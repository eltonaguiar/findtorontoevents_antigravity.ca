<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analysis | Find Stocks</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #12122a;
            --bg-card-hover: #1a1a3a;
            --border: #2a2a4a;
            --text: #e0e0f0;
            --text-dim: #8888aa;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234, 179, 8, 0.15);
            --blue: #3b82f6;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        .header {
            background: linear-gradient(135deg, #12122a 0%, #1e1e3f 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-links { display: flex; gap: 1rem; font-size: 0.9rem; }
        .header-links a { color: var(--text-dim); }
        .header-links a:hover { color: var(--text); }

        /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        @media (max-width: 1024px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .container { padding: 1rem; } }

        /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
        }
        .card h2 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--text); }
        .card h3 { font-size: 0.95rem; color: var(--text-dim); margin-bottom: 0.5rem; }

        /* ‚îÄ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ‚îÄ */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }
        .stat-card .label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; margin-top: 0.25rem; }
        .stat-card .value.positive { color: var(--green); }
        .stat-card .value.negative { color: var(--red); }
        .stat-card .value.neutral { color: var(--text); }

        /* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
        label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.03em; }
        select, input[type="number"], input[type="text"] {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }
        select:focus, input:focus { border-color: var(--accent); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .form-group { display: flex; flex-direction: column; }

        /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-primary:hover { background: #5558e6; box-shadow: 0 0 20px var(--accent-glow); }
        .btn-secondary { background: var(--bg-dark); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ‚îÄ Checkboxes ‚îÄ‚îÄ‚îÄ */
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; }
        .checkbox-item {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.4rem 0.6rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .checkbox-item:hover { border-color: var(--accent); }
        .checkbox-item input { accent-color: var(--accent); }

        /* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        thead th {
            text-align: left;
            padding: 0.6rem 0.8rem;
            background: var(--bg-dark);
            color: var(--text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            cursor: pointer;
        }
        thead th:hover { color: var(--text); }
        tbody td {
            padding: 0.5rem 0.8rem;
            border-bottom: 1px solid rgba(42, 42, 74, 0.5);
            white-space: nowrap;
        }
        tbody tr:hover { background: rgba(99, 102, 241, 0.05); }
        .positive { color: var(--green); }
        .negative { color: var(--red); }

        /* ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ */
        .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .tab {
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-dim);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ Scenario Cards ‚îÄ‚îÄ‚îÄ */
        .scenario-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .scenario-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .scenario-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .scenario-card.selected { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .scenario-card h4 { font-size: 1rem; margin-bottom: 0.5rem; }
        .scenario-card p { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.75rem; }
        .scenario-meta { display: flex; gap: 1rem; font-size: 0.8rem; }
        .scenario-meta span { background: var(--bg-dark); padding: 0.2rem 0.5rem; border-radius: 4px; }

        /* ‚îÄ‚îÄ‚îÄ Comparison Table ‚îÄ‚îÄ‚îÄ */
        .comparison-row { display: grid; grid-template-columns: 200px 1fr; gap: 1rem; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(42,42,74,0.5); }
        .comparison-bar { height: 24px; border-radius: 4px; position: relative; min-width: 2px; }
        .comparison-label { font-size: 0.85rem; }
        .comparison-value { position: absolute; right: 8px; top: 3px; font-size: 0.75rem; font-weight: 600; }

        /* ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ */
        .chart-container { position: relative; height: 300px; }

        /* ‚îÄ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ */
        .loading { text-align: center; padding: 2rem; color: var(--text-dim); }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ‚îÄ Badge ‚îÄ‚îÄ‚îÄ */
        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-green { background: var(--green-dim); color: var(--green); }
        .badge-red { background: var(--red-dim); color: var(--red); }
        .badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
        .badge-blue { background: rgba(59,130,246,0.15); color: var(--blue); }

        /* ‚îÄ‚îÄ‚îÄ Disclaimer ‚îÄ‚îÄ‚îÄ */
        .disclaimer {
            background: rgba(234, 179, 8, 0.08);
            border: 1px solid rgba(234, 179, 8, 0.2);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 1.5rem;
        }
        .disclaimer strong { color: var(--yellow); }

        /* ‚îÄ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ */
        .export-btns { display: flex; gap: 0.5rem; margin-top: 1rem; }

        /* ‚îÄ‚îÄ‚îÄ Section spacing ‚îÄ‚îÄ‚îÄ */
        .section { margin-bottom: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ -->
<div class="header">
    <h1>Portfolio Analysis Tool</h1>
    <div class="header-links">
        <a href="/findstocks/portfolio/quick-picks.html" style="color:var(--yellow);font-weight:600;">Quick Picks</a>
        <a href="/findstocks/portfolio/report.html">Daily Report</a>
        <a href="/findstocks/portfolio/stats.html">Stats</a>
        <a href="/findstocks/">Stock Picks</a>
        <a href="/findstocks/research/">Research</a>
        <a href="/">Events</a>
    </div>
</div>

<div class="container">

    <!-- ‚îÄ‚îÄ‚îÄ Status Bar ‚îÄ‚îÄ‚îÄ -->
    <div id="statusBar" class="stat-grid">
        <div class="stat-card"><div class="label">Stocks</div><div class="value neutral" id="statStocks">‚Äî</div></div>
        <div class="stat-card"><div class="label">Picks</div><div class="value neutral" id="statPicks">‚Äî</div></div>
        <div class="stat-card"><div class="label">Price Records</div><div class="value neutral" id="statPrices">‚Äî</div></div>
        <div class="stat-card"><div class="label">Algorithms</div><div class="value neutral" id="statAlgos">‚Äî</div></div>
        <div class="stat-card"><div class="label">Backtests Run</div><div class="value neutral" id="statBacktests">‚Äî</div></div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Setup Banner ‚îÄ‚îÄ‚îÄ -->
    <div id="setupBanner" class="card section" style="display:none; border-color: var(--yellow);">
        <h2>Setup Required</h2>
        <p style="color:var(--text-dim); margin-bottom:1rem;">The database needs to be initialized. Click the buttons below in order:</p>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="runSetup()">1. Create Tables</button>
            <button class="btn btn-secondary" onclick="importPicks()">2. Import Picks</button>
            <button class="btn btn-secondary" onclick="fetchPrices()">3. Fetch Price Data</button>
        </div>
        <div id="setupLog" style="margin-top:1rem; font-size:0.85rem; color:var(--text-dim);"></div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ -->
    <div class="tabs">
        <div class="tab active" data-tab="whatif">What-If Analysis</div>
        <div class="tab" data-tab="compare">Compare Strategies</div>
        <div class="tab" data-tab="optimal">Optimal Finder</div>
        <div class="tab" data-tab="picks">Stock Picks</div>
        <div class="tab" data-tab="history">Backtest History</div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: What-If Analysis ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content active" id="tab-whatif">
        <div class="grid-2">
            <!-- Left: Controls -->
            <div>
                <div class="card section">
                    <h2>Preset Scenarios</h2>
                    <div class="scenario-grid" id="scenarioGrid"></div>
                </div>
                <div class="card section">
                    <h2>Custom Parameters</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Strategy Type</label>
                            <select id="strategyType" onchange="onStrategyChange()">
                                <option value="custom">Custom</option>
                                <option value="daytrader">Day Trader</option>
                                <option value="swing">Swing Trader</option>
                                <option value="conservative">Conservative</option>
                                <option value="aggressive">Aggressive</option>
                                <option value="buy_hold">Buy & Hold</option>
                                <option value="low_vol">Low Volatility (skip VIX&ge;25)</option>
                                <option value="calm_only">Calm Markets Only (VIX&lt;16)</option>
                                <option value="vol_aware">Volatility-Aware (skip VIX&ge;20)</option>
                                <option value="bluechip_30d">Blue Chip 30-Day Hold</option>
                                <option value="bluechip_90d">Blue Chip 90-Day Hold</option>
                                <option value="bluechip_180d">Blue Chip 6-Month Hold</option>
                                <option value="bluechip_calm">Blue Chip (Calm Markets)</option>
                                <option value="cursor_genius_90d">‚≠ê Cursor Genius 90d Hold</option>
                                <option value="cursor_genius_50tp">‚≠ê Cursor Genius 50% TP</option>
                                <option value="cursor_genius_20tp">‚≠ê Cursor Genius 20% TP</option>
                                <option value="cursor_genius_std">‚≠ê Cursor Genius Standard</option>
                                <option value="etf_90d">üì¶ ETF Masters 90d Hold</option>
                                <option value="etf_20tp">üì¶ ETF Masters 20% TP</option>
                                <option value="sector_rotation_90d">üîÑ Sector Rotation 90d</option>
                                <option value="sector_momentum_30d">üî• Sector Momentum 30d</option>
                                <option value="sector_momentum_90d">üî• Sector Momentum 90d</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Take Profit %</label>
                            <input type="number" id="takeProfit" value="10" min="1" max="999" step="1">
                        </div>
                        <div class="form-group">
                            <label>Stop Loss %</label>
                            <input type="number" id="stopLoss" value="5" min="1" max="999" step="1">
                        </div>
                        <div class="form-group">
                            <label>Max Hold (Days)</label>
                            <input type="number" id="maxHoldDays" value="7" min="1" max="365" step="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Initial Capital ($)</label>
                            <input type="number" id="initialCapital" value="10000" min="100" step="100">
                        </div>
                        <div class="form-group">
                            <label>Fee Model</label>
                            <select id="feeModel" onchange="toggleCommField()">
                                <option value="questrade" selected>Questrade Canada ($0 stocks, forex for US)</option>
                                <option value="flat_10">Flat $10/trade (legacy)</option>
                                <option value="zero">Zero fees</option>
                            </select>
                        </div>
                        <div class="form-group" id="commGroup" style="display:none">
                            <label>Commission Per Trade ($)</label>
                            <input type="number" id="commission" value="10" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label>Volatility Filter (VIX-based)</label>
                            <select id="volFilter" onchange="toggleMaxVix()">
                                <option value="off">Off (trade always)</option>
                                <option value="skip_high">Skip High Vol (VIX &ge; 25)</option>
                                <option value="skip_elevated">Skip Elevated (VIX &ge; 20)</option>
                                <option value="calm_only">Calm Markets Only (VIX &lt; 16)</option>
                                <option value="custom">Custom VIX Threshold</option>
                            </select>
                        </div>
                        <div class="form-group" id="maxVixGroup" style="display:none">
                            <label>Max VIX Threshold</label>
                            <input type="number" id="maxVix" value="25" min="10" max="80" step="1">
                        </div>
                        <div class="form-group">
                            <label>Slippage %</label>
                            <input type="number" id="slippage" value="0.5" min="0" max="5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Position Size % of Capital</label>
                            <input type="number" id="positionSize" value="10" min="1" max="100" step="1">
                        </div>
                    </div>

                    <h3 style="margin-top:1rem;">Filter by Algorithm</h3>
                    <div class="checkbox-grid" id="algoCheckboxes"></div>

                    <div style="margin-top:1.5rem;">
                        <button class="btn btn-primary" onclick="runWhatIf()">Run What-If Analysis</button>
                        <button class="btn btn-secondary" onclick="runWhatIf(true)" style="margin-left:0.5rem;">Run & Save</button>
                    </div>
                </div>
            </div>

            <!-- Right: Results -->
            <div>
                <div id="whatifResults" style="display:none;">
                    <div class="stat-grid" id="whatifStats"></div>
                    <div class="card section">
                        <h2>Equity Curve</h2>
                        <div class="chart-container"><canvas id="equityChart"></canvas></div>
                    </div>
                    <div class="card section">
                        <h2>Returns by Algorithm</h2>
                        <div class="chart-container"><canvas id="algoChart"></canvas></div>
                    </div>
                    <div class="card section">
                        <div class="section-header">
                            <h2>Trade Log</h2>
                            <div class="export-btns">
                                <button class="btn btn-sm btn-secondary" onclick="exportCSV()">Export CSV</button>
                            </div>
                        </div>
                        <div class="table-wrap">
                            <table id="tradeTable">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable(0)">Ticker</th>
                                        <th onclick="sortTable(1)">Algorithm</th>
                                        <th onclick="sortTable(2)">Entry Date</th>
                                        <th onclick="sortTable(3)">Entry $</th>
                                        <th onclick="sortTable(4)">Exit Date</th>
                                        <th onclick="sortTable(5)">Exit $</th>
                                        <th onclick="sortTable(6)">Shares</th>
                                        <th onclick="sortTable(7)">Net P/L</th>
                                        <th onclick="sortTable(8)">Return %</th>
                                        <th onclick="sortTable(9)">Exit Reason</th>
                                        <th onclick="sortTable(10)">Hold Days</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="whatifEmpty" class="card" style="text-align:center; padding:3rem;">
                    <p style="font-size:1.1rem; margin-bottom:0.5rem;">Select a scenario or configure custom parameters</p>
                    <p style="color:var(--text-dim);">Results will appear here after running the analysis</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Compare Strategies ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-compare">
        <div class="card section">
            <div class="section-header">
                <h2>Strategy Comparison</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="runComparison()">Compare All Scenarios</button>
                </div>
            </div>
            <h3 style="margin-bottom:0.5rem;">Filter by Algorithm (optional)</h3>
            <div class="checkbox-grid" id="compareAlgoCheckboxes"></div>
        </div>
        <div id="comparisonResults" style="display:none;">
            <div class="card section">
                <h2>Return Comparison</h2>
                <div class="chart-container" style="height:400px;"><canvas id="comparisonChart"></canvas></div>
            </div>
            <div class="card section">
                <h2>Detailed Comparison</h2>
                <div class="table-wrap">
                    <table id="comparisonTable">
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>TP%</th>
                                <th>SL%</th>
                                <th>Hold</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Return %</th>
                                <th>Final Value</th>
                                <th>Max DD%</th>
                                <th>Commissions</th>
                                <th>Sharpe</th>
                                <th>P/F</th>
                                <th>Expectancy</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Optimal Finder ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-optimal">
        <div class="card section">
            <div class="section-header">
                <h2>Optimal Conditions Finder</h2>
            </div>
            <p style="color:var(--text-dim); margin-bottom:1rem;">
                Runs a grid search across <strong>every permutation</strong> of Take Profit, Stop Loss, Holding Period,
                Volatility Filter, and Fee Model to find the exact conditions that produce the highest returns.
            </p>
            <div class="grid-2">
                <div>
                    <div class="form-group">
                        <label>Algorithm Filter</label>
                        <select id="optAlgoFilter" style="width:100%;">
                            <option value="">All Algorithms</option>
                            <option value="Blue Chip Growth">Blue Chip Growth Only</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Sort Results By</label>
                        <select id="optSortBy" style="width:100%;">
                            <option value="total_return_pct">Total Return %</option>
                            <option value="win_rate">Win Rate %</option>
                            <option value="sharpe_ratio">Sharpe Ratio</option>
                            <option value="profit_factor">Profit Factor</option>
                            <option value="expectancy">Expectancy</option>
                            <option value="final_value">Final Portfolio Value</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="grid-2" style="margin-top:0.5rem;">
                <div>
                    <div class="form-group">
                        <label>Speed</label>
                        <select id="optQuick" style="width:100%;">
                            <option value="1">Quick (fewer combos, faster)</option>
                            <option value="0">Full Grid (comprehensive, slower)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Show Top N Results</label>
                        <input type="number" id="optTopN" value="25" min="5" max="100" style="width:100%;">
                    </div>
                </div>
            </div>
            <div style="margin-top:1rem;">
                <button class="btn btn-primary" onclick="runOptimalFinder()" id="optRunBtn">Find Optimal Conditions</button>
            </div>
        </div>

        <div id="optimalLoading" style="display:none;">
            <div class="card" style="text-align:center; padding:3rem;">
                <div class="loading">Searching permutations... this may take 10-30 seconds</div>
            </div>
        </div>

        <div id="optimalResults" style="display:none;">
            <!-- Summary stats -->
            <div class="stat-grid" id="optimalSummaryStats"></div>

            <!-- Winner card -->
            <div class="card section" id="optimalWinnerCard" style="border: 2px solid var(--green); display:none;">
                <h2 style="color: var(--green);">&#x1F3C6; Winning Configuration</h2>
                <div id="optimalWinnerContent"></div>
            </div>

            <!-- Top results chart -->
            <div class="card section">
                <h2>Top Configurations by <span id="optSortLabel">Return</span></h2>
                <div class="chart-container" style="height:500px;"><canvas id="optimalChart"></canvas></div>
            </div>

            <!-- Top results table -->
            <div class="card section">
                <h2>Full Results Table</h2>
                <div class="table-wrap">
                    <table id="optimalTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Configuration</th>
                                <th onclick="sortOptTable(2)">TP</th>
                                <th onclick="sortOptTable(3)">SL</th>
                                <th onclick="sortOptTable(4)">Hold</th>
                                <th>Vol Filter</th>
                                <th>Fee Model</th>
                                <th onclick="sortOptTable(7)">Trades</th>
                                <th onclick="sortOptTable(8)">Win Rate</th>
                                <th onclick="sortOptTable(9)">Return %</th>
                                <th onclick="sortOptTable(10)">Final Value</th>
                                <th onclick="sortOptTable(11)">Max DD%</th>
                                <th onclick="sortOptTable(12)">Sharpe</th>
                                <th onclick="sortOptTable(13)">P/F</th>
                                <th onclick="sortOptTable(14)">Fees</th>
                                <th>Best Trade</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Worst results (what to avoid) -->
            <div class="card section" style="border-color: var(--red);">
                <h2 style="color:var(--red);">Worst Configurations (Avoid These)</h2>
                <div class="table-wrap">
                    <table id="worstTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Configuration</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Return %</th>
                                <th>Final Value</th>
                                <th>Max DD%</th>
                                <th>Worst Trade</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="optimalEmpty" class="card" style="text-align:center; padding:3rem;">
            <p style="font-size:1.1rem; margin-bottom:0.5rem;">Click "Find Optimal Conditions" to search all parameter permutations</p>
            <p style="color:var(--text-dim);">The engine will test every combination and rank them by your chosen metric</p>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Stock Picks ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-picks">
        <div class="card section">
            <div class="section-header">
                <h2>Imported Stock Picks</h2>
                <select id="picksAlgoFilter" onchange="loadPicks()" style="width:auto;">
                    <option value="">All Algorithms</option>
                </select>
            </div>
            <div class="table-wrap">
                <table id="picksTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Company</th>
                            <th>Algorithm</th>
                            <th>Pick Date</th>
                            <th>Entry Price</th>
                            <th>Score</th>
                            <th>Rating</th>
                            <th>Risk</th>
                            <th>Timeframe</th>
                            <th>Stop Loss</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Backtest History ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-history">
        <div class="card section">
            <h2>Saved Backtest Results</h2>
            <div class="table-wrap">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Run Name</th>
                            <th>Strategy</th>
                            <th>Algorithms</th>
                            <th>Trades</th>
                            <th>Win Rate</th>
                            <th>Return %</th>
                            <th>Final Value</th>
                            <th>Max DD%</th>
                            <th>Sharpe</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Disclaimer ‚îÄ‚îÄ‚îÄ -->
    <div class="disclaimer">
        <strong>Disclaimer:</strong> This tool is for <strong>research and educational purposes only</strong>.
        Past performance does not guarantee future results. Backtests use historical data and may not reflect real-world execution.
        All simulations include a $10/trade commission and configurable slippage. Investing involves risk of loss.
        Consult a licensed financial adviser before making investment decisions.
        Results are based on our algorithm picks and the
        <a href="/findstocks/research/" style="color:var(--yellow);">Bet-Your-Life immutable ledger protocol</a>
        for data integrity.
    </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ
const API_BASE = '/findstocks/api';
let allAlgorithms = [];
let currentTrades = [];
let equityChartInstance = null;
let algoChartInstance = null;
let comparisonChartInstance = null;

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
    initTabs();
    loadStats();
    loadAlgorithms();
    loadScenarios();
});

// ‚îÄ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ‚îÄ
function initTabs() {
    var tabs = document.querySelectorAll('.tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].addEventListener('click', function() {
            var target = this.getAttribute('data-tab');
            var allTabs = document.querySelectorAll('.tab');
            var allContent = document.querySelectorAll('.tab-content');
            for (var j = 0; j < allTabs.length; j++) allTabs[j].classList.remove('active');
            for (var j = 0; j < allContent.length; j++) allContent[j].classList.remove('active');
            this.classList.add('active');
            document.getElementById('tab-' + target).classList.add('active');
            // Load data for tab
            if (target === 'picks') loadPicks();
            if (target === 'history') loadHistory();
        });
    }
}

// ‚îÄ‚îÄ‚îÄ API Helper ‚îÄ‚îÄ‚îÄ
function apiCall(endpoint, params, callback) {
    var qs = [];
    for (var k in params) {
        if (params.hasOwnProperty(k) && params[k] !== '') {
            qs.push(encodeURIComponent(k) + '=' + encodeURIComponent(params[k]));
        }
    }
    var url = API_BASE + '/' + endpoint + (qs.length > 0 ? '?' + qs.join('&') : '');
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.onload = function() {
        try {
            var data = JSON.parse(xhr.responseText);
            callback(null, data);
        } catch(e) {
            callback('Parse error: ' + e.message);
        }
    };
    xhr.onerror = function() { callback('Network error'); };
    xhr.send();
}

// ‚îÄ‚îÄ‚îÄ Load Stats ‚îÄ‚îÄ‚îÄ
function loadStats() {
    apiCall('data.php', {type: 'stats'}, function(err, data) {
        if (err || !data || !data.ok) {
            document.getElementById('setupBanner').style.display = 'block';
            return;
        }
        var s = data.stats;
        document.getElementById('statStocks').textContent = s.total_stocks || 0;
        document.getElementById('statPicks').textContent = s.total_picks || 0;
        document.getElementById('statPrices').textContent = s.total_price_records || 0;
        document.getElementById('statAlgos').textContent = s.active_algorithms || 0;
        document.getElementById('statBacktests').textContent = s.total_backtests || 0;

        if (s.total_picks === 0) {
            document.getElementById('setupBanner').style.display = 'block';
        }
    });
}

// ‚îÄ‚îÄ‚îÄ Load Algorithms ‚îÄ‚îÄ‚îÄ
function loadAlgorithms() {
    apiCall('data.php', {type: 'algorithms'}, function(err, data) {
        if (err || !data || !data.algorithms) return;
        allAlgorithms = data.algorithms;
        renderAlgoCheckboxes('algoCheckboxes');
        renderAlgoCheckboxes('compareAlgoCheckboxes');
        renderAlgoFilter();
        populateOptAlgoFilter();
    });
}

function renderAlgoCheckboxes(containerId) {
    var html = '';
    for (var i = 0; i < allAlgorithms.length; i++) {
        var a = allAlgorithms[i];
        var count = a.pick_count || 0;
        html += '<label class="checkbox-item">'
             + '<input type="checkbox" value="' + a.name + '" checked>'
             + a.name + ' (' + count + ')'
             + '</label>';
    }
    document.getElementById(containerId).innerHTML = html;
}

function selectOnlyAlgo(containerId, algoName) {
    var boxes = document.querySelectorAll('#' + containerId + ' input[type="checkbox"]');
    for (var i = 0; i < boxes.length; i++) {
        boxes[i].checked = (boxes[i].value === algoName);
    }
}

function renderAlgoFilter() {
    var sel = document.getElementById('picksAlgoFilter');
    for (var i = 0; i < allAlgorithms.length; i++) {
        var opt = document.createElement('option');
        opt.value = allAlgorithms[i].name;
        opt.textContent = allAlgorithms[i].name;
        sel.appendChild(opt);
    }
}

function getSelectedAlgos(containerId) {
    var cbs = document.getElementById(containerId).querySelectorAll('input[type="checkbox"]:checked');
    var selected = [];
    for (var i = 0; i < cbs.length; i++) selected.push(cbs[i].value);
    return selected.join(',');
}

// ‚îÄ‚îÄ‚îÄ Load Scenarios ‚îÄ‚îÄ‚îÄ
function loadScenarios() {
    apiCall('data.php', {type: 'scenarios'}, function(err, data) {
        if (err || !data || !data.scenarios) return;
        var grid = document.getElementById('scenarioGrid');
        var html = '';
        for (var i = 0; i < data.scenarios.length; i++) {
            var sc = data.scenarios[i];
            html += '<div class="scenario-card" data-key="' + sc.key + '" onclick="selectScenario(this, \'' + sc.key + '\',' + sc.tp + ',' + sc.sl + ',' + sc.hold + ')">'
                 + '<h4>' + sc.name + '</h4>'
                 + '<div class="scenario-meta">'
                 + '<span>TP: ' + (sc.tp >= 999 ? 'None' : sc.tp + '%') + '</span>'
                 + '<span>SL: ' + (sc.sl >= 999 ? 'None' : sc.sl + '%') + '</span>'
                 + '<span>Hold: ' + sc.hold + 'd</span>'
                 + '</div></div>';
        }
        grid.innerHTML = html;
    });
}

function selectScenario(el, key, tp, sl, hold) {
    var cards = document.querySelectorAll('.scenario-card');
    for (var i = 0; i < cards.length; i++) cards[i].classList.remove('selected');
    el.classList.add('selected');
    document.getElementById('takeProfit').value = tp >= 999 ? 999 : tp;
    document.getElementById('stopLoss').value = sl >= 999 ? 999 : sl;
    document.getElementById('maxHoldDays').value = hold;
}

function onStrategyChange() {
    var strat = document.getElementById('strategyType').value;
    var presets = {
        daytrader:    {tp: 5,   sl: 3,  hold: 2,  vol: 'off'},
        swing:        {tp: 15,  sl: 5,  hold: 14, vol: 'off'},
        conservative: {tp: 10,  sl: 5,  hold: 30, vol: 'off'},
        aggressive:   {tp: 30,  sl: 15, hold: 30, vol: 'off'},
        buy_hold:     {tp: 999, sl: 999, hold: 90, vol: 'off'},
        low_vol:      {tp: 10,  sl: 5,  hold: 14, vol: 'skip_high'},
        calm_only:    {tp: 15,  sl: 5,  hold: 30, vol: 'calm_only'},
        vol_aware:    {tp: 10,  sl: 5,  hold: 7,  vol: 'skip_elevated'},
        bluechip_30d: {tp: 999, sl: 999, hold: 30, vol: 'off',       algo: 'Blue Chip Growth'},
        bluechip_90d: {tp: 999, sl: 999, hold: 90, vol: 'off',       algo: 'Blue Chip Growth'},
        bluechip_180d:{tp: 999, sl: 999, hold: 180,vol: 'off',       algo: 'Blue Chip Growth'},
        bluechip_calm:{tp: 999, sl: 999, hold: 90, vol: 'calm_only', algo: 'Blue Chip Growth'},
        cursor_genius_90d:{tp: 999, sl: 999, hold: 90, vol: 'off', algo: 'Cursor Genius'},
        cursor_genius_50tp:{tp: 50, sl: 999, hold: 90, vol: 'off', algo: 'Cursor Genius'},
        cursor_genius_20tp:{tp: 20, sl: 999, hold: 90, vol: 'off', algo: 'Cursor Genius'},
        cursor_genius_std:{tp: 10, sl: 5, hold: 30, vol: 'off', algo: 'Cursor Genius'},
        etf_90d:{tp: 999, sl: 999, hold: 90, vol: 'off', algo: 'ETF Masters'},
        etf_20tp:{tp: 20, sl: 999, hold: 90, vol: 'off', algo: 'ETF Masters'},
        sector_rotation_90d:{tp: 999, sl: 999, hold: 90, vol: 'off', algo: 'Sector Rotation'},
        sector_momentum_30d:{tp: 999, sl: 999, hold: 30, vol: 'off', algo: 'Sector Momentum'},
        sector_momentum_90d:{tp: 999, sl: 999, hold: 90, vol: 'off', algo: 'Sector Momentum'}
    };
    if (presets[strat]) {
        document.getElementById('takeProfit').value = presets[strat].tp;
        document.getElementById('stopLoss').value = presets[strat].sl;
        document.getElementById('maxHoldDays').value = presets[strat].hold;
        if (presets[strat].vol) {
            document.getElementById('volFilter').value = presets[strat].vol;
            toggleMaxVix();
        }
        // For Blue Chip presets, auto-select only the Blue Chip Growth algo
        if (presets[strat].algo) {
            selectOnlyAlgo('algoCheckboxes', presets[strat].algo);
        }
    }
}

// ‚îÄ‚îÄ‚îÄ Run What-If ‚îÄ‚îÄ‚îÄ
function runWhatIf(save) {
    var algos = getSelectedAlgos('algoCheckboxes');
    var fm = document.getElementById('feeModel').value;
    var vf = document.getElementById('volFilter').value;
    var params = {
        algorithms: algos,
        strategy: document.getElementById('strategyType').value,
        take_profit: document.getElementById('takeProfit').value,
        stop_loss: document.getElementById('stopLoss').value,
        max_hold_days: document.getElementById('maxHoldDays').value,
        initial_capital: document.getElementById('initialCapital').value,
        commission: document.getElementById('commission').value,
        slippage: document.getElementById('slippage').value,
        position_size: document.getElementById('positionSize').value,
        fee_model: fm,
        vol_filter: vf,
        max_vix: document.getElementById('maxVix').value
    };
    if (save) params.save = '1';

    document.getElementById('whatifResults').style.display = 'none';
    document.getElementById('whatifEmpty').innerHTML = '<div class="loading">Running analysis</div>';
    document.getElementById('whatifEmpty').style.display = 'block';

    apiCall('backtest.php', params, function(err, data) {
        if (err || !data || !data.ok) {
            document.getElementById('whatifEmpty').innerHTML = '<p style="color:var(--red);">Error: ' + (err || (data && data.error ? data.error : 'Unknown error')) + '</p>';
            return;
        }
        document.getElementById('whatifEmpty').style.display = 'none';
        document.getElementById('whatifResults').style.display = 'block';
        currentTrades = data.trades || [];
        renderWhatIfResults(data);
    });
}

function renderWhatIfResults(data) {
    var s = data.summary;
    var p = data.params || {};
    var statsHtml = ''
        + statCard('Total Return', fmtPct(s.total_return_pct), s.total_return_pct)
        + statCard('Final Value', '$' + fmtNum(s.final_value), s.final_value - p.initial_capital)
        + statCard('Win Rate', s.win_rate + '%', s.win_rate - 50)
        + statCard('Total Trades', s.total_trades, 0)
        + statCard('Avg Win', fmtPct(s.avg_win_pct), 1)
        + statCard('Avg Loss', fmtPct(-s.avg_loss_pct), -1)
        + statCard('Max Drawdown', fmtPct(-s.max_drawdown_pct), -1)
        + statCard('Total Fees', '$' + fmtNum(s.total_commissions), -1)
        + statCard('Sharpe Ratio', s.sharpe_ratio, s.sharpe_ratio)
        + statCard('Profit Factor', s.profit_factor, s.profit_factor - 1)
        + statCard('Expectancy', fmtPct(s.expectancy), s.expectancy);

    // Fee breakdown for Questrade model
    if (p.fee_model === 'questrade' && (s.total_forex_fees > 0 || s.cdr_trades > 0)) {
        statsHtml += statCard('CDR Trades', s.cdr_trades + ' ($0 fee)', 1)
                  +  statCard('US Forex Trades', s.us_forex_trades, s.us_forex_trades > 0 ? -1 : 0)
                  +  statCard('Forex Fees', '$' + fmtNum(s.total_forex_fees), -1)
                  +  statCard('ECN+SEC Fees', '$' + fmtNum((s.total_ecn_fees || 0) + (s.total_sec_fees || 0)), -1);
    }

    // Fee model label
    statsHtml += '<div class="stat-card" style="border-color:var(--accent)"><div class="label">Fee Model</div><div class="value" style="font-size:0.8rem">' + (p.fee_model_label || p.fee_model || 'flat') + '</div></div>';

    // Volatility filter info
    if (p.vol_filter && p.vol_filter !== 'off') {
        statsHtml += '<div class="stat-card" style="border-color:#eab308"><div class="label">Vol Filter</div><div class="value" style="font-size:0.75rem">' + (p.vol_filter_label || p.vol_filter) + '</div></div>';
        statsHtml += statCard('Trades Skipped', s.vol_skipped || 0, s.vol_skipped > 0 ? 1 : 0);

        // Show skipped tickers summary
        if (s.vol_skipped_tickers && s.vol_skipped_tickers.length > 0) {
            var skipList = '<div style="margin-top:0.5rem;font-size:0.8rem;color:var(--text-dim)"><strong>Skipped due to VIX:</strong> ';
            var shown = Math.min(s.vol_skipped_tickers.length, 10);
            for (var si = 0; si < shown; si++) {
                var sk = s.vol_skipped_tickers[si];
                skipList += sk.ticker + ' (VIX:' + sk.vix.toFixed(1) + ') ';
            }
            if (s.vol_skipped > shown) skipList += '...+' + (s.vol_skipped - shown) + ' more';
            skipList += '</div>';
            statsHtml += '<div class="stat-card" style="grid-column:1/-1;text-align:left">' + skipList + '</div>';
        }
    }

    document.getElementById('whatifStats').innerHTML = statsHtml;

    renderTradeTable(data.trades);
    renderEquityChart(data);
    renderAlgoChart(data);
}

function statCard(label, value, sentiment) {
    var cls = sentiment > 0 ? 'positive' : (sentiment < 0 ? 'negative' : 'neutral');
    return '<div class="stat-card"><div class="label">' + label + '</div><div class="value ' + cls + '">' + value + '</div></div>';
}

function fmtPct(v) { return (v >= 0 ? '+' : '') + parseFloat(v).toFixed(2) + '%'; }
function fmtNum(v) { return parseFloat(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

// Toggle commission field based on fee model
function toggleCommField() {
    var fm = document.getElementById('feeModel').value;
    var cg = document.getElementById('commGroup');
    cg.style.display = (fm === 'flat_10') ? '' : 'none';
}

// Toggle max VIX input based on vol filter
function toggleMaxVix() {
    var vf = document.getElementById('volFilter').value;
    document.getElementById('maxVixGroup').style.display = (vf === 'custom') ? '' : 'none';
}

// ‚îÄ‚îÄ‚îÄ Trade Table ‚îÄ‚îÄ‚îÄ
function renderTradeTable(trades) {
    var tbody = document.getElementById('tradeTable').querySelector('tbody');
    var html = '';
    for (var i = 0; i < trades.length; i++) {
        var t = trades[i];
        var cls = t.net_profit >= 0 ? 'positive' : 'negative';
        var cdrBadge = t.has_cdr ? ' <span class="badge badge-green" title="CDR available ‚Äî $0 fee">CDR</span>' : (t.forex_fee > 0 ? ' <span class="badge badge-yellow" title="1.75% forex fee">FX</span>' : '');
        var vixBadge = '';
        if (t.vix_at_entry !== null && t.vix_at_entry > 0) {
            var vixColor = t.vix_at_entry < 16 ? 'badge-green' : (t.vix_at_entry < 20 ? 'badge-blue' : (t.vix_at_entry < 25 ? 'badge-yellow' : 'badge-red'));
            vixBadge = ' <span class="badge ' + vixColor + '" title="VIX: ' + t.vix_at_entry.toFixed(1) + ' (' + (t.vol_regime || '') + ')">VIX:' + t.vix_at_entry.toFixed(0) + '</span>';
        }
        var reasonBadge = t.exit_reason === 'take_profit' ? '<span class="badge badge-green">TP</span>'
                       : t.exit_reason === 'stop_loss' ? '<span class="badge badge-red">SL</span>'
                       : t.exit_reason === 'max_hold' ? '<span class="badge badge-yellow">MAX</span>'
                       : '<span class="badge badge-blue">' + t.exit_reason + '</span>';
        html += '<tr>'
             + '<td><strong>' + t.ticker + '</strong>' + cdrBadge + vixBadge + '</td>'
             + '<td>' + t.algorithm + '</td>'
             + '<td>' + t.entry_date + '</td>'
             + '<td>$' + parseFloat(t.entry_price).toFixed(2) + '</td>'
             + '<td>' + (t.exit_date || '‚Äî') + '</td>'
             + '<td>$' + parseFloat(t.exit_price).toFixed(2) + '</td>'
             + '<td>' + t.shares + '</td>'
             + '<td class="' + cls + '">$' + parseFloat(t.net_profit).toFixed(2) + '</td>'
             + '<td class="' + cls + '">' + fmtPct(t.return_pct) + '</td>'
             + '<td>' + reasonBadge + '</td>'
             + '<td>' + t.hold_days + '</td>'
             + '</tr>';
    }
    tbody.innerHTML = html || '<tr><td colspan="11" style="text-align:center; color:var(--text-dim);">No trades executed</td></tr>';
}

// ‚îÄ‚îÄ‚îÄ Sort Table ‚îÄ‚îÄ‚îÄ
var sortDir = {};
function sortTable(colIdx) {
    var table = document.getElementById('tradeTable');
    var tbody = table.querySelector('tbody');
    var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
    var dir = sortDir[colIdx] === 'asc' ? 'desc' : 'asc';
    sortDir[colIdx] = dir;
    rows.sort(function(a, b) {
        var aVal = a.cells[colIdx].textContent.replace(/[$%+,]/g, '');
        var bVal = b.cells[colIdx].textContent.replace(/[$%+,]/g, '');
        var aNum = parseFloat(aVal);
        var bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return dir === 'asc' ? aNum - bNum : bNum - aNum;
        }
        return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });
    for (var i = 0; i < rows.length; i++) tbody.appendChild(rows[i]);
}

// ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ
function renderEquityChart(data) {
    var ctx = document.getElementById('equityChart').getContext('2d');
    if (equityChartInstance) equityChartInstance.destroy();

    var trades = data.trades || [];
    var capital = data.params.initial_capital || 10000;
    var labels = ['Start'];
    var values = [capital];
    for (var i = 0; i < trades.length; i++) {
        capital += parseFloat(trades[i].net_profit);
        labels.push(trades[i].ticker);
        values.push(Math.round(capital * 100) / 100);
    }

    equityChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Portfolio Value ($)',
                data: values,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 3,
                pointBackgroundColor: function(context) {
                    var idx = context.dataIndex;
                    if (idx === 0) return '#6366f1';
                    return values[idx] >= values[idx - 1] ? '#22c55e' : '#ef4444';
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: 'rgba(42,42,74,0.5)' }, ticks: { color: '#8888aa' } },
                x: { grid: { display: false }, ticks: { color: '#8888aa', maxRotation: 45 } }
            }
        }
    });
}

function renderAlgoChart(data) {
    var ctx = document.getElementById('algoChart').getContext('2d');
    if (algoChartInstance) algoChartInstance.destroy();

    var trades = data.trades || [];
    var algoMap = {};
    for (var i = 0; i < trades.length; i++) {
        var algo = trades[i].algorithm;
        if (!algoMap[algo]) algoMap[algo] = {wins: 0, losses: 0, totalReturn: 0, count: 0};
        algoMap[algo].count++;
        algoMap[algo].totalReturn += parseFloat(trades[i].return_pct);
        if (parseFloat(trades[i].net_profit) >= 0) algoMap[algo].wins++;
        else algoMap[algo].losses++;
    }

    var labels = [], returns = [], colors = [];
    for (var name in algoMap) {
        labels.push(name);
        var avg = algoMap[name].totalReturn / algoMap[name].count;
        returns.push(Math.round(avg * 100) / 100);
        colors.push(avg >= 0 ? '#22c55e' : '#ef4444');
    }

    algoChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Avg Return %',
                data: returns,
                backgroundColor: colors,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: 'rgba(42,42,74,0.5)' }, ticks: { color: '#8888aa', callback: function(v) { return v + '%'; } } },
                x: { grid: { display: false }, ticks: { color: '#8888aa', maxRotation: 45 } }
            }
        }
    });
}

// ‚îÄ‚îÄ‚îÄ Comparison ‚îÄ‚îÄ‚îÄ
function runComparison() {
    var algos = getSelectedAlgos('compareAlgoCheckboxes');
    document.getElementById('comparisonResults').style.display = 'none';

    apiCall('whatif.php', {compare: '1', algorithms: algos, initial_capital: document.getElementById('initialCapital').value, commission: document.getElementById('commission').value, fee_model: document.getElementById('feeModel').value}, function(err, data) {
        if (err || !data || !data.ok) return;
        document.getElementById('comparisonResults').style.display = 'block';
        renderComparison(data);
    });
}

function renderComparison(data) {
    var scenarios = data.scenarios || [];

    // Table
    var tbody = document.getElementById('comparisonTable').querySelector('tbody');
    var html = '';
    for (var i = 0; i < scenarios.length; i++) {
        var sc = scenarios[i];
        var s = sc.summary;
        var cls = s.total_return_pct >= 0 ? 'positive' : 'negative';
        html += '<tr>'
             + '<td><strong>' + sc.name + '</strong></td>'
             + '<td>' + (sc.params.take_profit >= 999 ? '‚Äî' : sc.params.take_profit + '%') + '</td>'
             + '<td>' + (sc.params.stop_loss >= 999 ? '‚Äî' : sc.params.stop_loss + '%') + '</td>'
             + '<td>' + sc.params.max_hold_days + 'd</td>'
             + '<td>' + s.total_trades + '</td>'
             + '<td>' + s.win_rate + '%</td>'
             + '<td class="' + cls + '">' + fmtPct(s.total_return_pct) + '</td>'
             + '<td>$' + fmtNum(s.final_value) + '</td>'
             + '<td class="negative">' + fmtPct(-s.max_drawdown_pct) + '</td>'
             + '<td>$' + fmtNum(s.total_commissions) + '</td>'
             + '<td>' + s.sharpe_ratio + '</td>'
             + '<td>' + s.profit_factor + '</td>'
             + '<td class="' + (s.expectancy >= 0 ? 'positive' : 'negative') + '">' + fmtPct(s.expectancy) + '</td>'
             + '</tr>';
    }
    tbody.innerHTML = html;

    // Chart
    var ctx = document.getElementById('comparisonChart').getContext('2d');
    if (comparisonChartInstance) comparisonChartInstance.destroy();

    var labels = [], returns = [], winRates = [], colors = [];
    for (var i = 0; i < scenarios.length; i++) {
        labels.push(scenarios[i].name);
        returns.push(scenarios[i].summary.total_return_pct);
        winRates.push(scenarios[i].summary.win_rate);
        colors.push(scenarios[i].summary.total_return_pct >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)');
    }

    comparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Total Return %', data: returns, backgroundColor: colors, borderRadius: 6 },
                { label: 'Win Rate %', data: winRates, backgroundColor: 'rgba(99,102,241,0.5)', borderRadius: 6 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#8888aa' } } },
            scales: {
                y: { grid: { color: 'rgba(42,42,74,0.5)' }, ticks: { color: '#8888aa', callback: function(v) { return v + '%'; } } },
                x: { grid: { display: false }, ticks: { color: '#8888aa', maxRotation: 45, font: { size: 10 } } }
            }
        }
    });
}

// ‚îÄ‚îÄ‚îÄ Picks ‚îÄ‚îÄ‚îÄ
function loadPicks() {
    var algo = document.getElementById('picksAlgoFilter').value;
    var params = {type: 'picks'};
    if (algo) params.algorithm = algo;

    apiCall('data.php', params, function(err, data) {
        if (err || !data || !data.picks) return;
        var tbody = document.getElementById('picksTable').querySelector('tbody');
        var html = '';
        for (var i = 0; i < data.picks.length; i++) {
            var p = data.picks[i];
            var riskCls = p.risk_level === 'High' || p.risk_level === 'Very High' ? 'badge-red' : (p.risk_level === 'Medium' ? 'badge-yellow' : 'badge-green');
            html += '<tr>'
                 + '<td><strong>' + p.ticker + '</strong></td>'
                 + '<td>' + (p.company_name || '') + '</td>'
                 + '<td>' + p.algorithm_name + '</td>'
                 + '<td>' + p.pick_date + '</td>'
                 + '<td>$' + parseFloat(p.entry_price).toFixed(2) + '</td>'
                 + '<td>' + p.score + '</td>'
                 + '<td><span class="badge badge-green">' + p.rating + '</span></td>'
                 + '<td><span class="badge ' + riskCls + '">' + p.risk_level + '</span></td>'
                 + '<td>' + p.timeframe + '</td>'
                 + '<td>$' + parseFloat(p.stop_loss_price).toFixed(2) + '</td>'
                 + '</tr>';
        }
        tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; color:var(--text-dim);">No picks found</td></tr>';
    });
}

// ‚îÄ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ
function loadHistory() {
    apiCall('data.php', {type: 'backtests'}, function(err, data) {
        if (err || !data || !data.backtests) return;
        var tbody = document.getElementById('historyTable').querySelector('tbody');
        var html = '';
        for (var i = 0; i < data.backtests.length; i++) {
            var b = data.backtests[i];
            var cls = parseFloat(b.total_return_pct) >= 0 ? 'positive' : 'negative';
            html += '<tr>'
                 + '<td>' + b.run_name + '</td>'
                 + '<td>' + b.strategy_type + '</td>'
                 + '<td>' + (b.algorithm_filter || 'All') + '</td>'
                 + '<td>' + b.total_trades + '</td>'
                 + '<td>' + b.win_rate + '%</td>'
                 + '<td class="' + cls + '">' + fmtPct(b.total_return_pct) + '</td>'
                 + '<td>$' + fmtNum(b.final_value) + '</td>'
                 + '<td>' + fmtPct(-parseFloat(b.max_drawdown_pct)) + '</td>'
                 + '<td>' + b.sharpe_ratio + '</td>'
                 + '<td>' + b.created_at + '</td>'
                 + '</tr>';
        }
        tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; color:var(--text-dim);">No saved backtests yet</td></tr>';
    });
}

// ‚îÄ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ‚îÄ
function exportCSV() {
    if (!currentTrades || currentTrades.length === 0) return;
    var csv = 'Ticker,Company,Algorithm,Entry Date,Entry Price,Exit Date,Exit Price,Shares,Net P/L,Return %,Exit Reason,Hold Days\n';
    for (var i = 0; i < currentTrades.length; i++) {
        var t = currentTrades[i];
        csv += [t.ticker, '"' + (t.company || '') + '"', t.algorithm, t.entry_date, t.entry_price, t.exit_date, t.exit_price, t.shares, t.net_profit, t.return_pct, t.exit_reason, t.hold_days].join(',') + '\n';
    }
    var blob = new Blob([csv], {type: 'text/csv'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'backtest_trades_' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click();
}

// ‚îÄ‚îÄ‚îÄ Setup Functions ‚îÄ‚îÄ‚îÄ
function runSetup() {
    logSetup('Creating tables...');
    apiCall('setup_schema.php', {}, function(err, data) {
        if (err) { logSetup('Error: ' + err); return; }
        logSetup('Schema: ' + JSON.stringify(data.actions));
    });
}

function importPicks() {
    logSetup('Importing picks...');
    apiCall('import_picks.php', {}, function(err, data) {
        if (err) { logSetup('Error: ' + err); return; }
        logSetup('Imported: ' + data.imported + ' picks, skipped: ' + data.skipped);
        loadStats();
    });
}

function fetchPrices() {
    logSetup('Fetching price data (this may take a moment)...');
    apiCall('fetch_prices.php', {range: '1y'}, function(err, data) {
        if (err) { logSetup('Error: ' + err); return; }
        var msg = 'Fetched: ' + data.fetched + ' tickers.';
        if (data.errors && data.errors.length > 0) msg += ' Errors: ' + data.errors.join(', ');
        if (data.note) msg += ' Note: ' + data.note;
        logSetup(msg);
        loadStats();
        // Fetch remaining tickers
        if (data.note && data.note.indexOf('Limited') >= 0) {
            logSetup('Fetching next batch...');
            setTimeout(function() { fetchPricesRemaining(); }, 2000);
        }
    });
}

function fetchPricesRemaining() {
    apiCall('fetch_prices.php', {range: '1y'}, function(err, data) {
        if (err) { logSetup('Error on batch 2: ' + err); return; }
        logSetup('Batch 2: Fetched ' + data.fetched + ' more tickers.');
        loadStats();
        if (data.note && data.note.indexOf('Limited') >= 0) {
            setTimeout(function() {
                apiCall('fetch_prices.php', {range: '1y'}, function(err2, data2) {
                    if (!err2 && data2) logSetup('Batch 3: Fetched ' + data2.fetched + ' more.');
                    loadStats();
                });
            }, 2000);
        }
    });
}

function logSetup(msg) {
    var log = document.getElementById('setupLog');
    log.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + msg + '</div>';
}

// ‚îÄ‚îÄ‚îÄ Optimal Finder ‚îÄ‚îÄ‚îÄ
var optimalChartInstance = null;

function runOptimalFinder() {
    var algo = document.getElementById('optAlgoFilter').value;
    var sortBy = document.getElementById('optSortBy').value;
    var quick = document.getElementById('optQuick').value;
    var topN = document.getElementById('optTopN').value;

    document.getElementById('optimalEmpty').style.display = 'none';
    document.getElementById('optimalResults').style.display = 'none';
    document.getElementById('optimalLoading').style.display = 'block';
    document.getElementById('optRunBtn').disabled = true;
    document.getElementById('optRunBtn').textContent = 'Searching...';

    var params = {
        algorithms: algo,
        sort_by: sortBy,
        quick: quick,
        top: topN,
        fee_model: 'questrade',
        initial_capital: document.getElementById('initialCapital').value,
        slippage: document.getElementById('slippage').value
    };

    apiCall('optimal_finder.php', params, function(err, data) {
        document.getElementById('optimalLoading').style.display = 'none';
        document.getElementById('optRunBtn').disabled = false;
        document.getElementById('optRunBtn').textContent = 'Find Optimal Conditions';

        if (err || !data || !data.ok) {
            document.getElementById('optimalEmpty').style.display = 'block';
            document.getElementById('optimalEmpty').innerHTML = '<p style="color:var(--red);">Error: ' + (err || (data && data.error ? data.error : 'Unknown')) + '</p>';
            return;
        }

        document.getElementById('optimalResults').style.display = 'block';
        renderOptimalResults(data);
    });
}

function renderOptimalResults(data) {
    var top = data.top_results || [];
    var worst = data.worst_results || [];
    var sortLabel = {
        total_return_pct: 'Return %',
        win_rate: 'Win Rate',
        sharpe_ratio: 'Sharpe Ratio',
        profit_factor: 'Profit Factor',
        expectancy: 'Expectancy',
        final_value: 'Final Value'
    };
    document.getElementById('optSortLabel').textContent = sortLabel[data.sort_by] || data.sort_by;

    // ‚îÄ‚îÄ‚îÄ Summary stats ‚îÄ‚îÄ‚îÄ
    var html = '';
    html += statCard('Permutations Tested', data.total_permutations, 0);
    html += statCard('With Trades', data.total_with_trades, 0);
    html += statCard('Time Elapsed', data.elapsed_seconds + 's', 0);
    html += statCard('Picks Analyzed', data.total_picks, 0);
    if (top.length > 0) {
        var best = top[0].summary;
        html += statCard('Best Return', fmtPct(best.total_return_pct), best.total_return_pct);
        html += statCard('Best Win Rate', best.win_rate + '%', best.win_rate - 50);
        html += statCard('Best Sharpe', best.sharpe_ratio, best.sharpe_ratio);
        html += statCard('Best Final Value', '$' + fmtNum(best.final_value), best.final_value - data.initial_capital);
    }
    document.getElementById('optimalSummaryStats').innerHTML = html;

    // ‚îÄ‚îÄ‚îÄ Winner card ‚îÄ‚îÄ‚îÄ
    if (top.length > 0) {
        var w = top[0];
        var ws = w.summary;
        var wp = w.params;
        var winnerHtml = '<div class="stat-grid" style="margin-top:1rem;">';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Take Profit</div><div class="value">' + (wp.take_profit >= 999 ? 'None (Hold)' : wp.take_profit + '%') + '</div></div>';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Stop Loss</div><div class="value">' + (wp.stop_loss >= 999 ? 'None' : wp.stop_loss + '%') + '</div></div>';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Holding Period</div><div class="value">' + wp.max_hold_days + ' days</div></div>';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Vol Filter</div><div class="value">' + wp.vol_filter + '</div></div>';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Fee Model</div><div class="value">' + wp.fee_model + '</div></div>';
        winnerHtml += '</div>';
        winnerHtml += '<div class="stat-grid" style="margin-top:0.5rem;">';
        winnerHtml += statCard('Total Return', fmtPct(ws.total_return_pct), ws.total_return_pct);
        winnerHtml += statCard('Win Rate', ws.win_rate + '%', ws.win_rate - 50);
        winnerHtml += statCard('Final Value', '$' + fmtNum(ws.final_value), ws.final_value - data.initial_capital);
        winnerHtml += statCard('Trades', ws.total_trades, 0);
        winnerHtml += statCard('Sharpe', ws.sharpe_ratio, ws.sharpe_ratio);
        winnerHtml += statCard('Profit Factor', ws.profit_factor, ws.profit_factor - 1);
        winnerHtml += statCard('Max Drawdown', fmtPct(-ws.max_drawdown_pct), -1);
        winnerHtml += statCard('Total Fees', '$' + fmtNum(ws.total_commissions), -1);
        winnerHtml += '</div>';

        if (ws.best_trade) {
            winnerHtml += '<p style="margin-top:1rem;font-size:0.85rem;color:var(--text-dim);">Best single trade: <strong style="color:var(--green);">' + ws.best_trade.ticker + '</strong> ' + ws.best_trade.entry_date + ' ‚Üí ' + ws.best_trade.exit_date + ' (' + fmtPct(ws.best_trade.return_pct) + ', ' + ws.best_trade.exit_reason + ')</p>';
        }

        document.getElementById('optimalWinnerContent').innerHTML = winnerHtml;
        document.getElementById('optimalWinnerCard').style.display = 'block';
    }

    // ‚îÄ‚îÄ‚îÄ Top results chart ‚îÄ‚îÄ‚îÄ
    renderOptimalChart(top, data.sort_by);

    // ‚îÄ‚îÄ‚îÄ Top results table ‚îÄ‚îÄ‚îÄ
    renderOptimalTable(top);

    // ‚îÄ‚îÄ‚îÄ Worst results table ‚îÄ‚îÄ‚îÄ
    renderWorstTable(worst);
}

function renderOptimalChart(results, sortKey) {
    var ctx = document.getElementById('optimalChart').getContext('2d');
    if (optimalChartInstance) optimalChartInstance.destroy();

    var labels = [], values = [], winRates = [], colors = [];
    var max = Math.min(results.length, 20);
    for (var i = 0; i < max; i++) {
        var r = results[i];
        var lbl = '#' + r.rank + ' ' + (r.params.take_profit >= 999 ? 'NoTP' : 'TP' + r.params.take_profit) + '/' + (r.params.stop_loss >= 999 ? 'NoSL' : 'SL' + r.params.stop_loss) + '/' + r.params.max_hold_days + 'd';
        labels.push(lbl);
        values.push(r.summary[sortKey] || 0);
        winRates.push(r.summary.win_rate);
        colors.push(r.summary.total_return_pct >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)');
    }

    optimalChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: sortKey.replace(/_/g, ' '), data: values, backgroundColor: colors, borderRadius: 6 },
                { label: 'Win Rate %', data: winRates, backgroundColor: 'rgba(99,102,241,0.4)', borderRadius: 6 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { labels: { color: '#8888aa' } } },
            scales: {
                x: { grid: { color: 'rgba(42,42,74,0.5)' }, ticks: { color: '#8888aa' } },
                y: { grid: { display: false }, ticks: { color: '#8888aa', font: { size: 10 } } }
            }
        }
    });
}

function renderOptimalTable(results) {
    var tbody = document.getElementById('optimalTable').querySelector('tbody');
    var html = '';
    for (var i = 0; i < results.length; i++) {
        var r = results[i];
        var s = r.summary;
        var p = r.params;
        var cls = s.total_return_pct >= 0 ? 'positive' : 'negative';
        var bestTrade = s.best_trade ? (s.best_trade.ticker + ' ' + fmtPct(s.best_trade.return_pct)) : '‚Äî';
        var isWinner = (i === 0);
        var rowStyle = isWinner ? ' style="background:rgba(34,197,94,0.08);"' : '';
        html += '<tr' + rowStyle + '>'
             + '<td>' + (isWinner ? '<strong style="color:var(--green);">#' + r.rank + ' &#x1F3C6;</strong>' : '#' + r.rank) + '</td>'
             + '<td style="font-size:0.75rem;">' + p.label + '</td>'
             + '<td>' + (p.take_profit >= 999 ? '‚Äî' : p.take_profit + '%') + '</td>'
             + '<td>' + (p.stop_loss >= 999 ? '‚Äî' : p.stop_loss + '%') + '</td>'
             + '<td>' + p.max_hold_days + 'd</td>'
             + '<td><span class="badge ' + (p.vol_filter === 'off' ? 'badge-blue' : 'badge-yellow') + '">' + p.vol_filter + '</span></td>'
             + '<td>' + p.fee_model + '</td>'
             + '<td>' + s.total_trades + '</td>'
             + '<td>' + s.win_rate + '%</td>'
             + '<td class="' + cls + '"><strong>' + fmtPct(s.total_return_pct) + '</strong></td>'
             + '<td>$' + fmtNum(s.final_value) + '</td>'
             + '<td class="negative">' + fmtPct(-s.max_drawdown_pct) + '</td>'
             + '<td>' + s.sharpe_ratio + '</td>'
             + '<td>' + s.profit_factor + '</td>'
             + '<td>$' + fmtNum(s.total_commissions) + '</td>'
             + '<td style="font-size:0.75rem;">' + bestTrade + '</td>'
             + '</tr>';
    }
    tbody.innerHTML = html || '<tr><td colspan="16" style="text-align:center;">No results</td></tr>';
}

function renderWorstTable(results) {
    var tbody = document.getElementById('worstTable').querySelector('tbody');
    var html = '';
    for (var i = 0; i < results.length; i++) {
        var r = results[i];
        var s = r.summary;
        var p = r.params;
        var worstTrade = s.worst_trade ? (s.worst_trade.ticker + ' ' + fmtPct(s.worst_trade.return_pct)) : '‚Äî';
        html += '<tr>'
             + '<td>#' + r.rank + '</td>'
             + '<td style="font-size:0.75rem;">' + p.label + '</td>'
             + '<td>' + s.total_trades + '</td>'
             + '<td>' + s.win_rate + '%</td>'
             + '<td class="negative"><strong>' + fmtPct(s.total_return_pct) + '</strong></td>'
             + '<td>$' + fmtNum(s.final_value) + '</td>'
             + '<td class="negative">' + fmtPct(-s.max_drawdown_pct) + '</td>'
             + '<td style="font-size:0.75rem;color:var(--red);">' + worstTrade + '</td>'
             + '</tr>';
    }
    tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center;">No results</td></tr>';
}

var optSortDir = {};
function sortOptTable(colIdx) {
    var table = document.getElementById('optimalTable');
    var tbody = table.querySelector('tbody');
    var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
    var dir = optSortDir[colIdx] === 'asc' ? 'desc' : 'asc';
    optSortDir[colIdx] = dir;
    rows.sort(function(a, b) {
        var aVal = a.cells[colIdx].textContent.replace(/[$%+,#üèÜ]/g, '').trim();
        var bVal = b.cells[colIdx].textContent.replace(/[$%+,#üèÜ]/g, '').trim();
        var aNum = parseFloat(aVal);
        var bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) return dir === 'asc' ? aNum - bNum : bNum - aNum;
        return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });
    for (var i = 0; i < rows.length; i++) tbody.appendChild(rows[i]);
}

// Populate optimal algo filter dropdown with loaded algorithms
function populateOptAlgoFilter() {
    var sel = document.getElementById('optAlgoFilter');
    if (!sel || !allAlgorithms) return;
    // Keep existing options (All + Blue Chip), add rest
    for (var i = 0; i < allAlgorithms.length; i++) {
        var a = allAlgorithms[i];
        if (a.name === 'Blue Chip Growth') continue; // Already in HTML
        var opt = document.createElement('option');
        opt.value = a.name;
        opt.textContent = a.name + ' (' + (a.pick_count || 0) + ' picks)';
        sel.appendChild(opt);
    }
}
</script>
</body>
</html>
