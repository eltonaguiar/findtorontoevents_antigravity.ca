<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock System Status | Portfolio Analysis v2</title>
    <style>
        :root {
            --bg-dark: #0a0a1a; --bg-card: #12122a; --border: #2a2a4a;
            --text: #e0e0f0; --text-dim: #8888aa; --accent: #6366f1;
            --green: #22c55e; --green-dim: rgba(34,197,94,0.15);
            --red: #ef4444; --red-dim: rgba(239,68,68,0.15);
            --yellow: #eab308; --yellow-dim: rgba(234,179,8,0.15);
            --blue: #3b82f6; --radius: 12px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg-dark); color:var(--text); min-height:100vh; line-height:1.5; }
        a { color:var(--accent); text-decoration:none; }
        a:hover { text-decoration:underline; }
        .header { background:linear-gradient(135deg,#12122a,#1e1e3f); border-bottom:1px solid var(--border); padding:1rem 2rem; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem; }
        .header h1 { font-size:1.5rem; background:linear-gradient(135deg,var(--accent),#a78bfa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .header-links { display:flex; gap:1rem; font-size:0.9rem; flex-wrap:wrap; }
        .header-links a { color:var(--text-dim); }
        .container { max-width:1200px; margin:0 auto; padding:1.5rem; }
        .card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:1.5rem; margin-bottom:1.5rem; }
        .card h2 { font-size:1.1rem; margin-bottom:0.5rem; display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
        .stat-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1rem; margin-bottom:1.5rem; }
        .stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:1rem; text-align:center; }
        .stat-card .label { font-size:0.7rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.05em; }
        .stat-card .value { font-size:1.3rem; font-weight:700; margin-top:0.25rem; }
        .positive { color:var(--green); }
        .negative { color:var(--red); }
        .neutral { color:var(--text); }
        .warning { color:var(--yellow); }
        table { width:100%; border-collapse:collapse; font-size:0.85rem; }
        th,td { padding:0.5rem 0.75rem; text-align:left; border-bottom:1px solid var(--border); }
        th { color:var(--text-dim); font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; }
        .badge { display:inline-block; padding:0.15rem 0.5rem; border-radius:4px; font-size:0.7rem; font-weight:600; }
        .badge-green { background:var(--green-dim); color:var(--green); }
        .badge-red { background:var(--red-dim); color:var(--red); }
        .badge-yellow { background:var(--yellow-dim); color:var(--yellow); }
        .badge-blue { background:rgba(59,130,246,0.15); color:var(--blue); }
        .status-ok { color:var(--green); }
        .status-warn { color:var(--yellow); }
        .status-fail { color:var(--red); }
        .loading { text-align:center; padding:2rem; color:var(--text-dim); }
        .spinner { display:inline-block; width:20px; height:20px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
        @media (max-width:768px) { .grid-2 { grid-template-columns:1fr; } .container { padding:1rem; } }
        .refresh-btn { background:var(--accent); color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-size:0.85rem; }
        .refresh-btn:hover { background:#5558e6; }
        .timestamp { font-size:0.8rem; color:var(--text-dim); }
        .data-type-tag { font-size:0.6rem; padding:0.15rem 0.5rem; border-radius:4px; font-weight:700; text-transform:uppercase; letter-spacing:0.03em; vertical-align:middle; }
        .tag-backtest { background:rgba(234,179,8,0.15); color:var(--yellow); border:1px solid rgba(234,179,8,0.3); }
        .tag-live { background:rgba(34,197,94,0.15); color:var(--green); border:1px solid rgba(34,197,94,0.3); }
        .tag-forward { background:rgba(99,102,241,0.15); color:var(--accent); border:1px solid rgba(99,102,241,0.3); }
        .section-help { font-size:0.78rem; color:var(--text-dim); line-height:1.5; margin-bottom:1rem; padding:0.75rem; background:rgba(99,102,241,0.04); border:1px solid rgba(99,102,241,0.1); border-radius:8px; }
        .section-help strong { color:var(--text); }
        .section-meta { font-size:0.7rem; color:var(--text-dim); margin-top:0.75rem; display:flex; gap:1rem; flex-wrap:wrap; }
    </style>
</head>
<body>
    <div class="header">
        <h1>System Status &amp; Analytics</h1>
        <div class="header-links">
            <a href="/findstocks/portfolio2/hub.html">Hub</a>
            <a href="/findstocks/portfolio2/">Dashboard</a>
            <a href="/findstocks/portfolio2/leaderboard.html">Leaderboard</a>
            <a href="/findstocks/portfolio2/learning-dashboard.html">Self-Learning</a>
            <a href="/findstocks/">Home</a>
        </div>
    </div>

    <div class="container">
        <!-- Data Integrity Notice -->
        <div style="background:rgba(234,179,8,0.06);border:1px solid rgba(234,179,8,0.2);border-radius:var(--radius);padding:1rem;margin-bottom:1.5rem;font-size:0.8rem;color:var(--text-dim);line-height:1.6;">
            <strong style="color:var(--yellow);">Understanding This Data</strong><br>
            <span class="data-type-tag tag-backtest">Backtest</span> = Simulated results using historical data. Shows what <em>would have</em> happened, not what <em>will</em> happen. Subject to look-ahead bias, survivorship bias, and execution assumptions.<br>
            <span class="data-type-tag tag-live">Live Data</span> = Real-time database statistics and current prices.<br>
            <span class="data-type-tag tag-forward">Forward-Looking</span> = Algorithm-generated picks for future trades. Unproven until markets validate them.<br>
            <strong style="color:var(--text);">Past backtest performance does NOT predict future results.</strong> All simulations assume $10,000 starting capital, 10% position sizing, $10 round-trip commission, and 0.5% slippage unless otherwise noted.
        </div>

        <div id="last-updated" class="card" style="text-align:center;">
            <span class="spinner"></span> Loading system status...
        </div>

        <!-- Database Stats -->
        <div class="stat-grid" id="db-stats"></div>

        <!-- System Health -->
        <div class="card" id="health-card">
            <h2><span class="data-type-tag tag-live">Live</span> System Health</h2>
            <div class="section-help">Real-time check of database connectivity, data freshness, and price coverage. A healthy system shows all green. <strong>Data Freshness</strong> checks if the most recent picks are from 2026. <strong>Price Coverage</strong> checks if daily prices are up to date.</div>
            <div id="health-checks"></div>
        </div>

        <div class="grid-2">
            <!-- Algorithm Performance -->
            <div class="card">
                <h2><span class="data-type-tag tag-live">Live</span> Algorithm Performance Summary</h2>
                <div class="section-help">Each algorithm generates stock picks with a confidence score (0-100). <strong>Avg Score</strong> is the mean confidence across all picks. Status: Strong (80+), Moderate (60-79), Weak (&lt;60). Scores reflect the algorithm's internal confidence, not realized returns.</div>
                <div class="table-wrap">
                    <table id="algo-table">
                        <thead><tr><th>Algorithm</th><th>Picks</th><th>Avg Score</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="section-meta" id="algo-meta"></div>
            </div>

            <!-- Strategy Rankings -->
            <div class="card">
                <h2><span class="data-type-tag tag-backtest">Backtest</span> Strategy Rankings</h2>
                <div class="section-help">Each strategy applies different TP% / SL% / hold period rules to ALL picks and backtests against historical prices. <strong>Return %</strong> is total portfolio return on $10,000. <strong>Win Rate</strong> is % of trades that were profitable. Rankings are pre-computed by our nightly automation and cached.</div>
                <div id="strat-loading" style="text-align:center;padding:1rem;"><span class="spinner"></span> Loading cached rankings...</div>
                <div class="table-wrap" style="display:none;" id="strat-wrap">
                    <table id="strat-table">
                        <thead><tr><th>#</th><th>Strategy</th><th>Return %</th><th>Win Rate</th><th>Verdict</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="section-meta" id="strat-meta"></div>
            </div>
        </div>

        <!-- Top Trades -->
        <div class="card">
            <h2><span class="data-type-tag tag-backtest">Backtest</span> Top Performing Trades</h2>
            <div class="section-help">The 10 best-performing historical trades from our backtest engine. Uses TP=50%, SL=10%, 30-day max hold on $10,000 capital. <strong>P&amp;L</strong> is net profit after $10 commission and 0.5% slippage per trade. <strong>These are simulated past results, not live trades.</strong></div>
            <div class="table-wrap">
                <table id="top-trades-table">
                    <thead><tr><th>#</th><th>Ticker</th><th>Algorithm</th><th>Entry</th><th>Exit</th><th>Return %</th><th>P&L</th><th>Hold Days</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="section-meta" id="top-meta"></div>
        </div>

        <!-- Worst Trades -->
        <div class="card">
            <h2><span class="data-type-tag tag-backtest">Backtest</span> Worst Performing Trades</h2>
            <div class="section-help">The 10 worst-performing historical trades using the same backtest parameters. Reviewing losses is critical for understanding risk. <strong>These losses are simulated</strong> — they show what would have happened with those parameters on past picks.</div>
            <div class="table-wrap">
                <table id="worst-trades-table">
                    <thead><tr><th>#</th><th>Ticker</th><th>Algorithm</th><th>Entry</th><th>Exit</th><th>Return %</th><th>P&L</th><th>Hold Days</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Learning Algorithm Insights -->
        <div class="card">
            <h2><span class="data-type-tag tag-backtest">Backtest</span> Learning Algorithm Recommendations</h2>
            <div class="section-help">Our self-learning engine tests 180 parameter combinations (6 TP x 6 SL x 5 hold periods) per algorithm to find optimal settings. It compares each algo's <strong>current return</strong> vs <strong>best possible return</strong> and recommends parameter changes. Results are pre-computed by the nightly GitHub Actions pipeline. <strong>Heavy computation — uses cached results on page load.</strong></div>
            <div id="learning-results"><span class="spinner"></span> Loading cached recommendations...</div>
            <div class="section-meta" id="learning-meta"></div>
        </div>

        <!-- Bear / Short Analysis -->
        <div class="card">
            <h2><span class="data-type-tag tag-backtest">Backtest</span> Bear Market / Short Opportunity Analysis</h2>
            <div class="section-help">Identifies stocks that <strong>declined</strong> after our algorithms issued a BUY signal. These "failed longs" reveal potential short/inverse opportunities. <strong>Short Profit %</strong> = what you'd earn if you shorted instead of buying. Also proposes conceptual inverse algorithms. <em>Requires on-demand computation.</em></div>
            <button class="refresh-btn" onclick="runBearAnalysis()">Analyze Short Opportunities</button>
            <div id="bear-results" style="margin-top:1rem;"></div>
        </div>

        <!-- Permutation Scan -->
        <div class="card">
            <h2><span class="data-type-tag tag-backtest">Backtest</span> Exhaustive Parameter Scan</h2>
            <div class="section-help">Brute-force tests 1,287 combinations of Take Profit (1-50%), Stop Loss (1-25%), and Hold Period (1-60 days) to find the absolute best parameters across all algorithms. <strong>Warning:</strong> This is the most computationally intensive operation — it may take 30-60 seconds or time out on first run. Results are pre-computed when available.</div>
            <button class="refresh-btn" onclick="runPermScan()">Run Full Permutation Scan</button>
            <div id="perm-results" style="margin-top:1rem;"></div>
        </div>

        <!-- Audit Log -->
        <div class="card">
            <h2><span class="data-type-tag tag-live">Live</span> Recent Activity Log</h2>
            <div class="section-help">Shows recent automated actions: learning runs, parameter adjustments, and data refreshes. Populated by the GitHub Actions nightly pipeline and on-demand analyses.</div>
            <div class="table-wrap">
                <table id="audit-table">
                    <thead><tr><th>Time</th><th>Action</th><th>Details</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
var API = '/findstocks/portfolio2/api/';

document.addEventListener('DOMContentLoaded', function() {
    loadAllData();
});

function apiGet(url, cb) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', API + url, true);
    xhr.timeout = 20000;
    xhr.onload = function() {
        try { cb(JSON.parse(xhr.responseText)); }
        catch(e) { cb({ok:false,error:'Parse error'}); }
    };
    xhr.onerror = function() { cb({ok:false,error:'Network error'}); };
    xhr.ontimeout = function() { cb({ok:false,error:'Request timed out'}); };
    xhr.send();
}

function loadAllData() {
    // Stats
    apiGet('data.php?type=stats', function(d) {
        if (!d.ok || !d.stats) {
            document.getElementById('last-updated').innerHTML = '<span class="status-fail">Database connection failed.</span>';
            return;
        }
        var s = d.stats;
        var now = new Date().toLocaleString();
        document.getElementById('last-updated').innerHTML =
            '<div style="font-size:1.1rem;font-weight:700;">System Online</div>'
            + '<div class="timestamp">Last checked: ' + now + '</div>'
            + '<div class="timestamp">Pick data: ' + (s.pick_date_range ? s.pick_date_range.earliest + ' to ' + s.pick_date_range.latest : 'N/A') + '</div>'
            + '<div class="timestamp">Price data: ' + (s.price_date_range ? s.price_date_range.earliest + ' to ' + s.price_date_range.latest : 'N/A') + '</div>'
            + '<div class="timestamp" style="margin-top:0.5rem;">Simulated capital: <strong>$10,000</strong> | Position size: <strong>10%</strong> | Commission: <strong>$10/trade</strong> | Slippage: <strong>0.5%</strong></div>';

        var statsHtml = '';
        var items = [
            ['Stocks Tracked', s.total_stocks, 'neutral'],
            ['Stock Picks', s.total_picks, 'neutral'],
            ['Price Records', (s.total_price_records||0).toLocaleString(), 'neutral'],
            ['Active Algorithms', s.active_algorithms, 'neutral'],
            ['Backtests Run', s.total_backtests, 'neutral'],
            ['Sim Capital', '$10,000', 'neutral']
        ];
        for (var i = 0; i < items.length; i++) {
            statsHtml += '<div class="stat-card"><div class="label">' + items[i][0] + '</div><div class="value ' + items[i][2] + '">' + items[i][1] + '</div></div>';
        }
        document.getElementById('db-stats').innerHTML = statsHtml;

        // Algorithm breakdown
        var tbody = document.querySelector('#algo-table tbody');
        tbody.innerHTML = '';
        var ab = s.algorithm_breakdown || [];
        for (var i = 0; i < ab.length; i++) {
            var a = ab[i];
            var avgScore = parseFloat(a.avg_score || 0).toFixed(1);
            var status = avgScore >= 80 ? 'badge-green' : avgScore >= 60 ? 'badge-yellow' : 'badge-red';
            var statusText = avgScore >= 80 ? 'Strong' : avgScore >= 60 ? 'Moderate' : 'Weak';
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + a.algorithm_name + '</td><td>' + a.cnt + '</td><td>' + avgScore + '</td>'
                + '<td><span class="badge ' + status + '">' + statusText + '</span></td>';
            tbody.appendChild(tr);
        }
        document.getElementById('algo-meta').innerHTML = 'Data source: stock_picks table | Refreshed: ' + now;

        // Health checks
        var hc = document.getElementById('health-checks');
        var checks = [
            ['Database Connection', true, 'Connected to ejaguiar1_stocks'],
            ['Stock Picks', s.total_picks > 0, s.total_picks + ' picks loaded'],
            ['Price Data', s.total_price_records > 100, s.total_price_records + ' records'],
            ['Data Freshness', s.pick_date_range && s.pick_date_range.latest >= '2026-01-01', 'Latest: ' + (s.pick_date_range ? s.pick_date_range.latest : 'N/A')],
            ['Price Coverage', s.price_date_range && s.price_date_range.latest >= '2026-01-01', 'Latest: ' + (s.price_date_range ? s.price_date_range.latest : 'N/A')]
        ];
        var hhtml = '<table><tbody>';
        for (var i = 0; i < checks.length; i++) {
            var c = checks[i];
            hhtml += '<tr><td>' + c[0] + '</td><td class="' + (c[1] ? 'status-ok' : 'status-fail') + '">' + (c[1] ? 'OK' : 'ISSUE') + '</td><td style="color:var(--text-dim)">' + c[2] + '</td></tr>';
        }
        hhtml += '</tbody></table>';
        hc.innerHTML = hhtml;
    });

    // Strategy rankings — use cached endpoint
    apiGet('whatif.php?action=cached_compare', function(d) {
        var loadEl = document.getElementById('strat-loading');
        var wrapEl = document.getElementById('strat-wrap');
        if (!d.ok || !d.scenarios) {
            loadEl.innerHTML = '<span style="color:var(--text-dim);">No cached rankings available yet. Rankings are generated nightly by our automation pipeline.</span>';
            return;
        }
        loadEl.style.display = 'none';
        wrapEl.style.display = 'block';
        var tbody = document.querySelector('#strat-table tbody');
        tbody.innerHTML = '';
        var sc = d.scenarios || [];
        for (var i = 0; i < Math.min(sc.length, 20); i++) {
            var s = sc[i].summary;
            var verdict = s.total_return_pct > 0 ? 'badge-green' : s.total_return_pct > -5 ? 'badge-yellow' : 'badge-red';
            var vtext = s.total_return_pct > 0 ? 'Profitable' : s.total_return_pct > -5 ? 'Marginal' : 'Losing';
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + (i+1) + '</td><td title="' + (sc[i].description||'') + '">' + sc[i].name + '</td>'
                + '<td class="' + (s.total_return_pct >= 0 ? 'positive' : 'negative') + '">' + s.total_return_pct.toFixed(2) + '%</td>'
                + '<td>' + s.win_rate + '%</td>'
                + '<td><span class="badge ' + verdict + '">' + vtext + '</span></td>';
            tbody.appendChild(tr);
        }
        var metaHtml = 'Showing top ' + Math.min(sc.length, 20) + ' of ' + d.total_scenarios + ' strategies';
        if (d.cached_at) metaHtml += ' | Computed: ' + d.cached_at;
        if (d.cache_age_seconds) {
            var hrs = Math.round(d.cache_age_seconds / 3600);
            metaHtml += ' (' + (hrs < 1 ? '<1' : hrs) + 'h ago)';
        }
        metaHtml += ' | Capital: $' + (d.initial_capital || 10000).toLocaleString();
        document.getElementById('strat-meta').innerHTML = metaHtml;
    });

    // Top/worst trades
    apiGet('backtest.php?take_profit=50&stop_loss=10&max_hold_days=30', function(d) {
        if (!d.ok || !d.trades) return;
        var trades = d.trades.slice();
        trades.sort(function(a,b) { return b.return_pct - a.return_pct; });

        // Top 10
        var tbody = document.querySelector('#top-trades-table tbody');
        tbody.innerHTML = '';
        for (var i = 0; i < Math.min(10, trades.length); i++) {
            var t = trades[i];
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + (i+1) + '</td><td><strong>' + t.ticker + '</strong></td><td>' + t.algorithm + '</td>'
                + '<td>' + t.entry_date + ' $' + t.entry_price.toFixed(2) + '</td>'
                + '<td>' + t.exit_date + ' $' + t.exit_price.toFixed(2) + '</td>'
                + '<td class="' + (t.return_pct >= 0 ? 'positive' : 'negative') + '">' + t.return_pct.toFixed(2) + '%</td>'
                + '<td class="' + (t.net_profit >= 0 ? 'positive' : 'negative') + '">$' + t.net_profit.toFixed(2) + '</td>'
                + '<td>' + t.hold_days + 'd</td>';
            tbody.appendChild(tr);
        }
        document.getElementById('top-meta').innerHTML = 'Backtest params: TP=50%, SL=10%, Hold=30d | Capital: $10,000 | Total trades simulated: ' + trades.length;

        // Worst 10
        var tbody2 = document.querySelector('#worst-trades-table tbody');
        tbody2.innerHTML = '';
        for (var i = trades.length - 1; i >= Math.max(0, trades.length - 10); i--) {
            var t = trades[i];
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + (trades.length - i) + '</td><td><strong>' + t.ticker + '</strong></td><td>' + t.algorithm + '</td>'
                + '<td>' + t.entry_date + ' $' + t.entry_price.toFixed(2) + '</td>'
                + '<td>' + t.exit_date + ' $' + t.exit_price.toFixed(2) + '</td>'
                + '<td class="' + (t.return_pct >= 0 ? 'positive' : 'negative') + '">' + t.return_pct.toFixed(2) + '%</td>'
                + '<td class="' + (t.net_profit >= 0 ? 'positive' : 'negative') + '">$' + t.net_profit.toFixed(2) + '</td>'
                + '<td>' + t.hold_days + 'd</td>';
            tbody2.appendChild(tr);
        }
    });

    // Learning recommendations — use cached
    apiGet('learning.php?action=cached_results', function(d) {
        var el = document.getElementById('learning-results');
        if (!d.ok || !d.recommendations || d.recommendations.length === 0) {
            el.innerHTML = '<span style="color:var(--text-dim);">No cached learning data yet. The learning engine runs nightly via GitHub Actions.</span>';
            return;
        }
        var html = '<table><thead><tr><th>Algorithm</th><th>Strategy</th><th>Win Rate</th><th>Avg Return</th><th>Best For</th></tr></thead><tbody>';
        var recs = d.recommendations || [];
        for (var i = 0; i < recs.length; i++) {
            var r = recs[i];
            var wr = parseFloat(r.win_rate || 0);
            var wrClass = wr >= 50 ? 'positive' : wr > 0 ? 'warning' : 'negative';
            var ret = parseFloat(r.avg_return_pct || 0);
            var retClass = ret >= 0 ? 'positive' : 'negative';
            html += '<tr><td>' + (r.algorithm_name||'-') + '</td>'
                + '<td>' + (r.strategy_type||'-') + '</td>'
                + '<td class="' + wrClass + '">' + wr.toFixed(1) + '%</td>'
                + '<td class="' + retClass + '">' + ret.toFixed(2) + '%</td>'
                + '<td>' + (r.best_for||'-') + '</td></tr>';
        }
        html += '</tbody></table>';
        el.innerHTML = html;
        document.getElementById('learning-meta').innerHTML = 'Source: algorithm_performance table (pre-computed by nightly learning engine) | ' + recs.length + ' algorithms analyzed';
    });
}

function runBearAnalysis() {
    var el = document.getElementById('bear-results');
    el.innerHTML = '<span class="spinner"></span> Analyzing short/bear opportunities (may take 10-30 seconds)...';
    apiGet('learning.php?action=bear_analysis', function(d) {
        if (!d.ok) { el.innerHTML = '<span style="color:var(--text-dim);">Analysis timed out or returned an error. Try again or wait for the nightly refresh.</span>'; return; }
        var html = '<p style="color:var(--yellow);margin-bottom:1rem;">' + (d.insight||'') + '</p>';
        if (d.short_candidates && d.short_candidates.length > 0) {
            html += '<h3 style="margin-bottom:0.5rem;">Best Short Candidates (stocks that declined after our BUY signal)</h3>';
            html += '<table><thead><tr><th>Ticker</th><th>Algorithm</th><th>Pick Date</th><th>Entry $</th><th>Current $</th><th>Decline %</th><th>Short Profit %</th></tr></thead><tbody>';
            for (var i = 0; i < d.short_candidates.length; i++) {
                var s = d.short_candidates[i];
                html += '<tr><td><strong>' + s.ticker + '</strong></td><td>' + s.algorithm + '</td><td>' + s.pick_date + '</td>'
                    + '<td>$' + s.entry_price + '</td><td>$' + s.current_price + '</td>'
                    + '<td class="negative">' + s.change_pct + '%</td>'
                    + '<td class="positive">+' + s.short_profit_pct + '%</td></tr>';
            }
            html += '</tbody></table>';
        }
        if (d.inverse_algorithms) {
            html += '<h3 style="margin:1.5rem 0 0.5rem;">Proposed Inverse/Short Algorithms</h3>';
            for (var i = 0; i < d.inverse_algorithms.length; i++) {
                var ia = d.inverse_algorithms[i];
                html += '<div style="background:rgba(99,102,241,0.05);border:1px solid var(--border);border-radius:8px;padding:1rem;margin-bottom:0.75rem;">'
                    + '<strong>' + ia.name + '</strong><br>'
                    + '<span style="color:var(--text-dim)">Based on: ' + ia.based_on + '</span><br>'
                    + '<span style="color:var(--text-dim)">' + ia.concept + '</span><br>'
                    + '<span style="color:var(--accent)">' + ia.strategy + '</span></div>';
            }
        }
        el.innerHTML = html;
    });
}

function runPermScan() {
    var el = document.getElementById('perm-results');
    el.innerHTML = '<span class="spinner"></span> Running exhaustive scan (1,287 combos)... this may take 30-60 seconds or time out.';
    apiGet('learning.php?action=permutation_scan&top=20', function(d) {
        if (!d.ok) { el.innerHTML = '<span style="color:var(--text-dim);">Scan timed out. This computation is very heavy. Results are generated by our nightly automation when available.</span>'; return; }
        var html = '<div class="stat-grid" style="margin-bottom:1rem;">'
            + '<div class="stat-card"><div class="label">Total Combos</div><div class="value">' + (d.total_combos||0) + '</div></div>'
            + '<div class="stat-card"><div class="label">Profitable</div><div class="value positive">' + (d.profitable_combos||0) + '</div></div>'
            + '<div class="stat-card"><div class="label">Losing</div><div class="value negative">' + (d.losing_combos||0) + '</div></div>'
            + '<div class="stat-card"><div class="label">Profitability Rate</div><div class="value ' + ((d.profitability_rate||0) > 30 ? 'positive' : 'negative') + '">' + (d.profitability_rate||0) + '%</div></div>'
            + '</div>';
        if (d.top_permutations && d.top_permutations.length > 0) {
            html += '<h3>Top 20 Parameter Combinations</h3>';
            html += '<table><thead><tr><th>#</th><th>TP%</th><th>SL%</th><th>Hold Days</th><th>Return %</th><th>Win Rate</th><th>Trades</th><th>Total P&L</th></tr></thead><tbody>';
            for (var i = 0; i < d.top_permutations.length; i++) {
                var p = d.top_permutations[i];
                html += '<tr><td>' + (i+1) + '</td><td>' + p.take_profit + '</td><td>' + p.stop_loss + '</td><td>' + p.max_hold_days + '</td>'
                    + '<td class="' + (p.return_pct >= 0 ? 'positive' : 'negative') + '"><strong>' + p.return_pct.toFixed(2) + '%</strong></td>'
                    + '<td>' + p.win_rate + '%</td><td>' + p.trades + '</td>'
                    + '<td class="' + (p.total_pnl >= 0 ? 'positive' : 'negative') + '">$' + p.total_pnl.toFixed(2) + '</td></tr>';
            }
            html += '</tbody></table>';
        }
        el.innerHTML = html;
    });
}
</script>

<div style="text-align:center;font-size:0.7rem;color:#8888aa;padding:2rem 1.5rem;border-top:1px solid #2a2a4a;margin-top:2rem;max-width:900px;margin-left:auto;margin-right:auto;line-height:1.6;">
    <strong>Important Disclaimer</strong><br>
    This tool is for <strong>educational and research purposes only</strong> and does not constitute financial advice, investment advice, trading advice, or any other sort of advice.
    Nothing on this page should be construed as a recommendation or solicitation to buy or sell any security or financial product.<br><br>
    <strong>No fiduciary relationship</strong> is created between you and the operators of this website by your use of this tool.
    You are solely responsible for your own investment decisions. <strong>All investments involve risk</strong>, including the possible loss of principal.
    Past performance does not guarantee future results. Backtests and algorithm rankings are based on historical data, may contain errors, and may not reflect real-world execution, slippage, or market conditions.<br><br>
    Data is sourced from third parties (Yahoo Finance) and may be delayed, inaccurate, or incomplete. The operators of this website make no warranties regarding the accuracy, completeness, or timeliness of any information provided.
    <strong>Consult a licensed financial adviser</strong> before making any investment decisions.<br><br>
    <span style="opacity:0.7;">By using this tool you acknowledge that you have read and understood this disclaimer and agree that the operators shall not be held liable for any losses arising from your use of this information.</span>
</div>
</body>
</html>
