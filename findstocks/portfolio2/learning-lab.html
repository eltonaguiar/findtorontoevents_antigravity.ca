<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Lab | Self-Learning Algorithm Dashboard</title>
    <style>
        :root { --bg-dark:#0a0a1a; --bg-card:#12122a; --border:#2a2a4a; --text:#e0e0f0;
            --text-dim:#8888aa; --accent:#6366f1; --green:#22c55e; --red:#ef4444;
            --yellow:#eab308; --blue:#3b82f6; --gold:#f59e0b; --cyan:#06b6d4; --radius:12px; }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:var(--bg-dark);color:var(--text);min-height:100vh;line-height:1.5;}
        a{color:var(--accent);text-decoration:none;} a:hover{text-decoration:underline;}
        .header{background:linear-gradient(135deg,#12122a,#1e1e3f);border-bottom:1px solid var(--border);
            padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;}
        .header h1{font-size:1.5rem;background:linear-gradient(135deg,var(--cyan),var(--accent));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .header-links{display:flex;gap:1rem;font-size:0.85rem;flex-wrap:wrap;}
        .header-links a{color:var(--text-dim);}
        .container{max-width:1200px;margin:0 auto;padding:1.5rem;}
        .section-title{font-size:1.2rem;font-weight:700;margin:2rem 0 1rem;display:flex;align-items:center;gap:0.75rem;}
        .badge{font-size:0.6rem;padding:0.2rem 0.5rem;border-radius:99px;font-weight:700;text-transform:uppercase;}
        .badge-green{background:rgba(34,197,94,0.15);color:var(--green);}
        .badge-red{background:rgba(239,68,68,0.15);color:var(--red);}
        .badge-yellow{background:rgba(234,179,8,0.15);color:var(--yellow);}

        .systems-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;margin-bottom:2rem;}
        .system-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
            padding:1.25rem;transition:border-color 0.2s;}
        .system-card:hover{border-color:var(--accent);}
        .system-name{font-size:1.1rem;font-weight:700;margin-bottom:0.5rem;}
        .system-stat{display:flex;justify-content:space-between;font-size:0.8rem;padding:0.25rem 0;
            border-bottom:1px solid rgba(42,42,74,0.5);}
        .system-stat .lbl{color:var(--text-dim);}
        .system-stat .val{font-weight:700;font-family:monospace;}
        .system-status{display:inline-block;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.65rem;
            font-weight:700;margin-top:0.5rem;}
        .status-active{background:rgba(34,197,94,0.15);color:var(--green);}
        .status-stale{background:rgba(234,179,8,0.15);color:var(--yellow);}
        .status-inactive{background:rgba(239,68,68,0.15);color:var(--red);}

        .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
            padding:1.25rem;margin-bottom:1rem;}
        .card-title{font-size:1rem;font-weight:700;margin-bottom:0.75rem;}

        .improve-row{padding:1rem;border-bottom:1px solid rgba(42,42,74,0.5);}
        .improve-header{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem;}
        .improve-name{font-weight:700;font-size:1rem;}
        .improve-arrow{font-size:1.2rem;font-weight:800;}
        .improve-detail{font-size:0.8rem;color:var(--text-dim);line-height:1.6;}
        .improve-detail .label{color:var(--text-dim);} .improve-detail .value{color:var(--text);font-weight:600;font-family:monospace;}
        .improve-bar{display:flex;gap:1.5rem;margin-top:0.5rem;flex-wrap:wrap;}
        .improve-bar-item{display:flex;flex-direction:column;align-items:center;gap:0.15rem;}
        .improve-bar-label{font-size:0.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.03em;}
        .improve-bar-value{font-size:1.1rem;font-weight:700;font-family:monospace;}
        .improve-meta{font-size:0.7rem;color:var(--text-dim);margin-top:0.5rem;display:flex;gap:1rem;flex-wrap:wrap;}
        .improve-waiting{background:rgba(234,179,8,0.08);border:1px dashed rgba(234,179,8,0.3);border-radius:8px;
            padding:0.75rem;margin-top:0.5rem;font-size:0.8rem;color:var(--yellow);}

        .history-table{width:100%;border-collapse:collapse;font-size:0.8rem;}
        .history-table th{text-align:left;padding:0.5rem;border-bottom:1px solid var(--border);
            color:var(--text-dim);font-size:0.7rem;text-transform:uppercase;}
        .history-table td{padding:0.5rem;border-bottom:1px solid rgba(42,42,74,0.5);}

        .loading{text-align:center;padding:3rem;color:var(--text-dim);}
        .spinner{display:inline-block;width:32px;height:32px;border:3px solid var(--border);
            border-top:3px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}

        .disclaimer{text-align:center;font-size:0.7rem;color:var(--text-dim);
            padding:2rem 1.5rem;border-top:1px solid var(--border);margin-top:2rem;
            max-width:900px;margin-left:auto;margin-right:auto;line-height:1.6;}

        @media(max-width:768px){.systems-grid{grid-template-columns:1fr;}.container{padding:1rem;}}
        .data-type-tag { font-size:0.6rem; padding:0.15rem 0.5rem; border-radius:4px; font-weight:700; text-transform:uppercase; letter-spacing:0.03em; vertical-align:middle; }
        .tag-backtest { background:rgba(234,179,8,0.15); color:#eab308; border:1px solid rgba(234,179,8,0.3); }
        .tag-live { background:rgba(34,197,94,0.15); color:#22c55e; border:1px solid rgba(34,197,94,0.3); }
        .tag-forward { background:rgba(99,102,241,0.15); color:#6366f1; border:1px solid rgba(99,102,241,0.3); }
    </style>
</head>
<body>
    <div class="header">
        <h1>Learning Lab</h1>
        <div class="header-links">
            <a href="consolidated.html">Consolidated</a>
            <a href="picks.html">Top Picks</a>
            <a href="leaderboard.html">Leaderboard</a>
            <a href="daytrader-sim.html">DayTrader Sim</a>
            <a href="hub.html">Hub</a>
        </div>
    </div>

    <div class="container">
        <div style="display:flex;gap:0.75rem;flex-wrap:wrap;align-items:center;font-size:0.72rem;color:#8888aa;margin-bottom:1rem;padding:0.5rem 0.75rem;background:rgba(234,179,8,0.04);border:1px solid rgba(234,179,8,0.15);border-radius:8px;">
            <span>Data types:</span>
            <span class="data-type-tag tag-live">Live</span> <span>System status &amp; run history</span>
            <span style="opacity:0.3;">|</span>
            <span class="data-type-tag tag-backtest">Backtest</span> <span>Improvement recommendations based on simulated trades</span>
        </div>
        <div class="section-title">Learning Systems Overview</div>
        <div class="systems-grid" id="systemsGrid">
            <div class="loading"><div class="spinner"></div><br>Loading systems...</div>
        </div>

        <div class="section-title">Are Our Algorithms Getting Smarter? <span class="badge" id="improveBadge">...</span></div>
        <p style="color:var(--text-dim);font-size:0.8rem;margin:-0.5rem 0 1rem;">Compares the win rate of our <strong>earliest</strong> picks vs our <strong>most recent</strong> picks. If the number goes up, the algorithm is learning from past mistakes.</p>
        <div id="improvementPanel" class="card">
            <div class="loading"><div class="spinner"></div></div>
        </div>

        <div class="section-title">Parameter Change History
            <select id="historySystem" onchange="loadHistory()" style="background:var(--bg-card);color:var(--text);border:1px solid var(--border);padding:0.3rem 0.5rem;border-radius:6px;font-size:0.8rem;">
                <option value="miracle_v3">Miracle v3 (Claude)</option>
                <option value="miracle_v2">Miracle v2</option>
                <option value="stocks_v1">Stocks v1</option>
                <option value="mutualfunds">Mutual Funds</option>
                <option value="forex">Forex</option>
                <option value="crypto">Crypto</option>
            </select>
        </div>
        <div id="historyPanel" class="card">
            <div class="loading"><div class="spinner"></div></div>
        </div>

        <div class="disclaimer">
            <strong>Important Disclaimer</strong><br>
            Self-learning algorithm adjustments are automated and may not improve future performance.
            Past algorithmic improvements do not guarantee future results.
            This tool is for <strong>educational and research purposes only</strong>.
        </div>
    </div>

<script>
var API_BASE = (function(){
    var h = window.location.hostname;
    return (h==='findtorontoevents.ca'||h==='www.findtorontoevents.ca') ? '/findstocks/portfolio2/api/' : 'api/';
})();

function apiGet(ep,cb){
    var x=new XMLHttpRequest();x.open('GET',API_BASE+ep,true);
    x.onload=function(){if(x.status>=200&&x.status<400){try{cb(null,JSON.parse(x.responseText));}catch(e){cb('Parse error');}}else cb('HTTP '+x.status);};
    x.onerror=function(){cb('Network error');};x.send();
}
function esc(s){return s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';}

function loadOverview(){
    apiGet('learning_dashboard.php?action=overview',function(err,d){
        var g=document.getElementById('systemsGrid');
        if(err||!d||!d.ok){g.innerHTML='<div class="card" style="color:var(--red);">Error: '+(err||'Unknown')+'</div>';return;}
        var html='';
        var sys=d.systems||[];
        for(var i=0;i<sys.length;i++){
            var s=sys[i];
            var statusClass='status-inactive';var statusText='No Data';
            if(s.last_run){
                var days=(Date.now()-new Date(s.last_run).getTime())/86400000;
                if(days<2){statusClass='status-active';statusText='Active';}
                else if(days<7){statusClass='status-stale';statusText='Stale ('+Math.round(days)+'d ago)';}
                else{statusClass='status-inactive';statusText='Inactive ('+Math.round(days)+'d ago)';}
            }
            html+='<div class="system-card">';
            html+='<div class="system-name">'+esc(s.name)+'</div>';
            html+='<div class="system-stat"><span class="lbl">Algorithms</span><span class="val">'+s.algorithms_tracked+'</span></div>';
            html+='<div class="system-stat"><span class="lbl">Adjustments Made</span><span class="val">'+s.adjustments_made+'</span></div>';
            html+='<div class="system-stat"><span class="lbl">Last Run</span><span class="val">'+(s.last_run?s.last_run.split(' ')[0]:'Never')+'</span></div>';
            if(s.best_algo){
                html+='<div class="system-stat"><span class="lbl">Best Algo</span><span class="val" style="color:var(--green);">'+esc(s.best_algo.algorithm_name||s.best_algo.strategy_name||'-')+' ('+(s.best_algo.win_rate||0)+'%)</span></div>';
            }
            html+='<span class="system-status '+statusClass+'">'+statusText+'</span>';
            if(s.page) html+=' <a href="'+s.page+'" style="font-size:0.7rem;margin-left:0.5rem;">View Page</a>';
            html+='</div>';
        }
        g.innerHTML=html||'<div class="card">No learning systems found.</div>';
    });
}

function loadImprovement(){
    apiGet('learning_dashboard.php?action=is_improving',function(err,d){
        var p=document.getElementById('improvementPanel');
        var b=document.getElementById('improveBadge');
        if(err||!d||!d.ok){p.innerHTML='<div style="color:var(--red);">Error loading improvement data</div>';return;}
        b.textContent=d.overall_improving?'Improving':'Waiting for data';
        b.className='badge '+(d.overall_improving?'badge-green':'badge-yellow');
        var html='';
        var imps=d.improvements||[];
        for(var i=0;i<imps.length;i++){
            var im=imps[i];
            var improving=im.is_improving;
            var hasData=false;
            var earlyWR=0,recentWR=0,earlyCount=0,recentCount=0,earlyLabel='Earliest 30 Picks',recentLabel='Latest 30 Picks';

            if(im.first_30_win_rate!==undefined){
                earlyWR=im.first_30_win_rate; recentWR=im.last_30_win_rate;
                earlyCount=im.first_30_trades||0; recentCount=im.last_30_trades||0;
                hasData=(earlyCount>0||recentCount>0);
            }else if(im.first_backtests_win_rate!==undefined){
                earlyWR=im.first_backtests_win_rate; recentWR=im.last_backtests_win_rate;
                earlyLabel='First 10 Backtests'; recentLabel='Last 10 Backtests';
                earlyCount=im.total_backtests||0; recentCount=earlyCount;
                hasData=(earlyCount>0);
            }

            var arrow=improving?'<span class="improve-arrow" style="color:var(--green);">&#9650; Getting better</span>'
                               :'<span class="improve-arrow" style="color:var(--text-dim);">&#9644; No change yet</span>';
            if(hasData && im.improvement_pct<0) arrow='<span class="improve-arrow" style="color:var(--red);">&#9660; Needs work</span>';

            html+='<div class="improve-row">';
            html+='<div class="improve-header"><div class="improve-name">'+esc(im.name)+'</div>'+arrow+'</div>';

            if(!hasData){
                // No resolved trades yet â€” show helpful explanation
                var totalPicks=im.total_picks||0;
                var msg='No trades have resolved yet (hit take-profit or stop-loss).';
                if(totalPicks>0) msg=totalPicks+' picks made so far, but none have resolved yet (hit take-profit or stop-loss).';
                html+='<div class="improve-waiting">';
                html+=msg+' This data appears once the daily refresh job resolves open picks.';
                html+='</div>';
            }else{
                // Show the comparison bars
                html+='<div class="improve-detail">';
                html+='<div class="improve-bar">';
                html+='<div class="improve-bar-item"><span class="improve-bar-label">'+earlyLabel+'</span>';
                html+='<span class="improve-bar-value" style="color:var(--text-dim);">'+earlyWR+'%</span>';
                if(earlyCount>0) html+='<span class="improve-bar-label">win rate ('+earlyCount+' trades)</span>';
                html+='</div>';
                html+='<div class="improve-bar-item" style="font-size:1.5rem;color:var(--text-dim);align-self:center;">&#8594;</div>';
                html+='<div class="improve-bar-item"><span class="improve-bar-label">'+recentLabel+'</span>';
                html+='<span class="improve-bar-value" style="color:'+(improving?'var(--green)':'var(--text)')+';">'+recentWR+'%</span>';
                if(recentCount>0) html+='<span class="improve-bar-label">win rate ('+recentCount+' trades)</span>';
                html+='</div>';
                html+='<div class="improve-bar-item"><span class="improve-bar-label">Change</span>';
                html+='<span class="improve-bar-value" style="color:'+(im.improvement_pct>0?'var(--green)':im.improvement_pct<0?'var(--red)':'var(--text-dim)')+';">'+(im.improvement_pct>0?'+':'')+im.improvement_pct+'%</span></div>';
                html+='</div></div>';
            }

            // GitHub job info + last run
            var meta=[];
            if(im.github&&im.github.job) meta.push('GitHub Job: <strong>'+esc(im.github.job)+'</strong>');
            if(im.last_run) meta.push('Last data: '+esc(im.last_run.split(' ')[0]));
            else meta.push('Last data: <em>Never run</em>');
            if(meta.length>0) html+='<div class="improve-meta">'+meta.join('<span style="color:var(--border);">|</span>')+'</div>';

            html+='</div>';
        }
        if(imps.length===0){
            html='<div style="color:var(--text-dim);padding:1rem;">No learning systems have run yet. Data will appear after the GitHub Actions daily refresh job runs.</div>';
        }
        p.innerHTML=html;
    });
}

function loadHistory(){
    var sys=document.getElementById('historySystem').value;
    var p=document.getElementById('historyPanel');
    p.innerHTML='<div class="loading"><div class="spinner"></div></div>';
    apiGet('learning_dashboard.php?action=history&system='+sys+'&limit=30',function(err,d){
        if(err||!d||!d.ok){p.innerHTML='<div style="color:var(--red);">Error: '+(err||'Unknown')+'</div>';return;}
        var hist=d.history||[];
        if(hist.length===0){p.innerHTML='<div style="color:var(--text-dim);">No learning history for this system yet. Run the learning endpoint to generate adjustments.</div>';return;}
        var html='<table class="history-table"><thead><tr><th>Date</th><th>Details</th></tr></thead><tbody>';
        for(var i=0;i<hist.length;i++){
            var h=hist[i];
            var date=h.created_at||h.applied_at||'-';
            var details=h.details||h.reason||h.action_type||'-';
            if(h.parameter_name) details=h.parameter_name+': '+h.old_value+' -> '+h.new_value+' ('+details+')';
            html+='<tr><td style="white-space:nowrap;">'+esc(date.split(' ')[0])+'</td><td style="font-size:0.75rem;">'+esc(details.substring(0,200))+'</td></tr>';
        }
        html+='</tbody></table>';
        p.innerHTML=html;
    });
}

loadOverview();
loadImprovement();
loadHistory();
</script>
<script src="/findstocks/portfolio2/stock-nav.js"></script>
<script src="/live-monitor/api/scope_labels.js"></script>
</body>
</html>
