<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidated Stock Picks | Performance Tracker</title>
    <style>
        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #12122a;
            --bg-card-hover: #1a1a3a;
            --border: #2a2a4a;
            --text: #e0e0f0;
            --text-dim: #8888aa;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234, 179, 8, 0.15);
            --blue: #3b82f6;
            --gold: #f59e0b;
            --cyan: #06b6d4;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .header {
            background: linear-gradient(135deg, #12122a 0%, #1e1e3f 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 1rem;
        }
        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--gold), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-links { display: flex; gap: 1rem; font-size: 0.85rem; flex-wrap: wrap; }
        .header-links a { color: var(--text-dim); }
        .header-links a:hover { color: var(--text); }

        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

        /* Tab navigation */
        .tab-nav {
            display: flex; gap: 0; margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }
        .tab-btn {
            padding: 0.75rem 1.25rem; font-size: 0.85rem; font-weight: 600;
            color: var(--text-dim); cursor: pointer;
            border: none; background: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px; white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-btn .tab-badge {
            font-size: 0.6rem; padding: 0.1rem 0.4rem; border-radius: 99px;
            background: var(--accent); color: #fff; margin-left: 0.4rem; vertical-align: middle;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Freshness banner */
        .freshness-banner {
            display: flex; gap: 0.75rem; flex-wrap: wrap;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem 1.25rem; margin-bottom: 1.5rem;
        }
        .freshness-item {
            display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem;
        }
        .freshness-dot { width: 8px; height: 8px; border-radius: 50%; }
        .freshness-dot.fresh { background: var(--green); }
        .freshness-dot.stale { background: var(--yellow); }
        .freshness-dot.outdated { background: var(--red); }

        .section-title {
            font-size: 1.2rem; font-weight: 700;
            margin: 1.5rem 0 1rem;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .badge {
            font-size: 0.6rem; padding: 0.2rem 0.5rem;
            border-radius: 99px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .badge-consensus { background: var(--gold); color: #000; }
        .badge-green { background: var(--green); color: #000; }
        .badge-red { background: var(--red); color: #fff; }

        /* Transparency banner */
        .transparency-banner {
            background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(6,182,212,0.08));
            border: 1px solid rgba(99,102,241,0.25);
            border-radius: var(--radius); padding: 0.9rem 1.25rem; margin-bottom: 1.5rem;
            font-size: 0.78rem; color: var(--text-dim); line-height: 1.6;
        }
        .transparency-banner strong { color: var(--text); }
        .transparency-banner .genesis-date { color: var(--cyan); font-weight: 700; }
        .transparency-banner .live-date { color: var(--green); font-weight: 700; }
        .date-tag {
            font-size: 0.6rem; padding: 0.12rem 0.45rem; border-radius: 4px;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;
            display: inline-block; vertical-align: middle; margin-left: 0.3rem;
        }
        .date-tag.genesis { background: rgba(6,182,212,0.2); color: var(--cyan); }
        .date-tag.live { background: rgba(34,197,94,0.2); color: var(--green); }

        /* Diagnosis cards */
        .diag-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 0.9rem 1.1rem;
            margin-bottom: 0.75rem; border-left: 3px solid var(--border);
        }
        .diag-card.sev-danger { border-left-color: var(--red); }
        .diag-card.sev-warning { border-left-color: var(--yellow); }
        .diag-card.sev-positive { border-left-color: var(--green); }
        .diag-card.sev-neutral { border-left-color: var(--accent); }
        .diag-card .diag-title { font-size: 0.85rem; font-weight: 700; margin-bottom: 0.3rem; }
        .diag-card .diag-text { font-size: 0.78rem; color: var(--text-dim); line-height: 1.5; }
        .sector-bar {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .sector-bar .sector-name { width: 110px; font-size: 0.8rem; font-weight: 600; }
        .sector-bar .sector-meter { flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 4px; position: relative; overflow: hidden; }
        .sector-bar .sector-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .sector-bar .sector-val { width: 70px; text-align: right; font-size: 0.8rem; font-weight: 700; }
        .algo-grade {
            display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center;
            font-weight: 800; font-size: 0.75rem; border-radius: 6px;
        }
        .algo-grade.grade-A { background: rgba(34,197,94,0.2); color: var(--green); }
        .algo-grade.grade-B { background: rgba(59,130,246,0.2); color: var(--blue); }
        .algo-grade.grade-C { background: rgba(234,179,8,0.2); color: var(--yellow); }
        .algo-grade.grade-D { background: rgba(239,68,68,0.15); color: #f97316; }
        .algo-grade.grade-F { background: rgba(239,68,68,0.2); color: var(--red); }

        /* Filter bar */
        .filter-bar {
            display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem;
            align-items: center;
        }
        .filter-bar select, .filter-bar input {
            background: var(--bg-card); color: var(--text); border: 1px solid var(--border);
            padding: 0.5rem 0.75rem; border-radius: 8px; font-size: 0.85rem;
        }
        .filter-bar label { font-size: 0.8rem; color: var(--text-dim); }
        .filter-bar button {
            background: var(--accent); color: #fff; border: none;
            padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;
        }
        .filter-bar button:hover { opacity: 0.85; }

        /* Stats row */
        .stats-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.75rem; margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem; text-align: center;
        }
        .stat-card .num { font-size: 1.6rem; font-weight: 800; }
        .stat-card .label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; }
        .stat-card .num.positive { color: var(--green); }
        .stat-card .num.negative { color: var(--red); }

        /* Consensus cards */
        .picks-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1rem;
        }
        .pick-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem;
            transition: border-color 0.2s, transform 0.1s;
            position: relative;
        }
        .pick-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .pick-card .rank-badge {
            position: absolute; top: -8px; left: 12px;
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 0.75rem;
        }
        .rank-1 { background: var(--gold); color: #000; }
        .rank-2 { background: #c0c0c0; color: #000; }
        .rank-3 { background: #cd7f32; color: #fff; }
        .rank-default { background: var(--border); color: var(--text); }

        .pick-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 0.75rem; padding-left: 24px;
        }
        .pick-ticker { font-size: 1.3rem; font-weight: 800; color: var(--cyan); }
        .pick-company { font-size: 0.75rem; color: var(--text-dim); }
        .consensus-badge {
            font-size: 0.7rem; padding: 0.25rem 0.6rem;
            border-radius: 99px; font-weight: 700; border: 1px solid;
        }
        .consensus-high { background: rgba(245,158,11,0.15); border-color: var(--gold); color: var(--gold); }
        .consensus-medium { background: rgba(99,102,241,0.15); border-color: var(--accent); color: var(--accent); }
        .consensus-low { background: rgba(136,136,170,0.1); border-color: var(--text-dim); color: var(--text-dim); }

        .pick-metrics {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem; margin-bottom: 0.75rem;
        }
        .metric { text-align: center; }
        .metric .val { font-size: 1rem; font-weight: 700; font-family: monospace; }
        .metric .lbl { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; }
        .val.positive { color: var(--green); }
        .val.negative { color: var(--red); }

        .pick-sources { border-top: 1px solid var(--border); padding-top: 0.75rem; }
        .source-tag {
            display: inline-block; font-size: 0.65rem;
            padding: 0.15rem 0.5rem; border-radius: 4px;
            background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3);
            color: var(--accent); margin: 0.15rem 0.1rem;
            cursor: pointer; position: relative;
            transition: background 0.15s, border-color 0.15s;
        }
        .source-tag:hover { background: rgba(99,102,241,0.25); border-color: var(--accent); }
        .source-link { font-size: 0.65rem; color: var(--text-dim); margin-top: 0.4rem; display: block; }

        /* Algorithm links popup */
        .algo-popup-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .algo-popup-overlay.visible { opacity: 1; pointer-events: auto; }
        .algo-popup {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.5rem; max-width: 480px; width: 90%;
            max-height: 80vh; overflow-y: auto; position: relative;
        }
        .algo-popup .popup-close {
            position: absolute; top: 0.75rem; right: 0.75rem;
            background: none; border: none; color: var(--text-dim);
            font-size: 1.2rem; cursor: pointer; padding: 0.25rem;
        }
        .algo-popup .popup-close:hover { color: var(--text); }
        .algo-popup h3 {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .algo-popup .popup-subtitle { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 1rem; }
        .algo-popup .popup-section { font-size: 0.7rem; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; margin: 0.75rem 0 0.4rem; }
        .algo-popup .page-link {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 0.6rem; margin-bottom: 0.3rem;
            border-radius: 6px; border: 1px solid var(--border);
            font-size: 0.78rem; color: var(--text); text-decoration: none;
            transition: border-color 0.15s, background 0.15s;
        }
        .algo-popup .page-link:hover { border-color: var(--accent); background: rgba(99,102,241,0.06); text-decoration: none; }
        .algo-popup .page-link .link-icon { font-size: 0.9rem; }
        .algo-popup .page-link .link-desc { font-size: 0.65rem; color: var(--text-dim); }

        .pick-direction {
            display: inline-flex; align-items: center; gap: 0.3rem;
            font-size: 0.7rem; font-weight: 800; padding: 0.2rem 0.6rem;
            border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .dir-long { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
        .dir-short { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
        .pick-verdict {
            font-size: 0.72rem; color: var(--text-dim); padding: 0.5rem 0.6rem;
            background: rgba(99,102,241,0.05); border-radius: 6px;
            margin-top: 0.5rem; line-height: 1.5; border-left: 3px solid var(--accent);
        }
        .stale-note { font-size: 0.65rem; color: var(--yellow); font-style: italic; }

        .pick-meta-row {
            display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.5rem; align-items: center;
        }
        .pick-date-stamp {
            font-size: 0.65rem; color: var(--text-dim); display: flex; align-items: center; gap: 0.25rem;
        }
        .pick-date-stamp .dv { color: var(--text); font-weight: 600; }
        .classification-badge {
            font-size: 0.6rem; padding: 0.15rem 0.5rem; border-radius: 4px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em;
        }
        .cls-daytrade { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
        .cls-swing { background: rgba(99,102,241,0.15); color: var(--accent); border: 1px solid rgba(99,102,241,0.3); }
        .cls-mixed { background: rgba(234,179,8,0.15); color: var(--yellow); border: 1px solid rgba(234,179,8,0.3); }
        .tpsl-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;
            margin-bottom: 0.5rem; padding: 0.4rem; border-radius: 8px;
            background: rgba(99,102,241,0.04); border: 1px solid rgba(99,102,241,0.08);
        }
        .tpsl-row .metric .val.tp { color: var(--green); }
        .tpsl-row .metric .val.sl { color: var(--red); }

        .pick-actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; }
        .btn-sm {
            font-size: 0.7rem; padding: 0.3rem 0.6rem;
            border-radius: 6px; border: 1px solid var(--border);
            background: transparent; color: var(--text-dim); cursor: pointer;
        }
        .btn-sm:hover { border-color: var(--accent); color: var(--accent); }

        /* Performance styles */
        .perf-hero {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .perf-hero-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.5rem; text-align: center;
        }
        .perf-hero-card .hero-num {
            font-size: 2.5rem; font-weight: 900; line-height: 1;
        }
        .perf-hero-card .hero-label {
            font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .perf-hero-card .hero-sub {
            font-size: 0.8rem; color: var(--text-dim); margin-top: 0.25rem;
        }
        /* Win rate tooltip */
        .wr-tooltip-wrap { position: relative; display: inline-block; }
        .wr-info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 18px; height: 18px; border-radius: 50%;
            background: rgba(234,179,8,0.15); color: #eab308; font-size: 11px;
            font-weight: 700; cursor: help; margin-left: 6px; vertical-align: middle;
            border: 1px solid rgba(234,179,8,0.3); transition: all 0.15s;
        }
        .wr-info-icon:hover { background: rgba(234,179,8,0.3); }
        .wr-tooltip {
            visibility: hidden; opacity: 0; position: absolute; z-index: 100;
            bottom: calc(100% + 10px); left: 50%; transform: translateX(-50%);
            width: 320px; background: #1a1a3a; border: 1px solid rgba(234,179,8,0.4);
            border-radius: 10px; padding: 12px 14px; font-size: 12px; color: #c8c8d8;
            line-height: 1.6; text-align: left; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transition: opacity 0.2s, visibility 0.2s; pointer-events: none;
        }
        .wr-tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%;
            transform: translateX(-50%); border: 6px solid transparent;
            border-top-color: rgba(234,179,8,0.4);
        }
        .wr-info-icon:hover + .wr-tooltip,
        .wr-tooltip-wrap:hover .wr-tooltip { visibility: visible; opacity: 1; pointer-events: auto; }
        @media(max-width:600px) {
            .wr-tooltip { width: 260px; left: auto; right: -20px; transform: none; }
            .wr-tooltip::after { left: auto; right: 28px; }
        }

        /* Position cards */
        .pos-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .pos-table th {
            text-align: left; padding: 0.5rem 0.75rem; font-size: 0.65rem;
            color: var(--text-dim); text-transform: uppercase; border-bottom: 1px solid var(--border);
        }
        .pos-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid rgba(42,42,74,0.5); }
        .pos-table tr:hover td { background: rgba(99,102,241,0.05); }
        .pos-table .ticker-cell { font-weight: 800; color: var(--cyan); }

        /* Challenge styles */
        .challenge-mode-toggle {
            display: flex; gap: 0; margin-bottom: 1.5rem;
            background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);
            overflow: hidden;
        }
        .mode-btn {
            flex: 1; padding: 0.75rem 1rem; text-align: center;
            font-size: 0.85rem; font-weight: 600; cursor: pointer;
            border: none; background: none; color: var(--text-dim);
            transition: all 0.2s;
        }
        .mode-btn.active { background: var(--accent); color: #fff; }
        .mode-btn:hover:not(.active) { color: var(--text); }

        .challenge-target {
            text-align: center; padding: 1.5rem; margin-bottom: 1.5rem;
            background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(245,158,11,0.1));
            border: 1px solid var(--border); border-radius: var(--radius);
        }
        .challenge-target .target-amt {
            font-size: 3rem; font-weight: 900;
            background: linear-gradient(135deg, var(--gold), var(--green));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .challenge-target .target-label {
            font-size: 0.85rem; color: var(--text-dim); margin-top: 0.25rem;
        }

        /* Lesson cards */
        .lesson-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1rem;
            border-left: 3px solid var(--accent);
        }
        .lesson-card.high-conf { border-left-color: var(--gold); }
        .lesson-card .lesson-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0.5rem;
        }
        .lesson-card .lesson-title { font-weight: 700; font-size: 0.9rem; }
        .lesson-card .lesson-type {
            font-size: 0.6rem; padding: 0.15rem 0.5rem; border-radius: 4px;
            text-transform: uppercase; font-weight: 700;
        }
        .lt-pattern { background: rgba(99,102,241,0.15); color: var(--accent); }
        .lt-algo_insight { background: rgba(6,182,212,0.15); color: var(--cyan); }
        .lt-timing { background: rgba(234,179,8,0.15); color: var(--yellow); }
        .lt-risk { background: rgba(239,68,68,0.15); color: var(--red); }
        .lt-improvement { background: rgba(34,197,94,0.15); color: var(--green); }
        .lt-consensus_strength { background: rgba(245,158,11,0.15); color: var(--gold); }
        .lesson-card .lesson-text { font-size: 0.8rem; color: var(--text-dim); line-height: 1.6; }
        .lesson-card .lesson-conf {
            font-size: 0.7rem; color: var(--text-dim); margin-top: 0.5rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .conf-bar {
            height: 4px; border-radius: 2px; background: var(--border); flex: 1; max-width: 100px;
        }
        .conf-fill { height: 100%; border-radius: 2px; background: var(--accent); }

        /* Chart placeholder */
        .chart-container {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem; margin-bottom: 1.5rem;
            min-height: 200px; position: relative;
        }
        .chart-container canvas { width: 100% !important; }

        /* Loading / Error */
        .loading { text-align: center; padding: 3rem; color: var(--text-dim); }
        .spinner { display: inline-block; width: 32px; height: 32px;
            border: 3px solid var(--border); border-top: 3px solid var(--accent);
            border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-box {
            background: var(--red-dim); border: 1px solid var(--red);
            border-radius: var(--radius); padding: 1rem; margin: 1rem 0;
        }

        .disclaimer {
            text-align: center; font-size: 0.7rem; color: var(--text-dim);
            padding: 2rem 1.5rem; border-top: 1px solid var(--border);
            margin-top: 2rem; max-width: 900px; margin-left: auto; margin-right: auto;
            line-height: 1.6;
        }

        .data-type-tag { font-size:0.6rem; padding:0.15rem 0.5rem; border-radius:4px; font-weight:700; text-transform:uppercase; letter-spacing:0.03em; vertical-align:middle; }
        .tag-live { background:rgba(34,197,94,0.15); color:#22c55e; border:1px solid rgba(34,197,94,0.3); }
        .tag-forward { background:rgba(99,102,241,0.15); color:#6366f1; border:1px solid rgba(99,102,241,0.3); }

        .empty-state {
            text-align: center; padding: 3rem 1rem; color: var(--text-dim);
        }
        .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
        .empty-state p { font-size: 0.85rem; max-width: 400px; margin: 0 auto; }

        /* Glossary / Analysis tab styles */
        .glossary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }
        .glossary-item {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem; transition: border-color 0.2s;
        }
        .glossary-item:hover { border-color: var(--accent); }
        .glossary-term {
            font-weight: 700; font-size: 0.95rem; color: var(--accent);
            margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.5rem;
        }
        .glossary-def { font-size: 0.85rem; color: var(--text-dim); line-height: 1.6; }
        .glossary-def strong { color: var(--text); }
        .grade-explainer {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 0.7rem 1rem;
            margin-bottom: 1rem; font-size: 0.8rem; color: var(--text-dim);
            line-height: 1.6;
        }
        .grade-explainer strong { color: var(--text); }
        .grade-explainer .ge-title { color: var(--accent); font-weight: 700; margin-bottom: 0.3rem; }
        .badge-blue { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
        .badge-yellow { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
        .badge-orange { background: rgba(249, 115, 22, 0.15); color: #f97316; }
        .badge-purple { background: rgba(168, 85, 247, 0.15); color: #a855f7; }

        @media (max-width: 768px) {
            .header { padding: 0.75rem 1rem; }
            .header h1 { font-size: 1.2rem; }
            .container { padding: 1rem; }
            .picks-grid { grid-template-columns: 1fr; }
            .pick-metrics { grid-template-columns: 1fr 1fr; }
            .perf-hero { grid-template-columns: 1fr; }
            .pos-table { font-size: 0.7rem; }
            .glossary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Consolidated Picks + Performance</h1>
        <div class="header-links">
            <a href="hub.html">Hub</a>
            <a href="picks.html">Top Picks</a>
            <a href="leaderboard.html">Leaderboard</a>
            <a href="learning-lab.html">Learning Lab</a>
            <a href="daytrader-sim.html">DayTrader Sim</a>
            <a href="horizon-picks.html">Horizons</a>
            <a href="/findstocks_global/miracle.html">Miracle v3</a>
        </div>
    </div>

    <div class="container">
        <!-- Best Stocks designation banner -->
        <div style="background:linear-gradient(135deg,rgba(34,211,238,0.06),rgba(99,102,241,0.06));border:1px solid rgba(34,211,238,0.3);border-radius:var(--radius);padding:0.8rem 1.2rem;margin-bottom:1rem;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <span style="background:rgba(34,211,238,0.15);color:#22d3ee;padding:3px 10px;border-radius:6px;font-weight:800;font-size:11px;border:1px solid rgba(34,211,238,0.3);letter-spacing:0.5px;">BEST STOCKS</span>
            <span style="color:var(--text);font-size:0.85rem;font-weight:600;">Crown Jewel &mdash; Most Sophisticated Pick System</span>
            <span style="color:var(--text-dim);font-size:0.75rem;margin-left:auto;">Status: <strong style="color:#eab308;">Tracking</strong> &mdash; 65 open positions, results pending ~Feb 24</span>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('consensus')">Consensus Picks</button>
            <button class="tab-btn" onclick="switchTab('performance')">Performance <span class="tab-badge" id="perfBadge">-</span></button>
            <button class="tab-btn" onclick="switchTab('challenge')">$200/Day Challenge</button>
            <button class="tab-btn" onclick="switchTab('learning')">Self-Learning</button>
            <button class="tab-btn" onclick="switchTab('analysis')" style="color:#f59e0b;">System Analysis</button>
            <button class="tab-btn" onclick="switchTab('research')" style="color:#a855f7;">Research &amp; Future</button>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 1: CONSENSUS PICKS -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="tab-panel active" id="tab-consensus">
            <div class="freshness-banner" id="freshnessBanner">
                <div class="freshness-item"><div class="spinner" style="width:14px;height:14px;border-width:2px;"></div> Checking data freshness...</div>
            </div>

            <div class="stats-row" id="statsRow">
                <div class="stat-card"><div class="num" id="statConsensus">-</div><div class="label">Consensus Picks</div></div>
                <div class="stat-card"><div class="num" id="statTotal">-</div><div class="label">Total Raw Picks</div></div>
                <div class="stat-card"><div class="num" id="statAlgos">-</div><div class="label">Algorithms</div></div>
                <div class="stat-card"><div class="num" id="statSources">-</div><div class="label">Data Sources</div></div>
            </div>

            <div class="filter-bar">
                <label>Days:
                    <select id="filterDays">
                        <option value="3">3 days</option>
                        <option value="7">7 days</option>
                        <option value="14" selected>14 days</option>
                        <option value="30">30 days</option>
                    </select>
                </label>
                <label>Min Consensus:
                    <select id="filterMinConsensus">
                        <option value="1">1+ (all)</option>
                        <option value="2" selected>2+ (consensus)</option>
                        <option value="3">3+ (strong)</option>
                        <option value="5">5+ (very strong)</option>
                    </select>
                </label>
                <button onclick="loadConsensus()">Apply Filters</button>
            </div>

            <div class="section-title">
                Cross-Algorithm Consensus <span class="badge badge-consensus" id="consensusBadge">Loading...</span>
                <span class="data-type-tag tag-forward">Forward-Looking</span>
            </div>
            <div id="consensusGrid" class="picks-grid">
                <div class="loading"><div class="spinner"></div><br>Loading consensus data...</div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 2: PERFORMANCE TRACKER -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="tab-panel" id="tab-performance">
            <div class="transparency-banner">
                <strong>Transparency Notice:</strong> Performance tracking began on
                <span class="genesis-date">Feb 10, 2026</span> (genesis date).
                Positions entered on that date are initial seeds based on existing consensus at launch.
                All picks from <span class="live-date" id="perfLiveDate">Feb 11, 2026</span> onward are
                real-time tracked picks with verifiable entry dates and prices.
                This is NOT backtesting — no hindsight bias. Every pick is recorded BEFORE we know the outcome.
                <br><span style="color:var(--text-dim);">Last tracked: <span id="perfLastTracked">-</span></span>
            </div>
            <div class="section-title">Honest Performance Tracking <span class="data-type-tag tag-live">Live</span></div>
            <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:1.5rem;">
                Every consensus pick is tracked as a virtual position. Results are reported honestly — wins AND losses.
                TP: +8%, SL: -4%, Max hold: 14 days. Positions also close when consensus drops.
            </p>

            <!-- Early-stage banner (shown when 0 closed trades) -->
            <div id="perfEarlyBanner" style="display:none;background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.25);border-radius:var(--radius);padding:1rem 1.25rem;margin-bottom:1.5rem;font-size:0.8rem;line-height:1.7;">
                <div style="font-size:0.9rem;font-weight:700;color:var(--yellow);margin-bottom:0.3rem;">Why is Win Rate 0% with 0W / 0L?</div>
                <div style="color:var(--text);">Win rate is calculated only from <b>closed</b> trades. Currently <b>all positions are still open</b> &mdash; none have hit a take-profit (+8%), stop-loss (&minus;4%), the 14-day max hold limit, or dropped below 2 algorithm consensus.</div>
                <ul style="margin:0.4rem 0 0 1.2rem;color:var(--text-dim);font-size:0.75rem;">
                    <li>A "win" = closed trade with positive return. A "loss" = closed trade with negative return.</li>
                    <li>The system launched on <b style="color:var(--cyan);">Feb 10, 2026</b>. First max-hold closures expected around <b style="color:var(--cyan);" id="perfEtaDate">Feb 24, 2026</b>.</li>
                    <li>Stop-loss or take-profit exits can happen any day if prices move enough.</li>
                    <li>This is expected behavior &mdash; positions are being tracked daily.</li>
                </ul>
            </div>

            <!-- Hero stats -->
            <div class="perf-hero" id="perfHero">
                <div class="perf-hero-card">
                    <div class="hero-num" id="perfWinRate">-</div>
                    <div class="hero-label">Win Rate <span class="wr-tooltip-wrap" id="wrTooltipWrap" style="display:none;"><span class="wr-info-icon">?</span><span class="wr-tooltip" id="wrTooltipContent"></span></span></div>
                    <div class="hero-sub" id="perfWinSub">-</div>
                </div>
                <div class="perf-hero-card">
                    <div class="hero-num" id="perfPortfolio">-</div>
                    <div class="hero-label">Portfolio Value</div>
                    <div class="hero-sub" id="perfPortSub">Started at $10,000</div>
                </div>
            </div>

            <div class="stats-row" id="perfStats">
                <div class="stat-card"><div class="num" id="pOpen">-</div><div class="label">Open Positions</div></div>
                <div class="stat-card"><div class="num" id="pClosed">-</div><div class="label">Closed Trades</div></div>
                <div class="stat-card"><div class="num" id="pAvgWin">-</div><div class="label">Avg Win</div></div>
                <div class="stat-card"><div class="num" id="pAvgLoss">-</div><div class="label">Avg Loss</div></div>
                <div class="stat-card"><div class="num" id="pPF">-</div><div class="label">Profit Factor</div></div>
                <div class="stat-card"><div class="num" id="pStreak">-</div><div class="label">Streak</div></div>
                <div class="stat-card"><div class="num" id="pAvgHold">-</div><div class="label">Avg Hold Days</div></div>
                <div class="stat-card"><div class="num" id="pTotalRet">-</div><div class="label">Total Return %</div></div>
            </div>

            <!-- Portfolio chart -->
            <div class="section-title">Portfolio Value Over Time</div>
            <div class="chart-container">
                <canvas id="perfChart" height="200"></canvas>
            </div>

            <!-- Auto-Diagnosis -->
            <div class="section-title">Auto-Diagnosis <span class="data-type-tag tag-live">AI Analysis</span></div>
            <div id="diagnosisNotes" style="margin-bottom:1.5rem;">
                <div class="loading"><div class="spinner"></div></div>
            </div>

            <!-- Sector Performance -->
            <div class="section-title">Sector Performance</div>
            <div id="sectorPerf" style="margin-bottom:1.5rem;"></div>

            <!-- Algorithm Report Card -->
            <div class="section-title">Algorithm Report Card</div>
            <div id="algoReport" style="margin-bottom:1.5rem;overflow-x:auto;"></div>

            <!-- Exit reason breakdown -->
            <div class="section-title">Exit Reason Breakdown</div>
            <div id="exitReasons" style="margin-bottom:1.5rem;"></div>

            <!-- Open positions -->
            <div class="section-title">Open Positions <span class="badge badge-green" id="openBadge">-</span></div>
            <div id="openPositions" style="overflow-x:auto;margin-bottom:1.5rem;">
                <div class="loading"><div class="spinner"></div></div>
            </div>

            <!-- Recent closed -->
            <div class="section-title">Recent Closed Trades</div>
            <div id="closedPositions" style="overflow-x:auto;">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 3: $200/DAY CHALLENGE -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="tab-panel" id="tab-challenge">
            <div class="transparency-banner">
                <strong>Transparency Notice:</strong> The $200/day challenge started on
                <span class="genesis-date">Feb 10, 2026</span>.
                Day 1 results use the genesis consensus snapshot. All subsequent days are
                <span class="live-date">real-time picks</span> selected each morning before market open.
                Both modes (Consensus and ML-Enhanced) trade the same $5,000 capital with identical rules.
                <br><span style="color:var(--text-dim);">Results include ALL trades — winners and losers. No cherry-picking.</span>
            </div>
            <div class="challenge-target">
                <div class="target-amt">$200/Day</div>
                <div class="target-label">Can our algorithms consistently make $200/day from $5,000 capital?</div>
            </div>

            <div class="challenge-mode-toggle">
                <button class="mode-btn active" onclick="switchChallengeMode('consensus')">Consensus Mode</button>
                <button class="mode-btn" onclick="switchChallengeMode('ml')">ML-Enhanced Mode</button>
            </div>

            <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:1.5rem;" id="challengeDesc">
                <strong>Consensus Mode:</strong> Picks top 5 consensus stocks daily, allocates $1,000 each.
                Pure algorithm agreement — no tweaks, no bias. Honest results.
            </p>

            <!-- Challenge stats -->
            <div class="stats-row" id="challengeStats">
                <div class="stat-card"><div class="num" id="cDays">-</div><div class="label">Days Tracked</div></div>
                <div class="stat-card"><div class="num" id="cTotalPnl">-</div><div class="label">Total P&L</div></div>
                <div class="stat-card"><div class="num" id="cAvgReturn">-</div><div class="label">Avg Daily Return</div></div>
                <div class="stat-card"><div class="num" id="cTargetRate">-</div><div class="label">$200 Target Hit Rate</div></div>
                <div class="stat-card"><div class="num" id="cWinRate">-</div><div class="label">Trade Win Rate</div></div>
                <div class="stat-card"><div class="num" id="cPeakPnl">-</div><div class="label">Peak P&L</div></div>
            </div>

            <!-- Challenge chart -->
            <div class="section-title">Cumulative P&L</div>
            <div class="chart-container">
                <canvas id="challengeChart" height="200"></canvas>
            </div>

            <!-- Latest trades -->
            <div class="section-title">Latest Challenge Trades</div>
            <div id="challengeTrades" style="overflow-x:auto;margin-bottom:1.5rem;">
                <div class="loading"><div class="spinner"></div></div>
            </div>

            <!-- Daily history -->
            <div class="section-title">Daily Results History</div>
            <div id="challengeHistory" style="overflow-x:auto;">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 4: SELF-LEARNING -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="tab-panel" id="tab-learning">
            <div class="transparency-banner">
                <strong>Transparency Notice:</strong> Self-learning insights are generated from
                <span class="live-date">real closed positions only</span> — never from backtests.
                Lessons require a minimum of 5 closed trades before pattern detection activates.
                Each lesson shows its detection date, confidence level, and supporting data.
                ML-Enhanced mode in the $200/day challenge applies these lessons automatically.
            </div>
            <div class="section-title">Self-Learning Insights <span class="data-type-tag tag-live">Auto-Detected</span></div>
            <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:1.5rem;">
                The system automatically analyzes closed positions to detect patterns, rank algorithms,
                and suggest improvements. These lessons are applied to the ML-Enhanced challenge mode.
            </p>

            <!-- Lesson type summary -->
            <div class="stats-row" id="lessonSummary"></div>

            <!-- Lessons list -->
            <div id="lessonsList">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 5: SYSTEM ANALYSIS -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="tab-panel" id="tab-analysis">
            <div class="section-title" style="color:#f59e0b;">System Analysis <span class="badge" style="background:rgba(245,158,11,0.15);color:#f59e0b;border:1px solid rgba(245,158,11,0.3);">DIAGNOSIS</span></div>

            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-bottom:1.5rem;">
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;">
                    <h4 style="font-size:0.85rem;color:var(--yellow);margin-bottom:0.5rem;">Current Status</h4>
                    <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">
                        &bull; 65 open positions, 0 closed<br>
                        &bull; $10K starting capital, 5% sizing = $500/position<br>
                        &bull; 65 positions x $500 = $32.5K needed (exceeds capital)<br>
                        &bull; Exit rules: TP +8%, SL -4%, 14-day max hold<br>
                        &bull; First closures expected ~Feb 24, 2026
                    </div>
                </div>
                <div style="background:var(--bg-card);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius);padding:1.2rem;">
                    <h4 style="font-size:0.85rem;color:var(--red);margin-bottom:0.5rem;">Issues Identified</h4>
                    <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">
                        &bull; <strong>Over-diversified:</strong> 65 positions vs optimal 20-25 (research)<br>
                        &bull; <strong>Capital exceeded:</strong> Need $32.5K but only have $10K<br>
                        &bull; <strong>Stop too tight:</strong> -4% may cause premature exits (research says -5% to -7%)<br>
                        &bull; <strong>Fixed TP caps winners:</strong> +8% TP limits upside vs trailing stop<br>
                        &bull; <strong>Algorithm diversity unknown:</strong> 20 algos may be correlated
                    </div>
                </div>
                <div style="background:var(--bg-card);border:1px solid rgba(34,197,94,0.3);border-radius:var(--radius);padding:1.2rem;">
                    <h4 style="font-size:0.85rem;color:var(--green);margin-bottom:0.5rem;">What's Working</h4>
                    <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">
                        &bull; Multi-algorithm consensus approach is academically validated<br>
                        &bull; Forward-facing tracking (no backtesting bias)<br>
                        &bull; Self-learning pattern detection after 5 closed trades<br>
                        &bull; Transparent exit rules with honest reporting<br>
                        &bull; Regime gate on 19/20 algorithms
                    </div>
                </div>
            </div>

            <h4 style="font-size:0.9rem;margin-bottom:0.75rem;color:var(--yellow);">Research-Backed Improvements</h4>
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem;">
                <table style="width:100%;font-size:12px;border-collapse:collapse;">
                    <thead><tr style="border-bottom:1px solid var(--border);">
                        <th style="text-align:left;padding:6px 8px;color:var(--text-dim);font-size:11px;text-transform:uppercase;">Change</th>
                        <th style="text-align:left;padding:6px 8px;color:var(--text-dim);font-size:11px;text-transform:uppercase;">Current</th>
                        <th style="text-align:left;padding:6px 8px;color:var(--text-dim);font-size:11px;text-transform:uppercase;">Research Recommends</th>
                        <th style="text-align:left;padding:6px 8px;color:var(--text-dim);font-size:11px;text-transform:uppercase;">Source</th>
                    </tr></thead>
                    <tbody style="color:var(--text);">
                        <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Position count</td><td style="padding:6px 8px;color:var(--red);">65</td><td style="padding:6px 8px;color:var(--green);">20-25</td><td style="padding:6px 8px;color:var(--text-dim);">Portfolio research, Danelfin</td></tr>
                        <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Stop loss</td><td style="padding:6px 8px;color:var(--red);">-4%</td><td style="padding:6px 8px;color:var(--green);">-5% to -7% or 2x ATR</td><td style="padding:6px 8px;color:var(--text-dim);">Minervini (7-8%), 567K backtests</td></tr>
                        <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Take profit</td><td style="padding:6px 8px;color:var(--yellow);">Fixed +8%</td><td style="padding:6px 8px;color:var(--green);">Trailing stop after +5%</td><td style="padding:6px 8px;color:var(--text-dim);">2M backtest study, Jha method</td></tr>
                        <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Consensus method</td><td style="padding:6px 8px;color:var(--yellow);">Count-based</td><td style="padding:6px 8px;color:var(--green);">Family-based (3-4 families)</td><td style="padding:6px 8px;color:var(--text-dim);">Ensemble ML research</td></tr>
                        <tr><td style="padding:6px 8px;">Algorithm weighting</td><td style="padding:6px 8px;color:var(--yellow);">Equal weight</td><td style="padding:6px 8px;color:var(--green);">IC-based dynamic (rolling)</td><td style="padding:6px 8px;color:var(--text-dim);">IC-weighted ML study (+16.63%)</td></tr>
                    </tbody>
                </table>
            </div>

            <h4 style="font-size:0.9rem;margin-bottom:0.75rem;color:var(--yellow);">Target Benchmarks</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;margin-bottom:1rem;">
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:0.8rem;text-align:center;">
                    <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;">Win Rate</div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--green);">40-65%</div>
                    <div style="font-size:10px;color:var(--text-dim);">with 1:2+ R:R</div>
                </div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:0.8rem;text-align:center;">
                    <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;">Sharpe Ratio</div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--green);">&gt;1.5</div>
                    <div style="font-size:10px;color:var(--text-dim);">Institutional min</div>
                </div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:0.8rem;text-align:center;">
                    <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;">Max Drawdown</div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--yellow);">&lt;20%</div>
                    <div style="font-size:10px;color:var(--text-dim);">Professional std</div>
                </div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:0.8rem;text-align:center;">
                    <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;">Profit Factor</div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--green);">&gt;1.5</div>
                    <div style="font-size:10px;color:var(--text-dim);">2.0+ excellent</div>
                </div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:0.8rem;text-align:center;">
                    <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;">Min Trades</div>
                    <div style="font-size:1.3rem;font-weight:700;color:var(--cyan);">385</div>
                    <div style="font-size:10px;color:var(--text-dim);">95% confidence</div>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 6: RESEARCH & FUTURE -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="tab-panel" id="tab-research">
            <div class="section-title" style="color:#a855f7;">Research Findings <span class="badge" style="background:rgba(168,85,247,0.15);color:#a855f7;border:1px solid rgba(168,85,247,0.3);">WEB RESEARCH FEB 12</span></div>
            <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:1rem;">Based on analysis of Reddit (r/algotrading, r/stocks), academic papers, trading competition winners (US Investing Championship), AI platforms (Danelfin), and 567K+ backtests.</p>

            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem;margin-bottom:1.5rem;">
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;">
                    <h4 style="font-size:0.85rem;color:#a855f7;margin-bottom:0.5rem;">Competition Winners</h4>
                    <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">
                        <strong>J Law (2024-25):</strong> +353.9% and +252.3% returns. Growth/momentum.<br>
                        <strong>Vibha Jha (2021-23):</strong> 7/10 trades were LOSERS, but 3 winners = 4x all losses. CANSLIM + TQQQ swings.<br>
                        <strong>Mark Minervini:</strong> 220% CAGR, max 7-8% SL, never risk &gt;2% of capital. SEPA Trend Template.<br>
                        <strong>Key insight:</strong> All winners optimize for avg win/avg loss ratio, NOT win rate. A 40% WR with 3:1 R:R beats 60% WR with 1:1.
                    </div>
                </div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;">
                    <h4 style="font-size:0.85rem;color:#a855f7;margin-bottom:0.5rem;">Danelfin AI Platform (Best Comparison)</h4>
                    <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">
                        <strong>Method:</strong> 10,000 features/stock/day, 900+ indicators (600 technical + 150 fundamental + 150 sentiment).<br>
                        <strong>Architecture:</strong> Hundreds of decision trees, recalibrated daily.<br>
                        <strong>Results:</strong> 60%+ WR on Buy signals since 2017. +376% cumulative (vs +166% S&amp;P 500).<br>
                        <strong>10/10 stocks:</strong> +21.05% annualized alpha after 3 months.<br>
                        <strong>Takeaway:</strong> Structured decision trees &gt; simple voting.
                    </div>
                </div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;">
                    <h4 style="font-size:0.85rem;color:#a855f7;margin-bottom:0.5rem;">Ensemble/Consensus Research</h4>
                    <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">
                        <strong>FinRL Competition (200+ teams):</strong> Ensembles reduced drawdown by 4.17%, improved Sharpe by 0.21.<br>
                        <strong>Optimal ensemble size:</strong> 3-5 diverse models (diminishing returns after 7).<br>
                        <strong>Diversity &gt; quantity:</strong> 5 different strategy types beats 20 momentum variants.<br>
                        <strong>IC-weighted:</strong> Rolling accuracy weighting achieved +16.63% return vs +6.03% benchmark.<br>
                        <strong>Critical:</strong> Ensembling poor strategies does NOT create edge. Each must have some individual edge.
                    </div>
                </div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;">
                    <h4 style="font-size:0.85rem;color:#a855f7;margin-bottom:0.5rem;">Exit Strategy Research (567K Backtests)</h4>
                    <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">
                        <strong>Best exits (ranked):</strong> Stop &amp; Reverse &gt; Dollar Target &gt; Breakeven Stops.<br>
                        <strong>Simpler beats complex:</strong> Parabolic, Chandelier, and combo exits all underperformed simple ones.<br>
                        <strong>2M backtest study:</strong> Take Profit has 56.9% WR (highest) but caps upside. Holding has highest expectancy.<br>
                        <strong>Triple Barrier Method:</strong> TP/SL/Time stop &mdash; whichever hits first closes. Prevents overfitting.<br>
                        <strong>Daily bars outperformed</strong> all shorter timeframes in exit effectiveness.
                    </div>
                </div>
            </div>

            <h4 style="font-size:0.9rem;margin-bottom:0.75rem;color:#a855f7;">Validated Strategy Win Rates</h4>
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem;">
                <table style="width:100%;font-size:12px;border-collapse:collapse;">
                    <thead><tr style="border-bottom:1px solid var(--border);">
                        <th style="text-align:left;padding:6px 8px;color:var(--text-dim);font-size:11px;text-transform:uppercase;">Strategy</th>
                        <th style="text-align:center;padding:6px 8px;color:var(--text-dim);font-size:11px;text-transform:uppercase;">Win Rate</th>
                        <th style="text-align:center;padding:6px 8px;color:var(--text-dim);font-size:11px;text-transform:uppercase;">Profit Factor</th>
                        <th style="text-align:left;padding:6px 8px;color:var(--text-dim);font-size:11px;text-transform:uppercase;">Notes</th>
                    </tr></thead>
                    <tbody style="color:var(--text);">
                        <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">RSI(2) &lt; 10 + 200 SMA filter</td><td style="padding:6px 8px;text-align:center;color:var(--green);">90%</td><td style="padding:6px 8px;text-align:center;">5.0</td><td style="padding:6px 8px;color:var(--text-dim);">83 trades since 1993, very selective</td></tr>
                        <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">RSI mean reversion (QQQ)</td><td style="padding:6px 8px;text-align:center;color:var(--green);">75%</td><td style="padding:6px 8px;text-align:center;">3.0</td><td style="padding:6px 8px;color:var(--text-dim);">Sharpe 2.85, 232 trades</td></tr>
                        <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Danelfin AI (10/10 score)</td><td style="padding:6px 8px;text-align:center;color:var(--green);">60%+</td><td style="padding:6px 8px;text-align:center;">N/A</td><td style="padding:6px 8px;color:var(--text-dim);">+21% alpha, 900+ indicators</td></tr>
                        <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Multi-factor ML (IC-weighted)</td><td style="padding:6px 8px;text-align:center;color:var(--green);">N/A</td><td style="padding:6px 8px;text-align:center;">2.7+</td><td style="padding:6px 8px;color:var(--text-dim);">+16.63% return, 5.44% max DD</td></tr>
                        <tr><td style="padding:6px 8px;">Professional swing traders</td><td style="padding:6px 8px;text-align:center;color:var(--yellow);">35-50%</td><td style="padding:6px 8px;text-align:center;">1.5-2.5</td><td style="padding:6px 8px;color:var(--text-dim);">With 3:1 R:R still highly profitable</td></tr>
                    </tbody>
                </table>
            </div>

            <p style="font-size:0.75rem;color:var(--text-dim);line-height:1.6;margin-bottom:1rem;">
                <strong>Sources:</strong> US Investing Championship (worldcupchampionships.com), Danelfin.com, FinRL ACM ICAIF 2024, KJ Trading Systems (567K backtests), Oleg Polakow (2M backtests), BuildAlpha, QuantConnect, Journal of Big Data, IEEE SVM multi-factor study, Reddit r/algotrading, r/stocks.
            </p>
        </div>

        <!-- Data Sources & Transparency -->
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.5rem;">
            <h3 style="font-size:1rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:8px;">
                Data Sources & Transparency
                <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(99,102,241,0.15);color:#818cf8;border:1px solid rgba(99,102,241,0.3);">VERIFIED</span>
            </h3>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
                <strong style="color:var(--text);">Where the numbers come from:</strong><br>
                &bull; <strong>Performance data:</strong> <a href="api/consensus_performance.php?action=dashboard" target="_blank">consensus_performance.php?action=dashboard</a> &mdash; live API, updated daily via GitHub Actions<br>
                &bull; <strong>Price data:</strong> <a href="api/fetch_prices.php" target="_blank">fetch_prices.php</a> &mdash; Yahoo Finance v8 chart API, refreshed daily<br>
                &bull; <strong>Algorithm signals:</strong> <a href="/live-monitor/api/daily_picks.php?type=all" target="_blank">daily_picks.php</a> &mdash; 20 algorithms score each ticker<br>
                &bull; <strong>Entry tracking:</strong> <a href="api/consensus_performance.php?action=track" target="_blank">consensus_performance.php?action=track</a> &mdash; records positions at market open<br>
                &bull; <strong>Exit rules:</strong> TP +8% (swing) / +5% (day), SL -4% / -3%, max hold 14 days, consensus drop &lt;2 algos<br>
                &bull; <strong>Pattern learning:</strong> <code>consensus_lessons</code> table &mdash; activates after 5+ closed trades<br>
                &bull; <strong>GitHub Actions:</strong> <code>refresh-stocks-portfolio.yml</code> runs weekdays at 23:30 UTC
            </div>
        </div>

        <!-- Future Roadmap -->
        <div style="background:var(--bg-card);border:1px solid rgba(99,102,241,0.3);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.5rem;">
            <h3 style="font-size:1rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:8px;">
                Future Roadmap
                <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(34,197,94,0.15);color:#22c55e;border:1px solid rgba(34,197,94,0.3);">PLANNED</span>
            </h3>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
                <strong style="color:var(--green);">Q1 2026:</strong><br>
                &bull; First batch of max-hold closures (~Feb 24) will produce real W/L data<br>
                &bull; Pattern detection engine activates after 5 closed trades<br>
                &bull; Win rate, Sharpe ratio, and drawdown metrics go live<br><br>
                <strong style="color:var(--yellow);">Q2 2026:</strong><br>
                &bull; ML-Enhanced challenge mode using learned lessons<br>
                &bull; Sector rotation insights from closed trade analysis<br>
                &bull; Equity curve chart with vs-SPY benchmark comparison<br><br>
                <strong style="color:var(--text-dim);">Long-term:</strong><br>
                &bull; Dynamic position sizing based on consensus strength<br>
                &bull; Multi-timeframe consensus (day + swing + position)<br>
                &bull; Automated alerts when consensus score changes dramatically
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <strong>Important Disclaimer</strong><br>
            This tool is for <strong>educational and research purposes only</strong> and does not constitute financial advice.
            <strong>All investments involve risk</strong>, including the possible loss of principal. Past performance does not guarantee future results.
            <strong>Consult a licensed financial adviser</strong> before making any investment decisions.
        </div>
    </div>

<!-- Algorithm Links Popup -->
<div class="algo-popup-overlay" id="algoPopupOverlay" onclick="closeAlgoPopup(event)">
    <div class="algo-popup" id="algoPopup">
        <button class="popup-close" onclick="closeAlgoPopup()">&times;</button>
        <h3 id="algoPopupName">Algorithm Name</h3>
        <div class="popup-subtitle" id="algoPopupDesc"></div>
        <div id="algoPopupLinks"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
var API_BASE = (function() {
    var h = window.location.hostname;
    if (h === 'findtorontoevents.ca' || h === 'www.findtorontoevents.ca') {
        return '/findstocks/portfolio2/api/';
    }
    return 'api/';
})();

// Transparency: genesis date = when tracking started. Before this = seed data, after = live tracked.
var GENESIS_DATE = '2026-02-10';
function dateTag(d) {
    if (!d) return '';
    return d === GENESIS_DATE
        ? ' <span class="date-tag genesis">Genesis</span>'
        : ' <span class="date-tag live">Live</span>';
}

function apiGet(endpoint, cb) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', API_BASE + endpoint, true);
    xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 400) {
            try { cb(null, JSON.parse(xhr.responseText)); }
            catch(e) { cb('JSON parse error'); }
        } else { cb('HTTP ' + xhr.status); }
    };
    xhr.onerror = function() { cb('Network error'); };
    xhr.send();
}

// ─── Tab switching ───
function switchTab(name) {
    var btns = document.querySelectorAll('.tab-btn');
    var panels = document.querySelectorAll('.tab-panel');
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
    for (var i = 0; i < panels.length; i++) panels[i].classList.remove('active');
    document.getElementById('tab-' + name).classList.add('active');
    // Activate button
    for (var i = 0; i < btns.length; i++) {
        if (btns[i].textContent.toLowerCase().indexOf(name === 'consensus' ? 'consensus' : name === 'performance' ? 'performance' : name === 'challenge' ? '$200' : 'learning') >= 0) {
            btns[i].classList.add('active');
        }
    }
    // Load data on first visit
    if (name === 'performance' && !window._perfLoaded) { loadPerformance(); window._perfLoaded = true; }
    if (name === 'challenge' && !window._challengeLoaded) { loadChallenge(); window._challengeLoaded = true; }
    if (name === 'learning' && !window._learningLoaded) { loadLearning(); window._learningLoaded = true; }
}

// ─── Load freshness ───
function loadFreshness() {
    apiGet('consolidated_picks.php?action=freshness', function(err, data) {
        var banner = document.getElementById('freshnessBanner');
        if (err || !data || !data.ok) {
            banner.innerHTML = '<div class="freshness-item"><div class="freshness-dot outdated"></div> Unable to check data freshness</div>';
            return;
        }
        var html = '';
        var sources = data.sources || [];
        for (var i = 0; i < sources.length; i++) {
            var s = sources[i];
            var status = s.status || 'unknown';
            var dotClass = status === 'fresh' ? 'fresh' : (status === 'stale' ? 'stale' : 'outdated');
            html += '<div class="freshness-item"><div class="freshness-dot ' + dotClass + '"></div><span>' + (s.label || s.table) + ': ' + (s.latest_pick_date || s.latest_date || 'N/A') + '</span></div>';
        }
        banner.innerHTML = html;
        document.getElementById('statSources').textContent = sources.length;
    });
}

// ─── Load consensus picks ───
function loadConsensus() {
    var days = document.getElementById('filterDays').value;
    var minCons = document.getElementById('filterMinConsensus').value;
    var grid = document.getElementById('consensusGrid');
    grid.innerHTML = '<div class="loading"><div class="spinner"></div><br>Loading consensus data...</div>';

    apiGet('consolidated_picks.php?action=consensus&days=' + days + '&min_consensus=' + minCons + '&limit=100', function(err, data) {
        if (err || !data || !data.ok) {
            grid.innerHTML = '<div class="error-box">Failed to load: ' + (err || 'Unknown error') + '</div>';
            return;
        }
        var picks = data.consensus_picks || [];
        document.getElementById('statConsensus').textContent = picks.length;
        document.getElementById('statTotal').textContent = data.total_raw_picks || 0;
        document.getElementById('consensusBadge').textContent = picks.length + ' tickers';

        var algoSet = {};
        for (var i = 0; i < picks.length; i++) {
            var srcs = picks[i].sources || [];
            for (var j = 0; j < srcs.length; j++) algoSet[srcs[j].algorithm] = true;
        }
        document.getElementById('statAlgos').textContent = Object.keys(algoSet).length;

        if (picks.length === 0) {
            grid.innerHTML = '<div class="loading" style="color:var(--text-dim);">No consensus picks found. Try widening filters.</div>';
            return;
        }

        var html = '';
        for (var i = 0; i < picks.length; i++) {
            var p = picks[i];
            var rank = i + 1;
            var rankClass = rank <= 3 ? 'rank-' + rank : 'rank-default';
            var consClass = p.consensus_count >= 5 ? 'consensus-high' : (p.consensus_count >= 3 ? 'consensus-medium' : 'consensus-low');
            var returnClass = p.current_return_pct > 0 ? 'positive' : (p.current_return_pct < 0 ? 'negative' : '');
            var returnSign = p.current_return_pct > 0 ? '+' : '';

            html += '<div class="pick-card">';
            html += '<div class="rank-badge ' + rankClass + '">' + rank + '</div>';
            html += '<div class="pick-header">';
            html += '<div><div class="pick-ticker">' + esc(p.ticker) + '</div>';
            html += '<div class="pick-company">' + esc(p.company_name || '') + '</div></div>';
            html += '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.3rem;">';
            var dirClass = (p.direction === 'SHORT') ? 'dir-short' : 'dir-long';
            var dirLabel = (p.direction === 'SHORT') ? '&#9660; SHORT' : '&#9650; LONG';
            html += '<span class="pick-direction ' + dirClass + '">' + dirLabel + '</span>';
            html += '<div class="consensus-badge ' + consClass + '">' + p.consensus_count + ' algos</div>';
            html += '</div></div>';

            // Classification + entry date row
            html += '<div class="pick-meta-row">';
            var ct = p.pick_classification || 'Swing Trade';
            var cc = ct.indexOf('Day Trade') >= 0 ? (ct.indexOf('Mixed') >= 0 ? 'cls-mixed' : 'cls-daytrade') : 'cls-swing';
            html += '<span class="classification-badge ' + cc + '">' + esc(ct) + '</span>';
            html += '<span class="pick-date-stamp">Picked: <span class="dv">' + esc(p.earliest_pick_date || p.latest_pick_date || '') + '</span>';
            if (p.earliest_pick_date && p.latest_pick_date && p.earliest_pick_date !== p.latest_pick_date) {
                html += ' &rarr; <span class="dv">' + esc(p.latest_pick_date) + '</span>';
            }
            html += '</span></div>';

            html += '<div class="pick-metrics">';
            html += '<div class="metric"><div class="val">$' + fmtPrice(p.avg_entry_price) + '</div><div class="lbl">Avg Entry</div></div>';
            html += '<div class="metric"><div class="val">$' + fmtPrice(p.latest_price) + '</div><div class="lbl">Latest';
            if (p.price_age_days >= 2) html += ' <span class="stale-note">(' + p.price_age_days + 'd)</span>';
            html += '</div></div>';
            var retDisp = (p.current_return_pct === 0 && p.price_age_days >= 1) ? '<span class="stale-note">awaiting update</span>' : returnSign + p.current_return_pct + '%';
            html += '<div class="metric"><div class="val ' + returnClass + '">' + retDisp + '</div><div class="lbl">Return</div></div>';
            html += '</div>';

            // TP/SL row
            html += '<div class="tpsl-row">';
            html += '<div class="metric"><div class="val tp">' + (p.tp_price ? '$' + fmtPrice(p.tp_price) : '—') + '</div><div class="lbl">Target (+' + (p.suggested_tp_pct || 0) + '%)</div></div>';
            html += '<div class="metric"><div class="val sl">' + (p.sl_price ? '$' + fmtPrice(p.sl_price) : '—') + '</div><div class="lbl">Stop Loss (-' + (p.suggested_sl_pct || 0) + '%)</div></div>';
            var rr = (p.suggested_sl_pct > 0) ? (p.suggested_tp_pct / p.suggested_sl_pct).toFixed(1) : '—';
            html += '<div class="metric"><div class="val">' + rr + ':1</div><div class="lbl">Risk / Reward</div></div>';
            html += '</div>';

            html += '<div class="pick-metrics" style="margin-bottom:0.5rem;">';
            html += '<div class="metric"><div class="val">' + fmtNum(p.consensus_score) + '</div><div class="lbl">Score</div></div>';
            html += '<div class="metric"><div class="val">' + fmtNum(p.avg_score) + '</div><div class="lbl">Avg Algo</div></div>';
            html += '<div class="metric"><div class="val">' + p.total_picks + '</div><div class="lbl">Picks</div></div>';
            html += '</div>';

            if (p.verdict) {
                var vBorder = p.current_return_pct >= 0 ? 'var(--green)' : 'var(--accent)';
                html += '<div class="pick-verdict" style="border-left-color:' + vBorder + ';">' + esc(p.verdict) + '</div>';
            }

            // Auto-notes from corrective scoring
            if (p.auto_notes) {
                var noteColor = p.current_return_pct < -3 ? 'var(--red)' : (p.current_return_pct < 0 ? 'var(--yellow)' : 'var(--green)');
                html += '<div style="font-size:0.68rem;color:' + noteColor + ';padding:0.35rem 0.5rem;margin-top:0.4rem;background:rgba(255,255,255,0.03);border-radius:4px;line-height:1.4;">';
                html += '<strong>Auto-Analysis:</strong> ' + esc(p.auto_notes);
                if (p.original_score && p.consensus_score !== p.original_score) {
                    html += ' <span style="opacity:0.6;">(Score: ' + fmtNum(p.original_score) + ' → ' + fmtNum(p.consensus_score) + ')</span>';
                }
                html += '</div>';
            }

            html += '<div class="pick-sources">';
            var srcs = p.sources || [];
            for (var j = 0; j < srcs.length; j++) {
                html += '<span class="source-tag" onclick="showAlgoPopup(\'' + esc(srcs[j].algorithm).replace(/'/g, "\\'") + '\')" title="Click to see where ' + esc(srcs[j].algorithm) + ' is used">' + esc(srcs[j].algorithm) + ' <span style="opacity:0.5;">' + esc(srcs[j].pick_date || '') + '</span></span>';
            }
            html += '</div>';

            html += '<div class="pick-actions">';
            html += '<button class="btn-sm" onclick="window.location.href=\'stock-intel.html?ticker=' + encodeURIComponent(p.ticker) + '\'">Deep Dive</button>';
            html += '<button class="btn-sm" onclick="window.open(\'https://finance.yahoo.com/quote/' + encodeURIComponent(p.ticker) + '\',\'_blank\')">Yahoo</button>';
            html += '<button class="btn-sm" onclick="openAuditModal(\'' + esc(p.ticker) + '\', \'' + esc(p.latest_pick_date || '') + '\')" style="background:var(--accent);color:white;">Audit Trail</button>';
            html += '</div></div>';
        }
        grid.innerHTML = html;
    });
}


// ═══════════════════════════════════════════
// PERFORMANCE TAB
// ═══════════════════════════════════════════
var perfChartInstance = null;

function loadPerformance() {
    // Load dashboard
    apiGet('consensus_performance.php?action=dashboard', function(err, data) {
        if (err || !data || !data.ok) {
            document.getElementById('perfHero').innerHTML = '<div class="error-box">Performance data not available yet. Run the daily tracker first.</div>';
            return;
        }
        // Update last tracked timestamp
        var lte = document.getElementById('perfLastTracked');
        if (lte && data.generated_at) lte.textContent = data.generated_at + ' UTC';
        var s = data.stats || {};
        var wr = s.win_rate || 0;
        var totalClosed = s.total_closed || 0;
        // Show early-stage banner when no trades have closed yet
        var earlyBanner = document.getElementById('perfEarlyBanner');
        if (earlyBanner) {
            earlyBanner.style.display = totalClosed === 0 ? 'block' : 'none';
        }
        var wrColor = wr >= 55 ? 'positive' : (wr < 45 ? 'negative' : '');
        document.getElementById('perfWinRate').className = 'hero-num ' + wrColor;
        document.getElementById('perfWinRate').textContent = wr + '%';
        document.getElementById('perfWinSub').textContent = s.total_wins + 'W / ' + s.total_losses + 'L of ' + s.total_closed + ' closed';
        document.getElementById('perfBadge').textContent = wr + '%';

        // Win rate tooltip — show contextual explanation
        var wrWrap = document.getElementById('wrTooltipWrap');
        var wrTip = document.getElementById('wrTooltipContent');
        if (wrWrap && wrTip) {
            wrWrap.style.display = 'inline-block';
            if (totalClosed === 0) {
                // Genesis: Feb 10, 2026. Max hold: 14 days. First closures ~Feb 24.
                var genesis = new Date(2026, 1, 10); // Feb 10, 2026
                var maxHoldDays = 14;
                var firstClosureDate = new Date(genesis.getTime() + maxHoldDays * 86400000);
                var today = new Date();
                var daysUntil = Math.max(0, Math.ceil((firstClosureDate - today) / 86400000));
                var etaStr = firstClosureDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                wrTip.innerHTML = '<strong style="color:#eab308;">0% = No closed trades yet</strong><br>'
                    + 'All ' + (s.open_positions || 65) + ' positions are still open. Win rate is only calculated from closed trades.<br><br>'
                    + '<strong style="color:var(--cyan);">First closures expected:</strong> ~' + etaStr
                    + (daysUntil > 0 ? ' (' + daysUntil + ' days)' : ' (any day now)') + '<br><br>'
                    + '<strong>Exit triggers:</strong><br>'
                    + '&bull; Take-profit: +8% (swing) / +5% (day)<br>'
                    + '&bull; Stop-loss: &minus;4% (swing) / &minus;3% (day)<br>'
                    + '&bull; Max hold: 14 days from entry<br>'
                    + '&bull; Consensus drop: &lt;2 algorithms agree<br><br>'
                    + '<span style="color:var(--text-dim);font-size:11px;">SL/TP exits can happen any day if prices move enough. Max-hold closures are the guaranteed date.</span>';
            } else {
                wrTip.innerHTML = '<strong style="color:' + (wr >= 50 ? '#22c55e' : '#ef4444') + ';">' + wr + '% win rate</strong> from ' + totalClosed + ' closed trade' + (totalClosed !== 1 ? 's' : '') + '<br><br>'
                    + '<strong>Wins:</strong> ' + (s.total_wins || 0) + ' | <strong>Losses:</strong> ' + (s.total_losses || 0) + '<br>'
                    + '<strong>Avg win:</strong> ' + (s.avg_win || '—') + '% | <strong>Avg loss:</strong> ' + (s.avg_loss || '—') + '%<br><br>'
                    + '<span style="color:var(--text-dim);font-size:11px;">Based on real forward-facing results, not backtests. Exits via SL/TP/max-hold/consensus-drop rules.</span>';
            }
        }

        var pv = s.total_tracked || 0;
        var pvNum = document.getElementById('perfPortfolio');
        // If no chart data yet, show total return
        pvNum.textContent = '$' + fmtComma(10000 + (s.total_return_pct || 0) * 100);
        pvNum.className = 'hero-num ' + ((s.total_return_pct || 0) >= 0 ? 'positive' : 'negative');
        document.getElementById('perfPortSub').textContent = 'Total return: ' + ((s.total_return_pct || 0) >= 0 ? '+' : '') + (s.total_return_pct || 0) + '%';

        document.getElementById('pOpen').textContent = s.open_positions || 0;
        document.getElementById('pClosed').textContent = s.total_closed || 0;
        var aw = document.getElementById('pAvgWin');
        aw.textContent = '+' + (s.avg_win_pct || 0) + '%';
        aw.className = 'num positive';
        var al = document.getElementById('pAvgLoss');
        al.textContent = (s.avg_loss_pct || 0) + '%';
        al.className = 'num negative';
        document.getElementById('pPF').textContent = s.profit_factor || '0';
        var streak = s.current_streak || 0;
        var sk = document.getElementById('pStreak');
        sk.textContent = (streak > 0 ? '+' : '') + streak;
        sk.className = 'num ' + (streak > 0 ? 'positive' : (streak < 0 ? 'negative' : ''));
        document.getElementById('pAvgHold').textContent = (s.avg_hold_days || 0) + 'd';
        var tr = document.getElementById('pTotalRet');
        tr.textContent = ((s.total_return_pct || 0) >= 0 ? '+' : '') + (s.total_return_pct || 0) + '%';
        tr.className = 'num ' + ((s.total_return_pct || 0) >= 0 ? 'positive' : 'negative');

        // Exit reasons
        var exits = data.exit_reasons || [];
        if (exits.length > 0) {
            var ehtml = '<div class="stats-row">';
            for (var i = 0; i < exits.length; i++) {
                var e = exits[i];
                var label = e.reason.replace(/_/g, ' ').replace(/\b\w/g, function(c){return c.toUpperCase();});
                ehtml += '<div class="stat-card"><div class="num">' + e.count + '</div><div class="label">' + label + '</div>';
                ehtml += '<div style="font-size:0.7rem;color:' + (e.avg_return >= 0 ? 'var(--green)' : 'var(--red)') + ';">';
                ehtml += 'avg ' + (e.avg_return >= 0 ? '+' : '') + e.avg_return + '%</div></div>';
            }
            ehtml += '</div>';
            document.getElementById('exitReasons').innerHTML = ehtml;
        }

        // Chart
        var chart = data.chart || [];
        if (chart.length > 0) {
            renderPerfChart(chart);
        }
    });

    // Load positions
    apiGet('consensus_performance.php?action=positions', function(err, data) {
        if (err || !data || !data.ok) return;

        // Open positions
        var open = data.open || [];
        document.getElementById('openBadge').textContent = open.length;
        if (open.length === 0) {
            document.getElementById('openPositions').innerHTML = '<div class="empty-state"><p>No open positions. Positions are created when the daily tracker runs.</p></div>';
        } else {
            var h = '<table class="pos-table"><thead><tr><th>Ticker</th><th>Entry</th><th>Current</th><th>Return</th><th>Days</th><th>Consensus</th><th>Diagnosis</th></tr></thead><tbody>';
            for (var i = 0; i < open.length; i++) {
                var p = open[i];
                var ret = parseFloat(p.current_return_pct) || 0;
                var rc = ret >= 0 ? 'positive' : 'negative';
                var diag = p.diagnosis || {};
                var diagNotes = diag.notes || [];
                var sev = diag.severity || 'info';
                var sevColor = sev === 'danger' ? 'var(--red)' : (sev === 'warning' ? 'var(--yellow)' : 'var(--text-dim)');
                h += '<tr>';
                h += '<td class="ticker-cell">' + esc(p.ticker) + '<br><span style="font-size:0.65rem;color:var(--text-dim);">' + esc(p.company_name || '') + '</span>';
                if (p.sector) h += '<br><span style="font-size:0.6rem;color:var(--accent);">' + esc(p.sector) + '</span>';
                h += '</td>';
                h += '<td>$' + fmtPrice(p.entry_price) + '<br><span style="font-size:0.65rem;color:var(--text-dim);">' + esc(p.entry_date || '') + dateTag(p.entry_date) + '</span></td>';
                h += '<td>$' + fmtPrice(p.current_price);
                if (p.price_age_days >= 2) h += ' <span class="stale-note">(' + p.price_age_days + 'd)</span>';
                h += '</td>';
                var retCell = (ret === 0 && p.price_age_days >= 1) ? '<span class="stale-note">awaiting update</span>' : (ret >= 0 ? '+' : '') + ret + '%';
                h += '<td class="' + rc + '" style="font-weight:700;">' + retCell + '</td>';
                h += '<td>' + (p.hold_days || 0) + '</td>';
                h += '<td>' + (p.consensus_count || 0) + ' algos</td>';
                h += '<td style="max-width:280px;font-size:0.7rem;">';
                if (diag.summary) {
                    h += '<div style="color:' + sevColor + ';font-weight:600;margin-bottom:0.2rem;">' + esc(diag.summary) + '</div>';
                }
                for (var j = 0; j < Math.min(diagNotes.length, 2); j++) {
                    var n = diagNotes[j];
                    var nc = n.severity === 'danger' ? 'var(--red)' : (n.severity === 'warning' ? 'var(--yellow)' : 'var(--text-dim)');
                    h += '<div style="color:' + nc + ';font-size:0.65rem;line-height:1.3;margin-top:0.15rem;">' + esc(n.text) + '</div>';
                }
                if (diagNotes.length > 2) {
                    h += '<div style="color:var(--text-dim);font-size:0.6rem;margin-top:0.1rem;">+' + (diagNotes.length - 2) + ' more notes</div>';
                }
                h += '</td>';
                h += '</tr>';
            }
            h += '</tbody></table>';
            document.getElementById('openPositions').innerHTML = h;
        }

        // Closed positions
        var closed = data.closed || [];
        if (closed.length === 0) {
            document.getElementById('closedPositions').innerHTML = '<div class="empty-state"><p>No closed trades yet. Positions close when they hit TP (+8%), SL (-4%), max hold (14d), or consensus drops.</p></div>';
        } else {
            var h = '<table class="pos-table"><thead><tr><th>Ticker</th><th>Entry</th><th>Exit</th><th>Return</th><th>Days</th><th>Reason</th></tr></thead><tbody>';
            for (var i = 0; i < closed.length; i++) {
                var p = closed[i];
                var ret = parseFloat(p.final_return_pct) || 0;
                var rc = ret >= 0 ? 'positive' : 'negative';
                var reason = (p.exit_reason || '').replace(/_/g, ' ');
                h += '<tr>';
                h += '<td class="ticker-cell">' + esc(p.ticker) + '</td>';
                h += '<td>$' + fmtPrice(p.entry_price) + ' <span style="font-size:0.65rem;color:var(--text-dim);">' + esc(p.entry_date || '') + dateTag(p.entry_date) + '</span></td>';
                h += '<td>$' + fmtPrice(p.exit_price) + ' <span style="font-size:0.65rem;color:var(--text-dim);">' + esc(p.exit_date || '') + '</span></td>';
                h += '<td class="' + rc + '" style="font-weight:700;">' + (ret >= 0 ? '+' : '') + ret + '%</td>';
                h += '<td>' + (p.hold_days || 0) + 'd</td>';
                h += '<td><span style="font-size:0.7rem;">' + reason + '</span></td>';
                h += '</tr>';
            }
            h += '</tbody></table>';
            document.getElementById('closedPositions').innerHTML = h;
        }
    });

    // Load auto-diagnosis
    apiGet('consensus_performance.php?action=diagnose', function(err, data) {
        if (err || !data || !data.ok) {
            document.getElementById('diagnosisNotes').innerHTML = '<div class="empty-state"><p>Diagnosis data not available.</p></div>';
            return;
        }

        // Market notes
        var mn = data.market_notes || [];
        var dh = '';
        for (var i = 0; i < mn.length; i++) {
            var n = mn[i];
            var sev = n.severity || 'neutral';
            dh += '<div class="diag-card sev-' + sev + '">';
            if (n.title) dh += '<div class="diag-title">' + esc(n.title) + '</div>';
            dh += '<div class="diag-text">' + esc(n.text) + '</div>';
            dh += '</div>';
        }
        if (mn.length === 0) dh = '<div class="empty-state"><p>No market diagnosis notes yet. Data will populate after price updates.</p></div>';
        document.getElementById('diagnosisNotes').innerHTML = dh;

        // Sector performance bars
        var sectors = data.sector_performance || [];
        if (sectors.length > 0) {
            var sh = '';
            var maxAbs = 1;
            for (var i = 0; i < sectors.length; i++) {
                if (Math.abs(sectors[i].avg_return) > maxAbs) maxAbs = Math.abs(sectors[i].avg_return);
            }
            for (var i = 0; i < sectors.length; i++) {
                var s = sectors[i];
                var pct = Math.min(100, Math.abs(s.avg_return) / maxAbs * 100);
                var color = s.avg_return >= 0 ? 'var(--green)' : 'var(--red)';
                var valColor = s.avg_return >= 0 ? 'positive' : 'negative';
                sh += '<div class="sector-bar">';
                sh += '<div class="sector-name">' + esc(s.sector) + '</div>';
                sh += '<div class="sector-meter"><div class="sector-fill" style="width:' + pct + '%;background:' + color + ';"></div></div>';
                sh += '<div class="sector-val ' + valColor + '">' + (s.avg_return >= 0 ? '+' : '') + s.avg_return + '%</div>';
                sh += '<div style="font-size:0.65rem;color:var(--text-dim);width:60px;text-align:right;">' + s.winners + 'W/' + s.losers + 'L</div>';
                sh += '</div>';
            }
            document.getElementById('sectorPerf').innerHTML = sh;
        } else {
            document.getElementById('sectorPerf').innerHTML = '<div class="empty-state"><p>No sector data.</p></div>';
        }

        // Algorithm report card
        var algos = data.algo_performance || [];
        if (algos.length > 0) {
            var ah = '<table class="pos-table"><thead><tr><th>Grade</th><th>Algorithm</th><th>Picks</th><th>Avg Return</th><th>W/L</th><th>Win Rate</th></tr></thead><tbody>';
            for (var i = 0; i < Math.min(algos.length, 20); i++) {
                var a = algos[i];
                var rc = a.avg_return >= 0 ? 'positive' : 'negative';
                ah += '<tr>';
                ah += '<td><span class="algo-grade grade-' + a.grade + '">' + a.grade + '</span></td>';
                ah += '<td style="font-size:0.8rem;"><a href="javascript:void(0)" onclick="showAlgoPopup(\'' + esc(a.algorithm).replace(/'/g, "\\'") + '\')" style="color:var(--cyan);cursor:pointer;" title="See where ' + esc(a.algorithm) + ' is used">' + esc(a.algorithm) + '</a></td>';
                ah += '<td>' + a.picks + '</td>';
                ah += '<td class="' + rc + '" style="font-weight:700;">' + (a.avg_return >= 0 ? '+' : '') + a.avg_return + '%</td>';
                ah += '<td>' + a.winners + '/' + a.losers + '</td>';
                ah += '<td>' + a.win_rate + '%</td>';
                ah += '</tr>';
            }
            ah += '</tbody></table>';
            document.getElementById('algoReport').innerHTML = ah;
        } else {
            document.getElementById('algoReport').innerHTML = '<div class="empty-state"><p>No algorithm data.</p></div>';
        }
    });
}

function renderPerfChart(chart) {
    var ctx = document.getElementById('perfChart').getContext('2d');
    if (perfChartInstance) perfChartInstance.destroy();

    var labels = [];
    var values = [];
    for (var i = 0; i < chart.length; i++) {
        labels.push(chart[i].date);
        values.push(chart[i].value);
    }

    perfChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Portfolio Value ($)',
                data: values,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99,102,241,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 2
            }, {
                label: 'Baseline ($10,000)',
                data: labels.map(function() { return 10000; }),
                borderColor: '#8888aa',
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#8888aa', font: { size: 11 } } } },
            scales: {
                x: { ticks: { color: '#8888aa', font: { size: 10 }, maxTicksLimit: 10 }, grid: { color: 'rgba(42,42,74,0.5)' } },
                y: { ticks: { color: '#8888aa', font: { size: 10 }, callback: function(v) { return '$' + v.toLocaleString(); } }, grid: { color: 'rgba(42,42,74,0.5)' } }
            }
        }
    });
}


// ═══════════════════════════════════════════
// $200/DAY CHALLENGE TAB
// ═══════════════════════════════════════════
var challengeChartInstance = null;
var currentChallengeMode = 'consensus';

function switchChallengeMode(mode) {
    currentChallengeMode = mode;
    var btns = document.querySelectorAll('.mode-btn');
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
    if (mode === 'consensus') {
        btns[0].classList.add('active');
        document.getElementById('challengeDesc').innerHTML = '<strong>Consensus Mode:</strong> Picks top 5 consensus stocks daily, allocates $1,000 each. Pure algorithm agreement — no tweaks, no bias. Honest results.';
    } else {
        btns[1].classList.add('active');
        document.getElementById('challengeDesc').innerHTML = '<strong>ML-Enhanced Mode:</strong> Uses self-learning insights to optimize picks. Applies algorithm win-rate weighting, optimal consensus count, and momentum filters. Should outperform pure consensus over time.';
    }
    loadChallenge();
}

function loadChallenge() {
    var mode = currentChallengeMode;

    apiGet('consensus_performance.php?action=challenge&mode=' + mode + '&days=60', function(err, data) {
        if (err || !data || !data.ok) {
            document.getElementById('challengeStats').innerHTML = '<div class="error-box">Challenge data not available yet.</div>';
            return;
        }

        var ms = null;
        var stats = data.mode_stats || [];
        for (var i = 0; i < stats.length; i++) {
            if (stats[i].mode === mode) { ms = stats[i]; break; }
        }

        if (!ms) {
            document.getElementById('cDays').textContent = '0';
            document.getElementById('cTotalPnl').textContent = '$0';
            document.getElementById('cAvgReturn').textContent = '0%';
            document.getElementById('cTargetRate').textContent = '0%';
            document.getElementById('cWinRate').textContent = '0%';
            document.getElementById('cPeakPnl').textContent = '$0';
        } else {
            document.getElementById('cDays').textContent = ms.days_tracked;
            var tp = document.getElementById('cTotalPnl');
            tp.textContent = '$' + fmtComma(ms.total_pnl);
            tp.className = 'num ' + (ms.total_pnl >= 0 ? 'positive' : 'negative');
            var ar = document.getElementById('cAvgReturn');
            ar.textContent = (ms.avg_daily_return >= 0 ? '+' : '') + ms.avg_daily_return + '%';
            ar.className = 'num ' + (ms.avg_daily_return >= 0 ? 'positive' : 'negative');
            document.getElementById('cTargetRate').textContent = ms.target_hit_rate + '%';
            document.getElementById('cWinRate').textContent = ms.win_rate + '%';
            var pp = document.getElementById('cPeakPnl');
            pp.textContent = '$' + fmtComma(ms.peak_pnl);
            pp.className = 'num positive';
        }

        // Chart
        var history = data.history || [];
        var filtered = [];
        for (var i = 0; i < history.length; i++) {
            if (history[i].mode === mode) filtered.push(history[i]);
        }
        filtered.reverse(); // chronological
        if (filtered.length > 0) {
            renderChallengeChart(filtered);
        }

        // Latest trades
        var trades = data.latest_trades || [];
        var ft = [];
        for (var i = 0; i < trades.length; i++) {
            if (trades[i].mode === mode) ft.push(trades[i]);
        }
        if (ft.length === 0) {
            document.getElementById('challengeTrades').innerHTML = '<div class="empty-state"><p>No challenge trades yet. The daily tracker will generate picks.</p></div>';
        } else {
            var h = '<table class="pos-table"><thead><tr><th>Ticker</th><th>Date</th><th>Entry</th><th>Shares</th><th>Invested</th><th>P&L</th><th>Return</th></tr></thead><tbody>';
            for (var i = 0; i < ft.length; i++) {
                var t = ft[i];
                var ret = parseFloat(t.return_pct) || 0;
                var rc = ret >= 0 ? 'positive' : 'negative';
                h += '<tr>';
                h += '<td class="ticker-cell">' + esc(t.ticker) + '<br><span style="font-size:0.65rem;color:var(--text-dim);">' + esc(t.company_name || '') + '</span></td>';
                h += '<td style="font-size:0.8rem;">' + esc(t.challenge_date || '') + dateTag(t.challenge_date) + '</td>';
                h += '<td>$' + fmtPrice(t.entry_price) + '</td>';
                h += '<td>' + parseFloat(t.shares || 0).toFixed(2) + '</td>';
                h += '<td>$' + fmtComma(t.invested) + '</td>';
                h += '<td class="' + rc + '" style="font-weight:700;">$' + fmtComma(t.pnl) + '</td>';
                h += '<td class="' + rc + '">' + (ret >= 0 ? '+' : '') + ret + '%</td>';
                h += '</tr>';
            }
            h += '</tbody></table>';
            document.getElementById('challengeTrades').innerHTML = h;
        }

        // History table
        if (filtered.length === 0) {
            document.getElementById('challengeHistory').innerHTML = '<div class="empty-state"><p>No daily results yet.</p></div>';
        } else {
            var h = '<table class="pos-table"><thead><tr><th>Date</th><th>Picks</th><th>Daily P&L</th><th>Return</th><th>$200 Target</th><th>Cumulative</th><th>Streak</th></tr></thead><tbody>';
            for (var i = filtered.length - 1; i >= 0; i--) {
                var d = filtered[i];
                var pnl = parseFloat(d.daily_pnl) || 0;
                var rc = pnl >= 0 ? 'positive' : 'negative';
                var target = parseInt(d.target_hit) === 1;
                h += '<tr>';
                h += '<td>' + esc(d.challenge_date) + dateTag(d.challenge_date) + '</td>';
                h += '<td>' + (d.picks_count || 0) + '</td>';
                h += '<td class="' + rc + '" style="font-weight:700;">$' + fmtComma(pnl) + '</td>';
                h += '<td class="' + rc + '">' + (pnl >= 0 ? '+' : '') + (d.daily_return_pct || 0) + '%</td>';
                h += '<td>' + (target ? '<span style="color:var(--green);">HIT</span>' : '<span style="color:var(--red);">MISS</span>') + '</td>';
                h += '<td>$' + fmtComma(d.cumulative_pnl) + '</td>';
                h += '<td>' + (parseInt(d.win_streak || 0) > 0 ? '+' : '') + (d.win_streak || 0) + '</td>';
                h += '</tr>';
            }
            h += '</tbody></table>';
            document.getElementById('challengeHistory').innerHTML = h;
        }
    });
}

function renderChallengeChart(history) {
    var ctx = document.getElementById('challengeChart').getContext('2d');
    if (challengeChartInstance) challengeChartInstance.destroy();

    var labels = [];
    var cum = [];
    var daily = [];
    for (var i = 0; i < history.length; i++) {
        labels.push(history[i].challenge_date);
        cum.push(parseFloat(history[i].cumulative_pnl) || 0);
        daily.push(parseFloat(history[i].daily_pnl) || 0);
    }

    challengeChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cumulative P&L ($)',
                data: cum,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34,197,94,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 3
            }, {
                label: 'Daily P&L ($)',
                data: daily,
                type: 'bar',
                backgroundColor: daily.map(function(v) { return v >= 0 ? 'rgba(34,197,94,0.4)' : 'rgba(239,68,68,0.4)'; }),
                borderColor: daily.map(function(v) { return v >= 0 ? '#22c55e' : '#ef4444'; }),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#8888aa', font: { size: 11 } } } },
            scales: {
                x: { ticks: { color: '#8888aa', font: { size: 10 }, maxTicksLimit: 10 }, grid: { color: 'rgba(42,42,74,0.5)' } },
                y: { ticks: { color: '#8888aa', font: { size: 10 }, callback: function(v) { return '$' + v; } }, grid: { color: 'rgba(42,42,74,0.5)' } }
            }
        }
    });
}


// ═══════════════════════════════════════════
// SELF-LEARNING TAB
// ═══════════════════════════════════════════
function loadLearning() {
    apiGet('consensus_performance.php?action=lessons&limit=30', function(err, data) {
        if (err || !data || !data.ok) {
            document.getElementById('lessonsList').innerHTML = '<div class="empty-state"><p>No lessons detected yet. The system needs closed trades to analyze patterns.</p></div>';
            return;
        }

        // Summary
        var summary = data.summary || [];
        if (summary.length > 0) {
            var h = '';
            for (var i = 0; i < summary.length; i++) {
                var s = summary[i];
                var label = s.type.replace(/_/g, ' ').replace(/\b\w/g, function(c){return c.toUpperCase();});
                h += '<div class="stat-card"><div class="num">' + s.count + '</div>';
                h += '<div class="label">' + label + '</div>';
                h += '<div style="font-size:0.7rem;color:var(--text-dim);">avg conf: ' + s.avg_confidence + '%</div></div>';
            }
            document.getElementById('lessonSummary').innerHTML = h;
        }

        // Lessons
        var lessons = data.lessons || [];
        if (lessons.length === 0) {
            document.getElementById('lessonsList').innerHTML = '<div class="empty-state"><div class="empty-icon">&#129504;</div><p>No lessons detected yet. The system needs at least 5 closed trades to begin detecting patterns. Run the daily tracker to start building data.</p></div>';
            return;
        }

        var h = '';
        for (var i = 0; i < lessons.length; i++) {
            var l = lessons[i];
            var conf = parseInt(l.confidence) || 50;
            var isHigh = conf >= 70;
            var typeClass = 'lt-' + (l.lesson_type || 'pattern');

            h += '<div class="lesson-card' + (isHigh ? ' high-conf' : '') + '">';
            h += '<div class="lesson-header">';
            h += '<div class="lesson-title">' + esc(l.lesson_title) + '</div>';
            h += '<span class="lesson-type ' + typeClass + '">' + esc((l.lesson_type || '').replace(/_/g, ' ')) + '</span>';
            h += '</div>';
            h += '<div class="lesson-text">' + esc(l.lesson_text) + '</div>';
            h += '<div class="lesson-conf">';
            h += '<span>Confidence: ' + conf + '%</span>';
            h += '<div class="conf-bar"><div class="conf-fill" style="width:' + conf + '%;"></div></div>';
            h += '<span style="font-size:0.65rem;">' + esc(l.lesson_date) + '</span>';
            h += '</div>';

            // Supporting data visualization
            if (l.supporting_data && Array.isArray(l.supporting_data) && l.supporting_data.length > 0) {
                h += '<div style="margin-top:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap;">';
                for (var j = 0; j < l.supporting_data.length; j++) {
                    var d = l.supporting_data[j];
                    var label = d.bucket || d.bracket || d.reason || d.algorithm || ('Count: ' + (d.consensus_count || '?'));
                    var wr = d.win_rate || 0;
                    var wrColor = wr >= 55 ? 'var(--green)' : (wr < 45 ? 'var(--red)' : 'var(--text-dim)');
                    h += '<div style="background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;padding:0.4rem 0.6rem;font-size:0.7rem;text-align:center;">';
                    h += '<div style="font-weight:700;color:var(--text);">' + esc(String(label)) + '</div>';
                    h += '<div style="color:' + wrColor + ';font-weight:700;">' + wr + '% WR</div>';
                    h += '<div style="color:var(--text-dim);">' + (d.trades || d.count || 0) + ' trades</div>';
                    h += '</div>';
                }
                h += '</div>';
            }

            h += '</div>';
        }
        document.getElementById('lessonsList').innerHTML = h;
    });
}


// ═══════════════════════════════════════════
// ALGORITHM PAGES MAP — where each algo is used (non-admin)
// ═══════════════════════════════════════════
var ALGO_PAGES = {
    '_default': [
        { section: 'Stock Picks & Analysis', links: [
            { url: '/findstocks/portfolio2/picks.html', name: 'Daily Stock Picks', desc: 'See this algorithm\'s latest picks', icon: '\u{1F4CA}' },
            { url: '/findstocks/portfolio2/consolidated.html', name: 'Consolidated Picks', desc: 'Multi-algorithm consensus view', icon: '\u{1F91D}' },
            { url: '/findstocks/portfolio2/leaderboard.html', name: 'Algorithm Leaderboard', desc: 'Ranking by win rate, Sharpe, returns', icon: '\u{1F3C6}' },
            { url: '/findstocks/portfolio2/algo-study.html', name: 'Algo Study', desc: 'Deep-dive analysis of algorithm logic', icon: '\u{1F52C}' }
        ]},
        { section: 'Live Trading & Performance', links: [
            { url: '/live-monitor/live-monitor.html', name: 'Live Trading Monitor', desc: 'Real-time signals and paper trades', icon: '\u{1F4F1}' },
            { url: '/live-monitor/algo-performance.html', name: 'Algo Performance', desc: 'Learned vs Original parameter comparison', icon: '\u{2699}' },
            { url: '/live-monitor/edge-dashboard.html', name: 'Edge Dashboard', desc: 'Edge analysis and alpha decay', icon: '\u{1F4C8}' },
            { url: '/live-monitor/winning-patterns.html', name: 'Winning Patterns', desc: 'Pattern detection across algorithms', icon: '\u{2728}' }
        ]},
        { section: 'System Health', links: [
            { url: '/live-monitor/goldmine-dashboard.html', name: 'Goldmine Dashboard', desc: 'Multi-dimensional system health', icon: '\u{1F48E}' },
            { url: '/findstocks/portfolio2/learning-dashboard.html', name: 'Self-Learning Algorithms', desc: 'Watch optimization in real-time', icon: '\u{1F9E0}' }
        ]}
    ],
    'Cursor Genius': {
        desc: 'Data-driven meta-strategy: selective, weighted dip-buying. Sharpe +6.29 (backtest leader). Tier 1: CAT, GOOG, JNJ, WMT, XOM. Tier 2: AAPL, PEP, HON, JPM, KO.',
        extra: [
            { section: 'Cursor Genius Highlights', links: [
                { url: '/findstocks/portfolio2/algo-study.html?algo=Cursor+Genius', name: 'Algo Study: Cursor Genius', desc: 'Deep-dive into the meta-strategy logic', icon: '\u{1F31F}' },
                { url: '/live-monitor/edge-dashboard.html', name: 'Edge Dashboard', desc: 'Cursor Genius edge: Sharpe +6.29, 67% WR in backtests', icon: '\u{1F4CA}' },
                { url: '/findstocks/research/index.html', name: 'Research Hub', desc: 'Benchmarked vs Renaissance, Two Sigma — hidden star', icon: '\u{1F4D6}' }
            ]}
        ]
    },
    'Challenger Bot': {
        desc: '20th algorithm using smart money consensus score. BUY when score >=70, SHORT when <=30. Fed by SEC 13F, Form 4, analyst ratings.',
        extra: [
            { section: 'Smart Money', links: [
                { url: '/live-monitor/smart-money.html', name: 'Smart Money Intelligence', desc: '6-tab dashboard: consensus, analyst, insider, leaderboard', icon: '\u{1F4B0}' },
                { url: '/findstocks/portfolio2/stock-intel.html', name: 'Stock Intelligence', desc: 'Per-ticker analyst ratings, insider MSPR, 13F data', icon: '\u{1F50D}' }
            ]}
        ]
    }
};

function getAlgoInfo(algoName) {
    var info = ALGO_PAGES[algoName] || {};
    return {
        desc: info.desc || 'Stock picking algorithm contributing to the consensus system.',
        extra: info.extra || []
    };
}

function showAlgoPopup(algoName) {
    var info = getAlgoInfo(algoName);
    document.getElementById('algoPopupName').textContent = algoName;
    document.getElementById('algoPopupDesc').textContent = info.desc;

    var html = '';

    // Extra algo-specific sections first
    var extra = info.extra;
    for (var s = 0; s < extra.length; s++) {
        html += '<div class="popup-section">' + esc(extra[s].section) + '</div>';
        var links = extra[s].links;
        for (var l = 0; l < links.length; l++) {
            html += '<a class="page-link" href="' + links[l].url + '">';
            html += '<span class="link-icon">' + links[l].icon + '</span>';
            html += '<div><div>' + esc(links[l].name) + '</div><div class="link-desc">' + esc(links[l].desc) + '</div></div>';
            html += '</a>';
        }
    }

    // Default sections
    var sections = ALGO_PAGES['_default'];
    for (var s = 0; s < sections.length; s++) {
        html += '<div class="popup-section">' + esc(sections[s].section) + '</div>';
        var links = sections[s].links;
        for (var l = 0; l < links.length; l++) {
            html += '<a class="page-link" href="' + links[l].url + '">';
            html += '<span class="link-icon">' + links[l].icon + '</span>';
            html += '<div><div>' + esc(links[l].name) + '</div><div class="link-desc">' + esc(links[l].desc) + '</div></div>';
            html += '</a>';
        }
    }

    document.getElementById('algoPopupLinks').innerHTML = html;
    document.getElementById('algoPopupOverlay').classList.add('visible');
}

function closeAlgoPopup(e) {
    if (e && e.target && e.target !== document.getElementById('algoPopupOverlay')) return;
    document.getElementById('algoPopupOverlay').classList.remove('visible');
}
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeAlgoPopup(); });

// ─── Helpers ───
function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtPrice(n) {
    if (!n || n === 0) return '0.00';
    return parseFloat(n).toFixed(2);
}
function fmtNum(n) {
    if (!n) return '0';
    var v = parseFloat(n);
    return v >= 1000 ? (v/1000).toFixed(1) + 'k' : v.toFixed(v < 10 ? 1 : 0);
}
function fmtComma(n) {
    var v = parseFloat(n) || 0;
    return v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// ─── Init ───
loadFreshness();
loadConsensus();

/* ── Audit Trail Modal ── */
function openAuditModal(symbol, date) {
    var url = API_BASE + 'audit_view.php?symbol=' + encodeURIComponent(symbol);
    if (date && date !== 'undefined' && date !== 'null') url += '&date=' + encodeURIComponent(date);
    var modal = document.getElementById('auditModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'auditModal';
        modal.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9999;justify-content:center;align-items:center;';
        modal.innerHTML = '<div style="background:#12122a;border:1px solid #2a2a4a;border-radius:14px;padding:28px;width:90%;max-width:520px;max-height:80vh;overflow-y:auto;color:#e0e0f0;"><h3 id="auditTitle" style="margin-bottom:16px;font-size:1.2rem;"></h3><div id="auditContent"></div><div style="display:flex;gap:10px;margin-top:16px;"><button onclick="closeAuditModal()" style="flex:1;padding:10px;background:#2a2a4a;color:#e0e0f0;border:none;border-radius:6px;cursor:pointer;">Close</button><button id="auditExportBtn" style="flex:1;padding:10px;background:#6366f1;color:white;border:none;border-radius:6px;cursor:pointer;">Export for AI</button></div></div>';
        document.body.appendChild(modal);
        modal.addEventListener('click', function(e) { if (e.target === modal) closeAuditModal(); });
    }
    document.getElementById('auditTitle').textContent = 'Audit Trail: ' + symbol;
    document.getElementById('auditContent').innerHTML = '<p style="color:#8888aa;">Loading...</p>';
    modal.style.display = 'flex';
    document.getElementById('auditExportBtn').onclick = function() { exportAudit(symbol, date); };
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onload = function() {
        var content = document.getElementById('auditContent');
        if (xhr.status !== 200) { content.innerHTML = '<p style="color:#ef4444;">Failed to load.</p>'; return; }
        try {
            var data = JSON.parse(xhr.responseText);
            if (!data || !data.ok || !data.audits || data.audits.length === 0) { content.innerHTML = '<p style="color:#8888aa;">No audit trail found for this pick yet.</p>'; return; }
            var html = '';
            for (var i = 0; i < data.audits.length; i++) {
                var a = data.audits[i];
                html += '<div style="margin-bottom:12px;padding:10px;background:rgba(255,255,255,0.03);border:1px solid #2a2a4a;border-radius:8px;"><div style="font-size:0.75rem;color:#6366f1;font-weight:700;margin-bottom:4px;">' + (a.generation_source || '') + '</div><div style="font-size:0.85rem;margin-bottom:6px;">' + (a.reasons || '') + '</div><div style="font-size:0.7rem;color:#8888aa;">' + (a.pick_timestamp || '') + '</div></div>';
            }
            content.innerHTML = html;
        } catch(e) { content.innerHTML = '<p style="color:#ef4444;">Error parsing audit data.</p>'; }
    };
    xhr.onerror = function() { document.getElementById('auditContent').innerHTML = '<p style="color:#ef4444;">Network error.</p>'; };
    xhr.send();
}
function closeAuditModal() { var m = document.getElementById('auditModal'); if (m) m.style.display = 'none'; }
function exportAudit(symbol, date) {
    var url = API_BASE + 'audit_view.php?symbol=' + encodeURIComponent(symbol) + '&export=1';
    if (date && date !== 'undefined' && date !== 'null') url += '&date=' + encodeURIComponent(date);
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onload = function() {
        try { var d = JSON.parse(xhr.responseText); if (d && d.ok && d.formatted_for_ai) { navigator.clipboard.writeText(d.formatted_for_ai).then(function() { alert('Audit trail copied to clipboard! Paste into ChatGPT/Claude/Gemini for AI review.'); }); } else { alert('No audit data to export.'); } } catch(e) { alert('Export failed.'); }
    };
    xhr.send();
}
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeAuditModal(); });
</script>
<script src="/findstocks/portfolio2/stock-nav.js"></script>
<script src="/live-monitor/api/scope_labels.js"></script>
</body>
</html>
