<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soccer Shootout VR - Game Arena | Toronto Events</title>
  <script src="/vr/https-redirect.js"></script>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

  <script>
    AFRAME.registerComponent('look-at-camera', {
      tick: function () {
        var cam = this.el.sceneEl.camera;
        if (cam) this.el.object3D.lookAt(cam.getWorldPosition(new THREE.Vector3()));
      }
    });
  </script>

  <style>
    body { margin: 0; overflow: hidden; font-family: 'Inter', -apple-system, sans-serif; }
    #loading {
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #0a1f0a 0%, #0a2e1a 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; color: white; transition: opacity 0.5s;
    }
    #loading h1 {
      font-size: 2.5rem; margin-bottom: 0.5rem;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    #loading p { color: #888; font-size: 1.1rem; }
    .spinner {
      width: 60px; height: 60px; border: 4px solid rgba(34,197,94,0.3);
      border-top-color: #22c55e; border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 1.5rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* HUD */
    #hud {
      position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
      z-index: 200; display: flex; gap: 16px; align-items: center;
    }
    .hud-card {
      background: rgba(10,20,10,0.88); backdrop-filter: blur(10px);
      border: 1px solid rgba(34,197,94,0.4); border-radius: 14px;
      padding: 10px 20px; color: white; text-align: center; font-size: 14px; min-width: 100px;
    }
    .hud-card h3 { margin: 0 0 2px; font-size: 12px; color: #888; }
    .hud-card .score { font-size: 32px; font-weight: 800; }
    .hud-card.you .score { color: #22c55e; }
    .hud-card.opp .score { color: #ef4444; }
    .hud-vs { font-size: 20px; font-weight: 800; color: #555; }
    .hud-card .name { font-weight: 600; font-size: 13px; }

    #hud-status {
      position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
      z-index: 200; background: rgba(10,20,10,0.9); backdrop-filter: blur(10px);
      border: 1px solid rgba(34,197,94,0.3); border-radius: 12px;
      padding: 10px 28px; color: #22c55e; font-size: 16px; font-weight: 600;
      text-align: center; transition: all 0.3s;
    }

    /* Shot indicator */
    #shot-indicator {
      position: fixed; top: 140px; left: 50%; transform: translateX(-50%);
      z-index: 200; display: flex; gap: 8px; padding: 8px 16px;
      background: rgba(10,20,10,0.85); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);
    }
    .shot-dot {
      width: 14px; height: 14px; border-radius: 50%;
      background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.2);
      transition: all 0.3s;
    }
    .shot-dot.goal { background: #22c55e; border-color: #22c55e; }
    .shot-dot.miss { background: #ef4444; border-color: #ef4444; }
    .shot-dot.active { border-color: #f59e0b; box-shadow: 0 0 8px rgba(245,158,11,0.5); }
    .shot-separator {
      width: 1px; background: rgba(255,255,255,0.15); margin: 0 4px;
    }

    /* Target zones overlay (for shooting) */
    #target-overlay {
      position: fixed; inset: 0; z-index: 150;
      display: none; cursor: crosshair;
    }
    #target-overlay.active { display: flex; align-items: center; justify-content: center; }
    #aim-reticle {
      position: fixed; z-index: 160;
      width: 40px; height: 40px; pointer-events: none;
      border: 2px solid #22c55e; border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px rgba(34,197,94,0.3);
      transition: border-color 0.2s;
    }
    #aim-reticle::before {
      content: ''; position: absolute;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 6px; height: 6px; border-radius: 50%; background: #22c55e;
    }

    /* Keeper select (when defending) */
    #keeper-overlay {
      position: fixed; inset: 0; z-index: 150; display: none;
      align-items: center; justify-content: center;
    }
    #keeper-overlay.active { display: flex; }

    /* Buttons */
    .btn-bar {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      z-index: 200; display: flex; gap: 10px;
    }
    .btn {
      padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600;
      cursor: pointer; border: none; transition: all 0.2s; color: white;
    }
    .btn-primary { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .btn-primary:hover { box-shadow: 0 4px 15px rgba(34,197,94,0.4); transform: translateY(-1px); }
    .btn-danger { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); color: #ef4444; }
    .btn-danger:hover { background: rgba(239,68,68,0.3); }
    .btn-secondary { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); }
    .btn-secondary:hover { background: rgba(255,255,255,0.12); }

    /* Result overlay */
    #result-overlay {
      position: fixed; inset: 0; z-index: 300;
      background: rgba(0,0,0,0.75); backdrop-filter: blur(8px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: white; opacity: 0; pointer-events: none; transition: opacity 0.4s;
    }
    #result-overlay.active { opacity: 1; pointer-events: all; }
    #result-overlay h1 { font-size: 3.5rem; margin-bottom: 0.5rem; }
    #result-overlay p { font-size: 1.2rem; color: #aaa; margin-bottom: 1.5rem; }
    #result-overlay .btn-bar { position: static; transform: none; }

    /* Round result flash */
    #round-flash {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 250; font-size: 4rem; font-weight: 900;
      opacity: 0; pointer-events: none; transition: all 0.4s;
      text-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #round-flash.show { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }

    /* Toast */
    #toast-container {
      position: fixed; top: 180px; right: 16px; z-index: 9000;
      display: flex; flex-direction: column; gap: 8px; max-width: 300px;
    }
    .toast {
      background: rgba(10,20,10,0.9); border: 1px solid rgba(34,197,94,0.5);
      border-radius: 12px; padding: 12px 16px; color: white;
      animation: toastIn 0.3s ease-out; font-size: 13px;
    }
    @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } }
    .toast-title { font-weight: 700; margin-bottom: 2px; }
    .toast-msg { color: #aaa; font-size: 12px; }
    .toast-actions { display: flex; gap: 6px; margin-top: 8px; }
    .toast-btn { padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; }
    .toast-btn.accept { background: #22c55e; color: white; }
    .toast-btn.decline { background: rgba(255,255,255,0.1); color: #aaa; }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <h1>Soccer Shootout</h1>
    <p>Setting up the pitch...</p>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-card you">
      <h3>SHOOTER</h3>
      <div class="score" id="score-you">0</div>
      <div class="name" id="name-you">You</div>
    </div>
    <div class="hud-vs">VS</div>
    <div class="hud-card opp">
      <h3>KEEPER</h3>
      <div class="score" id="score-opp">0</div>
      <div class="name" id="name-opp">AI</div>
    </div>
  </div>
  <div id="hud-status">Get ready to shoot!</div>

  <!-- Shot indicator: 3 dots for you, separator, 3 dots for opponent -->
  <div id="shot-indicator">
    <div class="shot-dot" id="you-shot-0"></div>
    <div class="shot-dot" id="you-shot-1"></div>
    <div class="shot-dot" id="you-shot-2"></div>
    <div class="shot-separator"></div>
    <div class="shot-dot" id="opp-shot-0"></div>
    <div class="shot-dot" id="opp-shot-1"></div>
    <div class="shot-dot" id="opp-shot-2"></div>
  </div>

  <!-- Buttons -->
  <div class="btn-bar" id="game-btns">
    <button class="btn btn-danger" onclick="abandonMatch()">Abandon Match</button>
    <a class="btn btn-secondary" href="/vr/game-arena/">Back to Arena</a>
  </div>

  <!-- Round result flash -->
  <div id="round-flash"></div>

  <!-- Final result overlay -->
  <div id="result-overlay">
    <h1 id="result-title">You Win!</h1>
    <p id="result-subtitle">Great shootout!</p>
    <div class="btn-bar">
      <button class="btn btn-primary" onclick="newMatch()">Play Again</button>
      <a class="btn btn-secondary" href="/vr/game-arena/">Back to Arena</a>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-container"></div>

  <!-- A-FRAME SCENE -->
  <a-scene
    renderer="antialias: true; colorManagement: true; sortTransparentObjects: true"
    vr-mode-ui="enabled: true"
    loading-screen="enabled: false"
    cursor="rayOrigin: mouse; fuse: false"
    raycaster="objects: .clickable"
  >
    <a-assets></a-assets>

    <!-- Sky -->
    <a-sky color="#1a2a1a"></a-sky>

    <!-- Ground (pitch) -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="40" height="60" color="#1a6b1a" material="roughness: 0.9"></a-plane>
    <!-- Pitch lines -->
    <a-plane position="0 0.01 0" rotation="-90 0 0" width="36" height="50" color="#1f7a1f" material="roughness: 0.9; transparent: true; opacity: 0.3"></a-plane>
    <!-- Center circle -->
    <a-ring position="0 0.02 0" rotation="-90 0 0" radius-inner="4.9" radius-outer="5" color="#fff" opacity="0.3"></a-ring>
    <!-- Penalty box lines -->
    <a-entity position="0 0.02 -18">
      <a-plane rotation="-90 0 0" width="16" height="0.08" color="#fff" opacity="0.4" position="0 6 0"></a-plane>
      <a-plane rotation="-90 0 0" width="0.08" height="12" color="#fff" opacity="0.4" position="-8 0 0"></a-plane>
      <a-plane rotation="-90 0 0" width="0.08" height="12" color="#fff" opacity="0.4" position="8 0 0"></a-plane>
      <a-plane rotation="-90 0 0" width="16" height="0.08" color="#fff" opacity="0.4" position="0 -6 0"></a-plane>
    </a-entity>
    <!-- Penalty spot -->
    <a-circle position="0 0.03 -15" rotation="-90 0 0" radius="0.15" color="#fff" opacity="0.7"></a-circle>

    <!-- ===== GOAL ===== -->
    <a-entity id="goal" position="0 0 -24">
      <!-- Goal posts -->
      <a-cylinder position="-3.66 1.22 0" radius="0.06" height="2.44" color="#fff"></a-cylinder>
      <a-cylinder position="3.66 1.22 0" radius="0.06" height="2.44" color="#fff"></a-cylinder>
      <!-- Crossbar -->
      <a-cylinder position="0 2.44 0" radius="0.06" height="7.38" rotation="0 0 90" color="#fff"></a-cylinder>
      <!-- Net (semi-transparent back) -->
      <a-plane position="0 1.22 -0.5" width="7.32" height="2.44" color="#999" opacity="0.15" material="side: double; transparent: true"></a-plane>
      <a-plane position="-3.66 1.22 -0.25" width="0.5" height="2.44" color="#999" opacity="0.1" material="transparent: true"></a-plane>
      <a-plane position="3.66 1.22 -0.25" width="0.5" height="2.44" color="#999" opacity="0.1" material="transparent: true"></a-plane>
      <a-plane position="0 2.44 -0.25" rotation="90 0 0" width="7.32" height="0.5" color="#999" opacity="0.1" material="transparent: true"></a-plane>
    </a-entity>

    <!-- ===== GOALKEEPER ===== -->
    <a-entity id="keeper" position="0 0 -23.5">
      <!-- Body -->
      <a-box id="keeper-body" position="0 0.9 0" width="0.6" height="1.2" depth="0.35" color="#f59e0b"></a-box>
      <!-- Head -->
      <a-sphere id="keeper-head" position="0 1.7 0" radius="0.2" color="#fbbf24"></a-sphere>
      <!-- Arms -->
      <a-box id="keeper-arm-l" position="-0.5 1.1 0" width="0.5" height="0.15" depth="0.15" color="#f59e0b"></a-box>
      <a-box id="keeper-arm-r" position="0.5 1.1 0" width="0.5" height="0.15" depth="0.15" color="#f59e0b"></a-box>
      <!-- Legs -->
      <a-box position="-0.15 0.25 0" width="0.2" height="0.5" depth="0.2" color="#1e3a5f"></a-box>
      <a-box position="0.15 0.25 0" width="0.2" height="0.5" depth="0.2" color="#1e3a5f"></a-box>
      <!-- Gloves -->
      <a-box id="keeper-glove-l" position="-0.8 1.1 0" width="0.18" height="0.22" depth="0.1" color="#22c55e"></a-box>
      <a-box id="keeper-glove-r" position="0.8 1.1 0" width="0.18" height="0.22" depth="0.1" color="#22c55e"></a-box>
    </a-entity>

    <!-- ===== SOCCER BALL ===== -->
    <a-sphere id="ball" position="0 0.22 -15" radius="0.22" color="#fff"
              material="roughness: 0.3; metalness: 0.1">
      <!-- Black pentagon patches -->
      <a-sphere position="0 0.18 0.08" radius="0.06" color="#333"></a-sphere>
      <a-sphere position="0.1 -0.1 0.15" radius="0.06" color="#333"></a-sphere>
      <a-sphere position="-0.1 -0.1 0.15" radius="0.06" color="#333"></a-sphere>
    </a-sphere>

    <!-- ===== TARGET ZONES (clickable areas of the goal) ===== -->
    <!-- 3x2 grid of clickable target zones -->
    <a-entity id="target-zones" position="0 1.22 -23.8" visible="false">
      <!-- Top row -->
      <a-plane class="clickable target-zone" data-zone="top-left" position="-1.8 0.6 0" width="2.2" height="1.1"
               color="#22c55e" opacity="0.2" material="transparent: true; shader: flat"></a-plane>
      <a-plane class="clickable target-zone" data-zone="top-center" position="0 0.6 0" width="2.2" height="1.1"
               color="#f59e0b" opacity="0.2" material="transparent: true; shader: flat"></a-plane>
      <a-plane class="clickable target-zone" data-zone="top-right" position="1.8 0.6 0" width="2.2" height="1.1"
               color="#22c55e" opacity="0.2" material="transparent: true; shader: flat"></a-plane>
      <!-- Bottom row -->
      <a-plane class="clickable target-zone" data-zone="bottom-left" position="-1.8 -0.5 0" width="2.2" height="1.1"
               color="#3b82f6" opacity="0.2" material="transparent: true; shader: flat"></a-plane>
      <a-plane class="clickable target-zone" data-zone="bottom-center" position="0 -0.5 0" width="2.2" height="1.1"
               color="#ef4444" opacity="0.2" material="transparent: true; shader: flat"></a-plane>
      <a-plane class="clickable target-zone" data-zone="bottom-right" position="1.8 -0.5 0" width="2.2" height="1.1"
               color="#3b82f6" opacity="0.2" material="transparent: true; shader: flat"></a-plane>

      <!-- Zone labels -->
      <a-text value="TOP\nLEFT" align="center" position="-1.8 0.6 0.02" width="3" color="#22c55e" opacity="0.6"></a-text>
      <a-text value="TOP\nCENTER" align="center" position="0 0.6 0.02" width="3" color="#f59e0b" opacity="0.6"></a-text>
      <a-text value="TOP\nRIGHT" align="center" position="1.8 0.6 0.02" width="3" color="#22c55e" opacity="0.6"></a-text>
      <a-text value="BOTTOM\nLEFT" align="center" position="-1.8 -0.5 0.02" width="3" color="#3b82f6" opacity="0.6"></a-text>
      <a-text value="BOTTOM\nCENTER" align="center" position="0 -0.5 0.02" width="3" color="#ef4444" opacity="0.6"></a-text>
      <a-text value="BOTTOM\nRIGHT" align="center" position="1.8 -0.5 0.02" width="3" color="#3b82f6" opacity="0.6"></a-text>
    </a-entity>

    <!-- ===== KEEPER DIVE ZONES (when player is keeper) ===== -->
    <a-entity id="dive-zones" position="0 1.22 -23.8" visible="false">
      <a-plane class="clickable dive-zone" data-zone="left" position="-2 0 0" width="2.5" height="2.4"
               color="#6366f1" opacity="0.25" material="transparent: true; shader: flat"></a-plane>
      <a-plane class="clickable dive-zone" data-zone="center" position="0 0 0" width="2.5" height="2.4"
               color="#a855f7" opacity="0.25" material="transparent: true; shader: flat"></a-plane>
      <a-plane class="clickable dive-zone" data-zone="right" position="2 0 0" width="2.5" height="2.4"
               color="#6366f1" opacity="0.25" material="transparent: true; shader: flat"></a-plane>

      <a-text value="DIVE\nLEFT" align="center" position="-2 0 0.02" width="3.5" color="#6366f1" opacity="0.7"></a-text>
      <a-text value="STAY\nCENTER" align="center" position="0 0 0.02" width="3.5" color="#a855f7" opacity="0.7"></a-text>
      <a-text value="DIVE\nRIGHT" align="center" position="2 0 0.02" width="3.5" color="#6366f1" opacity="0.7"></a-text>
    </a-entity>

    <!-- Floodlights -->
    <a-entity position="-12 8 -15">
      <a-box width="0.3" height="8" depth="0.3" color="#333" position="0 -4 0"></a-box>
      <a-box width="1.5" height="0.4" depth="0.8" color="#555" position="0 0 0"></a-box>
    </a-entity>
    <a-entity position="12 8 -15">
      <a-box width="0.3" height="8" depth="0.3" color="#333" position="0 -4 0"></a-box>
      <a-box width="1.5" height="0.4" depth="0.8" color="#555" position="0 0 0"></a-box>
    </a-entity>

    <!-- Stadium ambient (simple stands) -->
    <a-box position="-16 2 -15" width="2" height="5" depth="30" color="#1a1a2e" opacity="0.6"></a-box>
    <a-box position="16 2 -15" width="2" height="5" depth="30" color="#1a1a2e" opacity="0.6"></a-box>
    <a-box position="0 2 -30" width="35" height="5" depth="2" color="#1a1a2e" opacity="0.6"></a-box>

    <!-- Lighting -->
    <a-light type="ambient" color="#304030" intensity="0.5"></a-light>
    <a-light type="directional" position="0 8 -5" color="#ffffff" intensity="0.6"></a-light>
    <a-light type="point" position="-12 8 -15" color="#fff5cc" intensity="0.8" distance="30"></a-light>
    <a-light type="point" position="12 8 -15" color="#fff5cc" intensity="0.8" distance="30"></a-light>
    <a-light type="point" position="0 4 -24" color="#22c55e" intensity="0.3" distance="10"></a-light>

    <!-- Camera Rig -->
    <a-entity id="rig" position="0 1.6 -12">
      <a-camera look-controls wasd-controls="acceleration: 30" fov="75">
        <a-ring cursor="fuse: false"
                raycaster="objects: .clickable; far: 30"
                radius-inner="0.005" radius-outer="0.012"
                color="#22c55e" shader="flat" position="0 0 -1"
                animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 200"
                animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.5 0.5 0.5; dur: 1500; easing: linear"
                animation__mouseleave="property: scale; startEvents: mouseleave; to: 1 1 1; dur: 200"></a-ring>
      </a-camera>
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable; far: 25; lineColor: #22c55e; lineOpacity: 0.5" cursor="rayOrigin: entity; fuse: false"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 25; lineColor: #16a34a; lineOpacity: 0.5" cursor="rayOrigin: entity; fuse: false"></a-entity>
    </a-entity>
  </a-scene>

  <script>
  (function() {
    'use strict';

    // ===== LOADING =====
    window.addEventListener('load', function () {
      setTimeout(function () {
        var el = document.getElementById('loading');
        el.style.opacity = '0';
        setTimeout(function () { el.classList.add('hidden'); }, 500);
      }, 1200);
    });

    // ===== STATE =====
    var STORAGE_KEY = 'gameArena';
    var arenaState = (function() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e) { return {}; }
    })();
    var playerName = arenaState.playerName || 'You';
    var params = new URLSearchParams(window.location.search);
    var opponentName = params.get('opponent') || 'AI';

    document.getElementById('name-you').textContent = playerName;
    document.getElementById('name-opp').textContent = opponentName;

    // ===== GAME CONFIG =====
    var TOTAL_ROUNDS = 3; // Best of 3 shots each
    var ZONES = ['top-left', 'top-center', 'top-right', 'bottom-left', 'bottom-center', 'bottom-right'];
    var DIVE_ZONES = ['left', 'center', 'right'];

    // Zone -> 3D positions for ball animation
    var ZONE_POSITIONS = {
      'top-left':      { x: -2, y: 2.1, z: -24 },
      'top-center':    { x: 0,  y: 2.1, z: -24 },
      'top-right':     { x: 2,  y: 2.1, z: -24 },
      'bottom-left':   { x: -2, y: 0.6, z: -24 },
      'bottom-center': { x: 0,  y: 0.6, z: -24 },
      'bottom-right':  { x: 2,  y: 0.6, z: -24 }
    };

    // Dive zone -> keeper x position
    var DIVE_POSITIONS = {
      'left': -2.5,
      'center': 0,
      'right': 2.5
    };

    // Which dive zone covers which target zones
    var DIVE_COVERS = {
      'left': ['top-left', 'bottom-left'],
      'center': ['top-center', 'bottom-center'],
      'right': ['top-right', 'bottom-right']
    };

    // ===== MATCH STATE =====
    var myScore = 0;
    var oppScore = 0;
    var currentRound = 0; // 0-indexed, goes 0..5 (3 yours + 3 opponent's, alternating)
    var totalShots = TOTAL_ROUNDS * 2; // 6 total shots (3 each)
    var myShots = []; // 'goal' or 'miss' for each of my shots
    var oppShots = []; // 'goal' or 'miss' for each of opponent's shots
    var phase = 'waiting'; // 'waiting', 'shooting', 'keeping', 'animating', 'done'
    var isPlayerShooting = true; // alternating: true = player shoots, false = player keeps

    // ===== ELEMENTS =====
    var ball = document.getElementById('ball');
    var keeper = document.getElementById('keeper');
    var targetZones = document.getElementById('target-zones');
    var diveZones = document.getElementById('dive-zones');

    // ===== SETUP TARGET ZONE CLICKS =====
    document.querySelectorAll('.target-zone').forEach(function(zone) {
      zone.addEventListener('click', function() {
        if (phase !== 'shooting') return;
        var target = zone.getAttribute('data-zone');
        playerShoot(target);
      });
      zone.addEventListener('mouseenter', function() {
        if (phase === 'shooting') zone.setAttribute('material', 'opacity', 0.5);
      });
      zone.addEventListener('mouseleave', function() {
        if (phase === 'shooting') zone.setAttribute('material', 'opacity', 0.2);
      });
    });

    // ===== SETUP DIVE ZONE CLICKS =====
    document.querySelectorAll('.dive-zone').forEach(function(zone) {
      zone.addEventListener('click', function() {
        if (phase !== 'keeping') return;
        var dir = zone.getAttribute('data-zone');
        playerKeep(dir);
      });
      zone.addEventListener('mouseenter', function() {
        if (phase === 'keeping') zone.setAttribute('material', 'opacity', 0.5);
      });
      zone.addEventListener('mouseleave', function() {
        if (phase === 'keeping') zone.setAttribute('material', 'opacity', 0.25);
      });
    });

    // ===== PLAYER SHOOTS =====
    function playerShoot(targetZone) {
      phase = 'animating';
      targetZones.setAttribute('visible', 'false');
      setStatus('Shooting...');

      // AI keeper decides where to dive
      var aiDive = DIVE_ZONES[Math.floor(Math.random() * DIVE_ZONES.length)];

      // Animate keeper dive
      animateKeeperDive(aiDive);

      // Animate ball to target
      var pos = ZONE_POSITIONS[targetZone];
      animateBall(pos, function() {
        // Check if saved
        var saved = DIVE_COVERS[aiDive].indexOf(targetZone) !== -1;
        // 10% chance ball misses entirely (hits post/over)
        var misses = Math.random() < 0.1;

        if (misses) {
          showRoundFlash('MISS!', '#f59e0b');
          myShots.push('miss');
          updateShotDots();
        } else if (saved) {
          showRoundFlash('SAVED!', '#ef4444');
          myShots.push('miss');
          updateShotDots();
        } else {
          showRoundFlash('GOAL!', '#22c55e');
          myScore++;
          myShots.push('goal');
          updateScoreHUD();
          updateShotDots();
        }

        setTimeout(function() {
          nextRound();
        }, 1800);
      });
    }

    // ===== PLAYER KEEPS (DIVES) =====
    function playerKeep(diveDir) {
      phase = 'animating';
      diveZones.setAttribute('visible', 'false');
      setStatus(opponentName + ' shoots...');

      // AI picks a target
      var aiTarget = ZONES[Math.floor(Math.random() * ZONES.length)];

      // Animate ball from opponent
      var pos = ZONE_POSITIONS[aiTarget];

      // Animate keeper (player) dive
      animateKeeperDive(diveDir);

      // Brief delay then animate ball
      setTimeout(function() {
        animateBall(pos, function() {
          var saved = DIVE_COVERS[diveDir].indexOf(aiTarget) !== -1;
          var misses = Math.random() < 0.12; // AI has small miss chance

          if (misses) {
            showRoundFlash('THEY MISS!', '#22c55e');
            oppShots.push('miss');
            updateShotDots();
          } else if (saved) {
            showRoundFlash('YOU SAVED IT!', '#22c55e');
            oppShots.push('miss');
            updateShotDots();
          } else {
            showRoundFlash('THEY SCORE!', '#ef4444');
            oppScore++;
            oppShots.push('goal');
            updateScoreHUD();
            updateShotDots();
          }

          setTimeout(function() {
            nextRound();
          }, 1800);
        });
      }, 500);
    }

    // ===== ANIMATIONS =====
    function animateBall(targetPos, callback) {
      var startPos = { x: 0, y: 0.22, z: -15 };
      ball.setAttribute('position', startPos.x + ' ' + startPos.y + ' ' + startPos.z);

      // Animate ball flying to target
      ball.setAttribute('animation__fly', {
        property: 'position',
        to: targetPos.x + ' ' + targetPos.y + ' ' + targetPos.z,
        dur: 600,
        easing: 'easeInQuad'
      });

      // Spin the ball
      ball.setAttribute('animation__spin', {
        property: 'rotation',
        from: '0 0 0',
        to: '360 720 0',
        dur: 600,
        easing: 'linear'
      });

      setTimeout(callback, 700);
    }

    function animateKeeperDive(direction) {
      var x = DIVE_POSITIONS[direction];
      var keeperBody = document.getElementById('keeper');

      keeperBody.setAttribute('animation__dive', {
        property: 'position',
        to: x + ' 0 -23.5',
        dur: 400,
        easing: 'easeOutQuad'
      });

      // Diving animation - tilt
      if (direction === 'left') {
        keeperBody.setAttribute('animation__tilt', { property: 'rotation', to: '0 0 30', dur: 400, easing: 'easeOutQuad' });
      } else if (direction === 'right') {
        keeperBody.setAttribute('animation__tilt', { property: 'rotation', to: '0 0 -30', dur: 400, easing: 'easeOutQuad' });
      } else {
        keeperBody.setAttribute('animation__tilt', { property: 'rotation', to: '0 0 0', dur: 200 });
      }
    }

    function resetPositions() {
      // Reset ball
      ball.setAttribute('position', '0 0.22 -15');
      ball.removeAttribute('animation__fly');
      ball.removeAttribute('animation__spin');
      ball.setAttribute('rotation', '0 0 0');

      // Reset keeper
      keeper.setAttribute('position', '0 0 -23.5');
      keeper.removeAttribute('animation__dive');
      keeper.removeAttribute('animation__tilt');
      keeper.setAttribute('rotation', '0 0 0');
    }

    // ===== ROUND MANAGEMENT =====
    function nextRound() {
      currentRound++;
      resetPositions();

      // Check if match is over
      var myRoundsDone = myShots.length;
      var oppRoundsDone = oppShots.length;

      // Match ends when both have taken all 3 shots
      if (myRoundsDone >= TOTAL_ROUNDS && oppRoundsDone >= TOTAL_ROUNDS) {
        endMatch();
        return;
      }

      // Check if the match is already decided (impossible to catch up)
      var myRemaining = TOTAL_ROUNDS - myRoundsDone;
      var oppRemaining = TOTAL_ROUNDS - oppRoundsDone;
      if (myScore > oppScore + oppRemaining) {
        // Player has clinched victory
        endMatch();
        return;
      }
      if (oppScore > myScore + myRemaining) {
        // Opponent has clinched victory
        endMatch();
        return;
      }

      // Alternate sides
      isPlayerShooting = !isPlayerShooting;

      setTimeout(function() {
        if (isPlayerShooting) {
          startShootingRound();
        } else {
          startKeepingRound();
        }
      }, 1000);
    }

    function startShootingRound() {
      phase = 'shooting';
      targetZones.setAttribute('visible', 'true');
      diveZones.setAttribute('visible', 'false');

      var shotNum = myShots.length + 1;
      setStatus('Shot ' + shotNum + '/' + TOTAL_ROUNDS + ' - Pick your target!');

      // Highlight active shot dot
      var dotIdx = myShots.length;
      if (dotIdx < TOTAL_ROUNDS) {
        var dot = document.getElementById('you-shot-' + dotIdx);
        if (dot) dot.classList.add('active');
      }

      // Update HUD roles
      document.querySelector('.hud-card.you h3').textContent = 'SHOOTER';
      document.querySelector('.hud-card.opp h3').textContent = 'KEEPER';
    }

    function startKeepingRound() {
      phase = 'keeping';
      diveZones.setAttribute('visible', 'true');
      targetZones.setAttribute('visible', 'false');

      var shotNum = oppShots.length + 1;
      setStatus(opponentName + '\'s Shot ' + shotNum + '/' + TOTAL_ROUNDS + ' - Pick your dive!');

      // Highlight active shot dot
      var dotIdx = oppShots.length;
      if (dotIdx < TOTAL_ROUNDS) {
        var dot = document.getElementById('opp-shot-' + dotIdx);
        if (dot) dot.classList.add('active');
      }

      // Update HUD roles
      document.querySelector('.hud-card.you h3').textContent = 'KEEPER';
      document.querySelector('.hud-card.opp h3').textContent = 'SHOOTER';
    }

    // ===== END MATCH =====
    function endMatch() {
      phase = 'done';
      targetZones.setAttribute('visible', 'false');
      diveZones.setAttribute('visible', 'false');

      var overlay = document.getElementById('result-overlay');
      var title = document.getElementById('result-title');
      var sub = document.getElementById('result-subtitle');

      var result;
      if (myScore > oppScore) {
        title.textContent = 'YOU WIN!';
        title.style.color = '#22c55e';
        sub.textContent = myScore + ' - ' + oppScore + ' | Great shooting!';
        result = 'win';
      } else if (oppScore > myScore) {
        title.textContent = opponentName.toUpperCase() + ' WINS!';
        title.style.color = '#ef4444';
        sub.textContent = myScore + ' - ' + oppScore + ' | Better luck next time!';
        result = 'loss';
      } else {
        title.textContent = 'DRAW!';
        title.style.color = '#f59e0b';
        sub.textContent = myScore + ' - ' + oppScore + ' | What a match!';
        result = 'draw';
      }

      setStatus('Match Over!');
      recordMatch(result);

      setTimeout(function() {
        overlay.classList.add('active');
      }, 500);
    }

    function recordMatch(result) {
      try {
        var s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        s.wins = (s.wins || 0) + (result === 'win' ? 1 : 0);
        s.losses = (s.losses || 0) + (result === 'loss' ? 1 : 0);
        s.draws = (s.draws || 0) + (result === 'draw' ? 1 : 0);
        if (!s.matches) s.matches = [];
        s.matches.push({ game: 'Soccer Shootout', opponent: opponentName, result: result, time: Date.now() });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      } catch(e) {}
    }

    // ===== NEW MATCH =====
    window.newMatch = function() {
      myScore = 0; oppScore = 0;
      currentRound = 0;
      myShots = []; oppShots = [];
      isPlayerShooting = true;
      phase = 'waiting';

      document.getElementById('result-overlay').classList.remove('active');

      // Reset shot dots
      for (var i = 0; i < TOTAL_ROUNDS; i++) {
        ['you-shot-', 'opp-shot-'].forEach(function(prefix) {
          var dot = document.getElementById(prefix + i);
          if (dot) { dot.className = 'shot-dot'; }
        });
      }

      updateScoreHUD();
      resetPositions();

      setTimeout(function() {
        startShootingRound();
      }, 800);
    };

    // ===== ABANDON =====
    window.abandonMatch = function() {
      if (confirm('Abandon this match? It will count as a loss.')) {
        recordMatch('loss');
        window.location.href = '/vr/game-arena/';
      }
    };

    // ===== UI HELPERS =====
    function setStatus(text) {
      document.getElementById('hud-status').textContent = text;
    }

    function updateScoreHUD() {
      document.getElementById('score-you').textContent = myScore;
      document.getElementById('score-opp').textContent = oppScore;
    }

    function updateShotDots() {
      myShots.forEach(function(result, i) {
        var dot = document.getElementById('you-shot-' + i);
        if (dot) { dot.className = 'shot-dot ' + (result === 'goal' ? 'goal' : 'miss'); }
      });
      oppShots.forEach(function(result, i) {
        var dot = document.getElementById('opp-shot-' + i);
        if (dot) { dot.className = 'shot-dot ' + (result === 'goal' ? 'goal' : 'miss'); }
      });
    }

    function showRoundFlash(text, color) {
      var flash = document.getElementById('round-flash');
      flash.textContent = text;
      flash.style.color = color;
      flash.classList.add('show');
      setTimeout(function() { flash.classList.remove('show'); }, 1200);
    }

    // ===== INCOMING CHALLENGE TOAST =====
    var BOT_NAMES = ['MapleLeaf99','PuckMaster','CityExplorer','NightOwlTO','LakeShoreRun','QueenWestAce'];
    function simulateChallenge() {
      var delay = 30000 + Math.random() * 50000;
      setTimeout(function() {
        var challenger = BOT_NAMES[Math.floor(Math.random() * BOT_NAMES.length)];
        var games = [
          { name: 'Soccer Shootout', url: '/vr/game-arena/soccer-shootout.html' },
          { name: 'Tic-Tac-Toe', url: '/vr/game-arena/tic-tac-toe.html' }
        ];
        var game = games[Math.floor(Math.random() * games.length)];
        var c = document.getElementById('toast-container');
        var t = document.createElement('div');
        t.className = 'toast';
        t.innerHTML = '<div class="toast-title">' + challenger + ' challenges you!</div>'
          + '<div class="toast-msg">' + game.name + '</div>'
          + '<div class="toast-actions">'
          + '<button class="toast-btn accept" onclick="window.location.href=\'' + game.url + '?opponent=' + encodeURIComponent(challenger) + '\'">Accept</button>'
          + '<button class="toast-btn decline" onclick="this.closest(\'.toast\').remove()">Decline</button>'
          + '</div>';
        c.appendChild(t);
        setTimeout(function() { if (t.parentNode) { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(function(){ t.remove(); }, 300); } }, 12000);
        simulateChallenge();
      }, delay);
    }

    // ===== INIT =====
    function init() {
      updateScoreHUD();
      // Start first round after loading
      setTimeout(function() {
        startShootingRound();
      }, 2500);
      simulateChallenge();
    }

    init();
  })();
  </script>
  <!-- VR Navigation Menu -->
  <script src="/vr/nav-menu.js"></script>
</body>
</html>
