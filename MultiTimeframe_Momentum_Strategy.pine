// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Multi-Timeframe Momentum Strategy - Meme Coin Scanner v2.5

//@version=5
strategy("Multi-Timeframe Momentum Strategy", shorttitle="MTF Momentum", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10, commission_type=strategy.commission.percent, commission_value=0.1, slippage=1)

// INPUTS
tf1 = input.timeframe("60", "Primary TF (1h recommended)")
tf2 = input.timeframe("240", "Secondary TF (4h recommended)")
tf3 = input.timeframe("D", "Tertiary TF (Daily)")
min1hChange = input.float(2.0, "Min 1h Momentum %", minval=0.5, maxval=10.0, step=0.5)
min4hChange = input.float(3.0, "Min 4h Momentum %", minval=1.0, maxval=15.0, step=0.5)
rsiLength = input.int(14, "RSI Length")
rsiOverbought = input.int(75, "RSI Overbought Level")
rsiOversold = input.int(40, "RSI Oversold Level")
volumeMultiplier = input.float(1.5, "Volume Multiplier (vs 20 SMA)", minval=1.0, maxval=5.0, step=0.1)
stopLossPct = input.float(5.0, "Stop Loss %", minval=1.0, maxval=15.0, step=0.5)
takeProfitPct = input.float(15.0, "Take Profit %", minval=5.0, maxval=50.0, step=1.0)
trailingStop = input.bool(true, "Use Trailing Stop")
trailingStopPct = input.float(10.0, "Trailing Stop %", minval=3.0, maxval=20.0, step=1.0)
maxPositions = input.int(3, "Max Concurrent Positions", minval=1, maxval=10)

// MULTI-TIMEFRAME DATA
currentClose = request.security(syminfo.tickerid, tf1, close)
currentOpen = request.security(syminfo.tickerid, tf1, open)
currentVolume = request.security(syminfo.tickerid, tf1, volume)
tf2Close = request.security(syminfo.tickerid, tf2, close)
tf2Open = request.security(syminfo.tickerid, tf2, open)
tf2Change = ((tf2Close - tf2Open) / tf2Open) * 100
tf3Close = request.security(syminfo.tickerid, tf3, close)
tf3Open = request.security(syminfo.tickerid, tf3, open)
tf3Change = ((tf3Close - tf3Open) / tf3Open) * 100

// INDICATORS
rsi = ta.rsi(close, rsiLength)
volumeSMA = ta.sma(volume, 20)
volumeSpike = currentVolume > (volumeSMA * volumeMultiplier)
change1h = ((currentClose - currentOpen) / currentOpen) * 100
ema12 = ta.ema(close, 12)
ema26 = ta.ema(close, 26)
trendBullish = ema12 > ema26

// ALIGNMENT SCORING
score1h = change1h >= min1hChange ? 25 : (change1h > 0 ? 15 : 0)
score4h = tf2Change >= min4hChange ? 25 : (tf2Change > 0 ? 15 : 0)
scoreDaily = tf3Change > 0 ? 25 : 0
rsiScore = rsi < rsiOverbought and rsi > 50 ? 25 : (rsi < rsiOverbought and rsi > 40 ? 15 : 0)
compositeScore = score1h + score4h + scoreDaily + rsiScore

// PATTERN DETECTION
breakoutPattern = change1h > min1hChange and tf2Change > 0 and tf3Change > -5
continuationPattern = change1h > 0 and tf2Change > 0 and tf3Change > 5
earlyMomentum = change1h > min1hChange and tf2Change < min4hChange and tf3Change > -2
parabolicWarning = tf3Change > 50 or (tf2Change > 30 and change1h < 2)
dipRecovery = change1h > 2 and tf2Change < 0 and tf3Change > 10
patternLabel = breakoutPattern ? "BREAKOUT" : (continuationPattern ? "CONTINUATION" : (earlyMomentum ? "EARLY" : (dipRecovery ? "DIP" : "NONE")))

// ENTRY CONDITIONS
noPosition = strategy.position_size == 0
hasPosition = strategy.position_size > 0
openTradesOk = strategy.opentrades < maxPositions
longCondition = compositeScore >= 60 and (not parabolicWarning) and trendBullish and rsi < rsiOverbought and (breakoutPattern or continuationPattern or earlyMomentum or dipRecovery) and volumeSpike
canEnterLong = longCondition and openTradesOk and noPosition

// EXIT CONDITIONS
longStopLoss = strategy.position_avg_price * (1 - stopLossPct / 100)
longTakeProfit = strategy.position_avg_price * (1 + takeProfitPct / 100)
var float trailStopPrice = na
if hasPosition
    trailStopPrice := na(trailStopPrice) ? close * (1 - trailingStopPct / 100) : math.max(trailStopPrice, close * (1 - trailingStopPct / 100))
momentumReversal = change1h < -2 and tf2Change < 0
rsiExit = rsi > 85

// EXECUTION
if canEnterLong
    strategy.entry("Long", strategy.long, comment=patternLabel)

if hasPosition
    strategy.exit("Take Profit", "Long", limit=longTakeProfit, stop=longStopLoss)
    if trailingStop and (not na(trailStopPrice))
        strategy.close("Long", when=close < trailStopPrice, comment="Trail")
    strategy.close("Long", when=momentumReversal, comment="Reversal")
    strategy.close("Long", when=rsiExit, comment="RSI")

// VISUALIZATION
bgcolor(compositeScore >= 75 ? color.new(color.green, 90) : (compositeScore >= 60 ? color.new(color.lime, 90) : (compositeScore >= 40 ? color.new(color.yellow, 90) : color.new(color.red, 95))))
plot(ema12, "EMA 12", color.blue, 1)
plot(ema26, "EMA 26", color.orange, 1)
plotshape(longCondition and noPosition, title="Buy", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small, text="BUY")

// INFO TABLE
var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 10), frame_color=color.gray, frame_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "Score", text_color=color.white)
    table.cell(infoTable, 1, 0, str.tostring(compositeScore) + "/100", text_color=compositeScore >= 75 ? color.green : (compositeScore >= 60 ? color.yellow : color.red))
    table.cell(infoTable, 0, 1, "1h", text_color=color.gray)
    table.cell(infoTable, 1, 1, str.tostring(change1h, "#.##") + "%", text_color=change1h > 0 ? color.green : color.red)
    table.cell(infoTable, 0, 2, "4h", text_color=color.gray)
    table.cell(infoTable, 1, 2, str.tostring(tf2Change, "#.##") + "%", text_color=tf2Change > 0 ? color.green : color.red)
    table.cell(infoTable, 0, 3, "24h", text_color=color.gray)
    table.cell(infoTable, 1, 3, str.tostring(tf3Change, "#.##") + "%", text_color=tf3Change > 0 ? color.green : color.red)
    table.cell(infoTable, 0, 4, "RSI", text_color=color.gray)
    table.cell(infoTable, 1, 4, str.tostring(rsi, "#."), text_color=rsi > 70 ? color.red : (rsi < 40 ? color.green : color.gray))
    table.cell(infoTable, 0, 5, "Vol", text_color=color.gray)
    table.cell(infoTable, 1, 5, volumeSpike ? "YES" : "NO", text_color=volumeSpike ? color.green : color.gray)
    table.cell(infoTable, 0, 6, "Pattern", text_color=color.gray)
    table.cell(infoTable, 1, 6, patternLabel, text_color=breakoutPattern ? color.green : color.gray)
    table.cell(infoTable, 0, 7, "Pos", text_color=color.gray)
    table.cell(infoTable, 1, 7, hasPosition ? "LONG" : "NONE", text_color=hasPosition ? color.green : color.gray)

// ALERTS
alertcondition(longCondition and noPosition, title="Buy Signal", message="MTF Buy on {{ticker}}")
alertcondition(momentumReversal and hasPosition, title="Sell Signal", message="MTF Sell on {{ticker}}")
