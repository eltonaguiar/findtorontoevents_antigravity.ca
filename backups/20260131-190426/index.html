<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Find Toronto Events</title>
  <meta name="description" content="Find Toronto Events – curated feed updated daily." />
  <style>
    :root{--bg:#0b0613;--card:#141023;--muted:#b8b3c7;--text:#fff;--accent:#ec4899;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 500px at 50% -200px, rgba(236,72,153,.45), transparent 60%), radial-gradient(900px 500px at 20% 10%, rgba(59,130,246,.18), transparent 50%), var(--bg);color:var(--text);}
    header{padding:40px 16px 18px; text-align:center;}
    h1{margin:0;font-size:42px;letter-spacing:-0.03em;}
    .sub{margin-top:8px;color:var(--muted);font-weight:600;font-size:13px;}
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px 60px;}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.10);backdrop-filter: blur(10px);border-radius:18px;padding:14px 14px;margin:18px 0 16px;}
    .toolbar input{flex:1;min-width:240px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.10);border-radius:14px;color:var(--text);padding:12px 14px;font-weight:600;outline:none;}
    .toolbar button{background:linear-gradient(135deg, rgba(236,72,153,1), rgba(168,85,247,1));border:none;color:white;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;}
    .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px;font-weight:700;}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px;}
    @media (min-width:740px){.grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media (min-width:1060px){.grid{grid-template-columns:repeat(3,minmax(0,1fr));}}
    .card{background:rgba(20,16,35,0.88);border:1px solid rgba(255,255,255,0.10);border-radius:18px;padding:14px 14px 12px;box-shadow:0 20px 60px rgba(0,0,0,0.35);}
    .title{font-weight:900;letter-spacing:-0.02em;margin:0 0 6px;font-size:15px;line-height:1.25;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px;font-weight:700;}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.20);}
    a{color:inherit;text-decoration:none;}
    a:hover{color:white;}
    .empty{padding:24px;color:var(--muted);text-align:center;font-weight:800;}
    footer{padding:30px 16px;color:rgba(255,255,255,0.35);text-align:center;font-weight:700;font-size:12px;}
  </style>
</head>
<body>
  <header>
    <h1>Toronto Events</h1>
    <div class="sub">Curated feed • Updated daily</div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <input id="q" placeholder="Search title, location, source…" />
      <button id="refresh" type="button">Refresh</button>
      <div class="meta">
        <div id="count">Loading…</div>
        <div id="updated"></div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No events found.</div>
  </div>

  <footer>findtorontoevents.ca</footer>

  <script>
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const q = document.getElementById('q');
    const count = document.getElementById('count');
    const updated = document.getElementById('updated');

    let all = [];

    function fmtDate(d){
      try{
        const dt = new Date(d);
        return new Intl.DateTimeFormat(undefined,{weekday:'short',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(dt);
      }catch{ return String(d); }
    }

    function normalize(s){ return (s||'').toString().toLowerCase(); }

    function render(){
      const term = normalize(q.value).trim();
      const now = new Date();

      const filtered = all
        .filter(e => {
          const blob = normalize(e.title) + ' ' + normalize(e.location) + ' ' + normalize(e.source) + ' ' + normalize(e.host);
          return term ? blob.includes(term) : true;
        })
        .filter(e => {
          const dt = new Date(e.date);
          return isNaN(dt) ? true : dt >= new Date(now.getTime() - 1000*60*60*24*60);
        })
        .sort((a,b)=> new Date(a.date) - new Date(b.date));

      count.textContent = `Showing ${filtered.length} of ${all.length}`;
      grid.innerHTML = '';
      empty.style.display = filtered.length ? 'none' : 'block';

      for(const e of filtered.slice(0, 120)){
        const card = document.createElement('div');
        card.className = 'card';
        const title = document.createElement('h3');
        title.className = 'title';
        title.textContent = e.title || 'Untitled event';

        const row = document.createElement('div');
        row.className = 'row';

        const when = document.createElement('span');
        when.className = 'pill';
        when.textContent = fmtDate(e.date);

        const where = document.createElement('span');
        where.className = 'pill';
        where.textContent = (e.location || 'Toronto').slice(0, 60);

        const src = document.createElement('span');
        src.className = 'pill';
        src.textContent = e.source || 'Source';

        row.appendChild(when);
        row.appendChild(where);
        row.appendChild(src);

        const link = document.createElement('a');
        link.href = e.url || '#';
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.appendChild(title);

        card.appendChild(link);
        card.appendChild(row);
        grid.appendChild(card);
      }
    }

    async function load(){
      count.textContent = 'Loading…';
      try{
        const [eventsRes, metaRes] = await Promise.all([
          fetch('/events.json', {cache:'no-store'}),
          fetch('/metadata.json', {cache:'no-store'}).catch(()=>null)
        ]);

        if(!eventsRes.ok) throw new Error('events.json HTTP '+eventsRes.status);
        all = await eventsRes.json();

        if(metaRes && metaRes.ok){
          const m = await metaRes.json();
          if(m && m.lastUpdated) updated.textContent = 'Updated: ' + new Date(m.lastUpdated).toLocaleString();
        }

        render();
      } catch(err){
        console.error(err);
        count.textContent = 'Failed to load events.';
        grid.innerHTML = '';
        empty.style.display = 'block';
        empty.textContent = 'Failed to load events. Please refresh.';
      }
    }

    q.addEventListener('input', () => render());
    document.getElementById('refresh').addEventListener('click', () => load());

    load();
  </script>
</body>
</html>