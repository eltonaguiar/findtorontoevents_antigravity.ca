name: Portfolio Risk Controller

on:
  schedule:
    # Run after regime detection: 9 PM UTC (4 PM EST) on weekdays
    - cron: '0 21 * * 1-5'
    # Sunday extended analysis
    - cron: '30 14 * * 0'
  workflow_dispatch:

jobs:
  portfolio-risk:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --quiet \
            yfinance>=0.2.30 \
            numpy>=1.24 \
            pandas>=2.0 \
            scipy>=1.10 \
            requests>=2.31 \
            mysql-connector-python>=8.0

      - name: Run Portfolio Risk Controller
        env:
          SM_API_BASE: ${{ secrets.SM_API_BASE || 'https://findtorontoevents.ca/live-monitor/api' }}
          SM_ADMIN_KEY: ${{ secrets.SM_ADMIN_KEY || 'livetrader2026' }}
          DB_HOST: ${{ secrets.DB_HOST || 'mysql.50webs.com' }}
          DB_USER: ${{ secrets.DB_USER || 'ejaguiar1_stocks' }}
          DB_PASS: ${{ secrets.DB_PASS || 'stocks' }}
          DB_NAME: ${{ secrets.DB_NAME || 'ejaguiar1_stocks' }}
        run: |
          echo "=========================================="
          echo "PORTFOLIO RISK CONTROLLER â€” $(date -u '+%Y-%m-%d %H:%M UTC')"
          echo "=========================================="
          python scripts/portfolio_risk_controller.py
