name: Strategy Arena — Rapid Tournament Cycle

on:
  schedule:
    # Every 2 hours: 8am, 10am, 12pm, 2pm, 4pm, 6pm, 8pm, 10pm, 12am EST
    # (13,15,17,19,21,23,1,3 UTC)
    - cron: '15 1,3,13,15,17,19,21,23 * * *'
  workflow_dispatch:

jobs:
  arena-cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Initialize strategies (idempotent)
      continue-on-error: true
      run: |
        echo "=== Initializing Strategy Arena ==="
        RESULT=$(curl -s --max-time 20 "https://findtorontoevents.ca/live-monitor/api/strategy_arena.php?action=init&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        try:
            d = json.load(sys.stdin)
            if d.get('ok'):
                print(f'Created: {d.get(\"created\",0)} | Existing: {d.get(\"existing\",0)} | Total: {d.get(\"total_strategies\",0)}')
            else:
                print(f'Error: {d.get(\"error\",\"unknown\")}')
        except: print('Parse error')
        " || echo "Init: $RESULT"

    - name: Run arena cycle (place + settle)
      continue-on-error: true
      run: |
        echo "=== Running Arena Cycle ==="
        RESULT=$(curl -s --max-time 30 "https://findtorontoevents.ca/live-monitor/api/strategy_arena.php?action=run&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        try:
            d = json.load(sys.stdin)
            if d.get('ok'):
                cycle = d.get('cycle', {})
                placed = cycle.get('placed', {})
                settled = cycle.get('settled', {})
                print(f'Value bets available: {placed.get(\"value_bets_available\",0)}')
                print(f'Bets placed: {placed.get(\"bets_placed\",0)}')
                print(f'Bets settled: {settled.get(\"settled\",0)} (W:{settled.get(\"won\",0)} L:{settled.get(\"lost\",0)} P:{settled.get(\"push\",0)})')
                print(f'Voided: {settled.get(\"voided\",0)}')
                for s in placed.get('by_strategy', [])[:10]:
                    print(f'  {s[\"strategy\"]}: {s[\"placed\"]} placed, {s[\"skipped\"]} skipped')
            else:
                print(f'Error: {d.get(\"error\",\"unknown\")}')
        except: print('Parse error')
        " || echo "Run: $RESULT"

    - name: Take daily snapshot
      continue-on-error: true
      run: |
        echo "=== Saving performance snapshot ==="
        RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/live-monitor/api/strategy_arena.php?action=snapshot&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        try:
            d = json.load(sys.stdin)
            if d.get('ok'): print(f'Snapshots saved: {d.get(\"snapshots_saved\",0)} | Date: {d.get(\"date\",\"?\")}')
            else: print(f'Error: {d.get(\"error\",\"unknown\")}')
        except: print('Parse error')
        " || echo "Snapshot: $RESULT"

    - name: Auto-eliminate losers (weekly — Sundays only)
      continue-on-error: true
      run: |
        DAY=$(date +%u)
        if [ "$DAY" -eq 7 ]; then
          echo "=== Auto-eliminating statistical losers ==="
          RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/live-monitor/api/strategy_arena.php?action=eliminate&key=livetrader2026&min_bets=50&max_dd=30") || true
          echo "$RESULT" | python3 -c "
        import sys, json
        try:
            d = json.load(sys.stdin)
            if d.get('ok'):
                elim = d.get('eliminated', [])
                print(f'Eliminated: {d.get(\"eliminated_count\",0)}')
                for e in elim:
                    print(f'  {e[\"name\"]}: {e[\"reason\"]} (ROI: {e[\"final_roi\"]}%)')
            else:
                print(f'Error: {d.get(\"error\",\"unknown\")}')
        except: print('Parse error')
          " || echo "Eliminate: $RESULT"
        else
          echo "Skipping elimination (only runs on Sundays)"
        fi

    - name: Leaderboard summary
      continue-on-error: true
      run: |
        echo "=== Strategy Arena Leaderboard ==="
        RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/live-monitor/api/strategy_arena.php?action=leaderboard&sort=roi") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        try:
            d = json.load(sys.stdin)
            if d.get('ok'):
                summ = d.get('summary', {})
                print(f'Active: {summ.get(\"active\",0)}/{summ.get(\"total_strategies\",0)} strategies')
                print(f'Total bets: {summ.get(\"total_bets_placed\",0)}')
                print(f'Best: {summ.get(\"best_strategy\",\"?\")} ({summ.get(\"best_roi\",0):.1f}% ROI)')
                print(f'Worst: {summ.get(\"worst_strategy\",\"?\")} ({summ.get(\"worst_roi\",0):.1f}% ROI)')
                print()
                print('Top 10:')
                for i, s in enumerate(d.get('strategies', [])[:10]):
                    status = 'ELIM' if s['status'] == 'eliminated' else 'OK'
                    decided = int(s.get('total_wins',0)) + int(s.get('total_losses',0))
                    print(f'  #{i+1} {s[\"name\"]:30s} ROI={float(s[\"roi_pct\"]):+6.1f}% WR={s[\"win_rate\"]}% Bets={decided} [{status}] [{s.get(\"confidence\",\"?\")}]')
            else:
                print(f'Error: {d.get(\"error\",\"unknown\")}')
        except: print('Parse error')
        " || echo "Leaderboard: $RESULT"

    - name: Arena status
      continue-on-error: true
      run: |
        echo "=== Arena Status ==="
        RESULT=$(curl -s --max-time 10 "https://findtorontoevents.ca/live-monitor/api/strategy_arena.php?action=status") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        try:
            d = json.load(sys.stdin)
            if d.get('ok'):
                s = d.get('strategies', {})
                b = d.get('bets', {})
                print(f'Strategies: {s.get(\"active\",0)} active / {s.get(\"eliminated\",0)} eliminated / {s.get(\"total\",0)} total')
                print(f'Bets: {b.get(\"total\",0)} total ({b.get(\"pending\",0)} pending, {b.get(\"settled\",0)} settled)')
                print(f'Latest bet: {d.get(\"latest_bet\",\"none\")}')
                print(f'Latest settlement: {d.get(\"latest_settlement\",\"none\")}')
            else:
                print(f'Error: {d.get(\"error\",\"unknown\")}')
        except: print('Parse error')
        " || echo "Status: $RESULT"
