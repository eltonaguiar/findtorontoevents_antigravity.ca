name: Refresh All Portfolio Data

on:
  schedule:
    # Run daily at 6:30 PM ET (23:30 UTC) - after market close
    - cron: '30 23 * * 1-5'
    # Run weekly comprehensive refresh on Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  refresh-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    # ─── Step 0: Ensure all algorithms are seeded (picks up new algos from code updates) ───
    - name: Seed algorithms and portfolios
      continue-on-error: true
      run: |
        echo "=== Seeding algorithms & portfolio templates ==="
        RESULT=$(curl -s --max-time 30 "https://findtorontoevents.ca/findstocks/portfolio2/api/setup_schema.php") || true
        echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Schema ok={d.get(\"ok\")}, Actions: {len(d.get(\"actions\",[]))}')" || echo "Schema: $RESULT"

    - name: Import new stock picks
      continue-on-error: true
      run: |
        echo "=== Importing stock picks from JSON feeds ==="
        # Use source=json (not source=all) — the v1db migration is one-time only
        # and connecting to the external DB causes timeouts in CI
        # NOTE: '|| true' on curl prevents set -e from aborting the script on
        # timeout (exit code 28), allowing the for loop to actually retry.
        for attempt in 1 2 3; do
          RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findstocks/portfolio2/api/import_picks.php?source=json") || true
          if [ -n "$RESULT" ] && echo "$RESULT" | python3 -c "import sys,json; json.load(sys.stdin)" 2>/dev/null; then
            echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Imported: {d.get(\"imported\",0)}, Skipped: {d.get(\"skipped\",0)}')"
            break
          fi
          echo "Attempt $attempt failed, retrying in 5s..."
          sleep 5
        done

    - name: Fetch price data (batch 1)
      continue-on-error: true
      run: |
        echo "=== Fetching price data from Yahoo Finance (batch 1) ==="
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findstocks/portfolio2/api/fetch_prices.php?range=1y") || true
        echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Fetched: {d.get(\"fetched\",0)} tickers. Note: {d.get(\"note\",\"\")}. Errors: {d.get(\"errors\",[])}')" || echo "Fetch response: $RESULT"

    - name: Fetch price data (batch 2)
      continue-on-error: true
      run: |
        echo "=== Fetching remaining tickers ==="
        sleep 5
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findstocks/portfolio2/api/fetch_prices.php?range=1y") || true
        echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Fetched: {d.get(\"fetched\",0)} tickers. Message: {d.get(\"message\",d.get(\"note\",\"\"))}')" || echo "Fetch response: $RESULT"

    # ─── Fetch Dividend & Earnings Data ───
    - name: Fetch dividend and earnings data
      continue-on-error: true
      run: |
        echo "=== Fetching dividend & earnings data ==="

        # Ensure schema exists
        curl -s --max-time 15 \
          "https://findtorontoevents.ca/findstocks/portfolio2/api/dividend_earnings_schema.php" > /dev/null 2>&1

        TOTAL=0
        BATCH=0
        MAX_BATCHES=6

        while [ "$BATCH" -lt "$MAX_BATCHES" ]; do
          BATCH=$((BATCH + 1))
          echo "--- Batch $BATCH of $MAX_BATCHES ---"

          RESPONSE=$(curl -s --max-time 90 \
            "https://findtorontoevents.ca/findstocks/portfolio2/api/fetch_dividends_earnings.php?action=fetch_all") || true

          PROCESSED=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('processed',0))" 2>/dev/null || echo "0")
          REMAINING=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('remaining',0))" 2>/dev/null || echo "0")
          echo "Processed: $PROCESSED | Remaining: $REMAINING"
          TOTAL=$((TOTAL + PROCESSED))

          if [ "$REMAINING" = "0" ]; then
            echo "All tickers processed"
            break
          fi

          sleep 3
        done

        echo "Total dividend/earnings tickers fetched: $TOTAL"

    - name: Track saved portfolios
      continue-on-error: true
      run: |
        echo "=== Tracking saved portfolio positions ==="
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findstocks/portfolio2/api/track_portfolio.php?key=stocksrefresh2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'Portfolios tracked: {d.get(\"portfolios_tracked\", 0)}')
            print(f'Positions checked: {d.get(\"positions_checked\", 0)}')
            print(f'Positions closed: {d.get(\"positions_closed\", 0)}')
            cr = d.get('close_reasons', {})
            print(f'  SL hits: {cr.get(\"stop_loss\",0)}, TP hits: {cr.get(\"take_profit\",0)}, Max hold: {cr.get(\"max_hold\",0)}')
        else:
            print(f'Error: {d.get(\"error\",\"unknown\")}')
        " || echo "Track response: $RESULT"

    - name: Refresh horizon picks cache
      continue-on-error: true
      run: |
        echo "=== Refreshing horizon picks ==="
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findstocks/portfolio2/api/horizon_picks.php?nocache=1") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            for h in d.get('horizons', []):
                bt = h.get('backtest', {})
                print(f'{h[\"name\"]}: {h.get(\"pick_count\",0)} picks, Win Rate={bt.get(\"win_rate\",0)}%')
        " || echo "Horizon picks: $RESULT"

    - name: Run comprehensive backtest and save
      continue-on-error: true
      run: |
        echo "=== Running all-algorithm backtest ==="
        # Momentum Ride (best performing strategy)
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findstocks/portfolio2/api/backtest.php?take_profit=50&stop_loss=10&max_hold_days=30&save=1") || true
        echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); s=d.get('summary',{}); print(f'Momentum Ride: Return={s.get(\"total_return_pct\",0):.2f}%, Win Rate={s.get(\"win_rate\",0)}%, Trades={s.get(\"total_trades\",0)}')" || echo "$RESULT"

    - name: Run strategy comparison
      continue-on-error: true
      run: |
        echo "=== Running all 10 strategy comparison ==="
        RESULT=$(curl -s --max-time 120 "https://findtorontoevents.ca/findstocks/portfolio2/api/whatif.php?compare=1") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print('Strategy Comparison Results:')
            for i, s in enumerate(d.get('scenarios', [])):
                sm = s.get('summary', {})
                print(f'  {i+1}. {s[\"name\"]}: Return={sm.get(\"total_return_pct\",0):.2f}%, Win Rate={sm.get(\"win_rate\",0)}%')
        " || echo "Comparison response: $RESULT"

    - name: Run algorithm comparison
      continue-on-error: true
      run: |
        echo "=== Comparing algorithms under Momentum Ride scenario ==="
        RESULT=$(curl -s --max-time 120 "https://findtorontoevents.ca/findstocks/portfolio2/api/whatif.php?compare_algos=1&scenario=momentum_ride") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print('Algorithm Comparison (Momentum Ride):')
            for a in d.get('algorithms', []):
                sm = a.get('summary', {})
                print(f'  {a[\"algorithm\"]}: Return={sm.get(\"total_return_pct\",0):.2f}%, Win Rate={sm.get(\"win_rate\",0)}%')
        " || echo "Algo comparison: $RESULT"

    - name: Update learning algorithm metrics
      continue-on-error: true
      run: |
        echo "=== Triggering learning algorithm parameter update ==="
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findstocks/portfolio2/api/learning.php?action=analyze_and_adjust") || true
        echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Learning update: ok={d.get(\"ok\")}, adjustments={d.get(\"adjustments_made\",0)}')" || echo "Learning response: $RESULT"

    - name: Print stocks summary
      continue-on-error: true
      run: |
        echo "=== Stocks Database Stats ==="
        RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/findstocks/portfolio2/api/data.php?type=stats") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        s = d.get('stats', {})
        print(f'Stocks: {s.get(\"total_stocks\",0)}')
        print(f'Picks: {s.get(\"total_picks\",0)}')
        print(f'Price Records: {s.get(\"total_price_records\",0)}')
        print(f'Backtests: {s.get(\"total_backtests\",0)}')
        print(f'Active Algos: {s.get(\"active_algorithms\",0)}')
        " || echo "Stats: $RESULT"

    # ─── Mutual Funds Refresh ───
    - name: Refresh mutual funds NAV data
      continue-on-error: true
      run: |
        echo "=== Refreshing Mutual Funds ==="
        curl -s --max-time 30 "https://findtorontoevents.ca/findmutualfunds2/portfolio2/api/import_picks.php?source=seed" > /dev/null 2>&1 || true
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findmutualfunds2/portfolio2/api/fetch_prices.php?force=1") || true
        echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'MF NAVs fetched: {d.get(\"fetched\",0)}')" || echo "MF: $RESULT"
        curl -s --max-time 60 "https://findtorontoevents.ca/findmutualfunds2/portfolio2/api/learning.php?action=analyze_and_adjust" > /dev/null 2>&1 || true

    # ─── Forex Refresh ───
    - name: Refresh forex price data
      continue-on-error: true
      run: |
        echo "=== Refreshing Forex ==="
        curl -s --max-time 30 "https://findtorontoevents.ca/findforex2/portfolio/api/import_picks.php?source=seed" > /dev/null 2>&1 || true
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findforex2/portfolio/api/fetch_prices.php?force=1") || true
        echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'FX prices fetched: {d.get(\"fetched\",0)}')" || echo "FX: $RESULT"
        curl -s --max-time 60 "https://findtorontoevents.ca/findforex2/portfolio/api/learning.php?action=analyze_and_adjust" > /dev/null 2>&1 || true

    # ─── Crypto Refresh ───
    - name: Refresh crypto price data
      continue-on-error: true
      run: |
        echo "=== Refreshing Crypto ==="
        curl -s --max-time 30 "https://findtorontoevents.ca/findcryptopairs/portfolio/api/import_picks.php?source=seed" > /dev/null 2>&1 || true
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/findcryptopairs/portfolio/api/fetch_prices.php?force=1") || true
        echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Crypto prices fetched: {d.get(\"fetched\",0)}')" || echo "CR: $RESULT"
        curl -s --max-time 60 "https://findtorontoevents.ca/findcryptopairs/portfolio/api/learning.php?action=analyze_and_adjust" > /dev/null 2>&1 || true

    # ─── Regenerate Top Picks & Verify Dashboards ───
    - name: Regenerate top picks cache
      continue-on-error: true
      run: |
        echo "=== Regenerating cross-asset top picks ==="
        RESULT=$(curl -s --max-time 30 "https://findtorontoevents.ca/findstocks/portfolio2/api/advanced_stats.php?action=top_picks") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        print(f'Stocks: {len(d.get(\"top_stocks\",[]))}, Day Trading: {len(d.get(\"day_trading\",[]))}')
        print(f'MF: {len(d.get(\"top_mutual_funds\",[]))}, FX: {len(d.get(\"top_forex\",[]))}, Crypto: {len(d.get(\"top_crypto\",[]))}')
        " || echo "Top picks: $RESULT"

    - name: Verify dashboard pages
      continue-on-error: true
      run: |
        echo "=== Verifying dashboard pages ==="
        for page in "findstocks/portfolio2/picks.html" "findstocks/portfolio2/leaderboard.html" "findstocks/portfolio2/horizon-picks.html" "findstocks/portfolio2/dashboard.html" "findstocks/portfolio2/dividends.html"; do
          STATUS=$(curl -sS -o /dev/null -w "%{http_code}" "https://findtorontoevents.ca/$page" 2>&1) || true
          echo "$page: HTTP $STATUS"
        done

    - name: Verify dividend and earnings data
      continue-on-error: true
      run: |
        echo "=== Verifying dividend/earnings data ==="
        RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/findstocks/portfolio2/api/fetch_dividends_earnings.php?action=get_fundamentals&ticker=AAPL") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            f = d.get('fundamentals', {})
            print(f'AAPL: div_yield={f.get(\"dividend_yield\",\"N/A\")}, eps={f.get(\"trailing_eps\",\"N/A\")}, pe={f.get(\"trailing_pe\",\"N/A\")}, rec={f.get(\"recommendation_key\",\"N/A\")}')
        else:
            print(f'Warning: {d.get(\"error\",\"unknown\")}')
        " || echo "Div/earn verify: $RESULT"

        RESULT2=$(curl -s --max-time 15 "https://findtorontoevents.ca/findstocks/portfolio2/api/fetch_dividends_earnings.php?action=upcoming") || true
        echo "$RESULT2" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        print(f'Upcoming dividends: {d.get(\"dividend_count\",0)}, Upcoming earnings: {d.get(\"earnings_count\",0)}')
        " || echo "Upcoming verify: $RESULT2"
