name: YouTube Provider Scraper

on:
  schedule:
    # Run daily at 3:00 AM UTC (10:00 PM EST)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of movies to process'
        required: false
        default: '200'
      offset:
        description: 'Offset for pagination'
        required: false
        default: '0'

jobs:
  scrape-youtube-providers:
    runs-on: ubuntu-latest
    steps:
      - name: Run YouTube provider scraper (via web)
        run: |
          LIMIT="${{ github.event.inputs.limit || '200' }}"
          OFFSET="${{ github.event.inputs.offset || '0' }}"

          echo "Triggering YouTube scraper on web server..."
          echo "Parameters: limit=$LIMIT offset=$OFFSET"

          RESPONSE=$(curl -sS --max-time 600 \
            "https://findtorontoevents.ca/MOVIESHOWS3/api/scrape-youtube-providers.php?limit=${LIMIT}&offset=${OFFSET}")

          echo "$RESPONSE"

          # Check for success
          if echo "$RESPONSE" | grep -q "SUMMARY:"; then
            echo "✅ Scraper completed successfully"
          else
            echo "::warning::Scraper may have encountered issues"
          fi

      - name: Summary
        run: |
          echo "✅ YouTube provider scraper job completed"
          echo ""
          echo "What was done:"
          echo "  - Scraped YouTube trailer titles and descriptions"
          echo "  - Detected streaming platform mentions"
          echo "  - Updated streaming_providers table"
          echo ""
          echo "Next scheduled run: Tomorrow at 3:00 AM UTC"
