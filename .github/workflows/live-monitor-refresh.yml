name: Live Trading Monitor — Auto Refresh

on:
  schedule:
    # Every 30 minutes — fetch prices, track positions, scan signals
    # Crypto & forex run 24/7; stocks only during market hours (handled server-side)
    - cron: '*/30 * * * *'
    # Weekly hour-learning analysis on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  live-refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    # ─── Step 1: Fetch real-time prices (all 36 assets) ───
    - name: Fetch live prices
      continue-on-error: true
      run: |
        echo "=== Fetching live prices (crypto + forex + stocks) ==="
        RESULT=$(curl -s --max-time 45 "https://findtorontoevents.ca/live-monitor/api/live_prices.php?action=fetch&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'Crypto: {d.get(\"crypto_fetched\",0)}/14')
            print(f'Forex:  {d.get(\"forex_fetched\",0)}/10')
            print(f'Stocks: {d.get(\"stock_fetched\",0)}/12 (market_open={d.get(\"market_open\",False)})')
            print(f'Total:  {d.get(\"total_updated\",0)} updated')
            errs = d.get('crypto_errors',[]) + d.get('forex_errors',[]) + d.get('stock_errors',[])
            if errs:
                for e in errs[:5]: print(f'  Error: {e}')
        else:
            print(f'Error: {d.get(\"error\",\"unknown\")}')
        " || echo "Price fetch: $RESULT"

    # ─── Step 2: Track open positions (check SL/TP/max-hold auto-close) ───
    - name: Track positions
      continue-on-error: true
      run: |
        echo "=== Tracking open positions ==="
        RESULT=$(curl -s --max-time 30 "https://findtorontoevents.ca/live-monitor/api/live_trade.php?action=track&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'Tracked: {d.get(\"tracked\",0)} positions')
            print(f'Auto-closed: {d.get(\"closed\",0)}')
            for c in d.get('closed_details', []):
                print(f'  {c.get(\"symbol\",\"?\")}: {c.get(\"exit_reason\",\"?\")} PnL={c.get(\"realized_pnl_usd\",0)}')
        else:
            print(f'Error: {d.get(\"error\",\"unknown\")}')
        " || echo "Track: $RESULT"

    # ─── Step 3: Scan for new signals ───
    - name: Scan signals
      continue-on-error: true
      run: |
        echo "=== Scanning for trading signals ==="
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/live-monitor/api/live_signals.php?action=scan&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'Symbols scanned: {d.get(\"symbols_scanned\",0)} (stocks: {d.get(\"stocks_scanned\",0)}, market_open={d.get(\"market_open\",False)})')
            print(f'Signals generated: {d.get(\"signals_generated\",0)}')
            for s in d.get('signals', []):
                print(f'  {s[\"symbol\"]:8s} {s[\"algorithm_name\"]:22s} {s[\"signal_type\"]:5s} strength={s[\"signal_strength\"]}')
        else:
            print(f'Error: {d.get(\"error\",\"unknown\")}')
        " || echo "Scan: $RESULT"

    # ─── Step 4: Expire old signals ───
    - name: Expire old signals
      continue-on-error: true
      run: |
        curl -s --max-time 10 "https://findtorontoevents.ca/live-monitor/api/live_signals.php?action=expire" > /dev/null 2>&1 || true

    # ─── Step 5: Check circuit breakers ───
    - name: Check circuit breakers
      continue-on-error: true
      run: |
        echo "=== Checking circuit breakers ==="
        RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/live-monitor/api/breaker_live.php?action=check&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            active = d.get('active_breakers', [])
            if active:
                print(f'ACTIVE BREAKERS: {len(active)}')
                for b in active:
                    print(f'  {b.get(\"rule\",\"?\")}: {b.get(\"reason\",\"?\")} (cooldown: {b.get(\"remaining_minutes\",0)}m)')
            else:
                print('No active circuit breakers - trading allowed')
        " || echo "Breakers: $RESULT"

    # ─── Step 6: Print portfolio summary ───
    - name: Portfolio summary
      continue-on-error: true
      run: |
        echo "=== Live Monitor Portfolio Summary ==="
        RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/live-monitor/api/live_trade.php?action=dashboard") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            pv = d.get('portfolio_value', 0)
            s = d.get('stats', {})
            snap = d.get('latest_snapshot', {})
            print(f'Portfolio Value: \${pv:,.2f}')
            print(f'Open Positions: {len(d.get(\"open_positions\",[]))}')
            print(f'Total Trades: {s.get(\"total_trades\",0)} (W:{s.get(\"wins\",0)} L:{s.get(\"losses\",0)} WR:{s.get(\"win_rate\",0)}%)')
            print(f'Cumulative PnL: \${s.get(\"total_pnl_usd\",0):,.2f}')
            print(f'Drawdown: {snap.get(\"drawdown_pct\",0)}%')
            for p in d.get('open_positions', []):
                print(f'  {p[\"symbol\"]:8s} {p[\"direction\"]:5s} entry={p[\"entry_price\"]} PnL={p[\"unrealized_pnl_usd\"]} ({p[\"unrealized_pct\"]}%)')
        " || echo "Dashboard: $RESULT"

  # ─── Weekly job: Hour Learning Analysis ───
  hour-learning:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Only run on the weekly schedule (Sunday 2 AM UTC)
    if: github.event.schedule == '0 2 * * 0' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Run hour-learning analysis
      continue-on-error: true
      run: |
        echo "=== Hour-Learning: Analyzing optimal TP/SL/Hold parameters ==="
        RESULT=$(curl -s --max-time 120 "https://findtorontoevents.ca/live-monitor/api/hour_learning.php?action=analyze&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'Algorithms analyzed: {d.get(\"analyzed\",0)}')
            for r in d.get('results', []):
                print(f'  {r.get(\"algorithm\",\"?\"):22s} Best: TP={r.get(\"best_tp\",0)}% SL={r.get(\"best_sl\",0)}% Hold={r.get(\"best_hold\",0)}h WR={r.get(\"win_rate\",0)}%')
        else:
            print(f'Learning: {d.get(\"error\",\"not enough trades yet\")}')
        " || echo "Learning: $RESULT"

    - name: Apply learned parameters
      continue-on-error: true
      run: |
        echo "=== Applying learned parameters to signal defaults ==="
        RESULT=$(curl -s --max-time 30 "https://findtorontoevents.ca/live-monitor/api/hour_learning.php?action=apply&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'Applied: {d.get(\"applied\",0)} algorithm updates')
        else:
            print(f'Apply: {d.get(\"error\",\"nothing to apply\")}')
        " || echo "Apply: $RESULT"

    - name: Winning patterns analysis
      continue-on-error: true
      run: |
        echo "=== Analyzing winning trade patterns ==="
        RESULT=$(curl -s --max-time 30 "https://findtorontoevents.ca/live-monitor/api/winning_patterns.php?action=full_report&days=30") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            ov = d.get('overview', {})
            print(f'Trades: {ov.get(\"total_trades\",0)} | Win Rate: {ov.get(\"win_rate\",0)}% | PnL: \${ov.get(\"total_pnl\",0):.2f}')
            for insight in d.get('insights', []):
                print(f'  > {insight}')
        " || echo "Patterns: $RESULT"
