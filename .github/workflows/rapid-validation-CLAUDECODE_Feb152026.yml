# Rapid Validation Engine - Auto-run every 15 minutes
# CLAUDECODE_Feb152026
name: Rapid Validation Engine

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  rapid-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy API to server
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
        run: |
          echo "=== Deploying Rapid Validation API to Server ==="
          # Upload dashboard
          curl -T rapid_validation/dashboard_CLAUDECODE_Feb152026.html \
            "ftp://$FTP_SERVER/findtorontoevents.ca/rapid_validation/" \
            --user "$FTP_USER:$FTP_PASS" \
            --ftp-create-dirs --insecure || true
          # Upload API files
          for file in rapid_validation/api/*.php; do
            filename=$(basename "$file")
            curl -T "$file" "ftp://$FTP_SERVER/findtorontoevents.ca/rapid_validation/api/$filename" \
              --user "$FTP_USER:$FTP_PASS" --ftp-create-dirs --insecure || true
          done
          # Upload Python scripts
          for file in rapid_validation/*.py; do
            filename=$(basename "$file")
            curl -T "$file" "ftp://$FTP_SERVER/findtorontoevents.ca/rapid_validation/$filename" \
              --user "$FTP_USER:$FTP_PASS" --insecure || true
          done
          echo "âœ… Deployment attempted"

      - name: Check system status
        id: status
        run: |
          echo "=== Checking Rapid Validation Status ==="
          RESP=$(curl -s -m 30 "https://findtorontoevents.ca/rapid_validation/api/rapid_signal_engine.php?action=status")
          echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          init = d.get('initialized', False)
          last = d.get('last_updated', 'Never')
          ranks = d.get('rankings', {})
          print(f'Initialized: {init}')
          print(f'Last updated: {last}')
          if ranks:
              print(f'Promoted: {ranks.get(\"promoted\", 0)}')
              print(f'Testing: {ranks.get(\"testing\", 0)}')
              print(f'Eliminated: {ranks.get(\"eliminated\", 0)}')
          " 2>/dev/null || echo "$RESP"

      - name: Run validation cycle
        id: cycle
        run: |
          echo "=== Running Validation + Ranking Cycle ==="
          RESP=$(curl -s -m 120 "https://findtorontoevents.ca/rapid_validation/api/rapid_signal_engine.php?action=cycle&key=livetrader2026")
          echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          ok = d.get('ok', False)
          results = d.get('results', {})
          ranks = d.get('rankings', {})

          print(f'Overall: {\"SUCCESS\" if ok else \"FAILED\"}')
          print()

          # Validation results
          val = results.get('validate', {})
          print(f'Validation: {\"OK\" if val.get(\"ok\") else \"FAILED\"}')
          if val.get('output'):
              print(val['output'][:500])

          print()

          # Ranking results
          rank = results.get('rank', {})
          print(f'Ranking: {\"OK\" if rank.get(\"ok\") else \"FAILED\"}')
          if rank.get('output'):
              print(rank['output'][:500])

          print()

          # Rankings summary
          if ranks:
              print(f'Final Rankings:')
              print(f'  Promoted: {ranks.get(\"promoted\", 0)}')
              print(f'  Testing: {ranks.get(\"testing\", 0)}')
              print(f'  Eliminated: {ranks.get(\"eliminated\", 0)}')

          sys.exit(0 if ok else 1)
          " 2>/dev/null || echo "$RESP"

      - name: Summary report
        if: always()
        run: |
          echo "========================================"
          echo "Rapid Validation Engine - Run Complete"
          echo "========================================"
          echo "Timestamp: $(date -u)"
          echo "Dashboard: https://findtorontoevents.ca/rapid_validation/dashboard_CLAUDECODE_Feb152026.html"
          echo "API Status: https://findtorontoevents.ca/rapid_validation/api/rapid_signal_engine.php?action=status"
