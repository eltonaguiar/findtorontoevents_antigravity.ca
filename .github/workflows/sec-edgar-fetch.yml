name: SEC EDGAR — Insider Trades & 13F Holdings

on:
  schedule:
    # Daily at 8 AM EST (13:00 UTC) for Form 4 insider trades (weekdays)
    - cron: '0 13 * * 1-5'
    # Weekly Sunday 1 AM EST (06:00 UTC) for 13F filings
    - cron: '0 6 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sec-fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    # ─── Step 1: Ensure schema ───
    - name: Ensure schema
      run: |
        curl -s --max-time 15 "https://findtorontoevents.ca/live-monitor/api/goldmine_tracker.php?action=schema" > /dev/null 2>&1
        echo "Schema ensured"

    # ─── Step 2: Fetch Form 4 insider trades (batch 1-3) ───
    - name: Fetch Form 4 insider trades — Batch 1
      run: |
        echo "=== SEC EDGAR Form 4 — Batch 1 (tickers 1-5) ==="
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/live-monitor/api/sec_edgar.php?action=fetch_form4&key=livetrader2026&batch=0") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'  Tickers processed: {d.get(\"tickers_processed\", 0)}')
            print(f'  Filings parsed: {d.get(\"filings_parsed\", 0)}')
            print(f'  Trades inserted: {d.get(\"trades_inserted\", 0)}')
        else:
            print(f'Error: {d.get(\"error\",\"unknown\")}')
        " || echo "Form4 B1: $RESULT"

    - name: Fetch Form 4 insider trades — Batch 2
      run: |
        echo "=== SEC EDGAR Form 4 — Batch 2 (tickers 6-10) ==="
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/live-monitor/api/sec_edgar.php?action=fetch_form4&key=livetrader2026&batch=1") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'  Tickers: {d.get(\"tickers_processed\", 0)}, Trades: {d.get(\"trades_inserted\", 0)}')
        else:
            print(f'Error: {d.get(\"error\",\"unknown\")}')
        " || echo "Form4 B2: $RESULT"

    - name: Fetch Form 4 insider trades — Batch 3
      run: |
        echo "=== SEC EDGAR Form 4 — Batch 3 (tickers 11-15) ==="
        RESULT=$(curl -s --max-time 60 "https://findtorontoevents.ca/live-monitor/api/sec_edgar.php?action=fetch_form4&key=livetrader2026&batch=2") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'  Tickers: {d.get(\"tickers_processed\", 0)}, Trades: {d.get(\"trades_inserted\", 0)}')
        else:
            print(f'Error: {d.get(\"error\",\"unknown\")}')
        " || echo "Form4 B3: $RESULT"

    # ─── Step 3: Detect insider clusters ───
    - name: Detect insider clusters
      continue-on-error: true
      run: |
        echo "=== Insider Clusters ==="
        RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/live-monitor/api/sec_edgar.php?action=insider_clusters") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            clusters = d.get('clusters', [])
            print(f'  Cluster alerts: {len(clusters)}')
            for c in clusters:
                print(f'    {c[\"ticker\"]}: {c[\"insiders\"]} insiders bought \${c.get(\"total_bought\",0):,.0f}')
        " || echo "Clusters: $RESULT"

    # ─── Step 4: Fetch 13F filings (weekly only) ───
    - name: Fetch 13F filings (weekly)
      if: github.event.schedule == '0 6 * * 0' || github.event_name == 'workflow_dispatch'
      continue-on-error: true
      run: |
        echo "=== SEC EDGAR 13F Filings ==="
        RESULT=$(curl -s --max-time 120 "https://findtorontoevents.ca/live-monitor/api/sec_edgar.php?action=fetch_13f&key=livetrader2026") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            print(f'  Funds processed: {d.get(\"funds_processed\", 0)}')
            print(f'  Holdings inserted: {d.get(\"holdings_inserted\", 0)}')
        else:
            print(f'Error: {d.get(\"error\",\"unknown\")}')
        " || echo "13F: $RESULT"

    # ─── Step 5: Conviction picks check ───
    - name: Check conviction picks (multi-fund overlap)
      continue-on-error: true
      run: |
        echo "=== Conviction Picks ==="
        RESULT=$(curl -s --max-time 15 "https://findtorontoevents.ca/live-monitor/api/sec_edgar.php?action=conviction_picks") || true
        echo "$RESULT" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if d.get('ok'):
            picks = d.get('picks', [])
            print(f'  Multi-fund overlap stocks: {len(picks)}')
            for p in picks[:5]:
                print(f'    {p[\"ticker\"]}: {p[\"fund_count\"]} funds, sentiment={p.get(\"sentiment\",\"?\")}')
        " || echo "Conviction: $RESULT"
