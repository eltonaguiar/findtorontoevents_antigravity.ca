name: Meta-Label v2 Training

on:
  schedule:
    # Weekly Sunday training at 3:30 PM UTC (10:30 AM EST)
    - cron: '30 15 * * 0'
    # Wednesday mid-week retrain
    - cron: '30 20 * * 3'
  workflow_dispatch:

jobs:
  meta-label-v2:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --quiet \
            xgboost>=2.0 \
            scikit-learn>=1.3 \
            pandas>=2.0 \
            numpy>=1.24 \
            requests>=2.31 \
            mysql-connector-python>=8.0

      - name: Train Meta-Label v2
        env:
          SM_API_BASE: ${{ secrets.SM_API_BASE || 'https://findtorontoevents.ca/live-monitor/api' }}
          SM_ADMIN_KEY: ${{ secrets.SM_ADMIN_KEY || 'livetrader2026' }}
          DB_HOST: ${{ secrets.DB_HOST || 'mysql.50webs.com' }}
          DB_USER: ${{ secrets.DB_USER || 'ejaguiar1_stocks' }}
          DB_PASS: ${{ secrets.DB_PASS || 'stocks' }}
          DB_NAME: ${{ secrets.DB_NAME || 'ejaguiar1_stocks' }}
        run: |
          echo "=========================================="
          echo "META-LABEL v2 TRAINING â€” $(date -u '+%Y-%m-%d %H:%M UTC')"
          echo "=========================================="
          python scripts/meta_label_v2.py

      - name: Upload model report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: meta-label-v2-report
          path: data/meta_label_v2_report.json
          retention-days: 30
