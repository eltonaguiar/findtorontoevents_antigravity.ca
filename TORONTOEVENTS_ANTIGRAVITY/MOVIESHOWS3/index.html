<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieShows - Discover Movies & TV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        /* Hamburger Menu */
        .hamburger-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hamburger-btn:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 24px;
        }

        .hamburger-icon span {
            width: 100%;
            height: 2px;
            background: white;
            border-radius: 2px;
        }

        .menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 250;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .menu-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .menu-panel {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 300px;
            max-width: 90vw;
            background: rgba(24, 24, 24, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 251;
            transform: translateX(-100%);
            transition: transform 0.3s;
        }

        .menu-panel.active {
            transform: translateX(0);
        }

        .menu-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: linear-gradient(to right, rgba(245, 158, 11, 0.5), transparent);
        }

        .menu-header h2 {
            font-size: 20px;
            font-weight: 900;
        }

        .menu-header h2 span {
            color: #f59e0b;
        }

        .menu-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .menu-content {
            padding: 16px;
        }

        .menu-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            text-decoration: none;
            color: white;
            margin-bottom: 4px;
        }

        .menu-link:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .menu-link.active {
            background: rgba(245, 158, 11, 0.2);
        }

        /* Top Controls */
        .top-controls {
            position: fixed;
            top: 16px;
            left: 80px;
            right: 16px;
            z-index: 50;
            display: flex;
            gap: 12px;
        }

        .control-btn {
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .control-btn:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .filter-group {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 4px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 4px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            color: white;
        }

        .filter-btn.active {
            background: white;
            color: black;
        }

        /* Browse/Catalog View */
        .browse-view {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            overflow-y: auto;
            padding: 80px 20px 20px;
        }

        .browse-close {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 101;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .browse-close:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .browse-view.active {
            opacity: 1;
            pointer-events: auto;
        }

        .browse-header {
            max-width: 1400px;
            margin: 0 auto 30px;
        }

        .browse-header h1 {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 10px;
        }

        .browse-search-bar {
            margin: 20px 0;
            position: relative;
        }

        .browse-search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.2s;
        }

        .browse-search-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f59e0b;
        }

        .browse-search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .browse-search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s;
        }

        .browse-search-clear.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .browse-search-clear:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .browse-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-section {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 700;
            opacity: 0.7;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .filter-chip.active {
            background: #f59e0b;
            border-color: #f59e0b;
            color: black;
        }

        .year-range-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .year-input {
            width: 80px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            text-align: center;
            outline: none;
        }

        .year-input:focus {
            border-color: #f59e0b;
        }

        .browse-results-count {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 16px;
        }

        .browse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .movie-card {
            cursor: pointer;
            transition: transform 0.2s;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .movie-card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }

        .movie-card-add-queue {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .movie-card-add-queue:hover {
            background: rgba(0, 0, 0, 0.95);
            transform: scale(1.1);
        }

        .movie-card:hover {
            transform: scale(1.05);
        }

        .movie-card img {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
        }

        .movie-card-info {
            padding: 12px;
        }

        .movie-card-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .movie-card-meta {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Queue Panel */
        .queue-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 250;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .queue-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .queue-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 400px;
            max-width: 90vw;
            background: rgba(24, 24, 24, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 251;
            transform: translateX(100%);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        .queue-panel.active {
            transform: translateX(0);
        }

        .queue-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .queue-header h2 {
            font-size: 20px;
            font-weight: 900;
        }

        .queue-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .queue-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .queue-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.02);
        }

        .queue-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .queue-item img {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
        }

        .queue-item-info {
            flex: 1;
        }

        .queue-item-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .queue-item-meta {
            font-size: 12px;
            opacity: 0.7;
        }

        .queue-item-remove {
            background: rgba(255, 0, 0, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Sidebar Actions */
        .sidebar-actions {
            position: fixed;
            right: 16px;
            bottom: 100px;
            z-index: 15;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            padding: 12px;
            cursor: pointer;
            color: white;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: none;
        }

        .action-btn:hover {
            background: rgba(0, 0, 0, 0.6);
            transform: scale(1.1);
        }

        /* Alt trailer button */
        .action-btn.alt-trailer-btn {
            position: relative;
            font-size: 18px;
        }
        .action-btn.alt-trailer-btn .alt-count {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #f59e0b;
            color: #000;
            font-size: 10px;
            font-weight: 800;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .action-btn.alt-trailer-btn.hidden-btn {
            display: none;
        }

        /* Alt trailer dropdown */
        .alt-trailer-dropdown {
            position: fixed;
            right: 80px;
            bottom: 200px;
            z-index: 20;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 8px;
            min-width: 260px;
            max-width: 320px;
            max-height: 350px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }
        .alt-trailer-dropdown.active {
            display: block;
        }
        .alt-trailer-dropdown-title {
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.4);
        }
        .alt-trailer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .alt-trailer-item:hover {
            background: rgba(255,255,255,0.08);
        }
        .alt-trailer-item.active-trailer {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .alt-trailer-item-thumb {
            width: 64px;
            height: 36px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
            background: #222;
        }
        .alt-trailer-item-info {
            flex: 1;
            min-width: 0;
        }
        .alt-trailer-item-name {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .alt-trailer-item-type {
            font-size: 10px;
            color: rgba(255,255,255,0.4);
        }
        .alt-trailer-item-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 700;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        .alt-type-trailer { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .alt-type-teaser { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .alt-type-clip { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .alt-type-other { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }

        /* Alt description link */
        .alt-desc-link {
            display: inline-block;
            font-size: 11px;
            color: #f59e0b;
            cursor: pointer;
            margin-left: 6px;
            opacity: 0.7;
            transition: opacity 0.2s;
            white-space: nowrap;
            vertical-align: middle;
        }
        .alt-desc-link:hover {
            opacity: 1;
            text-decoration: underline;
        }
        .alt-desc-loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(245, 158, 11, 0.2);
            border-top-color: #f59e0b;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-left: 6px;
        }

        #container {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
        }

        #container::-webkit-scrollbar {
            display: none;
        }

        .video-card {
            height: 100vh;
            width: 100%;
            position: relative;
            scroll-snap-align: start;
            background: #000;
        }

        .video-wrapper {
            position: absolute;
            inset: 0;
        }

        .video-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 100px;
            padding: 20px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            z-index: 10;
        }

        .movie-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .movie-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .meta-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .movie-description {
            font-size: 14px;
            line-height: 1.4;
            opacity: 0.9;
        }

        .genre-tags {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .genre-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .loading,
        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        /* Play Overlay */
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 25;
            cursor: pointer;
            transition: opacity 0.3s;
            opacity: 0;
            pointer-events: none;
        }

        .play-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .play-button {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            transition: transform 0.2s;
            color: #000;
        }

        .play-button:hover {
            transform: scale(1.1);
        }

        /* Unmute Button */
        .unmute-btn {
            position: absolute;
            bottom: 80px;
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .unmute-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .unmute-btn:active {
            transform: scale(0.95);
        }

        /* Login Modal */
        .login-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
        }

        .login-overlay.active {
            display: block;
        }

        .login-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            z-index: 1001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .login-modal.active {
            display: block;
        }

        .login-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .login-close:hover {
            opacity: 1;
        }

        /* User Profile Avatar */
        .user-avatar-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .user-avatar-btn:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.6);
        }
        .user-dropdown {
            position: fixed;
            top: 68px;
            right: 20px;
            z-index: 101;
            background: rgba(24, 24, 24, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 12px;
            min-width: 160px;
            display: none;
            color: white;
        }
        .user-dropdown.active { display: block; }
        .user-dropdown-name {
            font-size: 13px;
            font-weight: 700;
            padding: 4px 8px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
        }
        .user-dropdown-item {
            display: block;
            width: 100%;
            padding: 8px;
            background: none;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s;
        }
        .user-dropdown-item:hover { background: rgba(255, 255, 255, 0.1); }

        /* Mute Overlay Modal */
        .mute-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid #ff4444;
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -45%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .mute-overlay.hidden {
            display: none;
        }

        .mute-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .mute-heading {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 24px;
        }

        .enable-sound-btn {
            background: linear-gradient(135deg, #ff4444 0%, #ff6b6b 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 16px;
            text-transform: uppercase;
            box-shadow: 0 4px 20px rgba(255, 68, 68, 0.4);
        }

        .enable-sound-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(255, 68, 68, 0.6);
        }

        .enable-sound-btn:active {
            transform: translateY(0);
        }

        .keyboard-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .keyboard-hint kbd {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 2px 8px;
            font-family: monospace;
            font-weight: 600;
            color: white;
        }

        /* Persistent Bottom-Left Unmute Button */
        .persistent-unmute-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 50;
            background: #ff4444;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(255, 68, 68, 0.4);
        }

        .persistent-unmute-btn:hover {
            background: #ff6b6b;
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(255, 68, 68, 0.6);
        }

        .persistent-unmute-btn:active {
            transform: translateY(0);
        }

        .persistent-unmute-btn.hidden {
            display: none;
        }

        /* Menu Divider */
        .menu-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            margin: 20px 0;
        }

        /* Menu Settings */
        .menu-settings {
            padding: 10px 0;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .setting-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .setting-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: #fff;
        }

        .setting-icon {
            font-size: 20px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: 0.4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: #ff4444;
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        /* Delay Slider */
        .delay-slider {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            margin-top: 10px;
            -webkit-appearance: none;
            appearance: none;
        }

        .delay-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff4444;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(255, 68, 68, 0.5);
        }

        .delay-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff4444;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(255, 68, 68, 0.5);
        }

        /* Now Playing Badge */
        .now-playing-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: nowPlayingPulse 2s ease-in-out infinite;
        }

        @keyframes nowPlayingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Motivational Video Styles */
        .motivation-badge {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .motivation-channel-badge {
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
            color: #c4b5fd;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .filter-btn.motivation-filter {
            color: #c4b5fd;
        }
        .filter-btn.motivation-filter.active {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        /* Settings section subtitle */
        .settings-subtitle {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.4);
            padding: 16px 20px 8px;
        }

        .setting-item-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 2px;
        }

        /* Browse section headers */
        .browse-section-header {
            max-width: 1400px;
            margin: 0 auto 16px;
            padding: 16px 0 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .browse-section-header h2 {
            font-size: 22px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Coming Soon Badge */
        .coming-soon-badge {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .coming-soon-date-badge {
            background: rgba(14, 165, 233, 0.25);
            border: 1px solid rgba(14, 165, 233, 0.5);
            color: #7dd3fc;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .coming-soon-venue-badge {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Streaming Service Filter Row */
        .streaming-filter-row {
            position: fixed;
            top: 72px;
            left: 80px;
            right: 16px;
            z-index: 49;
            display: none;
            gap: 6px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 4px 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .streaming-filter-row::-webkit-scrollbar { display: none; }
        .streaming-filter-row.visible { display: flex; }

        .streaming-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .streaming-pill:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
        }
        .streaming-pill.active {
            color: white;
            border-color: transparent;
        }
        .streaming-pill img {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }
        .streaming-pill.netflix.active { background: #e50914; }
        .streaming-pill.prime.active { background: #00a8e1; }
        .streaming-pill.disney.active { background: #113ccf; }
        .streaming-pill.hulu.active { background: #1ce783; color: black; }
        .streaming-pill.apple.active { background: #555; }
        .streaming-pill.hbo.active { background: #b835f5; }
        .streaming-pill.paramount.active { background: #0064ff; }
        .streaming-pill.peacock.active { background: #000; border-color: #ffd700; }
        .streaming-pill.crave.active { background: #0033a1; }
        .streaming-pill.tubi.active { background: #fa382f; }
        .streaming-pill .provider-count {
            background: rgba(255,255,255,0.2);
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
        }

        /* Provider badges on movie cards */
        .provider-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        .provider-badge {
            width: 22px;
            height: 22px;
            border-radius: 5px;
            object-fit: cover;
        }

        /* Lazy loading placeholder */
        .video-placeholder {
            width: 100%;
            height: 100%;
            background: #0a0a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .video-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.4;
        }
        .video-placeholder .play-icon {
            position: absolute;
            font-size: 60px;
            opacity: 0.7;
            animation: pulse-play 2s infinite;
        }
        @keyframes pulse-play {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        .video-placeholder .loading-spinner {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .filter-btn.coming-soon-filter {
            color: #7dd3fc;
        }
        .filter-btn.coming-soon-filter.active {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }

        /* Freestyle (experimental) */
        .filter-btn.freestyle-filter {
            color: #fbbf24;
            position: relative;
        }
        .filter-btn.freestyle-filter.active {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .freestyle-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .freestyle-experimental-tag {
            display: inline-block;
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.4);
            color: #fbbf24;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: experimentalPulse 3s ease-in-out infinite;
        }
        @keyframes experimentalPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .freestyle-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 300;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }
        .freestyle-overlay.active {
            display: flex;
        }
        .freestyle-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            position: sticky;
            top: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            z-index: 10;
        }
        .freestyle-header h2 {
            font-size: 22px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }
        .freestyle-header p {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 12px;
        }
        .freestyle-search-row {
            display: flex;
            gap: 8px;
        }
        .freestyle-search-input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            color: white;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }
        .freestyle-search-input:focus {
            border-color: #f59e0b;
        }
        .freestyle-search-input::placeholder {
            color: rgba(255,255,255,0.3);
        }
        .freestyle-search-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: transform 0.1s;
        }
        .freestyle-search-btn:active {
            transform: scale(0.96);
        }
        .freestyle-close {
            position: absolute;
            top: 16px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .freestyle-results {
            padding: 20px 24px;
            flex: 1;
        }
        .freestyle-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        .freestyle-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        .freestyle-card:hover {
            border-color: rgba(245, 158, 11, 0.4);
            transform: translateY(-2px);
        }
        .freestyle-card-thumb {
            position: relative;
            aspect-ratio: 16/9;
            background: #111;
            overflow: hidden;
        }
        .freestyle-card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .freestyle-card-play {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .freestyle-card:hover .freestyle-card-play {
            opacity: 1;
        }
        .freestyle-card-play span {
            font-size: 40px;
        }
        .freestyle-card-body {
            padding: 12px 14px;
        }
        .freestyle-card-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .freestyle-card-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 6px;
        }
        .freestyle-card-desc {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }
        .freestyle-no-trailer {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            font-weight: 600;
        }
        .freestyle-loading {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.4);
        }
        .freestyle-loading .spinner-ring {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid rgba(245, 158, 11, 0.2);
            border-top-color: #f59e0b;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .freestyle-empty {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.3);
        }
        .freestyle-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        /* Freestyle card actions */
        .freestyle-card-actions {
            display: flex;
            gap: 6px;
            padding: 8px 14px 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .freestyle-action-btn {
            flex: 1;
            padding: 8px 0;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .freestyle-action-btn:hover {
            background: rgba(255,255,255,0.12);
        }
        .freestyle-action-btn.play-btn {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }
        .freestyle-action-btn.play-btn:hover {
            background: rgba(245, 158, 11, 0.25);
        }
        .freestyle-action-btn.queue-btn {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.25);
            color: #4ade80;
        }
        .freestyle-action-btn.queue-btn:hover {
            background: rgba(34, 197, 94, 0.2);
        }
        .freestyle-action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        /* YouTube result badge */
        .yt-badge {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .freestyle-yt-channel {
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 4px;
        }
        @media (max-width: 600px) {
            .freestyle-results-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Coming soon card in browse */
        .coming-soon-card-date {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(14, 165, 233, 0.85);
            backdrop-filter: blur(8px);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
        }

        .coming-soon-card-venue {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            color: #7dd3fc;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Motivational card overlay */
        .motivation-card-channel {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(139, 92, 246, 0.8);
            backdrop-filter: blur(8px);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .motivation-duration-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
        }
    </style>
</head>

<body>
    <!-- Quest 3 / VR Headset Detection Banner -->
    <div id="questBanner" style="display:none; position:fixed; top:0; left:0; right:0; z-index:9999;
        background:linear-gradient(135deg, #7c3aed, #4f46e5); padding:14px 20px; text-align:center;
        font-size:14px; font-weight:700; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
        <span>VR headset detected! For the best experience, try </span>
        <a href="/MOVIESHOWS3_QUEST/" style="color:#fbbf24; text-decoration:underline; font-weight:900;">Quest Edition</a>
        <span> - lighter, faster, no freezing.</span>
        <button onclick="this.parentElement.style.display='none'; localStorage.setItem('ms3_dismissQuest','1');"
            style="margin-left:16px; background:rgba(0,0,0,0.3); border:none; color:white; padding:4px 12px;
            border-radius:6px; cursor:pointer; font-size:12px;">Dismiss</button>
    </div>

    <!-- Mute Overlay Modal -->
    <div class="mute-overlay hidden" id="muteOverlay">
        <div class="mute-icon"></div>
        <div class="mute-heading">Audio is Muted</div>
        <button class="enable-sound-btn" onclick="enableSound()">
             TAP TO ENABLE SOUND
        </button>
        <div class="keyboard-hint">or press <kbd>M</kbd> key</div>
    </div>

    <!-- Persistent Bottom-Left Unmute Button -->
    <button class="persistent-unmute-btn hidden" id="persistentUnmuteBtn" onclick="enableSound()">
         Click to Unmute
    </button>

    <!-- Hamburger Menu -->
    <button class="hamburger-btn" onclick="toggleMenu()">
        <div class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>

    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="menu-panel" id="menuPanel">
        <div class="menu-header">
            <h2><span>Movie</span>Shows</h2>
            <button class="menu-close" onclick="toggleMenu()"></button>
        </div>
        <div class="menu-content">
            <a href="https://findtorontoevents.ca/" class="menu-link">
                <span></span> Toronto Events
            </a>
            <a href="/MOVIESHOWS3/" class="menu-link active">
                <span></span> Movies & TV
            </a>
            <a href="https://findtorontoevents.ca/FAVCREATORS_TRACKER/" class="menu-link">
                <span></span> FavCreators
            </a>
            <a href="/MOVIESHOWS3/admin.html" class="menu-link">
                <span></span> Admin
            </a>

            <div class="menu-divider"></div>

            <div class="menu-settings">
                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon"></span>
                        <span>Auto-Scroll</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoScrollToggle" onchange="toggleAutoScroll()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-item" id="autoScrollDelayContainer" style="display: none;">
                    <div class="setting-label">
                        <span class="setting-icon"></span>
                        <span>Delay: <span id="delayValue">10</span>s</span>
                    </div>
                    <input type="range" id="autoScrollDelay" min="5" max="30" value="10" step="1"
                        oninput="updateAutoScrollDelay(this.value)" class="delay-slider">
                </div>

                <div class="settings-subtitle">Motivational Videos</div>

                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon"></span>
                        <div>
                            <span>Show in "All" Feed</span>
                            <div class="setting-item-desc">Include motivation videos in the All tab</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="motivationInAllToggle" onchange="toggleMotivationInAll()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon"></span>
                        <div>
                            <span>Long-Form Videos</span>
                            <div class="setting-item-desc">Enable longer motivational videos (5+ min)</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="motivationLongFormToggle" onchange="toggleMotivationLongForm()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-subtitle">Watch History</div>

                <div class="setting-item">
                    <div class="setting-label">
                        <span class="setting-icon"></span>
                        <div>
                            <span>Skip Watched Trailers</span>
                            <div class="setting-item-desc">Auto-skip trailers you already watched</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="skipWatchedToggle" onchange="toggleSkipWatched()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Controls -->
    <div class="top-controls">
        <button class="control-btn" onclick="toggleBrowse()" title="Browse All">
            
        </button>
        <button class="control-btn" onclick="toggleQueue()" title="My Queue">
            
        </button>
        <button class="control-btn" onclick="toggleStreamingFilter()" title="Filter by Streaming Service" id="streamingToggleBtn">
            
        </button>
        <div class="filter-group">
            <button class="filter-btn active" onclick="filterContent('all')" id="filterAll">All (<span
                    id="countAll">0</span>)</button>
            <button class="filter-btn" onclick="filterContent('now-playing')" id="filterNowPlaying">Now Playing (<span id="countNowPlaying">0</span>)</button>
            <button class="filter-btn" onclick="filterContent('movie')" id="filterMovies">Movies (<span
                    id="countMovies">0</span>)</button>
            <button class="filter-btn" onclick="filterContent('tv')" id="filterTV">TV (<span
                    id="countTV">0</span>)</button>
            <button class="filter-btn coming-soon-filter" onclick="filterContent('coming-soon')" id="filterComingSoon">Coming Soon (<span
                    id="countComingSoon">0</span>)</button>
            <button class="filter-btn motivation-filter" onclick="filterContent('motivation')" id="filterMotivation">Motivation (<span
                    id="countMotivation">0</span>)</button>
            <button class="filter-btn freestyle-filter" onclick="openFreestyle()" id="filterFreestyle">Freestyle <span class="freestyle-experimental-tag">Beta</span></button>
        </div>
    </div>

    <!-- Streaming Service Filter Row -->
    <div class="streaming-filter-row" id="streamingFilterRow">
        <button class="streaming-pill" data-provider="all" onclick="filterByProvider('all')">All</button>
        <button class="streaming-pill netflix" data-provider="8" onclick="filterByProvider('8')">Netflix</button>
        <button class="streaming-pill prime" data-provider="9" onclick="filterByProvider('9')">Prime Video</button>
        <button class="streaming-pill disney" data-provider="337" onclick="filterByProvider('337')">Disney+</button>
        <button class="streaming-pill hulu" data-provider="15" onclick="filterByProvider('15')">Hulu</button>
        <button class="streaming-pill apple" data-provider="350" onclick="filterByProvider('350')">Apple TV+</button>
        <button class="streaming-pill hbo" data-provider="1899" onclick="filterByProvider('1899')">Max</button>
        <button class="streaming-pill paramount" data-provider="531" onclick="filterByProvider('531')">Paramount+</button>
        <button class="streaming-pill peacock" data-provider="386" onclick="filterByProvider('386')">Peacock</button>
        <button class="streaming-pill crave" data-provider="230" onclick="filterByProvider('230')">Crave</button>
        <button class="streaming-pill tubi" data-provider="73" onclick="filterByProvider('73')">Tubi</button>
    </div>

    <!-- Browse/Catalog View -->
    <div class="browse-view" id="browseView">
        <button class="browse-close" onclick="toggleBrowse()"></button>
        <div class="browse-header">
            <h1>Browse All Movies & TV Shows</h1>
            <p style="opacity: 0.7;">Search by name, filter by genre, year, or content type</p>

            <!-- Search Bar -->
            <div class="browse-search-bar">
                <input type="text" id="browseSearchInput" class="browse-search-input" placeholder="Search by title..."
                    oninput="applyBrowseFilters()">
                <button class="browse-search-clear" id="browseSearchClear" onclick="clearSearch()"></button>
            </div>

            <!-- Filters -->
            <div class="browse-filters">
                <!-- Content Type Filter -->
                <div class="filter-section">
                    <div class="filter-label">Content Type</div>
                    <div class="filter-buttons">
                        <button class="filter-chip active" data-type="all"
                            onclick="setContentTypeFilter('all')">All</button>
                        <button class="filter-chip" data-type="now-playing"
                            onclick="setContentTypeFilter('now-playing')">Now Playing</button>
                        <button class="filter-chip" data-type="movie"
                            onclick="setContentTypeFilter('movie')">Movies</button>
                        <button class="filter-chip" data-type="tv" onclick="setContentTypeFilter('tv')">TV
                            Series</button>
                        <button class="filter-chip" data-type="coming-soon"
                            onclick="setContentTypeFilter('coming-soon')" style="border-color: rgba(14, 165, 233, 0.5); color: #7dd3fc;">Coming Soon</button>
                        <button class="filter-chip" data-type="motivation"
                            onclick="setContentTypeFilter('motivation')" style="border-color: rgba(139, 92, 246, 0.5); color: #c4b5fd;">Motivation</button>
                        <button class="filter-chip" data-type="out-this-week"
                            onclick="setContentTypeFilter('out-this-week')">Out This Week</button>
                        <button class="filter-chip" data-type="freestyle"
                            onclick="openFreestyle()" style="border-color: rgba(245, 158, 11, 0.5); color: #fbbf24;">Freestyle <span class="freestyle-experimental-tag">Beta</span></button>
                    </div>
                </div>

                <!-- Streaming Service Filter -->
                <div class="filter-section" style="flex-basis: 100%;">
                    <div class="filter-label">Streaming Service</div>
                    <div class="filter-buttons" id="browseStreamingFilters">
                        <button class="filter-chip active" data-provider="all" onclick="setBrowseProviderFilter('all')">All</button>
                        <button class="filter-chip" data-provider="8" onclick="setBrowseProviderFilter('8')" style="border-color: rgba(229,9,20,0.5); color: #f87171;">Netflix</button>
                        <button class="filter-chip" data-provider="9" onclick="setBrowseProviderFilter('9')" style="border-color: rgba(0,168,225,0.5); color: #38bdf8;">Prime Video</button>
                        <button class="filter-chip" data-provider="337" onclick="setBrowseProviderFilter('337')" style="border-color: rgba(17,60,207,0.5); color: #818cf8;">Disney+</button>
                        <button class="filter-chip" data-provider="15" onclick="setBrowseProviderFilter('15')" style="border-color: rgba(28,231,131,0.5); color: #4ade80;">Hulu</button>
                        <button class="filter-chip" data-provider="350" onclick="setBrowseProviderFilter('350')" style="border-color: rgba(100,100,100,0.5); color: #d4d4d8;">Apple TV+</button>
                        <button class="filter-chip" data-provider="1899" onclick="setBrowseProviderFilter('1899')" style="border-color: rgba(184,53,245,0.5); color: #c084fc;">Max</button>
                        <button class="filter-chip" data-provider="531" onclick="setBrowseProviderFilter('531')" style="border-color: rgba(0,100,255,0.5); color: #60a5fa;">Paramount+</button>
                        <button class="filter-chip" data-provider="386" onclick="setBrowseProviderFilter('386')" style="border-color: rgba(255,215,0,0.5); color: #fbbf24;">Peacock</button>
                        <button class="filter-chip" data-provider="230" onclick="setBrowseProviderFilter('230')" style="border-color: rgba(0,51,161,0.5); color: #93c5fd;">Crave</button>
                        <button class="filter-chip" data-provider="73" onclick="setBrowseProviderFilter('73')" style="border-color: rgba(250,56,47,0.5); color: #fb923c;">Tubi</button>
                    </div>
                </div>

                <!-- Genre Filter -->
                <div class="filter-section">
                    <div class="filter-label">Genre</div>
                    <div class="filter-buttons" id="genreFilters">
                        <button class="filter-chip active" data-genre="all" onclick="setGenreFilter('all')">All</button>
                        <!-- Genres will be populated dynamically -->
                    </div>
                </div>

                <!-- Year Range -->
                <div class="filter-section" style="flex: 0 0 auto;">
                    <div class="filter-label">Year Range</div>
                    <div class="year-range-container">
                        <input type="number" id="yearFrom" class="year-input" placeholder="From" min="1900" max="2027"
                            oninput="applyBrowseFilters()">
                        <span style="opacity: 0.5;">-</span>
                        <input type="number" id="yearTo" class="year-input" placeholder="To" min="1900" max="2027"
                            oninput="applyBrowseFilters()">
                    </div>
                </div>
            </div>

            <!-- Results Count -->
            <div class="browse-results-count" id="browseResultsCount">Loading...</div>
        </div>
        <div class="browse-grid" id="browseGrid"></div>
    </div>

    <!-- Freestyle Overlay -->
    <div class="freestyle-overlay" id="freestyleOverlay">
        <div class="freestyle-header">
            <button class="freestyle-close" onclick="closeFreestyle()"></button>
            <h2> Freestyle <span class="freestyle-experimental-tag">Experimental</span></h2>
            <p>Search for anything  movies, TV shows, or switch to <strong style="color:#ff4444;">YouTube</strong> for music, vlogs, tutorials, and more. Results are fetched live and may not be in our database. This is an experimental feature!</p>
            <div class="freestyle-search-row">
                <input type="text" class="freestyle-search-input" id="freestyleSearchInput" 
                       placeholder="Try: sci-fi thriller, anime, Korean drama, horror 2025..."
                       onkeydown="if(event.key==='Enter')doFreestyleSearch()">
                <select id="freestyleType" style="padding:10px; background:#1a1a1a; border:1px solid rgba(255,255,255,0.15); border-radius:12px; color:white; font-size:13px;" onchange="updateFreestylePlaceholder()">
                    <option value="multi" style="background:#1a1a1a; color:white;">All (TMDB)</option>
                    <option value="movie" style="background:#1a1a1a; color:white;">Movies</option>
                    <option value="tv" style="background:#1a1a1a; color:white;">TV Shows</option>
                    <option value="youtube" style="background:#1a1a1a; color:#ff4444;">YouTube</option>
                </select>
                <button class="freestyle-search-btn" onclick="doFreestyleSearch()">Search</button>
            </div>
        </div>
        <div class="freestyle-results" id="freestyleResults">
            <div class="freestyle-empty">
                <div class="freestyle-empty-icon"></div>
                <div style="font-size:16px; font-weight:600; margin-bottom:8px;">Search for anything</div>
                <div style="font-size:13px;">Type a movie, show, or topic above to discover content from TMDB</div>
            </div>
        </div>
    </div>

    <!-- Queue Panel -->
    <div class="queue-overlay" id="queueOverlay" onclick="toggleQueue()"></div>
    <div class="queue-panel" id="queuePanel">
        <div class="queue-header">
            <h2>My Queue (<span id="queueCount">0</span>)</h2>
            <button class="queue-close" onclick="toggleQueue()"></button>
        </div>
        <div class="queue-content" id="queueContent">
            <p style="opacity: 0.5; text-align: center; padding: 20px;">Your queue is empty<br><small>Click  to add
                    movies</small></p>
        </div>
        <div id="queueUpNext"
            style="padding: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1); background: rgba(245, 158, 11, 0.1); display: none;">
            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 8px;">UP NEXT</div>
            <div id="queueUpNextContent"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-overlay" id="loginOverlay" onclick="closeLogin()"></div>
    <div class="login-modal" id="loginModal">
        <button class="login-close" onclick="closeLogin()"></button>
        <h2 style="margin: 0 0 24px 0; font-size: 24px;">Sign In to Like Movies</h2>
        <form id="loginForm" onsubmit="handleLogin(event)" style="display: flex; flex-direction: column; gap: 16px;">
            <input type="email" id="loginEmail" placeholder="Email" required autocomplete="email"
                style="padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px;">
            <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password"
                style="padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 14px;">
            <button type="submit"
                style="padding: 12px; border-radius: 8px; border: none; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-weight: 700; cursor: pointer; font-size: 14px;">
                Sign In
            </button>
        </form>
        <div id="loginError" style="color: #ef4444; margin-top: 12px; font-size: 13px; display: none;"></div>
        <div
            style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px; opacity: 0.7; text-align: center;">
            Demo: admin / admin
        </div>
    </div>

    <!-- User Avatar (when logged in) -->
    <button class="user-avatar-btn" id="userAvatarBtn" onclick="toggleUserDropdown()"></button>
    <div class="user-dropdown" id="userDropdown">
        <div class="user-dropdown-name" id="userDropdownName"></div>
        <button class="user-dropdown-item" onclick="handleLogout()">Logout</button>
    </div>

    <!-- Sidebar Actions -->
    <div class="sidebar-actions">
        <button class="action-btn alt-trailer-btn hidden-btn" id="altTrailerBtn" onclick="toggleAltTrailers()" title="Alt Trailers"><span class="alt-count" id="altTrailerCount" style="display:none;">0</span></button>
        <button class="action-btn" onclick="likeMovie()" title="Like"></button>
        <button class="action-btn" onclick="addToQueue()" title="Add to Queue"></button>
        <button class="action-btn" onclick="shareMovie()" title="Share"></button>
    </div>

    <!-- Alt Trailer Dropdown -->
    <div class="alt-trailer-dropdown" id="altTrailerDropdown"></div>

    <!-- Video Container -->
    <div id="container">
        <div class="loading">Loading movies...</div>
    </div>

    <script>
        const API_URL = '/MOVIESHOWS3/api/get-movies.php';
        const TMDB_API_KEY = 'b84ff7bfe35ffad8779b77bcbbda317f';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';

        let allMovies = [];
        let allMotivationalVideos = [];
        let filteredMovies = [];
        let currentFilter = 'all';
        let myQueue = JSON.parse(localStorage.getItem('movieQueue') || '[]');
        let currentMovieIndex = 0;

        // Streaming provider state
        let providerCache = JSON.parse(localStorage.getItem('ms3_providerCache') || '{}');
        let providerCacheTimestamp = parseInt(localStorage.getItem('ms3_providerCacheTs') || '0');
        const PROVIDER_CACHE_TTL = 24 * 60 * 60 * 1000; // 24h
        let currentProviderFilter = 'all';
        let providerDataLoaded = false;
        let providerLoadingInProgress = false;

        // TMDB Provider ID mapping
        const PROVIDER_NAMES = {
            '8': 'Netflix', '9': 'Prime Video', '337': 'Disney+',
            '15': 'Hulu', '350': 'Apple TV+', '1899': 'Max',
            '531': 'Paramount+', '386': 'Peacock', '230': 'Crave', '73': 'Tubi'
        };
        const PROVIDER_LOGOS = {
            '8': 'https://image.tmdb.org/t/p/original/pbpMk2JmcoNnQwx5JGpXngfoWtp.jpg',
            '9': 'https://image.tmdb.org/t/p/original/emthp39XA2YScoYL1p0sdbAH2WA.jpg',
            '337': 'https://image.tmdb.org/t/p/original/7rwgEs15tFwyR9NPQ5vpzxTj19Q.jpg',
            '15': 'https://image.tmdb.org/t/p/original/zxrVdFjIjLqkfnwyghnfywTn3Lh.jpg',
            '350': 'https://image.tmdb.org/t/p/original/6uhKBfmtzFqOcLousHwZuzcrScK.jpg',
            '1899': 'https://image.tmdb.org/t/p/original/6Q3KKKLC5RzYtuZgjE0Jv88tKds.jpg',
            '531': 'https://image.tmdb.org/t/p/original/xbhHHa1YgtpwhC8lb1NQ3ACVcLd.jpg',
            '386': 'https://image.tmdb.org/t/p/original/8VCV78prwd9QzZnEhzuVrl65MZz.jpg',
            '230': 'https://image.tmdb.org/t/p/original/mogGMz3ZNmFsUBYSUOpGrdOoCNZ.jpg',
            '73': 'https://image.tmdb.org/t/p/original/4UfRBJiRROwkhVnxVHnGFjHW7fE.jpg'
        };

        // Lazy loading state
        const LAZY_LOAD_BUFFER = 2; // Load iframes for N cards before/after visible
        let lazyObserver = null;
        let loadedIframes = new Set();

        // YouTube Player instances (for Quest 3 fix)
        let ytPlayers = {};

        // Motivational settings (persisted in localStorage)
        let motivationSettings = {
            showInAll: false,
            showLongForm: true
        };

        // Load motivation settings from localStorage
        function loadMotivationSettings() {
            const saved = localStorage.getItem('motivationSettings');
            if (saved) {
                motivationSettings = JSON.parse(saved);
            }
            document.getElementById('motivationInAllToggle').checked = motivationSettings.showInAll;
            document.getElementById('motivationLongFormToggle').checked = motivationSettings.showLongForm;
        }

        function saveMotivationSettings() {
            localStorage.setItem('motivationSettings', JSON.stringify(motivationSettings));
        }

        function toggleMotivationInAll() {
            motivationSettings.showInAll = document.getElementById('motivationInAllToggle').checked;
            saveMotivationSettings();
            // Re-apply current filter to update the view
            filterContent(currentFilter);
            console.log(motivationSettings.showInAll ? ' Motivation videos shown in All' : ' Motivation videos hidden from All');
        }

        function toggleMotivationLongForm() {
            motivationSettings.showLongForm = document.getElementById('motivationLongFormToggle').checked;
            saveMotivationSettings();
            // Rebuild motivation videos list
            buildMotivationalVideos();
            // Re-apply filter
            filterContent(currentFilter);
            console.log(motivationSettings.showLongForm ? ' Long-form motivation enabled' : ' Short-form only');
        }

        // ========== CURATED MOTIVATIONAL VIDEOS ==========
        // Approved channels and their videos
        const MOTIVATION_CHANNELS = [
            // --- Motiversity --- (all verified 2025-02-06)
            {
                channel: 'Motiversity',
                videos: [
                    { id: 'wnHW6o8WMas', title: 'NO EXCUSES - Best Motivational Video', duration: '10:15', isShort: false },
                    { id: '2xeW_HYdb8g', title: 'LISTEN TO THIS EVERY MORNING', duration: '10:20', isShort: false },
                    { id: '9i45VrIyNOI', title: 'WHY NOT YOU - Best Motivational Speeches', duration: '8:35', isShort: false },
                    { id: '-WRP5qXa7SU', title: 'FOCUS AND VALUE YOURSELF - Matthew McConaughey', duration: '17:40', isShort: false },
                    { id: 'LwxnZzGp-n8', title: 'FOCUS ON YOURSELF AND STAY SILENT - Tony Robbins', duration: '12:25', isShort: false },
                    { id: 'zjOS9hWVGQs', title: 'DISCIPLINE YOURSELF - Jocko Willink & David Goggins', duration: '10:00', isShort: false },
                    { id: 'U24wsr048FY', title: 'DISCIPLINE YOUR MIND - Motivational Speech', duration: '8:00', isShort: false },
                    { id: 'Wj1_NCOJ2yY', title: 'DISCIPLINE - Motivational Speech', duration: '9:00', isShort: false },
                ]
            },
            // --- MotivationHub --- (all verified)
            {
                channel: 'MotivationHub',
                videos: [
                    { id: 'g-jwWYX7Jlo', title: 'DREAM - Motivational Video', duration: '15:22', isShort: false },
                    { id: 'k9zTr2MAFRg', title: 'AGAINST ALL ODDS - Elon Musk Motivation', duration: '12:10', isShort: false },
                    { id: 'Hx0VZjLvY-M', title: 'PERSISTENCE - Goggins, Jocko & Eric Thomas', duration: '15:00', isShort: false },
                    { id: '5j3S2ZuiJfc', title: 'GET UP AND GET IT DONE IN 2025 - David Goggins', duration: '19:30', isShort: false },
                ]
            },
            // --- Ben Lionel Scott --- (all verified)
            {
                channel: 'Ben Lionel Scott',
                videos: [
                    { id: '26U_seo0a1g', title: 'UNBROKEN - Motivational Video', duration: '11:30', isShort: false },
                    { id: 'lsSC2vx7zFQ', title: 'HOW BAD DO YOU WANT IT? (Success)', duration: '5:37', isShort: false },
                    { id: 'x3mxjCm0aUI', title: 'CONTROL YOUR MIND - Motivational Speech', duration: '10:00', isShort: false },
                    { id: '8bUpyNYXAiI', title: 'SELF CONFIDENCE - Motivational Speech', duration: '10:00', isShort: false },
                ]
            },
            // --- Be Inspired --- (all verified)
            {
                channel: 'Be Inspired',
                videos: [
                    { id: 'ft_DXwgUXB0', title: 'SELF DISCIPLINE - Featuring Will Smith', duration: '7:12', isShort: false },
                    { id: 'bth-GCGyWcU', title: 'YOU HAVE NO DISCIPLINE - Eric Thomas', duration: '8:00', isShort: false },
                ]
            },
            // --- Fearless Motivation --- (all verified)
            {
                channel: 'Fearless Motivation',
                videos: [
                    { id: 'D0q9HIMRvtk', title: 'I DID NOT COME THIS FAR TO ONLY COME THIS FAR', duration: '4:30', isShort: false },
                    { id: 'PKBDZOPoCH0', title: 'YOU ARE HERE FOR A REASON (Goosebumps)', duration: '5:00', isShort: false },
                    { id: 'xOvts_DTrlA', title: 'THE WARRIOR MENTALITY', duration: '6:00', isShort: false },
                    { id: '9H5SWjSdgdk', title: 'NO FEAR - Best Motivational Speech', duration: '7:00', isShort: false },
                ]
            },
            // --- Motivation2Study --- (all verified)
            {
                channel: 'Motivation2Study',
                videos: [
                    { id: 'VSceuiPBpxY', title: 'THE MINDSET OF A WINNER - Kobe Bryant', duration: '10:00', isShort: false },
                    { id: 'YcdF_TsubxQ', title: 'NO EXCUSES - Best Video for Students', duration: '8:00', isShort: false },
                ]
            },
            // --- Absolute Motivation --- (verified)
            {
                channel: 'Absolute Motivation',
                videos: [
                    { id: 'TLKxdTmk-zc', title: 'THE MOST EYE OPENING 10 MINUTES - David Goggins', duration: '10:00', isShort: false },
                ]
            },
            // --- GaryVee --- (all verified)
            {
                channel: 'GaryVee',
                videos: [
                    { id: 'dp9uSNPnC34', title: 'YOU\'VE GOT TIME!', duration: '0:58', isShort: true },
                    { id: 'f-AyDfj-1C0', title: 'ADVICE EVERY GRADUATE NEEDS TO HEAR', duration: '0:55', isShort: true },
                    { id: '51RdAU0cOUw', title: 'CHANGE YOUR PERSPECTIVE - Gary Vaynerchuk', duration: '7:00', isShort: false },
                    { id: 'loyfrfB4UhE', title: 'FEELING LOST? TURN YOUR LIFE AROUND', duration: '8:00', isShort: false },
                ]
            },
            // --- Evan Carmichael --- (all verified)
            {
                channel: 'Evan Carmichael',
                videos: [
                    { id: 'rePlYbzByxg', title: 'TOP 10 RULES FOR SUCCESS', duration: '12:00', isShort: false },
                    { id: 'oK28sWkfSSk', title: 'OVERCOME NEGATIVITY AND UNLOCK YOUR MIND', duration: '10:00', isShort: false },
                ]
            },
            // --- Eric Thomas --- (all verified)
            {
                channel: 'Eric Thomas',
                videos: [
                    { id: '7Oxz060iedY', title: 'YOU OWE YOU - Powerful Motivation', duration: '7:40', isShort: false },
                    { id: 'tTQG-xf611M', title: 'THE NEW VERSION OF YOU IN 2025', duration: '20:00', isShort: false },
                    { id: 'V5-OaWYas8U', title: 'MAKING 2025 THE BEST YEAR EVER', duration: '20:00', isShort: false },
                ]
            },
            // --- Tony Robbins --- (all verified)
            {
                channel: 'Tony Robbins',
                videos: [
                    { id: '0b2MtFQk_aU', title: 'ONE OF THE MOST EYE OPENING SPEECHES EVER', duration: '10:00', isShort: false },
                    { id: '2EuhFLwtR7Y', title: 'TRANSFORM YOUR LIFE WITH ONE DECISION', duration: '34:00', isShort: false },
                    { id: '8PHm_GkQ8kU', title: 'BECOME SOMEONE NOBODY THOUGHT YOU COULD BE', duration: '12:00', isShort: false },
                ]
            },
            // --- David Goggins Clips --- (all verified)
            {
                channel: 'David Goggins',
                videos: [
                    { id: 'Emc7obS9z4s', title: 'START NOW - David Goggins', duration: '0:30', isShort: true },
                    { id: 'm5S3H1W9lnQ', title: 'IT ALL COMES DOWN TO THIS', duration: '0:45', isShort: true },
                    { id: '8rjtYOavgoo', title: 'WHAT DO YOU STAND FOR?', duration: '0:55', isShort: true },
                    { id: 'Cw0hZQ8Na_Y', title: 'GET UP AND GET IT DONE', duration: '14:00', isShort: false },
                    { id: 'b0FVTOxsWw0', title: 'A FEW MINUTES CAN CHANGE YOUR LIFE', duration: '10:00', isShort: false },
                    { id: 'd6Jefz9Mwgg', title: 'DO IT ALONE. DO IT BROKEN. DO IT SCARED.', duration: '15:00', isShort: false },
                    { id: 'EMRT4mfKTkw', title: 'SHUT UP AND DO THE WORK', duration: '10:00', isShort: false },
                ]
            },
        ];

        // Build the motivational videos list based on settings
        function buildMotivationalVideos() {
            allMotivationalVideos = [];
            let idCounter = 100000; // Use high IDs to avoid collision with DB movies

            MOTIVATION_CHANNELS.forEach(channel => {
                channel.videos.forEach(video => {
                    // If long-form is disabled, only include shorts
                    if (!motivationSettings.showLongForm && !video.isShort) return;

                    allMotivationalVideos.push({
                        id: idCounter++,
                        title: video.title,
                        type: 'motivation',
                        genre: 'Motivation',
                        description: `${channel.channel} - Motivational ${video.isShort ? 'Short' : 'Video'}`,
                        release_year: new Date().getFullYear(),
                        imdb_rating: null,
                        trailer_id: video.id,
                        thumbnail: `https://img.youtube.com/vi/${video.id}/hqdefault.jpg`,
                        _channel: channel.channel,
                        _duration: video.duration,
                        _isShort: video.isShort,
                        _isMotivation: true
                    });
                });
            });

            // Shuffle motivational videos for variety
            for (let i = allMotivationalVideos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allMotivationalVideos[i], allMotivationalVideos[j]] = [allMotivationalVideos[j], allMotivationalVideos[i]];
            }

            // Update count
            document.getElementById('countMotivation').textContent = allMotivationalVideos.length;
        }

        // Now Playing data - fetched from TMDB or approximated from current movies
        let nowPlayingMovies = [];

        function buildNowPlayingList() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth(); // 0-indexed
            // Consider "now playing" as movies from this year
            nowPlayingMovies = allMovies.filter(m => {
                if (m.type !== 'movie') return false;
                const releaseYear = parseInt(m.release_year);
                return releaseYear >= currentYear - 1 && releaseYear <= currentYear;
            });
            document.getElementById('countNowPlaying').textContent = nowPlayingMovies.length;
        }

        // ========== COMING SOON ==========
        // Curated list of upcoming movies & TV shows with trailers
        // Each entry has a release date, venue (Theaters / VOD / Streaming), and trailer ID
        let allComingSoon = [];

        const COMING_SOON_ENTRIES = [
            // --- MOVIES - Theatrical (2026) ---
            {
                title: 'Dracula',
                type: 'movie',
                genre: 'Fantasy, Horror, Romance',
                description: 'Luc Besson\'s gothic horror romance starring Caleb Landry Jones as the legendary vampire and Christoph Waltz as a relentless priest.',
                releaseDate: '2026-02-06',
                venue: 'Theaters',
                trailerId: 'WphzEoD8Gwk',
                thumbnail: null
            },
            {
                title: 'Scream VII',
                type: 'movie',
                genre: 'Horror, Thriller',
                description: 'A new Ghostface emerges targeting Sidney Prescott\'s daughter. Neve Campbell and Courteney Cox return.',
                releaseDate: '2026-02-27',
                venue: 'Theaters',
                trailerId: 'UJrghaPJ0RY',
                thumbnail: null
            },
            {
                title: 'The Bride!',
                type: 'movie',
                genre: 'Fantasy, Drama, Horror',
                description: 'Maggie Gyllenhaal directs Jessie Buckley and Christian Bale in a 1930s reimagining of Frankenstein\'s Bride.',
                releaseDate: '2026-03-06',
                venue: 'Theaters + IMAX',
                trailerId: 'acUJhgxYkQs',
                thumbnail: null
            },
            {
                title: 'Hoppers',
                type: 'movie',
                genre: 'Animation, Comedy, Family',
                description: 'Pixar\'s new film follows an animal lover who uses tech to transfer human consciousness into robotic animals.',
                releaseDate: '2026-03-06',
                venue: 'Theaters',
                trailerId: 'SS3U9GnTlmY',
                thumbnail: null
            },
            {
                title: 'Project Hail Mary',
                type: 'movie',
                genre: 'Sci-Fi, Adventure, Drama',
                description: 'Ryan Gosling stars as an astronaut who wakes up on a spaceship light-years from Earth with no memory, tasked with saving humanity.',
                releaseDate: '2026-03-20',
                venue: 'Theaters + IMAX',
                trailerId: 'J8h_CsVEF6U',
                thumbnail: null
            },
            {
                title: 'Avengers: Doomsday',
                type: 'movie',
                genre: 'Action, Superhero',
                description: 'Robert Downey Jr. returns as Doctor Doom. The Russo Brothers direct the next epic Marvel crossover uniting Avengers, Fantastic Four, and X-Men.',
                releaseDate: '2026-05-01',
                venue: 'Theaters + IMAX',
                trailerId: null,
                thumbnail: null
            },
            {
                title: 'Scary Movie 6',
                type: 'movie',
                genre: 'Comedy, Horror',
                description: 'The Wayans family returns for another round of horror spoofs skewering modern genre films.',
                releaseDate: '2026-06-12',
                venue: 'Theaters',
                trailerId: null,
                thumbnail: null
            },
            {
                title: 'The Odyssey',
                type: 'movie',
                genre: 'Action, Fantasy, Adventure',
                description: 'Christopher Nolan\'s mythic action epic starring Matt Damon, Tom Holland, Robert Pattinson, and Zendaya. Shot entirely on IMAX.',
                releaseDate: '2026-07-17',
                venue: 'Theaters + IMAX',
                trailerId: 'i3j6l8zQSks',
                thumbnail: null
            },
            {
                title: 'Three Bags Full: A Sheep Detective Movie',
                type: 'movie',
                genre: 'Comedy, Mystery',
                description: 'Hugh Jackman and Bryan Cranston lead an ensemble cast in this story of sheep solving their shepherd\'s murder.',
                releaseDate: '2026-11-13',
                venue: 'Theaters',
                trailerId: null,
                thumbnail: null
            },
        ];

        function buildComingSoonList() {
            allComingSoon = [];
            let idCounter = 200000; // High IDs to avoid collision

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            COMING_SOON_ENTRIES.forEach(entry => {
                const releaseDate = new Date(entry.releaseDate + 'T00:00:00');

                // Only include entries that haven't been released yet (or released within last 7 days for awareness)
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                if (releaseDate >= sevenDaysAgo) {
                    // Calculate how many days until release
                    const diffTime = releaseDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    let releaseDateStr;
                    if (diffDays < 0) {
                        releaseDateStr = 'Just Released!';
                    } else if (diffDays === 0) {
                        releaseDateStr = 'Out Today!';
                    } else if (diffDays === 1) {
                        releaseDateStr = 'Tomorrow!';
                    } else if (diffDays <= 7) {
                        releaseDateStr = `In ${diffDays} days`;
                    } else if (diffDays <= 30) {
                        releaseDateStr = `In ${Math.ceil(diffDays / 7)} weeks`;
                    } else {
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        releaseDateStr = `${months[releaseDate.getMonth()]} ${releaseDate.getDate()}, ${releaseDate.getFullYear()}`;
                    }

                    const trailerId = entry.trailerId;
                    // Skip entries with no trailer (can't show in the video feed)
                    // But include in browse grid

                    allComingSoon.push({
                        id: idCounter++,
                        title: entry.title,
                        type: entry.type,
                        genre: entry.genre,
                        description: entry.description,
                        release_year: releaseDate.getFullYear(),
                        imdb_rating: null,
                        trailer_id: trailerId,
                        thumbnail: trailerId ? `https://img.youtube.com/vi/${trailerId}/hqdefault.jpg` : null,
                        _isComingSoon: true,
                        _releaseDate: entry.releaseDate,
                        _releaseDateStr: releaseDateStr,
                        _venue: entry.venue,
                        _daysUntil: diffDays
                    });
                }
            });

            // Sort by release date (soonest first)
            allComingSoon.sort((a, b) => new Date(a._releaseDate) - new Date(b._releaseDate));

            document.getElementById('countComingSoon').textContent = allComingSoon.length;
        }

        // Get coming soon entries that have trailers (for the video feed)
        function getComingSoonWithTrailers() {
            return allComingSoon.filter(m => m.trailer_id);
        }

        // ========== FREESTYLE (EXPERIMENTAL) ==========
        let freestyleResults = [];
        let freestyleSearching = false;

        function openFreestyle() {
            document.getElementById('freestyleOverlay').classList.add('active');
            setTimeout(() => {
                document.getElementById('freestyleSearchInput').focus();
            }, 200);
        }

        function closeFreestyle() {
            document.getElementById('freestyleOverlay').classList.remove('active');
        }

        function updateFreestylePlaceholder() {
            const type = document.getElementById('freestyleType').value;
            const input = document.getElementById('freestyleSearchInput');
            if (type === 'youtube') {
                input.placeholder = 'Search YouTube: music videos, tutorials, vlogs, anything...';
            } else {
                input.placeholder = 'Try: sci-fi thriller, anime, Korean drama, horror 2025...';
            }
        }

        async function doFreestyleSearch() {
            const query = document.getElementById('freestyleSearchInput').value.trim();
            const type = document.getElementById('freestyleType').value;
            const resultsDiv = document.getElementById('freestyleResults');

            if (!query) return;
            if (freestyleSearching) return;
            freestyleSearching = true;

            const isYouTube = type === 'youtube';
            const searchLabel = isYouTube ? 'YouTube' : 'TMDB';

            resultsDiv.innerHTML = `
                <div class="freestyle-loading">
                    <div class="spinner-ring"></div>
                    <div>Searching ${searchLabel} for "${escapeHtml(query)}"...</div>
                </div>`;

            try {
                const apiBase = window.location.pathname.replace(/\/[^/]*$/, '');
                let url;

                if (isYouTube) {
                    url = apiBase + '/api/freestyle-search.php?q=' + encodeURIComponent(query) + '&type=youtube';
                } else {
                    url = apiBase + '/api/freestyle-search.php?q=' + encodeURIComponent(query) + '&type=' + type;
                }

                const resp = await fetch(url);
                const data = await resp.json();

                if (!data.success) {
                    resultsDiv.innerHTML = `<div class="freestyle-empty"><div class="freestyle-empty-icon"></div><div>${data.error || 'Search failed'}</div></div>`;
                    freestyleSearching = false;
                    return;
                }

                freestyleResults = data.results || [];

                if (freestyleResults.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="freestyle-empty">
                            <div class="freestyle-empty-icon"></div>
                            <div style="font-size:16px; font-weight:600; margin-bottom:8px;">No results found</div>
                            <div style="font-size:13px;">Try different keywords or a broader search</div>
                        </div>`;
                    freestyleSearching = false;
                    return;
                }

                const sourceLabel = isYouTube ? 'YouTube' : 'TMDB';
                let html = `<div style="margin-bottom:12px; color:rgba(255,255,255,0.4); font-size:13px;">${(data.total_results || freestyleResults.length).toLocaleString()} results on ${sourceLabel} &bull; Showing ${freestyleResults.length}</div>`;
                html += '<div class="freestyle-results-grid">';

                freestyleResults.forEach((item, i) => {
                    const isYt = item._isYouTube;
                    const videoId = isYt ? item.trailer_id : item.trailer_id;
                    const thumb = videoId
                        ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`
                        : (item.backdrop || item.thumbnail || '');
                    const hasTrailer = !!videoId;

                    let badgeHtml;
                    if (isYt) {
                        badgeHtml = `<span class="yt-badge">YouTube</span>`;
                        if (item._channel) {
                            badgeHtml += `<span style="color:rgba(255,255,255,0.4); font-size:11px;">${escapeHtml(item._channel)}</span>`;
                        }
                    } else {
                        const typeLabel = item.type === 'tv' ? 'TV' : 'Movie';
                        const typeColor = item.type === 'tv' ? '#8957e5' : '#1f6feb';
                        badgeHtml = `<span class="freestyle-badge">FREESTYLE</span>
                            <span style="background:${typeColor}; color:#fff; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:700;">${typeLabel}</span>`;
                    }

                    html += `
                    <div class="freestyle-card">
                        <div class="freestyle-card-thumb" onclick="${hasTrailer ? `playFreestyleTrailer(${i})` : ''}" style="${hasTrailer ? 'cursor:pointer' : ''}">
                            ${thumb ? `<img src="${thumb}" alt="" onerror="this.style.display='none'">` : ''}
                            ${hasTrailer ? `<div class="freestyle-card-play"><span></span></div>` : `<div class="freestyle-no-trailer">No trailer available</div>`}
                        </div>
                        <div class="freestyle-card-body">
                            <div class="freestyle-card-title">${escapeHtml(item.title)}</div>
                            <div class="freestyle-card-meta">
                                ${badgeHtml}
                                ${item.release_year ? `<span style="color:rgba(255,255,255,0.5); font-size:11px;">${item.release_year}</span>` : ''}
                                ${item.imdb_rating ? `<span style="color:rgba(255,255,255,0.5); font-size:11px;"> ${item.imdb_rating}</span>` : ''}
                                ${item._duration ? `<span style="color:rgba(255,255,255,0.4); font-size:11px;">${item._duration}</span>` : ''}
                            </div>
                            ${item.genre ? `<div style="font-size:11px; color:rgba(255,255,255,0.35); margin-bottom:4px;">${escapeHtml(item.genre)}</div>` : ''}
                            <div class="freestyle-card-desc">${escapeHtml(item.description || '')}</div>
                        </div>
                        <div class="freestyle-card-actions">
                            ${hasTrailer ? `<button class="freestyle-action-btn play-btn" onclick="event.stopPropagation(); playFreestyleTrailer(${i})"> Play Now</button>` : ''}
                            ${hasTrailer ? `<button class="freestyle-action-btn queue-btn" onclick="event.stopPropagation(); queueFreestyleItem(${i}, this)"> Queue</button>` : ''}
                        </div>
                    </div>`;
                });

                html += '</div>';
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = `<div class="freestyle-empty"><div class="freestyle-empty-icon"></div><div>Error: ${err.message}</div></div>`;
            }
            freestyleSearching = false;
        }

        function makeFreestyleMovie(item) {
            return {
                id: 'freestyle_' + (item.tmdb_id || item.trailer_id || Math.random()),
                title: item.title,
                type: item.type || 'movie',
                genre: item.genre || '',
                description: item.description || '',
                release_year: item.release_year,
                imdb_rating: item.imdb_rating,
                trailer_id: item.trailer_id,
                thumbnail: item.thumbnail,
                _isFreestyle: true,
                _isYouTube: item._isYouTube || false,
                _channel: item._channel || ''
            };
        }

        function playFreestyleTrailer(index) {
            const item = freestyleResults[index];
            if (!item || !item.trailer_id) return;

            // Close freestyle overlay and play in the main player
            closeFreestyle();

            const tempMovie = makeFreestyleMovie(item);

            // Add to filtered movies temporarily and play
            filteredMovies = [tempMovie, ...filteredMovies];
            currentIndex = 0;
            renderMovies(filteredMovies);
            if (typeof playTrailer === 'function') {
                playTrailer(0);
            }
        }

        function queueFreestyleItem(index, btn) {
            const item = freestyleResults[index];
            if (!item || !item.trailer_id) return;

            const tempMovie = makeFreestyleMovie(item);

            // Check if already in queue
            if (myQueue.find(m => m.trailer_id === tempMovie.trailer_id)) {
                btn.textContent = 'Already queued';
                btn.disabled = true;
                return;
            }

            myQueue.push(tempMovie);
            localStorage.setItem('movieQueue', JSON.stringify(myQueue));
            document.getElementById('queueCount').textContent = myQueue.length;

            btn.textContent = ' Queued';
            btn.disabled = true;
            btn.style.background = 'rgba(34, 197, 94, 0.25)';
        }

        // Browse filter state
        let browseFilters = {
            searchQuery: '',
            contentType: 'all',
            genre: 'all',
            yearFrom: null,
            yearTo: null
        };
        let browseFilteredMovies = [];

        // Authentication state
        let currentUser = null;
        let userLikes = [];
        let likeCounts = {};

        // Check session on page load
        async function checkSession() {
            try {
                const response = await fetch('/MOVIESHOWS3/api/check-session.php');
                if (!response.ok) return;
                const text = await response.text();
                if (!text.trim().startsWith('{') && !text.trim().startsWith('[')) return;
                const data = JSON.parse(text);
                if (data.user) {
                    currentUser = data.user;
                    updateUserProfile();
                    await loadLikes();
                }
            } catch (error) {
                console.error('Session check failed:', error);
            }
        }

        // Load likes data
        async function loadLikes() {
            try {
                const response = await fetch('/MOVIESHOWS3/api/get-likes.php');
                if (!response.ok) {
                    console.warn('Likes API returned status', response.status);
                    return;
                }
                const text = await response.text();
                // Guard against non-JSON responses (e.g. PHP errors returning HTML)
                if (!text.trim().startsWith('{') && !text.trim().startsWith('[')) {
                    console.warn('Likes API returned non-JSON response');
                    return;
                }
                const data = JSON.parse(text);
                likeCounts = data.like_counts || {};
                userLikes = data.user_likes || [];
                console.log(' Loaded likes:', { likeCounts, userLikes });
            } catch (error) {
                console.error('Failed to load likes:', error);
            }
        }

        // Update user profile display
        function updateUserProfile() {
            const avatarBtn = document.getElementById('userAvatarBtn');
            const dropdownName = document.getElementById('userDropdownName');
            if (currentUser) {
                // Show initials in avatar
                const name = currentUser.display_name || currentUser.email || '?';
                const initials = name.split(/[\s@]/).filter(Boolean).map(w => w[0].toUpperCase()).slice(0, 2).join('');
                avatarBtn.textContent = initials;
                avatarBtn.style.display = 'flex';
                dropdownName.textContent = name;
            } else {
                avatarBtn.style.display = 'none';
                document.getElementById('userDropdown').classList.remove('active');
            }
        }

        function toggleUserDropdown() {
            document.getElementById('userDropdown').classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#userAvatarBtn') && !e.target.closest('#userDropdown')) {
                document.getElementById('userDropdown').classList.remove('active');
            }
        });

        // Show login modal
        function showLogin() {
            document.getElementById('loginOverlay').classList.add('active');
            document.getElementById('loginModal').classList.add('active');
        }

        // Close login modal
        function closeLogin() {
            document.getElementById('loginOverlay').classList.remove('active');
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('loginError').style.display = 'none';
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch('/MOVIESHOWS3/api/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (data.user) {
                    currentUser = data.user;
                    updateUserProfile();
                    await loadLikes();
                    await loadWatchHistory();
                    closeLogin();
                    console.log(' Logged in as:', currentUser.display_name);
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
                console.error('Login error:', error);
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await fetch('/MOVIESHOWS3/api/logout.php', { method: 'POST' });
                currentUser = null;
                userLikes = [];
                watchedMovieIds = [];
                updateUserProfile();
                console.log(' Logged out');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // ---- Watch History & Skip Watched ----
        let watchedMovieIds = [];
        let skipWatchedSettings = { enabled: false };

        // Load skip-watched setting from localStorage
        function loadSkipWatchedSettings() {
            const saved = localStorage.getItem('skipWatchedSettings');
            if (saved) {
                try { skipWatchedSettings = JSON.parse(saved); } catch(e) {}
            }
            const toggle = document.getElementById('skipWatchedToggle');
            if (toggle) toggle.checked = skipWatchedSettings.enabled;
        }

        function toggleSkipWatched() {
            skipWatchedSettings.enabled = document.getElementById('skipWatchedToggle').checked;
            localStorage.setItem('skipWatchedSettings', JSON.stringify(skipWatchedSettings));
            console.log(skipWatchedSettings.enabled ? ' Skip watched ON' : ' Skip watched OFF');
            // Re-filter to apply immediately
            filterContent(currentFilter);
        }

        // Fetch watch history from API
        async function loadWatchHistory() {
            if (!currentUser) return;
            try {
                const response = await fetch('/MOVIESHOWS3/api/watch-history.php');
                if (!response.ok) return;
                const text = await response.text();
                if (!text.trim().startsWith('{') && !text.trim().startsWith('[')) return;
                const data = JSON.parse(text);
                watchedMovieIds = data.watched_ids || [];
                console.log(' Loaded watch history:', watchedMovieIds.length, 'movies watched');
            } catch (error) {
                console.error('Failed to load watch history:', error);
            }
        }

        // Record a watch event
        async function recordWatch(movieId, trailerId, completed) {
            if (!currentUser) return;
            try {
                await fetch('/MOVIESHOWS3/api/watch-history.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ movie_id: movieId, trailer_id: trailerId || '', completed: completed ? 1 : 0 })
                });
                // Add to local list so skip-watched works immediately
                if (!watchedMovieIds.includes(movieId)) {
                    watchedMovieIds.push(movieId);
                }
                console.log(' Recorded watch for movie', movieId);
            } catch (error) {
                console.error('Failed to record watch:', error);
            }
        }

        // Auto-scroll settings
        let autoScrollSettings = {
            enabled: true,
            delay: 10 // default 10 seconds (kept for backward compatibility, but now triggers on video end)
        };
        let autoScrollTimeout = null;

        // Load auto-scroll settings from localStorage
        function loadAutoScrollSettings() {
            const saved = localStorage.getItem('autoScrollSettings');
            if (saved) {
                autoScrollSettings = JSON.parse(saved);
            }

            // Update UI
            document.getElementById('autoScrollToggle').checked = autoScrollSettings.enabled;
            document.getElementById('autoScrollDelay').value = autoScrollSettings.delay;
            document.getElementById('delayValue').textContent = autoScrollSettings.delay;

            // Show/hide delay container
            const delayContainer = document.getElementById('autoScrollDelayContainer');
            if (autoScrollSettings.enabled) {
                delayContainer.style.display = 'flex';
            } else {
                delayContainer.style.display = 'none';
            }
        }

        // Save auto-scroll settings to localStorage
        function saveAutoScrollSettings() {
            localStorage.setItem('autoScrollSettings', JSON.stringify(autoScrollSettings));
        }

        // Toggle auto-scroll on/off
        function toggleAutoScroll() {
            autoScrollSettings.enabled = document.getElementById('autoScrollToggle').checked;
            saveAutoScrollSettings();

            const delayContainer = document.getElementById('autoScrollDelayContainer');
            if (autoScrollSettings.enabled) {
                delayContainer.style.display = 'flex';
                console.log(' Auto-scroll enabled - will scroll when video ends');
            } else {
                delayContainer.style.display = 'none';
                // Clear any pending auto-scroll
                if (autoScrollTimeout) {
                    clearTimeout(autoScrollTimeout);
                    autoScrollTimeout = null;
                }
                console.log(' Auto-scroll disabled');
            }
        }

        // Update auto-scroll delay
        function updateAutoScrollDelay(value) {
            autoScrollSettings.delay = parseInt(value);
            document.getElementById('delayValue').textContent = value;
            saveAutoScrollSettings();
            console.log('Auto-scroll delay updated to', value, 'seconds (fallback if video end detection fails)');
        }

        // Trigger auto-scroll to next video (called when video ends)
        function triggerAutoScroll() {
            if (!autoScrollSettings.enabled) return;

            const cards = document.querySelectorAll('.video-card');
            if (cards.length === 0) return;

            // Find current playing card
            let currentIndex = -1;
            cards.forEach((card, index) => {
                const rect = card.getBoundingClientRect();
                const isInView = rect.top >= 0 && rect.top < window.innerHeight / 2;
                if (isInView) {
                    currentIndex = index;
                }
            });

            // Scroll to next card
            const nextIndex = currentIndex + 1;
            if (nextIndex < cards.length) {
                cards[nextIndex].scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log(' Auto-scrolled to video', nextIndex + 1, '(triggered by video end)');
            } else {
                // Loop back to first video
                cards[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log(' Auto-scrolled back to first video (triggered by video end)');
            }
        }

        // YouTube IFrame API callback when video state changes
        function onPlayerStateChange(event, index) {
            // YT.PlayerState.ENDED = 0
            if (event.data === 0) {
                console.log(` Video ${index} ended`);
                // Record watch history
                if (filteredMovies[index]) {
                    const movie = filteredMovies[index];
                    recordWatch(movie.id, movie.trailer_id, true);
                }
                triggerAutoScroll();
            }
        }

        // Initialize YouTube player for a specific iframe
        function initYouTubePlayer(index) {
            const iframe = document.getElementById(`player-${index}`);
            if (!iframe) return;

            // Destroy stale player if iframe was reloaded (src changed)
            if (ytPlayers[index]) {
                try { ytPlayers[index].destroy(); } catch(e) {}
                delete ytPlayers[index];
            }

            try {
                ytPlayers[index] = new YT.Player(`player-${index}`, {
                    events: {
                        'onStateChange': (event) => onPlayerStateChange(event, index)
                    }
                });
                console.log(` Initialized YouTube player for video ${index}`);
            } catch (error) {
                console.warn(`Failed to initialize YouTube player ${index}:`, error);
            }
        }

        function toggleMenu() {
            document.getElementById('menuOverlay').classList.toggle('active');
            document.getElementById('menuPanel').classList.toggle('active');
        }

        // ========== STREAMING SERVICE FILTER ==========
        function toggleStreamingFilter() {
            const row = document.getElementById('streamingFilterRow');
            row.classList.toggle('visible');
            const btn = document.getElementById('streamingToggleBtn');
            btn.style.background = row.classList.contains('visible')
                ? 'rgba(245, 158, 11, 0.4)' : 'rgba(0, 0, 0, 0.4)';

            if (row.classList.contains('visible') && !providerDataLoaded && !providerLoadingInProgress) {
                fetchAllProviderData();
            }
        }

        async function fetchAllProviderData() {
            if (providerLoadingInProgress) return;
            providerLoadingInProgress = true;

            // Check cache validity
            if (Date.now() - providerCacheTimestamp < PROVIDER_CACHE_TTL && Object.keys(providerCache).length > 0) {
                applyProviderCacheToMovies();
                providerDataLoaded = true;
                providerLoadingInProgress = false;
                updateProviderCounts();
                return;
            }

            console.log('Fetching streaming provider data via TMDB Discover API...');
            var newCache = {};

            // Build a set of our TMDB IDs for fast lookup
            var ourMovieIds = new Set();
            var ourTvIds = new Set();
            allMovies.forEach(function(m) {
                if (!m.tmdb_id) return;
                if (m.type === 'tv') ourTvIds.add(String(m.tmdb_id));
                else ourMovieIds.add(String(m.tmdb_id));
            });

            // For each provider, use TMDB Discover to get titles on that service
            var providerIds = Object.keys(PROVIDER_NAMES);

            for (var pi = 0; pi < providerIds.length; pi++) {
                var pid = providerIds[pi];
                try {
                    // Fetch movies on this provider (up to 5 pages = 100 results)
                    var movieMatches = await fetchDiscoverPages('movie', pid, ourMovieIds, 5);
                    // Fetch TV on this provider
                    var tvMatches = await fetchDiscoverPages('tv', pid, ourTvIds, 5);

                    // Tag matched movies
                    movieMatches.forEach(function(tmdbId) {
                        var key = 'movie_' + tmdbId;
                        if (!newCache[key]) newCache[key] = [];
                        newCache[key].push({
                            id: pid,
                            name: PROVIDER_NAMES[pid],
                            logo: PROVIDER_LOGOS[pid]
                        });
                    });
                    tvMatches.forEach(function(tmdbId) {
                        var key = 'tv_' + tmdbId;
                        if (!newCache[key]) newCache[key] = [];
                        newCache[key].push({
                            id: pid,
                            name: PROVIDER_NAMES[pid],
                            logo: PROVIDER_LOGOS[pid]
                        });
                    });

                    console.log('Provider ' + PROVIDER_NAMES[pid] + ': ' + movieMatches.length + ' movies, ' + tvMatches.length + ' TV');
                } catch (err) {
                    console.warn('Failed to fetch provider ' + pid + ': ' + err.message);
                }
                // Small delay between providers
                await new Promise(function(r) { setTimeout(r, 200); });
            }

            providerCache = newCache;
            try {
                localStorage.setItem('ms3_providerCache', JSON.stringify(providerCache));
                localStorage.setItem('ms3_providerCacheTs', String(Date.now()));
            } catch(e) { /* localStorage full */ }

            applyProviderCacheToMovies();
            providerDataLoaded = true;
            providerLoadingInProgress = false;
            updateProviderCounts();
            console.log('Streaming provider data loaded for ' + Object.keys(providerCache).length + ' titles');
        }

        async function fetchDiscoverPages(mediaType, providerId, ourIdSet, maxPages) {
            var matched = [];
            for (var page = 1; page <= maxPages; page++) {
                try {
                    var url = TMDB_BASE_URL + '/discover/' + mediaType +
                        '?api_key=' + TMDB_API_KEY +
                        '&with_watch_providers=' + providerId +
                        '&watch_region=US' +
                        '&with_watch_monetization_types=flatrate|free|ads' +
                        '&sort_by=popularity.desc&page=' + page;
                    var resp = await fetch(url);
                    if (!resp.ok) break;
                    var data = await resp.json();
                    if (!data.results || data.results.length === 0) break;
                    data.results.forEach(function(item) {
                        if (ourIdSet.has(String(item.id))) {
                            matched.push(String(item.id));
                        }
                    });
                    if (page >= data.total_pages) break;
                } catch (e) { break; }
            }
            return matched;
        }

        function applyProviderCacheToMovies() {
            allMovies.forEach(function(movie) {
                if (!movie.tmdb_id) { movie._providers = []; return; }
                var cacheKey = movie.type + '_' + movie.tmdb_id;
                movie._providers = providerCache[cacheKey] || [];
            });
        }

        function updateProviderCounts() {
            var counts = {};
            allMovies.forEach(function(movie) {
                if (!movie._providers) return;
                movie._providers.forEach(function(p) {
                    counts[p.id] = (counts[p.id] || 0) + 1;
                });
            });

            // Update pill counts in the streaming filter row
            document.querySelectorAll('.streaming-pill[data-provider]').forEach(function(pill) {
                var pid = pill.getAttribute('data-provider');
                if (pid === 'all') return;
                var existing = pill.querySelector('.provider-count');
                if (existing) existing.remove();
                var count = counts[pid] || 0;
                if (count > 0) {
                    var span = document.createElement('span');
                    span.className = 'provider-count';
                    span.textContent = count;
                    pill.appendChild(span);
                }
            });

            // Update browse view provider filter counts too
            document.querySelectorAll('#browseStreamingFilters .filter-chip[data-provider]').forEach(function(chip) {
                var pid = chip.getAttribute('data-provider');
                if (pid === 'all') return;
                var count = counts[pid] || 0;
                var name = PROVIDER_NAMES[pid] || pid;
                chip.textContent = name + (count > 0 ? ' (' + count + ')' : '');
            });
        }

        function filterByProvider(providerId) {
            currentProviderFilter = providerId;

            // Update pill active states
            document.querySelectorAll('.streaming-pill').forEach(function(p) {
                p.classList.remove('active');
            });
            var activePill = document.querySelector('.streaming-pill[data-provider="' + providerId + '"]');
            if (activePill) activePill.classList.add('active');

            // Re-filter and render
            applyMainFilter();
        }

        function setBrowseProviderFilter(providerId) {
            currentProviderFilter = providerId;

            // Update active state in browse
            document.querySelectorAll('#browseStreamingFilters .filter-chip').forEach(function(c) {
                c.classList.remove('active');
            });
            var activeChip = document.querySelector('#browseStreamingFilters .filter-chip[data-provider="' + providerId + '"]');
            if (activeChip) activeChip.classList.add('active');

            // Also update the top streaming pills
            document.querySelectorAll('.streaming-pill').forEach(function(p) { p.classList.remove('active'); });
            var topPill = document.querySelector('.streaming-pill[data-provider="' + providerId + '"]');
            if (topPill) topPill.classList.add('active');

            applyBrowseFilters();
        }

        function applyProviderFilterToList(movies) {
            if (currentProviderFilter === 'all') return movies;
            return movies.filter(function(m) {
                if (!m._providers) return false;
                return m._providers.some(function(p) { return p.id === currentProviderFilter; });
            });
        }

        function applyMainFilter() {
            // Apply content type filter first
            var movies;
            if (currentFilter === 'all') {
                if (motivationSettings.showInAll) {
                    movies = allMovies.concat(allMotivationalVideos);
                } else {
                    movies = allMovies.slice();
                }
            } else if (currentFilter === 'motivation') {
                movies = allMotivationalVideos.slice();
            } else if (currentFilter === 'now-playing') {
                buildNowPlayingList();
                movies = nowPlayingMovies.slice();
            } else if (currentFilter === 'coming-soon') {
                buildComingSoonList();
                movies = allComingSoon.slice();
            } else {
                movies = allMovies.filter(function(m) { return m.type === currentFilter; });
            }

            // Apply provider filter
            movies = applyProviderFilterToList(movies);

            // Skip watched
            if (skipWatchedSettings.enabled && watchedMovieIds.length > 0) {
                movies = movies.filter(function(m) { return watchedMovieIds.indexOf(m.id) === -1; });
            }

            filteredMovies = movies;
            renderMovies(filteredMovies);

            setTimeout(function() { setupScrollAutoplay(); }, 100);

            if (document.getElementById('browseView').classList.contains('active')) {
                renderBrowseGrid();
                applyBrowseFilters();
            }
        }

        function toggleBrowse() {
            const browseView = document.getElementById('browseView');
            const isActive = browseView.classList.toggle('active');

            if (isActive) {
                // Initialize genre filters from database
                populateGenreFilters();
                // Reset and apply filters
                applyBrowseFilters();
            }
        }

        function toggleQueue() {
            document.getElementById('queueOverlay').classList.toggle('active');
            document.getElementById('queuePanel').classList.toggle('active');
            renderQueue();
        }

        function filterContent(type) {
            currentFilter = type;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(function(btn) { btn.classList.remove('active'); });
            var filterMap = {
                'all': 'filterAll',
                'movie': 'filterMovies',
                'tv': 'filterTV',
                'motivation': 'filterMotivation',
                'now-playing': 'filterNowPlaying',
                'coming-soon': 'filterComingSoon'
            };
            var btnId = filterMap[type];
            if (btnId) document.getElementById(btnId).classList.add('active');

            // Use the centralized filter logic
            applyMainFilter();
        }

        function renderBrowseGrid() {
            const grid = document.getElementById('browseGrid');
            const resultsCount = document.getElementById('browseResultsCount');

            // Use browseFilteredMovies instead of filteredMovies
            const moviesToDisplay = browseFilteredMovies;

            resultsCount.textContent = `Showing ${moviesToDisplay.length} result${moviesToDisplay.length !== 1 ? 's' : ''}`;

            if (moviesToDisplay.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.5;">No results found. Try adjusting your filters.</div>';
                return;
            }

            grid.innerHTML = moviesToDisplay.map((movie, index) => {
                // Find the actual index in filteredMovies for playback
                const actualIndex = filteredMovies.findIndex(m => m.id === movie.id);
                const isMotivation = movie._isMotivation;
                const isComingSoon = movie._isComingSoon;
                const hasTrailer = !!movie.trailer_id;

                // Determine card border color
                let cardStyle = '';
                if (isMotivation) cardStyle = 'border: 1px solid rgba(139, 92, 246, 0.3);';
                else if (isComingSoon) cardStyle = 'border: 1px solid rgba(14, 165, 233, 0.3);';

                // Determine image style
                let imgStyle = '';
                if (isMotivation || isComingSoon) imgStyle = 'aspect-ratio: 16/9; object-fit: cover;';

                // Click handler - only if has trailer and is in filteredMovies
                const clickHandler = hasTrailer && actualIndex >= 0
                    ? `onclick="playMovieFromBrowse(${actualIndex})"`
                    : '';
                const cursorStyle = hasTrailer && actualIndex >= 0 ? 'cursor: pointer;' : 'cursor: default; opacity: 0.85;';

                return `
                <div class="movie-card" style="${cardStyle}">
                    <div class="movie-card-actions">
                        <button class="movie-card-add-queue" onclick="event.stopPropagation(); addToQueueFromBrowseFiltered(${movie.id});" title="Add to Queue">\u2795</button>
                    </div>
                    <div ${clickHandler} style="${cursorStyle} position: relative;">
                        <img src="${movie.thumbnail || 'https://placehold.co/200x300/1a1a1a/666?text=' + encodeURIComponent(movie.title)}" alt="${escapeHtml(movie.title)}" onerror="this.src='https://placehold.co/200x300/1a1a1a/666?text=No+Image'" style="${imgStyle}">
                        ${isMotivation ? `
                            <div class="motivation-card-channel">${escapeHtml(movie._channel)}</div>
                            <div class="motivation-duration-badge">${movie._duration}</div>
                        ` : ''}
                        ${isComingSoon ? `
                            <div class="coming-soon-card-date">${movie._releaseDateStr}</div>
                            <div class="coming-soon-card-venue">${escapeHtml(movie._venue)}</div>
                        ` : ''}
                        ${!hasTrailer && isComingSoon ? `
                            <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);">
                                <span style="color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 600;">Trailer Coming Soon</span>
                            </div>
                        ` : ''}
                        <div class="movie-card-info">
                            <div class="movie-card-title">${escapeHtml(movie.title)}</div>
                            <div class="movie-card-meta">
                                ${isMotivation
                                    ? `<span class="motivation-badge" style="font-size: 9px; padding: 2px 6px;">MOTIVATION</span> ${movie._isShort ? 'Short' : 'Video'}`
                                    : isComingSoon
                                        ? `<span class="coming-soon-badge" style="font-size: 9px; padding: 2px 6px;">COMING SOON</span> ${movie.type ? movie.type.toUpperCase() : ''}`
                                        : `${movie.release_year || ''} ${movie.imdb_rating ? '\u2b50 ' + movie.imdb_rating : ''}`
                                }
                            </div>
                            ${movie._providers && movie._providers.length > 0 ? `
                                <div class="provider-badges">
                                    ${movie._providers.slice(0, 5).map(function(p) {
                                        return '<img class="provider-badge" src="' + p.logo + '" alt="' + p.name + '" title="' + p.name + '">';
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function populateGenreFilters() {
            // Extract unique genres from all movies (check both 'genres' and 'genre' fields)
            const genresSet = new Set();
            filteredMovies.forEach(movie => {
                const genreStr = movie.genres || movie.genre;
                if (genreStr) {
                    const genres = genreStr.split(',').map(g => g.trim());
                    genres.forEach(genre => {
                        if (genre) genresSet.add(genre);
                    });
                }
            });

            const genres = Array.from(genresSet).sort();
            const genreFiltersContainer = document.getElementById('genreFilters');

            // Keep the "All" button and add genre buttons
            const allButton = genreFiltersContainer.querySelector('[data-genre="all"]');
            genreFiltersContainer.innerHTML = '';
            genreFiltersContainer.appendChild(allButton);

            genres.forEach(genre => {
                const button = document.createElement('button');
                button.className = 'filter-chip';
                button.setAttribute('data-genre', genre);
                button.textContent = genre;
                button.onclick = () => setGenreFilter(genre);
                genreFiltersContainer.appendChild(button);
            });
        }

        function applyBrowseFilters() {
            // Get filter values
            const searchQuery = document.getElementById('browseSearchInput').value.toLowerCase().trim();
            const yearFrom = parseInt(document.getElementById('yearFrom').value) || null;
            const yearTo = parseInt(document.getElementById('yearTo').value) || null;

            // Update search clear button visibility
            const clearBtn = document.getElementById('browseSearchClear');
            if (searchQuery) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }

            // Update filter state
            browseFilters.searchQuery = searchQuery;
            browseFilters.yearFrom = yearFrom;
            browseFilters.yearTo = yearTo;

            // Start with current filter (all/movie/tv)
            let results = [...filteredMovies];

            // Apply content type filter (now-playing, out-this-week, motivation)
            if (browseFilters.contentType === 'now-playing') {
                const currentYear = new Date().getFullYear();
                results = results.filter(m => {
                    if (m.type !== 'movie') return false;
                    const releaseYear = parseInt(m.release_year);
                    return releaseYear >= currentYear - 1 && releaseYear <= currentYear;
                });
            } else if (browseFilters.contentType === 'out-this-week') {
                const currentYear = new Date().getFullYear();
                results = results.filter(m => {
                    const releaseYear = parseInt(m.release_year);
                    return releaseYear === currentYear;
                });
            } else if (browseFilters.contentType === 'coming-soon') {
                // Show all coming soon entries (including those without trailers in browse)
                results = [...allComingSoon];
            } else if (browseFilters.contentType === 'motivation') {
                // Show only motivational videos in browse
                results = [...allMotivationalVideos];
            } else if (browseFilters.contentType === 'movie') {
                results = results.filter(m => m.type === 'movie');
            } else if (browseFilters.contentType === 'tv') {
                results = results.filter(m => m.type === 'tv');
            }

            // Apply search query
            if (searchQuery) {
                results = results.filter(m =>
                    m.title.toLowerCase().includes(searchQuery) ||
                    (m.description && m.description.toLowerCase().includes(searchQuery))
                );
            }

            // Apply genre filter (check both 'genres' and 'genre' fields)
            if (browseFilters.genre !== 'all') {
                results = results.filter(m => {
                    const genreStr = m.genres || m.genre;
                    if (!genreStr) return false;
                    const genres = genreStr.split(',').map(g => g.trim().toLowerCase());
                    return genres.includes(browseFilters.genre.toLowerCase());
                });
            }

            // Apply streaming provider filter
            if (currentProviderFilter !== 'all') {
                results = results.filter(function(m) {
                    if (!m._providers) return false;
                    return m._providers.some(function(p) { return p.id === currentProviderFilter; });
                });
            }

            // Apply year range filter
            if (yearFrom) {
                results = results.filter(m => {
                    const year = parseInt(m.release_year);
                    return !isNaN(year) && year >= yearFrom;
                });
            }

            if (yearTo) {
                results = results.filter(m => {
                    const year = parseInt(m.release_year);
                    return !isNaN(year) && year <= yearTo;
                });
            }

            browseFilteredMovies = results;
            renderBrowseGrid();
        }

        function setContentTypeFilter(type) {
            browseFilters.contentType = type;

            // Update button states
            document.querySelectorAll('[data-type]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            applyBrowseFilters();
        }

        function setGenreFilter(genre) {
            browseFilters.genre = genre;

            // Update button states
            document.querySelectorAll('[data-genre]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-genre="${genre}"]`).classList.add('active');

            applyBrowseFilters();
        }

        function clearSearch() {
            document.getElementById('browseSearchInput').value = '';
            applyBrowseFilters();
        }

        function addToQueueFromBrowseFiltered(movieId) {
            const movie = browseFilteredMovies.find(m => m.id === movieId);

            if (movie && !myQueue.find(m => m.id === movie.id)) {
                myQueue.push(movie);
                localStorage.setItem('movieQueue', JSON.stringify(myQueue));
                document.getElementById('queueCount').textContent = myQueue.length;
                alert(`\u2705 Added "${movie.title}" to queue`);

                // Update queue if it's open
                if (document.getElementById('queuePanel').classList.contains('active')) {
                    renderQueue();
                }
            } else if (movie) {
                alert('Already in queue!');
            }
        }

        function playMovieFromBrowse(index) {
            // Stop ALL currently playing videos first
            document.querySelectorAll('.video-card iframe').forEach(iframe => {
                const currentSrc = iframe.src;
                if (currentSrc && currentSrc.includes('autoplay=1')) {
                    // Remove src to stop playback
                    iframe.src = '';
                    // Restore with autoplay=0 after a tiny delay
                    setTimeout(() => {
                        iframe.src = currentSrc.replace(/autoplay=1/, 'autoplay=0');
                    }, 50);
                }
            });

            // Close browse view
            document.getElementById('browseView').classList.remove('active');

            // Wait for transition, then scroll and trigger playback
            setTimeout(() => {
                const container = document.getElementById('container');
                container.scrollTo({
                    top: index * window.innerHeight,
                    behavior: 'smooth'
                });

                // Use scrollend event for reliable timing (works with DevTools closed)
                const handleScrollEnd = () => {
                    const targetIframe = document.getElementById(`player-${index}`);
                    if (targetIframe) {
                        const currentSrc = targetIframe.src;
                        if (!currentSrc.includes('autoplay=1')) {
                            targetIframe.src = currentSrc.replace(/autoplay=[01]/, 'autoplay=1');
                        }
                    }

                    // Show mute overlay if all videos are muted
                    updateMuteOverlay();
                };

                // Use scrollend event if supported, otherwise fallback to timeout
                if ('onscrollend' in container) {
                    container.addEventListener('scrollend', handleScrollEnd, { once: true });
                } else {
                    setTimeout(handleScrollEnd, 800);
                }
            }, 350);
        }

        function addToQueueFromBrowse(index) {
            const movie = filteredMovies[index];

            if (movie && !myQueue.find(m => m.id === movie.id)) {
                myQueue.push(movie);
                localStorage.setItem('movieQueue', JSON.stringify(myQueue));
                document.getElementById('queueCount').textContent = myQueue.length;
                alert(` Added "${movie.title}" to queue`);

                // Update queue if it's open
                if (document.getElementById('queuePanel').classList.contains('active')) {
                    renderQueue();
                }
            } else if (movie) {
                alert('Already in queue!');
            }
        }

        function addToQueue() {
            const currentIndex = Math.floor(document.getElementById('container').scrollTop / window.innerHeight);
            const movie = filteredMovies[currentIndex];

            if (movie && !myQueue.find(m => m.id === movie.id)) {
                myQueue.push(movie);
                localStorage.setItem('movieQueue', JSON.stringify(myQueue));
                document.getElementById('queueCount').textContent = myQueue.length;
                alert(` Added "${movie.title}" to queue`);
            } else if (movie) {
                alert('Already in queue!');
            }
        }

        function removeFromQueue(id) {
            myQueue = myQueue.filter(m => m.id !== id);
            localStorage.setItem('movieQueue', JSON.stringify(myQueue));
            document.getElementById('queueCount').textContent = myQueue.length;
            renderQueue();
        }

        function renderQueue() {
            const queueContent = document.getElementById('queueContent');
            const upNextSection = document.getElementById('queueUpNext');
            const upNextContent = document.getElementById('queueUpNextContent');

            if (myQueue.length === 0) {
                queueContent.innerHTML = '<p style="opacity: 0.5; text-align: center; padding: 20px;">Your queue is empty<br><small>Click \u2795 to add movies</small></p>';
                upNextSection.style.display = 'none';
                return;
            }

            // Render queue items
            queueContent.innerHTML = myQueue.map(movie => `
                <div class="queue-item">
                    <img src="${movie.thumbnail || 'https://placehold.co/60x90/1a1a1a/666?text=' + encodeURIComponent(movie.title)}" alt="${escapeHtml(movie.title)}" onerror="this.src='https://placehold.co/60x90/1a1a1a/666?text=No+Image'">
                    <div class="queue-item-info">
                        <div class="queue-item-title">${escapeHtml(movie.title)}</div>
                        <div class="queue-item-meta">
                            ${movie.release_year || ''} ${movie.imdb_rating ? '\u2b50 ' + movie.imdb_rating : ''}
                        </div>
                    </div>
                    <button class="queue-item-remove" onclick="removeFromQueue(${movie.id})">\u2716</button>
                </div>
            `).join('');

            // Show "Up Next" - the first item in queue
            if (myQueue.length > 0) {
                const nextMovie = myQueue[0];
                upNextContent.innerHTML = `
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <img src="${nextMovie.thumbnail || 'https://placehold.co/60x90/1a1a1a/666?text=' + encodeURIComponent(nextMovie.title)}" alt="${escapeHtml(nextMovie.title)}" style="width: 50px; height: 75px; object-fit: cover; border-radius: 6px;" onerror="this.src='https://placehold.co/60x90/1a1a1a/666?text=No+Image'">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 14px; margin-bottom: 4px;">${escapeHtml(nextMovie.title)}</div>
                            <div style="font-size: 12px; opacity: 0.7;">${nextMovie.release_year || ''} ${nextMovie.imdb_rating ? '\u2b50 ' + nextMovie.imdb_rating : ''}</div>
                        </div>
                    </div>
                `;
                upNextSection.style.display = 'block';
            } else {
                upNextSection.style.display = 'none';
            }
        }

        async function likeMovie() {
            // Check if user is logged in
            if (!currentUser) {
                showLogin();
                return;
            }

            // Get current video index
            const currentIndex = Math.floor(document.getElementById('container').scrollTop / window.innerHeight);
            const movie = filteredMovies[currentIndex];

            if (!movie) {
                alert(' No video to like');
                return;
            }

            try {
                const response = await fetch('/MOVIESHOWS3/api/like-movie.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ movie_id: movie.id })
                });
                const data = await response.json();

                if (data.success) {
                    // Update local state
                    if (data.is_liked) {
                        if (!userLikes.includes(movie.id)) {
                            userLikes.push(movie.id);
                        }
                        console.log(` Liked "${movie.title}"`);
                    } else {
                        userLikes = userLikes.filter(id => id !== movie.id);
                        console.log(` Unliked "${movie.title}"`);
                    }
                    likeCounts[movie.id] = data.like_count;

                    // Show feedback
                    const message = data.is_liked ? ` Liked "${movie.title}"!` : ` Unliked "${movie.title}"`;
                    alert(message);
                } else {
                    alert(' Failed to like movie');
                }
            } catch (error) {
                console.error('Like error:', error);
                alert(' Network error. Please try again.');
            }
        }

        function shareMovie() {
            // Get current video index
            const currentIndex = Math.floor(document.getElementById('container').scrollTop / window.innerHeight);
            const movie = filteredMovies[currentIndex];

            if (!movie) {
                alert(' No video to share');
                return;
            }

            // Build shareable URL with video index as hash
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}#video=${currentIndex}`;

            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert(` Link copied!\n\n"${movie.title}"\n${shareUrl}`);
            }).catch(() => {
                // Fallback if clipboard API fails
                alert(` Share this link:\n\n"${movie.title}"\n${shareUrl}`);
            });
        }

        // ========== ALT TRAILERS & ALT DESCRIPTION ==========
        let altContentCache = {}; // Cache per movie id/title
        let altTrailerDropdownOpen = false;
        let currentAltMovieKey = null;

        function getAltCacheKey(movie) {
            if (movie.tmdb_id) return 'tmdb_' + movie.tmdb_id;
            return 'title_' + movie.title + '_' + (movie.release_year || '');
        }

        async function fetchAltContent(movie) {
            const cacheKey = getAltCacheKey(movie);
            if (altContentCache[cacheKey]) return altContentCache[cacheKey];

            const apiBase = window.location.pathname.replace(/\/[^/]*$/, '');
            let url = apiBase + '/api/alt-content.php?';
            const type = movie.type === 'tv' ? 'tv' : 'movie';

            if (movie.tmdb_id) {
                url += 'tmdb_id=' + movie.tmdb_id + '&type=' + type;
            } else {
                url += 'title=' + encodeURIComponent(movie.title) + '&type=' + type;
                if (movie.release_year) url += '&year=' + movie.release_year;
            }

            const resp = await fetch(url);
            const data = await resp.json();

            if (data.success) {
                altContentCache[cacheKey] = data;
            }
            return data;
        }

        // Called when user scrolls to a new video  check if alt trailers available
        function updateAltTrailerButton() {
            const currentIndex = Math.floor(document.getElementById('container').scrollTop / window.innerHeight);
            const movie = filteredMovies[currentIndex];
            const btn = document.getElementById('altTrailerBtn');
            const countEl = document.getElementById('altTrailerCount');

            // Hide dropdown on scroll
            document.getElementById('altTrailerDropdown').classList.remove('active');
            altTrailerDropdownOpen = false;

            if (!movie || movie._isMotivation) {
                btn.classList.add('hidden-btn');
                return;
            }

            // If we already have cached data, show the button immediately
            const cacheKey = getAltCacheKey(movie);
            if (altContentCache[cacheKey] && altContentCache[cacheKey].video_count > 1) {
                btn.classList.remove('hidden-btn');
                countEl.textContent = altContentCache[cacheKey].video_count;
                countEl.style.display = 'flex';
                currentAltMovieKey = cacheKey;
                return;
            }

            // Otherwise, fetch in background (show button optimistically for DB movies)
            if (movie.tmdb_id || (!movie._isComingSoon && movie.id)) {
                btn.classList.remove('hidden-btn');
                countEl.style.display = 'none';
                currentAltMovieKey = cacheKey;

                fetchAltContent(movie).then(data => {
                    // Only update if user hasn't scrolled away
                    const newIndex = Math.floor(document.getElementById('container').scrollTop / window.innerHeight);
                    if (newIndex !== currentIndex) return;

                    if (data && data.success && data.video_count > 1) {
                        countEl.textContent = data.video_count;
                        countEl.style.display = 'flex';
                    } else if (data && data.success && data.video_count <= 1) {
                        btn.classList.add('hidden-btn');
                    }
                }).catch(() => {
                    btn.classList.add('hidden-btn');
                });
            } else {
                btn.classList.add('hidden-btn');
            }
        }

        function toggleAltTrailers() {
            const dropdown = document.getElementById('altTrailerDropdown');
            altTrailerDropdownOpen = !altTrailerDropdownOpen;

            if (!altTrailerDropdownOpen) {
                dropdown.classList.remove('active');
                return;
            }

            const currentIndex = Math.floor(document.getElementById('container').scrollTop / window.innerHeight);
            const movie = filteredMovies[currentIndex];
            if (!movie) return;

            const cacheKey = getAltCacheKey(movie);
            const data = altContentCache[cacheKey];

            if (!data || !data.videos || data.videos.length === 0) {
                dropdown.innerHTML = '<div class="alt-trailer-dropdown-title">Loading...</div>';
                dropdown.classList.add('active');
                fetchAltContent(movie).then(d => {
                    if (d && d.success) renderAltTrailerDropdown(d.videos, movie.trailer_id, currentIndex);
                    else dropdown.innerHTML = '<div class="alt-trailer-dropdown-title">No trailers found</div>';
                });
                return;
            }

            renderAltTrailerDropdown(data.videos, movie.trailer_id, currentIndex);
            dropdown.classList.add('active');
        }

        function renderAltTrailerDropdown(videos, currentTrailerId, movieIndex) {
            const dropdown = document.getElementById('altTrailerDropdown');

            let html = '<div class="alt-trailer-dropdown-title">Available Videos (' + videos.length + ')</div>';
            videos.forEach((v, i) => {
                const isActive = v.key === currentTrailerId;
                const typeClass = v.type.toLowerCase() === 'trailer' ? 'alt-type-trailer'
                    : v.type.toLowerCase() === 'teaser' ? 'alt-type-teaser'
                    : v.type.toLowerCase() === 'clip' ? 'alt-type-clip'
                    : 'alt-type-other';

                html += `
                    <div class="alt-trailer-item ${isActive ? 'active-trailer' : ''}" onclick="switchTrailer(${movieIndex}, '${v.key}')">
                        <img class="alt-trailer-item-thumb" src="https://img.youtube.com/vi/${v.key}/default.jpg" alt="" onerror="this.style.background='#333'">
                        <div class="alt-trailer-item-info">
                            <div class="alt-trailer-item-name" title="${escapeHtml(v.name)}">${escapeHtml(v.name)}</div>
                            <div class="alt-trailer-item-type">${v.official ? 'Official' : ''} ${escapeHtml(v.type)}</div>
                        </div>
                        <span class="alt-trailer-item-badge ${typeClass}">${escapeHtml(v.type)}</span>
                    </div>`;
            });
            dropdown.innerHTML = html;
        }

        function switchTrailer(movieIndex, newTrailerKey) {
            const movie = filteredMovies[movieIndex];
            if (!movie) return;

            // Update the movie's trailer_id
            movie.trailer_id = newTrailerKey;

            // Update the iframe src
            const iframe = document.getElementById('player-' + movieIndex);
            if (iframe) {
                const isMuted = videoMuteStates[movieIndex] !== false ? 1 : 0;
                iframe.src = `https://www.youtube.com/embed/${newTrailerKey}?autoplay=1&mute=${isMuted}&controls=1&playsinline=1&loop=0&modestbranding=1&rel=0&enablejsapi=1`;
            }

            // Close dropdown
            document.getElementById('altTrailerDropdown').classList.remove('active');
            altTrailerDropdownOpen = false;

            // Update active state - re-render dropdown next time
            const cacheKey = getAltCacheKey(movie);
            if (altContentCache[cacheKey]) {
                // Already cached, just note the switch
                console.log(` Switched to alternate trailer: ${newTrailerKey}`);
            }
        }

        // Alt description
        let altDescStates = {}; // Track which descriptions are showing alt

        async function loadAltDescription(movieIndex) {
            const movie = filteredMovies[movieIndex];
            if (!movie) return;

            const descEl = document.getElementById('movie-desc-' + movieIndex);
            const linkEl = document.getElementById('alt-desc-' + movieIndex);
            if (!descEl) return;

            const stateKey = 'desc_' + movieIndex;

            // If already showing alt, toggle back to original
            if (altDescStates[stateKey]) {
                descEl.innerHTML = escapeHtml(movie.description) +
                    `<span class="alt-desc-link" id="alt-desc-${movieIndex}" onclick="event.stopPropagation(); loadAltDescription(${movieIndex})" title="Load alternative description from TMDB">alt desc</span>`;
                altDescStates[stateKey] = false;
                return;
            }

            // Show loading
            if (linkEl) {
                linkEl.outerHTML = '<span class="alt-desc-loading"></span>';
            }

            try {
                const data = await fetchAltContent(movie);
                if (data && data.success && data.alt_description) {
                    altDescStates[stateKey] = true;
                    let altText = '';
                    if (data.tagline) {
                        altText = '"' + data.tagline + '"  ';
                    }
                    altText += data.alt_description;

                    descEl.innerHTML = escapeHtml(altText) +
                        `<span class="alt-desc-link" id="alt-desc-${movieIndex}" onclick="event.stopPropagation(); loadAltDescription(${movieIndex})" title="Switch back to original description" style="color:#4ade80;">original</span>`;
                } else {
                    descEl.innerHTML = escapeHtml(movie.description) +
                        `<span class="alt-desc-link" style="color:rgba(255,255,255,0.3); cursor:default;" title="No alternative description available">no alt</span>`;
                }
            } catch (err) {
                descEl.innerHTML = escapeHtml(movie.description) +
                    `<span class="alt-desc-link" id="alt-desc-${movieIndex}" onclick="event.stopPropagation(); loadAltDescription(${movieIndex})" title="Try again">retry</span>`;
            }
        }

        // Close alt dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (altTrailerDropdownOpen && !e.target.closest('.alt-trailer-dropdown') && !e.target.closest('.alt-trailer-btn')) {
                document.getElementById('altTrailerDropdown').classList.remove('active');
                altTrailerDropdownOpen = false;
            }
        });

        function renderQueue() {
            const content = document.getElementById('queueContent');
            document.getElementById('queueCount').textContent = myQueue.length;

            if (myQueue.length === 0) {
                content.innerHTML = '<p style="opacity: 0.5; text-align: center; padding: 20px;">Your queue is empty<br><small>Click  to add movies</small></p>';
                return;
            }

            content.innerHTML = myQueue.map(movie => `
                <div class="queue-item">
                    <img src="${movie.thumbnail || 'https://placehold.co/60x90/1a1a1a/666?text=No+Image'}" alt="${escapeHtml(movie.title)}" onclick="playMovie(${movie.id})" onerror="this.src='https://placehold.co/60x90/1a1a1a/666?text=No+Image'">
                    <div class="queue-item-info" onclick="playMovie(${movie.id})">
                        <div class="queue-item-title">${escapeHtml(movie.title)}</div>
                        <div class="queue-item-meta">
                            ${movie.release_year || ''} ${movie.imdb_rating ? ' ' + movie.imdb_rating : ''}
                        </div>
                    </div>
                    <button class="queue-item-remove" onclick="event.stopPropagation(); removeFromQueue(${movie.id})"></button>
                </div>
            `).join('');
        }

        function playMovie(id) {
            const index = filteredMovies.findIndex(m => m.id === id);
            if (index !== -1) {
                document.getElementById('container').scrollTo({
                    top: index * window.innerHeight,
                    behavior: 'smooth'
                });
                toggleQueue();
            }
        }

        async function loadMovies() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load movies');
                }

                if (!data.movies || data.movies.length === 0) {
                    throw new Error('No movies with trailers found');
                }

                allMovies = data.movies;

                // Build motivational videos, now playing, and coming soon lists
                loadMotivationSettings();
                buildMotivationalVideos();
                buildNowPlayingList();
                buildComingSoonList();

                // Determine what goes in the "All" feed
                if (motivationSettings.showInAll) {
                    filteredMovies = [...allMovies, ...allMotivationalVideos];
                } else {
                    filteredMovies = [...allMovies];
                }

                // Update counts
                const movieCount = allMovies.filter(m => m.type === 'movie').length;
                const tvCount = allMovies.filter(m => m.type === 'tv').length;

                document.getElementById('countAll').textContent = allMovies.length;
                document.getElementById('countMovies').textContent = movieCount;
                document.getElementById('countTV').textContent = tvCount;
                document.getElementById('countMotivation').textContent = allMotivationalVideos.length;
                document.getElementById('countComingSoon').textContent = allComingSoon.length;
                document.getElementById('queueCount').textContent = myQueue.length;

                renderMovies(filteredMovies);
                // Init alt trailer button for first video
                setTimeout(updateAltTrailerButton, 1000);
                console.log(`\u2705 Loaded ${allMovies.length} movies + ${allMotivationalVideos.length} motivational + ${allComingSoon.length} coming soon`);

                // Pre-fetch streaming provider data in background (non-blocking)
                setTimeout(function() {
                    if (!providerDataLoaded && !providerLoadingInProgress) {
                        fetchAllProviderData().then(function() {
                            // Re-render browse grid if open
                            if (document.getElementById('browseView').classList.contains('active')) {
                                renderBrowseGrid();
                            }
                        });
                    }
                }, 3000);
            } catch (error) {
                console.error('Error loading movies:', error);
                // Still build motivational videos even if movie API fails
                loadMotivationSettings();
                buildMotivationalVideos();
                document.getElementById('countMotivation').textContent = allMotivationalVideos.length;

                if (allMotivationalVideos.length > 0) {
                    // Show motivation content as fallback
                    filteredMovies = [...allMotivationalVideos];
                    currentFilter = 'motivation';
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    const motBtn = document.getElementById('filterMotivation');
                    if (motBtn) motBtn.classList.add('active');
                    renderMovies(filteredMovies);
                    console.log(` Movie API failed, showing ${allMotivationalVideos.length} motivational videos as fallback`);
                } else {
                    document.getElementById('container').innerHTML = `
                        <div class="error">
                            <div class="error-icon"></div>
                            <h2>Error Loading Movies</h2>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function renderMovies(movies) {
            var container = document.getElementById('container');
            container.innerHTML = '';

            // Reset per-video mute states and player instances when re-rendering
            videoMuteStates = {};
            ytPlayers = {};
            loadedIframes = new Set();

            // Destroy old lazy observer
            if (lazyObserver) {
                lazyObserver.disconnect();
                lazyObserver = null;
            }

            movies.forEach(function(movie, index) {
                var card = createMovieCard(movie, index);
                container.appendChild(card);
            });

            // Setup lazy loading observer for iframes
            setupLazyLoading();

            // Update mute overlay to reflect current state
            updateMuteOverlay();
        }

        function setupLazyLoading() {
            var options = {
                root: null,
                rootMargin: '200% 0px', // Pre-load when 2 screens away
                threshold: 0
            };

            lazyObserver = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    var card = entry.target;
                    var index = parseInt(card.dataset.index);

                    if (entry.isIntersecting) {
                        // Card is near viewport - load iframe if not loaded
                        if (!loadedIframes.has(index)) {
                            activateIframe(card, index);
                        }
                    } else {
                        // Card is far from viewport - unload iframe to free memory
                        // But keep a generous buffer
                        if (loadedIframes.has(index)) {
                            var rect = card.getBoundingClientRect();
                            var distance = Math.abs(rect.top) / window.innerHeight;
                            if (distance > 4) {
                                deactivateIframe(card, index);
                            }
                        }
                    }
                });
            }, options);

            document.querySelectorAll('.video-card').forEach(function(card) {
                lazyObserver.observe(card);
            });
        }

        function activateIframe(card, index) {
            var placeholder = card.querySelector('.video-placeholder');
            if (!placeholder) return;

            var trailerId = placeholder.dataset.trailerId;
            if (!trailerId) return;

            loadedIframes.add(index);

            var muteVal = (userEnabledSound || videoMuteStates[index] === false) ? 0 : 1;
            var autoplayValue = 0; // Scroll autoplay will handle playing
            var youtubeUrl = 'https://www.youtube.com/embed/' + trailerId +
                '?autoplay=' + autoplayValue + '&mute=' + muteVal +
                '&controls=1&playsinline=1&loop=0&modestbranding=1&rel=0&enablejsapi=1&origin=' + window.location.origin;

            var wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';
            wrapper.innerHTML =
                '<iframe id="player-' + index + '" ' +
                'src="' + youtubeUrl + '" ' +
                'allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ' +
                'allowfullscreen></iframe>' +
                '<button class="unmute-btn" onclick="toggleMute(' + index + ')" title="Toggle Mute">' +
                (muteVal ? '' : '') + '</button>';

            placeholder.replaceWith(wrapper);
        }

        function deactivateIframe(card, index) {
            var wrapper = card.querySelector('.video-wrapper');
            if (!wrapper) return;

            // Clean up YT player
            if (ytPlayers[index]) {
                try { ytPlayers[index].destroy(); } catch(e) {}
                delete ytPlayers[index];
            }

            var movie = filteredMovies[index];
            if (!movie) return;

            loadedIframes.delete(index);

            var posterUrl = movie.thumbnail || 'https://placehold.co/1280x720/1a1a2e/e2e8f0?text=' + encodeURIComponent(movie.title);
            var ph = document.createElement('div');
            ph.className = 'video-placeholder';
            ph.dataset.trailerId = movie.trailer_id;
            ph.innerHTML = '<img src="' + posterUrl + '" alt="' + escapeHtml(movie.title) + '" ' +
                'onerror="this.style.display=\'none\'">' +
                '<div class="play-icon"></div>';

            wrapper.replaceWith(ph);
        }

        function createMovieCard(movie, index) {
            const card = document.createElement('div');
            card.className = 'video-card';
            card.dataset.index = index;

            const isMotivation = movie._isMotivation;
            const isComingSoon = movie._isComingSoon;
            const hasTrailer = !!movie.trailer_id;

            // Build meta badges
            let metaBadges = '';
            if (isMotivation) {
                metaBadges += `<span class="motivation-badge">MOTIVATION</span>`;
                metaBadges += `<span class="motivation-channel-badge">${escapeHtml(movie._channel)}</span>`;
                if (movie._duration) {
                    metaBadges += `<span class="meta-badge">${movie._duration}</span>`;
                }
                if (movie._isShort) {
                    metaBadges += `<span class="meta-badge">SHORT</span>`;
                }
            } else if (isComingSoon) {
                metaBadges += `<span class="coming-soon-badge">COMING SOON</span>`;
                metaBadges += `<span class="coming-soon-date-badge">${movie._releaseDateStr}</span>`;
                metaBadges += `<span class="coming-soon-venue-badge">${escapeHtml(movie._venue)}</span>`;
                if (movie.type) metaBadges += `<span class="meta-badge">${movie.type.toUpperCase()}</span>`;
            } else {
                if (movie.release_year) metaBadges += `<span class="meta-badge">${movie.release_year}</span>`;
                if (movie.imdb_rating) metaBadges += `<span class="meta-badge">\u2b50 ${movie.imdb_rating}</span>`;
                if (movie.type) metaBadges += `<span class="meta-badge">${movie.type.toUpperCase()}</span>`;
                // Now Playing badge for current-year movies
                if (movie.type === 'movie') {
                    const yr = parseInt(movie.release_year);
                    const currentYr = new Date().getFullYear();
                    if (yr >= currentYr - 1 && yr <= currentYr) {
                        metaBadges += `<span class="now-playing-badge">NOW PLAYING</span>`;
                    }
                }
            }

            var videoContent;
            if (hasTrailer) {
                // Use lazy placeholder - iframe will be loaded by IntersectionObserver
                var posterUrl = movie.thumbnail || 'https://placehold.co/1280x720/1a1a2e/e2e8f0?text=' + encodeURIComponent(movie.title);
                // First 2 cards get immediate iframes for fast initial load
                if (index < 2) {
                    var muteVal = userEnabledSound ? 0 : 1;
                    var autoplayValue = index === 0 ? 1 : 0;
                    var youtubeUrl = 'https://www.youtube.com/embed/' + movie.trailer_id +
                        '?autoplay=' + autoplayValue + '&mute=' + muteVal +
                        '&controls=1&playsinline=1&loop=0&modestbranding=1&rel=0&enablejsapi=1&origin=' + window.location.origin;
                    videoContent =
                        '<div class="video-wrapper">' +
                        '<iframe id="player-' + index + '" src="' + youtubeUrl + '" ' +
                        'allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ' +
                        'allowfullscreen></iframe>' +
                        '<button class="unmute-btn" onclick="toggleMute(' + index + ')" title="Toggle Mute">' +
                        (muteVal ? '' : '') + '</button></div>';
                    loadedIframes.add(index);
                } else {
                    videoContent =
                        '<div class="video-placeholder" data-trailer-id="' + movie.trailer_id + '">' +
                        '<img src="' + posterUrl + '" alt="' + escapeHtml(movie.title) + '" ' +
                        'onerror="this.style.display=\'none\'">' +
                        '<div class="play-icon"></div></div>';
                }
            } else {
                var noTrailerPoster = movie.thumbnail || 'https://placehold.co/1280x720/1a1a2e/e2e8f0?text=' + encodeURIComponent(movie.title);
                videoContent =
                    '<div class="video-wrapper" style="position: relative; background: #0a0a1a;">' +
                    '<img src="' + noTrailerPoster + '" alt="' + escapeHtml(movie.title) + '" ' +
                    'style="width: 100%; height: 100%; object-fit: cover; opacity: 0.6;" ' +
                    'onerror="this.style.display=\'none\'">' +
                    '<div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">' +
                    '<div style="font-size: 48px;"></div>' +
                    '<div style="font-size: 16px; font-weight: 700; color: rgba(255,255,255,0.9);">Trailer Coming Soon</div>' +
                    '<div style="font-size: 13px; color: rgba(255,255,255,0.5);">' + (movie._releaseDateStr || '') + '</div>' +
                    '</div></div>';
            }

            const altDescId = `alt-desc-${index}`;
            const isDbMovie = !isMotivation && !isComingSoon && movie.id;
            const altDescLink = isDbMovie
                ? `<span class="alt-desc-link" id="${altDescId}" onclick="event.stopPropagation(); loadAltDescription(${index})" title="Load alternative description from TMDB">alt desc</span>`
                : '';

            card.innerHTML = `
                ${videoContent}
                <div class="info-overlay">
                    <div class="movie-title">${escapeHtml(movie.title)}</div>
                    <div class="movie-meta">
                        ${metaBadges}
                    </div>
                    ${movie.description ? `<div class="movie-description" id="movie-desc-${index}">${escapeHtml(movie.description)}${altDescLink}</div>` : ''}
                    ${movie._providers && movie._providers.length > 0 ? `
                        <div class="provider-badges">
                            ${movie._providers.slice(0, 5).map(function(p) {
                                return '<img class="provider-badge" src="' + p.logo + '" alt="' + p.name + '" title="' + p.name + '">';
                            }).join('')}
                        </div>
                    ` : ''}
                    ${movie.genre ? `
                        <div class="genre-tags">
                            ${movie.genre.split(',').map(g => `<span class="genre-tag">${escapeHtml(g.trim())}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            return card;
        }

        let videoMuteStates = {}; // Track mute state per video
        let hasUserInteracted = false;
        let userEnabledSound = false; // Track if user globally enabled sound

        function startPlayback(index) {
            hasUserInteracted = true;
            const overlay = document.getElementById(`play-overlay-${index}`);
            if (overlay) {
                overlay.classList.remove('visible');
                setTimeout(() => overlay.remove(), 300);
            }

            // Reload iframe to trigger autoplay
            const iframe = document.getElementById(`player-${index}`);
            if (iframe) {
                iframe.src = iframe.src;
            }
        }

        function toggleMute(index) {
            // Toggle mute state for this specific video
            var currentMuteState = videoMuteStates[index] !== undefined ? videoMuteStates[index] : true;
            videoMuteStates[index] = !currentMuteState;

            var playerEl = document.getElementById('player-' + index);
            if (!playerEl) return;
            var btn = playerEl.parentElement.querySelector('.unmute-btn');
            if (btn) btn.textContent = videoMuteStates[index] ? '' : '';

            // Use YouTube IFrame API postMessage for mute/unmute (no src reload)
            // This fixes Meta Quest 3 where iframe src reloads jam the player
            if (ytPlayers[index]) {
                try {
                    if (videoMuteStates[index]) {
                        ytPlayers[index].mute();
                    } else {
                        ytPlayers[index].unMute();
                        ytPlayers[index].playVideo();
                    }
                } catch(e) {
                    // Fallback: use postMessage directly
                    sendYTCommand(playerEl, videoMuteStates[index] ? 'mute' : 'unMute');
                }
            } else {
                // No YT player instance yet - use postMessage
                sendYTCommand(playerEl, videoMuteStates[index] ? 'mute' : 'unMute');
                if (!videoMuteStates[index]) {
                    sendYTCommand(playerEl, 'playVideo');
                }
            }

            // Update overlay visibility
            updateMuteOverlay();
        }

        function sendYTCommand(iframe, command) {
            try {
                iframe.contentWindow.postMessage(JSON.stringify({
                    event: 'command',
                    func: command,
                    args: []
                }), '*');
            } catch(e) {
                // Cross-origin fallback - only use src swap as last resort
                console.warn('postMessage failed, using src fallback for', command);
                if (command === 'mute' || command === 'unMute') {
                    var muteVal = command === 'mute' ? 1 : 0;
                    var currentUrl = iframe.src;
                    iframe.src = currentUrl.replace(/mute=[01]/, 'mute=' + muteVal);
                }
            }
        }

        function enableSound() {
            // Mark that user wants sound globally (persists across category switches)
            userEnabledSound = true;

            // Unmute all loaded videos using YouTube API (no iframe src reload)
            document.querySelectorAll('#container iframe').forEach(function(iframe) {
                var idMatch = iframe.id.match(/player-(\d+)/);
                if (!idMatch) return;
                var idx = parseInt(idMatch[1]);
                videoMuteStates[idx] = false;

                // Use YT player API if available, otherwise postMessage
                if (ytPlayers[idx]) {
                    try {
                        ytPlayers[idx].unMute();
                        ytPlayers[idx].setVolume(100);
                    } catch(e) {
                        sendYTCommand(iframe, 'unMute');
                    }
                } else {
                    sendYTCommand(iframe, 'unMute');
                }

                var btn = iframe.parentElement.querySelector('.unmute-btn');
                if (btn) btn.textContent = '';
            });

            // Hide the mute overlay and persistent button
            document.getElementById('muteOverlay').classList.add('hidden');
            document.getElementById('persistentUnmuteBtn').classList.add('hidden');
        }

        function showMuteOverlay() {
            // Show the mute overlay modal
            document.getElementById('muteOverlay').classList.remove('hidden');
            document.getElementById('persistentUnmuteBtn').classList.remove('hidden');
        }

        function updateMuteOverlay() {
            // Check if any video is unmuted
            const anyUnmuted = Object.values(videoMuteStates).some(state => state === false);

            if (anyUnmuted) {
                // Hide overlay if any video is unmuted
                document.getElementById('muteOverlay').classList.add('hidden');
                document.getElementById('persistentUnmuteBtn').classList.add('hidden');
            } else {
                // Show overlay if all videos are muted
                showMuteOverlay();
            }
        }

        // Keyboard shortcut: M key to enable sound
        document.addEventListener('keydown', (e) => {
            if (e.key === 'm' || e.key === 'M') {
                enableSound();
            }
        });

        // Show mute overlay on page load after a short delay
        setTimeout(() => {
            showMuteOverlay();
        }, 1000);

        // Intersection Observer for autoplay on scroll (works with lazy loading)
        function setupScrollAutoplay() {
            var options = {
                root: null,
                rootMargin: '0px',
                threshold: 0.75
            };

            var currentlyPlaying = null;

            var observer = new IntersectionObserver(function(entries) {
                var mostVisible = null;
                var highestRatio = 0;

                entries.forEach(function(entry) {
                    if (entry.isIntersecting && entry.intersectionRatio >= 0.75) {
                        if (entry.intersectionRatio > highestRatio) {
                            highestRatio = entry.intersectionRatio;
                            mostVisible = entry;
                        }
                    }
                });

                if (mostVisible) {
                    var card = mostVisible.target;
                    var index = card.dataset.index;
                    var iframe = card.querySelector('iframe');

                    // If card has a placeholder, activate the iframe first
                    if (!iframe && card.querySelector('.video-placeholder')) {
                        activateIframe(card, parseInt(index));
                        // Wait for iframe to load before playing
                        setTimeout(function() {
                            var newIframe = card.querySelector('iframe');
                            if (newIframe && currentlyPlaying !== index) {
                                playVideoAtIndex(index, newIframe, currentlyPlaying === null);
                                currentlyPlaying = index;
                            }
                        }, 500);
                        return;
                    }

                    if (iframe && currentlyPlaying !== index) {
                        playVideoAtIndex(index, iframe, currentlyPlaying === null);
                        currentlyPlaying = index;
                    }
                }
            }, options);

            document.querySelectorAll('.video-card').forEach(function(card) {
                observer.observe(card);
            });

            // Force play first video after short delay
            setTimeout(function() {
                if (currentlyPlaying !== null) return;
                var firstCard = document.querySelector('.video-card');
                if (firstCard) {
                    var firstIframe = firstCard.querySelector('iframe');
                    if (firstIframe) {
                        console.log('Force playing first video');
                        currentlyPlaying = '0';
                        initYouTubePlayer(0);
                    }
                }
            }, 1000);
        }

        function playVideoAtIndex(index, iframe, isInitialLoad) {
            console.log('Playing video ' + index);

            // PAUSE all other videos using YT API (no src replacement!)
            document.querySelectorAll('.video-card').forEach(function(card) {
                var cardIndex = card.dataset.index;
                if (cardIndex !== index) {
                    var ci = parseInt(cardIndex);
                    if (ytPlayers[ci]) {
                        try { ytPlayers[ci].pauseVideo(); } catch(e) {}
                    } else {
                        var cardIframe = card.querySelector('iframe');
                        if (cardIframe) {
                            sendYTCommand(cardIframe, 'pauseVideo');
                        }
                    }
                }
            });

            // PLAY the new video using YT API
            if (ytPlayers[parseInt(index)]) {
                try {
                    ytPlayers[parseInt(index)].playVideo();
                } catch(e) {
                    sendYTCommand(iframe, 'playVideo');
                }
            } else {
                // Use postMessage to start, and init YT player
                sendYTCommand(iframe, 'playVideo');
                if (typeof YT !== 'undefined' && YT.Player) {
                    initYouTubePlayer(parseInt(index));
                }
            }

            // Update alt trailer button
            updateAltTrailerButton();
        }


        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load YouTube IFrame API
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // YouTube API ready callback
        window.onYouTubeIframeAPIReady = function () {
            console.log(' YouTube IFrame API loaded');
        };

        // Handle URL hash navigation (for shared video links)
        function handleUrlHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#video=')) {
                const videoIndex = parseInt(hash.replace('#video=', ''));
                if (!isNaN(videoIndex) && videoIndex >= 0 && videoIndex < filteredMovies.length) {
                    console.log(` Navigating to shared video ${videoIndex}`);
                    setTimeout(() => {
                        const container = document.getElementById('container');
                        container.scrollTo({
                            top: videoIndex * window.innerHeight,
                            behavior: 'smooth'
                        });

                        // Trigger autoplay after scroll
                        setTimeout(() => {
                            const targetIframe = document.getElementById(`player-${videoIndex}`);
                            if (targetIframe) {
                                const currentSrc = targetIframe.src;
                                if (!currentSrc.includes('autoplay=1')) {
                                    targetIframe.src = currentSrc.replace(/autoplay=[01]/, 'autoplay=1');
                                }
                            }
                            updateMuteOverlay();
                        }, 1000);
                    }, 500);
                }
            }
        }

        // Detect Quest / VR headset and show banner
        (function detectQuest() {
            var ua = navigator.userAgent || '';
            var isQuest = /OculusBrowser|Quest|Pacific/i.test(ua);
            var isXR = /XR|VR|Pico|HTC Vive|Oculus/i.test(ua);
            if ((isQuest || isXR) && localStorage.getItem('ms3_dismissQuest') !== '1') {
                var banner = document.getElementById('questBanner');
                if (banner) banner.style.display = 'block';
            }
        })();

        // Load movies and setup autoplay
        loadMovies().then(async () => {
            setupScrollAutoplay();
            loadAutoScrollSettings();  // Load auto-scroll settings from localStorage
            loadMotivationSettings(); // Load motivation settings from localStorage
            loadSkipWatchedSettings(); // Load skip-watched settings from localStorage
            handleUrlHash();  // Handle shared video links
            await checkSession();  // Check if user is logged in
            await loadWatchHistory(); // Load watch history after session is confirmed
        });
    </script>
</body>

</html>