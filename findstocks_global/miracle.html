<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DayTraders Miracle Cursor | Claude-Generated Stock Scanner</title>
    <style>
        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #12122a;
            --bg-card-hover: #1a1a3a;
            --border: #2a2a4a;
            --text: #e0e0f0;
            --text-dim: #8888aa;
            --accent: #6366f1;
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234, 179, 8, 0.15);
            --blue: #3b82f6;
            --gold: #f59e0b;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; line-height: 1.5; }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .header { background: linear-gradient(135deg, #12122a 0%, #1e1e3f 100%); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        .header h1 { font-size: 1.5rem; background: linear-gradient(135deg, var(--gold), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header .subtitle { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.1rem; }
        .header-links { display: flex; gap: 1rem; font-size: 0.85rem; }
        .header-links a { color: var(--text-dim); }
        .header-links a:hover { color: var(--text); }

        .container { max-width: 1300px; margin: 0 auto; padding: 1.5rem; }

        /* Summary stats */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; text-align: center; }
        .stat-card .val { font-size: 1.6rem; font-weight: 800; }
        .stat-card .lbl { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }

        .section-title { font-size: 1.2rem; font-weight: 700; margin: 1.5rem 0 0.75rem; display: flex; align-items: center; gap: 0.6rem; }
        .section-title .badge { font-size: 0.6rem; padding: 0.15rem 0.5rem; border-radius: 99px; background: var(--accent); color: white; font-weight: 700; text-transform: uppercase; }

        /* Action buttons */
        .actions { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .btn { padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); color: var(--text); cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .btn:hover { border-color: var(--accent); background: var(--bg-card-hover); }
        .btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .btn.btn-green { border-color: var(--green); color: var(--green); }
        .btn.btn-green:hover { background: var(--green-dim); }

        /* Pick cards */
        .picks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 0.75rem; }
        .pick-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; transition: all 0.2s; position: relative; overflow: hidden; }
        .pick-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 6px 24px rgba(0,0,0,0.3); }
        .pick-card.cdr { border-left: 3px solid var(--gold); }
        .pick-card.non-cdr { border-left: 3px solid var(--blue); }

        .pick-rank { position: absolute; top: 0.6rem; right: 0.6rem; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; background: var(--border); color: var(--text-dim); }
        .pick-rank.gold { background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; }
        .pick-rank.silver { background: linear-gradient(135deg, #9ca3af, #6b7280); color: #000; }
        .pick-rank.bronze { background: linear-gradient(135deg, #b45309, #92400e); color: #fff; }

        .pick-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.6rem; }
        .pick-ticker { font-size: 1.1rem; font-weight: 800; }
        .pick-name { font-size: 0.7rem; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
        .conf-badge { font-size: 0.55rem; font-weight: 800; padding: 0.1rem 0.4rem; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.03em; }
        .conf-badge.extremely-strong { background: rgba(34,197,94,0.25); color: #22c55e; }
        .conf-badge.very-strong { background: rgba(34,197,94,0.15); color: #22c55e; }
        .conf-badge.strong { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .conf-badge.okay { background: rgba(234,179,8,0.15); color: #eab308; }
        .conf-badge.weak { background: rgba(239,68,68,0.1); color: #ef4444; }

        .pick-prices { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem; margin: 0.6rem 0; }
        .price-item { text-align: center; }
        .price-item .lbl { font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.04em; }
        .price-item .val { font-size: 0.9rem; font-weight: 700; }
        .val-green { color: var(--green); }
        .val-red { color: var(--red); }
        .val-gold { color: var(--gold); }

        .pick-meta { display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; border-top: 1px solid var(--border); font-size: 0.7rem; color: var(--text-dim); flex-wrap: wrap; gap: 0.3rem; }
        .strat-badge { font-size: 0.6rem; padding: 0.1rem 0.35rem; background: rgba(99,102,241,0.15); color: var(--accent); border-radius: 4px; }
        .cdr-tag { font-size: 0.55rem; padding: 0.1rem 0.3rem; background: rgba(245,158,11,0.2); color: var(--gold); border-radius: 4px; font-weight: 700; }
        .fee-tag { font-size: 0.55rem; color: var(--text-dim); }

        .score-bar { display: inline-flex; align-items: center; gap: 0.3rem; }
        .mini-bar { width: 45px; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .mini-fill { height: 100%; border-radius: 3px; }
        .mini-fill.high { background: var(--green); }
        .mini-fill.mid { background: var(--yellow); }
        .mini-fill.low { background: var(--red); }

        /* Leaderboard table */
        .lb-wrap { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 1.5rem; }
        .lb-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .lb-table th { background: #1a1a3a; padding: 0.6rem 0.8rem; text-align: left; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); border-bottom: 1px solid var(--border); }
        .lb-table td { padding: 0.5rem 0.8rem; border-bottom: 1px solid rgba(42,42,74,0.5); font-size: 0.8rem; }
        .lb-table tr:hover { background: var(--bg-card-hover); }

        .loading { text-align: center; padding: 3rem; color: var(--text-dim); }
        .spinner { display: inline-block; width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .disclaimer { text-align: center; font-size: 0.65rem; color: var(--text-dim); padding: 2rem 1rem; border-top: 1px solid var(--border); margin-top: 2rem; }

        .status-msg { padding: 0.5rem 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.8rem; }
        .status-msg.success { background: var(--green-dim); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
        .status-msg.error { background: var(--red-dim); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }

        /* ── Budget Picker ── */
        .budget-section { background: linear-gradient(135deg, #12122a, #1e1e3f); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; }
        .budget-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .budget-header h2 { font-size: 1.1rem; font-weight: 700; }
        .budget-header .badge-new { font-size: 0.55rem; padding: 0.15rem 0.5rem; border-radius: 99px; background: var(--green); color: #000; font-weight: 800; text-transform: uppercase; }

        .budget-form { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
        .budget-field { display: flex; flex-direction: column; gap: 0.35rem; }
        .budget-field label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.04em; }
        .budget-input { background: var(--bg-dark); border: 1px solid var(--border); color: var(--text); padding: 0.6rem 0.8rem; border-radius: 8px; font-size: 1.1rem; font-weight: 700; width: 180px; outline: none; transition: border-color 0.2s; }
        .budget-input:focus { border-color: var(--accent); }
        .budget-input::placeholder { color: var(--text-dim); font-weight: 400; font-size: 0.85rem; }

        .tf-group { display: flex; gap: 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .tf-btn { padding: 0.55rem 0.75rem; background: var(--bg-dark); color: var(--text-dim); border: none; cursor: pointer; font-size: 0.72rem; font-weight: 600; white-space: nowrap; transition: all 0.2s; position: relative; }
        .tf-btn:not(:last-child) { border-right: 1px solid var(--border); }
        .tf-btn:hover { background: var(--bg-card-hover); color: var(--text); }
        .tf-btn.active { background: var(--accent); color: #fff; }
        .tf-btn.active[data-tf="intraday"] { background: #ef4444; }
        .tf-btn.active[data-tf="daytrade"] { background: #eab308; color: #000; }
        .tf-btn.active[data-tf="swing"] { background: #6366f1; }
        .tf-btn.active[data-tf="longterm"] { background: #22c55e; color: #000; }
        .tf-btn .tf-sub { display: block; font-size: 0.5rem; font-weight: 400; opacity: 0.75; margin-top: 0.1rem; }

        .budget-go { padding: 0.6rem 1.4rem; background: linear-gradient(135deg, var(--accent), #8b5cf6); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 700; transition: all 0.2s; }
        .budget-go:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(99,102,241,0.4); }
        .budget-go:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        .budget-presets { display: flex; gap: 0.4rem; margin-top: 0.75rem; flex-wrap: wrap; }
        .preset-btn { padding: 0.25rem 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-dark); color: var(--text-dim); font-size: 0.7rem; cursor: pointer; transition: all 0.15s; }
        .preset-btn:hover { border-color: var(--accent); color: var(--text); }

        /* Budget results */
        .budget-results { margin-top: 1rem; }
        .budget-profile { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 8px; background: var(--bg-dark); border: 1px solid var(--border); margin-bottom: 1rem; flex-wrap: wrap; }
        .profile-badge { font-size: 0.7rem; font-weight: 800; padding: 0.25rem 0.6rem; border-radius: 6px; color: #000; }
        .profile-info { font-size: 0.75rem; color: var(--text-dim); flex: 1; }
        .profile-info strong { color: var(--text); }
        .profile-stats { display: flex; gap: 1rem; font-size: 0.75rem; }
        .profile-stats span { white-space: nowrap; }

        .budget-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.5rem; margin-bottom: 1rem; }
        .bsum-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem 0.65rem; text-align: center; }
        .bsum-card .val { font-size: 1.2rem; font-weight: 800; }
        .bsum-card .lbl { font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; }

        /* Budget pick cards — slightly different from scanner picks */
        .bp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 0.75rem; }
        .bp-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; transition: all 0.2s; position: relative; overflow: hidden; }
        .bp-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 6px 24px rgba(0,0,0,0.3); }
        .bp-card.cdr { border-left: 3px solid var(--gold); }
        .bp-card.non-cdr { border-left: 3px solid var(--blue); }

        .bp-position { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; margin: 0.5rem 0; padding: 0.5rem; border-radius: 8px; background: rgba(0,0,0,0.25); }
        .bp-position .bp-item { text-align: center; }
        .bp-position .bp-item .lbl { font-size: 0.5rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.04em; }
        .bp-position .bp-item .val { font-size: 0.85rem; font-weight: 700; }

        .bp-pnl { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin: 0.5rem 0; }
        .bp-pnl-box { text-align: center; padding: 0.4rem; border-radius: 6px; }
        .bp-pnl-box.profit { background: var(--green-dim); border: 1px solid rgba(34,197,94,0.3); }
        .bp-pnl-box.loss { background: var(--red-dim); border: 1px solid rgba(239,68,68,0.3); }
        .bp-pnl-box.neutral { background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); }
        .bp-pnl-box .lbl { font-size: 0.5rem; color: var(--text-dim); text-transform: uppercase; }
        .bp-pnl-box .val { font-size: 0.9rem; font-weight: 800; }

        .bp-rr-bar { height: 6px; border-radius: 3px; overflow: hidden; display: flex; margin: 0.5rem 0 0.3rem; }
        .bp-rr-green { background: var(--green); }
        .bp-rr-red { background: var(--red); }

        @media (max-width: 600px) {
            .picks-grid { grid-template-columns: 1fr; }
            .bp-grid { grid-template-columns: 1fr; }
            .header { padding: 0.75rem 1rem; }
            .container { padding: 0.75rem; }
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .budget-form { flex-direction: column; }
            .budget-input { width: 100%; }
            .tf-group { flex-wrap: wrap; }
            .budget-summary { grid-template-columns: repeat(2, 1fr); }
            .bp-pnl { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>DayTraders Miracle Cursor</h1>
            <div class="subtitle">Claude-Generated AI Stock Scanner &mdash; v3 (miracle3_ tables)</div>
        </div>
        <div class="header-links">
            <a href="/findstocks/portfolio2/picks.html">Portfolio Picks</a>
            <a href="/findstocks/portfolio2/leaderboard.html">Algo Leaderboard</a>
            <a href="/findstocks_global/">Investment Hub</a>
            <a href="/findstocks/">Home</a>
        </div>
    </div>

    <div class="container">
        <div id="status-area"></div>

        <!-- ═══ BUDGET PICKER ═══ -->
        <div class="budget-section" id="budget-section">
            <div class="budget-header">
                <h2>My Budget Picks</h2>
                <span class="badge-new">NEW</span>
                <span style="font-size:0.7rem;color:var(--text-dim);margin-left:auto;">Personalized picks sized to your budget</span>
            </div>

            <div class="budget-form">
                <div class="budget-field">
                    <label>Your Budget (CAD/USD)</label>
                    <input type="text" id="budget-input" class="budget-input" placeholder="$500" value="" inputmode="decimal">
                </div>
                <div class="budget-field">
                    <label>Trading Timeframe</label>
                    <div class="tf-group" id="tf-group">
                        <button class="tf-btn" data-tf="intraday" onclick="pickTF(this)">
                            Intraday<span class="tf-sub">Exit today</span>
                        </button>
                        <button class="tf-btn active" data-tf="daytrade" onclick="pickTF(this)">
                            Day Trade<span class="tf-sub">Next day close</span>
                        </button>
                        <button class="tf-btn" data-tf="swing" onclick="pickTF(this)">
                            Swing<span class="tf-sub">Up to 1 week</span>
                        </button>
                        <button class="tf-btn" data-tf="longterm" onclick="pickTF(this)">
                            Buy &amp; Hold<span class="tf-sub">Weeks to months</span>
                        </button>
                    </div>
                </div>
                <div class="budget-field" style="display:flex;align-items:flex-end;">
                    <button class="budget-go" id="budget-go" onclick="loadBudgetPicks()">Get My Picks</button>
                </div>
            </div>

            <div class="budget-presets">
                <span style="font-size:0.6rem;color:var(--text-dim);line-height:1.8;">Quick:</span>
                <button class="preset-btn" onclick="setBudget(100)">$100</button>
                <button class="preset-btn" onclick="setBudget(250)">$250</button>
                <button class="preset-btn" onclick="setBudget(500)">$500</button>
                <button class="preset-btn" onclick="setBudget(1000)">$1K</button>
                <button class="preset-btn" onclick="setBudget(2500)">$2.5K</button>
                <button class="preset-btn" onclick="setBudget(5000)">$5K</button>
                <button class="preset-btn" onclick="setBudget(10000)">$10K</button>
                <button class="preset-btn" onclick="setBudget(25000)">$25K</button>
                <button class="preset-btn" onclick="setBudget(50000)">$50K</button>
            </div>

            <div id="budget-results" class="budget-results"></div>
        </div>

        <!-- ═══ SCANNER CONTROLS ═══ -->
        <div class="actions">
            <button class="btn btn-green" onclick="runScan()">Run Scan Now</button>
            <button class="btn" onclick="runResolve()">Resolve Outcomes</button>
            <button class="btn" onclick="runLearn()">Run Learning</button>
            <button class="btn" id="btn-cdr" onclick="toggleCDR()">CDR Only</button>
            <button class="btn" id="btn-refresh" onclick="loadAll()">Refresh</button>
        </div>

        <div id="stats-area"></div>
        <div id="loading" class="loading"><div class="spinner"></div><p style="margin-top:0.75rem;">Loading miracle picks...</p></div>

        <div id="picks-section" style="display:none;">
            <div class="section-title"><span>Today's Miracle Picks</span><span class="badge" style="background:var(--gold);color:#000;">Day Trade</span></div>
            <div id="picks-grid" class="picks-grid"></div>
        </div>

        <div id="leaderboard-section" style="display:none;">
            <div class="section-title"><span>Strategy Leaderboard</span><span class="badge">Performance</span></div>
            <div id="leaderboard"></div>
        </div>

        <div class="disclaimer">
            <strong>Important Disclaimer</strong><br>
            This tool is for <strong>educational and research purposes only</strong> and does not constitute financial advice, investment advice, trading advice, or any other sort of advice.
            Nothing on this page should be construed as a recommendation or solicitation to buy or sell any security or financial product.
            <strong>No fiduciary relationship</strong> is created between you and the operators of this website by your use of this tool.<br><br>
            You are solely responsible for your own investment decisions. <strong>All investments involve risk</strong>, including the possible loss of principal.
            <strong>Day trading involves substantial risk of rapid financial loss.</strong> Statistics show the majority of day traders lose money.
            Past performance does not guarantee future results. All picks are algorithm-generated based on historical data and may not reflect current market conditions, slippage, or liquidity.
            Questrade fee model is used for illustrative P&amp;L calculations only and may not reflect your actual brokerage costs.<br><br>
            Data is sourced from third parties (Yahoo Finance) and may be delayed, inaccurate, or incomplete. The operators make no warranties regarding the accuracy, completeness, or timeliness of any information.
            <strong>Consult a licensed financial adviser</strong> before making any investment decisions.<br><br>
            <span style="opacity:0.7;">By using this tool you acknowledge that you have read and understood this disclaimer and agree that the operators shall not be held liable for any losses arising from your use of this information.</span><br>
            <span style="opacity:0.5;margin-top:0.5rem;display:inline-block;">DayTraders Miracle_CURSOR v3 &mdash; Generated by Claude (Anthropic)</span>
        </div>
    </div>

<script>
var API = '/findstocks_global/api/';
var cdrOnly = false;

function apiGet(url, cb) {
    var x = new XMLHttpRequest();
    x.open('GET', API + url, true);
    x.onload = function() { try { cb(JSON.parse(x.responseText)); } catch(e) { cb(null); } };
    x.onerror = function() { cb(null); };
    x.send();
}

function fmt(n, d) { return (n === null || n === undefined || isNaN(n)) ? '-' : parseFloat(n).toFixed(d || 2); }
function rankClass(r) { return r === 1 ? 'gold' : (r === 2 ? 'silver' : (r === 3 ? 'bronze' : '')); }
function barClass(s) { return s >= 70 ? 'high' : (s >= 50 ? 'mid' : 'low'); }
function confClass(c) { return (c || '').toLowerCase().replace(/\s+/g, '-'); }

function showStatus(msg, type) {
    document.getElementById('status-area').innerHTML = '<div class="status-msg ' + type + '">' + msg + '</div>';
    setTimeout(function() { document.getElementById('status-area').innerHTML = ''; }, 5000);
}

function renderStats(data) {
    if (!data || !data.stats) return;
    var s = data.stats;
    var html = '<div class="stats-row">'
        + '<div class="stat-card"><div class="val" style="color:var(--accent);">' + s.watchlist_tickers + '</div><div class="lbl">Watchlist</div></div>'
        + '<div class="stat-card"><div class="val">' + s.active_strategies + '</div><div class="lbl">Strategies</div></div>'
        + '<div class="stat-card"><div class="val">' + s.total_picks + '</div><div class="lbl">Total Picks</div></div>'
        + '<div class="stat-card"><div class="val val-green">' + s.total_wins + '</div><div class="lbl">Wins</div></div>'
        + '<div class="stat-card"><div class="val val-red">' + s.total_losses + '</div><div class="lbl">Losses</div></div>'
        + '<div class="stat-card"><div class="val" style="color:var(--gold);">' + s.overall_win_rate + '%</div><div class="lbl">Win Rate</div></div>'
        + '<div class="stat-card"><div class="val">' + s.today_picks + '</div><div class="lbl">Today</div></div>'
        + '<div class="stat-card"><div class="val" style="color:var(--blue);">' + s.learning_adjustments + '</div><div class="lbl">Learned</div></div>'
        + '</div>';
    document.getElementById('stats-area').innerHTML = html;
}

function renderPicks(data) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('picks-section').style.display = 'block';
    if (!data || !data.picks || data.picks.length === 0) {
        document.getElementById('picks-grid').innerHTML = '<p style="color:var(--text-dim);padding:1rem;">No picks found. Run a scan to generate picks.</p>';
        return;
    }
    var html = '';
    var picks = data.picks;
    for (var i = 0; i < picks.length; i++) {
        var p = picks[i];
        var rank = i + 1;
        var isCDR = parseInt(p.is_cdr) === 1;
        var score = parseInt(p.score) || 0;
        var conf = p.confidence || 'Okay';
        var rr = parseFloat(p.risk_reward_ratio) || 0;
        var netProfit = parseFloat(p.net_profit_if_tp) || 0;
        var fee = parseFloat(p.questrade_buy_fee || 0) + parseFloat(p.questrade_sell_fee || 0);

        html += '<div class="pick-card ' + (isCDR ? 'cdr' : 'non-cdr') + '">'
            + '<div class="pick-rank ' + rankClass(rank) + '">' + rank + '</div>'
            + '<div class="pick-header">'
            + '<span class="pick-ticker">' + p.ticker + '</span>'
            + '<span class="pick-name">' + (p.company_name || '') + '</span>'
            + '<span class="conf-badge ' + confClass(conf) + '">' + conf + '</span>'
            + '</div>'
            + '<div class="pick-prices">'
            + '<div class="price-item"><div class="lbl">Entry</div><div class="val">$' + fmt(p.entry_price) + '</div></div>'
            + '<div class="price-item"><div class="lbl">Target +' + fmt(p.take_profit_pct, 1) + '%</div><div class="val val-green">$' + fmt(p.take_profit_price) + '</div></div>'
            + '<div class="price-item"><div class="lbl">Stop -' + fmt(p.stop_loss_pct, 1) + '%</div><div class="val val-red">$' + fmt(p.stop_loss_price) + '</div></div>'
            + '</div>'
            + '<div style="display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;margin-bottom:0.4rem;">'
            + '<span class="score-bar">Score: <span class="mini-bar"><span class="mini-fill ' + barClass(score) + '" style="width:' + score + '%;"></span></span> ' + score + '</span>'
            + '<span>R:R ' + fmt(rr, 1) + ':1</span>'
            + '</div>'
            + '<div class="pick-meta">'
            + '<span class="strat-badge">' + (p.strategy_name || '') + '</span>'
            + (isCDR ? '<span class="cdr-tag">CDR $0 FEE</span>' : '<span class="fee-tag">Fee: $' + fmt(fee) + '</span>')
            + '<span style="color:' + (netProfit > 0 ? 'var(--green)' : 'var(--red)') + ';font-weight:700;">Net: $' + fmt(netProfit) + '</span>'
            + '</div></div>';
    }
    document.getElementById('picks-grid').innerHTML = html;
}

function renderLeaderboard(data) {
    document.getElementById('leaderboard-section').style.display = 'block';
    if (!data || !data.leaderboard || data.leaderboard.length === 0) {
        document.getElementById('leaderboard').innerHTML = '<p style="color:var(--text-dim);padding:1rem;">No strategy data yet.</p>';
        return;
    }
    var lb = data.leaderboard;
    var html = '<div class="lb-wrap"><table class="lb-table"><thead><tr>'
        + '<th>#</th><th>Strategy</th><th>Picks</th><th>W/L</th><th>Win Rate</th><th>Avg Return</th><th>R:R</th><th>Score</th>'
        + '</tr></thead><tbody>';
    for (var i = 0; i < lb.length; i++) {
        var s = lb[i];
        var wr = parseFloat(s.win_rate) || 0;
        html += '<tr>'
            + '<td><span class="pick-rank ' + rankClass(s.rank) + '" style="width:22px;height:22px;font-size:0.6rem;">' + s.rank + '</span></td>'
            + '<td style="font-weight:700;">' + s.strategy_name + '</td>'
            + '<td>' + s.total_picks + '</td>'
            + '<td><span class="val-green">' + (s.wins||0) + '</span>/<span class="val-red">' + (s.losses||0) + '</span></td>'
            + '<td><span class="' + (wr >= 50 ? 'val-green' : 'val-red') + '">' + fmt(wr, 1) + '%</span></td>'
            + '<td>' + fmt(s.avg_outcome_pct, 2) + '%</td>'
            + '<td>' + fmt(s.avg_rr, 1) + ':1</td>'
            + '<td style="font-weight:800;">' + fmt(s.composite_score, 1) + '</td>'
            + '</tr>';
    }
    html += '</tbody></table></div>';
    document.getElementById('leaderboard').innerHTML = html;
}

function loadAll() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('picks-section').style.display = 'none';
    var picksUrl = 'picks3.php' + (cdrOnly ? '?cdr_only=1' : '');
    apiGet('dashboard3.php?action=stats', renderStats);
    apiGet(picksUrl, renderPicks);
    apiGet('dashboard3.php?action=leaderboard', renderLeaderboard);
}

function runScan() {
    var BATCH = 10;
    var totalPicks = 0, totalSaved = 0, totalScanned = 0, totalErrors = [];
    showStatus('Starting batch scan (10 tickers per batch)...', 'success');

    function scanBatch(offset) {
        var url = 'scanner3.php?batch=' + BATCH + '&offset=' + offset;
        apiGet(url, function(d) {
            if (!d || !d.ok) { showStatus('Batch failed at offset ' + offset, 'error'); loadAll(); return; }
            totalPicks += (d.picks_found || 0);
            totalSaved += (d.picks_saved || 0);
            totalScanned += (d.tickers_scanned || 0);
            if (d.errors) totalErrors = totalErrors.concat(d.errors);
            var pct = d.batch ? Math.min(100, Math.round((d.batch.offset + d.batch.size) / d.batch.total * 100)) : 100;
            showStatus('Scanning... ' + pct + '% (' + totalScanned + ' tickers, ' + totalPicks + ' picks found)', 'success');

            if (d.batch && d.batch.has_more) {
                scanBatch(offset + BATCH);
            } else {
                showStatus('Scan complete: ' + totalScanned + ' tickers scanned, ' + totalPicks + ' picks found, ' + totalSaved + ' saved.' + (totalErrors.length ? ' (' + totalErrors.length + ' errors)' : ''), 'success');
                loadAll();
            }
        });
    }
    scanBatch(0);
}

function runResolve() {
    showStatus('Resolving pending pick outcomes...', 'success');
    apiGet('resolve3.php', function(d) {
        if (d && d.ok) showStatus('Resolved: ' + (d.resolved||0) + ' picks. Still pending: ' + (d.still_pending||0), 'success');
        else showStatus('Resolve failed.', 'error');
        loadAll();
    });
}

function runLearn() {
    showStatus('Running self-adjusting learning algorithm...', 'success');
    apiGet('learning3.php?action=adjust', function(d) {
        if (d && d.ok) showStatus('Learning complete: ' + (d.adjustments_made||0) + ' adjustments applied to ' + (d.total_strategies||0) + ' strategies.', 'success');
        else showStatus('Learning failed.', 'error');
        loadAll();
    });
}

function toggleCDR() {
    cdrOnly = !cdrOnly;
    document.getElementById('btn-cdr').classList.toggle('active', cdrOnly);
    loadAll();
}

// ═══════════════════════════════════════════════
// BUDGET PICKER
// ═══════════════════════════════════════════════
var selectedTF = 'daytrade';
var budgetLoading = false;

function pickTF(btn) {
    var btns = document.getElementById('tf-group').children;
    for (var i = 0; i < btns.length; i++) btns[i].className = 'tf-btn';
    btn.className = 'tf-btn active';
    selectedTF = btn.getAttribute('data-tf');
}

function setBudget(val) {
    document.getElementById('budget-input').value = val;
    loadBudgetPicks();
}

function parseBudget() {
    var raw = document.getElementById('budget-input').value.replace(/[\$,\s]/g, '');
    var n = parseFloat(raw);
    if (isNaN(n) || n < 50) return 0;
    return n;
}

function loadBudgetPicks() {
    var budget = parseBudget();
    if (budget <= 0) {
        showStatus('Please enter a budget of at least $50.', 'error');
        return;
    }
    if (budgetLoading) return;
    budgetLoading = true;
    var goBtn = document.getElementById('budget-go');
    goBtn.disabled = true;
    goBtn.textContent = 'Loading...';

    var url = 'budget_picks3.php?budget=' + budget + '&timeframe=' + selectedTF + (cdrOnly ? '&cdr_only=1' : '');
    apiGet(url, function(data) {
        budgetLoading = false;
        goBtn.disabled = false;
        goBtn.textContent = 'Get My Picks';
        renderBudgetResults(data);
    });
}

function renderBudgetResults(data) {
    var container = document.getElementById('budget-results');
    if (!data || !data.ok) {
        container.innerHTML = '<div class="status-msg error">' + (data && data.error ? data.error : 'Failed to load picks. Try again.') + '</div>';
        return;
    }
    if (!data.picks || data.picks.length === 0) {
        container.innerHTML = '<div class="status-msg error">No picks found for your budget of $' + fmtMoney(data.budget) + '. Try a larger budget or run a new scan first.</div>';
        return;
    }

    var p = data.profile;
    var s = data.summary;
    var html = '';

    // Profile info bar
    html += '<div class="budget-profile">'
        + '<span class="profile-badge" style="background:' + p.color + ';">' + p.name + '</span>'
        + '<span class="profile-info">' + p.description + ' <strong>Max hold: ' + p.max_hold + '</strong></span>'
        + '<span class="profile-stats">'
        + '<span>TP: ' + p.tp_range + '</span>'
        + '<span>SL: ' + p.sl_range + '</span>'
        + '</span></div>';

    // Summary cards
    html += '<div class="budget-summary">'
        + '<div class="bsum-card"><div class="val" style="color:var(--accent);">$' + fmtMoney(data.budget) + '</div><div class="lbl">Budget</div></div>'
        + '<div class="bsum-card"><div class="val">' + data.count + '</div><div class="lbl">Picks Found</div></div>'
        + '<div class="bsum-card"><div class="val val-green">$' + fmtMoney(s.total_potential_profit) + '</div><div class="lbl">Total Profit If All TP</div></div>'
        + '<div class="bsum-card"><div class="val val-red">-$' + fmtMoney(s.total_potential_risk) + '</div><div class="lbl">Total Risk If All SL</div></div>'
        + '<div class="bsum-card"><div class="val" style="color:var(--gold);">' + s.cdr_picks + '</div><div class="lbl">CDR ($0 Fee)</div></div>'
        + '<div class="bsum-card"><div class="val" style="color:var(--green);">' + (s.best_pick || '-') + '</div><div class="lbl">Best Pick</div></div>'
        + '</div>';

    // Pick cards
    html += '<div class="bp-grid">';
    for (var i = 0; i < data.picks.length; i++) {
        html += renderBPCard(data.picks[i], i + 1, p.color);
    }
    html += '</div>';

    container.innerHTML = html;
}

function renderBPCard(pk, rank, accentColor) {
    var isCDR = parseInt(pk.is_cdr) === 1;
    var score = pk.score || 0;
    var conf = pk.confidence || 'Okay';
    var totalRange = pk.take_profit_pct + pk.stop_loss_pct;
    var rrPct = totalRange > 0 ? Math.round(pk.take_profit_pct / totalRange * 100) : 50;

    var h = '<div class="bp-card ' + (isCDR ? 'cdr' : 'non-cdr') + '">';

    // Rank
    h += '<div class="pick-rank ' + rankClass(rank) + '">' + rank + '</div>';

    // Header: ticker, name, confidence
    h += '<div class="pick-header">'
        + '<span class="pick-ticker">' + pk.ticker + '</span>'
        + '<span class="pick-name">' + (pk.company_name || '') + '</span>'
        + '<span class="conf-badge ' + confClass(conf) + '">' + conf + '</span>'
        + '</div>';

    // Entry / Target / Stop row
    h += '<div class="pick-prices">'
        + '<div class="price-item"><div class="lbl">Entry</div><div class="val">$' + fmt(pk.entry_price) + '</div></div>'
        + '<div class="price-item"><div class="lbl">Target +' + fmt(pk.take_profit_pct, 1) + '%</div><div class="val val-green">$' + fmt(pk.take_profit_price) + '</div></div>'
        + '<div class="price-item"><div class="lbl">Stop -' + fmt(pk.stop_loss_pct, 1) + '%</div><div class="val val-red">$' + fmt(pk.stop_loss_price) + '</div></div>'
        + '</div>';

    // Position details (budget-specific)
    h += '<div class="bp-position">'
        + '<div class="bp-item"><div class="lbl">Shares</div><div class="val" style="color:var(--accent);">' + pk.shares + '</div></div>'
        + '<div class="bp-item"><div class="lbl">Position</div><div class="val">$' + fmtMoney(pk.position_value) + '</div></div>'
        + '<div class="bp-item"><div class="lbl">Fees (Round-Trip)</div><div class="val">' + (isCDR ? '<span style="color:var(--gold);">$0 CDR</span>' : '$' + fmt(pk.fees_roundtrip)) + '</div></div>'
        + '<div class="bp-item"><div class="lbl">Budget Used</div><div class="val">' + fmt(pk.budget_utilization, 0) + '%</div></div>'
        + '</div>';

    // P&L boxes
    h += '<div class="bp-pnl">'
        + '<div class="bp-pnl-box profit"><div class="lbl">If Target Hit</div><div class="val val-green">+$' + fmtMoney(pk.net_profit) + '</div></div>'
        + '<div class="bp-pnl-box loss"><div class="lbl">If Stop Hit</div><div class="val val-red">-$' + fmtMoney(Math.abs(pk.net_loss)) + '</div></div>'
        + '<div class="bp-pnl-box neutral"><div class="lbl">Risk:Reward</div><div class="val" style="color:var(--accent);">' + fmt(pk.risk_reward, 1) + ':1</div></div>'
        + '</div>';

    // R:R visual bar
    h += '<div class="bp-rr-bar">'
        + '<div class="bp-rr-green" style="width:' + rrPct + '%;"></div>'
        + '<div class="bp-rr-red" style="width:' + (100 - rrPct) + '%;"></div>'
        + '</div>';

    // Meta row
    h += '<div class="pick-meta">'
        + '<span class="strat-badge">' + (pk.strategy_name || '') + '</span>'
        + '<span class="score-bar">Score: <span class="mini-bar"><span class="mini-fill ' + barClass(score) + '" style="width:' + score + '%;"></span></span> ' + score + '</span>'
        + (isCDR ? '<span class="cdr-tag">CDR $0 FEE</span>' : '<span class="fee-tag">Fee drag: ' + fmt(pk.fee_drag_pct, 2) + '%</span>')
        + '</div>';

    h += '</div>';
    return h;
}

function fmtMoney(n) {
    if (n === null || n === undefined || isNaN(n)) return '0.00';
    var num = parseFloat(n);
    if (num >= 1000) {
        return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
    return num.toFixed(2);
}

// Budget input: Enter key support
(function() {
    var inp = document.getElementById('budget-input');
    if (inp) {
        inp.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) loadBudgetPicks();
        });
    }
})();

loadAll();
</script>
</body>
</html>
