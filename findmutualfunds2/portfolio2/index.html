<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutual Funds Portfolio v2 | Fund Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #12122a;
            --bg-card-hover: #1a1a3a;
            --border: #2a2a4a;
            --text: #e0e0f0;
            --text-dim: #8888aa;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234, 179, 8, 0.15);
            --blue: #3b82f6;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .header {
            background: linear-gradient(135deg, #12122a 0%, #1e1e3f 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-links { display: flex; gap: 1rem; font-size: 0.9rem; }
        .header-links a { color: var(--text-dim); }
        .header-links a:hover { color: var(--text); }

        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        /* Tabs */
        .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 1.5rem; overflow-x: auto; }
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            color: var(--text-dim);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text); background: rgba(99, 102, 241, 0.05); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card h2 { font-size: 1.1rem; margin-bottom: 1rem; }
        .card h3 { font-size: 0.95rem; color: var(--text-dim); margin-bottom: 0.5rem; }

        /* Stat Cards */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }
        .stat-card .label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card .value { font-size: 1.4rem; font-weight: 700; margin-top: 0.25rem; }
        .stat-card .value.positive { color: var(--green); }
        .stat-card .value.negative { color: var(--red); }

        /* Forms */
        label { display: block; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.2rem; text-transform: uppercase; letter-spacing: 0.03em; }
        select, input[type="number"], input[type="text"], textarea {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
        }
        select:focus, input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .form-group { margin-bottom: 0.75rem; }
        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #5558e6; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn-secondary:hover { background: #3a3a5a; }
        .btn-success { background: var(--green); color: white; }
        .btn-danger { background: var(--red); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }

        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        tr:hover { background: rgba(99, 102, 241, 0.03); }
        .pct-positive { color: var(--green); }
        .pct-negative { color: var(--red); }

        /* Algo checkboxes */
        .algo-checks { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .algo-check {
            display: flex; align-items: center; gap: 0.3rem;
            background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 6px; padding: 0.3rem 0.6rem; font-size: 0.8rem; cursor: pointer;
        }
        .algo-check:hover { border-color: var(--accent); }
        .algo-check input { accent-color: var(--accent); }

        /* Loading */
        .loading { text-align: center; padding: 2rem; color: var(--text-dim); }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Charts */
        .chart-container { position: relative; height: 300px; margin: 1rem 0; }

        /* Comparison table highlights */
        .rank-1 { background: var(--green-dim); }
        .rank-last { background: var(--red-dim); }

        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        @media (max-width: 1024px) { .grid-2 { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .grid-3 { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr 1fr; }
        }

        /* Disclaimer */
        .disclaimer {
            background: var(--yellow-dim);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.8rem;
            color: var(--yellow);
            margin-bottom: 1.5rem;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-green { background: var(--green-dim); color: var(--green); }
        .badge-red { background: var(--red-dim); color: var(--red); }
        .badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
        .badge-blue { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
        .badge-purple { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
        .badge-orange { background: rgba(249, 115, 22, 0.15); color: #f97316; }

        /* Grade Explainer */
        .grade-explainer {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.5rem;
            font-size: 0.85rem; color: var(--text-dim); line-height: 1.6;
        }
        .ge-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; }

        /* Section titles & Glossary grid */
        .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; }
        .glossary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .glossary-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; }
        .glossary-term { margin-bottom: 0.5rem; }
        .glossary-def { font-size: 0.82rem; color: var(--text-dim); line-height: 1.6; }

        /* Stars */
        .stars { color: #eab308; letter-spacing: 1px; }
        .stars-dim { color: var(--border); }

        /* Setup banner */
        .setup-banner {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(167, 139, 250, 0.1));
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .setup-banner h2 { color: var(--accent); margin-bottom: 0.5rem; }
        .setup-banner p { color: var(--text-dim); margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Mutual Funds Portfolio v2</h1>
        <div class="header-links">
            <a href="/findstocks/portfolio2/">Stocks</a>
            <a href="/findmutualfunds2/">Funds Home</a>
            <a href="/">Events</a>
        </div>
    </div>

    <div class="container">
        <!-- Best Mutual Funds designation banner -->
        <div style="background:rgba(136,136,170,0.08);border:1px solid rgba(136,136,170,0.3);border-radius:12px;padding:10px 16px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:12px;">
            <span style="background:rgba(34,197,94,0.15);color:#22c55e;padding:3px 10px;border-radius:6px;font-weight:800;font-size:11px;border:1px solid rgba(34,197,94,0.3);letter-spacing:0.5px;">BEST MF</span>
            <span style="color:#8888aa;">Forward performance tracking available. Use the Tracking tab to initialize positions, refresh NAVs, and track real outcomes with exit rules (TP/SL/max-hold).</span>
        </div>

        <!-- System Analysis -->
        <div style="background:var(--bg-card);border:1px solid rgba(168,85,247,0.3);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.5rem;">
            <h3 style="font-size:1rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:8px;">
                System Analysis
                <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(168,85,247,0.15);color:#a855f7;border:1px solid rgba(168,85,247,0.3);">DIAGNOSIS</span>
            </h3>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
                <strong style="color:var(--text);">How fund screening works:</strong><br>
                Mutual funds are screened from Yahoo Finance using criteria including: trailing returns (1yr, 3yr, 5yr), expense ratio (MER), fund category, and Morningstar rating where available. Picks are generated based on trailing performance combined with risk metrics (standard deviation, Sharpe ratio approximation). Currently supports Canadian and US-listed mutual funds and ETFs.<br><br>
                <strong style="color:var(--text);">Current status &mdash; critical gap:</strong><br>
                &bull; 45 picks have been generated but <strong style="color:#ef4444;">zero have forward-facing outcome tracking</strong><br>
                &bull; No entry prices recorded, no daily NAV refresh, no win/loss determination<br>
                &bull; Without forward tracking, this system provides screening only &mdash; not performance data<br>
                &bull; Backtests exist but are inherently biased (survivorship bias, look-ahead bias)<br><br>
                <strong style="color:var(--text);">Platform comparison:</strong><br>
                &bull; <strong style="color:#8888aa;">This system: No forward tracking</strong> &mdash; cannot verify if picks outperform index funds<br>
                &bull; <a href="/findstocks/portfolio2/consolidated.html">Consolidated Stocks</a> &mdash; full forward tracking (65 positions, daily price refresh)<br>
                &bull; <a href="/live-monitor/algo-performance.html">L vs O</a> &mdash; real closed trades with verified P&amp;L<br>
                &bull; Building forward-facing tracking for mutual funds is a top-priority roadmap item
            </div>
        </div>

        <!-- Data Sources & Transparency -->
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.5rem;">
            <h3 style="font-size:1rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:8px;">
                Data Sources & Transparency
                <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(136,136,170,0.15);color:#8888aa;border:1px solid rgba(136,136,170,0.3);">NO TRACKING</span>
            </h3>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
                <strong style="color:var(--text);">Where the numbers come from:</strong><br>
                &bull; <strong>Fund data:</strong> <a href="api/mutual_fund_portfolio.php?action=stats" target="_blank">mutual_fund_portfolio.php?action=stats</a> &mdash; 45 picks, 0 tracked outcomes<br>
                &bull; <strong>NAV prices:</strong> <a href="api/mutual_fund_portfolio.php?action=funds" target="_blank">mutual_fund_portfolio.php?action=funds</a> &mdash; Yahoo Finance daily NAV data<br>
                &bull; <strong>Backtests:</strong> <a href="api/mutual_fund_portfolio.php?action=backtests" target="_blank">mutual_fund_portfolio.php?action=backtests</a> &mdash; historical simulation only<br>
                &bull; <strong>No forward tracking:</strong> Unlike stocks and crypto, mutual fund picks have no live outcome tracking yet<br>
                &bull; <strong>Compare to:</strong> <a href="/findstocks/portfolio2/consolidated.html">Consolidated Stock Picks</a> &mdash; full forward-facing tracking with exit rules
            </div>
        </div>

        <!-- Future Roadmap -->
        <div style="background:var(--bg-card);border:1px solid rgba(99,102,241,0.3);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.5rem;">
            <h3 style="font-size:1rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:8px;">
                Future Roadmap
                <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(34,197,94,0.15);color:#22c55e;border:1px solid rgba(34,197,94,0.3);">PLANNED</span>
            </h3>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
                <strong style="color:#22c55e;">Near-term:</strong><br>
                &bull; Build forward-facing outcome tracker (same model as Consolidated Picks)<br>
                &bull; Daily NAV refresh via GitHub Actions with entry price recording<br>
                &bull; Win/loss tracking with configurable exit rules<br><br>
                <strong style="color:#eab308;">Q2 2026:</strong><br>
                &bull; MER (Management Expense Ratio) impact analysis on returns<br>
                &bull; Fund family comparison (Vanguard vs iShares vs Fidelity)<br>
                &bull; Risk-adjusted metrics (Sharpe ratio, max drawdown per fund)<br><br>
                <strong style="color:var(--text-dim);">Long-term:</strong><br>
                &bull; Tax-efficient fund rotation strategies (RRSP vs TFSA optimization)<br>
                &bull; Automated rebalancing recommendations<br>
                &bull; Income vs growth fund comparison dashboard
            </div>
        </div>

        <div class="disclaimer">
            This tool is for research and educational purposes only. Past performance does not guarantee future results. Mutual fund trades may have redemption fees and T+1 settlement. Consult a licensed financial adviser.
        </div>

        <div id="setup-banner" class="setup-banner" style="display:none;">
            <h2>First-Time Setup</h2>
            <p>Initialize the database, import sample mutual fund picks, and fetch NAV data.</p>
            <div class="btn-group" style="justify-content:center;">
                <button class="btn btn-primary" onclick="runSetup()">1. Setup DB</button>
                <button class="btn btn-secondary" onclick="importPicks('seed')">2. Import Seed Data</button>
                <button class="btn btn-secondary" onclick="fetchNAVs()">3. Fetch NAVs</button>
            </div>
            <div id="setup-log" style="margin-top:1rem;font-size:0.8rem;color:var(--text-dim);"></div>
        </div>

        <!-- Stats Row -->
        <div class="stat-grid" id="stats-row">
            <div class="stat-card"><div class="label">Total Funds</div><div class="value" id="stat-funds">-</div></div>
            <div class="stat-card"><div class="label">Total Picks</div><div class="value" id="stat-picks">-</div></div>
            <div class="stat-card"><div class="label">NAV Records</div><div class="value" id="stat-navs">-</div></div>
            <div class="stat-card"><div class="label">Algorithms</div><div class="value" id="stat-algos">-</div></div>
            <div class="stat-card"><div class="label">Backtests</div><div class="value" id="stat-backtests">-</div></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="whatif">What-If Analysis</div>
            <div class="tab" data-tab="compare">Compare Strategies</div>
            <div class="tab" data-tab="algo-compare">Compare Algorithms</div>
            <div class="tab" data-tab="portfolios">Portfolio Templates</div>
            <div class="tab" data-tab="picks">Fund Picks</div>
            <div class="tab" data-tab="history">Backtest History</div>
            <div class="tab" data-tab="tracking" style="color:#22c55e;">Tracking</div>
            <div class="tab" data-tab="analysis" style="color:#f59e0b;">System Analysis</div>
            <div class="tab" data-tab="research" style="color:#a855f7;">Research &amp; Future</div>
        </div>

        <!-- TAB: What-If Analysis -->
        <div class="tab-content active" id="tab-whatif">
            <div class="grid-2">
                <div class="card">
                    <h2>What-If Parameters</h2>

                    <div class="form-group">
                        <label>Quick Scenario</label>
                        <select id="wi-scenario" onchange="applyScenario()">
                            <option value="">-- Custom Parameters --</option>
                            <option value="short_tactical">Short Tactical (TR:5% SL:3% Hold:14d)</option>
                            <option value="momentum_monthly">Momentum Monthly (TR:8% SL:5% Hold:30d)</option>
                            <option value="swing_quarter">Swing Quarter (TR:12% SL:6% Hold:60d)</option>
                            <option value="conservative_hold">Conservative Hold (TR:6% SL:4% Hold:90d)</option>
                            <option value="growth_6m">Growth 6-Month (TR:18% SL:10% Hold:126d)</option>
                            <option value="buy_hold_1y">Buy & Hold 1-Year (TR:25% SL:15% Hold:252d)</option>
                            <option value="income_steady">Income Steady (TR:5% SL:3% Hold:90d)</option>
                            <option value="aggressive_rotation">Aggressive Rotation (TR:15% SL:8% Hold:21d)</option>
                            <option value="value_patient">Value Patient (TR:20% SL:12% Hold:180d)</option>
                            <option value="balanced_moderate">Balanced Moderate (TR:10% SL:6% Hold:60d)</option>
                        </select>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Target Return %</label>
                            <input type="number" id="wi-tp" value="10" min="1" max="999" step="1">
                        </div>
                        <div class="form-group">
                            <label>Stop Loss %</label>
                            <input type="number" id="wi-sl" value="5" min="1" max="999" step="1">
                        </div>
                        <div class="form-group">
                            <label>Max Hold Days</label>
                            <input type="number" id="wi-hold" value="60" min="1" max="365" step="1">
                        </div>
                        <div class="form-group">
                            <label>Initial Capital $</label>
                            <input type="number" id="wi-capital" value="10000" min="100" step="100">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Filter Algorithms</label>
                        <div class="algo-checks" id="wi-algos"></div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="btn-run-whatif" onclick="runWhatIf()">Run Analysis</button>
                        <button class="btn btn-success" id="btn-save-whatif" onclick="runWhatIf(true)" style="display:none;">Save Results</button>
                    </div>
                </div>

                <div class="card">
                    <h2>Scenario Guide</h2>
                    <div style="font-size:0.85rem;color:var(--text-dim);line-height:1.8;">
                        <p><strong style="color:var(--text);">Short Tactical</strong> - Quick rotations, 5% target, 14-day hold. Low-fee funds only.</p>
                        <p><strong style="color:var(--text);">Momentum Monthly</strong> - Ride monthly trends, 8% target, 30-day hold.</p>
                        <p><strong style="color:var(--text);">Swing Quarter</strong> - Quarterly rebalancing, 12% target, 60-day hold.</p>
                        <p><strong style="color:var(--text);">Conservative Hold</strong> - Steady growth, 6% target, 90-day hold with tight stops.</p>
                        <p><strong style="color:var(--text);">Growth 6-Month</strong> - Mid-term growth, 18% target, 126-day hold.</p>
                        <p><strong style="color:var(--text);">Buy & Hold 1-Year</strong> - Long-term, 25% target, full year hold.</p>
                        <p><strong style="color:var(--text);">Income Steady</strong> - Income-focused, 5% target, 90-day hold.</p>
                        <p><strong style="color:var(--text);">Aggressive Rotation</strong> - Fast rotation, 15% target, 21-day hold.</p>
                        <p><strong style="color:var(--text);">Value Patient</strong> - Undervalued funds, 20% target, 180-day hold.</p>
                        <p><strong style="color:var(--text);">Balanced Moderate</strong> - Middle ground, 10% target, 60-day hold.</p>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="wi-results" style="display:none;">
                <div class="stat-grid" id="wi-stats"></div>

                <div class="grid-2">
                    <div class="card">
                        <h2>Equity Curve</h2>
                        <div class="chart-container"><canvas id="chart-equity"></canvas></div>
                    </div>
                    <div class="card">
                        <h2>Exit Reasons</h2>
                        <div class="chart-container"><canvas id="chart-exits"></canvas></div>
                    </div>
                </div>

                <div class="card">
                    <h2>Algorithm Breakdown</h2>
                    <div class="table-wrap">
                        <table id="wi-algo-table">
                            <thead><tr>
                                <th>Algorithm</th><th>Trades</th><th>Wins</th><th>Losses</th>
                                <th>Win Rate</th><th>Avg Return</th><th>Total P&L</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h2>Trade Log</h2>
                    <div class="table-wrap">
                        <table id="wi-trades-table">
                            <thead><tr>
                                <th>Symbol</th><th>Algorithm</th><th>Entry Date</th><th>Entry NAV</th>
                                <th>Exit Date</th><th>Exit NAV</th><th>Units</th><th>Net P&L</th>
                                <th>Return %</th><th>Hold Days</th><th>Exit Reason</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Compare Strategies -->
        <div class="tab-content" id="tab-compare">
            <div class="card">
                <h2>Compare All Strategies</h2>
                <p style="color:var(--text-dim);font-size:0.85rem;margin-bottom:1rem;">
                    Run all 10 preset scenarios against the same fund picks and compare performance side by side.
                </p>
                <div class="form-group" style="max-width:300px;">
                    <label>Filter Algorithms</label>
                    <div class="algo-checks" id="cmp-algos"></div>
                </div>
                <button class="btn btn-primary" id="btn-compare" onclick="runCompare()">Run Comparison</button>
            </div>

            <div id="cmp-results" style="display:none;">
                <div class="card">
                    <h2>Strategy Comparison (Ranked by Return)</h2>
                    <div class="chart-container" style="height:350px;"><canvas id="chart-compare"></canvas></div>
                </div>
                <div class="card">
                    <div class="table-wrap">
                        <table id="cmp-table">
                            <thead><tr>
                                <th>#</th><th>Strategy</th><th>TR%</th><th>SL%</th><th>Hold</th>
                                <th>Trades</th><th>Win Rate</th><th>Return %</th><th>Final $</th>
                                <th>Max DD</th><th>Fee Drag</th><th>Sharpe</th><th>Profit Factor</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Compare Algorithms -->
        <div class="tab-content" id="tab-algo-compare">
            <div class="card">
                <h2>Compare Algorithms</h2>
                <p style="color:var(--text-dim);font-size:0.85rem;margin-bottom:1rem;">
                    Test each algorithm independently under the same scenario rules.
                </p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Scenario</label>
                        <select id="ac-scenario">
                            <option value="">-- Custom --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Target Return %</label>
                        <input type="number" id="ac-tp" value="10" min="1" max="999">
                    </div>
                    <div class="form-group">
                        <label>Stop Loss %</label>
                        <input type="number" id="ac-sl" value="5" min="1" max="999">
                    </div>
                    <div class="form-group">
                        <label>Max Hold Days</label>
                        <input type="number" id="ac-hold" value="60" min="1" max="365">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="runAlgoCompare()">Compare Algorithms</button>
            </div>

            <div id="ac-results" style="display:none;">
                <div class="card">
                    <h2>Algorithm Performance (Ranked by Return)</h2>
                    <div class="chart-container" style="height:400px;"><canvas id="chart-algo-cmp"></canvas></div>
                </div>
                <div class="card">
                    <div class="table-wrap">
                        <table id="ac-table">
                            <thead><tr>
                                <th>#</th><th>Algorithm</th><th>Trades</th><th>Win Rate</th>
                                <th>Return %</th><th>Final $</th><th>Max DD</th>
                                <th>Fee Drag</th><th>Sharpe</th><th>Profit Factor</th><th>Avg Hold</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Portfolio Templates -->
        <div class="tab-content" id="tab-portfolios">
            <div class="card">
                <h2>Portfolio Templates</h2>
                <p style="color:var(--text-dim);font-size:0.85rem;margin-bottom:1rem;">
                    Pre-configured fund portfolio strategies. Click "Backtest" to run a simulation.
                </p>
                <div class="table-wrap">
                    <table id="portfolios-table">
                        <thead><tr>
                            <th>Name</th><th>Type</th><th>TR%</th><th>SL%</th><th>Hold</th>
                            <th>Capital</th><th>Pos Size</th><th>Action</th>
                        </tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Fund Picks -->
        <div class="tab-content" id="tab-picks">
            <div class="card">
                <h2>Mutual Fund Picks</h2>
                <div class="form-group" style="max-width:300px;">
                    <label>Filter by Algorithm</label>
                    <select id="picks-algo-filter" onchange="loadPicks()">
                        <option value="">All Algorithms</option>
                    </select>
                </div>
                <div class="table-wrap">
                    <table id="picks-table">
                        <thead><tr>
                            <th>Symbol</th><th>Fund Name</th><th>Family</th><th>Category</th>
                            <th>Algorithm</th><th>Entry NAV</th><th>Pick Date</th><th>Score</th><th>Rating</th>
                            <th>Morningstar</th><th>Expense Ratio</th><th>Status</th>
                        </tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Backtest History -->
        <div class="tab-content" id="tab-history">
            <div class="card">
                <h2>Saved Backtest Results</h2>
                <div class="btn-group" style="margin-bottom:1rem;">
                    <button class="btn btn-primary" onclick="seedBacktests()">Seed All Scenarios</button>
                    <button class="btn btn-secondary" onclick="seedBacktests(true)">Re-Run All (Force)</button>
                </div>
                <div id="seed-log" style="font-size:0.8rem;color:var(--text-dim);margin-bottom:1rem;"></div>
                <div class="table-wrap">
                    <table id="history-table">
                        <thead><tr>
                            <th>Run Name</th><th>Strategy</th><th>Algos</th><th>Trades</th>
                            <th>Win Rate</th><th>Return %</th><th>Final $</th><th>Max DD</th>
                            <th>Sharpe</th><th>Created</th>
                        </tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Forward Tracking -->
        <div class="tab-content" id="tab-tracking">
            <div class="card">
                <h2>Forward Performance Tracking</h2>
                <p style="font-size:0.85rem;color:var(--text-dim);margin-bottom:1rem;">Track real outcomes of mutual fund picks with daily NAV updates, exit rules (TP/SL/max-hold), and win/loss recording.</p>
                <div class="btn-group" style="margin-bottom:1rem;">
                    <button class="btn btn-primary" onclick="initTracking()">Initialize Tracking</button>
                    <button class="btn btn-success" onclick="refreshTracking()">Refresh NAVs</button>
                </div>
                <div id="tracking-log" style="font-size:0.8rem;color:var(--text-dim);margin-bottom:1rem;"></div>

                <!-- Tracking Stats -->
                <div class="stat-grid" id="tracking-stats">
                    <div class="stat-card"><div class="label">Open Positions</div><div class="value" id="t-open">-</div></div>
                    <div class="stat-card"><div class="label">Closed</div><div class="value" id="t-closed">-</div></div>
                    <div class="stat-card"><div class="label">Win Rate</div><div class="value" id="t-winrate">-</div></div>
                    <div class="stat-card"><div class="label">Avg Return</div><div class="value" id="t-avgret">-</div></div>
                    <div class="stat-card"><div class="label">Avg Hold Days</div><div class="value" id="t-avghold">-</div></div>
                </div>

                <!-- Open Positions Table -->
                <h3 style="margin:1rem 0 0.5rem;">Open Positions</h3>
                <div class="table-wrap">
                    <table id="tracking-open-table">
                        <thead><tr>
                            <th>Symbol</th><th>Fund Name</th><th>Algorithm</th><th>Pick Date</th>
                            <th>Entry NAV</th><th>Current NAV</th><th>Return %</th><th>Hold Days</th>
                            <th>Peak</th><th>Trough</th>
                        </tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Closed Positions Table -->
                <h3 style="margin:1.5rem 0 0.5rem;">Closed Positions</h3>
                <div class="table-wrap">
                    <table id="tracking-closed-table">
                        <thead><tr>
                            <th>Symbol</th><th>Fund Name</th><th>Algorithm</th><th>Pick Date</th>
                            <th>Entry NAV</th><th>Exit NAV</th><th>Return %</th><th>Exit Reason</th>
                            <th>Hold Days</th><th>Exit Date</th>
                        </tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Per-Algorithm Performance -->
                <h3 style="margin:1.5rem 0 0.5rem;">Algorithm Performance</h3>
                <div class="table-wrap">
                    <table id="tracking-algo-table">
                        <thead><tr>
                            <th>Algorithm</th><th>Total Picks</th><th>Open</th><th>Wins</th><th>Losses</th>
                            <th>Avg Current Return</th>
                        </tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ═══════════ TAB: System Analysis ═══════════ -->
        <div class="tab-content" id="tab-analysis">
            <div class="grade-explainer" style="background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(239,68,68,0.08));border-color:rgba(245,158,11,0.3);">
                <div class="ge-title" style="color:#f59e0b;">Honest System Assessment -- Mutual Funds Portfolio</div>
                This page provides complete transparency about our mutual fund analysis system's current state, known limitations, and planned improvements. We believe in honest disclosure -- this system has no forward-facing performance tracking whatsoever. All analysis is based on backtested scenarios using historical NAV data from Yahoo Finance.
            </div>

            <h3 class="section-title" style="color:#22c55e;">Current Strengths</h3>
            <div class="glossary-grid">
                <div class="glossary-item">
                    <div class="glossary-term"><span class="badge badge-green">MULTIPLE ANALYSIS TOOLS</span></div>
                    <div class="glossary-def"><strong>What-If Calculator</strong> -- Run custom scenarios with configurable target return, stop loss, and max hold days. 10 preset scenarios from Short Tactical (14d) to Buy &amp; Hold 1-Year (252d). See equity curves, exit reason breakdowns, and per-algorithm performance.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="badge badge-green">STRATEGY COMPARISON</span></div>
                    <div class="glossary-def"><strong>Side-by-Side Scenarios</strong> -- Compare all 10 preset strategies simultaneously with ranked performance tables. Includes win rate, return %, final value, max drawdown, fee drag, Sharpe ratio, and profit factor for each scenario.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="badge badge-green">ALGORITHM COMPARISON</span></div>
                    <div class="glossary-def"><strong>Per-Algorithm Breakdown</strong> -- Test each algorithm independently under the same scenario rules. Identifies which algorithm works best for mutual funds under different market conditions and holding periods.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="badge badge-green">PORTFOLIO TEMPLATES</span></div>
                    <div class="glossary-def"><strong>Pre-Configured Strategies</strong> -- Ready-made portfolio templates for different investor profiles (conservative, growth, income, aggressive rotation). Each template has preconfigured TP/SL/hold parameters and can be backtested with one click.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="badge badge-green">FUND PICKS DATABASE</span></div>
                    <div class="glossary-def"><strong>45 Picks Across Multiple Algorithms</strong> -- Fund picks filterable by algorithm, with fund name, family, category, NAV price, score, rating, Morningstar stars, and expense ratio displayed for each pick.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="badge badge-green">USER-FRIENDLY INTERFACE</span></div>
                    <div class="glossary-def"><strong>Multiple Analysis Angles</strong> -- Interactive charts via Chart.js, sortable tables, scenario presets with quick-apply, algorithm filtering, and saveable backtest results. Designed for both beginners and experienced fund investors.</div>
                </div>
            </div>

            <h3 class="section-title" style="color:#6366f1;margin-top:1.5rem;">ML System Status</h3>
            <div style="background:var(--bg-card);border:1px solid rgba(99,102,241,0.3);border-radius:12px;padding:1rem;margin-bottom:1rem;">
                <div style="font-size:0.85rem;color:#889;">
                    <p style="margin-bottom:0.8rem;"><strong style="color:#22c55e;">Current State: ML Pipeline DEPLOYED (Feb 12, 2026)</strong></p>
                    <ul style="margin-left:1.5rem;margin-bottom:0.8rem;">
                        <li><span style="color:#22c55e;">&check;</span> <strong>mutualfund_ml_optimizer.py</strong> (1,438 lines) &mdash; walk-forward grid search, Sharpe objective</li>
                        <li><span style="color:#22c55e;">&check;</span> <strong>Expense ratio drag</strong> included in all calculations</li>
                        <li><span style="color:#22c55e;">&check;</span> <strong>Cross-algo correlation analysis</strong> &mdash; redundancy detection</li>
                        <li><span style="color:#22c55e;">&check;</span> <strong>Walk-forward validation</strong> &mdash; 60/20/20 train/val/test split</li>
                        <li><span style="color:#22c55e;">&check;</span> <strong>GitHub Actions</strong> &mdash; Sunday 4 PM EST weekly run</li>
                        <li><span style="color:#f59e0b;">&bull;</span> 45 picks with NAV history; optimizer uses backtest data</li>
                    </ul>
                    <p style="color:#22c55e;"><strong>Status:</strong> ML deployed with walk-forward validation + expense ratio integration. Running weekly Sundays.</p>
                </div>
            </div>

            <h3 class="section-title" style="color:#ef4444;margin-top:1.5rem;">Known Flaws &amp; Limitations</h3>
            <div class="glossary-grid">
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">NO LIVE TRACKING</span></div>
                    <div class="glossary-def"><strong>Zero Forward-Facing Data</strong> -- 45 picks generated, 0 tracked with real results. No entry prices recorded, no exit conditions monitored, no win/loss ratio. Every other asset class in our system (stocks, crypto, forex) has some form of live tracking except mutual funds.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">NO EXPENSE RATIO OPTIMIZATION</span></div>
                    <div class="glossary-def"><strong>Critical for Fund Selection</strong> -- Expense ratios are displayed but not factored into fund selection or ranking. Research shows each 1% in fees costs approximately 17% of returns over 20 years (Carhart 1997). This is the single highest-impact missing feature for mutual fund investors.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">NO TAX-LOSS HARVESTING</span></div>
                    <div class="glossary-def"><strong>Missing Tax Efficiency</strong> -- No recommendations for tax-loss harvesting, no RRSP vs TFSA optimization, no capital gains distribution tracking. Professional robo-advisors (Wealthfront, Betterment) make tax-loss harvesting a core feature.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">NO REBALANCING ALERTS</span></div>
                    <div class="glossary-def"><strong>No Drift Monitoring</strong> -- No automated rebalancing recommendations when portfolio allocation drifts from target. No alerts when a fund deviates from its stated strategy (style drift detection). Manual monitoring required.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">NO MARKET REGIME CORRELATION</span></div>
                    <div class="glossary-def"><strong>Context-Blind Analysis</strong> -- No correlation with broader market regime (bull/bear/sideways). Fund performance varies dramatically across market conditions but our analysis treats all periods equally.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">SINGLE DATA SOURCE</span></div>
                    <div class="glossary-def"><strong>Yahoo Finance Only</strong> -- All NAV data comes from Yahoo Finance. No Morningstar ratings integration, no Lipper data, no Bloomberg Terminal data. World-class fund analysis platforms use 5-10 data sources for comprehensive coverage.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">NO STYLE DRIFT DETECTION</span></div>
                    <div class="glossary-def"><strong>Manager Risk Ignored</strong> -- Mutual fund managers may change their investment strategy over time (style drift). A "large-cap value" fund may gradually shift to "large-cap growth." Without style drift detection, past performance may not reflect future approach.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">NO MANAGER TENURE TRACKING</span></div>
                    <div class="glossary-def"><strong>Key Predictor Missing</strong> -- Manager tenure is one of the strongest predictors of future fund performance consistency. When a star manager leaves, historical returns become less predictive. We do not track manager changes or tenure length.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">NO FLOW DATA</span></div>
                    <div class="glossary-def"><strong>Capital Flows Ignored</strong> -- Fund inflows and outflows affect returns. Large outflows force fund managers to sell holdings at unfavorable prices. Large inflows create cash drag. Professional fund analysis always includes flow data.</div>
                </div>
            </div>

            <h3 class="section-title" style="color:#3b82f6;margin-top:1.5rem;">Improvement Roadmap</h3>
            <div class="glossary-grid">
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">DONE: ANALYSIS TOOLS</span></div>
                    <div class="glossary-def"><strong>Backtesting Infrastructure Complete</strong> -- What-If analysis, strategy comparison, algorithm comparison, portfolio templates, fund picks database, and backtest history are all operational. 10 preset scenarios, interactive charts, saveable results.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">DONE: FUND PICKS</span></div>
                    <div class="glossary-def"><strong>45 Picks Generated</strong> -- Multiple algorithms have generated fund picks with scores, ratings, and Morningstar star ratings. Yahoo Finance NAV data imported for backtesting against historical scenarios.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                    <div class="glossary-term"><span class="badge badge-red">PHASE 1: EXPENSE OPTIMIZATION</span></div>
                    <div class="glossary-def"><strong>Highest Impact Fix</strong> -- Factor expense ratios into fund selection and ranking. Build expense ratio vs returns scatter plot. Flag funds where fees erode returns below index fund alternatives. This single feature would provide more value than any other improvement.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(245,158,11,0.3);">
                    <div class="glossary-term"><span class="badge badge-yellow">PHASE 2: MORNINGSTAR DATA</span></div>
                    <div class="glossary-def"><strong>Data Source Expansion</strong> -- Integrate Morningstar ratings and categories for richer fund analysis. Morningstar is the gold standard for mutual fund analysis ($200/yr subscription). Would add analyst ratings, category rankings, and style box classification.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(59,130,246,0.3);">
                    <div class="glossary-term"><span class="badge badge-blue">PHASE 3: LIVE TRACKING</span></div>
                    <div class="glossary-def"><strong>Forward-Facing Outcome Tracking</strong> -- Connect fund picks to actual NAV tracking with entry prices, exit conditions, and daily P&amp;L recording. Same model as Consolidated Stock Picks. Daily refresh via GitHub Actions.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">DONE: ML PIPELINE (Feb 12)</span></div>
                    <div class="glossary-def"><strong>Walk-Forward ML Deployed</strong> -- mutualfund_ml_optimizer.py (1,438 lines) with walk-forward validation, Sharpe optimization, expense ratio drag, cross-algo correlation. Runs weekly via GitHub Actions. Also: concept drift detection, multi-timeframe regime, online incremental learning.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(59,130,246,0.3);">
                    <div class="glossary-term"><span class="badge badge-blue">PHASE 5: TAX EFFICIENCY</span></div>
                    <div class="glossary-def"><strong>Tax-Loss Harvesting &amp; RRSP/TFSA Optimization</strong> -- Score funds by tax efficiency. Suggest tax-loss harvesting opportunities. Optimize fund placement across registered (RRSP, TFSA) and non-registered accounts based on distribution types.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(59,130,246,0.3);">
                    <div class="glossary-term"><span class="badge badge-blue">PHASE 6: REBALANCING</span></div>
                    <div class="glossary-def"><strong>Drift Monitoring &amp; Alerts</strong> -- Automated detection of portfolio drift from target allocation. Style drift detection for individual funds. Rebalancing recommendations with tax-aware trade suggestions.</div>
                </div>
            </div>

            <h3 class="section-title" style="color:#eab308;margin-top:1.5rem;">Is It Production Ready?</h3>
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;">
                <p style="font-size:0.9rem;color:#e0e0f0;margin-bottom:0.8rem;"><strong>Short Answer: It is a research/analysis tool, not a trading system.</strong></p>
                <p style="font-size:0.85rem;color:#889;margin-bottom:0.5rem;">Here is where we actually stand:</p>
                <ul style="font-size:0.85rem;color:#889;margin-left:1.5rem;margin-bottom:0.8rem;">
                    <li>The analysis tools work well for backtesting scenarios and comparing strategies</li>
                    <li>45 fund picks exist but <strong>none are tracked with real outcomes</strong></li>
                    <li><span style="color:#22c55e;">&check;</span> ML pipeline deployed (walk-forward grid search + drift detection)</li>
                    <li>No expense ratio optimization (the single most impactful feature for fund investors)</li>
                    <li>Data source: Yahoo Finance only -- no Morningstar, no Lipper, no Bloomberg</li>
                </ul>
                <p style="font-size:0.85rem;color:#e0e0f0;"><strong>What milestones remain?</strong></p>
                <ul style="font-size:0.85rem;color:#889;margin-left:1.5rem;margin-bottom:0.8rem;">
                    <li><strong>Expense ratio optimization</strong> &rarr; Factor fees into fund selection (highest impact)</li>
                    <li><strong>Forward tracking built</strong> &rarr; Record entry/exit prices for every pick</li>
                    <li><strong>20+ closed positions</strong> &rarr; ML grid search can activate</li>
                    <li><strong>Morningstar integration</strong> &rarr; Gold standard fund data</li>
                    <li><strong>Tax efficiency scoring</strong> &rarr; RRSP/TFSA optimization</li>
                </ul>
                <p style="font-size:0.85rem;color:#f59e0b;"><strong>Current Status:</strong> The backtesting and analysis tools on this page are fully functional for research purposes. Fund picks are generated by multiple algorithms with scores and ratings. However, there is zero forward-facing validation -- no picks have been tracked against real outcomes. Do NOT treat backtest results as predictive of future performance. Build the forward tracker before making allocation decisions.</p>
            </div>

            <h3 class="section-title" style="color:#a855f7;margin-top:1.5rem;">Architecture</h3>
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;">
                <p style="font-size:0.85rem;color:#889;margin-bottom:0.8rem;">System components and data flow:</p>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;">
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Data Source: Yahoo Finance</div>
                        <div style="font-size:0.78rem;color:#889;">Daily NAV data for all tracked mutual funds. Single data source -- no Morningstar, no Lipper, no Bloomberg integration. NAV prices fetched via fetch_prices.php and stored in the database for backtesting.</div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">API: mutual_fund_portfolio.php</div>
                        <div style="font-size:0.78rem;color:#889;">PHP backend handles stats, fund data, and backtest operations. Actions: stats (portfolio overview), funds (fund list with NAV), backtests (saved scenario results). Located at findmutualfunds2/portfolio2/api/.</div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Backtest Engine: whatif.php</div>
                        <div style="font-size:0.78rem;color:#889;">Runs What-If scenarios, strategy comparisons, and algorithm comparisons against historical NAV data. Configurable TP/SL/hold parameters. Supports saving results to database.</div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Fund Picks: data.php?type=picks</div>
                        <div style="font-size:0.78rem;color:#889;">45 fund picks across multiple algorithms. Each pick includes ticker, fund name, family, category, NAV, score, rating, Morningstar stars, and expense ratio. Filterable by algorithm.</div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Portfolio Templates: data.php?type=portfolios</div>
                        <div style="font-size:0.78rem;color:#889;">Pre-configured fund portfolio strategies with backtest capability. Different investor profiles (conservative, growth, income, aggressive). Each template has preset TP/SL/hold/capital/sizing parameters.</div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Frontend: This Portfolio Page</div>
                        <div style="font-size:0.78rem;color:#889;">What-If analysis, strategy comparison, algorithm comparison, portfolio templates, fund picks, backtest history, system analysis, and research tabs. Interactive charts via Chart.js. Fully functional for backtesting and research.</div>
                    </div>
                </div>
            </div>

            <div style="margin-top:1.5rem;padding:1rem;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:12px;">
                <div style="font-weight:600;color:#22c55e;margin-bottom:0.5rem;">Bottom Line</div>
                <p style="font-size:0.85rem;color:#889;">The mutual fund analysis tools are solid for backtesting and research -- multiple scenario presets, algorithm comparisons, portfolio templates, and saveable results. However, the system has zero forward-facing performance tracking. 45 picks exist but none have been tracked against real outcomes. The highest-impact next step is building expense ratio optimization, followed by a forward-facing outcome tracker modeled after the Consolidated Stock Picks system.</p>
            </div>
        </div>

        <!-- ═══════════ TAB: Research & Future ═══════════ -->
        <div class="tab-content" id="tab-research">
            <div class="grade-explainer" style="background:linear-gradient(135deg,rgba(168,85,247,0.08),rgba(99,102,241,0.08));border-color:rgba(168,85,247,0.3);">
                <div class="ge-title" style="color:#a855f7;">Research &amp; Future Enhancements</div>
                This section documents our research into professional mutual fund analysis, the academic foundations behind fund selection, and the benchmarks we are targeting. Understanding how institutional fund analysis platforms operate is essential for building systems that can compete with Morningstar, Vanguard, and robo-advisors.
            </div>

            <h3 class="section-title" style="color:#6366f1;">Core Methodology: Backtested Strategy Comparison</h3>
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;">
                <p style="font-size:0.85rem;color:#889;margin-bottom:0.8rem;">Our system evaluates mutual funds by backtesting different holding strategies against historical NAV data. The core approach:</p>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
                    <div style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#22c55e;margin-bottom:0.3rem;">Scenario-Based Backtesting</div>
                        <div style="font-size:0.78rem;color:#889;">10 preset scenarios test different investment approaches: from Short Tactical (5% target, 14-day hold) to Buy &amp; Hold 1-Year (25% target, 252-day hold). Each scenario applies configurable take-profit, stop-loss, and max hold rules to historical NAV data.</div>
                    </div>
                    <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">Multi-Algorithm Selection</div>
                        <div style="font-size:0.78rem;color:#889;">Multiple algorithms generate fund picks using different selection criteria. Each algorithm can be tested independently or in combination. Algorithm comparison reveals which selection method works best for different market conditions and holding periods.</div>
                    </div>
                </div>
            </div>

            <h3 class="section-title" style="color:#22c55e;margin-top:1.5rem;">Key Mutual Fund Concepts</h3>
            <div class="glossary-grid">
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">ACTIVE VS PASSIVE</span></div>
                    <div class="glossary-def"><strong>The Central Debate in Fund Selection</strong> -- Fama &amp; French (2010) demonstrated that most actively managed mutual funds underperform their benchmark indices after fees. Over 15-year periods, roughly 90% of active large-cap funds fail to beat the S&amp;P 500. This makes expense ratios the single most predictive factor in fund selection.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">EXPENSE RATIO IMPACT</span></div>
                    <div class="glossary-def"><strong>The Silent Return Killer</strong> -- Carhart (1997) showed that each 1% in annual fees costs approximately 17% of total returns over a 20-year horizon due to compounding drag. A fund returning 8% gross with a 1.5% expense ratio delivers only 6.5% net -- and that 1.5% compounds against the investor every year.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">FACTOR INVESTING</span></div>
                    <div class="glossary-def"><strong>Beyond Market Cap Weighting</strong> -- Academic research identifies persistent return factors: momentum (recent winners keep winning), value (cheap stocks outperform), quality (profitable companies outperform), and low-volatility (boring stocks have higher risk-adjusted returns). Smart beta mutual funds target these factors systematically.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">SHARPE RATIO</span></div>
                    <div class="glossary-def"><strong>Risk-Adjusted Return Metric</strong> -- Measures excess return per unit of risk. A Sharpe ratio above 1.0 indicates good risk-adjusted performance. However, Sharpe ratio has limitations with non-normal return distributions (fat tails, skewness) common in mutual fund returns. Sortino ratio may be more appropriate for downside-focused investors.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">SURVIVORSHIP BIAS</span></div>
                    <div class="glossary-def"><strong>Hidden Data Problem</strong> -- Fund databases drop funds that close or merge, removing the worst performers from historical records. This inflates average reported returns by 1-2% annually. Any backtest using only currently-existing funds overstates expected performance. Our system is exposed to this bias.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                    <div class="glossary-term"><span class="badge badge-green">MORNINGSTAR STARS</span></div>
                    <div class="glossary-def"><strong>Backward-Looking Metric</strong> -- Kinnel (2010) showed that Morningstar's star ratings predict expense ratios more than future returns. 5-star funds do not consistently outperform 3-star funds. The stars reflect past risk-adjusted performance, not future potential. Expense ratio is a better predictor of future fund performance.</div>
                </div>
            </div>

            <h3 class="section-title" style="color:#f97316;margin-top:1.5rem;">Market Inefficiencies in Mutual Funds</h3>
            <div class="glossary-grid">
                <div class="glossary-item" style="border-color:rgba(249,115,22,0.3);">
                    <div class="glossary-term"><span class="badge badge-orange">WINDOW DRESSING</span></div>
                    <div class="glossary-def">Fund managers buy recent winners and sell losers before quarter-end reporting to make their portfolio look better. This creates predictable end-of-quarter trading patterns. Academic research documents this across thousands of funds.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(249,115,22,0.3);">
                    <div class="glossary-term"><span class="badge badge-orange">TAX INEFFICIENCY</span></div>
                    <div class="glossary-def">Many active mutual funds generate significant capital gains distributions that investors must pay taxes on, even if they did not sell their fund shares. Index funds and ETFs are typically more tax-efficient due to lower turnover. Tax drag can reduce after-tax returns by 1-2% annually.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(249,115,22,0.3);">
                    <div class="glossary-term"><span class="badge badge-orange">CASH DRAG</span></div>
                    <div class="glossary-def">Active funds typically hold 3-10% in cash for redemption buffers. In rising markets, this cash drag reduces returns vs fully-invested index funds. Some fund families use credit facilities to minimize cash drag, but most smaller funds absorb the cost.</div>
                </div>
                <div class="glossary-item" style="border-color:rgba(249,115,22,0.3);">
                    <div class="glossary-term"><span class="badge badge-orange">CLOSET INDEXING</span></div>
                    <div class="glossary-def">Some actively managed funds charge active management fees (1-2%) while closely tracking their benchmark index (R-squared &gt; 0.95). Investors pay active fees for passive returns. "Active share" measures how different a fund is from its benchmark -- low active share indicates closet indexing.</div>
                </div>
            </div>

            <h3 class="section-title" style="color:#a855f7;margin-top:1.5rem;">Key Research Sources</h3>
            <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;">
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;">
                    <div style="font-size:0.8rem;color:#889;line-height:1.6;">
                        <strong style="color:#a855f7;">Fama &amp; French (2010)</strong><br>
                        "Luck versus Skill in the Cross-Section of Mutual Fund Returns" -- Demonstrated that the distribution of mutual fund returns matches what would be expected from chance alone. After fees, most active managers do not deliver alpha. The few that do are statistically indistinguishable from lucky coin flippers.
                    </div>
                    <div style="font-size:0.8rem;color:#889;line-height:1.6;">
                        <strong style="color:#a855f7;">Carhart (1997)</strong><br>
                        "On Persistence in Mutual Fund Performance" -- Extended the Fama-French 3-factor model with a momentum factor. Showed that most apparent fund outperformance is explained by factor exposures and fees, not manager skill. Expense ratios are the strongest negative predictor of fund returns.
                    </div>
                    <div style="font-size:0.8rem;color:#889;line-height:1.6;">
                        <strong style="color:#a855f7;">Kinnel (2010)</strong><br>
                        "How Expense Ratios and Star Ratings Predict Success" -- Morningstar's own director of research found that expense ratios are a better predictor of future fund performance than Morningstar's own star ratings. The cheapest quintile of funds outperformed the most expensive quintile in every category.
                    </div>
                    <div style="font-size:0.8rem;color:#889;line-height:1.6;">
                        <strong style="color:#a855f7;">Cremers &amp; Petajisto (2009)</strong><br>
                        "How Active Is Your Fund Manager?" -- Introduced the "active share" concept. Funds with high active share (truly different from benchmark) outperform after fees, while closet indexers (low active share) underperform. Active share is the best predictor of fund performance persistence.
                    </div>
                </div>
            </div>

            <h3 class="section-title" style="color:#22c55e;margin-top:1.5rem;">How We Apply This Research</h3>
            <div style="background:linear-gradient(135deg,rgba(34,197,94,0.08),rgba(99,102,241,0.08));border:1px solid rgba(34,197,94,0.2);border-radius:12px;padding:1rem;margin-bottom:1rem;">
                <p style="font-size:0.85rem;color:#889;margin-bottom:0.8rem;">Our system incorporates academic findings in these ways:</p>
                <ul style="font-size:0.85rem;color:#889;margin-left:1.5rem;margin-bottom:0.8rem;">
                    <li><strong>Multiple Scenarios:</strong> 10 preset strategies test different holding periods and exit rules, matching academic findings on optimal rebalancing frequencies</li>
                    <li><strong>Algorithm Comparison:</strong> Side-by-side testing reveals which fund selection approaches work for different market conditions</li>
                    <li><strong>Disciplined Exits:</strong> TP/SL framework prevents the common mistake of holding underperforming funds indefinitely</li>
                    <li><strong>Expense Ratio Display:</strong> Shown for each fund pick (but not yet factored into selection -- a known gap)</li>
                    <li><strong>Morningstar Stars:</strong> Displayed as context but not the primary selection criterion (per Kinnel 2010 findings)</li>
                </ul>
                <p style="font-size:0.85rem;color:#f59e0b;"><strong>Not yet applied:</strong> Expense ratio optimization (Carhart 1997), active share filtering (Cremers &amp; Petajisto), tax-loss harvesting, survivorship bias correction, factor exposure analysis, style drift detection, flow data tracking, rebalancing automation.</p>
            </div>

            <h3 class="section-title" style="color:#10b981;margin-top:1.5rem;">Future Enhancements &amp; Research Priorities</h3>
            <div style="background:var(--bg-card);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:1rem;margin-bottom:1rem;">
                <p style="font-size:0.85rem;color:#e0e0f0;margin-bottom:0.8rem;"><strong>Based on academic research and competitive analysis, these are the highest-impact improvements:</strong></p>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
                    <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#ef4444;margin-bottom:0.3rem;">P1: Expense Ratio Optimization</div>
                        <div style="font-size:0.78rem;color:#889;">Highest-impact feature. Factor expense ratios into fund selection and ranking. Build expense vs return scatter plots. Auto-flag funds where fees erode returns below comparable index fund alternatives. Carhart (1997) shows this is the strongest predictor of future fund returns.</div>
                    </div>
                    <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#f59e0b;margin-bottom:0.3rem;">P2: Morningstar Data Integration</div>
                        <div style="font-size:0.78rem;color:#889;">Morningstar is the gold standard for fund analysis ($200/yr). Would add analyst ratings (gold/silver/bronze), category rankings, style box classification, and manager tenure data. Currently we rely on Yahoo Finance only.</div>
                    </div>
                    <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">P3: Live Tracking</div>
                        <div style="font-size:0.78rem;color:#889;">Connect fund picks to actual NAV tracking for forward validation. Record entry prices at pick generation, monitor daily NAV changes, apply exit rules (TP/SL/max hold). Same model as Consolidated Stock Picks with daily GitHub Actions refresh.</div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">P4: ML Pipeline</div>
                        <div style="font-size:0.78rem;color:#889;">Learn which fund characteristics predict outperformance: expense ratio, AUM, manager tenure, category, factor exposures, active share, flow trends. Requires 20+ closed positions for grid search activation. Walk-forward validation before deployment.</div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">P5: Tax Efficiency Scoring</div>
                        <div style="font-size:0.78rem;color:#889;">Score funds by tax efficiency (turnover ratio, capital gains distribution history). Suggest tax-loss harvesting opportunities. Optimize fund placement: high-turnover funds in registered accounts (RRSP, TFSA), tax-efficient funds in taxable accounts.</div>
                    </div>
                    <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                        <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">P6: Rebalancing &amp; Drift Monitoring</div>
                        <div style="font-size:0.78rem;color:#889;">Automated detection of portfolio allocation drift from targets. Style drift detection for individual funds (when a "value" fund starts behaving like "growth"). Rebalancing alerts with tax-aware trade suggestions to minimize capital gains realization.</div>
                    </div>
                </div>
            </div>

            <h3 class="section-title" style="color:#f59e0b;margin-top:1.5rem;">World-Class Benchmark Comparison</h3>
            <div style="background:var(--bg-card);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:1rem;margin-bottom:1rem;">
                <p style="font-size:0.85rem;color:#889;margin-bottom:0.8rem;">How top mutual fund analysis platforms compare, and where we need to be:</p>
                <div style="overflow-x:auto;">
                    <table style="width:100%;font-size:0.78rem;color:#889;border-collapse:collapse;">
                        <thead>
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                                <th style="text-align:left;padding:0.5rem;color:#e0e0f0;">Metric</th>
                                <th style="text-align:center;padding:0.5rem;color:#22c55e;">World-Class Target</th>
                                <th style="text-align:center;padding:0.5rem;color:#f59e0b;">Our Current</th>
                                <th style="text-align:center;padding:0.5rem;color:#3b82f6;">Gap</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                <td style="padding:0.5rem;">Data Sources</td>
                                <td style="text-align:center;padding:0.5rem;">5-10 (Morningstar, Lipper, Bloomberg)</td>
                                <td style="text-align:center;padding:0.5rem;">1 (Yahoo Finance)</td>
                                <td style="text-align:center;padding:0.5rem;color:#ef4444;">Critical gap</td>
                            </tr>
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                <td style="padding:0.5rem;">Expense Optimization</td>
                                <td style="text-align:center;padding:0.5rem;">Yes (core feature)</td>
                                <td style="text-align:center;padding:0.5rem;">None (displayed only)</td>
                                <td style="text-align:center;padding:0.5rem;color:#ef4444;">Highest priority</td>
                            </tr>
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                <td style="padding:0.5rem;">Tax Awareness</td>
                                <td style="text-align:center;padding:0.5rem;">Full tax-lot tracking</td>
                                <td style="text-align:center;padding:0.5rem;">None</td>
                                <td style="text-align:center;padding:0.5rem;color:#ef4444;">Not implemented</td>
                            </tr>
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                <td style="padding:0.5rem;">ML Integration</td>
                                <td style="text-align:center;padding:0.5rem;">Walk-forward validated</td>
                                <td style="text-align:center;padding:0.5rem;">None (no data to train)</td>
                                <td style="text-align:center;padding:0.5rem;color:#ef4444;">Need forward tracker first</td>
                            </tr>
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                <td style="padding:0.5rem;">Rebalancing</td>
                                <td style="text-align:center;padding:0.5rem;">Automated with tax awareness</td>
                                <td style="text-align:center;padding:0.5rem;">None</td>
                                <td style="text-align:center;padding:0.5rem;color:#ef4444;">Not implemented</td>
                            </tr>
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                                <td style="padding:0.5rem;">Live Tracking</td>
                                <td style="text-align:center;padding:0.5rem;">Real-time NAV + P&amp;L</td>
                                <td style="text-align:center;padding:0.5rem;">None (backtest only)</td>
                                <td style="text-align:center;padding:0.5rem;color:#ef4444;">Zero forward data</td>
                            </tr>
                            <tr>
                                <td style="padding:0.5rem;">Forward Validation</td>
                                <td style="text-align:center;padding:0.5rem;">Yes (with attribution)</td>
                                <td style="text-align:center;padding:0.5rem;">0 tracked outcomes</td>
                                <td style="text-align:center;padding:0.5rem;color:#ef4444;">45 picks, 0 tracked</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="font-size:0.78rem;color:#666;margin-top:1rem;">Benchmark platforms: Vanguard ($7T AUM, lowest-cost index funds), Morningstar (gold standard analysis, $200/yr), Wealthfront (robo-advisor, tax-loss harvesting), Betterment (goal-based allocation), Fidelity (Zero-fee index funds, fund screener).</p>
            </div>

            <div style="margin-top:1.5rem;padding:1rem;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:12px;">
                <div style="font-weight:600;color:#ef4444;margin-bottom:0.5rem;">The Hard Truth</div>
                <p style="font-size:0.85rem;color:#889;">Our mutual fund system has solid backtesting and analysis tools but zero forward-facing performance data. The 45 fund picks are generated by algorithms but have never been tracked against real outcomes. Without live tracking, we cannot validate whether our fund selection actually outperforms simple index fund investing -- and academic research (Fama &amp; French 2010) strongly suggests most active fund selection strategies do not. The single highest-impact improvement is adding expense ratio optimization, because research consistently shows that fees are the strongest predictor of future fund returns. Until we build forward tracking and expense optimization, this system is a research tool, not a fund selection platform that can compete with Morningstar or robo-advisors.</p>
            </div>
        </div>

    </div>

<script>
// ─── Config ───
var API = './api/';

var SCENARIOS = {
    short_tactical:       { name: 'Short Tactical',       tp: 5,  sl: 3,  hold: 14 },
    momentum_monthly:     { name: 'Momentum Monthly',     tp: 8,  sl: 5,  hold: 30 },
    swing_quarter:        { name: 'Swing Quarter',        tp: 12, sl: 6,  hold: 60 },
    conservative_hold:    { name: 'Conservative Hold',    tp: 6,  sl: 4,  hold: 90 },
    growth_6m:            { name: 'Growth 6-Month',       tp: 18, sl: 10, hold: 126 },
    buy_hold_1y:          { name: 'Buy & Hold 1-Year',    tp: 25, sl: 15, hold: 252 },
    income_steady:        { name: 'Income Steady',        tp: 5,  sl: 3,  hold: 90 },
    aggressive_rotation:  { name: 'Aggressive Rotation',  tp: 15, sl: 8,  hold: 21 },
    value_patient:        { name: 'Value Patient',        tp: 20, sl: 12, hold: 180 },
    balanced_moderate:    { name: 'Balanced Moderate',     tp: 10, sl: 6,  hold: 60 }
};

var scenarios = [];
var algorithms = [];
var chartEquity = null;
var chartExits = null;
var chartCompare = null;
var chartAlgoCmp = null;

// ─── Init ───
document.addEventListener('DOMContentLoaded', function() {
    initTabs();
    loadStats();
    loadScenarios();
    loadAlgorithms();
    loadPortfolios();
    loadHistory();
});

function initTabs() {
    var tabs = document.querySelectorAll('.tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].addEventListener('click', function() {
            var all = document.querySelectorAll('.tab');
            for (var j = 0; j < all.length; j++) { all[j].classList.remove('active'); }
            this.classList.add('active');
            var contents = document.querySelectorAll('.tab-content');
            for (var j = 0; j < contents.length; j++) { contents[j].classList.remove('active'); }
            document.getElementById('tab-' + this.getAttribute('data-tab')).classList.add('active');

            // Lazy-load picks on first visit
            if (this.getAttribute('data-tab') === 'picks' && !this._loaded) {
                this._loaded = true;
                loadPicks();
            }
            // Lazy-load tracking on first visit
            if (this.getAttribute('data-tab') === 'tracking' && !this._loaded) {
                this._loaded = true;
                loadTracking();
            }
        });
    }
}

// ─── API Helpers ───
function apiGet(endpoint, cb) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', API + endpoint, true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            try { cb(JSON.parse(xhr.responseText)); }
            catch(e) { cb({ ok: false, error: 'Parse error: ' + e.message }); }
        } else { cb({ ok: false, error: 'HTTP ' + xhr.status }); }
    };
    xhr.onerror = function() { cb({ ok: false, error: 'Network error' }); };
    xhr.send();
}

function fmt(num, decimals) {
    if (num === null || num === undefined || isNaN(num)) return '-';
    return parseFloat(num).toFixed(decimals !== undefined ? decimals : 2);
}

function fmtDollar(num) {
    if (num === null || num === undefined || isNaN(num)) return '-';
    return '$' + parseFloat(num).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function fmtInt(num) {
    if (num === null || num === undefined || isNaN(num)) return '-';
    return parseInt(num).toLocaleString();
}

// ─── Load Data ───
function loadStats() {
    apiGet('data.php?type=stats', function(d) {
        if (!d.ok || !d.stats) {
            document.getElementById('setup-banner').style.display = 'block';
            return;
        }
        var s = d.stats;
        document.getElementById('stat-funds').textContent = s.total_funds || s.total_stocks || 0;
        document.getElementById('stat-picks').textContent = s.total_picks || 0;
        document.getElementById('stat-navs').textContent = fmtInt(s.total_nav_records || s.total_price_records || 0);
        document.getElementById('stat-algos').textContent = s.active_algorithms || 0;
        document.getElementById('stat-backtests').textContent = s.total_backtests || 0;
        if ((s.total_picks || 0) === 0) {
            document.getElementById('setup-banner').style.display = 'block';
        }
    });
}

function loadScenarios() {
    apiGet('data.php?type=scenarios', function(d) {
        if (!d.ok || !d.scenarios) return;
        scenarios = d.scenarios;
        var sel2 = document.getElementById('ac-scenario');
        for (var i = 0; i < scenarios.length; i++) {
            var s = scenarios[i];
            var o2 = document.createElement('option');
            o2.value = s.key;
            o2.textContent = s.name + ' (TR:' + s.tp + '% SL:' + s.sl + '% Hold:' + s.hold + 'd)';
            sel2.appendChild(o2);
        }
    });
}

function loadAlgorithms() {
    apiGet('data.php?type=algorithms', function(d) {
        if (!d.ok || !d.algorithms) return;
        algorithms = d.algorithms;
        renderAlgoChecks('wi-algos', algorithms);
        renderAlgoChecks('cmp-algos', algorithms);
        var sel = document.getElementById('picks-algo-filter');
        for (var i = 0; i < algorithms.length; i++) {
            var o = document.createElement('option');
            o.value = algorithms[i].name;
            o.textContent = algorithms[i].name + ' (' + (algorithms[i].pick_count || 0) + ')';
            sel.appendChild(o);
        }
    });
}

function renderAlgoChecks(containerId, algos) {
    var c = document.getElementById(containerId);
    c.innerHTML = '';
    for (var i = 0; i < algos.length; i++) {
        var lbl = document.createElement('label');
        lbl.className = 'algo-check';
        var chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.value = algos[i].name;
        chk.checked = true;
        lbl.appendChild(chk);
        lbl.appendChild(document.createTextNode(algos[i].name));
        c.appendChild(lbl);
    }
}

function getCheckedAlgos(containerId) {
    var checks = document.querySelectorAll('#' + containerId + ' input[type=checkbox]:checked');
    var arr = [];
    for (var i = 0; i < checks.length; i++) arr.push(checks[i].value);
    var total = document.querySelectorAll('#' + containerId + ' input[type=checkbox]').length;
    if (arr.length === total) return '';
    return arr.join(',');
}

function applyScenario() {
    var key = document.getElementById('wi-scenario').value;
    if (!key) return;
    var s = SCENARIOS[key];
    if (s) {
        document.getElementById('wi-tp').value = s.tp;
        document.getElementById('wi-sl').value = s.sl;
        document.getElementById('wi-hold').value = s.hold;
    }
    // Also try from server-loaded scenarios
    for (var i = 0; i < scenarios.length; i++) {
        if (scenarios[i].key === key) {
            document.getElementById('wi-tp').value = scenarios[i].tp;
            document.getElementById('wi-sl').value = scenarios[i].sl;
            document.getElementById('wi-hold').value = scenarios[i].hold;
            break;
        }
    }
}

// ─── What-If Analysis ───
function runWhatIf(save) {
    var btn = document.getElementById('btn-run-whatif');
    btn.disabled = true;
    btn.textContent = 'Running...';

    var scenario = document.getElementById('wi-scenario').value;
    var params = 'scenario=' + (scenario || 'custom')
        + '&target_return=' + document.getElementById('wi-tp').value
        + '&stop_loss=' + document.getElementById('wi-sl').value
        + '&max_hold_days=' + document.getElementById('wi-hold').value
        + '&initial_capital=' + document.getElementById('wi-capital').value;

    var algos = getCheckedAlgos('wi-algos');
    if (algos) params += '&algorithms=' + encodeURIComponent(algos);

    if (save) params += '&save=1';

    apiGet('whatif.php?' + params, function(d) {
        btn.disabled = false;
        btn.textContent = 'Run Analysis';
        if (!d.ok) {
            alert('Error: ' + (d.error || 'Unknown'));
            return;
        }
        renderWhatIfResults(d);
    });
}

function renderWhatIfResults(d) {
    var el = document.getElementById('wi-results');
    el.style.display = 'block';
    document.getElementById('btn-save-whatif').style.display = 'inline-block';

    var s = d.summary;
    if (!s) { el.innerHTML = '<div class="card"><p style="color:var(--text-dim);">No results returned. Make sure NAV data has been fetched.</p></div>'; return; }

    var statsHtml = '';
    var metrics = [
        ['Final Value', fmtDollar(s.final_value), (s.total_return_pct || 0) >= 0 ? 'positive' : 'negative'],
        ['Total Return', fmt(s.total_return_pct) + '%', (s.total_return_pct || 0) >= 0 ? 'positive' : 'negative'],
        ['Win Rate', fmt(s.win_rate, 1) + '%', (s.win_rate || 0) >= 50 ? 'positive' : 'negative'],
        ['Trades', s.total_trades || 0, ''],
        ['Avg Win', '+' + fmt(s.avg_win_pct) + '%', 'positive'],
        ['Avg Loss', '-' + fmt(s.avg_loss_pct) + '%', 'negative'],
        ['Max Drawdown', fmt(s.max_drawdown_pct) + '%', 'negative'],
        ['Fee Drag', fmtDollar(s.total_commissions || s.fee_drag || 0), 'negative'],
        ['Sharpe', fmt(s.sharpe_ratio, 3), (s.sharpe_ratio || 0) > 0 ? 'positive' : 'negative'],
        ['Profit Factor', fmt(s.profit_factor), (s.profit_factor || 0) > 1 ? 'positive' : 'negative'],
        ['Expectancy', fmt(s.expectancy), (s.expectancy || 0) > 0 ? 'positive' : 'negative'],
        ['Avg Hold', fmt(s.avg_hold_days || 0, 1) + 'd', '']
    ];
    for (var i = 0; i < metrics.length; i++) {
        var m = metrics[i];
        statsHtml += '<div class="stat-card"><div class="label">' + m[0] + '</div><div class="value ' + m[2] + '">' + m[1] + '</div></div>';
    }
    document.getElementById('wi-stats').innerHTML = statsHtml;

    // Equity curve
    if (d.equity_curve && d.equity_curve.length > 0) {
        renderEquityCurve(d.equity_curve);
    }

    // Exit reasons pie
    if (d.exit_reasons) {
        renderExitPie(d.exit_reasons);
    }

    // Algorithm breakdown
    if (d.algorithm_breakdown) {
        var tbody = document.querySelector('#wi-algo-table tbody');
        tbody.innerHTML = '';
        for (var i = 0; i < d.algorithm_breakdown.length; i++) {
            var a = d.algorithm_breakdown[i];
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + a.algorithm + '</td><td>' + a.trades + '</td>'
                + '<td>' + a.wins + '</td><td>' + a.losses + '</td>'
                + '<td>' + fmt(a.win_rate, 1) + '%</td>'
                + '<td class="' + ((a.avg_return_pct || 0) >= 0 ? 'pct-positive' : 'pct-negative') + '">' + fmt(a.avg_return_pct) + '%</td>'
                + '<td class="' + ((a.total_pnl || 0) >= 0 ? 'pct-positive' : 'pct-negative') + '">' + fmtDollar(a.total_pnl) + '</td>';
            tbody.appendChild(tr);
        }
    }

    // Trade log
    if (d.trades) {
        var tbody2 = document.querySelector('#wi-trades-table tbody');
        tbody2.innerHTML = '';
        var maxShow = Math.min(d.trades.length, 200);
        for (var i = 0; i < maxShow; i++) {
            var t = d.trades[i];
            var tr = document.createElement('tr');
            tr.innerHTML = '<td><strong>' + (t.ticker || t.symbol) + '</strong></td><td>' + t.algorithm + '</td>'
                + '<td>' + t.entry_date + '</td><td>$' + fmt(t.entry_price || t.entry_nav) + '</td>'
                + '<td>' + (t.exit_date || '-') + '</td><td>$' + fmt(t.exit_price || t.exit_nav) + '</td>'
                + '<td>' + (t.units || t.shares || 0) + '</td>'
                + '<td class="' + ((t.net_profit || 0) >= 0 ? 'pct-positive' : 'pct-negative') + '">' + fmtDollar(t.net_profit) + '</td>'
                + '<td class="' + ((t.return_pct || 0) >= 0 ? 'pct-positive' : 'pct-negative') + '">' + fmt(t.return_pct) + '%</td>'
                + '<td>' + (t.hold_days || 0) + '</td>'
                + '<td><span class="badge ' + exitBadge(t.exit_reason || '') + '">' + (t.exit_reason || '').replace(/_/g, ' ') + '</span></td>';
            tbody2.appendChild(tr);
        }
        if (d.trades.length > 200) {
            var note = document.createElement('tr');
            note.innerHTML = '<td colspan="11" style="text-align:center;color:var(--text-dim);">Showing first 200 of ' + d.trades.length + ' trades</td>';
            tbody2.appendChild(note);
        }
    }
}

function exitBadge(reason) {
    if (reason === 'target_return' || reason === 'take_profit') return 'badge-green';
    if (reason === 'stop_loss') return 'badge-red';
    if (reason === 'max_hold') return 'badge-yellow';
    return 'badge-blue';
}

function renderEquityCurve(curve) {
    var ctx = document.getElementById('chart-equity').getContext('2d');
    if (chartEquity) chartEquity.destroy();
    var labels = [];
    var data = [];
    for (var i = 0; i < curve.length; i++) {
        labels.push(curve[i].trade || (i + 1));
        data.push(curve[i].capital);
    }
    chartEquity = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Portfolio Value ($)',
                data: data,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 0
            }, {
                label: 'Starting Capital',
                data: new Array(data.length).fill(data[0] || 10000),
                borderColor: 'rgba(255,255,255,0.2)',
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#8888aa' } } },
            scales: {
                x: { ticks: { color: '#8888aa' }, grid: { color: 'rgba(42,42,74,0.5)' } },
                y: { ticks: { color: '#8888aa', callback: function(v) { return '$' + v.toLocaleString(); } }, grid: { color: 'rgba(42,42,74,0.5)' } }
            }
        }
    });
}

function renderExitPie(reasons) {
    var ctx = document.getElementById('chart-exits').getContext('2d');
    if (chartExits) chartExits.destroy();
    var labels = [];
    var data = [];
    var colors = { 'target_return': '#22c55e', 'take_profit': '#22c55e', 'stop_loss': '#ef4444', 'max_hold': '#eab308', 'end_of_data': '#3b82f6', 'no_price_data': '#8888aa', 'no_nav_data': '#8888aa' };
    for (var k in reasons) {
        if (reasons.hasOwnProperty(k)) {
            labels.push(k.replace(/_/g, ' '));
            data.push(reasons[k]);
        }
    }
    var bgColors = labels.map(function(l) {
        var key = l.replace(/ /g, '_');
        return colors[key] || '#6366f1';
    });
    chartExits = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{ data: data, backgroundColor: bgColors, borderWidth: 0 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#e0e0f0' } } }
        }
    });
}

// ─── Compare Strategies ───
function runCompare() {
    var btn = document.getElementById('btn-compare');
    btn.disabled = true;
    btn.textContent = 'Running all scenarios...';

    var params = 'compare=1';
    var algos = getCheckedAlgos('cmp-algos');
    if (algos) params += '&algorithms=' + encodeURIComponent(algos);

    apiGet('whatif.php?' + params, function(d) {
        btn.disabled = false;
        btn.textContent = 'Run Comparison';
        if (!d.ok) { alert('Error: ' + (d.error || 'Unknown')); return; }
        document.getElementById('cmp-results').style.display = 'block';

        var sc = d.scenarios;
        if (!sc || !sc.length) { alert('No scenario data returned.'); return; }

        // Chart
        var ctx = document.getElementById('chart-compare').getContext('2d');
        if (chartCompare) chartCompare.destroy();
        var labels = [];
        var returns = [];
        var barColors = [];
        for (var i = 0; i < sc.length; i++) {
            labels.push(sc[i].name);
            var ret = sc[i].summary ? sc[i].summary.total_return_pct : 0;
            returns.push(ret);
            barColors.push(ret >= 0 ? '#22c55e' : '#ef4444');
        }
        chartCompare = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Return %',
                    data: returns,
                    backgroundColor: barColors,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#8888aa', callback: function(v) { return v + '%'; } }, grid: { color: 'rgba(42,42,74,0.5)' } },
                    y: { ticks: { color: '#e0e0f0', font: { size: 11 } }, grid: { display: false } }
                }
            }
        });

        // Table
        var tbody = document.querySelector('#cmp-table tbody');
        tbody.innerHTML = '';
        for (var i = 0; i < sc.length; i++) {
            var s = sc[i].summary || {};
            var p = sc[i].params || {};
            var cls = i === 0 ? 'rank-1' : (i === sc.length - 1 ? 'rank-last' : '');
            var tr = document.createElement('tr');
            tr.className = cls;
            tr.innerHTML = '<td>' + (i + 1) + '</td><td><strong>' + sc[i].name + '</strong></td>'
                + '<td>' + (p.target_return || p.take_profit || '-') + '</td>'
                + '<td>' + (p.stop_loss || '-') + '</td>'
                + '<td>' + (p.max_hold_days || '-') + 'd</td>'
                + '<td>' + (s.total_trades || 0) + '</td>'
                + '<td>' + fmt(s.win_rate, 1) + '%</td>'
                + '<td class="' + ((s.total_return_pct || 0) >= 0 ? 'pct-positive' : 'pct-negative') + '"><strong>' + fmt(s.total_return_pct) + '%</strong></td>'
                + '<td>' + fmtDollar(s.final_value) + '</td>'
                + '<td class="pct-negative">' + fmt(s.max_drawdown_pct) + '%</td>'
                + '<td>' + fmtDollar(s.total_commissions || s.fee_drag || 0) + '</td>'
                + '<td>' + fmt(s.sharpe_ratio, 3) + '</td>'
                + '<td>' + fmt(s.profit_factor) + '</td>';
            tbody.appendChild(tr);
        }
    });
}

// ─── Compare Algorithms ───
function runAlgoCompare() {
    var params = 'compare_algos=1';
    var sc = document.getElementById('ac-scenario').value;
    if (sc) {
        params += '&scenario=' + sc;
    } else {
        params += '&target_return=' + document.getElementById('ac-tp').value
            + '&stop_loss=' + document.getElementById('ac-sl').value
            + '&max_hold_days=' + document.getElementById('ac-hold').value;
    }

    apiGet('whatif.php?' + params, function(d) {
        if (!d.ok) { alert('Error: ' + (d.error || 'Unknown')); return; }
        document.getElementById('ac-results').style.display = 'block';

        var algos = d.algorithms;
        if (!algos || !algos.length) { alert('No algorithm data returned.'); return; }

        // Chart
        var ctx = document.getElementById('chart-algo-cmp').getContext('2d');
        if (chartAlgoCmp) chartAlgoCmp.destroy();
        var labels = [];
        var returns = [];
        var barColors = [];
        for (var i = 0; i < algos.length; i++) {
            labels.push(algos[i].algorithm);
            var ret = algos[i].summary ? algos[i].summary.total_return_pct : 0;
            returns.push(ret);
            barColors.push(ret >= 0 ? '#22c55e' : '#ef4444');
        }
        chartAlgoCmp = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Total Return %', data: returns, backgroundColor: barColors, borderRadius: 4 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#8888aa', callback: function(v) { return v + '%'; } }, grid: { color: 'rgba(42,42,74,0.5)' } },
                    y: { ticks: { color: '#e0e0f0', font: { size: 11 } }, grid: { display: false } }
                }
            }
        });

        // Table
        var tbody = document.querySelector('#ac-table tbody');
        tbody.innerHTML = '';
        for (var i = 0; i < algos.length; i++) {
            var s = algos[i].summary || {};
            var cls = i === 0 ? 'rank-1' : (i === algos.length - 1 ? 'rank-last' : '');
            var tr = document.createElement('tr');
            tr.className = cls;
            tr.innerHTML = '<td>' + (i + 1) + '</td><td><strong>' + algos[i].algorithm + '</strong></td>'
                + '<td>' + (s.total_trades || 0) + '</td><td>' + fmt(s.win_rate, 1) + '%</td>'
                + '<td class="' + ((s.total_return_pct || 0) >= 0 ? 'pct-positive' : 'pct-negative') + '"><strong>' + fmt(s.total_return_pct) + '%</strong></td>'
                + '<td>' + fmtDollar(s.final_value) + '</td>'
                + '<td class="pct-negative">' + fmt(s.max_drawdown_pct) + '%</td>'
                + '<td>' + fmtDollar(s.total_commissions || s.fee_drag || 0) + '</td>'
                + '<td>' + fmt(s.sharpe_ratio, 3) + '</td>'
                + '<td>' + fmt(s.profit_factor) + '</td>'
                + '<td>' + fmt(s.avg_hold_days || 0, 1) + 'd</td>';
            tbody.appendChild(tr);
        }
    });
}

// ─── Portfolio Templates ───
function loadPortfolios() {
    apiGet('data.php?type=portfolios', function(d) {
        if (!d.ok || !d.portfolios) return;
        var tbody = document.querySelector('#portfolios-table tbody');
        tbody.innerHTML = '';
        var ports = d.portfolios;
        for (var i = 0; i < ports.length; i++) {
            var p = ports[i];
            var tr = document.createElement('tr');
            tr.innerHTML = '<td><strong>' + p.name + '</strong><br><span style="font-size:0.75rem;color:var(--text-dim)">' + (p.description || '') + '</span></td>'
                + '<td><span class="badge badge-blue">' + (p.strategy_type || '-') + '</span></td>'
                + '<td>' + parseFloat(p.take_profit_pct || p.target_return_pct || 0) + '</td>'
                + '<td>' + parseFloat(p.stop_loss_pct || 0) + '</td>'
                + '<td>' + (p.max_hold_days || '-') + 'd</td>'
                + '<td>' + fmtDollar(p.initial_capital) + '</td>'
                + '<td>' + parseFloat(p.position_size_pct || 10) + '%</td>'
                + '<td><button class="btn btn-primary" style="padding:0.3rem 0.8rem;font-size:0.8rem;" onclick="backtestPortfolio(' + p.id + ')">Backtest</button></td>';
            tbody.appendChild(tr);
        }
    });
}

function backtestPortfolio(id) {
    document.querySelector('.tab[data-tab="whatif"]').click();
    var btn = document.getElementById('btn-run-whatif');
    btn.disabled = true;
    btn.textContent = 'Running portfolio backtest...';

    apiGet('backtest.php?portfolio_id=' + id + '&save=1', function(d) {
        btn.disabled = false;
        btn.textContent = 'Run Analysis';
        if (!d.ok) { alert('Error: ' + (d.error || 'Unknown')); return; }
        renderWhatIfResults(d);
    });
}

// ─── Fund Picks ───
function loadPicks() {
    var algo = document.getElementById('picks-algo-filter').value;
    var url = 'data.php?type=picks';
    if (algo) url += '&algorithm=' + encodeURIComponent(algo);

    apiGet(url, function(d) {
        if (!d.ok || !d.picks) return;
        var tbody = document.querySelector('#picks-table tbody');
        tbody.innerHTML = '';
        var picks = d.picks;
        for (var i = 0; i < picks.length; i++) {
            var p = picks[i];
            var starHtml = renderStars(p.morningstar_rating || p.morningstar || 0);
            var expRatio = p.expense_ratio ? fmt(p.expense_ratio, 2) + '%' : '-';
            var tr = document.createElement('tr');
            var pickDate = p.pick_date || '';
            var pickTime = p.pick_time || '';
            var pickDisplay = pickDate;
            if (pickTime && pickTime.length > 10) {
                var timePart = pickTime.substring(11, 16);
                if (timePart && timePart !== '00:00') pickDisplay += ' ' + timePart;
            }
            var navVal = parseFloat(p.entry_nav || 0);
            var navClass = navVal > 0 ? '' : ' style="color:var(--red)"';
            tr.innerHTML = '<td><strong>' + (p.ticker || p.symbol) + '</strong></td>'
                + '<td>' + (p.company_name || p.fund_name || '') + '</td>'
                + '<td>' + (p.fund_family || '-') + '</td>'
                + '<td>' + (p.category || '-') + '</td>'
                + '<td>' + (p.algorithm_name || p.algorithm || '') + '</td>'
                + '<td' + navClass + '>$' + fmt(navVal) + '</td>'
                + '<td style="font-size:0.8rem;color:var(--text-dim)">' + pickDisplay + '</td>'
                + '<td>' + (p.score || '-') + '</td>'
                + '<td><span class="badge ' + ratingBadge(p.rating) + '">' + (p.rating || '-') + '</span></td>'
                + '<td>' + starHtml + '</td>'
                + '<td>' + expRatio + '</td>'
                + '<td><span class="badge badge-blue">Active</span></td>';
            tbody.appendChild(tr);
        }
    });
}

function renderStars(count) {
    count = parseInt(count) || 0;
    if (count <= 0) return '<span class="stars-dim">N/A</span>';
    var html = '<span class="stars">';
    for (var i = 0; i < 5; i++) {
        if (i < count) {
            html += '&#9733;';
        } else {
            html += '<span class="stars-dim">&#9733;</span>';
        }
    }
    html += '</span>';
    return html;
}

function ratingBadge(rating) {
    if (!rating) return 'badge-blue';
    var r = rating.toUpperCase();
    if (r === 'STRONG BUY') return 'badge-green';
    if (r === 'BUY') return 'badge-blue';
    if (r === 'HOLD') return 'badge-yellow';
    if (r === 'SELL' || r === 'STRONG SELL') return 'badge-red';
    return 'badge-purple';
}

// ─── Backtest History ───
function loadHistory() {
    apiGet('data.php?type=backtests', function(d) {
        if (!d.ok || !d.backtests) return;
        var tbody = document.querySelector('#history-table tbody');
        tbody.innerHTML = '';
        var bt = d.backtests;
        for (var i = 0; i < bt.length; i++) {
            var b = bt[i];
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + (b.run_name || '-') + '</td>'
                + '<td><span class="badge badge-blue">' + (b.strategy_type || '-') + '</span></td>'
                + '<td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;">' + (b.algorithm_filter || 'All') + '</td>'
                + '<td>' + (b.total_trades || 0) + '</td>'
                + '<td>' + fmt(b.win_rate, 1) + '%</td>'
                + '<td class="' + (parseFloat(b.total_return_pct || 0) >= 0 ? 'pct-positive' : 'pct-negative') + '">' + fmt(b.total_return_pct) + '%</td>'
                + '<td>' + fmtDollar(b.final_value) + '</td>'
                + '<td class="pct-negative">' + fmt(b.max_drawdown_pct) + '%</td>'
                + '<td>' + fmt(b.sharpe_ratio, 3) + '</td>'
                + '<td>' + (b.created_at || '') + '</td>';
            tbody.appendChild(tr);
        }
    });
}

// ─── Seed Backtests ───
function seedBacktests(force) {
    var log = document.getElementById('seed-log');
    log.innerHTML = '<div class="spinner"></div> Running all 10 scenarios and saving results...';
    var url = 'seed_backtests.php';
    if (force) url += '?force=1';
    apiGet(url, function(d) {
        if (d.ok) {
            var msg = d.message || ('Seeded ' + (d.seeded || 0) + ' backtests');
            if (d.results && d.results.length > 0) {
                msg += '<br>';
                for (var i = 0; i < d.results.length; i++) {
                    var r = d.results[i];
                    if (r.return_pct !== undefined) {
                        var cls = parseFloat(r.return_pct) >= 0 ? 'pct-positive' : 'pct-negative';
                        msg += '<span style="margin-right:8px">' + r.scenario + ': <span class="' + cls + '">' + r.return_pct + '%</span> (' + r.trades + ' trades)</span><br>';
                    }
                }
            }
            log.innerHTML = msg;
            loadHistory();
            loadStats();
        } else {
            log.innerHTML = 'Error: ' + (d.error || d.message || JSON.stringify(d));
        }
    });
}

// ─── Forward Tracking ───
function initTracking() {
    var log = document.getElementById('tracking-log');
    log.innerHTML = '<div class="spinner"></div> Initializing tracking positions from fund picks...';
    apiGet('mf2_tracking.php?action=init_tracking', function(d) {
        if (d.ok) {
            log.innerHTML = d.message || ('Imported ' + (d.imported || 0) + ' positions');
            loadTracking();
        } else {
            log.innerHTML = 'Error: ' + (d.error || JSON.stringify(d));
        }
    });
}

function refreshTracking() {
    var log = document.getElementById('tracking-log');
    log.innerHTML = '<div class="spinner"></div> Refreshing NAVs and checking exit rules...';
    apiGet('mf2_tracking.php?action=refresh', function(d) {
        if (d.ok) {
            log.innerHTML = 'Updated ' + (d.updated || 0) + ' positions, closed ' + (d.closed || 0) + '. Open: ' + (d.open_positions || 0);
            loadTracking();
        } else {
            log.innerHTML = 'Error: ' + (d.error || d.message || JSON.stringify(d));
        }
    });
}

function loadTracking() {
    apiGet('mf2_tracking.php?action=dashboard', function(d) {
        if (!d.ok) return;

        // Stats
        var s = d.stats || {};
        document.getElementById('t-open').textContent = s.open_positions || 0;
        document.getElementById('t-closed').textContent = s.total_closed || 0;
        var wr = s.win_rate || 0;
        var wrEl = document.getElementById('t-winrate');
        wrEl.textContent = fmt(wr, 1) + '%';
        wrEl.className = 'value ' + (wr >= 50 ? 'positive' : (s.total_closed > 0 ? 'negative' : ''));
        var avgRet = s.avg_return_pct || 0;
        var arEl = document.getElementById('t-avgret');
        arEl.textContent = fmt(avgRet) + '%';
        arEl.className = 'value ' + (avgRet >= 0 ? 'positive' : 'negative');
        document.getElementById('t-avghold').textContent = s.avg_hold_days || '-';

        // Open positions
        var tbody = document.querySelector('#tracking-open-table tbody');
        tbody.innerHTML = '';
        var open = d.open_positions || [];
        for (var i = 0; i < open.length; i++) {
            var p = open[i];
            var ret = parseFloat(p.current_return_pct || 0);
            var tr = document.createElement('tr');
            tr.innerHTML = '<td><strong>' + p.symbol + '</strong></td>'
                + '<td>' + (p.fund_name || '') + '</td>'
                + '<td>' + (p.algorithm_name || '') + '</td>'
                + '<td>' + (p.pick_date || '') + '</td>'
                + '<td>$' + fmt(p.entry_nav) + '</td>'
                + '<td>$' + fmt(p.current_nav) + '</td>'
                + '<td class="' + (ret >= 0 ? 'pct-positive' : 'pct-negative') + '"><strong>' + fmt(ret) + '%</strong></td>'
                + '<td>' + (p.hold_days || 0) + 'd</td>'
                + '<td>$' + fmt(p.peak_nav) + '</td>'
                + '<td>$' + fmt(p.trough_nav) + '</td>';
            tbody.appendChild(tr);
        }
        if (open.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--text-dim)">No tracked positions. Click "Initialize Tracking" to start.</td></tr>';
        }

        // Closed positions
        tbody = document.querySelector('#tracking-closed-table tbody');
        tbody.innerHTML = '';
        var closed = d.closed_positions || [];
        for (var i = 0; i < closed.length; i++) {
            var c = closed[i];
            var cret = parseFloat(c.final_return_pct || 0);
            var reasonBadge = c.exit_reason === 'take_profit' ? 'badge-green' :
                              c.exit_reason === 'stop_loss' ? 'badge-red' :
                              c.exit_reason === 'max_hold' ? 'badge-yellow' : 'badge-blue';
            var tr = document.createElement('tr');
            tr.innerHTML = '<td><strong>' + c.symbol + '</strong></td>'
                + '<td>' + (c.fund_name || '') + '</td>'
                + '<td>' + (c.algorithm_name || '') + '</td>'
                + '<td>' + (c.pick_date || '') + '</td>'
                + '<td>$' + fmt(c.entry_nav) + '</td>'
                + '<td>$' + fmt(c.exit_nav) + '</td>'
                + '<td class="' + (cret >= 0 ? 'pct-positive' : 'pct-negative') + '"><strong>' + fmt(cret) + '%</strong></td>'
                + '<td><span class="badge ' + reasonBadge + '">' + (c.exit_reason || '-') + '</span></td>'
                + '<td>' + (c.hold_days || 0) + 'd</td>'
                + '<td>' + (c.exit_date || '') + '</td>';
            tbody.appendChild(tr);
        }
        if (closed.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--text-dim)">No closed positions yet.</td></tr>';
        }

        // Algorithm performance
        tbody = document.querySelector('#tracking-algo-table tbody');
        tbody.innerHTML = '';
        var algos = d.algorithm_performance || [];
        for (var i = 0; i < algos.length; i++) {
            var a = algos[i];
            var aRet = parseFloat(a.avg_current_ret || 0);
            var tr = document.createElement('tr');
            tr.innerHTML = '<td><strong>' + a.algorithm_name + '</strong></td>'
                + '<td>' + (a.total || 0) + '</td>'
                + '<td>' + (a.open_cnt || 0) + '</td>'
                + '<td class="pct-positive">' + (a.wins || 0) + '</td>'
                + '<td class="pct-negative">' + (a.losses || 0) + '</td>'
                + '<td class="' + (aRet >= 0 ? 'pct-positive' : 'pct-negative') + '">' + fmt(aRet) + '%</td>';
            tbody.appendChild(tr);
        }
    });
}

// ─── Setup Functions ───
function runSetup() {
    var log = document.getElementById('setup-log');
    log.innerHTML = '<div class="spinner"></div> Setting up database...';
    apiGet('setup_schema.php', function(d) {
        if (d.ok) {
            log.innerHTML = 'Database created successfully. ' + (d.actions ? 'Actions: ' + d.actions.join(', ') : 'Tables ready.');
        } else {
            log.innerHTML = 'Error: ' + (d.error || JSON.stringify(d));
        }
    });
}

function importPicks(source) {
    var log = document.getElementById('setup-log');
    log.innerHTML = '<div class="spinner"></div> Importing fund picks (source: ' + source + ')...';
    apiGet('import_picks.php?source=' + source, function(d) {
        log.innerHTML = 'Imported: ' + (d.imported || 0) + ', Skipped: ' + (d.skipped || 0)
            + (d.prices_imported ? ', NAV records: ' + d.prices_imported : '')
            + (d.errors && d.errors.length ? ', Errors: ' + d.errors.join('; ') : '');
        loadStats();
    });
}

function fetchNAVs() {
    var log = document.getElementById('setup-log');
    log.innerHTML = '<div class="spinner"></div> Fetching NAV data (this may take a minute)...';
    apiGet('fetch_prices.php?force=1', function(d) {
        log.innerHTML = 'Fetched: ' + (d.fetched || 0) + ' funds. '
            + (d.note || '')
            + (d.errors && d.errors.length ? ' Errors: ' + d.errors.join('; ') : '');
        loadStats();
    });
}
</script>
</body>
</html>
