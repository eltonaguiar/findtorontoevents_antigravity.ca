// DOGE High Win Rate Strategy v2.3
// Prioritizes win rate over trade frequency

//@version=5
strategy("DOGE High Win Rate v2.3", shorttitle="DOGE WinRate v2.3", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10, commission_type=strategy.commission.percent, commission_value=0.1, slippage=1)

// INPUTS - TIGHTENED FOR HIGH WIN RATE
tf1 = input.timeframe("60", "Primary TF")
tf2 = input.timeframe("240", "Secondary TF") 
tf3 = input.timeframe("D", "Daily TF")
min1hChange = input.float(2.5, "Min 1h Momentum %", minval=1.0, maxval=10.0, step=0.5)
min4hChange = input.float(4.0, "Min 4h Momentum %", minval=2.0, maxval=15.0, step=0.5)
compositeThreshold = input.int(75, "Composite Score Threshold (HIGH)", minval=60, maxval=95, step=5)
minVolumeUSD = input.float(600000, "Min 24h Volume (USD)", minval=200000, maxval=5000000, step=100000)
rsiLength = input.int(14, "RSI Length")
rsiOverbought = input.int(75, "RSI Overbought")
rsiMin = input.int(45, "RSI Minimum (higher = stronger)")
rsiSweetSpot = input.int(55, "RSI Sweet Spot", minval=50, maxval=70)
stopLossPct = input.float(3.0, "Stop Loss %", minval=2.0, maxval=8.0, step=0.5)
takeProfitPct = input.float(12.0, "Take Profit %", minval=8.0, maxval=30.0, step=1.0)
trailingStop = input.bool(true, "Use Trailing Stop")
trailingStopPct = input.float(8.0, "Trailing Stop %", minval=5.0, maxval=20.0, step=1.0)
tradeCooldownBars = input.int(6, "Trade Cooldown (bars)", minval=3, maxval=12)
requireTrendAlignment = input.bool(true, "Require All Timeframes Positive")
requireVolumeSpike = input.bool(true, "Require Volume Spike")

// DATA
currentClose = request.security(syminfo.tickerid, tf1, close)
currentOpen = request.security(syminfo.tickerid, tf1, open)
currentVolume = request.security(syminfo.tickerid, tf1, volume)
tf2Close = request.security(syminfo.tickerid, tf2, close)
tf2Open = request.security(syminfo.tickerid, tf2, open)
tf2Change = ((tf2Close - tf2Open) / tf2Open) * 100
tf3Close = request.security(syminfo.tickerid, tf3, close)
tf3Open = request.security(syminfo.tickerid, tf3, open)
tf3Change = ((tf3Close - tf3Open) / tf3Open) * 100

// INDICATORS
rsi = ta.rsi(close, rsiLength)
volumeSMA = ta.sma(volume, 20)
volumeSpike = currentVolume > (volumeSMA * 1.5)
volume24h = volumeSMA * 24 * close
change1h = ((currentClose - currentOpen) / currentOpen) * 100

// EMAs for trend
ema12 = ta.ema(close, 12)
ema26 = ta.ema(close, 26)
ema50 = ta.ema(close, 50)
trendBullish = ema12 > ema26 and ema26 > ema50

// STRONGER SCORING
score1h = change1h >= min1hChange ? 30 : (change1h > min1hChange * 0.7 ? 20 : 0)
score4h = tf2Change >= min4hChange ? 25 : (tf2Change > min4hChange * 0.6 ? 15 : 0)
scoreDaily = tf3Change > 2 ? 25 : (tf3Change > 0 ? 15 : 0)

// RSI Score - bonus for sweet spot
rsiScore = 0
if rsi >= rsiSweetSpot and rsi <= rsiOverbought
    rsiScore := 25
else if rsi >= rsiMin and rsi < rsiSweetSpot
    rsiScore := 20
else if rsi < rsiMin
    rsiScore := 10
else
    rsiScore := 5

// Volume Score
volumeScore = volumeSpike and volume24h > minVolumeUSD ? 15 : (volume24h > minVolumeUSD ? 8 : 0)

// Trend Alignment Bonus
allTfPositive = change1h > 0 and tf2Change > 0 and tf3Change > 0
alignmentBonus = allTfPositive ? 10 : 0

// Composite Score
compositeScore = score1h + score4h + scoreDaily + rsiScore + volumeScore + alignmentBonus

// STRICT PATTERNS - Only best setups
strongBreakout = change1h > min1hChange and tf2Change > min4hChange * 0.5 and tf3Change > 0 and allTfPositive
continuationPattern = change1h > 1 and tf2Change > 3 and tf3Change > 5 and allTfPositive

// Pattern label
patternLabel = strongBreakout ? "STRONG BREAKOUT" : (continuationPattern ? "CONTINUATION" : "NONE")

// RISK FILTERS - STRICT
parabolicWarning = tf3Change > 80 or (tf2Change > 50 and change1h < 2) or tf3Change < -10
lowVolumeWarning = volume24h < minVolumeUSD
chasingWarning = tf3Change > 40 and change1h < 3
weakTrend = not trendBullish

// COOLDOWN
var int barsSinceLastTrade = 999
cooldownMet = barsSinceLastTrade >= tradeCooldownBars
barsSinceLastTrade := strategy.position_size > 0 ? 0 : barsSinceLastTrade + 1

// ENTRY - VERY SELECTIVE
noPosition = strategy.position_size == 0
hasPosition = strategy.position_size > 0

// Must have strong pattern
hasValidPattern = strongBreakout or continuationPattern

// Trend alignment check
trendAlignmentOk = not requireTrendAlignment or allTfPositive

// Volume check
volumeOk = not requireVolumeSpike or volumeSpike

// Main entry
longCondition = compositeScore >= compositeThreshold and hasValidPattern and trendBullish and trendAlignmentOk and rsi >= rsiMin and rsi <= rsiOverbought and volumeOk and volume24h >= minVolumeUSD and not parabolicWarning and not lowVolumeWarning and not chasingWarning and not weakTrend and cooldownMet

canEnterLong = longCondition and noPosition

// EXIT - TIGHTER
longStopLoss = strategy.position_avg_price * (1 - stopLossPct / 100)
longTakeProfit = strategy.position_avg_price * (1 + takeProfitPct / 100)
var float trailStopPrice = na
if hasPosition
    trailStopPrice := na(trailStopPrice) ? close * (1 - trailingStopPct / 100) : math.max(trailStopPrice, close * (1 - trailingStopPct / 100))

// Quick exits on weakness
momentumReversal = change1h < -1.5 or (change1h < 0 and tf2Change < 0)
rsiExit = rsi > 78
profitProtect = close > strategy.position_avg_price * 1.08 and change1h < 0
trailHit = not na(trailStopPrice) and close < trailStopPrice

// EXECUTION
if canEnterLong
    strategy.entry("Long", strategy.long, comment=patternLabel)
    barsSinceLastTrade := 0

if hasPosition
    strategy.exit("TP/SL", "Long", limit=longTakeProfit, stop=longStopLoss)
    if trailingStop and trailHit
        strategy.close("Long", comment="Trail")
    if momentumReversal
        strategy.close("Long", comment="Reversal")
    if rsiExit
        strategy.close("Long", comment="RSI")
    if profitProtect
        strategy.close("Long", comment="Profit Protect")

// VISUALIZATION
bgColor = compositeScore >= 80 ? color.new(color.green, 85) : (compositeScore >= compositeThreshold ? color.new(color.lime, 90) : (compositeScore >= 60 ? color.new(color.yellow, 90) : color.new(color.red, 95)))
bgcolor(bgColor)
plot(ema12, "EMA 12", color.blue, 2)
plot(ema26, "EMA 26", color.orange, 1)
plot(ema50, "EMA 50", color.purple, 1)
plotshape(canEnterLong, title="BUY", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.large, text="‚òÖ BUY ‚òÖ", textcolor=color.white)
plotshape(parabolicWarning and noPosition, title="WARNING", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.tiny, text="‚ö†")

// TABLE
var table infoTable = table.new(position.top_right, 2, 11, bgcolor=color.new(color.black, 15), frame_color=color.gray, frame_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "üêï DOGE v2.3", text_color=color.yellow)
    table.cell(infoTable, 1, 0, "HIGH WIN RATE")
    table.cell(infoTable, 0, 1, "Score", text_color=color.gray)
    table.cell(infoTable, 1, 1, str.tostring(compositeScore, "#.") + "/100", text_color=compositeScore >= compositeThreshold ? color.green : (compositeScore >= 60 ? color.yellow : color.red))
    table.cell(infoTable, 0, 2, "1h", text_color=color.gray)
    table.cell(infoTable, 1, 2, str.tostring(change1h, "#.##") + "%", text_color=change1h > 0 ? color.green : color.red)
    table.cell(infoTable, 0, 3, "4h", text_color=color.gray)
    table.cell(infoTable, 1, 3, str.tostring(tf2Change, "#.##") + "%", text_color=tf2Change > 0 ? color.green : color.red)
    table.cell(infoTable, 0, 4, "24h", text_color=color.gray)
    table.cell(infoTable, 1, 4, str.tostring(tf3Change, "#.##") + "%", text_color=tf3Change > 0 ? color.green : color.red)
    table.cell(infoTable, 0, 5, "RSI", text_color=color.gray)
    table.cell(infoTable, 1, 5, str.tostring(rsi, "#."), text_color=rsi > rsiSweetSpot and rsi < rsiOverbought ? color.green : (rsi < rsiMin ? color.red : color.yellow))
    table.cell(infoTable, 0, 6, "Vol 24h", text_color=color.gray)
    volText = volume24h > 1000000 ? "$" + str.tostring(volume24h/1000000, "#.") + "M" : "$" + str.tostring(volume24h/1000, "#.") + "K"
    table.cell(infoTable, 1, 6, volText, text_color=volume24h >= minVolumeUSD and volumeSpike ? color.green : color.red)
    table.cell(infoTable, 0, 7, "Pattern", text_color=color.gray)
    table.cell(infoTable, 1, 7, patternLabel, text_color=strongBreakout ? color.green : color.gray)
    table.cell(infoTable, 0, 8, "All TF+", text_color=color.gray)
    table.cell(infoTable, 1, 8, allTfPositive ? "YES ‚úì" : "NO", text_color=allTfPositive ? color.green : color.red)
    table.cell(infoTable, 0, 9, "Cooldown", text_color=color.gray)
    cdText = cooldownMet ? "READY" : str.tostring(tradeCooldownBars - barsSinceLastTrade) + " bars"
    table.cell(infoTable, 1, 9, cdText, text_color=cooldownMet ? color.green : color.yellow)
    table.cell(infoTable, 0, 10, "Position", text_color=color.gray)
    table.cell(infoTable, 1, 10, hasPosition ? "LONG" : "NONE", text_color=hasPosition ? color.green : color.gray)

alertcondition(canEnterLong, title="DOGE High Quality Buy", message="üêï DOGE High Win Rate Buy @ {{close}}")
