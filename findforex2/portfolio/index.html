<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Portfolio Analysis | FindForex2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #12122a;
            --bg-card-hover: #1a1a3a;
            --border: #2a2a4a;
            --text: #e0e0f0;
            --text-dim: #8888aa;
            --accent: #0ea5e9;
            --accent-glow: rgba(14, 165, 233, 0.3);
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234, 179, 8, 0.15);
            --blue: #3b82f6;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        .header {
            background: linear-gradient(135deg, #12122a 0%, #1e1e3f 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent), #38bdf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-links { display: flex; gap: 1rem; font-size: 0.9rem; }
        .header-links a { color: var(--text-dim); }
        .header-links a:hover { color: var(--text); }

        /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        @media (max-width: 1024px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .container { padding: 1rem; } }

        /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
        }
        .card h2 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--text); }
        .card h3 { font-size: 0.95rem; color: var(--text-dim); margin-bottom: 0.5rem; }

        /* ‚îÄ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ‚îÄ */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }
        .stat-card .label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; margin-top: 0.25rem; }
        .stat-card .value.positive { color: var(--green); }
        .stat-card .value.negative { color: var(--red); }
        .stat-card .value.neutral { color: var(--text); }

        /* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
        label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.03em; }
        select, input[type="number"], input[type="text"] {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }
        select:focus, input:focus { border-color: var(--accent); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .form-group { display: flex; flex-direction: column; }

        /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-primary:hover { background: #0284c7; box-shadow: 0 0 20px var(--accent-glow); }
        .btn-secondary { background: var(--bg-dark); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ‚îÄ Checkboxes ‚îÄ‚îÄ‚îÄ */
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; }
        .checkbox-item {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.4rem 0.6rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .checkbox-item:hover { border-color: var(--accent); }
        .checkbox-item input { accent-color: var(--accent); }

        /* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        thead th {
            text-align: left;
            padding: 0.6rem 0.8rem;
            background: var(--bg-dark);
            color: var(--text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            cursor: pointer;
        }
        thead th:hover { color: var(--text); }
        tbody td {
            padding: 0.5rem 0.8rem;
            border-bottom: 1px solid rgba(42, 42, 74, 0.5);
            white-space: nowrap;
        }
        tbody tr:hover { background: rgba(14, 165, 233, 0.05); }
        .positive { color: var(--green); }
        .negative { color: var(--red); }

        /* ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ */
        .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .tab {
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-dim);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ Scenario Cards ‚îÄ‚îÄ‚îÄ */
        .scenario-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .scenario-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .scenario-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .scenario-card.selected { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        .scenario-card h4 { font-size: 1rem; margin-bottom: 0.5rem; }
        .scenario-card p { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.75rem; }
        .scenario-meta { display: flex; gap: 1rem; font-size: 0.8rem; }
        .scenario-meta span { background: var(--bg-dark); padding: 0.2rem 0.5rem; border-radius: 4px; }

        /* ‚îÄ‚îÄ‚îÄ Comparison Table ‚îÄ‚îÄ‚îÄ */
        .comparison-row { display: grid; grid-template-columns: 200px 1fr; gap: 1rem; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(42,42,74,0.5); }
        .comparison-bar { height: 24px; border-radius: 4px; position: relative; min-width: 2px; }
        .comparison-label { font-size: 0.85rem; }
        .comparison-value { position: absolute; right: 8px; top: 3px; font-size: 0.75rem; font-weight: 600; }

        /* ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ */
        .chart-container { position: relative; height: 300px; }

        /* ‚îÄ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ */
        .loading { text-align: center; padding: 2rem; color: var(--text-dim); }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ‚îÄ Badge ‚îÄ‚îÄ‚îÄ */
        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-green { background: var(--green-dim); color: var(--green); }
        .badge-red { background: var(--red-dim); color: var(--red); }
        .badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
        .badge-blue { background: rgba(59,130,246,0.15); color: var(--blue); }
        .badge-orange { background: rgba(249, 115, 22, 0.15); color: #f97316; }
        .badge-purple { background: rgba(168, 85, 247, 0.15); color: #a855f7; }

        /* ‚îÄ‚îÄ‚îÄ Analysis/Research Tab Styles ‚îÄ‚îÄ‚îÄ */
        .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; }
        .glossary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .glossary-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; }
        .glossary-term { margin-bottom: 0.5rem; }
        .glossary-def { font-size: 0.82rem; color: var(--text-dim); line-height: 1.6; }
        .glossary-def strong { color: var(--text); }
        .grade-explainer {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.5rem;
            font-size: 0.85rem; color: var(--text-dim); line-height: 1.6;
        }
        .ge-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; }

        /* ‚îÄ‚îÄ‚îÄ Disclaimer ‚îÄ‚îÄ‚îÄ */
        .disclaimer {
            background: rgba(234, 179, 8, 0.08);
            border: 1px solid rgba(234, 179, 8, 0.2);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 1.5rem;
        }
        .disclaimer strong { color: var(--yellow); }

        /* ‚îÄ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ */
        .export-btns { display: flex; gap: 0.5rem; margin-top: 1rem; }

        /* ‚îÄ‚îÄ‚îÄ Section spacing ‚îÄ‚îÄ‚îÄ */
        .section { margin-bottom: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ -->
<div class="header">
    <h1>Forex Portfolio Analysis Tool</h1>
    <div class="header-links">
        <a href="/findforex2/portfolio/">Portfolio</a>
        <a href="/findforex2/">FindForex2</a>
        <a href="/investments/">Investments</a>
        <a href="/">Events Home</a>
    </div>
</div>

<div class="container">
    <!-- Best Forex designation banner -->
    <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:10px 16px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:12px;">
        <span style="background:rgba(239,68,68,0.15);color:#ef4444;padding:3px 10px;border-radius:6px;font-weight:800;font-size:11px;border:1px solid rgba(239,68,68,0.3);letter-spacing:0.5px;">BEST FOREX</span>
        <span style="color:#fca5a5;">Forward-facing results: <strong style="color:#ef4444;">0% WR</strong> (0 wins / 3 losses via learned algorithms). No forward pick tracking on this page (backtests only). Forex needs work.</span>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Status Bar ‚îÄ‚îÄ‚îÄ -->
    <div id="statusBar" class="stat-grid">
        <div class="stat-card"><div class="label">Pairs</div><div class="value neutral" id="statPairs">‚Äî</div></div>
        <div class="stat-card"><div class="label">Signals</div><div class="value neutral" id="statSignals">‚Äî</div></div>
        <div class="stat-card"><div class="label">Price Records</div><div class="value neutral" id="statPrices">‚Äî</div></div>
        <div class="stat-card"><div class="label">Strategies</div><div class="value neutral" id="statStrategies">‚Äî</div></div>
        <div class="stat-card"><div class="label">Backtests Run</div><div class="value neutral" id="statBacktests">‚Äî</div></div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Setup Banner ‚îÄ‚îÄ‚îÄ -->
    <div id="setupBanner" class="card section" style="display:none; border-color: var(--yellow);">
        <h2>Setup Required</h2>
        <p style="color:var(--text-dim); margin-bottom:1rem;">The database needs to be initialized. Click the buttons below in order:</p>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="runSetup()">1. Create Tables</button>
            <button class="btn btn-secondary" onclick="seedSignals()">2. Seed Signals</button>
            <button class="btn btn-secondary" onclick="fetchPrices()">3. Fetch Price Data</button>
        </div>
        <div id="setupLog" style="margin-top:1rem; font-size:0.85rem; color:var(--text-dim);"></div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ -->
    <div class="tabs">
        <div class="tab active" data-tab="whatif">What-If Analysis</div>
        <div class="tab" data-tab="compare">Compare Strategies</div>
        <div class="tab" data-tab="optimal">Optimal Finder</div>
        <div class="tab" data-tab="signals">Signals</div>
        <div class="tab" data-tab="history">Backtest History</div>
        <div class="tab" data-tab="analysis" style="color:#f59e0b;">System Analysis</div>
        <div class="tab" data-tab="research" style="color:#a855f7;">Research &amp; Future</div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: What-If Analysis ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content active" id="tab-whatif">
        <div class="grid-2">
            <!-- Left: Controls -->
            <div>
                <div class="card section">
                    <h2>Preset Scenarios</h2>
                    <div class="scenario-grid" id="scenarioGrid"></div>
                </div>
                <div class="card section">
                    <h2>Custom Parameters</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Strategy Type</label>
                            <select id="strategyType" onchange="onStrategyChange()">
                                <option value="custom">Custom</option>
                                <option value="scalp">Scalp (TP:0.5, SL:0.3, hold:1)</option>
                                <option value="daytrade">Day Trade (TP:1, SL:0.5, hold:2)</option>
                                <option value="swing">Swing (TP:3, SL:1, hold:14)</option>
                                <option value="trendfollow">Trend Follow (TP:5, SL:2, hold:30)</option>
                                <option value="carrytrade">Carry Trade (TP:999, SL:5, hold:90)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Take Profit (pips)</label>
                            <input type="number" id="takeProfit" value="10" min="0.1" max="999" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Stop Loss (pips)</label>
                            <input type="number" id="stopLoss" value="5" min="0.1" max="999" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Max Hold (Days)</label>
                            <input type="number" id="maxHoldDays" value="7" min="1" max="365" step="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Initial Capital ($)</label>
                            <input type="number" id="initialCapital" value="10000" min="100" step="100">
                        </div>
                        <div class="form-group">
                            <label>Spread (pips)</label>
                            <input type="number" id="spreadPips" value="2" min="0.1" max="50" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Slippage (pips)</label>
                            <input type="number" id="slippage" value="0.5" min="0" max="10" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Position Size % of Capital</label>
                            <input type="number" id="positionSize" value="10" min="1" max="100" step="1">
                        </div>
                    </div>

                    <h3 style="margin-top:1rem;">Filter by Strategy</h3>
                    <div class="checkbox-grid" id="strategyCheckboxes"></div>

                    <div style="margin-top:1.5rem;">
                        <button class="btn btn-primary" onclick="runWhatIf()">Run What-If Analysis</button>
                        <button class="btn btn-secondary" onclick="runWhatIf(true)" style="margin-left:0.5rem;">Run & Save</button>
                    </div>
                </div>
            </div>

            <!-- Right: Results -->
            <div>
                <div id="whatifResults" style="display:none;">
                    <div class="stat-grid" id="whatifStats"></div>
                    <div class="card section">
                        <h2>Equity Curve</h2>
                        <div class="chart-container"><canvas id="equityChart"></canvas></div>
                    </div>
                    <div class="card section">
                        <h2>Returns by Strategy</h2>
                        <div class="chart-container"><canvas id="strategyChart"></canvas></div>
                    </div>
                    <div class="card section">
                        <div class="section-header">
                            <h2>Trade Log</h2>
                            <div class="export-btns">
                                <button class="btn btn-sm btn-secondary" onclick="exportCSV()">Export CSV</button>
                            </div>
                        </div>
                        <div class="table-wrap">
                            <table id="tradeTable">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable(0)">Pair</th>
                                        <th onclick="sortTable(1)">Strategy</th>
                                        <th onclick="sortTable(2)">Entry Date</th>
                                        <th onclick="sortTable(3)">Entry Price</th>
                                        <th onclick="sortTable(4)">Exit Date</th>
                                        <th onclick="sortTable(5)">Exit Price</th>
                                        <th onclick="sortTable(6)">Lots</th>
                                        <th onclick="sortTable(7)">Net P/L</th>
                                        <th onclick="sortTable(8)">Return %</th>
                                        <th onclick="sortTable(9)">Exit Reason</th>
                                        <th onclick="sortTable(10)">Hold Days</th>
                                        <th onclick="sortTable(11)">Spread Cost</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="whatifEmpty" class="card" style="text-align:center; padding:3rem;">
                    <p style="font-size:1.1rem; margin-bottom:0.5rem;">Select a scenario or configure custom parameters</p>
                    <p style="color:var(--text-dim);">Results will appear here after running the analysis</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Compare Strategies ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-compare">
        <div class="card section">
            <div class="section-header">
                <h2>Strategy Comparison</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="runComparison()">Compare All Scenarios</button>
                </div>
            </div>
            <h3 style="margin-bottom:0.5rem;">Filter by Strategy (optional)</h3>
            <div class="checkbox-grid" id="compareStrategyCheckboxes"></div>
        </div>
        <div id="comparisonResults" style="display:none;">
            <div class="card section">
                <h2>Return Comparison</h2>
                <div class="chart-container" style="height:400px;"><canvas id="comparisonChart"></canvas></div>
            </div>
            <div class="card section">
                <h2>Detailed Comparison</h2>
                <div class="table-wrap">
                    <table id="comparisonTable">
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>TP (pips)</th>
                                <th>SL (pips)</th>
                                <th>Hold</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Return %</th>
                                <th>Final Value</th>
                                <th>Max DD%</th>
                                <th>Spread Cost</th>
                                <th>Sharpe</th>
                                <th>P/F</th>
                                <th>Expectancy</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Optimal Finder ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-optimal">
        <div class="card section">
            <div class="section-header">
                <h2>Optimal Conditions Finder</h2>
            </div>
            <p style="color:var(--text-dim); margin-bottom:1rem;">
                Runs a grid search across <strong>every permutation</strong> of Take Profit, Stop Loss, Holding Period,
                and Spread to find the exact conditions that produce the highest returns.
            </p>
            <div class="grid-2">
                <div>
                    <div class="form-group">
                        <label>Strategy Filter</label>
                        <select id="optStrategyFilter" style="width:100%;">
                            <option value="">All Strategies</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Sort Results By</label>
                        <select id="optSortBy" style="width:100%;">
                            <option value="total_return_pct">Total Return %</option>
                            <option value="win_rate">Win Rate %</option>
                            <option value="sharpe_ratio">Sharpe Ratio</option>
                            <option value="profit_factor">Profit Factor</option>
                            <option value="expectancy">Expectancy</option>
                            <option value="final_value">Final Portfolio Value</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="grid-2" style="margin-top:0.5rem;">
                <div>
                    <div class="form-group">
                        <label>Speed</label>
                        <select id="optQuick" style="width:100%;">
                            <option value="1">Quick (fewer combos, faster)</option>
                            <option value="0">Full Grid (comprehensive, slower)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Show Top N Results</label>
                        <input type="number" id="optTopN" value="25" min="5" max="100" style="width:100%;">
                    </div>
                </div>
            </div>
            <div class="form-row" style="margin-top:0.5rem;">
                <div class="form-group">
                    <label>Spread (pips)</label>
                    <input type="number" id="optSpreadPips" value="2" min="0.1" max="50" step="0.1">
                </div>
            </div>
            <div style="margin-top:1rem;">
                <button class="btn btn-primary" onclick="runOptimalFinder()" id="optRunBtn">Find Optimal Conditions</button>
            </div>
        </div>

        <div id="optimalLoading" style="display:none;">
            <div class="card" style="text-align:center; padding:3rem;">
                <div class="loading">Searching permutations... this may take 10-30 seconds</div>
            </div>
        </div>

        <div id="optimalResults" style="display:none;">
            <!-- Summary stats -->
            <div class="stat-grid" id="optimalSummaryStats"></div>

            <!-- Winner card -->
            <div class="card section" id="optimalWinnerCard" style="border: 2px solid var(--green); display:none;">
                <h2 style="color: var(--green);">üèÜ Winning Configuration</h2>
                <div id="optimalWinnerContent"></div>
            </div>

            <!-- Top results chart -->
            <div class="card section">
                <h2>Top Configurations by <span id="optSortLabel">Return</span></h2>
                <div class="chart-container" style="height:500px;"><canvas id="optimalChart"></canvas></div>
            </div>

            <!-- Top results table -->
            <div class="card section">
                <h2>Full Results Table</h2>
                <div class="table-wrap">
                    <table id="optimalTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Configuration</th>
                                <th onclick="sortOptTable(2)">TP (pips)</th>
                                <th onclick="sortOptTable(3)">SL (pips)</th>
                                <th onclick="sortOptTable(4)">Hold</th>
                                <th>Spread</th>
                                <th onclick="sortOptTable(6)">Trades</th>
                                <th onclick="sortOptTable(7)">Win Rate</th>
                                <th onclick="sortOptTable(8)">Return %</th>
                                <th onclick="sortOptTable(9)">Final Value</th>
                                <th onclick="sortOptTable(10)">Max DD%</th>
                                <th onclick="sortOptTable(11)">Sharpe</th>
                                <th onclick="sortOptTable(12)">P/F</th>
                                <th onclick="sortOptTable(13)">Spread Cost</th>
                                <th>Best Trade</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Worst results (what to avoid) -->
            <div class="card section" style="border-color: var(--red);">
                <h2 style="color:var(--red);">Worst Configurations (Avoid These)</h2>
                <div class="table-wrap">
                    <table id="worstTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Configuration</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Return %</th>
                                <th>Final Value</th>
                                <th>Max DD%</th>
                                <th>Worst Trade</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="optimalEmpty" class="card" style="text-align:center; padding:3rem;">
            <p style="font-size:1.1rem; margin-bottom:0.5rem;">Click "Find Optimal Conditions" to search all parameter permutations</p>
            <p style="color:var(--text-dim);">The engine will test every combination and rank them by your chosen metric</p>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Signals ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-signals">
        <div class="card section">
            <div class="section-header">
                <h2>Forex Signals</h2>
                <select id="signalsStrategyFilter" onchange="loadSignals()" style="width:auto;">
                    <option value="">All Strategies</option>
                </select>
            </div>
            <div class="table-wrap">
                <table id="signalsTable">
                    <thead>
                        <tr>
                            <th>Pair</th>
                            <th>Strategy</th>
                            <th>Signal Date</th>
                            <th>Entry Price</th>
                            <th>Direction</th>
                            <th>Take Profit</th>
                            <th>Stop Loss</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Backtest History ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-history">
        <div class="card section">
            <h2>Saved Backtest Results</h2>
            <div class="table-wrap">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Run Name</th>
                            <th>Strategy</th>
                            <th>Strategies</th>
                            <th>Trades</th>
                            <th>Win Rate</th>
                            <th>Return %</th>
                            <th>Final Value</th>
                            <th>Max DD%</th>
                            <th>Sharpe</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: System Analysis ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-analysis">
        <div class="grade-explainer" style="background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(239,68,68,0.08));border-color:rgba(245,158,11,0.3);">
            <div class="ge-title" style="color:#f59e0b;">Honest System Assessment -- Forex Portfolio</div>
            This page provides complete transparency about our forex trading system's current state, known limitations, and planned improvements. We believe in honest disclosure -- our forward-facing forex performance is currently 0% win rate with critical deployment issues identified.
        </div>

        <h3 class="section-title" style="color:#22c55e;">Current Strengths</h3>
        <div class="glossary-grid">
            <div class="glossary-item">
                <div class="glossary-term"><span class="badge badge-green">SOLID FOUNDATION</span></div>
                <div class="glossary-def"><strong>A-Grade Backtested Algorithms</strong> -- Trend Following (Sharpe 2.42, A grade) and Mean Reversion (Sharpe 2.29, A grade) demonstrate strong risk-adjusted returns in historical backtests. These are institutional-quality Sharpe ratios that suggest genuine edge in forex markets.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term"><span class="badge badge-green">MULTI-PAIR COVERAGE</span></div>
                <div class="glossary-def"><strong>10 Forex Pairs Tracked</strong> -- TwelveData API provides real-time pricing for 10 major and cross pairs. Diversification across USD, EUR, GBP, JPY, AUD, and CAD reduces single-currency risk exposure.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term"><span class="badge badge-green">MULTIPLE ALGORITHMS</span></div>
                <div class="glossary-def"><strong>Strategy Diversity</strong> -- Multiple backtested strategies with different approaches (trend-following, mean reversion) provide diversified signal generation. Each algorithm captures different market regimes.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term"><span class="badge badge-green">DISCIPLINED EXITS</span></div>
                <div class="glossary-def"><strong>Configurable TP/SL/Max Hold</strong> -- Every scenario uses predefined take-profit, stop-loss, and maximum hold periods. No emotional decision-making. Multiple preset scenarios from Short Tactical (14d) to Conservative Hold (90d).</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term"><span class="badge badge-green">CARRY TRADE POTENTIAL</span></div>
                <div class="glossary-def"><strong>Interest Rate Differential Opportunity</strong> -- With pairs like AUD/JPY, USD/JPY, and NZD/USD tracked, the system has the raw data needed to add carry trade scoring once interest rate differentials are integrated.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term"><span class="badge badge-green">ANALYSIS TOOLS</span></div>
                <div class="glossary-def"><strong>Comprehensive Portfolio Analysis</strong> -- What-If analysis, strategy comparison, optimal finder, and backtest history provide robust tools for evaluating and refining forex strategies before deployment.</div>
            </div>
        </div>

        <h3 class="section-title" style="color:#10b981;margin-top:1.5rem;">Deep Audit Findings (Feb 12, 2026)</h3>
        <div style="background:var(--bg-card);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <p style="font-size:0.85rem;color:#e0e0f0;margin-bottom:0.8rem;"><strong>A comprehensive audit of the forex system was conducted. Here are the findings:</strong></p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
                <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#ef4444;margin-bottom:0.4rem;">CRITICAL: Wrong Algorithms Deployed</div>
                    <div style="font-size:0.78rem;color:#889;">The A-grade Trend Following (Sharpe 2.42) and Mean Reversion (Sharpe 2.29) algorithms are NOT being used in live trading. Instead, Consensus (0% WR, 2 trades, 2 losses) and RSI Reversal (0% WR, 1 trade, 1 loss) are deployed -- these were never backtested for forex. This is the single highest-priority fix.</div>
                </div>
                <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#ef4444;margin-bottom:0.4rem;">Finding: 0% Forward Win Rate</div>
                    <div style="font-size:0.78rem;color:#889;">All 3 closed forex trades resulted in losses. Consensus: 2 trades, 2 losses. RSI Reversal: 1 trade, 1 loss. The forward-facing results are completely misaligned with the A-grade backtest results because the wrong algorithms are in production.</div>
                </div>
                <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.25);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#f59e0b;margin-bottom:0.4rem;">Finding: Minimal Trade Data</div>
                    <div style="font-size:0.78rem;color:#889;">Only 3 closed forex trades exist in the system. This is far too few for any statistical analysis or ML training (minimum 20 needed). Even after deploying correct algorithms, data accumulation will take weeks.</div>
                </div>
                <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.25);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#3b82f6;margin-bottom:0.4rem;">Finding: Bridge Script in Progress</div>
                    <div style="font-size:0.78rem;color:#889;">A bridge script (<code>bridge_picks_to_signals.py</code>) is being developed to deploy the A-grade Trend Following and Mean Reversion algorithms to the live signal engine. ETA: 1-2 weeks for full deployment and validation.</div>
                </div>
            </div>
        </div>

        <h3 class="section-title" style="color:#6366f1;margin-top:1.5rem;">ML System Status</h3>
        <div style="background:var(--bg-card);border:1px solid rgba(99,102,241,0.3);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <div style="font-size:0.85rem;color:#889;">
                <p style="margin-bottom:0.8rem;"><strong style="color:#22c55e;">Current State: ML Pipeline DEPLOYED (Feb 12, 2026)</strong></p>
                <ul style="margin-left:1.5rem;margin-bottom:0.8rem;">
                    <li><span style="color:#22c55e;">&check;</span> <strong>forex_ml_optimizer.py</strong> (1,051 lines) &mdash; grid search, walk-forward 70/30 split, Sharpe objective</li>
                    <li><span style="color:#22c55e;">&check;</span> <strong>Regime-aware optimization</strong> &mdash; separate params for bull/neutral/bear</li>
                    <li><span style="color:#22c55e;">&check;</span> <strong>concept_drift_detector.py</strong> &mdash; daily PSI + win rate degradation monitoring</li>
                    <li><span style="color:#22c55e;">&check;</span> <strong>multi_timeframe_regime.py</strong> &mdash; 4h/daily/weekly HMM for forex context</li>
                    <li><span style="color:#22c55e;">&check;</span> <strong>GitHub Actions</strong> &mdash; forex-ml-optimizer.yml (Sun + Wed 3 PM EST)</li>
                    <li><span style="color:#f59e0b;">&bull;</span> <strong>Waiting on data:</strong> only 3 closed trades &mdash; min 10 needed for first optimization</li>
                </ul>
                <p style="color:#22c55e;"><strong>Status:</strong> ML infra fully deployed. Optimizer auto-activates at 10+ closed FOREX trades.</p>
            </div>
        </div>

        <h3 class="section-title" style="color:#ef4444;margin-top:1.5rem;">Known Flaws &amp; Limitations</h3>
        <div class="glossary-grid">
            <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                <div class="glossary-term"><span class="badge badge-red">WRONG ALGOS DEPLOYED</span></div>
                <div class="glossary-def"><strong>Highest Priority Fix</strong> -- Consensus and RSI Reversal algorithms are deployed for forex live trading instead of the A-grade Trend Following (Sharpe 2.42) and Mean Reversion (Sharpe 2.29). This single issue explains the 0% forward win rate. Bridge script fix in progress.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                <div class="glossary-term"><span class="badge badge-red">0% FORWARD WIN RATE</span></div>
                <div class="glossary-def"><strong>3 Trades, 3 Losses</strong> -- Every closed forex trade has been a loss. The system has negative forward performance despite A-grade backtests. Until the correct algorithms are deployed and accumulate data, no claims of profitability can be made.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                <div class="glossary-term"><span class="badge badge-red">NO CARRY TRADE</span></div>
                <div class="glossary-def"><strong>Missing Key Forex Edge</strong> -- No interest rate differential tracking, no carry trade component. Professional forex systems exploit rate differentials across central banks. This is a fundamental missing feature for any serious forex system.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                <div class="glossary-term"><span class="badge badge-red">NO CENTRAL BANK CALENDAR</span></div>
                <div class="glossary-def"><strong>Event Risk Blind Spot</strong> -- No integration with FOMC, ECB, BOJ, BOE, RBA, or BOC meeting schedules. Central bank decisions are the single largest driver of forex moves. Trading without event awareness is like driving blindfolded.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                <div class="glossary-term"><span class="badge badge-red">NO CORRELATION TRACKING</span></div>
                <div class="glossary-def"><strong>Portfolio Risk Blind Spot</strong> -- No correlation matrix across the 10 tracked pairs. Holding long EUR/USD and long GBP/USD is essentially double-exposure to USD weakness. Without correlation tracking, position sizing ignores portfolio-level risk.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(239,68,68,0.3);">
                <div class="glossary-term"><span class="badge badge-red">NO COMMODITY CORRELATION</span></div>
                <div class="glossary-def"><strong>Missing Cross-Asset Signal</strong> -- AUD correlates with iron ore/gold, CAD with oil, NOK with Brent crude. Professional forex systems track commodity-currency correlations for additional signal confirmation. Currently absent.</div>
            </div>
        </div>

        <h3 class="section-title" style="color:#3b82f6;margin-top:1.5rem;">Improvement Roadmap</h3>
        <div class="glossary-grid">
            <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                <div class="glossary-term"><span class="badge badge-green">PHASE 1: BACKTESTS DONE</span></div>
                <div class="glossary-def"><strong>A-Grade Strategies Validated</strong> -- Trend Following (Sharpe 2.42) and Mean Reversion (Sharpe 2.29) backtested successfully against historical forex data. Multiple scenario presets configured. What-If, comparison, and optimal finder tools operational.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                <div class="glossary-term"><span class="badge badge-green">PHASE 2: LIVE MONITOR DONE</span></div>
                <div class="glossary-def"><strong>Real-Time Data Pipeline</strong> -- TwelveData API integration provides real-time pricing for 10 forex pairs. Live Monitor generates signals from 20 algorithms including forex-specific ones. Paper trading infrastructure operational.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(59,130,246,0.3);">
                <div class="glossary-term"><span class="badge badge-blue">PHASE 3: BRIDGE SCRIPT</span></div>
                <div class="glossary-def"><strong>Deploy Correct Algorithms (In Progress)</strong> -- Bridge script (<code>bridge_picks_to_signals.py</code>) will connect the A-grade Trend Following and Mean Reversion algorithms to the live signal engine. This is the critical fix that should transform forward performance. ETA: 1-2 weeks.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(59,130,246,0.3);">
                <div class="glossary-term"><span class="badge badge-blue">PHASE 4: DATA ACCUMULATION</span></div>
                <div class="glossary-def"><strong>Forward Trade Tracking</strong> -- After correct algorithms are deployed, accumulate 20+ closed trades for ML grid search activation. Track every forex signal with entry/exit prices, spread, and slippage data. Target: 50+ trades for statistical significance.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(59,130,246,0.3);">
                <div class="glossary-term"><span class="badge badge-blue">PHASE 5: FOREX FEATURES</span></div>
                <div class="glossary-def"><strong>Carry Trade &amp; Event Calendar</strong> -- Add interest rate differential scoring, central bank event calendar integration, session-aware trading (London/NY/Asian overlap detection), and commodity-currency correlation tracking.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(59,130,246,0.3);">
                <div class="glossary-term"><span class="badge badge-blue">PHASE 6: ML OPTIMIZATION</span></div>
                <div class="glossary-def"><strong>Learned vs Original for Forex</strong> -- Once enough closed trades exist, run grid search on forex-specific parameters. Enable the Learned vs Original comparison system that already works for crypto/stocks. Walk-forward backtest validates model before deployment.</div>
            </div>
        </div>

        <h3 class="section-title" style="color:#eab308;margin-top:1.5rem;">Is It Production Ready?</h3>
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <p style="font-size:0.9rem;color:#e0e0f0;margin-bottom:0.8rem;"><strong>Short Answer: No. The wrong algorithms are deployed.</strong></p>
            <p style="font-size:0.85rem;color:#889;margin-bottom:0.5rem;">Here is where we actually stand:</p>
            <ul style="font-size:0.85rem;color:#889;margin-left:1.5rem;margin-bottom:0.8rem;">
                <li>The backtested strategies are excellent (Sharpe 2.29-2.42) but they are <strong>not in live trading</strong></li>
                <li>The algorithms that ARE live (Consensus, RSI Reversal) have <strong>0% win rate on forex</strong></li>
                <li>Only <strong>3 closed trades</strong> exist -- far too few for any conclusions</li>
                <li>No carry trade component, no central bank calendar, no correlation tracking</li>
            </ul>
            <p style="font-size:0.85rem;color:#e0e0f0;"><strong>What milestones remain?</strong></p>
            <ul style="font-size:0.85rem;color:#889;margin-left:1.5rem;margin-bottom:0.8rem;">
                <li><strong>Deploy bridge script</strong> &rarr; A-grade algorithms go live for forex signals</li>
                <li><strong>20 closed trades</strong> &rarr; ML grid search can activate</li>
                <li><strong>50+ closed trades</strong> &rarr; Statistically meaningful forward win rate</li>
                <li><strong>Positive forward Sharpe &gt; 1.0</strong> &rarr; Validates backtested edge is real</li>
                <li><strong>Carry trade + event calendar</strong> &rarr; Forex-specific features that professionals use</li>
            </ul>
            <p style="font-size:0.85rem;color:#f59e0b;"><strong>Current Status:</strong> The analysis tools on this page work well for backtesting and research. But the live trading component is fundamentally broken because the wrong algorithms are deployed. Do NOT rely on live forex signals until the bridge script is deployed and validated with 50+ trades.</p>
        </div>

        <h3 class="section-title" style="color:#a855f7;margin-top:1.5rem;">Architecture</h3>
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;">
            <p style="font-size:0.85rem;color:#889;margin-bottom:0.8rem;">System components and data flow:</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;">
                <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Data Source: TwelveData API</div>
                    <div style="font-size:0.78rem;color:#889;">Real-time forex pricing for 10 pairs: EUR/USD, GBP/USD, USD/JPY, AUD/USD, USD/CAD, NZD/USD, EUR/GBP, EUR/JPY, GBP/JPY, USD/CHF. Refreshed via Live Monitor pipeline.</div>
                </div>
                <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Signal Engine: Live Monitor</div>
                    <div style="font-size:0.78rem;color:#889;">20 algorithms generate signals across crypto, forex, and stocks. Forex signals currently come from Consensus and RSI Reversal (wrong ones). Bridge script will route Trend Following and Mean Reversion signals instead.</div>
                </div>
                <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Backtest Engine: forex_portfolio.php</div>
                    <div style="font-size:0.78rem;color:#889;">PHP API handles strategy backtesting, scenario comparison, and optimal parameter finding. Uses historical price data to simulate trades with configurable TP/SL/hold periods.</div>
                </div>
                <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Paper Trading: $10K Capital</div>
                    <div style="font-size:0.78rem;color:#889;">Live Monitor runs paper trading with $10K capital, 5% position sizing, max 10 positions, and automatic SL/TP/max-hold enforcement. Forex shares this pool with crypto and stocks.</div>
                </div>
                <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Performance Tracking: algo_performance.php</div>
                    <div style="font-size:0.78rem;color:#889;">Tracks Learned vs Original algorithm parameters. Currently shows 0% forex win rate because wrong algorithms are deployed. Will become meaningful after bridge script deployment.</div>
                </div>
                <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">Frontend: This Portfolio Page</div>
                    <div style="font-size:0.78rem;color:#889;">What-If analysis, strategy comparison, optimal finder, live signals display, and backtest history. Interactive charts via Chart.js. Fully functional for research and backtesting.</div>
                </div>
            </div>
        </div>

        <div style="margin-top:1.5rem;padding:1rem;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:12px;">
            <div style="font-weight:600;color:#22c55e;margin-bottom:0.5rem;">Bottom Line</div>
            <p style="font-size:0.85rem;color:#889;">The forex backtesting system is solid with A-grade results. However, the live trading component is completely broken because the wrong algorithms are deployed. The single most impactful fix is deploying the bridge script to route Trend Following and Mean Reversion signals to forex live trading. Until then, forward performance will continue to be 0% win rate.</p>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: Research & Future ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-content" id="tab-research">
        <div class="grade-explainer" style="background:linear-gradient(135deg,rgba(168,85,247,0.08),rgba(99,102,241,0.08));border-color:rgba(168,85,247,0.3);">
            <div class="ge-title" style="color:#a855f7;">Research &amp; Future Enhancements</div>
            This section documents our research into professional forex trading theory, the academic foundations of our strategies, and the benchmarks we are targeting. Understanding how institutional forex desks operate is essential for building systems that can compete.
        </div>

        <h3 class="section-title" style="color:#6366f1;">Core Methodology: Trend Following &amp; Mean Reversion in FX</h3>
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <p style="font-size:0.85rem;color:#889;margin-bottom:0.8rem;">Forex markets exhibit two primary exploitable patterns. Our backtested A-grade algorithms target each:</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
                <div style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#22c55e;margin-bottom:0.3rem;">Trend Following (Sharpe 2.42)</div>
                    <div style="font-size:0.78rem;color:#889;">Currencies trend because of persistent macroeconomic forces: diverging monetary policy, trade imbalances, and capital flows. When the Fed raises rates while BOJ holds, USD/JPY trends for months. Moving average crossovers and momentum indicators capture these multi-week trends.</div>
                </div>
                <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">Mean Reversion (Sharpe 2.29)</div>
                    <div style="font-size:0.78rem;color:#889;">Exchange rates revert to purchasing power parity (PPP) and interest rate parity over time. When EUR/USD deviates significantly from fair value, institutional flows push it back. Bollinger Bands and RSI identify overextension points for counter-trend entries.</div>
                </div>
            </div>
        </div>

        <h3 class="section-title" style="color:#22c55e;margin-top:1.5rem;">Key Forex Concepts</h3>
        <div class="glossary-grid">
            <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                <div class="glossary-term"><span class="badge badge-green">CARRY TRADE</span></div>
                <div class="glossary-def"><strong>Interest Rate Differential Exploitation</strong> -- Borrow in low-yield currencies (JPY, CHF) and invest in high-yield currencies (AUD, NZD, emerging markets). The interest rate differential provides consistent returns as long as the exchange rate does not move against you. Carry trade is one of the most documented forex anomalies.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                <div class="glossary-term"><span class="badge badge-green">PURCHASING POWER PARITY</span></div>
                <div class="glossary-def"><strong>Long-Run Fair Value Anchor</strong> -- PPP theory states that exchange rates should adjust so that identical goods cost the same across countries. While PPP does not hold in the short term, it provides a gravitational pull on exchange rates over multi-year horizons. Mean reversion strategies exploit deviations from PPP.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                <div class="glossary-term"><span class="badge badge-green">INTEREST RATE PARITY</span></div>
                <div class="glossary-def"><strong>Forward Rate Relationship</strong> -- The forward exchange rate should reflect the interest rate differential between two currencies. When actual rates deviate from parity, arbitrage opportunities emerge. Central bank policy divergence creates the most persistent deviations.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(34,197,94,0.3);">
                <div class="glossary-term"><span class="badge badge-green">CURRENCY MOMENTUM</span></div>
                <div class="glossary-def"><strong>Cross-Sectional and Time-Series</strong> -- Academic research shows currencies that appreciated over the past 1-12 months tend to continue appreciating. Momentum is stronger in forex than in equities, with Sharpe ratios of 0.5-1.0 for simple momentum strategies across G10 currencies.</div>
            </div>
        </div>

        <h3 class="section-title" style="color:#3b82f6;margin-top:1.5rem;">Strategies Used in Our System</h3>
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
                <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">1. Trend Following (Moving Average)</div>
                    <div style="font-size:0.78rem;color:#889;">Uses moving average crossovers (fast/slow MA) to identify trend direction. Enters on crossover confirmation, exits on reverse crossover or TP/SL. Backtested Sharpe: 2.42.</div>
                </div>
                <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">2. Mean Reversion (Bollinger/RSI)</div>
                    <div style="font-size:0.78rem;color:#889;">Identifies overextended moves using Bollinger Bands and RSI. Enters counter-trend when price deviates 2+ standard deviations from mean. Exits on mean reversion or TP/SL. Backtested Sharpe: 2.29.</div>
                </div>
                <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">3. Consensus Algorithm (Currently Live)</div>
                    <div style="font-size:0.78rem;color:#889;">Multi-algorithm consensus scoring that aggregates signals. Works well for crypto but NOT backtested for forex. 0% win rate on forex (2 trades, 2 losses). Should be replaced by Trend Following for forex.</div>
                </div>
                <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">4. RSI Reversal (Currently Live)</div>
                    <div style="font-size:0.78rem;color:#889;">Pure RSI-based reversal strategy. Not specifically calibrated for forex session dynamics or pair-specific volatility. 0% win rate on forex (1 trade, 1 loss). Should be replaced by Mean Reversion for forex.</div>
                </div>
            </div>
        </div>

        <h3 class="section-title" style="color:#f97316;margin-top:1.5rem;">Market Inefficiencies in Forex</h3>
        <div class="glossary-grid">
            <div class="glossary-item" style="border-color:rgba(249,115,22,0.3);">
                <div class="glossary-term"><span class="badge badge-orange">FORWARD RATE BIAS</span></div>
                <div class="glossary-def">Forward exchange rates are biased predictors of future spot rates. High-interest currencies do not depreciate as much as forwards predict, creating the carry trade profit. This is one of the most persistent anomalies in finance, documented since the 1980s.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(249,115,22,0.3);">
                <div class="glossary-term"><span class="badge badge-orange">SESSION OVERLAPS</span></div>
                <div class="glossary-def">Volatility and liquidity spike during London-New York overlap (13:00-17:00 UTC). Asian session (00:00-09:00 UTC) has lower volatility but different pair dynamics. Session-aware entry timing can improve fill quality and reduce false signals.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(249,115,22,0.3);">
                <div class="glossary-term"><span class="badge badge-orange">CENTRAL BANK TELEGRAPHING</span></div>
                <div class="glossary-def">Central banks increasingly telegraph policy changes through forward guidance. Markets often price in 80-90% of a rate decision before the announcement. The edge is in the remaining 10-20% surprise component and the pace of future changes.</div>
            </div>
            <div class="glossary-item" style="border-color:rgba(249,115,22,0.3);">
                <div class="glossary-term"><span class="badge badge-orange">MONTH-END REBALANCING</span></div>
                <div class="glossary-def">Large institutional portfolio managers rebalance currency hedges at month-end and quarter-end. This creates predictable flow patterns. USD typically strengthens on London Fix (4 PM GMT) during month-end due to US equity outperformance requiring USD buying.</div>
            </div>
        </div>

        <h3 class="section-title" style="color:#a855f7;margin-top:1.5rem;">Key Research Sources</h3>
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;">
                <div style="font-size:0.8rem;color:#889;line-height:1.6;">
                    <strong style="color:#a855f7;">Burnside et al. (2006)</strong><br>
                    "The Returns to Currency Speculation" -- Foundational carry trade research showing that borrowing low-yield currencies and investing in high-yield currencies produces consistent excess returns of 4-5% annually.
                </div>
                <div style="font-size:0.8rem;color:#889;line-height:1.6;">
                    <strong style="color:#a855f7;">Menkhoff et al. (2012)</strong><br>
                    "Currency Momentum Strategies" -- Demonstrated that momentum in currencies is pervasive across 48 currencies over 35 years. Momentum strategies produce Sharpe ratios of 0.5-1.0, robust to transaction costs.
                </div>
                <div style="font-size:0.8rem;color:#889;line-height:1.6;">
                    <strong style="color:#a855f7;">Engel &amp; Hamilton (1990)</strong><br>
                    "Long Swings in the Dollar" -- Showed that exchange rates follow regime-switching patterns between appreciation and depreciation phases. Mean reversion strategies exploit the transitions between regimes.
                </div>
                <div style="font-size:0.8rem;color:#889;line-height:1.6;">
                    <strong style="color:#a855f7;">Lustig &amp; Verdelhan (2007)</strong><br>
                    "The Cross Section of Foreign Currency Risk Premia" -- Explained carry trade returns through a consumption-based asset pricing model. High-interest currencies are riskier and command a risk premium.
                </div>
            </div>
        </div>

        <h3 class="section-title" style="color:#22c55e;margin-top:1.5rem;">How We Apply This Research</h3>
        <div style="background:linear-gradient(135deg,rgba(34,197,94,0.08),rgba(99,102,241,0.08));border:1px solid rgba(34,197,94,0.2);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <p style="font-size:0.85rem;color:#889;margin-bottom:0.8rem;">Our system incorporates academic findings in these ways:</p>
            <ul style="font-size:0.85rem;color:#889;margin-left:1.5rem;margin-bottom:0.8rem;">
                <li><strong>Trend Following:</strong> Captures Menkhoff et al. currency momentum through MA crossover signals</li>
                <li><strong>Mean Reversion:</strong> Exploits Engel &amp; Hamilton regime switching via Bollinger Band deviation entries</li>
                <li><strong>Multiple Timeframes:</strong> Backtests across different hold periods (14d to 90d) match short and medium-term anomalies</li>
                <li><strong>Disciplined Exits:</strong> TP/SL framework prevents the common retail mistake of holding losing positions too long</li>
            </ul>
            <p style="font-size:0.85rem;color:#f59e0b;"><strong>Not yet applied:</strong> Carry trade (Burnside et al.), central bank policy analysis, session-aware trading, commodity-currency correlations, real-time economic calendar integration.</p>
        </div>

        <h3 class="section-title" style="color:#10b981;margin-top:1.5rem;">Future Enhancements &amp; Research Priorities</h3>
        <div style="background:var(--bg-card);border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <p style="font-size:0.85rem;color:#e0e0f0;margin-bottom:0.8rem;"><strong>Based on our audit findings, these are the highest-impact improvements to pursue:</strong></p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
                <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#ef4444;margin-bottom:0.3rem;">P1: Deploy Correct Algorithms</div>
                    <div style="font-size:0.78rem;color:#889;">The single most impactful fix. Bridge script will route A-grade Trend Following (Sharpe 2.42) and Mean Reversion (Sharpe 2.29) to forex live trading. Until this is done, all live forex trades are generated by the wrong algorithms.</div>
                </div>
                <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#ef4444;margin-bottom:0.3rem;">P1: Accumulate Trade Data</div>
                    <div style="font-size:0.78rem;color:#889;">Need 20+ closed forex trades for ML activation and 50+ for statistical significance. Current count: 3. After bridge script deployment, continuous paper trading should generate sufficient data within 4-6 weeks.</div>
                </div>
                <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#f59e0b;margin-bottom:0.3rem;">P2: Carry Trade Component</div>
                    <div style="font-size:0.78rem;color:#889;">Add interest rate differential tracking for all 10 pairs. Score pairs by carry attractiveness. Use central bank rate APIs to maintain current rate data. Carry is one of the most reliable forex edges and we are not using it.</div>
                </div>
                <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#f59e0b;margin-bottom:0.3rem;">P2: Central Bank Calendar</div>
                    <div style="font-size:0.78rem;color:#889;">Integrate FOMC, ECB, BOJ, BOE, RBA, BOC meeting schedules. Flag pairs affected by upcoming decisions. Reduce position sizing 24h before major events. Add post-decision momentum capture logic.</div>
                </div>
                <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">P3: Session-Aware Trading</div>
                    <div style="font-size:0.78rem;color:#889;">Detect London/NY/Asian sessions. Adjust signal confidence based on session volatility profiles. London-NY overlap generates best trend signals; Asian session suits mean reversion on JPY pairs.</div>
                </div>
                <div style="background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#3b82f6;margin-bottom:0.3rem;">P3: Correlation Matrix</div>
                    <div style="font-size:0.78rem;color:#889;">Build real-time correlation matrix across all 10 pairs. Prevent overexposure to single-factor risk (e.g., USD weakness affecting EUR/USD + GBP/USD + AUD/USD simultaneously). Adjust position sizing by portfolio-level correlation.</div>
                </div>
                <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">P4: Multi-Timeframe Confluence</div>
                    <div style="font-size:0.78rem;color:#889;">Require 4H + daily + weekly alignment before entering trades. When all three timeframes agree on direction, win probability increases significantly. Currently using single-timeframe signals only.</div>
                </div>
                <div style="background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2);border-radius:8px;padding:0.8rem;">
                    <div style="font-weight:600;color:#a855f7;margin-bottom:0.3rem;">P4: Commodity-Currency Correlation</div>
                    <div style="font-size:0.78rem;color:#889;">Track AUD with iron ore/gold, CAD with WTI crude, NOK with Brent. When commodity prices confirm currency direction, signals have higher conviction. Free commodity APIs (e.g., MetalpriceAPI) can provide this data.</div>
                </div>
            </div>
        </div>

        <h3 class="section-title" style="color:#f59e0b;margin-top:1.5rem;">World-Class Benchmark Comparison</h3>
        <div style="background:var(--bg-card);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:1rem;margin-bottom:1rem;">
            <p style="font-size:0.85rem;color:#889;margin-bottom:0.8rem;">How top forex trading operations compare, and where we need to be:</p>
            <div style="overflow-x:auto;">
                <table style="width:100%;font-size:0.78rem;color:#889;border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                            <th style="text-align:left;padding:0.5rem;color:#e0e0f0;">Metric</th>
                            <th style="text-align:center;padding:0.5rem;color:#22c55e;">World-Class Target</th>
                            <th style="text-align:center;padding:0.5rem;color:#f59e0b;">Our Current</th>
                            <th style="text-align:center;padding:0.5rem;color:#3b82f6;">Gap</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                            <td style="padding:0.5rem;">Forward Win Rate</td>
                            <td style="text-align:center;padding:0.5rem;">55-65%</td>
                            <td style="text-align:center;padding:0.5rem;">0% (3 trades)</td>
                            <td style="text-align:center;padding:0.5rem;color:#ef4444;">Wrong algos deployed</td>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                            <td style="padding:0.5rem;">Backtested Sharpe Ratio</td>
                            <td style="text-align:center;padding:0.5rem;">1.5-3.0</td>
                            <td style="text-align:center;padding:0.5rem;">2.29-2.42</td>
                            <td style="text-align:center;padding:0.5rem;color:#22c55e;">Excellent (backtested)</td>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                            <td style="padding:0.5rem;">Carry Trade Component</td>
                            <td style="text-align:center;padding:0.5rem;">Yes (core strategy)</td>
                            <td style="text-align:center;padding:0.5rem;">No</td>
                            <td style="text-align:center;padding:0.5rem;color:#ef4444;">Not implemented</td>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                            <td style="padding:0.5rem;">Central Bank Calendar</td>
                            <td style="text-align:center;padding:0.5rem;">Real-time integration</td>
                            <td style="text-align:center;padding:0.5rem;">None</td>
                            <td style="text-align:center;padding:0.5rem;color:#ef4444;">Critical gap</td>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                            <td style="padding:0.5rem;">Pairs Tracked</td>
                            <td style="text-align:center;padding:0.5rem;">20-50 (G10 + EM)</td>
                            <td style="text-align:center;padding:0.5rem;">10 (G10 majors)</td>
                            <td style="text-align:center;padding:0.5rem;color:#f59e0b;">Adequate for start</td>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                            <td style="padding:0.5rem;">Session-Aware Trading</td>
                            <td style="text-align:center;padding:0.5rem;">Yes (London/NY/Asian)</td>
                            <td style="text-align:center;padding:0.5rem;">No</td>
                            <td style="text-align:center;padding:0.5rem;color:#f59e0b;">Planned Phase 5</td>
                        </tr>
                        <tr>
                            <td style="padding:0.5rem;">ML/Grid Search</td>
                            <td style="text-align:center;padding:0.5rem;">Walk-forward validated</td>
                            <td style="text-align:center;padding:0.5rem;">Cannot train (3 trades)</td>
                            <td style="text-align:center;padding:0.5rem;color:#ef4444;">Need 20+ trades</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p style="font-size:0.78rem;color:#666;margin-top:1rem;">Benchmark firms: Citadel (forex market making), Renaissance Technologies (stat arb), Deutsche Bank (macro), Bridgewater Associates (macro forex).</p>
        </div>

        <div style="margin-top:1.5rem;padding:1rem;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:12px;">
            <div style="font-weight:600;color:#ef4444;margin-bottom:0.5rem;">The Hard Truth</div>
            <p style="font-size:0.85rem;color:#889;">Our forex system has excellent backtested results (Sharpe 2.29-2.42) but a completely broken live implementation. The A-grade algorithms are sitting unused while inferior algorithms lose every trade. This is the most fixable problem in our entire platform -- the bridge script deployment will immediately address it. However, even after fixing, we still lack carry trade components, central bank calendar integration, and session-aware trading that every professional forex desk uses. The backtests give us confidence the core approach works; the question is whether the forward results will validate that confidence once the correct algorithms are deployed.</p>
        </div>
    </div>

    <!-- Data Sources & Transparency -->
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.5rem;">
        <h3 style="font-size:1rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:8px;">
            Data Sources & Transparency
            <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);">LOSING</span>
        </h3>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
            <strong style="color:var(--text);">Where the numbers come from:</strong><br>
            &bull; <strong>Forward-facing results:</strong> <a href="/live-monitor/api/algo_performance.php?action=by_asset&days=30" target="_blank">algo_performance.php?action=by_asset</a> &mdash; 0% WR (0/3 forex trades in L vs O)<br>
            &bull; <strong>Backtested strategies:</strong> <a href="api/forex_portfolio.php?action=strategies" target="_blank">forex_portfolio.php?action=strategies</a> &mdash; backtests against historical data<br>
            &bull; <strong>Live forex prices:</strong> <a href="/live-monitor/api/live_prices.php" target="_blank">live_prices.php</a> &mdash; TwelveData API (10 forex pairs)<br>
            &bull; <strong>Live signals:</strong> <a href="/live-monitor/api/live_signals.php" target="_blank">live_signals.php</a> &mdash; 20 algorithms including forex-specific<br>
            &bull; <strong>Paper trading:</strong> <a href="/live-monitor/live-monitor.html" target="_blank">Live Monitor</a> &mdash; $10K capital, multi-asset<br>
            &bull; <strong>Compare to:</strong> <a href="/live-monitor/algo-performance.html">L vs O Algo Performance</a> &mdash; our #1 system (crypto-dominant)
        </div>
    </div>

    <!-- Future Roadmap -->
    <div style="background:var(--bg-card);border:1px solid rgba(14,165,233,0.3);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.5rem;">
        <h3 style="font-size:1rem;margin-bottom:0.75rem;display:flex;align-items:center;gap:8px;">
            Future Roadmap
            <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(34,197,94,0.15);color:#22c55e;border:1px solid rgba(34,197,94,0.3);">PLANNED</span>
        </h3>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
            <strong style="color:var(--green);">Near-term:</strong><br>
            &bull; Add forward-facing trade tracking (currently backtests only on this page)<br>
            &bull; Track every forex signal from Live Monitor with entry/exit prices<br>
            &bull; Add real-time spread and slippage analysis<br><br>
            <strong style="color:var(--yellow);">Q2 2026:</strong><br>
            &bull; Forex-specific algorithm tuning (session-aware: London, NY, Asian)<br>
            &bull; Interest rate differential scoring (carry trade detection)<br>
            &bull; Multi-timeframe confluence (4h + daily + weekly alignment)<br><br>
            <strong style="color:var(--text-dim);">Long-term:</strong><br>
            &bull; Correlation matrix across all 10 tracked pairs<br>
            &bull; Economic calendar integration (NFP, FOMC, ECB events)<br>
            &bull; Risk parity portfolio builder for forex positions
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Disclaimer ‚îÄ‚îÄ‚îÄ -->
    <div class="disclaimer">
        <strong>Disclaimer:</strong> This tool is for <strong>research and educational purposes only</strong>.
        Past performance does not guarantee future results. Backtests use historical data and may not reflect real-world execution.
        All simulations include spread costs and configurable slippage. Forex trading involves risk of loss.
        Consult a licensed financial adviser before making investment decisions.
    </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ
var API_BASE = 'api/';
let allStrategies = [];
let currentTrades = [];
let equityChartInstance = null;
let strategyChartInstance = null;
let comparisonChartInstance = null;

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
    initTabs();
    loadStats();
    loadStrategies();
    loadScenarios();
});

// ‚îÄ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ‚îÄ
function initTabs() {
    var tabs = document.querySelectorAll('.tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].addEventListener('click', function() {
            var target = this.getAttribute('data-tab');
            var allTabs = document.querySelectorAll('.tab');
            var allContent = document.querySelectorAll('.tab-content');
            for (var j = 0; j < allTabs.length; j++) allTabs[j].classList.remove('active');
            for (var j = 0; j < allContent.length; j++) allContent[j].classList.remove('active');
            this.classList.add('active');
            document.getElementById('tab-' + target).classList.add('active');
            // Load data for tab
            if (target === 'signals') loadSignals();
            if (target === 'history') loadHistory();
        });
    }
}

// ‚îÄ‚îÄ‚îÄ API Helper ‚îÄ‚îÄ‚îÄ
function apiCall(endpoint, params, callback) {
    var qs = [];
    for (var k in params) {
        if (params.hasOwnProperty(k) && params[k] !== '') {
            qs.push(encodeURIComponent(k) + '=' + encodeURIComponent(params[k]));
        }
    }
    var url = API_BASE + endpoint + (qs.length > 0 ? '?' + qs.join('&') : '');
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.onload = function() {
        try {
            var data = JSON.parse(xhr.responseText);
            callback(null, data);
        } catch(e) {
            callback('Parse error: ' + e.message);
        }
    };
    xhr.onerror = function() { callback('Network error'); };
    xhr.send();
}

// ‚îÄ‚îÄ‚îÄ Load Stats ‚îÄ‚îÄ‚îÄ
function loadStats() {
    apiCall('data.php', {type: 'stats'}, function(err, data) {
        if (err || !data || !data.ok) {
            document.getElementById('setupBanner').style.display = 'block';
            return;
        }
        var s = data.stats;
        document.getElementById('statPairs').textContent = s.total_pairs || 0;
        document.getElementById('statSignals').textContent = s.total_picks || 0;
        document.getElementById('statPrices').textContent = s.total_price_records || 0;
        document.getElementById('statStrategies').textContent = s.active_algorithms || 0;
        document.getElementById('statBacktests').textContent = s.total_backtests || 0;

        if ((s.total_picks || 0) === 0) {
            document.getElementById('setupBanner').style.display = 'block';
        }
    });
}

// ‚îÄ‚îÄ‚îÄ Load Strategies ‚îÄ‚îÄ‚îÄ
function loadStrategies() {
    apiCall('data.php', {type: 'algorithms'}, function(err, data) {
        if (err || !data || !data.algorithms) return;
        allStrategies = data.algorithms;
        renderStrategyCheckboxes('strategyCheckboxes');
        renderStrategyCheckboxes('compareStrategyCheckboxes');
        renderStrategyFilter();
        populateOptStrategyFilter();
    });
}

function renderStrategyCheckboxes(containerId) {
    var html = '';
    for (var i = 0; i < allStrategies.length; i++) {
        var s = allStrategies[i];
        var count = s.signal_count || 0;
        html += '<label class="checkbox-item">'
             + '<input type="checkbox" value="' + s.name + '" checked>'
             + s.name + ' (' + count + ')'
             + '</label>';
    }
    document.getElementById(containerId).innerHTML = html;
}

function selectOnlyStrategy(containerId, strategyName) {
    var boxes = document.querySelectorAll('#' + containerId + ' input[type="checkbox"]');
    for (var i = 0; i < boxes.length; i++) {
        boxes[i].checked = (boxes[i].value === strategyName);
    }
}

function renderStrategyFilter() {
    var sel = document.getElementById('signalsStrategyFilter');
    for (var i = 0; i < allStrategies.length; i++) {
        var opt = document.createElement('option');
        opt.value = allStrategies[i].name;
        opt.textContent = allStrategies[i].name;
        sel.appendChild(opt);
    }
}

function getSelectedStrategies(containerId) {
    var cbs = document.getElementById(containerId).querySelectorAll('input[type="checkbox"]:checked');
    var selected = [];
    for (var i = 0; i < cbs.length; i++) selected.push(cbs[i].value);
    return selected.join(',');
}

// ‚îÄ‚îÄ‚îÄ Load Scenarios ‚îÄ‚îÄ‚îÄ
function loadScenarios() {
    apiCall('data.php', {type: 'scenarios'}, function(err, data) {
        if (err || !data || !data.scenarios) return;
        var grid = document.getElementById('scenarioGrid');
        var html = '';
        for (var i = 0; i < data.scenarios.length; i++) {
            var sc = data.scenarios[i];
            html += '<div class="scenario-card" data-key="' + sc.key + '" onclick="selectScenario(this, \'' + sc.key + '\',' + sc.tp + ',' + sc.sl + ',' + sc.hold + ')">'
                 + '<h4>' + sc.name + '</h4>'
                 + '<div class="scenario-meta">'
                 + '<span>TP: ' + (sc.tp >= 999 ? 'None' : sc.tp + ' pips') + '</span>'
                 + '<span>SL: ' + (sc.sl >= 999 ? 'None' : sc.sl + ' pips') + '</span>'
                 + '<span>Hold: ' + sc.hold + 'd</span>'
                 + '</div></div>';
        }
        grid.innerHTML = html;
    });
}

function selectScenario(el, key, tp, sl, hold) {
    var cards = document.querySelectorAll('.scenario-card');
    for (var i = 0; i < cards.length; i++) cards[i].classList.remove('selected');
    el.classList.add('selected');
    document.getElementById('takeProfit').value = tp >= 999 ? 999 : tp;
    document.getElementById('stopLoss').value = sl >= 999 ? 999 : sl;
    document.getElementById('maxHoldDays').value = hold;
}

function onStrategyChange() {
    var strat = document.getElementById('strategyType').value;
    var presets = {
        scalp:       {tp: 0.5, sl: 0.3, hold: 1},
        daytrade:    {tp: 1,   sl: 0.5, hold: 2},
        swing:       {tp: 3,   sl: 1,   hold: 14},
        trendfollow: {tp: 5,   sl: 2,   hold: 30},
        carrytrade:  {tp: 999, sl: 5,   hold: 90}
    };
    if (presets[strat]) {
        document.getElementById('takeProfit').value = presets[strat].tp;
        document.getElementById('stopLoss').value = presets[strat].sl;
        document.getElementById('maxHoldDays').value = presets[strat].hold;
    }
}

// ‚îÄ‚îÄ‚îÄ Run What-If ‚îÄ‚îÄ‚îÄ
function runWhatIf(save) {
    var strategies = getSelectedStrategies('strategyCheckboxes');
    var params = {
        strategies: strategies,
        strategy: document.getElementById('strategyType').value,
        take_profit: document.getElementById('takeProfit').value,
        stop_loss: document.getElementById('stopLoss').value,
        max_hold_days: document.getElementById('maxHoldDays').value,
        initial_capital: document.getElementById('initialCapital').value,
        spread_pips: document.getElementById('spreadPips').value,
        slippage: document.getElementById('slippage').value,
        position_size: document.getElementById('positionSize').value
    };
    if (save) params.save = '1';

    document.getElementById('whatifResults').style.display = 'none';
    document.getElementById('whatifEmpty').innerHTML = '<div class="loading">Running analysis</div>';
    document.getElementById('whatifEmpty').style.display = 'block';

    apiCall('backtest.php', params, function(err, data) {
        if (err || !data || !data.ok) {
            document.getElementById('whatifEmpty').innerHTML = '<p style="color:var(--red);">Error: ' + (err || (data && data.error ? data.error : 'Unknown error')) + '</p>';
            return;
        }
        document.getElementById('whatifEmpty').style.display = 'none';
        document.getElementById('whatifResults').style.display = 'block';
        currentTrades = data.trades || [];
        renderWhatIfResults(data);
    });
}

function renderWhatIfResults(data) {
    var s = data.summary;
    var p = data.params || {};
    var statsHtml = ''
        + statCard('Total Return', fmtPct(s.total_return_pct), s.total_return_pct)
        + statCard('Final Value', '$' + fmtNum(s.final_value), s.final_value - p.initial_capital)
        + statCard('Win Rate', s.win_rate + '%', s.win_rate - 50)
        + statCard('Total Trades', s.total_trades, 0)
        + statCard('Avg Win', fmtPct(s.avg_win_pct), 1)
        + statCard('Avg Loss', fmtPct(-s.avg_loss_pct), -1)
        + statCard('Max Drawdown', fmtPct(-s.max_drawdown_pct), -1)
        + statCard('Total Spread Cost', '$' + fmtNum(s.total_spread_cost || 0), -1)
        + statCard('Sharpe Ratio', s.sharpe_ratio, s.sharpe_ratio)
        + statCard('Profit Factor', s.profit_factor, s.profit_factor - 1)
        + statCard('Expectancy', fmtPct(s.expectancy), s.expectancy);

    document.getElementById('whatifStats').innerHTML = statsHtml;

    renderTradeTable(data.trades);
    renderEquityChart(data);
    renderStrategyChart(data);
}

function statCard(label, value, sentiment) {
    var cls = sentiment > 0 ? 'positive' : (sentiment < 0 ? 'negative' : 'neutral');
    return '<div class="stat-card"><div class="label">' + label + '</div><div class="value ' + cls + '">' + value + '</div></div>';
}

function fmtPct(v) { return (v >= 0 ? '+' : '') + parseFloat(v).toFixed(2) + '%'; }
function fmtNum(v) { return parseFloat(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

// ‚îÄ‚îÄ‚îÄ Trade Table ‚îÄ‚îÄ‚îÄ
function renderTradeTable(trades) {
    var tbody = document.getElementById('tradeTable').querySelector('tbody');
    var html = '';
    for (var i = 0; i < trades.length; i++) {
        var t = trades[i];
        var cls = t.net_profit >= 0 ? 'positive' : 'negative';
        var reasonBadge = t.exit_reason === 'take_profit' ? '<span class="badge badge-green">TP</span>'
                       : t.exit_reason === 'stop_loss' ? '<span class="badge badge-red">SL</span>'
                       : t.exit_reason === 'max_hold' ? '<span class="badge badge-yellow">MAX</span>'
                       : '<span class="badge badge-blue">' + t.exit_reason + '</span>';
        html += '<tr>'
             + '<td><strong>' + t.pair + '</strong></td>'
             + '<td>' + t.strategy + '</td>'
             + '<td>' + t.entry_date + '</td>'
             + '<td>' + parseFloat(t.entry_price).toFixed(5) + '</td>'
             + '<td>' + (t.exit_date || '‚Äî') + '</td>'
             + '<td>' + parseFloat(t.exit_price).toFixed(5) + '</td>'
             + '<td>' + t.lots + '</td>'
             + '<td class="' + cls + '">$' + parseFloat(t.net_profit).toFixed(2) + '</td>'
             + '<td class="' + cls + '">' + fmtPct(t.return_pct) + '</td>'
             + '<td>' + reasonBadge + '</td>'
             + '<td>' + t.hold_days + '</td>'
             + '<td>$' + parseFloat(t.spread_cost || 0).toFixed(2) + '</td>'
             + '</tr>';
    }
    tbody.innerHTML = html || '<tr><td colspan="12" style="text-align:center; color:var(--text-dim);">No trades executed</td></tr>';
}

// ‚îÄ‚îÄ‚îÄ Sort Table ‚îÄ‚îÄ‚îÄ
var sortDir = {};
function sortTable(colIdx) {
    var table = document.getElementById('tradeTable');
    var tbody = table.querySelector('tbody');
    var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
    var dir = sortDir[colIdx] === 'asc' ? 'desc' : 'asc';
    sortDir[colIdx] = dir;
    rows.sort(function(a, b) {
        var aVal = a.cells[colIdx].textContent.replace(/[$%+,]/g, '');
        var bVal = b.cells[colIdx].textContent.replace(/[$%+,]/g, '');
        var aNum = parseFloat(aVal);
        var bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return dir === 'asc' ? aNum - bNum : bNum - aNum;
        }
        return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });
    for (var i = 0; i < rows.length; i++) tbody.appendChild(rows[i]);
}

// ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ
function renderEquityChart(data) {
    var ctx = document.getElementById('equityChart').getContext('2d');
    if (equityChartInstance) equityChartInstance.destroy();

    var trades = data.trades || [];
    var capital = data.params.initial_capital || 10000;
    var labels = ['Start'];
    var values = [capital];
    for (var i = 0; i < trades.length; i++) {
        capital += parseFloat(trades[i].net_profit);
        labels.push(trades[i].pair);
        values.push(Math.round(capital * 100) / 100);
    }

    equityChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Portfolio Value ($)',
                data: values,
                borderColor: '#0ea5e9',
                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 3,
                pointBackgroundColor: function(context) {
                    var idx = context.dataIndex;
                    if (idx === 0) return '#0ea5e9';
                    return values[idx] >= values[idx - 1] ? '#22c55e' : '#ef4444';
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: 'rgba(42,42,74,0.5)' }, ticks: { color: '#8888aa' } },
                x: { grid: { display: false }, ticks: { color: '#8888aa', maxRotation: 45 } }
            }
        }
    });
}

function renderStrategyChart(data) {
    var ctx = document.getElementById('strategyChart').getContext('2d');
    if (strategyChartInstance) strategyChartInstance.destroy();

    var trades = data.trades || [];
    var strategyMap = {};
    for (var i = 0; i < trades.length; i++) {
        var strat = trades[i].strategy;
        if (!strategyMap[strat]) strategyMap[strat] = {wins: 0, losses: 0, totalReturn: 0, count: 0};
        strategyMap[strat].count++;
        strategyMap[strat].totalReturn += parseFloat(trades[i].return_pct);
        if (parseFloat(trades[i].net_profit) >= 0) strategyMap[strat].wins++;
        else strategyMap[strat].losses++;
    }

    var labels = [], returns = [], colors = [];
    for (var name in strategyMap) {
        labels.push(name);
        var avg = strategyMap[name].totalReturn / strategyMap[name].count;
        returns.push(Math.round(avg * 100) / 100);
        colors.push(avg >= 0 ? '#22c55e' : '#ef4444');
    }

    strategyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Avg Return %',
                data: returns,
                backgroundColor: colors,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: 'rgba(42,42,74,0.5)' }, ticks: { color: '#8888aa', callback: function(v) { return v + '%'; } } },
                x: { grid: { display: false }, ticks: { color: '#8888aa', maxRotation: 45 } }
            }
        }
    });
}

// ‚îÄ‚îÄ‚îÄ Comparison ‚îÄ‚îÄ‚îÄ
function runComparison() {
    var strategies = getSelectedStrategies('compareStrategyCheckboxes');
    document.getElementById('comparisonResults').style.display = 'none';

    apiCall('backtest.php', {compare: '1', strategies: strategies, initial_capital: document.getElementById('initialCapital').value, spread_pips: document.getElementById('spreadPips').value}, function(err, data) {
        if (err || !data || !data.ok) return;
        document.getElementById('comparisonResults').style.display = 'block';
        renderComparison(data);
    });
}

function renderComparison(data) {
    var scenarios = data.scenarios || [];

    // Table
    var tbody = document.getElementById('comparisonTable').querySelector('tbody');
    var html = '';
    for (var i = 0; i < scenarios.length; i++) {
        var sc = scenarios[i];
        var s = sc.summary;
        var cls = s.total_return_pct >= 0 ? 'positive' : 'negative';
        html += '<tr>'
             + '<td><strong>' + sc.name + '</strong></td>'
             + '<td>' + (sc.params.take_profit >= 999 ? '‚Äî' : sc.params.take_profit + ' pips') + '</td>'
             + '<td>' + (sc.params.stop_loss >= 999 ? '‚Äî' : sc.params.stop_loss + ' pips') + '</td>'
             + '<td>' + sc.params.max_hold_days + 'd</td>'
             + '<td>' + s.total_trades + '</td>'
             + '<td>' + s.win_rate + '%</td>'
             + '<td class="' + cls + '">' + fmtPct(s.total_return_pct) + '</td>'
             + '<td>$' + fmtNum(s.final_value) + '</td>'
             + '<td class="negative">' + fmtPct(-s.max_drawdown_pct) + '</td>'
             + '<td>$' + fmtNum(s.total_spread_cost || 0) + '</td>'
             + '<td>' + s.sharpe_ratio + '</td>'
             + '<td>' + s.profit_factor + '</td>'
             + '<td class="' + (s.expectancy >= 0 ? 'positive' : 'negative') + '">' + fmtPct(s.expectancy) + '</td>'
             + '</tr>';
    }
    tbody.innerHTML = html;

    // Chart
    var ctx = document.getElementById('comparisonChart').getContext('2d');
    if (comparisonChartInstance) comparisonChartInstance.destroy();

    var labels = [], returns = [], winRates = [], colors = [];
    for (var i = 0; i < scenarios.length; i++) {
        labels.push(scenarios[i].name);
        returns.push(scenarios[i].summary.total_return_pct);
        winRates.push(scenarios[i].summary.win_rate);
        colors.push(scenarios[i].summary.total_return_pct >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)');
    }

    comparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Total Return %', data: returns, backgroundColor: colors, borderRadius: 6 },
                { label: 'Win Rate %', data: winRates, backgroundColor: 'rgba(14,165,233,0.5)', borderRadius: 6 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#8888aa' } } },
            scales: {
                y: { grid: { color: 'rgba(42,42,74,0.5)' }, ticks: { color: '#8888aa', callback: function(v) { return v + '%'; } } },
                x: { grid: { display: false }, ticks: { color: '#8888aa', maxRotation: 45, font: { size: 10 } } }
            }
        }
    });
}

// ‚îÄ‚îÄ‚îÄ Signals ‚îÄ‚îÄ‚îÄ
function loadSignals() {
    var strategy = document.getElementById('signalsStrategyFilter').value;
    var params = {type: 'signals'};
    if (strategy) params.strategy = strategy;

    apiCall('data.php', params, function(err, data) {
        if (err || !data || !data.signals) return;
        var tbody = document.getElementById('signalsTable').querySelector('tbody');
        var html = '';
        for (var i = 0; i < data.signals.length; i++) {
            var sig = data.signals[i];
            var statusBadge = sig.status === 'active' ? '<span class="badge badge-green">Active</span>'
                          : sig.status === 'closed' ? '<span class="badge badge-blue">Closed</span>'
                          : '<span class="badge badge-yellow">' + sig.status + '</span>';
            var dirBadge = sig.direction === 'long' ? '<span class="badge badge-green">LONG</span>'
                        : '<span class="badge badge-red">SHORT</span>';
            html += '<tr>'
                 + '<td><strong>' + sig.pair + '</strong></td>'
                 + '<td>' + sig.strategy_name + '</td>'
                 + '<td>' + sig.signal_date + '</td>'
                 + '<td>' + parseFloat(sig.entry_price).toFixed(5) + '</td>'
                 + '<td>' + dirBadge + '</td>'
                 + '<td>' + (sig.take_profit ? sig.take_profit + ' pips' : '‚Äî') + '</td>'
                 + '<td>' + (sig.stop_loss ? sig.stop_loss + ' pips' : '‚Äî') + '</td>'
                 + '<td>' + statusBadge + '</td>'
                 + '</tr>';
        }
        tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center; color:var(--text-dim);">No signals found</td></tr>';
    });
}

// ‚îÄ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ
function loadHistory() {
    apiCall('data.php', {type: 'backtests'}, function(err, data) {
        if (err || !data || !data.backtests) return;
        var tbody = document.getElementById('historyTable').querySelector('tbody');
        var html = '';
        for (var i = 0; i < data.backtests.length; i++) {
            var b = data.backtests[i];
            var cls = parseFloat(b.total_return_pct) >= 0 ? 'positive' : 'negative';
            html += '<tr>'
                 + '<td>' + b.run_name + '</td>'
                 + '<td>' + b.strategy_type + '</td>'
                 + '<td>' + (b.strategy_filter || 'All') + '</td>'
                 + '<td>' + b.total_trades + '</td>'
                 + '<td>' + b.win_rate + '%</td>'
                 + '<td class="' + cls + '">' + fmtPct(b.total_return_pct) + '</td>'
                 + '<td>$' + fmtNum(b.final_value) + '</td>'
                 + '<td>' + fmtPct(-parseFloat(b.max_drawdown_pct)) + '</td>'
                 + '<td>' + b.sharpe_ratio + '</td>'
                 + '<td>' + b.created_at + '</td>'
                 + '</tr>';
        }
        tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; color:var(--text-dim);">No saved backtests yet</td></tr>';
    });
}

// ‚îÄ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ‚îÄ
function exportCSV() {
    if (!currentTrades || currentTrades.length === 0) return;
    var csv = 'Pair,Strategy,Entry Date,Entry Price,Exit Date,Exit Price,Lots,Net P/L,Return %,Exit Reason,Hold Days,Spread Cost\n';
    for (var i = 0; i < currentTrades.length; i++) {
        var t = currentTrades[i];
        csv += [t.pair, t.strategy, t.entry_date, t.entry_price, t.exit_date, t.exit_price, t.lots, t.net_profit, t.return_pct, t.exit_reason, t.hold_days, t.spread_cost || 0].join(',') + '\n';
    }
    var blob = new Blob([csv], {type: 'text/csv'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'forex_backtest_trades_' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click();
}

// ‚îÄ‚îÄ‚îÄ Setup Functions ‚îÄ‚îÄ‚îÄ
function runSetup() {
    logSetup('Creating tables...');
    apiCall('setup_schema.php', {}, function(err, data) {
        if (err) { logSetup('Error: ' + err); return; }
        logSetup('Schema: ' + JSON.stringify(data.actions));
    });
}

function seedSignals() {
    logSetup('Seeding signals...');
    apiCall('seed_signals.php', {}, function(err, data) {
        if (err) { logSetup('Error: ' + err); return; }
        logSetup('Seeded: ' + data.seeded + ' signals');
        loadStats();
    });
}

function fetchPrices() {
    logSetup('Fetching price data (this may take a moment)...');
    apiCall('fetch_prices.php', {range: '1y'}, function(err, data) {
        if (err) { logSetup('Error: ' + err); return; }
        var msg = 'Fetched: ' + data.fetched + ' pairs.';
        if (data.errors && data.errors.length > 0) msg += ' Errors: ' + data.errors.join(', ');
        logSetup(msg);
        loadStats();
    });
}

function logSetup(msg) {
    var log = document.getElementById('setupLog');
    log.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + msg + '</div>';
}

// ‚îÄ‚îÄ‚îÄ Optimal Finder ‚îÄ‚îÄ‚îÄ
var optimalChartInstance = null;

function runOptimalFinder() {
    var strategy = document.getElementById('optStrategyFilter').value;
    var sortBy = document.getElementById('optSortBy').value;
    var quick = document.getElementById('optQuick').value;
    var topN = document.getElementById('optTopN').value;
    var spreadPips = document.getElementById('optSpreadPips').value;

    document.getElementById('optimalEmpty').style.display = 'none';
    document.getElementById('optimalResults').style.display = 'none';
    document.getElementById('optimalLoading').style.display = 'block';
    document.getElementById('optRunBtn').disabled = true;
    document.getElementById('optRunBtn').textContent = 'Searching...';

    var params = {
        strategies: strategy,
        sort_by: sortBy,
        quick: quick,
        top: topN,
        spread_pips: spreadPips,
        initial_capital: document.getElementById('initialCapital').value,
        slippage: document.getElementById('slippage').value
    };

    apiCall('optimal_finder.php', params, function(err, data) {
        document.getElementById('optimalLoading').style.display = 'none';
        document.getElementById('optRunBtn').disabled = false;
        document.getElementById('optRunBtn').textContent = 'Find Optimal Conditions';

        if (err || !data || !data.ok) {
            document.getElementById('optimalEmpty').style.display = 'block';
            document.getElementById('optimalEmpty').innerHTML = '<p style="color:var(--red);">Error: ' + (err || (data && data.error ? data.error : 'Unknown')) + '</p>';
            return;
        }

        document.getElementById('optimalResults').style.display = 'block';
        renderOptimalResults(data);
    });
}

function renderOptimalResults(data) {
    var top = data.top_results || [];
    var worst = data.worst_results || [];
    var sortLabel = {
        total_return_pct: 'Return %',
        win_rate: 'Win Rate',
        sharpe_ratio: 'Sharpe Ratio',
        profit_factor: 'Profit Factor',
        expectancy: 'Expectancy',
        final_value: 'Final Value'
    };
    document.getElementById('optSortLabel').textContent = sortLabel[data.sort_by] || data.sort_by;

    // ‚îÄ‚îÄ‚îÄ Summary stats ‚îÄ‚îÄ‚îÄ
    var html = '';
    html += statCard('Permutations Tested', data.total_permutations, 0);
    html += statCard('With Trades', data.total_with_trades, 0);
    html += statCard('Time Elapsed', data.elapsed_seconds + 's', 0);
    html += statCard('Signals Analyzed', data.total_signals, 0);
    if (top.length > 0) {
        var best = top[0].summary;
        html += statCard('Best Return', fmtPct(best.total_return_pct), best.total_return_pct);
        html += statCard('Best Win Rate', best.win_rate + '%', best.win_rate - 50);
        html += statCard('Best Sharpe', best.sharpe_ratio, best.sharpe_ratio);
        html += statCard('Best Final Value', '$' + fmtNum(best.final_value), best.final_value - data.initial_capital);
    }
    document.getElementById('optimalSummaryStats').innerHTML = html;

    // ‚îÄ‚îÄ‚îÄ Winner card ‚îÄ‚îÄ‚îÄ
    if (top.length > 0) {
        var w = top[0];
        var ws = w.summary;
        var wp = w.params;
        var winnerHtml = '<div class="stat-grid" style="margin-top:1rem;">';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Take Profit</div><div class="value">' + (wp.take_profit >= 999 ? 'None (Hold)' : wp.take_profit + ' pips') + '</div></div>';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Stop Loss</div><div class="value">' + (wp.stop_loss >= 999 ? 'None' : wp.stop_loss + ' pips') + '</div></div>';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Holding Period</div><div class="value">' + wp.max_hold_days + ' days</div></div>';
        winnerHtml += '<div class="stat-card" style="border-color:var(--green)"><div class="label">Spread</div><div class="value">' + wp.spread_pips + ' pips</div></div>';
        winnerHtml += '</div>';
        winnerHtml += '<div class="stat-grid" style="margin-top:0.5rem;">';
        winnerHtml += statCard('Total Return', fmtPct(ws.total_return_pct), ws.total_return_pct);
        winnerHtml += statCard('Win Rate', ws.win_rate + '%', ws.win_rate - 50);
        winnerHtml += statCard('Final Value', '$' + fmtNum(ws.final_value), ws.final_value - data.initial_capital);
        winnerHtml += statCard('Trades', ws.total_trades, 0);
        winnerHtml += statCard('Sharpe', ws.sharpe_ratio, ws.sharpe_ratio);
        winnerHtml += statCard('Profit Factor', ws.profit_factor, ws.profit_factor - 1);
        winnerHtml += statCard('Max Drawdown', fmtPct(-ws.max_drawdown_pct), -1);
        winnerHtml += statCard('Total Spread Cost', '$' + fmtNum(ws.total_spread_cost || 0), -1);
        winnerHtml += '</div>';

        if (ws.best_trade) {
            winnerHtml += '<p style="margin-top:1rem;font-size:0.85rem;color:var(--text-dim);">Best single trade: <strong style="color:var(--green);">' + ws.best_trade.pair + '</strong> ' + ws.best_trade.entry_date + ' ‚Üí ' + ws.best_trade.exit_date + ' (' + fmtPct(ws.best_trade.return_pct) + ', ' + ws.best_trade.exit_reason + ')</p>';
        }

        document.getElementById('optimalWinnerContent').innerHTML = winnerHtml;
        document.getElementById('optimalWinnerCard').style.display = 'block';
    }

    // ‚îÄ‚îÄ‚îÄ Top results chart ‚îÄ‚îÄ‚îÄ
    renderOptimalChart(top, data.sort_by);

    // ‚îÄ‚îÄ‚îÄ Top results table ‚îÄ‚îÄ‚îÄ
    renderOptimalTable(top);

    // ‚îÄ‚îÄ‚îÄ Worst results table ‚îÄ‚îÄ‚îÄ
    renderWorstTable(worst);
}

function renderOptimalChart(results, sortKey) {
    var ctx = document.getElementById('optimalChart').getContext('2d');
    if (optimalChartInstance) optimalChartInstance.destroy();

    var labels = [], values = [], winRates = [], colors = [];
    var max = Math.min(results.length, 20);
    for (var i = 0; i < max; i++) {
        var r = results[i];
        var lbl = '#' + r.rank + ' ' + (r.params.take_profit >= 999 ? 'NoTP' : 'TP' + r.params.take_profit) + '/' + (r.params.stop_loss >= 999 ? 'NoSL' : 'SL' + r.params.stop_loss) + '/' + r.params.max_hold_days + 'd';
        labels.push(lbl);
        values.push(r.summary[sortKey] || 0);
        winRates.push(r.summary.win_rate);
        colors.push(r.summary.total_return_pct >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)');
    }

    optimalChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: sortKey.replace(/_/g, ' '), data: values, backgroundColor: colors, borderRadius: 6 },
                { label: 'Win Rate %', data: winRates, backgroundColor: 'rgba(14,165,233,0.4)', borderRadius: 6 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { labels: { color: '#8888aa' } } },
            scales: {
                x: { grid: { color: 'rgba(42,42,74,0.5)' }, ticks: { color: '#8888aa' } },
                y: { grid: { display: false }, ticks: { color: '#8888aa', font: { size: 10 } } }
            }
        }
    });
}

function renderOptimalTable(results) {
    var tbody = document.getElementById('optimalTable').querySelector('tbody');
    var html = '';
    for (var i = 0; i < results.length; i++) {
        var r = results[i];
        var s = r.summary;
        var p = r.params;
        var cls = s.total_return_pct >= 0 ? 'positive' : 'negative';
        var bestTrade = s.best_trade ? (s.best_trade.pair + ' ' + fmtPct(s.best_trade.return_pct)) : '‚Äî';
        var isWinner = (i === 0);
        var rowStyle = isWinner ? ' style="background:rgba(34,197,94,0.08);"' : '';
        html += '<tr' + rowStyle + '>'
             + '<td>' + (isWinner ? '<strong style="color:var(--green);">#' + r.rank + ' üèÜ</strong>' : '#' + r.rank) + '</td>'
             + '<td style="font-size:0.75rem;">' + p.label + '</td>'
             + '<td>' + (p.take_profit >= 999 ? '‚Äî' : p.take_profit + ' pips') + '</td>'
             + '<td>' + (p.stop_loss >= 999 ? '‚Äî' : p.stop_loss + ' pips') + '</td>'
             + '<td>' + p.max_hold_days + 'd</td>'
             + '<td>' + p.spread_pips + ' pips</td>'
             + '<td>' + s.total_trades + '</td>'
             + '<td>' + s.win_rate + '%</td>'
             + '<td class="' + cls + '"><strong>' + fmtPct(s.total_return_pct) + '</strong></td>'
             + '<td>$' + fmtNum(s.final_value) + '</td>'
             + '<td class="negative">' + fmtPct(-s.max_drawdown_pct) + '</td>'
             + '<td>' + s.sharpe_ratio + '</td>'
             + '<td>' + s.profit_factor + '</td>'
             + '<td>$' + fmtNum(s.total_spread_cost || 0) + '</td>'
             + '<td style="font-size:0.75rem;">' + bestTrade + '</td>'
             + '</tr>';
    }
    tbody.innerHTML = html || '<tr><td colspan="15" style="text-align:center;">No results</td></tr>';
}

function renderWorstTable(results) {
    var tbody = document.getElementById('worstTable').querySelector('tbody');
    var html = '';
    for (var i = 0; i < results.length; i++) {
        var r = results[i];
        var s = r.summary;
        var p = r.params;
        var worstTrade = s.worst_trade ? (s.worst_trade.pair + ' ' + fmtPct(s.worst_trade.return_pct)) : '‚Äî';
        html += '<tr>'
             + '<td>#' + r.rank + '</td>'
             + '<td style="font-size:0.75rem;">' + p.label + '</td>'
             + '<td>' + s.total_trades + '</td>'
             + '<td>' + s.win_rate + '%</td>'
             + '<td class="negative"><strong>' + fmtPct(s.total_return_pct) + '</strong></td>'
             + '<td>$' + fmtNum(s.final_value) + '</td>'
             + '<td class="negative">' + fmtPct(-s.max_drawdown_pct) + '</td>'
             + '<td style="font-size:0.75rem;color:var(--red);">' + worstTrade + '</td>'
             + '</tr>';
    }
    tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center;">No results</td></tr>';
}

var optSortDir = {};
function sortOptTable(colIdx) {
    var table = document.getElementById('optimalTable');
    var tbody = table.querySelector('tbody');
    var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
    var dir = optSortDir[colIdx] === 'asc' ? 'desc' : 'asc';
    optSortDir[colIdx] = dir;
    rows.sort(function(a, b) {
        var aVal = a.cells[colIdx].textContent.replace(/[$%+,#üèÜ]/g, '').trim();
        var bVal = b.cells[colIdx].textContent.replace(/[$%+,#üèÜ]/g, '').trim();
        var aNum = parseFloat(aVal);
        var bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) return dir === 'asc' ? aNum - bNum : bNum - aNum;
        return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });
    for (var i = 0; i < rows.length; i++) tbody.appendChild(rows[i]);
}

// Populate optimal strategy filter dropdown with loaded strategies
function populateOptStrategyFilter() {
    var sel = document.getElementById('optStrategyFilter');
    if (!sel || !allStrategies) return;
    // Keep existing "All Strategies" option, add rest
    for (var i = 0; i < allStrategies.length; i++) {
        var s = allStrategies[i];
        var opt = document.createElement('option');
        opt.value = s.name;
        opt.textContent = s.name + ' (' + (s.signal_count || 0) + ' signals)';
        sel.appendChild(opt);
    }
}
</script>
<script src="/findstocks/portfolio2/stock-nav.js"></script>
<script src="/live-monitor/api/scope_labels.js"></script>
</body>
</html>
