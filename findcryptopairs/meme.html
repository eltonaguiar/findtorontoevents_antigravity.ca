<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meme Coin Scanner | Quick Profit Plays</title>
<style>
:root{--bg:#0a0a1a;--card:#12122a;--border:#2a2a4a;--text:#e0e0f0;--dim:#8888aa;--green:#22c55e;--red:#ef4444;--gold:#f59e0b;--accent:#e879f9;--cyan:#06b6d4;--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:#c4b5fd;text-decoration:none}a:hover{text-decoration:underline}
.header{text-align:center;padding:40px 20px 24px;border-bottom:1px solid rgba(255,255,255,0.06)}
.header h1{font-size:28px;font-weight:200;letter-spacing:4px;text-transform:uppercase;color:#fff}
.header .sub{color:var(--dim);font-size:13px;margin-top:6px}
.nav{display:flex;gap:8px;justify-content:center;padding:16px;flex-wrap:wrap}
.nav a{font-size:12px;padding:4px 14px;border-radius:20px;border:1px solid var(--border);color:var(--dim);transition:all 0.15s}
.nav a:hover,.nav a.active{border-color:var(--accent);color:var(--accent);text-decoration:none;background:rgba(232,121,249,0.08)}
.container{max-width:1200px;margin:0 auto;padding:20px}
.warning-bar{background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius);padding:12px 16px;margin-bottom:20px;display:flex;align-items:center;gap:10px;font-size:12px;color:#fca5a5}
.warning-bar strong{color:var(--red)}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center}
.stat-card .label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
.stat-card .value{font-size:24px;font-weight:700;margin-top:4px}
.stat-card .sub{font-size:11px;color:var(--dim);margin-top:2px}
.green{color:var(--green)}.red{color:var(--red)}.gold{color:var(--gold)}.cyan{color:var(--cyan)}.accent{color:var(--accent)}
.section-title{font-size:18px;font-weight:600;margin:24px 0 12px;display:flex;align-items:center;gap:8px}
.badge{font-size:10px;padding:2px 8px;border-radius:4px;text-transform:uppercase;font-weight:700;letter-spacing:1px}
.badge-strong{background:rgba(232,121,249,0.2);color:var(--accent);border:1px solid rgba(232,121,249,0.4)}
.badge-buy{background:rgba(168,85,247,0.15);color:#c084fc;border:1px solid rgba(168,85,247,0.3)}
.badge-lean{background:rgba(234,179,8,0.15);color:var(--gold);border:1px solid rgba(234,179,8,0.3)}
.badge-tier1{background:rgba(96,165,250,0.12);color:#93c5fd;border:1px solid rgba(96,165,250,0.25);font-size:9px;padding:1px 6px}
.badge-tier2{background:rgba(52,211,153,0.12);color:#6ee7b7;border:1px solid rgba(52,211,153,0.25);font-size:9px;padding:1px 6px}
.winner-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;transition:all 0.2s;position:relative}
.winner-card:hover{border-color:var(--accent);box-shadow:0 4px 20px rgba(232,121,249,0.1);transform:translateY(-2px)}
.winner-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--cyan));opacity:0;transition:opacity 0.2s;border-radius:var(--radius) var(--radius) 0 0}
.winner-card:hover::before{opacity:1}
.winner-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
.winner-pair{font-size:18px;font-weight:700;color:#fff}
.winner-score{font-size:28px;font-weight:800}
.winner-meta{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;font-size:12px;color:var(--dim)}
.winner-meta span{display:flex;align-items:center;gap:4px}
.factors{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:12px}
.factor{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);border-radius:8px;padding:8px 10px;font-size:11px}
.factor-name{color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;font-size:10px}
.factor-bar{height:4px;background:rgba(255,255,255,0.06);border-radius:2px;margin-top:4px;overflow:hidden}
.factor-fill{height:100%;border-radius:2px;transition:width 0.5s}
.history-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:12px}
.history-table th{text-align:left;padding:8px;color:var(--dim);border-bottom:1px solid var(--border);font-size:11px;text-transform:uppercase;letter-spacing:1px}
.history-table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
.outcome-win{color:var(--green);font-weight:700}
.outcome-loss{color:var(--red);font-weight:700}
.outcome-pending{color:var(--dim)}
.loading{text-align:center;padding:40px;color:var(--dim)}
.disclaimer{font-size:11px;color:#555;margin-top:32px;padding:12px;border:1px solid rgba(255,255,255,0.04);border-radius:8px;line-height:1.6}
.info-tip{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:rgba(232,121,249,0.2);color:var(--accent);font-size:10px;font-weight:700;cursor:help;position:relative;vertical-align:middle;margin-left:4px;flex-shrink:0;font-style:normal}
.info-tip:hover{background:rgba(232,121,249,0.4)}
.info-tip .tip-text{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e1e3a;border:1px solid var(--accent);border-radius:8px;padding:10px 12px;font-size:12px;font-weight:400;color:var(--text);width:260px;line-height:1.5;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,0.5);pointer-events:none}
.info-tip:hover .tip-text{display:block}
.info-tip .tip-text::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:var(--accent)}
.edu-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-top:24px;overflow:hidden}
.edu-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;cursor:pointer;user-select:none}
.edu-header:hover{background:rgba(255,255,255,0.02)}
.edu-header h3{font-size:16px;font-weight:600;margin:0;display:flex;align-items:center;gap:8px}
.edu-arrow{font-size:12px;color:var(--dim);transition:transform 0.2s}
.edu-arrow.open{transform:rotate(180deg)}
.edu-body{padding:0 20px 20px;display:none}
.edu-body.open{display:block}
.glossary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;margin-top:8px}
.glossary-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:14px}
.glossary-card .g-term{font-weight:700;color:#fff;font-size:13px;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.glossary-card .g-term .g-pts{font-size:11px;color:var(--accent);font-weight:400}
.glossary-card .g-desc{font-size:12px;color:#bbb;line-height:1.6}
.glossary-card .g-why{font-size:11px;color:var(--dim);margin-top:6px;font-style:italic}
.tier-explain{display:flex;gap:12px;margin:12px 0;flex-wrap:wrap}
.tier-card{flex:1;min-width:180px;padding:14px;border-radius:8px;text-align:center}
.tier-card.strong{background:rgba(232,121,249,0.08);border:1px solid rgba(232,121,249,0.2)}
.tier-card.buy{background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.2)}
.tier-card.lean{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2)}
.tier-card .t-label{font-size:18px;font-weight:700;margin-bottom:4px}
.tier-card .t-range{font-size:12px;color:var(--dim);margin-bottom:8px}
.tier-card .t-desc{font-size:12px;line-height:1.5}
.tier-card.strong .t-label{color:var(--accent)}
.tier-card.buy .t-label{color:#c084fc}
.tier-card.lean .t-label{color:var(--gold)}
.method-step{display:flex;gap:12px;margin:12px 0;align-items:flex-start}
.method-num{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}
.method-text{font-size:13px;line-height:1.6;color:#ccc}
.method-text strong{color:#fff}
.flaw-item{display:flex;gap:8px;margin:8px 0;font-size:12px;line-height:1.5;color:#ccc}
.flaw-icon{font-size:14px;flex-shrink:0;margin-top:1px}
.scan-log-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.scan-select{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:12px;cursor:pointer}
.scan-select:focus{outline:none;border-color:var(--accent)}
.scan-meta{font-size:11px;color:var(--dim)}
.scan-log-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:8px}
.scan-log-table th{text-align:center;padding:6px 4px;color:var(--dim);border-bottom:1px solid var(--border);font-size:10px;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap}
.scan-log-table th:first-child,.scan-log-table th:nth-child(2),.scan-log-table th:nth-child(3){text-align:left}
.scan-log-table td{padding:6px 4px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center;white-space:nowrap}
.scan-log-table td:first-child,.scan-log-table td:nth-child(2),.scan-log-table td:nth-child(3){text-align:left}
.scan-log-table tr:hover{background:rgba(255,255,255,0.02)}
.scan-log-table tr.is-winner{background:rgba(232,121,249,0.04)}
.factor-cell{display:inline-flex;align-items:center;justify-content:center;min-width:36px;padding:2px 5px;border-radius:4px;font-size:10px;font-weight:600}
.factor-cell.f-high{background:rgba(34,197,94,0.15);color:var(--green)}
.factor-cell.f-mid{background:rgba(245,158,11,0.15);color:var(--gold)}
.factor-cell.f-low{background:rgba(239,68,68,0.12);color:var(--red)}
.verdict-skip{color:var(--dim);font-size:10px}
/* Main page tabs */
.main-tabs{display:flex;gap:0;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:20px}
.main-tab-btn{flex:1;background:var(--card);color:var(--dim);border:none;padding:12px 20px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.15s;text-align:center}
.main-tab-btn:not(:last-child){border-right:1px solid var(--border)}
.main-tab-btn.active{background:var(--accent);color:#fff}
.main-tab-btn:hover:not(.active){background:rgba(255,255,255,0.04);color:var(--text)}
.main-panel{display:none}
.main-panel.active{display:block}
/* Perf period tabs */
.tab-row{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap}
.tab-btn{font-size:12px;padding:6px 16px;border-radius:20px;border:1px solid var(--border);color:var(--dim);background:transparent;cursor:pointer;transition:all 0.15s}
.tab-btn:hover,.tab-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(232,121,249,0.08)}
/* Performance grid */
.perf-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.perf-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.perf-card .p-label{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
.perf-card .p-val{font-size:20px;font-weight:700;margin-top:2px}
.perf-card .p-sub{font-size:10px;color:var(--dim);margin-top:2px}
/* Daily table */
.daily-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
.daily-table th{text-align:left;padding:6px 8px;color:var(--dim);border-bottom:1px solid var(--border);font-size:10px;text-transform:uppercase}
.daily-table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.03)}
.daily-table tr:hover{background:rgba(255,255,255,0.02)}
/* Picks date controls */
.picks-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.picks-date-label{font-size:13px;color:var(--dim)}
.picks-summary{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--dim);margin-bottom:8px}
.picks-summary span{display:flex;align-items:center;gap:4px}
/* Freshness badges */
.freshness-bar{display:flex;align-items:center;gap:10px;padding:10px 16px;margin-bottom:12px;border-radius:var(--radius);font-size:12px;border:1px solid var(--border);background:var(--card)}
.freshness-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;animation:pulse 2s infinite}
.freshness-fresh .freshness-dot{background:#22c55e;box-shadow:0 0 6px rgba(34,197,94,0.5)}
.freshness-aging .freshness-dot{background:#f59e0b;box-shadow:0 0 6px rgba(245,158,11,0.5)}
.freshness-stale .freshness-dot{background:#ef4444;box-shadow:0 0 6px rgba(239,68,68,0.5)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.signal-age-badge{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600;letter-spacing:0.5px}
.age-fresh{background:rgba(34,197,94,0.15);color:#22c55e;border:1px solid rgba(34,197,94,0.3)}
.age-aging{background:rgba(245,158,11,0.15);color:#f59e0b;border:1px solid rgba(245,158,11,0.3)}
.age-stale{background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
.winner-card.stale-card{opacity:0.55;border-color:rgba(239,68,68,0.3)}
.winner-card.stale-card:hover{opacity:0.8}
.stale-overlay{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:6px;padding:6px 10px;margin:8px 0;font-size:11px;color:#fca5a5;text-align:center}
.winner-card.card-invalidated{opacity:0.35;border-color:rgba(239,68,68,0.4);pointer-events:auto;position:relative;transition:all 0.3s}
.hide-invalidated .winner-card.card-invalidated{display:none}
.winner-card.card-invalidated:hover{opacity:0.55}
.winner-card.card-invalidated .winner-pair{text-decoration:line-through;color:#888}
.winner-card.card-invalidated .winner-score{text-decoration:line-through;opacity:0.5}
.winner-card.card-invalidated .buy-now-badge{display:none}
.winner-card.card-caution{border-color:rgba(245,158,11,0.5);box-shadow:inset 0 0 20px rgba(245,158,11,0.05)}
.winner-card.card-valid{border-color:rgba(34,197,94,0.4);box-shadow:inset 0 0 20px rgba(34,197,94,0.05)}
.live-verdict-banner{padding:8px 12px;border-radius:6px;margin:0 0 8px 0;font-size:12px;font-weight:600;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.live-verdict-banner.v-invalidated{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#fca5a5}
.live-verdict-banner.v-caution{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:#fcd34d}
.live-verdict-banner.v-valid{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:#86efac}
.live-verdict-banner .v-price{font-weight:400;font-size:11px;color:var(--dim)}
#auto-verify-summary{margin-bottom:12px;transition:all 0.3s}
.no-viable-banner{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);border-radius:12px;padding:20px;text-align:center;margin-bottom:16px}
.no-viable-banner h3{color:#fca5a5;margin:0 0 8px 0;font-size:16px}
.no-viable-banner p{color:var(--dim);margin:0;font-size:13px;line-height:1.6}
.some-viable-banner{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.25);border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:13px}
.some-viable-banner .viable-count{background:rgba(34,197,94,0.2);color:#86efac;padding:3px 10px;border-radius:6px;font-weight:800;font-size:12px;border:1px solid rgba(34,197,94,0.3)}
/* BUY NOW badge & ranking */
.buy-now-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,rgba(232,121,249,0.25),rgba(6,182,212,0.25));color:#fff;font-size:11px;font-weight:700;padding:4px 12px;border-radius:6px;border:1px solid rgba(232,121,249,0.4);cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.5px}
.buy-now-badge:hover{background:linear-gradient(135deg,rgba(232,121,249,0.4),rgba(6,182,212,0.4));transform:scale(1.05);box-shadow:0 2px 12px rgba(232,121,249,0.3)}
.buy-now-rank{font-size:10px;color:var(--dim);margin-left:6px}
.buy-now-rank .rank-val{font-weight:700;font-size:13px}
/* Verify modal */
.verify-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;padding:20px}
.verify-overlay.active{display:flex}
.verify-modal{background:#12122a;border:1px solid var(--accent);border-radius:16px;max-width:520px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 8px 40px rgba(232,121,249,0.2)}
.verify-modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border)}
.verify-modal-header h3{font-size:16px;color:#fff;margin:0}
.verify-close{background:none;border:none;color:var(--dim);font-size:20px;cursor:pointer;padding:4px 8px;border-radius:4px}
.verify-close:hover{color:#fff;background:rgba(255,255,255,0.1)}
.verify-body{padding:20px}
.verify-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px}
.verify-row .vr-label{color:var(--dim)}
.verify-row .vr-value{font-weight:600;color:#fff}
.verify-verdict{text-align:center;padding:16px;border-radius:10px;margin:16px 0;font-size:15px;font-weight:700}
.verdict-green{background:rgba(34,197,94,0.12);color:#22c55e;border:1px solid rgba(34,197,94,0.3)}
.verdict-yellow{background:rgba(245,158,11,0.12);color:#f59e0b;border:1px solid rgba(245,158,11,0.3)}
.verdict-red{background:rgba(239,68,68,0.12);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
.verify-manual{margin-top:16px;padding:12px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px}
.verify-manual label{font-size:12px;color:var(--dim);display:block;margin-bottom:6px}
.verify-manual input{width:100%;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:#fff;font-size:14px}
.verify-manual input:focus{outline:none;border-color:var(--accent)}
.verify-manual .vm-btn{display:inline-block;margin-top:8px;padding:6px 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600}
.verify-manual .vm-btn:hover{opacity:0.85}
/* Live mode toggle */
.live-mode-bar{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.live-toggle{position:relative;width:44px;height:24px;background:rgba(255,255,255,0.1);border-radius:12px;cursor:pointer;transition:all 0.3s;border:1px solid var(--border)}
.live-toggle.active{background:rgba(34,197,94,0.3);border-color:rgba(34,197,94,0.5)}
.live-toggle .lt-dot{position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:transform 0.3s}
.live-toggle.active .lt-dot{transform:translateX(20px)}
.live-label{font-size:12px;color:var(--dim)}
.live-label.active{color:var(--green)}
.live-pulse{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);margin-right:4px;animation:pulse 1s infinite}
@media(max-width:600px){.header h1{font-size:20px}.stats-row{grid-template-columns:repeat(2,1fr)}.factors{grid-template-columns:1fr}.glossary-grid{grid-template-columns:1fr}.tier-explain{flex-direction:column}.info-tip .tip-text{width:200px;left:0;transform:none}.verify-modal{margin:10px}}
</style>
</head>
<body>
<div class="header">
  <h1>Meme Coin Scanner</h1>
  <div class="sub">Short-term momentum plays on meme coins &mdash; DOGE, SHIB, PEPE, FLOKI &amp; emerging pumps</div>
</div>
<div class="nav">
  <a href="/findcryptopairs/winners.html">Crypto Scanner</a>
  <a href="/findcryptopairs/portfolio/">Crypto Portfolio</a>
  <a href="/live-monitor/live-monitor.html">Live Monitor</a>
  <a href="/investments/">Investment Hub</a>
  <a href="/updates/">Changelog</a>
  <a href="/">&larr; Home</a>
</div>
<div class="container">
  <!-- Honest performance status banner -->
  <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius);padding:12px 16px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:12px;">
    <span style="background:rgba(239,68,68,0.15);color:#ef4444;padding:3px 10px;border-radius:6px;font-weight:800;font-size:11px;border:1px solid rgba(239,68,68,0.3);letter-spacing:0.5px;">BEST MEME</span>
    <span style="color:#fca5a5;">Forward-facing results: <strong style="color:#ef4444;">5% WR</strong> (1 win / 19 losses, 20 resolved). This scanner is currently underperforming. Data is honest and unfiltered.</span>
  </div>

  <!-- v2 Improvement Banner -->
  <div style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.3);border-radius:var(--radius);padding:12px 16px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:12px;">
    <span style="background:rgba(34,197,94,0.15);color:#22c55e;padding:3px 10px;border-radius:6px;font-weight:800;font-size:11px;border:1px solid rgba(34,197,94,0.3);letter-spacing:0.5px;">v2 IMPROVED</span>
    <span style="color:#86efac;"><strong>Algorithm updated Feb 12, 2026:</strong> Added quality gates (EMA trend + momentum + volume), stricter thresholds (72/78/85), bear market penalty (-10pts). Goal: 5% &rarr; 40%+ win rate. <a href="#" onclick="switchMainTab('analysis');return false;" style="color:#22c55e;text-decoration:underline;">See details &rarr;</a></span>
  </div>

  <div class="warning-bar">
    <strong>&#9888; HIGH VOLATILITY:</strong>
    <span>Meme coins can drop 30-80% in hours. This scanner finds short-term momentum patterns &mdash; NOT safe long-term investments. Wider targets &amp; stops reflect extreme volatility. Never risk money you can't lose.</span>
  </div>

  <!-- QUICK FIX PLAN BANNER -->
  <div style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.3);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:12px;">
    <span style="background:rgba(34,197,94,0.15);color:#22c55e;padding:3px 10px;border-radius:6px;font-weight:800;font-size:11px;border:1px solid rgba(34,197,94,0.3);letter-spacing:0.5px;">NEW</span>
    <span style="color:#86efac;"><strong>Take Profit & Stop Loss prices now shown!</strong> Exact exit prices are calculated from entry. Quick-fix improvements in progress. <a href="#quick-fixes" style="color:#22c55e;text-decoration:underline;">See the plan &rarr;</a></span>
  </div>

  <!-- Main page tabs -->
  <div class="main-tabs">
    <button class="main-tab-btn active" onclick="switchMainTab('scanner')">Scanner</button>
    <button class="main-tab-btn" onclick="switchMainTab('analysis')" style="color:#f59e0b;">System Analysis</button>
    <button class="main-tab-btn" onclick="switchMainTab('research')" style="color:#a855f7;">Research &amp; Future</button>
  </div>

  <!-- TAB 1: SCANNER (all existing content) -->
  <div class="main-panel active" id="main-scanner">

  <div class="stats-row" id="stats-row">
    <div class="stat-card"><div class="label">Win Rate</div><div class="value" id="s-wr">--</div><div class="sub">Resolved signals</div></div>
    <div class="stat-card"><div class="label">Avg P&amp;L</div><div class="value" id="s-pnl">--</div><div class="sub">Per signal</div></div>
    <div class="stat-card"><div class="label">Total Signals</div><div class="value" id="s-total">--</div><div class="sub" id="s-resolved">--</div></div>
    <div class="stat-card"><div class="label">Best Trade</div><div class="value green" id="s-best">--</div><div class="sub" id="s-worst">--</div></div>
    <div class="stat-card"><div class="label">Active Memes</div><div class="value accent" id="s-pairs">--</div><div class="sub" id="s-scans">--</div></div>
    <div class="stat-card"><div class="label">Last Scan</div><div class="value" id="s-last" style="font-size:14px">--</div><div class="sub" id="s-first">--</div></div>
  </div>

  <!-- Data Freshness Bar -->
  <div class="freshness-bar freshness-stale" id="freshness-bar">
    <span class="freshness-dot"></span>
    <span id="freshness-text">Checking data freshness...</span>
    <span id="freshness-time" style="margin-left:auto;font-size:11px;color:var(--dim)"></span>
  </div>

  <!-- BTC Market Regime Indicator -->
  <div id="btc-regime-bar" style="display:none;padding:8px 16px;margin-bottom:12px;border-radius:var(--radius);font-size:12px;border:1px solid var(--border);background:var(--card);display:flex;align-items:center;gap:10px;flex-wrap:wrap"></div>

  <!-- Live Mode + BUY NOW Controls -->
  <div class="live-mode-bar">
    <div class="live-toggle active" id="hide-invalid-toggle" onclick="toggleHideInvalidated()">
      <div class="lt-dot"></div>
    </div>
    <span class="live-label active" id="hide-invalid-label">Hide Invalidated: ON</span>
    <span style="margin:0 8px;color:rgba(255,255,255,0.1)">|</span>
    <div class="live-toggle" id="live-toggle" onclick="toggleLiveMode()">
      <div class="lt-dot"></div>
    </div>
    <span class="live-label" id="live-label">Live Price Updates: OFF</span>
    <span style="margin-left:auto;font-size:11px;color:var(--dim)" id="live-status"></span>
  </div>

  <div class="section-title">Current Meme Winners <span class="badge badge-strong" id="winner-count">loading...</span>
    <span style="font-size:11px;color:var(--dim);font-weight:400;margin-left:8px" id="sort-label">(sorted by BUY NOW rank)</span>
  </div>
  <div id="auto-verify-summary"></div>
  <div id="winners-list"><div class="loading">Loading winners...</div></div>

  <!-- Price Verification Modal -->
  <div class="verify-overlay" id="verify-overlay" onclick="if(event.target===this)closeVerifyModal()">
    <div class="verify-modal">
      <div class="verify-modal-header">
        <h3 id="verify-title">Verify Signal</h3>
        <button class="verify-close" onclick="closeVerifyModal()">&times;</button>
      </div>
      <div class="verify-body" id="verify-body">
        <div class="loading">Fetching live price...</div>
      </div>
    </div>
  </div>

  <div class="section-title" style="margin-top:32px">Win Rate by Confidence Tier</div>
  <div id="tier-table"></div>

  <div class="section-title" style="margin-top:32px">Tier 1 vs Tier 2 Comparison <i class="info-tip">i<span class="tip-text">Tier 1 = established memes (DOGE, SHIB, etc). Tier 2 = newly discovered pumping coins with meme keywords or extreme volume.</span></i></div>
  <div id="tier-comparison"></div>

  <div class="section-title" style="margin-top:32px">Recent Signal History</div>
  <div id="history-list"><div class="loading">Loading history...</div></div>

  <div class="section-title" style="margin-top:32px">Full Scan Log &mdash; All Analyzed Meme Coins <i class="info-tip">i<span class="tip-text">Every meme coin that was deeply analyzed in a scan, including those that didn't make the 70-point threshold. Shows all 7 meme-specific indicator scores.</span></i></div>
  <div class="scan-log-controls">
    <select class="scan-select" id="scan-picker" onchange="loadScanLog(this.value)"><option value="">Loading scans...</option></select>
    <span class="scan-meta" id="scan-meta"></span>
  </div>
  <div id="scan-log-list"><div class="loading">Loading scan log...</div></div>

  <!-- DAILY PICKS -->
  <div class="section-title" style="margin-top:32px">Daily Picks <i class="info-tip">i<span class="tip-text">All algorithmic picks for a specific date, with timestamps and outcomes. Use the date picker to browse historical picks.</span></i></div>
  <div class="picks-controls">
    <select class="scan-select" id="picks-date" onchange="loadDailyPicks(this.value)"><option value="">Loading dates...</option></select>
    <span class="picks-date-label" id="picks-date-label"></span>
  </div>
  <div class="picks-summary" id="picks-summary"></div>
  <div id="daily-picks-list"><div class="loading">Loading daily picks...</div></div>

  <!-- PERFORMANCE TRACKER -->
  <div class="section-title" style="margin-top:32px">Performance Tracker <i class="info-tip">i<span class="tip-text">Track the scanner's performance over time. Shows daily P&amp;L, win rates, equity curve, streaks, and top-performing coins.</span></i></div>
  <div class="tab-row" id="perf-tabs">
    <button class="tab-btn active" onclick="loadPerf('all',this)">All Time</button>
    <button class="tab-btn" onclick="loadPerf('30d',this)">30 Days</button>
    <button class="tab-btn" onclick="loadPerf('7d',this)">7 Days</button>
    <button class="tab-btn" onclick="loadPerf('today',this)">Today</button>
  </div>
  <div class="perf-grid" id="perf-summary"></div>
  <div class="section-title" style="font-size:14px;margin-top:16px">Daily Breakdown</div>
  <div id="perf-daily"><div class="loading">Loading performance data...</div></div>
  <div class="section-title" style="font-size:14px;margin-top:16px">Top Performing Coins</div>
  <div id="perf-top-coins"><div class="loading">Loading...</div></div>

  <!-- CONFIDENCE TIERS -->
  <div class="edu-section">
    <div class="edu-header" onclick="toggleEdu(this)">
      <h3>Understanding Meme Confidence Tiers <span class="badge" style="background:rgba(34,197,94,0.15);color:#22c55e;border:1px solid rgba(34,197,94,0.3);font-size:9px;padding:2px 6px;">IMPROVED v2</span></h3>
      <span class="edu-arrow">&#9660;</span>
    </div>
    <div class="edu-body">
      <p style="font-size:13px;color:#bbb;margin-bottom:12px">Each meme coin is scored 0-100 across 7 meme-specific indicators. <strong style="color:#22c55e;">New in v2:</strong> Quality gates now require price above EMA, positive momentum on both timeframes, AND increasing volume. Stricter thresholds = fewer false signals.</p>
      
      <!-- Quality Gates Summary -->
      <div style="background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;">
        <div style="font-size:12px;font-weight:600;color:#fff;margin-bottom:8px;">Quality Gates (Must pass 2 of 3)</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;font-size:11px;color:var(--dim);">
          <div>&#10004; <strong style="color:var(--green);">Trend Confirm:</strong> Price above 1h EMA</div>
          <div>&#10004; <strong style="color:var(--green);">Momentum Gate:</strong> Both 15m & 5m positive</div>
          <div>&#10004; <strong style="color:var(--green);">Volume Gate:</strong> Volume increasing 20%+</div>
        </div>
      </div>
      
      <div class="tier-explain">
        <div class="tier-card strong">
          <div class="t-label">Strong Buy</div>
          <div class="t-range">Score 85-100 + Quality 2/3</div>
          <div class="t-desc">6-7 indicators firing + quality gates passed. <strong style="color:var(--accent)">Target: +4-12%</strong> (reduced). Risk: -2-4% (tighter). Maximum conviction with trend confirmation.</div>
        </div>
        <div class="tier-card buy">
          <div class="t-label">Buy</div>
          <div class="t-range">Score 78-84 + Quality 2/3</div>
          <div class="t-desc">5-6 indicators bullish + quality gates passed. <strong style="color:#c084fc">Target: +3-8%</strong> (reduced). Risk: -2-3.5% (tighter). Raised threshold from 75 for better accuracy.</div>
        </div>
        <div class="tier-card lean">
          <div class="t-label">Lean Buy</div>
          <div class="t-range">Score 72-77 + Quality 2/3</div>
          <div class="t-desc">4-5 indicators bullish + quality gates passed. <strong style="color:var(--gold)">Target: +2-5%</strong> (reduced). Risk: -1.5-2.5% (tighter). Raised threshold from 70.</div>
        </div>
      </div>
      <p style="font-size:12px;color:var(--dim);margin-top:8px"><strong>Tier 2 Emerging:</strong> Now requires 80+ score minimum (extra scrutiny). Bear market: -10pt penalty to all scores. <strong>Goal:</strong> Improve 5% win rate to 40%+ by filtering weak signals.</p>
    </div>
  </div>

  <!-- GLOSSARY OF MEME INDICATORS -->
  <div class="edu-section">
    <div class="edu-header" onclick="toggleEdu(this)">
      <h3>Meme Coin Indicators Explained <i class="info-tip">i<span class="tip-text">These 7 factors are specifically tuned for meme coin behavior &mdash; different from the general crypto scanner.</span></i></h3>
      <span class="edu-arrow">&#9660;</span>
    </div>
    <div class="edu-body">
      <div class="glossary-grid">
        <div class="glossary-card">
          <div class="g-term">Explosive Volume <span class="g-pts">0-25 pts</span></div>
          <div class="g-desc"><strong>What it measures:</strong> How much the current trading volume exceeds the average. Volume is king for memes &mdash; pumps live and die by volume surges.<br><strong>How it scores:</strong> 3x average=+12, 5x=+18, 10x+=25 (maximum). Below 1.5x gets 0.</div>
          <div class="g-why">Why it matters: Meme pumps are volume-driven events. When volume explodes 5-10x above normal, it signals a wave of retail buying that can push prices sharply higher in minutes.</div>
        </div>
        <div class="glossary-card">
          <div class="g-term">Parabolic Momentum <span class="g-pts">0-20 pts</span></div>
          <div class="g-desc"><strong>What it measures:</strong> Steep price acceleration on both 15-minute and 5-minute charts. Memes don't go up slowly &mdash; they go parabolic or they die.<br><strong>How it scores:</strong> +8 if both timeframes are positive. +6 more for 3%+ on 15m. +6 more for 2%+ on 5m. Capped at 20.</div>
          <div class="g-why">Why it matters: Meme coins accelerate rapidly. If a meme is moving up fast on both short and ultra-short timeframes, the pump has real momentum behind it.</div>
        </div>
        <div class="glossary-card">
          <div class="g-term">RSI Hype Zone <span class="g-pts">0-15 pts</span></div>
          <div class="g-desc"><strong>What it measures:</strong> RSI between 55-80 is the meme "hype zone." Unlike traditional assets, memes routinely sustain RSI above 70 during pumps. Only RSI 90+ is a clear top.<br><strong>How it scores:</strong> 15 pts for 55-80 (hype zone), 8 for 45-55, 5 for 80-90 (very hot), 3 for 35-45.</div>
          <div class="g-why">Why it matters: Traditional analysis says "RSI 70+ is overbought, sell." Memes break this rule &mdash; they can stay "overbought" for hours during pumps. We adjusted the sweet spot upward.</div>
        </div>
        <div class="glossary-card">
          <div class="g-term">Social Momentum Proxy <span class="g-pts">0-15 pts</span></div>
          <div class="g-desc"><strong>What it measures:</strong> A proxy for social media buzz, calculated as price_change_1h multiplied by volume_surge_ratio. When both are high, it signals viral attention.<br><strong>How it scores:</strong> Velocity 20+=15pts, 10+=12pts, 5+=8pts, 2+=5pts. Below 1 gets 0.</div>
          <div class="g-why">Why it matters: Meme coins are social-media driven. We can't read Twitter, but we CAN detect its effect: rapid price + volume surges = something went viral.</div>
        </div>
        <div class="glossary-card">
          <div class="g-term">Volume Concentration <span class="g-pts">0-10 pts</span></div>
          <div class="g-desc"><strong>What it measures:</strong> What percentage of the last 3 hours of volume happened in the last 45 minutes? A "burst" pattern means the pump is just starting.<br><strong>How it scores:</strong> 60%+ in last 3 candles=10pts, 45%+=7pts, 35%+=4pts, 28%+=2pts.</div>
          <div class="g-why">Why it matters: Even distribution of volume = steady market. Concentrated burst in recent candles = pump is accelerating NOW, not winding down.</div>
        </div>
        <div class="glossary-card">
          <div class="g-term">Breakout vs 4h High <span class="g-pts">0-10 pts</span></div>
          <div class="g-desc"><strong>What it measures:</strong> Is the current price breaking above its 4-hour high? Breakouts above recent resistance often trigger additional buying momentum.<br><strong>How it scores:</strong> 2%+ above 4h high=10pts, 0.5%+=7pts, at the high=4pts, within 1%=2pts.</div>
          <div class="g-why">Why it matters: Breaking above a recent high is a classic technical trigger. For memes, it often causes FOMO buying that accelerates the move further.</div>
        </div>
        <div class="glossary-card">
          <div class="g-term">Low Market Cap Bonus <span class="g-pts">0-5 pts</span></div>
          <div class="g-desc"><strong>What it measures:</strong> Smaller coins (by 24h volume) have more explosive potential. A $500K volume coin can 3x easier than a $500M one.<br><strong>How it scores:</strong> Under $1M vol=5pts, under $5M=3pts, under $20M=1pt. Larger coins get 0.</div>
          <div class="g-why">Why it matters: Small caps move bigger on less capital. This is also the riskiest factor &mdash; small caps are more likely to rug pull or dump catastrophically.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- TIER 1 VS TIER 2 EXPLAINED -->
  <div class="edu-section">
    <div class="edu-header" onclick="toggleEdu(this)">
      <h3>Tier 1 vs Tier 2 Memes <i class="info-tip">i<span class="tip-text">Why we separate established memes from newly discovered ones.</span></i></h3>
      <span class="edu-arrow">&#9660;</span>
    </div>
    <div class="edu-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div style="background:rgba(96,165,250,0.06);border:1px solid rgba(96,165,250,0.15);border-radius:8px;padding:14px">
          <div style="font-size:13px;font-weight:700;color:#93c5fd;margin-bottom:8px">Tier 1 &mdash; Established Memes</div>
          <ul style="font-size:12px;color:#ccc;line-height:1.8;padding-left:16px">
            <li><strong>DOGE, SHIB, PEPE, FLOKI, BONK, WIF, MEME</strong></li>
            <li>Always scanned regardless of 24h change</li>
            <li>Higher liquidity = easier entry/exit</li>
            <li>Less likely to rug pull (but still volatile!)</li>
            <li>Lower threshold for inclusion ($50K+ daily volume)</li>
          </ul>
        </div>
        <div style="background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.15);border-radius:8px;padding:14px">
          <div style="font-size:13px;font-weight:700;color:#6ee7b7;margin-bottom:8px">Tier 2 &mdash; Emerging / Discovered</div>
          <ul style="font-size:12px;color:#ccc;line-height:1.8;padding-left:16px">
            <li>Dynamically discovered from 600+ USDT pairs</li>
            <li>Must have meme keyword OR extreme pump (+15%)</li>
            <li>Requires $100K+ daily volume for analysis</li>
            <li>Higher risk: unknown coins, possible rug pulls</li>
            <li>Higher reward potential: early entry on new pumps</li>
          </ul>
        </div>
      </div>
      <p style="font-size:12px;color:var(--dim);line-height:1.6"><strong>Key difference:</strong> Tier 1 memes are watched 24/7. Tier 2 memes are discovered in real-time when their price action matches meme pump patterns. Tier 2 signals are inherently riskier but can offer earlier entry.</p>
    </div>
  </div>

  <!-- KNOWN RISKS -->
  <div class="edu-section">
    <div class="edu-header" onclick="toggleEdu(this)">
      <h3>Known Risks &amp; Limitations <i class="info-tip">i<span class="tip-text">Meme coins carry unique risks beyond normal crypto. Read this before acting on any signal.</span></i></h3>
      <span class="edu-arrow">&#9660;</span>
    </div>
    <div class="edu-body">
      <div style="font-size:13px;font-weight:700;color:var(--red);margin:0 0 8px">Meme-Specific Dangers</div>
      <div class="flaw-item"><span class="flaw-icon">&#9888;</span><span><strong>Rug pulls.</strong> Developers can drain liquidity pools instantly, making your tokens worthless. More common in Tier 2 (unknown coins). There is NO technical indicator that can predict a rug pull.</span></div>
      <div class="flaw-item"><span class="flaw-icon">&#9888;</span><span><strong>Whale dumps.</strong> A single holder can own 20-40% of a meme coin. When they sell, the price crashes faster than any stop-loss can execute. Slippage on large dumps can be 50%+.</span></div>
      <div class="flaw-item"><span class="flaw-icon">&#9888;</span><span><strong>Pump &amp; dump schemes.</strong> Organized groups inflate prices via social media, then dump on retail buyers. This scanner might detect the pump but CANNOT distinguish organic hype from manipulation.</span></div>
      <div class="flaw-item"><span class="flaw-icon">&#9888;</span><span><strong>Exchange delistings.</strong> Meme coins can be delisted from exchanges without warning, making them untradeable. Any open position becomes worthless instantly.</span></div>
      <div class="flaw-item"><span class="flaw-icon">&#9888;</span><span><strong>No fundamentals.</strong> Meme coins have no revenue, no product, no earnings. Their value is 100% speculative and sentiment-driven. Sentiment can flip from euphoria to panic in minutes.</span></div>
      <div class="flaw-item"><span class="flaw-icon">&#9888;</span><span><strong>2-hour window is still slow.</strong> Meme pumps can start AND end in 15 minutes. Our 2-hour resolve window captures multi-hour moves but may miss rapid pump-and-dumps.</span></div>

      <div style="font-size:13px;font-weight:700;color:var(--gold);margin:20px 0 8px">Scanner Limitations</div>
      <div class="flaw-item"><span class="flaw-icon" style="color:var(--gold)">&#9675;</span><span><strong>No social media data.</strong> We use a proxy (price velocity x volume) but can't read Twitter, Telegram, or Discord. The actual viral trigger is invisible to us.</span></div>
      <div class="flaw-item"><span class="flaw-icon" style="color:var(--gold)">&#9675;</span><span><strong>Single exchange.</strong> Prices on Crypto.com may differ from Binance, Uniswap, or other DEXs where meme coins often launch first.</span></div>
      <div class="flaw-item"><span class="flaw-icon" style="color:var(--gold)">&#9675;</span><span><strong>No on-chain analysis.</strong> We don't check tokenomics, holder distribution, locked liquidity, or smart contract audits. Always DYOR (Do Your Own Research).</span></div>
    </div>
  </div>

  <!-- PLAIN LANGUAGE WARNING -->
  <div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:10px;padding:16px;margin-top:24px;line-height:1.7">
    <div style="font-size:16px;font-weight:700;color:#ef4444;margin-bottom:8px">This Is NOT Financial Advice</div>
    <div style="font-size:13px;color:#ccc">
      <strong>What this page does:</strong> Every 10 minutes, our scanner checks established meme coins and discovers new pumping coins from 600+ pairs on Crypto.com Exchange. It scores them using 7 meme-specific indicators: explosive volume, parabolic momentum, RSI hype zone, social momentum proxy, volume concentration, breakout confirmation, and market cap bonus.<br><br>
      <strong>What makes this different from our general scanner:</strong> Wider targets (up to 15% vs 6%), shorter resolve window (2h vs 4h), RSI sweet spot shifted up (55-80 vs 50-70), and meme-specific factors like social velocity proxy. Meme coins behave differently from BTC/ETH &mdash; this scanner accounts for that.<br><br>
      <strong style="color:#ef4444">The hard truth:</strong> Even the best meme coin scanner in the world is essentially gambling with better odds. Meme coins have no intrinsic value &mdash; they go up because people BELIEVE they'll go up, and they crash when belief evaporates. Use this tool to identify momentum patterns, not as investment advice. <strong>Only use money you are 100% willing to lose completely.</strong>
    </div>
  </div>

  <div class="disclaimer" style="margin-top:12px">
    <strong>Data source:</strong> Crypto.com Exchange public API (real-time). Scanner runs every 10 minutes via GitHub Actions. Signals resolved after 2 hours with continuous candle walk.<br>
    <strong>Resolve method:</strong> Continuous &mdash; every 5-minute candle during the 2h window is checked. If target or stop was hit at ANY point, it's recorded accurately.<br>
    <strong>Not financial advice.</strong> For educational and entertainment purposes only. Past performance does not guarantee future results. Meme coins carry extreme risk of total loss.
  </div>

  </div><!-- end main-scanner panel -->

  <!-- ═══════════════════════════════════════════ -->
  <!-- TAB 2: SYSTEM ANALYSIS -->
  <!-- ═══════════════════════════════════════════ -->
  <div class="main-panel" id="main-analysis">
    <div class="section-title" style="color:#f59e0b;">System Analysis <span class="badge" style="background:rgba(245,158,11,0.15);color:#f59e0b;border:1px solid rgba(245,158,11,0.3);">DIAGNOSIS</span></div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-bottom:20px;">
      <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
        <h4 style="font-size:14px;color:var(--gold);margin-bottom:8px;">What This System Does <span style="font-size:9px;padding:2px 6px;background:rgba(34,197,94,0.15);color:#22c55e;border:1px solid rgba(34,197,94,0.3);border-radius:4px;">v2</span></h4>
        <div style="font-size:12px;color:var(--dim);line-height:1.7;">
          &bull; Scans 600+ Crypto.com Exchange USDT pairs every 10 minutes<br>
          &bull; Scores each meme coin 0&ndash;100 using 7 meme-specific indicators<br>
          &bull; <strong style="color:#22c55e;">NEW:</strong> Quality gates (trend confirm + momentum + volume)<br>
          &bull; <strong style="color:#22c55e;">NEW:</strong> Stricter thresholds (72/78/85 vs old 70/75/85)<br>
          &bull; <strong style="color:#22c55e;">NEW:</strong> Bear market penalty (-10pts when BTC in downtrend)<br>
          &bull; Automated momentum detection with daily/weekly/monthly views<br>
          &bull; Historical signal tracking with continuous 2-hour resolve<br>
          &bull; Covers 14+ established meme coins (Tier 1) plus emerging pumps (Tier 2)
        </div>
      </div>
      <div style="background:var(--card);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius);padding:16px;">
        <h4 style="font-size:14px;color:var(--red);margin-bottom:8px;">Critical Flaws</h4>
        <div style="font-size:12px;color:var(--dim);line-height:1.7;">
          &bull; <strong>ZERO fundamental analysis:</strong> Meme coins have no fundamentals to analyze<br>
          &bull; <strong>No social sentiment:</strong> Missing Reddit, Twitter/X, Telegram data<br>
          &bull; <strong>No whale wallet tracking:</strong> Cannot detect large holder movements<br>
          &bull; <strong>No rug-pull detection:</strong> Cannot identify scams or token exploits<br>
          &bull; <strong>No liquidity pool analysis:</strong> Cannot verify DEX liquidity depth<br>
          &bull; <strong>No smart contract audits:</strong> Cannot verify token contract safety<br>
          &bull; <strong>No market cap verification:</strong> Circulating supply data not validated
        </div>
      </div>
      <div style="background:var(--card);border:1px solid rgba(34,197,94,0.3);border-radius:var(--radius);padding:16px;">
        <h4 style="font-size:14px;color:var(--green);margin-bottom:8px;">What's Working</h4>
        <div style="font-size:12px;color:var(--dim);line-height:1.7;">
          &bull; Automated 24/7 scanning (every 10 minutes)<br>
          &bull; Momentum detection across multiple timeframes<br>
          &bull; Honest performance tracking (5% WR reported transparently)<br>
          &bull; Tier 1 vs Tier 2 separation for risk awareness<br>
          &bull; Continuous candle-walk resolve method (accurate outcome tracking)
        </div>
      </div>
    </div>

    <h4 style="font-size:15px;margin-bottom:10px;color:#f59e0b;">ML &amp; Learning Status</h4>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div style="font-size:12px;color:var(--dim);line-height:1.7;">
        <strong style="color:var(--gold);">ML capability: In progress.</strong> This system is currently rule-based momentum scanning with static indicator weights. Meme-specific ML integration is actively being built by other agents, including adaptive parameter tuning and pattern learning from past signals.<br><br>
        <strong style="color:var(--text);">Platform-wide ML deployed:</strong> The core trading platform now has <span style="color:#22c55e;">DEPLOYED</span> concept drift detection (<code>concept_drift_detector.py</code>), multi-timeframe regime analysis (<code>multi_timeframe_regime.py</code>), and online incremental learning (<code>online_meta_learner.py</code>). Meme-specific adaptation of these systems is in development.
      </div>
    </div>

    <h4 style="font-size:15px;margin-bottom:10px;color:#f59e0b;">Safety Assessment</h4>
    <div style="background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div style="font-size:12px;color:#fca5a5;line-height:1.7;">
        <strong style="color:var(--red);">ABSOLUTELY NOT SAFE for real trading.</strong> Meme coins are the highest-risk asset class in all of finance. Our scanner provides price data only &mdash; it cannot detect scams, rug pulls, or worthless tokens. The &gt;95% failure rate of meme coins means the vast majority of positions will lose money. Never invest money you cannot afford to lose entirely.
      </div>
    </div>

    <!-- QUICK FIX PLAN SECTION -->
    <h4 style="font-size:15px;margin-bottom:10px;color:#22c55e;"><a name="quick-fixes"></a>Quick-Fix Implementation Plan</h4>
    <div style="background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.3);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div style="font-size:12px;color:#86efac;line-height:1.7;">
        <strong style="color:#22c55e;">Phase 1: Immediate Fixes (COMPLETE)</strong>
        <ul style="margin:8px 0;padding-left:20px;">
          <li>&#10004; <strong>Exact TP/SL prices displayed</strong> - No more mental math on entry</li>
          <li>&#10004; <strong>Position sizing guidance added</strong> - Max 2% portfolio risk per trade</li>
          <li>&#10004; <strong>Better risk visualization</strong> - Color-coded risk levels on all cards</li>
          <li>&#10004; <strong>Quick entry/exit calculator</strong> - Instant profit/loss scenarios</li>
        </ul>
        <strong style="color:#f59e0b;">Phase 2: Accuracy Improvements (COMPLETE)</strong>
        <ul style="margin:8px 0;padding-left:20px;">
          <li>&#10004; <strong>Quality gates implemented</strong> - EMA trend + momentum + volume</li>
          <li>&#10004; <strong>Stricter thresholds</strong> - Raised from 70/75/85 to 72/78/85</li>
          <li>&#10004; <strong>Bear market penalty</strong> - -10pts when BTC in downtrend</li>
          <li>&#10004; <strong>Tier 2 scrutiny</strong> - Extra +10pts required for emerging coins</li>
        </ul>
        <strong style="color:#a855f7;">Phase 3: Short-term (This Week)</strong>
        <ul style="margin:8px 0;padding-left:20px;color:#d4d4d8;">
          <li>&#9675; <strong>Risk/reward ratio filters</strong> - Hide signals below 2:1 R/R</li>
          <li>&#9675; <strong>Correlation warnings</strong> - Alert when multiple meme signals are correlated</li>
          <li>&#9675; <strong>Time-of-day filters</strong> - Meme pumps often happen in specific sessions</li>
        </ul>
        <strong style="color:var(--dim);">Phase 4: Medium-term (This Month)</strong>
        <ul style="margin:8px 0;padding-left:20px;color:#d4d4d8;">
          <li>&#9675; <strong>Social sentiment overlay</strong> - Reddit/Twitter mention velocity</li>
          <li>&#9675; <strong>On-chain smart money tracking</strong> - Whale wallet monitoring</li>
          <li>&#9675; <strong>Machine learning signal filtering</strong> - Train on resolved outcomes</li>
          <li>&#9675; <strong>Multi-exchange price validation</strong> - Cross-check for manipulation</li>
        </ul>
      </div>
    </div>

    <h4 style="font-size:15px;margin-bottom:10px;color:#22c55e;">Position Size Calculator</h4>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:12px;">
        <div>
          <label style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">Portfolio Size ($)</label>
          <input type="number" id="calc-portfolio" value="10000" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:#fff;font-size:13px;margin-top:4px;" oninput="updatePositionCalc()">
        </div>
        <div>
          <label style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">Risk Per Trade (%)</label>
          <input type="number" id="calc-risk" value="2" min="0.5" max="10" step="0.5" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:#fff;font-size:13px;margin-top:4px;" oninput="updatePositionCalc()">
        </div>
        <div>
          <label style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">Entry Price ($)</label>
          <input type="number" id="calc-entry" value="0.001" step="0.000001" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:#fff;font-size:13px;margin-top:4px;" oninput="updatePositionCalc()">
        </div>
        <div>
          <label style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">Stop Loss ($)</label>
          <input type="number" id="calc-sl" value="0.00095" step="0.000001" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:#fff;font-size:13px;margin-top:4px;" oninput="updatePositionCalc()">
        </div>
      </div>
      <div id="calc-results" style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:8px;padding:12px;font-size:13px;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:16px;text-align:center;">
          <div>
            <div style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">Position Size</div>
            <div id="calc-position-size" style="font-size:18px;font-weight:700;color:#22c55e;">--</div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">Max Loss</div>
            <div id="calc-max-loss" style="font-size:18px;font-weight:700;color:#ef4444;">--</div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">Risk/Reward</div>
            <div id="calc-rr" style="font-size:18px;font-weight:700;color:#f59e0b;">--</div>
          </div>
        </div>
      </div>
      <div style="font-size:11px;color:var(--dim);margin-top:10px;">
        <strong style="color:#f59e0b;">Rule of thumb:</strong> Never risk more than 1-2% of your portfolio on a single meme coin trade. With a 5% win rate, you need strict risk management to survive until the next winning trade.
      </div>
    </div>
    <script>
    function updatePositionCalc() {
        var portfolio = parseFloat(document.getElementById('calc-portfolio').value) || 0;
        var riskPct = parseFloat(document.getElementById('calc-risk').value) || 0;
        var entry = parseFloat(document.getElementById('calc-entry').value) || 0;
        var sl = parseFloat(document.getElementById('calc-sl').value) || 0;
        
        if (portfolio > 0 && riskPct > 0 && entry > 0 && sl > 0 && entry !== sl) {
            var maxLoss = portfolio * (riskPct / 100);
            var priceRisk = Math.abs(entry - sl);
            var positionSize = maxLoss / (priceRisk / entry);
            var rr = priceRisk > 0 ? (entry * 0.05) / priceRisk : 0; // Assuming 5% target
            
            document.getElementById('calc-position-size').textContent = '$' + positionSize.toFixed(2);
            document.getElementById('calc-max-loss').textContent = '$' + maxLoss.toFixed(2);
            document.getElementById('calc-rr').textContent = '1:' + rr.toFixed(1);
        }
    }
    updatePositionCalc();
    </script>

    <h4 style="font-size:15px;margin-bottom:10px;color:#f59e0b;">API Endpoints</h4>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div style="font-size:12px;color:var(--dim);line-height:1.8;">
        &bull; <strong>Scanner stats:</strong> <a href="api/meme_scanner.php?action=stats" target="_blank" style="color:#c4b5fd">meme_scanner.php?action=stats</a> &mdash; overall performance metrics<br>
        &bull; <strong>Live signals:</strong> <a href="api/meme_scanner.php?action=scan" target="_blank" style="color:#c4b5fd">meme_scanner.php?action=scan</a> &mdash; current top meme coins<br>
        &bull; <strong>Signal history:</strong> <a href="api/meme_scanner.php?action=history" target="_blank" style="color:#c4b5fd">meme_scanner.php?action=history</a> &mdash; all signals with outcomes<br>
        &bull; <strong>Data source:</strong> FreeCryptoAPI for prices (real-time, no delay)
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════ -->
  <!-- TAB 3: RESEARCH & FUTURE -->
  <!-- ═══════════════════════════════════════════ -->
  <div class="main-panel" id="main-research">
    <div class="section-title" style="color:#a855f7;">Research Findings <span class="badge" style="background:rgba(168,85,247,0.15);color:#a855f7;border:1px solid rgba(168,85,247,0.3);">MEME COIN RESEARCH</span></div>
    <p style="font-size:13px;color:var(--dim);margin-bottom:16px;">Our methodology is price momentum scanning with time-period filtering. Below is a comparison to academic research, professional on-chain tools, and world-class standards.</p>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;margin-bottom:20px;">
      <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
        <h4 style="font-size:14px;color:#a855f7;margin-bottom:8px;">Academic Research</h4>
        <div style="font-size:12px;color:var(--dim);line-height:1.7;">
          <strong>Meme coin pump dynamics:</strong> Price surges driven primarily by social media virality, not fundamentals. Pumps follow power-law distributions with rapid onset and decay.<br>
          <strong>Ante (2023):</strong> Social sentiment and crypto prices are strongly correlated in low-cap tokens. Twitter/Reddit volume precedes price movement by 30&ndash;120 minutes.<br>
          <strong>Rug-pull detection research:</strong> Automated methods analyze contract code, liquidity locks, and holder concentration. None of which we implement.<br>
          <strong>Dogecoin effect:</strong> Social media-driven price action can sustain for days but always reverts. Entry timing is everything &mdash; technical indicators lag social triggers.
        </div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;">
        <h4 style="font-size:14px;color:#a855f7;margin-bottom:8px;">World-Class Tools Comparison</h4>
        <div style="font-size:12px;color:var(--dim);line-height:1.7;">
          <strong>Nansen ($100/mo):</strong> Full on-chain analytics, wallet labeling, smart money tracking, NFT analytics. Tracks whale movements in real-time.<br>
          <strong>Dune Analytics:</strong> Custom blockchain queries, token holder analysis, protocol metrics. Community-built dashboards for any on-chain data.<br>
          <strong>LunarCrush ($30/mo):</strong> Social intelligence for crypto. Real-time sentiment, influencer tracking, social volume metrics across Twitter, Reddit, YouTube.<br>
          <strong>Bubblemaps:</strong> Visual wallet clustering and token holder distribution. Identifies connected wallets and concentration risk.<br>
          <strong>What we have:</strong> Price data only &mdash; missing the entire on-chain and social intelligence layer.
        </div>
      </div>
    </div>

    <h4 style="font-size:15px;margin-bottom:10px;color:#a855f7;">World-Class Gap Analysis</h4>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <table style="width:100%;font-size:12px;border-collapse:collapse;">
        <thead><tr style="border-bottom:1px solid var(--border);">
          <th style="text-align:left;padding:6px 8px;color:var(--dim);font-size:11px;text-transform:uppercase;">Metric</th>
          <th style="text-align:left;padding:6px 8px;color:var(--dim);font-size:11px;text-transform:uppercase;">World-Class</th>
          <th style="text-align:left;padding:6px 8px;color:var(--dim);font-size:11px;text-transform:uppercase;">Ours</th>
          <th style="text-align:left;padding:6px 8px;color:var(--dim);font-size:11px;text-transform:uppercase;">Gap</th>
        </tr></thead>
        <tbody style="color:var(--text);">
          <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">On-chain Data</td><td style="padding:6px 8px;color:var(--green);">Full (wallet tracking, tx analysis)</td><td style="padding:6px 8px;color:var(--red);">None</td><td style="padding:6px 8px;color:var(--red);">Massive</td></tr>
          <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Social Sentiment</td><td style="padding:6px 8px;color:var(--green);">Real-time (Twitter, Reddit, Telegram)</td><td style="padding:6px 8px;color:var(--red);">None (price proxy only)</td><td style="padding:6px 8px;color:var(--red);">Massive</td></tr>
          <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Rug-Pull Detection</td><td style="padding:6px 8px;color:var(--green);">Automated (contract analysis, liquidity)</td><td style="padding:6px 8px;color:var(--red);">None</td><td style="padding:6px 8px;color:var(--red);">Massive</td></tr>
          <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Data Sources</td><td style="padding:6px 8px;color:var(--green);">5&ndash;10 (price, on-chain, social, news)</td><td style="padding:6px 8px;color:var(--red);">1 (FreeCryptoAPI only)</td><td style="padding:6px 8px;color:var(--red);">Massive</td></tr>
          <tr style="border-bottom:1px solid rgba(42,42,74,0.5);"><td style="padding:6px 8px;">Whale Tracking</td><td style="padding:6px 8px;color:var(--green);">Real-time wallet monitoring</td><td style="padding:6px 8px;color:var(--red);">None</td><td style="padding:6px 8px;color:var(--red);">Large</td></tr>
          <tr><td style="padding:6px 8px;">Liquidity Analysis</td><td style="padding:6px 8px;color:var(--green);">DEX pool depth, slippage calculation</td><td style="padding:6px 8px;color:var(--red);">None</td><td style="padding:6px 8px;color:var(--red);">Large</td></tr>
        </tbody>
      </table>
    </div>

    <h4 style="font-size:15px;margin-bottom:10px;color:#a855f7;">Future Priorities</h4>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <div style="font-size:12px;color:var(--dim);line-height:1.8;">
        <strong style="color:var(--green);">Priority 1 &mdash; Social sentiment integration:</strong> Reddit and Twitter/X trending score for meme coins. Social buzz precedes price movement by 30&ndash;120 min in academic research.<br>
        <strong style="color:var(--green);">Priority 2 &mdash; Whale wallet tracking:</strong> Monitor known large holders for accumulation/distribution patterns. Single whale sells can crash meme coins 50%+.<br>
        <strong style="color:var(--gold);">Priority 3 &mdash; Liquidity pool depth analysis:</strong> Check DEX liquidity before flagging a signal. Low liquidity = high slippage = worse execution.<br>
        <strong style="color:var(--gold);">Priority 4 &mdash; Smart contract risk scoring:</strong> Automated analysis of token contract code for rug-pull indicators (mint functions, proxy patterns, hidden fees).<br>
        <strong style="color:var(--dim);">Priority 5 &mdash; Market cap verification:</strong> Cross-reference circulating supply from multiple sources. Many meme coins report inflated or incorrect market caps.<br>
        <strong style="color:var(--dim);">Priority 6 &mdash; Historical rug-pull pattern detection:</strong> ML model trained on known rug pulls to flag similar on-chain patterns before they happen.
      </div>
    </div>

    <!-- Data Sources & Transparency -->
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <h3 style="font-size:15px;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
        Data Sources &amp; Transparency
        <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);">LOSING</span>
      </h3>
      <div style="font-size:12px;color:var(--dim);line-height:1.8;">
        <strong style="color:var(--text);">Where the numbers come from:</strong><br>
        &bull; <strong>Scanner stats:</strong> <a href="api/meme_scanner.php?action=stats" target="_blank" style="color:#c4b5fd">meme_scanner.php?action=stats</a> &mdash; 5% WR (1/19), all-time record<br>
        &bull; <strong>Live signals:</strong> <a href="api/meme_scanner.php?action=scan" target="_blank" style="color:#c4b5fd">meme_scanner.php?action=scan</a> &mdash; top meme coins scored by 7 indicators<br>
        &bull; <strong>Signal history:</strong> <a href="api/meme_scanner.php?action=history" target="_blank" style="color:#c4b5fd">meme_scanner.php?action=history</a> &mdash; every signal with resolved outcome<br>
        &bull; <strong>Price data:</strong> Crypto.com Exchange public API (real-time, no delay)<br>
        &bull; <strong>Scanner frequency:</strong> Every 10 minutes via GitHub Actions<br>
        &bull; <strong>Compare to:</strong> <a href="/live-monitor/algo-performance.html" style="color:#c4b5fd">L vs O Algo Performance</a> &mdash; crypto trades at 87.5% WR (our best crypto system)
      </div>
    </div>

    <!-- Future Roadmap -->
    <div style="background:var(--card);border:1px solid rgba(232,121,249,0.3);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
      <h3 style="font-size:15px;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
        Future Roadmap
        <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:rgba(34,197,94,0.15);color:#22c55e;border:1px solid rgba(34,197,94,0.3);">PLANNED</span>
      </h3>
      <div style="font-size:12px;color:var(--dim);line-height:1.8;">
        <strong style="color:var(--green);">Near-term:</strong><br>
        &bull; Wider resolve windows (4h, 8h, 24h) to capture slower meme coin moves<br>
        &bull; Social sentiment overlay (Reddit/X mention velocity)<br>
        &bull; CEX listing event detection (new listings = instant pumps)<br><br>
        <strong style="color:var(--gold);">Q2 2026:</strong><br>
        &bull; Adaptive scoring weights based on which factors predict wins<br>
        &bull; Cross-exchange arbitrage detection (Crypto.com vs Binance vs Coinbase)<br>
        &bull; Volume spike alerts with push notifications<br><br>
        <strong style="color:var(--dim);">Long-term:</strong><br>
        &bull; Meme coin lifecycle classification (launch, hype, peak, decline)<br>
        &bull; Machine learning model trained on resolved signal outcomes<br>
        &bull; Risk-adjusted position sizing based on volatility regime
      </div>
    </div>

    <p style="font-size:11px;color:var(--dim);line-height:1.6;margin-bottom:16px;">
      <strong>Sources:</strong> Ante (2023) social sentiment and crypto prices, meme coin pump dynamics research, rug-pull detection literature, DeFi liquidity analysis papers, Nansen.ai, Dune Analytics, LunarCrush, Bubblemaps, Dogecoin effect studies.
    </p>
  </div>

</div>

<script>
// ── Main tab switching ──
function switchMainTab(tab) {
    var tabNames = ['scanner', 'analysis', 'research'];
    var btns = document.querySelectorAll('.main-tab-btn');
    var panels = document.querySelectorAll('.main-panel');
    for (var i = 0; i < btns.length; i++) {
        btns[i].classList.toggle('active', tabNames[i] === tab);
    }
    for (var j = 0; j < panels.length; j++) {
        panels[j].classList.remove('active');
    }
    document.getElementById('main-' + tab).classList.add('active');
}

function toggleEdu(el) {
    var body = el.nextElementSibling;
    var arrow = el.querySelector('.edu-arrow');
    if (body.classList.contains('open')) {
        body.classList.remove('open');
        arrow.classList.remove('open');
    } else {
        body.classList.add('open');
        arrow.classList.add('open');
    }
}

var API = '/findcryptopairs/api/meme_scanner.php';

function api(action, cb) {
    var x = new XMLHttpRequest();
    x.open('GET', API + '?action=' + action);
    x.onload = function() {
        try { cb(JSON.parse(x.responseText)); } catch(e) { console.error(e); }
    };
    x.onerror = function() { console.error('API error'); };
    x.send();
}

function formatPnl(v) {
    v = parseFloat(v);
    if (isNaN(v)) return '--';
    var cls = v >= 0 ? 'green' : 'red';
    return '<span class="' + cls + '">' + (v >= 0 ? '+' : '') + v.toFixed(2) + '%</span>';
}

function verdictBadge(v) {
    if (v === 'STRONG_BUY') return '<span class="badge badge-strong">Strong Buy</span>';
    if (v === 'BUY') return '<span class="badge badge-buy">Buy</span>';
    return '<span class="badge badge-lean">Lean Buy</span>';
}

function tierBadge(t) {
    if (t === 'tier1') return '<span class="badge-tier1">Established</span>';
    return '<span class="badge-tier2">Emerging</span>';
}

function factorBar(score, max) {
    var pct = Math.round((score / max) * 100);
    var color = pct >= 80 ? 'var(--green)' : pct >= 50 ? 'var(--gold)' : 'var(--red)';
    return '<div class="factor-bar"><div class="factor-fill" style="width:' + pct + '%;background:' + color + '"></div></div>';
}

// ── BUY NOW Ranking System ──
// Computes a composite rank factoring freshness, R:R, and base score
function computeBuyNowRank(w) {
    var baseScore = parseInt(w.score) || 0;
    var targetPct = parseFloat(w.target_pct || 0);
    var riskPct = parseFloat(w.risk_pct || 0);
    var createdAt = w.created_at || '';

    // Freshness penalty: -2 pts per minute since signal, max -30
    var ageMinutes = 0;
    if (createdAt) {
        var signalTime = new Date(createdAt.replace(' ', 'T') + 'Z');
        ageMinutes = Math.max(0, (Date.now() - signalTime.getTime()) / 60000);
    }
    var freshnessPenalty = Math.min(30, Math.floor(ageMinutes) * 2);

    // R:R bonus: better ratio = higher rank (max +10)
    var rrRatio = riskPct > 0 ? targetPct / riskPct : 0;
    var rrBonus = Math.min(10, Math.floor(rrRatio * 3));

    // Regime bonus from factors
    var f = w.factors_json || {};
    var regimeAdj = 0;
    if (f.btc_regime && f.btc_regime.adjustment) {
        regimeAdj = parseInt(f.btc_regime.adjustment) || 0;
    }

    // Quality gate bonus
    var qualityBonus = 0;
    if (f.quality_check && f.quality_check.score >= 3) qualityBonus = 5;
    else if (f.quality_check && f.quality_check.score >= 2) qualityBonus = 2;

    var rank = baseScore - freshnessPenalty + rrBonus + regimeAdj + qualityBonus;
    return {
        rank: Math.max(0, Math.min(100, rank)),
        ageMinutes: Math.floor(ageMinutes),
        freshnessPenalty: freshnessPenalty,
        rrBonus: rrBonus,
        rrRatio: rrRatio,
        regimeAdj: regimeAdj,
        qualityBonus: qualityBonus
    };
}

function getAgeBadge(ageMinutes) {
    if (ageMinutes < 10) return '<span class="signal-age-badge age-fresh">' + ageMinutes + 'm ago</span>';
    if (ageMinutes < 20) return '<span class="signal-age-badge age-aging">' + ageMinutes + 'm ago</span>';
    return '<span class="signal-age-badge age-stale">' + ageMinutes + 'm ago</span>';
}

// Store current winners globally for live mode and verify modal
window.currentWinners = [];

function renderWinners(data) {
    // Show BTC regime indicator if available
    updateBtcRegimeBar(data.btc_regime, data.btc_trend_pct, data.last_scan);

    if (!data.ok || data.count === 0) {
        document.getElementById('winner-count').textContent = '0 winners';
        window.currentWinners = [];
        // Show helpful empty state with watchlist from scan log
        var emptyHtml = '<div style="text-align:center;padding:30px 20px;color:var(--dim);font-size:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:12px">';
        emptyHtml += '<div style="font-size:40px;margin-bottom:12px">&#128056;</div>';
        emptyHtml += '<div style="font-size:18px;color:#fff;margin-bottom:8px">No Buy Signals Right Now</div>';
        emptyHtml += '<div>None of the monitored meme coins are scoring above 70/100. The scanner is being selective &mdash; when volume explodes and momentum aligns, signals will appear instantly.';
        if (data.btc_regime === 'bear') {
            emptyHtml += '<br><br><span style="color:#fca5a5;font-weight:600">&#128308; BTC is in a bear regime, which reduces meme coin scores and suppresses signals.</span>';
        }
        emptyHtml += '<br><br>Scans every 15 minutes, 24/7. See the <strong>watchlist</strong> below for the closest candidates.</div>';
        emptyHtml += '</div>';
        emptyHtml += '<div id="watchlist-container"><div class="loading">Loading watchlist...</div></div>';
        document.getElementById('winners-list').innerHTML = emptyHtml;
        document.getElementById('auto-verify-summary').innerHTML = '';
        loadWatchlist();
        return;
    }

    // Compute BUY NOW rank for each winner and sort
    var ranked = [];
    for (var ri = 0; ri < data.winners.length; ri++) {
        var rw = data.winners[ri];
        rw._buyNow = computeBuyNowRank(rw);
        ranked.push(rw);
    }
    ranked.sort(function(a, b) { return b._buyNow.rank - a._buyNow.rank; });
    window.currentWinners = ranked;

    document.getElementById('winner-count').textContent = data.count + ' winners';
    var html = '';
    var defaultPortfolio = 10000;
    for (var i = 0; i < ranked.length; i++) {
        var w = ranked[i];
        var f = w.factors_json || {};
        var bn = w._buyNow;

        // FIXED: Define variables BEFORE using them
        var entryPrice = parseFloat(w.price_at_signal || 0);
        var targetPct = parseFloat(w.target_pct || 0);
        var riskPct = parseFloat(w.risk_pct || 0);
        var takeProfitPrice = entryPrice * (1 + targetPct / 100);
        var stopLossPrice = entryPrice * (1 - riskPct / 100);
        var priceDecimals = entryPrice >= 1 ? 4 : entryPrice >= 0.01 ? 6 : entryPrice >= 0.0001 ? 8 : 10;

        var scoreColor = w.score >= 85 ? 'accent' : w.score >= 75 ? 'gold' : 'cyan';
        var pair = (w.pair || '').replace('_USDT', '/USDT');

        // R:R ratio (now using correctly defined variables)
        var rrRatio = riskPct > 0 ? (targetPct / riskPct).toFixed(1) : '0';
        var rrBadge = '<span style="background:rgba(245,158,11,0.15);color:#f59e0b;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;border:1px solid rgba(245,158,11,0.3);">R:R 1:' + rrRatio + '</span>';

        // Staleness
        var isStale = bn.ageMinutes >= 30;
        var cardClass = 'winner-card' + (isStale ? ' stale-card' : '');

        // Risk bar color
        var riskColor = w.tier === 'tier2' ? '239,68,68' : w.score >= 85 ? '245,158,11' : '234,179,8';

        html += '<div class="' + cardClass + '" id="winner-card-' + i + '" style="position:relative;overflow:hidden;" data-pair="' + (w.pair || '') + '" data-idx="' + i + '">';
        html += '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:rgba(' + riskColor + ',0.5);"></div>';

        // Header with BUY NOW badge + age badge
        html += '<div class="winner-header">';
        html += '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">';
        html += '<span class="winner-pair">' + pair + '</span> ';
        html += verdictBadge(w.verdict) + ' ' + tierBadge(w.tier) + ' ' + rrBadge + ' ';
        html += getAgeBadge(bn.ageMinutes) + ' ';
        // BUY NOW badge (only if rank >= 70)
        if (bn.rank >= 70 && !isStale) {
            html += '<span class="buy-now-badge" onclick="openVerifyModal(' + i + ')">VERIFY &amp; BUY</span>';
        } else if (isStale) {
            html += '<span class="buy-now-badge" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);color:#fca5a5;font-size:10px" onclick="openVerifyModal(' + i + ')">STALE &mdash; VERIFY FIRST</span>';
        } else {
            html += '<span class="buy-now-badge" style="background:rgba(255,255,255,0.05);border-color:var(--border);color:var(--dim);font-size:10px" onclick="openVerifyModal(' + i + ')">VERIFY PRICE</span>';
        }
        html += '</div>';
        html += '<div style="text-align:right">';
        html += '<div class="winner-score ' + scoreColor + '">' + w.score + '<span style="font-size:12px;color:var(--dim)">/100</span></div>';
        html += '<div class="buy-now-rank">BUY NOW: <span class="rank-val ' + (bn.rank >= 70 ? 'green' : bn.rank >= 50 ? 'gold' : 'red') + '">' + bn.rank + '</span></div>';
        html += '</div>';
        html += '</div>';

        // Stale warning
        if (isStale) {
            html += '<div class="stale-overlay">STALE SIGNAL &mdash; Data is ' + bn.ageMinutes + ' minutes old. Verify current price before acting.</div>';
        }

        // Auto-verify verdict banner (populated on page load)
        html += '<div id="live-verdict-' + i + '" style="display:none"></div>';

        // Live price slot (populated by live mode)
        html += '<div id="live-price-' + i + '" style="display:none;margin:8px 0;padding:8px 12px;background:rgba(6,182,212,0.08);border:1px solid rgba(6,182,212,0.2);border-radius:6px;font-size:12px;"></div>';

        html += '<div class="winner-meta">';
        html += '<span>Entry: $' + entryPrice.toFixed(priceDecimals) + '</span>';
        html += '<span>24h: ' + formatPnl(w.chg_24h) + '</span>';
        html += '<span>Vol: $' + (parseFloat(w.vol_usd_24h)/1000).toFixed(0) + 'K</span>';
        html += '<span style="background:rgba(34,197,94,0.15);padding:2px 8px;border-radius:4px;font-weight:600;">TP: $' + takeProfitPrice.toFixed(priceDecimals) + '</span>';
        html += '<span style="background:rgba(239,68,68,0.15);padding:2px 8px;border-radius:4px;font-weight:600;">SL: $' + stopLossPrice.toFixed(priceDecimals) + '</span>';
        html += '<span>' + (w.created_at || '').substring(11, 16) + ' UTC</span>';
        html += '</div>';

        // P&L preview
        var previewPositionSize = defaultPortfolio * 0.02;
        html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.04);">';
        html += '<div style="text-align:center;"><div style="font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">If TP Hit</div><div style="font-size:14px;font-weight:700;color:var(--green);">+$' + (previewPositionSize * targetPct / 100).toFixed(2) + '</div></div>';
        html += '<div style="text-align:center;border-left:1px solid rgba(255,255,255,0.06);border-right:1px solid rgba(255,255,255,0.06);"><div style="font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">Position Size</div><div style="font-size:14px;font-weight:700;color:#fff;">$' + previewPositionSize.toFixed(2) + '</div></div>';
        html += '<div style="text-align:center;"><div style="font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;">If SL Hit</div><div style="font-size:14px;font-weight:700;color:var(--red);">-$' + (previewPositionSize * riskPct / 100).toFixed(2) + '</div></div>';
        html += '</div>';

        // Quality gates
        var qc = f['quality_check'] || {};
        if (qc.score !== undefined) {
            var qualityColor = qc.score >= 2 ? 'var(--green)' : qc.score >= 1 ? 'var(--gold)' : 'var(--red)';
            var qualityText = qc.score >= 2 ? 'Quality: PASS' : qc.score >= 1 ? 'Quality: WEAK' : 'Quality: FAIL';
            html += '<div style="margin:10px 0;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:6px;border-left:3px solid ' + qualityColor + ';">';
            html += '<div style="font-size:11px;color:' + qualityColor + ';font-weight:600;">' + qualityText + ' (' + qc.score + '/3 gates)</div>';
            if (qc.issues && qc.issues.length > 0) {
                html += '<div style="font-size:10px;color:var(--dim);margin-top:4px;">Issues: ' + qc.issues.join(', ') + '</div>';
            }
            html += '</div>';
        }

        // BTC Regime
        var btcRegime = f['btc_regime'] || {};
        if (btcRegime.regime) {
            var regimeColor = btcRegime.regime === 'bull' ? 'var(--green)' : btcRegime.regime === 'bear' ? 'var(--red)' : 'var(--dim)';
            var regimeEmoji = btcRegime.regime === 'bull' ? '\uD83D\uDC02' : btcRegime.regime === 'bear' ? '\uD83D\uDC3B' : '\u26A1';
            html += '<div style="margin:8px 0;font-size:10px;color:var(--dim);">BTC Regime: <span style="color:' + regimeColor + '">' + regimeEmoji + ' ' + btcRegime.regime.toUpperCase() + '</span>';
            if (btcRegime.adjustment !== 0) {
                var adjColor = btcRegime.adjustment > 0 ? 'var(--green)' : 'var(--red)';
                html += ' <span style="color:' + adjColor + '">(' + (btcRegime.adjustment > 0 ? '+' : '') + btcRegime.adjustment + ' pts)</span>';
            }
            html += '</div>';
        }

        // BUY NOW rank breakdown (collapsed)
        html += '<div style="margin:8px 0;font-size:10px;color:var(--dim);cursor:pointer" onclick="var d=this.nextElementSibling;d.style.display=d.style.display===\'none\'?\'block\':\'none\'">';
        html += 'BUY NOW rank breakdown: <strong style="color:' + (bn.rank >= 70 ? 'var(--green)' : bn.rank >= 50 ? 'var(--gold)' : 'var(--red)') + '">' + bn.rank + '/100</strong> (click to expand)';
        html += '</div>';
        html += '<div style="display:none;font-size:10px;color:var(--dim);padding:6px 10px;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:8px;">';
        html += 'Base: ' + w.score + ' | Freshness: -' + bn.freshnessPenalty + ' | R:R: +' + bn.rrBonus + ' | Regime: ' + (bn.regimeAdj >= 0 ? '+' : '') + bn.regimeAdj + ' | Quality: +' + bn.qualityBonus;
        html += '</div>';

        html += '<div class="factors">';
        var factorInfo = {
            'explosive_volume': {name: 'Expl. Volume', tip: 'Recent volume vs average. 3x=pump starting. 10x+=massive surge.'},
            'parabolic_momentum': {name: 'Parabolic Mom.', tip: 'Price acceleration on 15m + 5m charts. Both positive = confirmed uptrend.'},
            'rsi_hype_zone': {name: 'RSI Hype Zone', tip: 'RSI 60-75 is the sweet spot. Rising RSI = full points. Above 85 = dangerous.'},
            'social_proxy': {name: 'Social Proxy', tip: 'Price change x volume ratio = proxy for social buzz.'},
            'volume_concentration': {name: 'Vol. Conc.', tip: 'How much of recent volume is in the last 3 candles.'},
            'breakout_4h': {name: 'Breakout 4h', tip: 'Price breaking above its 4-hour high.'},
            'low_cap_bonus': {name: 'Low Cap', tip: 'Smaller coins move bigger on less capital.'}
        };
        for (var key in factorInfo) {
            if (f[key] && f[key].score !== undefined) {
                var fi = factorInfo[key];
                var displayScore = f[key].score;
                var displayMax = f[key].max || 1;
                if (key === 'trend_confirm' || key === 'momentum_gate' || key === 'volume_gate') {
                    var passed = f[key].passed || f[key].aligned;
                    displayScore = passed ? displayMax : 0;
                }
                html += '<div class="factor"><div class="factor-name">' + fi.name + ' (' + displayScore + '/' + displayMax + ') <i class="info-tip">i<span class="tip-text">' + fi.tip + '</span></i></div>' + factorBar(displayScore, displayMax) + '</div>';
            }
        }
        // Quick actions footer with verify button
        html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.04);display:flex;gap:8px;flex-wrap:wrap;align-items:center;">';
        html += '<span class="buy-now-badge" onclick="openVerifyModal(' + i + ')" style="font-size:11px;">Verify Live Price</span>';
        var baseSym = pair.replace('/USDT', '');
        var baseSymLower = baseSym.toLowerCase();
        html += '<a href="https://www.kucoin.com/trade/' + baseSym + '-USDT" target="_blank" style="font-size:11px;padding:4px 10px;background:rgba(35,185,140,0.15);color:#23b98c;border:1px solid rgba(35,185,140,0.3);border-radius:4px;text-decoration:none;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(35,185,140,0.25)\'" onmouseout="this.style.background=\'rgba(35,185,140,0.15)\'">KuCoin</a>';
        html += '<a href="https://www.gate.io/trade/' + baseSym + '_USDT" target="_blank" style="font-size:11px;padding:4px 10px;background:rgba(44,125,255,0.15);color:#2c7dff;border:1px solid rgba(44,125,255,0.3);border-radius:4px;text-decoration:none;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(44,125,255,0.25)\'" onmouseout="this.style.background=\'rgba(44,125,255,0.15)\'">Gate.io</a>';
        html += '<a href="https://www.mexc.com/exchange/' + baseSym + '_USDT" target="_blank" style="font-size:11px;padding:4px 10px;background:rgba(0,182,255,0.15);color:#00b6ff;border:1px solid rgba(0,182,255,0.3);border-radius:4px;text-decoration:none;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(0,182,255,0.25)\'" onmouseout="this.style.background=\'rgba(0,182,255,0.15)\'">MEXC</a>';
        html += '<a href="https://www.coingecko.com/en/coins/' + baseSymLower + '" target="_blank" style="font-size:11px;padding:4px 10px;background:rgba(255,255,255,0.05);color:var(--dim);border:1px solid var(--border);border-radius:4px;text-decoration:none;">CoinGecko</a>';
        html += '</div>';

        html += '</div></div>';
    }
    document.getElementById('winners-list').innerHTML = html;

    // Auto-verify all winners against live prices on render
    if (ranked.length > 0) {
        autoVerifyWinners();
    }
}

// ═══════════════════════════════════════════════════════════════════════
//  AUTO-VERIFY: batch check all winners against live prices on page load
//  Marks each card as VALID / CAUTION / INVALIDATED and shows summary
// ═══════════════════════════════════════════════════════════════════════
var _autoVerifyRunning = false;
function autoVerifyWinners() {
    if (_autoVerifyRunning) return;
    _autoVerifyRunning = true;

    var winners = window.currentWinners;
    if (!winners || winners.length === 0) {
        _autoVerifyRunning = false;
        return;
    }

    // Collect unique pairs for batch fetch
    var pairSet = {};
    for (var pi = 0; pi < winners.length; pi++) {
        pairSet[winners[pi].pair] = true;
    }
    var uniquePairs = [];
    for (var pk in pairSet) {
        if (pairSet.hasOwnProperty(pk)) uniquePairs.push(pk);
    }

    var summaryEl = document.getElementById('auto-verify-summary');
    summaryEl.innerHTML = '<div style="text-align:center;padding:8px;color:var(--dim);font-size:12px">Verifying live prices across 7 exchanges...</div>';

    // Batch price fetch
    var url = PRICE_CHECK_API + '?action=batch_price&pairs=' + encodeURIComponent(uniquePairs.join(','));
    var x = new XMLHttpRequest();
    x.open('GET', url);
    x.onload = function() {
        _autoVerifyRunning = false;
        try {
            var r = JSON.parse(x.responseText);
            if (!r.ok) {
                summaryEl.innerHTML = '';
                return;
            }
            // Build price map
            var priceMap = {};
            for (var pi2 = 0; pi2 < r.prices.length; pi2++) {
                var pd = r.prices[pi2];
                if (pd.price) priceMap[pd.pair] = pd;
            }
            applyAutoVerifyResults(priceMap);
        } catch(e) {
            summaryEl.innerHTML = '';
        }
    };
    x.onerror = function() {
        _autoVerifyRunning = false;
        summaryEl.innerHTML = '';
    };
    x.send();
}

function applyAutoVerifyResults(priceMap) {
    var winners = window.currentWinners;
    var validCount = 0;
    var cautionCount = 0;
    var invalidCount = 0;
    var noPriceCount = 0;

    for (var i = 0; i < winners.length; i++) {
        var w = winners[i];
        var card = document.getElementById('winner-card-' + i);
        var verdictSlot = document.getElementById('live-verdict-' + i);
        if (!card || !verdictSlot) continue;

        var pd = priceMap[w.pair];
        if (!pd || !pd.price) {
            noPriceCount++;
            continue;
        }

        var entryPrice = parseFloat(w.price_at_signal || 0);
        var targetPct = parseFloat(w.target_pct || 0);
        var riskPct = parseFloat(w.risk_pct || 0);
        var currentPrice = parseFloat(pd.price);
        if (entryPrice <= 0) continue;

        var changePct = ((currentPrice - entryPrice) / entryPrice) * 100;
        var remainingUp = targetPct - changePct;
        var priceDecimals = entryPrice >= 1 ? 4 : entryPrice >= 0.01 ? 6 : entryPrice >= 0.0001 ? 8 : 10;

        // Determine verdict (same logic as price_check.php)
        var verdict = 'VALID';
        var verdictText = '';
        var verdictClass = 'v-valid';

        if (changePct > targetPct * 0.8) {
            verdict = 'INVALIDATED';
            verdictText = 'Price already moved +' + changePct.toFixed(1) + '% — target nearly hit, upside gone';
            verdictClass = 'v-invalidated';
            invalidCount++;
        } else if (changePct < -riskPct) {
            verdict = 'INVALIDATED';
            verdictText = 'Price dropped ' + Math.abs(changePct).toFixed(1) + '% — past stop loss';
            verdictClass = 'v-invalidated';
            invalidCount++;
        } else if (changePct > targetPct * 0.5) {
            verdict = 'CAUTION';
            verdictText = 'Price moved +' + changePct.toFixed(1) + '% — reduced R:R, be cautious';
            verdictClass = 'v-caution';
            cautionCount++;
        } else if (changePct < -(riskPct * 0.5)) {
            verdict = 'CAUTION';
            verdictText = 'Price dropped ' + Math.abs(changePct).toFixed(1) + '% — approaching stop loss';
            verdictClass = 'v-caution';
            cautionCount++;
        } else {
            verdictText = 'Signal still viable — ' + remainingUp.toFixed(1) + '% upside remaining';
            validCount++;
        }

        // Apply card class
        card.className = card.className.replace(/ card-invalidated| card-caution| card-valid/g, '');
        if (verdict === 'INVALIDATED') {
            card.className += ' card-invalidated';
        } else if (verdict === 'CAUTION') {
            card.className += ' card-caution';
        } else {
            card.className += ' card-valid';
        }

        // Show inline verdict banner
        var changeColor = changePct >= 0 ? 'var(--green)' : 'var(--red)';
        var bannerHtml = '<div class="live-verdict-banner ' + verdictClass + '">';
        if (verdict === 'INVALIDATED') {
            bannerHtml += '<span style="font-size:14px">&#10060;</span> ';
        } else if (verdict === 'CAUTION') {
            bannerHtml += '<span style="font-size:14px">&#9888;&#65039;</span> ';
        } else {
            bannerHtml += '<span style="font-size:14px">&#9989;</span> ';
        }
        bannerHtml += '<span>' + verdict + ': ' + verdictText + '</span>';
        bannerHtml += '<span class="v-price">Now: $' + currentPrice.toFixed(priceDecimals) + ' (' + (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%) via ' + pd.source + '</span>';
        bannerHtml += '</div>';
        verdictSlot.innerHTML = bannerHtml;
        verdictSlot.style.display = 'block';
    }

    // Render summary banner
    var summaryEl = document.getElementById('auto-verify-summary');
    var totalChecked = validCount + cautionCount + invalidCount;

    if (totalChecked === 0) {
        summaryEl.innerHTML = '';
        return;
    }

    if (validCount === 0 && cautionCount === 0) {
        // ALL invalidated
        var hiddenNote = hideInvalidated ?
            'Invalidated signals are hidden. Toggle "Hide Invalidated" above to show them.' :
            'Invalidated signals are shown crossed out below for transparency.';
        summaryEl.innerHTML = '<div class="no-viable-banner">' +
            '<h3>&#10060; No Viable Signals Right Now</h3>' +
            '<p>All ' + invalidCount + ' signal' + (invalidCount > 1 ? 's' : '') + ' have been invalidated — prices moved past their targets or stop losses since they were generated. ' +
            'The scanner checks every 15 minutes. Fresh signals will appear when new setups form.<br>' +
            '<span style="color:#888;font-size:11px">' + hiddenNote + '</span></p>' +
            '</div>';
    } else {
        var summaryParts = [];
        if (validCount > 0) summaryParts.push('<span style="color:#86efac;font-weight:700">' + validCount + ' valid</span>');
        if (cautionCount > 0) summaryParts.push('<span style="color:#fcd34d;font-weight:700">' + cautionCount + ' caution</span>');
        if (invalidCount > 0) summaryParts.push('<span style="color:#fca5a5;font-weight:700">' + invalidCount + ' invalidated</span>');

        summaryEl.innerHTML = '<div class="some-viable-banner">' +
            '<span class="viable-count">' + validCount + ' VIABLE</span>' +
            '<span style="color:#ccc">Live-checked against 7 exchanges: ' + summaryParts.join(' &bull; ') + '</span>' +
            '</div>';
    }

    // Update hidden count for the toggle label
    if (typeof updateHiddenCount === 'function') updateHiddenCount();
}

// ═══════════════════════════════════════════════════════════════════════
//  WATCHLIST: Show top candidates when no signals are above threshold
//  Fetches scan_log and displays the closest-to-threshold coins
// ═══════════════════════════════════════════════════════════════════════
function loadWatchlist() {
    var url = '/findcryptopairs/api/meme_scanner.php?action=scan_log&limit=20';
    var x = new XMLHttpRequest();
    x.open('GET', url);
    x.onload = function() {
        try {
            var r = JSON.parse(x.responseText);
            renderWatchlist(r);
        } catch(e) {
            var c = document.getElementById('watchlist-container');
            if (c) c.innerHTML = '';
        }
    };
    x.onerror = function() {
        var c = document.getElementById('watchlist-container');
        if (c) c.innerHTML = '';
    };
    x.send();
}

function renderWatchlist(data) {
    var container = document.getElementById('watchlist-container');
    if (!container || !data.ok) {
        if (container) container.innerHTML = '';
        return;
    }

    var items = data.log || [];
    if (items.length === 0) {
        container.innerHTML = '<div style="color:var(--dim);text-align:center;padding:12px">No scan data available yet.</div>';
        return;
    }

    // Sort by score descending, take top 8
    items.sort(function(a, b) { return (parseInt(b.score) || 0) - (parseInt(a.score) || 0); });
    items = items.slice(0, 8);

    var html = '<div style="margin-bottom:8px;font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px">';
    html += '<span style="font-size:16px">&#128065;</span> Watchlist &mdash; Top Candidates (not buy signals)';
    html += '</div>';

    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px">';
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var score = parseInt(item.score) || 0;
        var pair = (item.pair || '').replace('_USDT', '/USDT');
        var chg = parseFloat(item.chg_24h || 0);
        var vol = parseFloat(item.vol_usd_24h || 0);
        var price = parseFloat(item.price || 0);
        var priceDecimals = price >= 1 ? 4 : price >= 0.01 ? 6 : price >= 0.0001 ? 8 : 10;

        var scoreColor = score >= 50 ? '#fcd34d' : score >= 30 ? '#94a3b8' : '#475569';
        var barWidth = Math.min(100, Math.max(3, score));
        var chgColor = chg >= 0 ? 'var(--green)' : 'var(--red)';

        html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 12px;opacity:0.7;transition:opacity 0.2s" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
        html += '<span style="font-weight:700;font-size:13px;color:#fff">' + pair + '</span>';
        html += '<span style="font-size:12px;color:' + scoreColor + ';font-weight:700">' + score + '<span style="color:var(--dim);font-weight:400">/100</span></span>';
        html += '</div>';

        // Score bar
        html += '<div style="height:3px;background:rgba(255,255,255,0.05);border-radius:2px;margin-bottom:6px">';
        html += '<div style="height:100%;width:' + barWidth + '%;background:' + scoreColor + ';border-radius:2px;transition:width 0.3s"></div>';
        html += '</div>';

        html += '<div style="display:flex;gap:8px;font-size:11px;color:var(--dim);flex-wrap:wrap">';
        html += '<span>$' + price.toFixed(priceDecimals) + '</span>';
        html += '<span style="color:' + chgColor + '">' + (chg >= 0 ? '+' : '') + chg.toFixed(1) + '%</span>';
        html += '<span>Vol: $' + (vol >= 1000000 ? (vol / 1000000).toFixed(1) + 'M' : (vol / 1000).toFixed(0) + 'K') + '</span>';
        if (score >= 50) {
            html += '<span style="color:#fcd34d;font-weight:600">Closest to threshold</span>';
        }
        html += '</div>';
        html += '</div>';
    }
    html += '</div>';

    html += '<div style="text-align:center;margin-top:8px;font-size:11px;color:#555">Coins need a score of 70+ across 7 technical indicators to generate a buy signal. These are the current leaders.</div>';

    container.innerHTML = html;
}

function updateBtcRegimeBar(regime, trendPct, lastScan) {
    var bar = document.getElementById('btc-regime-bar');
    if (!bar) return;

    if (!regime) {
        bar.style.display = 'none';
        return;
    }

    bar.style.display = 'flex';
    var icon = '';
    var label = '';
    var color = '';
    var bgColor = '';
    var borderColor = '';
    var detail = '';

    if (regime === 'bull') {
        icon = '&#128994;';
        label = 'BULL MARKET';
        color = '#86efac';
        bgColor = 'rgba(34,197,94,0.06)';
        borderColor = 'rgba(34,197,94,0.3)';
        detail = 'BTC trending up (' + (trendPct > 0 ? '+' : '') + (trendPct || 0).toFixed(1) + '% vs 24h SMA). Meme coins have better odds.';
    } else if (regime === 'bear') {
        icon = '&#128308;';
        label = 'BEAR MARKET';
        color = '#fca5a5';
        bgColor = 'rgba(239,68,68,0.06)';
        borderColor = 'rgba(239,68,68,0.3)';
        detail = 'BTC trending down (' + (trendPct || 0).toFixed(1) + '% vs 24h SMA). Meme signals carry extra risk. Scores adjusted.';
    } else {
        icon = '&#128992;';
        label = 'CHOPPY MARKET';
        color = '#fcd34d';
        bgColor = 'rgba(245,158,11,0.06)';
        borderColor = 'rgba(245,158,11,0.3)';
        detail = 'BTC in sideways range. Mixed conditions for meme plays.';
    }

    var scanAge = '';
    if (lastScan) {
        var scanDate = new Date(lastScan.replace(' ', 'T') + 'Z');
        var ageMin = Math.floor((Date.now() - scanDate.getTime()) / 60000);
        scanAge = '<span style="margin-left:auto;font-size:11px;color:var(--dim)">Last scan: ' + ageMin + 'm ago</span>';
    }

    bar.style.background = bgColor;
    bar.style.borderColor = borderColor;
    bar.innerHTML = '<span style="font-size:14px">' + icon + '</span>' +
        '<span style="background:' + bgColor + ';color:' + color + ';padding:2px 8px;border-radius:4px;font-weight:800;font-size:11px;border:1px solid ' + borderColor + ';letter-spacing:0.5px">' + label + '</span>' +
        '<span style="color:' + color + ';font-size:12px">' + detail + '</span>' +
        scanAge;
}

function renderStats(data) {
    if (!data.ok || !data.stats) return;
    var s = data.stats;
    document.getElementById('s-wr').innerHTML = s.overall_win_rate !== null ? '<span class="' + (s.overall_win_rate >= 60 ? 'green' : s.overall_win_rate >= 50 ? 'gold' : 'red') + '">' + s.overall_win_rate + '%</span>' : '--';
    document.getElementById('s-pnl').innerHTML = s.avg_pnl !== null ? formatPnl(s.avg_pnl) : '--';
    document.getElementById('s-total').textContent = s.total_signals || 0;
    document.getElementById('s-resolved').textContent = (s.resolved || 0) + ' resolved, ' + (s.pending || 0) + ' pending';
    document.getElementById('s-best').textContent = s.best_trade ? '+' + parseFloat(s.best_trade).toFixed(1) + '%' : '--';
    document.getElementById('s-worst').textContent = s.worst_trade ? 'Worst: ' + parseFloat(s.worst_trade).toFixed(1) + '%' : '';
    document.getElementById('s-pairs').textContent = s.unique_pairs || 0;
    document.getElementById('s-scans').textContent = (s.total_scans || 0) + ' scans';
    document.getElementById('s-last').textContent = s.last_scan ? s.last_scan.substring(5, 16) : '--';
    document.getElementById('s-first').textContent = s.first_scan ? 'Since ' + s.first_scan.substring(0, 10) : '';
}

function renderLeaderboard(data) {
    if (!data.ok) return;

    // By verdict tier
    var tiers = data.by_verdict || [];
    if (tiers.length === 0) {
        document.getElementById('tier-table').innerHTML = '<div class="loading">No resolved data yet. Check back after signals have been tracked for 2+ hours.</div>';
    } else {
        var html = '<table class="history-table"><tr><th>Tier</th><th>Signals</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>Avg P&L</th></tr>';
        for (var i = 0; i < tiers.length; i++) {
            var t = tiers[i];
            var wrClass = t.win_rate >= 60 ? 'green' : t.win_rate >= 50 ? 'gold' : 'red';
            html += '<tr><td>' + verdictBadge(t.verdict) + '</td><td>' + t.signals + '</td><td class="green">' + t.wins + '</td><td class="red">' + t.losses + '</td>';
            html += '<td class="' + wrClass + '">' + (t.win_rate !== null ? t.win_rate + '%' : '--') + '</td>';
            html += '<td>' + formatPnl(t.avg_pnl) + '</td></tr>';
        }
        html += '</table>';
        document.getElementById('tier-table').innerHTML = html;
    }

    // Tier 1 vs Tier 2 comparison
    var tc = data.by_tier || [];
    if (tc.length === 0) {
        document.getElementById('tier-comparison').innerHTML = '<div class="loading">No tier comparison data yet.</div>';
    } else {
        var html2 = '<table class="history-table"><tr><th>Tier</th><th>Signals</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>Avg P&L</th></tr>';
        for (var j = 0; j < tc.length; j++) {
            var r = tc[j];
            var wrC = r.win_rate >= 60 ? 'green' : r.win_rate >= 50 ? 'gold' : 'red';
            var tierLabel = r.tier === 'tier1' ? '<span class="badge-tier1">Established</span>' : '<span class="badge-tier2">Emerging</span>';
            html2 += '<tr><td>' + tierLabel + '</td><td>' + r.signals + '</td><td class="green">' + r.wins + '</td><td class="red">' + r.losses + '</td>';
            html2 += '<td class="' + wrC + '">' + (r.win_rate !== null ? r.win_rate + '%' : '--') + '</td>';
            html2 += '<td>' + formatPnl(r.avg_pnl) + '</td></tr>';
        }
        html2 += '</table>';
        document.getElementById('tier-comparison').innerHTML = html2;
    }
}

function renderHistory(data) {
    if (!data.ok || data.count === 0) {
        document.getElementById('history-list').innerHTML = '<div class="loading">No signal history yet.</div>';
        return;
    }
    var html = '<table class="history-table"><tr><th>Pair</th><th>Tier</th><th>Score</th><th>Entry</th><th>TP / SL</th><th>Resolve</th><th>P&L</th><th>Outcome</th><th>Time</th></tr>';
    for (var i = 0; i < Math.min(data.history.length, 50); i++) {
        var h = data.history[i];
        var pair = (h.pair || '').replace('_USDT', '/USDT');
        var outcomeClass = '';
        if (h.outcome === 'win' || h.outcome === 'partial_win') outcomeClass = 'outcome-win';
        else if (h.outcome === 'loss' || h.outcome === 'partial_loss') outcomeClass = 'outcome-loss';
        else outcomeClass = 'outcome-pending';
        
        // Calculate TP/SL prices for history
        var entryHist = parseFloat(h.price_at_signal || 0);
        var targetHist = parseFloat(h.target_pct || 5);
        var riskHist = parseFloat(h.risk_pct || 2);
        var histDecimals = entryHist >= 1 ? 4 : entryHist >= 0.01 ? 6 : entryHist >= 0.0001 ? 8 : 10;
        var tpHist = entryHist * (1 + targetHist / 100);
        var slHist = entryHist * (1 - riskHist / 100);

        html += '<tr>';
        html += '<td>' + pair + '</td>';
        html += '<td>' + tierBadge(h.tier) + '</td>';
        html += '<td>' + h.score + '</td>';
        html += '<td>$' + entryHist.toFixed(histDecimals) + '</td>';
        html += '<td style="font-size:10px;"><span style="color:var(--green);">$' + tpHist.toFixed(histDecimals) + '</span><br><span style="color:var(--red);">$' + slHist.toFixed(histDecimals) + '</span></td>';
        html += '<td>' + (h.price_at_resolve ? '$' + parseFloat(h.price_at_resolve).toFixed(histDecimals) : '--') + '</td>';
        html += '<td>' + (h.pnl_pct !== null ? formatPnl(h.pnl_pct) : '--') + '</td>';
        html += '<td class="' + outcomeClass + '">' + (h.outcome || 'pending') + '</td>';
        html += '<td>' + (h.created_at || '').substring(5, 16) + '</td>';
        html += '</tr>';
    }
    html += '</table>';
    document.getElementById('history-list').innerHTML = html;
}

// Scan Log
function factorClass(score, max) {
    var pct = (score / max) * 100;
    if (pct >= 70) return 'f-high';
    if (pct >= 40) return 'f-mid';
    return 'f-low';
}

function renderScanLog(data) {
    if (!data.ok || data.count === 0) {
        document.getElementById('scan-log-list').innerHTML = '<div class="loading">No scan log data yet. Log is populated after the next scan runs.</div>';
        return;
    }

    var picker = document.getElementById('scan-picker');
    if (data.recent_scans && data.recent_scans.length > 0 && picker.options.length <= 1) {
        picker.innerHTML = '';
        for (var s = 0; s < data.recent_scans.length; s++) {
            var sc = data.recent_scans[s];
            var label = (sc.created_at || '').substring(0, 16) + ' UTC — ' + sc.analyzed + ' analyzed, ' + sc.winners + ' winners';
            var opt = document.createElement('option');
            opt.value = sc.scan_id;
            opt.textContent = label;
            if (s === 0) opt.selected = true;
            picker.appendChild(opt);
        }
    }

    var log = data.log;
    var winnersInLog = 0;
    for (var m = 0; m < log.length; m++) { if (log[m].score >= 70) winnersInLog++; }
    document.getElementById('scan-meta').textContent = log.length + ' memes analyzed, ' + winnersInLog + ' passed threshold (70+)';

    var html = '<table class="scan-log-table">';
    html += '<tr><th>#</th><th>Pair</th><th>Tier</th><th>Score</th><th>Decision</th>';
    html += '<th>Expl Vol<br>0-25</th><th>Mom<br>0-20</th><th>RSI<br>0-15</th><th>Social<br>0-15</th><th>Vol Conc<br>0-10</th><th>Break<br>0-10</th><th>Cap<br>0-5</th>';
    html += '<th>24h Chg</th><th>Volume</th></tr>';

    for (var i = 0; i < log.length; i++) {
        var r = log[i];
        var f = r.factors_json || {};
        var pair = (r.pair || '').replace('_USDT', '/USDT');
        var rowClass = r.score >= 70 ? ' class="is-winner"' : '';

        var vd = '';
        if (r.verdict === 'STRONG_BUY') vd = '<span class="badge badge-strong">Strong Buy</span>';
        else if (r.verdict === 'BUY') vd = '<span class="badge badge-buy">Buy</span>';
        else if (r.verdict === 'LEAN_BUY') vd = '<span class="badge badge-lean">Lean Buy</span>';
        else vd = '<span class="verdict-skip">Skip</span>';

        var scColor = r.score >= 85 ? 'accent' : r.score >= 75 ? 'gold' : r.score >= 70 ? 'cyan' : 'dim';

        var factors = [
            {key: 'explosive_volume', max: 25},
            {key: 'parabolic_momentum', max: 20},
            {key: 'rsi_hype_zone', max: 15},
            {key: 'social_proxy', max: 15},
            {key: 'volume_concentration', max: 10},
            {key: 'breakout_4h', max: 10},
            {key: 'low_cap_bonus', max: 5}
        ];

        html += '<tr' + rowClass + '>';
        html += '<td style="color:var(--dim)">' + (i + 1) + '</td>';
        html += '<td style="font-weight:600;color:#fff">' + pair + '</td>';
        html += '<td>' + tierBadge(r.tier) + '</td>';
        html += '<td><span class="' + scColor + '" style="font-weight:700">' + r.score + '</span></td>';
        html += '<td>' + vd + '</td>';

        for (var j = 0; j < factors.length; j++) {
            var fk = factors[j].key;
            var fm = factors[j].max;
            if (f[fk]) {
                var fs = f[fk].score;
                html += '<td><span class="factor-cell ' + factorClass(fs, fm) + '">' + fs + '/' + fm + '</span></td>';
            } else {
                html += '<td><span class="factor-cell f-low">0/' + fm + '</span></td>';
            }
        }

        html += '<td>' + formatPnl(r.chg_24h) + '</td>';
        html += '<td style="color:var(--dim)">$' + (parseFloat(r.vol_usd_24h || 0) / 1000).toFixed(0) + 'K</td>';
        html += '</tr>';
    }
    html += '</table>';
    document.getElementById('scan-log-list').innerHTML = html;
}

function loadScanLog(scanId) {
    var q = 'scan_log';
    if (scanId) q += '&scan_id=' + scanId;
    api(q, function(data) {
        if (scanId) {
            var picker = document.getElementById('scan-picker');
            var tempPicker = picker.innerHTML;
            renderScanLog(data);
            picker.innerHTML = tempPicker;
            for (var k = 0; k < picker.options.length; k++) {
                if (picker.options[k].value === scanId) { picker.options[k].selected = true; break; }
            }
        } else {
            renderScanLog(data);
        }
    });
}

// ── Daily Picks ──
function renderDailyPicks(data) {
    if (!data.ok || data.total_picks === 0) {
        document.getElementById('daily-picks-list').innerHTML = '<div class="loading">No picks for this date.</div>';
        document.getElementById('picks-summary').innerHTML = '';
        return;
    }

    // Populate date picker
    var picker = document.getElementById('picks-date');
    if (data.available_dates && data.available_dates.length > 0 && picker.options.length <= 1) {
        picker.innerHTML = '';
        for (var d = 0; d < data.available_dates.length; d++) {
            var dt = data.available_dates[d];
            var opt = document.createElement('option');
            opt.value = dt.pick_date;
            opt.textContent = dt.pick_date + ' (' + dt.cnt + ' picks)';
            if (dt.pick_date === data.date) opt.selected = true;
            picker.appendChild(opt);
        }
    }

    // Day summary
    var ds = data.day_summary || {};
    var sumHtml = '';
    sumHtml += '<span>Picks: <strong style="color:#fff">' + (ds.total_picks || 0) + '</strong></span>';
    if (ds.win_rate !== null) {
        var wrCls = ds.win_rate >= 60 ? 'green' : ds.win_rate >= 50 ? 'gold' : 'red';
        sumHtml += '<span>Win Rate: <strong class="' + wrCls + '">' + ds.win_rate + '%</strong></span>';
    }
    sumHtml += '<span>Wins: <strong class="green">' + (ds.wins || 0) + '</strong> / Losses: <strong class="red">' + (ds.losses || 0) + '</strong></span>';
    if (ds.pending > 0) sumHtml += '<span>Pending: ' + ds.pending + '</span>';
    if (ds.avg_pnl !== null) sumHtml += '<span>Avg P&L: ' + formatPnl(ds.avg_pnl) + '</span>';
    if (ds.best_trade) sumHtml += '<span>Best: <strong class="green">+' + parseFloat(ds.best_trade).toFixed(1) + '%</strong></span>';
    document.getElementById('picks-summary').innerHTML = sumHtml;
    document.getElementById('picks-date-label').textContent = data.date;

    // Picks table
    var html = '<table class="history-table"><tr><th>Time (UTC)</th><th>Pair</th><th>Tier</th><th>Score</th><th>Verdict</th><th>Entry</th><th>Target</th><th>P&L</th><th>Outcome</th></tr>';
    for (var i = 0; i < data.picks.length; i++) {
        var p = data.picks[i];
        var pair = (p.pair || '').replace('_USDT', '/USDT');
        var time = (p.created_at || '').substring(11, 16);
        var outClass = '';
        if (p.outcome === 'win' || p.outcome === 'partial_win') outClass = 'outcome-win';
        else if (p.outcome === 'loss' || p.outcome === 'partial_loss') outClass = 'outcome-loss';
        else outClass = 'outcome-pending';

        html += '<tr>';
        html += '<td style="color:var(--dim)">' + time + '</td>';
        html += '<td style="font-weight:600;color:#fff">' + pair + '</td>';
        html += '<td>' + tierBadge(p.tier) + '</td>';
        html += '<td>' + p.score + '</td>';
        html += '<td>' + verdictBadge(p.verdict) + '</td>';
        html += '<td>$' + parseFloat(p.price_at_signal || 0).toFixed(6) + '</td>';
        html += '<td>+' + p.target_pct + '% / -' + p.risk_pct + '%</td>';
        html += '<td>' + (p.pnl_pct !== null ? formatPnl(p.pnl_pct) : '--') + '</td>';
        html += '<td class="' + outClass + '">' + (p.outcome || 'pending') + '</td>';
        html += '</tr>';
    }
    html += '</table>';
    document.getElementById('daily-picks-list').innerHTML = html;
}

function loadDailyPicks(date) {
    var q = 'daily_picks';
    if (date) q += '&date=' + date;
    api(q, function(data) {
        if (date) {
            var picker = document.getElementById('picks-date');
            var saved = picker.innerHTML;
            renderDailyPicks(data);
            picker.innerHTML = saved;
            for (var k = 0; k < picker.options.length; k++) {
                if (picker.options[k].value === date) { picker.options[k].selected = true; break; }
            }
        } else {
            renderDailyPicks(data);
        }
    });
}

// ── Performance Tracker ──
function renderPerformance(data) {
    if (!data.ok) {
        document.getElementById('perf-summary').innerHTML = '<div class="loading">No performance data yet.</div>';
        return;
    }

    var s = data.summary || {};
    var streaks = data.streaks || {};

    // Summary cards
    var cards = '';
    var wrCls = s.win_rate >= 60 ? 'green' : s.win_rate >= 50 ? 'gold' : 'red';
    cards += '<div class="perf-card"><div class="p-label">Win Rate</div><div class="p-val ' + (s.win_rate !== null ? wrCls : '') + '">' + (s.win_rate !== null ? s.win_rate + '%' : '--') + '</div><div class="p-sub">' + (s.resolved || 0) + ' resolved</div></div>';
    cards += '<div class="perf-card"><div class="p-label">Avg P&L</div><div class="p-val">' + (s.avg_pnl !== null ? formatPnl(s.avg_pnl) : '--') + '</div><div class="p-sub">per signal</div></div>';
    cards += '<div class="perf-card"><div class="p-label">Total P&L</div><div class="p-val">' + (s.total_pnl !== null ? formatPnl(s.total_pnl) : '--') + '</div><div class="p-sub">' + (s.total_signals || 0) + ' signals</div></div>';
    cards += '<div class="perf-card"><div class="p-label">Best Trade</div><div class="p-val green">' + (s.best_trade ? '+' + parseFloat(s.best_trade).toFixed(1) + '%' : '--') + '</div><div class="p-sub">Worst: ' + (s.worst_trade ? parseFloat(s.worst_trade).toFixed(1) + '%' : '--') + '</div></div>';
    cards += '<div class="perf-card"><div class="p-label">Active Days</div><div class="p-val cyan">' + (s.active_days || 0) + '</div><div class="p-sub">' + (s.unique_coins || 0) + ' coins</div></div>';
    cards += '<div class="perf-card"><div class="p-label">Win Streak</div><div class="p-val green">' + (streaks.max_win || 0) + '</div><div class="p-sub">Current: ' + (streaks.current || 0) + (streaks.current_type || '') + '</div></div>';
    cards += '<div class="perf-card"><div class="p-label">Loss Streak</div><div class="p-val red">' + (streaks.max_loss || 0) + '</div><div class="p-sub">max consecutive</div></div>';

    // Significance badge
    var sig = s.significance || {};
    var sigLabel = sig.confidence || 'insufficient_data';
    var sigColor = sigLabel === 'highly_significant' ? 'green' : sigLabel === 'significant' ? 'cyan' : sigLabel === 'trending_positive' ? 'gold' : 'dim';
    cards += '<div class="perf-card"><div class="p-label">Significance</div><div class="p-val ' + sigColor + '" style="font-size:12px">' + sigLabel.replace(/_/g, ' ') + '</div><div class="p-sub">' + (sig.sample_size || 0) + ' samples</div></div>';
    document.getElementById('perf-summary').innerHTML = cards;

    // Daily breakdown table
    var daily = data.daily || [];
    if (daily.length === 0) {
        document.getElementById('perf-daily').innerHTML = '<div class="loading">No daily data yet.</div>';
    } else {
        var html = '<table class="daily-table"><tr><th>Date</th><th>Signals</th><th>W</th><th>L</th><th>Win Rate</th><th>Avg P&L</th><th>Best</th><th>Worst</th><th>Coins</th></tr>';
        for (var i = 0; i < Math.min(daily.length, 30); i++) {
            var d = daily[i];
            var dWr = d.win_rate !== null ? d.win_rate : '--';
            var dWrCls = d.win_rate >= 60 ? 'green' : d.win_rate >= 50 ? 'gold' : d.win_rate !== null ? 'red' : '';
            html += '<tr>';
            html += '<td style="color:#fff">' + d.trade_date + '</td>';
            html += '<td>' + d.signals + '</td>';
            html += '<td class="green">' + d.wins + '</td>';
            html += '<td class="red">' + d.losses + '</td>';
            html += '<td class="' + dWrCls + '">' + (dWr !== '--' ? dWr + '%' : '--') + '</td>';
            html += '<td>' + (d.avg_pnl !== null ? formatPnl(d.avg_pnl) : '--') + '</td>';
            html += '<td class="green">' + (d.best_trade ? '+' + parseFloat(d.best_trade).toFixed(1) + '%' : '--') + '</td>';
            html += '<td class="red">' + (d.worst_trade ? parseFloat(d.worst_trade).toFixed(1) + '%' : '--') + '</td>';
            html += '<td>' + d.unique_coins + '</td>';
            html += '</tr>';
        }
        html += '</table>';
        document.getElementById('perf-daily').innerHTML = html;
    }

    // Top coins
    var top = data.top_coins || [];
    if (top.length === 0) {
        document.getElementById('perf-top-coins').innerHTML = '<div class="loading">No coin data yet.</div>';
    } else {
        var html2 = '<table class="daily-table"><tr><th>Coin</th><th>Tier</th><th>Signals</th><th>Win Rate</th><th>Avg P&L</th><th>Best</th><th>Days Active</th></tr>';
        for (var j = 0; j < top.length; j++) {
            var c = top[j];
            var cPair = (c.pair || '').replace('_USDT', '/USDT');
            var cWr = c.win_rate !== null ? c.win_rate + '%' : '--';
            var cWrCls = c.win_rate >= 60 ? 'green' : c.win_rate >= 50 ? 'gold' : 'red';
            html2 += '<tr>';
            html2 += '<td style="font-weight:600;color:#fff">' + cPair + '</td>';
            html2 += '<td>' + tierBadge(c.tier) + '</td>';
            html2 += '<td>' + c.signals + '</td>';
            html2 += '<td class="' + cWrCls + '">' + cWr + '</td>';
            html2 += '<td>' + (c.avg_pnl !== null ? formatPnl(c.avg_pnl) : '--') + '</td>';
            html2 += '<td class="green">' + (c.best_trade ? '+' + parseFloat(c.best_trade).toFixed(1) + '%' : '--') + '</td>';
            html2 += '<td>' + (c.days_active || 0) + '</td>';
            html2 += '</tr>';
        }
        html2 += '</table>';
        document.getElementById('perf-top-coins').innerHTML = html2;
    }
}

function loadPerf(period, btn) {
    // Update tab active state
    var tabs = document.querySelectorAll('#perf-tabs .tab-btn');
    for (var t = 0; t < tabs.length; t++) tabs[t].className = 'tab-btn';
    if (btn) btn.className = 'tab-btn active';

    api('performance&period=' + period, renderPerformance);
}

// ── Data Freshness Tracker ──
var lastScanTime = null;
function updateFreshness(statsData) {
    if (!statsData || !statsData.ok || !statsData.stats) return;
    var s = statsData.stats;
    if (s.last_scan) {
        lastScanTime = new Date(s.last_scan.replace(' ', 'T') + 'Z');
    }
    refreshFreshnessUI();
}

function refreshFreshnessUI() {
    var bar = document.getElementById('freshness-bar');
    var text = document.getElementById('freshness-text');
    var time = document.getElementById('freshness-time');
    if (!bar || !lastScanTime) return;

    var ageMs = Date.now() - lastScanTime.getTime();
    var ageMin = Math.floor(ageMs / 60000);
    var ageSec = Math.floor((ageMs % 60000) / 1000);

    bar.className = 'freshness-bar';
    if (ageMin < 5) {
        bar.classList.add('freshness-fresh');
        text.innerHTML = '<strong style="color:#22c55e">LIVE</strong> &mdash; Data is fresh (' + ageMin + 'm ' + ageSec + 's ago)';
    } else if (ageMin < 15) {
        bar.classList.add('freshness-aging');
        text.innerHTML = '<strong style="color:#f59e0b">AGING</strong> &mdash; Last scan ' + ageMin + ' minutes ago. Verify prices before acting.';
    } else {
        bar.classList.add('freshness-stale');
        text.innerHTML = '<strong style="color:#ef4444">STALE</strong> &mdash; Last scan ' + ageMin + ' minutes ago. Prices may have moved significantly.';
    }
    time.textContent = lastScanTime.toISOString().substring(11, 19) + ' UTC';
}
// Update freshness clock every 10 seconds
setInterval(refreshFreshnessUI, 10000);

// Wrap original renderStats to also update freshness
var _origRenderStats = renderStats;
renderStats = function(data) {
    _origRenderStats(data);
    updateFreshness(data);
};

// ── Price Verification Modal ──
var PRICE_CHECK_API = '/findcryptopairs/api/price_check.php';

function openVerifyModal(idx) {
    var w = window.currentWinners[idx];
    if (!w) return;

    var overlay = document.getElementById('verify-overlay');
    var title = document.getElementById('verify-title');
    var body = document.getElementById('verify-body');

    var pair = (w.pair || '').replace('_USDT', '/USDT');
    title.textContent = 'Verify: ' + pair;
    body.innerHTML = '<div class="loading">Fetching live price across 7 sources (Crypto.com, Binance, KuCoin, Gate.io, MEXC, CoinGecko, DexScreener)...</div>';
    overlay.classList.add('active');

    // Auto-fetch live price
    var url = PRICE_CHECK_API + '?action=verify&pair=' + encodeURIComponent(w.pair) +
        '&signal_price=' + w.price_at_signal +
        '&target_pct=' + w.target_pct +
        '&risk_pct=' + w.risk_pct;

    var x = new XMLHttpRequest();
    x.open('GET', url);
    x.onload = function() {
        try {
            var r = JSON.parse(x.responseText);
            renderVerifyResult(r, w, idx);
        } catch(e) {
            body.innerHTML = '<div style="color:var(--red);text-align:center;padding:20px">Failed to fetch price. Use manual input below.</div>' + manualInputHtml(w, idx);
        }
    };
    x.onerror = function() {
        body.innerHTML = '<div style="color:var(--red);text-align:center;padding:20px">Network error. Use manual input below.</div>' + manualInputHtml(w, idx);
    };
    x.send();
}

function renderVerifyResult(r, w, idx) {
    var body = document.getElementById('verify-body');
    if (!r.ok) {
        var sourcesTried = (r.sources_tried || []).join(', ') || 'unknown';
        body.innerHTML = '<div style="color:var(--red);text-align:center;padding:20px">' + (r.error || 'Price fetch failed') + '</div>' +
            '<div style="color:var(--dim);text-align:center;font-size:11px;margin-bottom:12px">Sources tried: ' + sourcesTried + '</div>' +
            manualInputHtml(w, idx);
        return;
    }

    var entryPrice = parseFloat(w.price_at_signal || 0);
    var priceDecimals = entryPrice >= 1 ? 4 : entryPrice >= 0.01 ? 6 : entryPrice >= 0.0001 ? 8 : 10;

    var verdictClass = 'verdict-green';
    if (r.verdict === 'INVALIDATED') verdictClass = 'verdict-red';
    else if (r.verdict === 'CAUTION') verdictClass = 'verdict-yellow';

    var html = '';
    html += '<div class="verify-verdict ' + verdictClass + '">';
    html += r.verdict.replace('_', ' ');
    html += '<div style="font-size:12px;font-weight:400;margin-top:4px">' + r.verdict_detail + '</div>';
    html += '</div>';

    html += '<div class="verify-row"><span class="vr-label">Signal Price</span><span class="vr-value">$' + entryPrice.toFixed(priceDecimals) + '</span></div>';
    html += '<div class="verify-row"><span class="vr-label">Current Price</span><span class="vr-value" style="color:' + (r.price_change_pct >= 0 ? 'var(--green)' : 'var(--red)') + '">$' + parseFloat(r.current_price).toFixed(priceDecimals) + '</span></div>';
    html += '<div class="verify-row"><span class="vr-label">Price Change</span><span class="vr-value" style="color:' + (r.price_change_pct >= 0 ? 'var(--green)' : 'var(--red)') + '">' + (r.price_change_pct >= 0 ? '+' : '') + r.price_change_pct.toFixed(2) + '%</span></div>';
    html += '<div class="verify-row"><span class="vr-label">Remaining Upside</span><span class="vr-value">' + r.remaining_upside_pct.toFixed(2) + '%</span></div>';
    html += '<div class="verify-row"><span class="vr-label">New R:R</span><span class="vr-value">1:' + r.new_rr_ratio + '</span></div>';
    html += '<div class="verify-row"><span class="vr-label">Target Price</span><span class="vr-value" style="color:var(--green)">$' + parseFloat(r.target_price).toFixed(priceDecimals) + '</span></div>';
    html += '<div class="verify-row"><span class="vr-label">Stop Price</span><span class="vr-value" style="color:var(--red)">$' + parseFloat(r.stop_price).toFixed(priceDecimals) + '</span></div>';
    html += '<div class="verify-row"><span class="vr-label">Source</span><span class="vr-value" style="color:var(--dim)">' + r.price_source + ' (' + r.latency_ms + 'ms)</span></div>';
    html += '<div class="verify-row"><span class="vr-label">Checked at</span><span class="vr-value" style="color:var(--dim);font-size:11px">' + r.timestamp + '</span></div>';

    // Disclaimer
    html += '<div style="margin-top:12px;font-size:10px;color:#555;text-align:center">This is a momentum pattern detector, not a buy recommendation. Not financial advice.</div>';

    // Manual input section
    html += manualInputHtml(w, idx);

    body.innerHTML = html;
}

function manualInputHtml(w, idx) {
    return '<div class="verify-manual">' +
        '<label>Or enter the price you see on your exchange:</label>' +
        '<input type="number" id="manual-price-input" step="0.000001" placeholder="e.g. 0.1823">' +
        '<button class="vm-btn" onclick="verifyManualPrice(' + idx + ')">Verify This Price</button>' +
        '</div>';
}

function verifyManualPrice(idx) {
    var w = window.currentWinners[idx];
    if (!w) return;

    var inputEl = document.getElementById('manual-price-input');
    var userPrice = parseFloat(inputEl.value);
    if (!userPrice || userPrice <= 0) {
        inputEl.style.borderColor = 'var(--red)';
        return;
    }
    inputEl.style.borderColor = 'var(--accent)';

    var body = document.getElementById('verify-body');
    body.innerHTML = '<div class="loading">Verifying with your price...</div>';

    var url = PRICE_CHECK_API + '?action=verify&pair=' + encodeURIComponent(w.pair) +
        '&signal_price=' + w.price_at_signal +
        '&target_pct=' + w.target_pct +
        '&risk_pct=' + w.risk_pct +
        '&user_price=' + userPrice;

    var x = new XMLHttpRequest();
    x.open('GET', url);
    x.onload = function() {
        try {
            var r = JSON.parse(x.responseText);
            renderVerifyResult(r, w, idx);
        } catch(e) {
            body.innerHTML = '<div style="color:var(--red)">Verification failed.</div>' + manualInputHtml(w, idx);
        }
    };
    x.onerror = function() {
        body.innerHTML = '<div style="color:var(--red)">Network error.</div>' + manualInputHtml(w, idx);
    };
    x.send();
}

function closeVerifyModal() {
    document.getElementById('verify-overlay').classList.remove('active');
}

// ── Hide Invalidated toggle — on by default ──
var hideInvalidated = true;
// Apply default state on load
document.getElementById('winners-list').parentNode.classList.add('hide-invalidated');

function toggleHideInvalidated() {
    hideInvalidated = !hideInvalidated;
    var toggle = document.getElementById('hide-invalid-toggle');
    var label = document.getElementById('hide-invalid-label');
    var wrapper = document.getElementById('winners-list');

    if (hideInvalidated) {
        toggle.classList.add('active');
        label.classList.add('active');
        label.textContent = 'Hide Invalidated: ON';
        if (wrapper && wrapper.parentNode) wrapper.parentNode.classList.add('hide-invalidated');
    } else {
        toggle.classList.remove('active');
        label.classList.remove('active');
        label.textContent = 'Hide Invalidated: OFF';
        if (wrapper && wrapper.parentNode) wrapper.parentNode.classList.remove('hide-invalidated');
    }
    updateHiddenCount();
}

function updateHiddenCount() {
    var cards = document.querySelectorAll('.winner-card.card-invalidated');
    var status = document.getElementById('live-status');
    if (cards.length > 0 && hideInvalidated && status) {
        status.textContent = cards.length + ' invalidated signal' + (cards.length > 1 ? 's' : '') + ' hidden';
    }
}

// ── Live Mode — polls live prices for active winners ──
var liveModeActive = false;
var liveModeInterval = null;

function toggleLiveMode() {
    liveModeActive = !liveModeActive;
    var toggle = document.getElementById('live-toggle');
    var label = document.getElementById('live-label');
    var status = document.getElementById('live-status');

    if (liveModeActive) {
        toggle.classList.add('active');
        label.innerHTML = '<span class="live-pulse"></span> Live Price Updates: ON';
        label.classList.add('active');
        status.textContent = 'Updating every 30s...';
        fetchLivePrices();
        liveModeInterval = setInterval(fetchLivePrices, 30000);
    } else {
        toggle.classList.remove('active');
        label.textContent = 'Live Price Updates: OFF';
        label.classList.remove('active');
        status.textContent = '';
        if (liveModeInterval) clearInterval(liveModeInterval);
        liveModeInterval = null;
        // Hide all live price slots
        for (var h = 0; h < window.currentWinners.length; h++) {
            var slot = document.getElementById('live-price-' + h);
            if (slot) slot.style.display = 'none';
        }
    }
}

function fetchLivePrices() {
    if (!window.currentWinners || window.currentWinners.length === 0) return;
    var pairs = [];
    for (var p = 0; p < Math.min(window.currentWinners.length, 10); p++) {
        pairs.push(window.currentWinners[p].pair);
    }

    var url = PRICE_CHECK_API + '?action=batch_price&pairs=' + pairs.join(',');
    var x = new XMLHttpRequest();
    x.open('GET', url);
    x.onload = function() {
        try {
            var r = JSON.parse(x.responseText);
            if (r.ok && r.prices) {
                var status = document.getElementById('live-status');
                status.textContent = 'Updated ' + new Date().toLocaleTimeString();
                for (var li = 0; li < r.prices.length; li++) {
                    updateLivePriceSlot(li, r.prices[li]);
                }
            }
        } catch(e) { /* silent fail */ }
    };
    x.send();
}

function updateLivePriceSlot(idx, priceData) {
    var slot = document.getElementById('live-price-' + idx);
    if (!slot || !priceData.price) return;

    var w = window.currentWinners[idx];
    if (!w) return;

    var entry = parseFloat(w.price_at_signal || 0);
    var targetPct = parseFloat(w.target_pct || 0);
    var riskPct = parseFloat(w.risk_pct || 0);
    var current = parseFloat(priceData.price);
    var changePct = entry > 0 ? ((current - entry) / entry * 100) : 0;
    var priceDecimals = entry >= 1 ? 4 : entry >= 0.01 ? 6 : entry >= 0.0001 ? 8 : 10;
    var remainingUp = targetPct - changePct;

    var color = changePct >= 0 ? 'var(--green)' : 'var(--red)';
    var statusText = '';
    if (changePct > targetPct * 0.8) statusText = '<span style="color:var(--red);font-weight:700">TARGET NEARLY HIT</span>';
    else if (changePct < -riskPct) statusText = '<span style="color:var(--red);font-weight:700">STOP HIT</span>';
    else if (changePct > targetPct * 0.5) statusText = '<span style="color:var(--gold)">Approaching target</span>';
    else statusText = '<span style="color:var(--green)">Signal active</span>';

    slot.style.display = 'block';
    slot.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px">' +
        '<span><strong style="color:var(--cyan)">LIVE:</strong> $' + current.toFixed(priceDecimals) + ' <span style="color:' + color + '">(' + (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%)</span></span>' +
        '<span>' + statusText + '</span>' +
        '<span style="color:var(--dim)">Upside left: ' + remainingUp.toFixed(1) + '% | via ' + priceData.source + '</span>' +
        '</div>';
}

// Load all data
api('stats', renderStats);
api('winners', renderWinners);
api('leaderboard', renderLeaderboard);
api('history&limit=50', renderHistory);
loadScanLog('');
loadDailyPicks('');
loadPerf('all', null);

// Auto-refresh every 90 seconds (memes move fast)
setInterval(function() {
    api('winners', renderWinners);
    api('stats', renderStats);
}, 90000);
</script>
<script src="/findstocks/portfolio2/stock-nav.js"></script>
<script src="/live-monitor/api/scope_labels.js"></script>
</body>
</html>
