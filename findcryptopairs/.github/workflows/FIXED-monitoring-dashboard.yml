name: âœ… FIXED â€” Monitoring Dashboard Data Refresh

on:
  schedule:
    # Every 15 minutes during market hours (6 AM - 11 PM UTC)
    - cron: '*/15 6-23 * * *'
    # Every 4 hours overnight
    - cron: '0 */4 0-5 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no data changes'
        required: false
        default: false
        type: boolean

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    # â”€â”€â”€ Step 1: Checkout with full history â”€â”€â”€
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 10
    
    # â”€â”€â”€ Step 2: Setup Python â”€â”€â”€
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # â”€â”€â”€ Step 3: Install dependencies â”€â”€â”€
    - name: Install dependencies
      run: |
        pip install --quiet requests>=2.31 pytz
    
    # â”€â”€â”€ Step 4: Run data collector with logging â”€â”€â”€
    - name: Collect dashboard data
      id: collect
      env:
        API_BASE: ${{ secrets.API_BASE || 'https://findtorontoevents.ca' }}
      run: |
        echo "=========================================="
        echo "MONITORING DASHBOARD DATA COLLECTION"
        echo "Started: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "=========================================="
        
        # Run collector and capture output
        python monitoring/data_collector.py 2>&1 | tee collector.log
        
        # Check if successful
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âš ï¸ Collector had errors, using fallback data"
        fi
        
        echo ""
        echo "Log excerpt:"
        tail -20 collector.log
    
    # â”€â”€â”€ Step 5: ALWAYS update timestamp (guarantees file change) â”€â”€â”€
    - name: Ensure timestamp freshness
      run: |
        # Touch the file to update modification time
        # This ensures git sees a change even if content is identical
        python3 << 'PYTHON'
        import json
        from datetime import datetime, timezone
        
        try:
          with open('monitoring/data/dashboard.json', 'r') as f:
            data = json.load(f)
        except:
          data = {}
        
        # Always update the main timestamp
        data['timestamp'] = datetime.now(timezone.utc).isoformat()
        data['_workflow_run'] = {
          'run_id': '${{ github.run_id }}',
          'run_number': '${{ github.run_number }}',
          'updated_at': datetime.now(timezone.utc).isoformat()
        }
        
        with open('monitoring/data/dashboard.json', 'w') as f:
          json.dump(data, f, indent=2)
        
        print(f"âœ… Timestamp updated: {data['timestamp']}")
        PYTHON
    
    # â”€â”€â”€ Step 6: Commit and push (ALWAYS, not just on changes) â”€â”€â”€
    - name: Commit changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Stage the file
        git add monitoring/data/dashboard.json
        
        # Check if we have changes to commit
        if git diff --cached --quiet; then
          echo "No content changes, but updating timestamp anyway..."
          # Force a no-op change to ensure commit
          echo "# Last updated: $(date -u)" > monitoring/data/.last_update
          git add monitoring/data/.last_update
        fi
        
        # Always commit with detailed message
        COMMIT_MSG="ğŸ“Š Dashboard: $(date -u '+%H:%M UTC') | Status: ${{ steps.collect.outputs.status }}"
        git commit -m "$COMMIT_MSG"
        
        # Push with retry
        for i in 1 2 3; do
          git pull --rebase origin main && git push && break
          echo "Push attempt $i failed, retrying..."
          sleep 5
        done
        
        echo "âœ… Dashboard update committed successfully"
    
    # â”€â”€â”€ Step 7: Deploy to GitHub Pages â”€â”€â”€
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./monitoring/dashboard
        destination_dir: monitoring
        keep_files: true
        enable_jekyll: false
    
    # â”€â”€â”€ Step 8: Notify on failure â”€â”€â”€
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          console.log('âŒ Dashboard update failed!');
          // Could trigger backup workflow here
    
    # â”€â”€â”€ Step 9: Upload logs for debugging â”€â”€â”€
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dashboard-logs-${{ github.run_number }}
        path: collector.log
        retention-days: 3
