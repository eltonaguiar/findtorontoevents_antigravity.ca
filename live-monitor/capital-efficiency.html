<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capital Efficiency Tracker | Find Toronto Events</title>
    <meta name="description" content="Capital Efficiency Tracker — fewer trades, higher quality, smarter sizing. Track algorithm efficiency, regime compliance, and trade quality across 20 algorithms.">
    <link rel="canonical" href="https://findtorontoevents.ca/live-monitor/capital-efficiency.html">
    <meta property="og:title" content="Capital Efficiency Tracker | Find Toronto Events">
    <meta property="og:description" content="Fewer trades, higher quality, smarter sizing. Track algorithm efficiency, regime compliance, and trade quality.">
    <meta property="og:url" content="https://findtorontoevents.ca/live-monitor/capital-efficiency.html">
    <meta property="og:site_name" content="Find Toronto Events">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Capital Efficiency Tracker | Find Toronto Events">
    <meta name="twitter:description" content="Fewer trades, higher quality, smarter sizing. Track algorithm efficiency and regime compliance.">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0e1a;
            --bg-card: #111827;
            --bg-card-hover: #1a2236;
            --border: #1e293b;
            --text: #e2e8f0;
            --text-dim: #8892a8;
            --text-bright: #fff;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --green: #10b981;
            --green-dim: rgba(16, 185, 129, 0.15);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #f59e0b;
            --yellow-dim: rgba(245, 158, 11, 0.15);
            --blue: #3b82f6;
            --blue-dim: rgba(59, 130, 246, 0.15);
            --orange: #f97316;
            --purple: #a855f7;
            --gold: #fbbf24;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #111827 0%, #1e293b 100%);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem 1rem;
            text-align: center;
        }
        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--green), var(--accent), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.3rem;
            letter-spacing: 0.5px;
        }
        .header p { color: var(--text-dim); font-size: 0.95rem; }
        .nav {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 0.8rem;
            font-size: 0.85rem;
            flex-wrap: wrap;
        }
        .nav a { color: var(--text-dim); }
        .nav a:hover { color: var(--text); text-decoration: none; }

        /* ===== CONTAINER ===== */
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        /* ===== KPI CARDS ===== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.2rem;
            text-align: center;
            transition: border-color 0.3s, transform 0.2s;
        }
        .kpi-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .kpi-card .kpi-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 0.3rem;
        }
        .kpi-card .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .kpi-card .kpi-sub {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }
        .kpi-card .kpi-change {
            font-size: 0.72rem;
            font-weight: 600;
            margin-top: 0.2rem;
        }
        .kpi-card .kpi-change.pos { color: var(--green); }
        .kpi-card .kpi-change.neg { color: var(--red); }

        /* ===== THESIS SECTION ===== */
        .thesis-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), rgba(16, 185, 129, 0.06));
            border: 1px solid rgba(99, 102, 241, 0.25);
            border-radius: var(--radius);
            padding: 1.8rem 2rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .thesis-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent), var(--green));
        }
        .thesis-card h2 {
            font-size: 1.1rem;
            color: var(--accent);
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .thesis-card h2 .icon { font-size: 1.2rem; }
        .thesis-card blockquote {
            font-size: 0.95rem;
            color: var(--text);
            line-height: 1.7;
            border: none;
            margin: 0;
            padding: 0;
            font-style: italic;
            margin-bottom: 1.2rem;
        }
        .thesis-card blockquote strong { color: var(--green); font-style: normal; }
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.8rem;
            margin-top: 1rem;
        }
        .article-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            padding: 0.8rem 1rem;
        }
        .article-item .article-num {
            font-size: 0.65rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }
        .article-item .article-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 0.2rem 0;
        }
        .article-item .article-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
            line-height: 1.5;
        }

        /* ===== SECTION / TABLE ===== */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .section h2 {
            font-size: 1.05rem;
            margin-bottom: 1rem;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-sub {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }
        .table-wrap {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        thead th {
            background: var(--bg-dark);
            color: var(--text-dim);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            font-weight: 600;
            padding: 0.6rem 0.8rem;
            text-align: left;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        tbody tr { border-top: 1px solid var(--border); }
        tbody tr:hover { background: var(--bg-card-hover); }
        td { padding: 0.55rem 0.8rem; white-space: nowrap; }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 0.15rem 0.55rem;
            border-radius: 6px;
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .badge-green { background: var(--green-dim); color: var(--green); }
        .badge-red { background: var(--red-dim); color: var(--red); }
        .badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
        .badge-blue { background: var(--blue-dim); color: var(--blue); }
        .badge-purple { background: rgba(168, 85, 247, 0.15); color: var(--purple); }

        /* ===== CHARTS ===== */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .chart-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
        }
        .chart-box h3 {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        canvas { max-height: 350px; }

        /* ===== REGIME COMPLIANCE ===== */
        .compliance-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .compliance-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.2rem;
            text-align: center;
        }
        .compliance-card .cc-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }
        .compliance-card .cc-trades {
            font-size: 1.6rem;
            font-weight: 700;
        }
        .compliance-card .cc-winrate {
            font-size: 0.85rem;
            margin-top: 0.3rem;
        }
        .compliance-card.with-regime { border-left: 3px solid var(--green); }
        .compliance-card.against-regime { border-left: 3px solid var(--red); }
        .compliance-card.no-regime { border-left: 3px solid var(--text-dim); }

        /* ===== LOADING / ERROR ===== */
        .loading { text-align: center; padding: 3rem; color: var(--text-dim); }
        .error-box {
            background: var(--red-dim);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #fca5a5;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* ===== REFRESH INFO ===== */
        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 1rem;
            padding: 0.5rem 0.8rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .refresh-bar .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .refresh-bar .status-dot.live { background: var(--green); box-shadow: 0 0 6px var(--green); }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
            font-size: 0.78rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            .compliance-grid { grid-template-columns: 1fr; }
            .articles-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.5rem; }
            .container { padding: 1rem; }
            .thesis-card { padding: 1.2rem; }
        }
        @media (max-width: 480px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .nav { gap: 0.8rem; }
        }
    </style>
</head>
<body>

    <!-- ===== HEADER ===== -->
    <div class="header">
        <h1>Capital Efficiency Tracker</h1>
        <p>Fewer Trades. Higher Quality. Smarter Sizing.</p>
        <div class="nav">
            <a href="live-monitor.html">Live Monitor</a>
            <a href="algo-performance.html">Algo Performance</a>
            <a href="edge-dashboard.html">Edge Finder</a>
            <a href="winning-patterns.html">Winning Patterns</a>
            <a href="smart-money.html">Smart Money</a>
            <a href="goldmine-dashboard.html">Goldmine</a>
            <a href="/investments/">All Investments</a>
        </div>
    </div>

    <div class="container">

        <!-- Refresh Bar -->
        <div class="refresh-bar">
            <span><span class="status-dot live"></span> Auto-refresh every 5 minutes</span>
            <span id="lastRefresh">Loading...</span>
        </div>

        <!-- ===== KPI CARDS ===== -->
        <div class="kpi-grid" id="kpiGrid">
            <div class="kpi-card">
                <div class="kpi-label">Quality Score</div>
                <div class="kpi-value" id="kpiQuality">--</div>
                <div class="kpi-sub">WR x Avg Win / |Avg Loss|</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Capital Efficiency</div>
                <div class="kpi-value" id="kpiEfficiency">--</div>
                <div class="kpi-sub">Total PnL / Risk Deployed</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Trade Count (30d)</div>
                <div class="kpi-value" id="kpiTradeCount">--</div>
                <div class="kpi-sub" id="kpiTradeCountSub">vs. prior period</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Regime Compliance</div>
                <div class="kpi-value" id="kpiRegime">--</div>
                <div class="kpi-sub">trades respecting regime gate</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Avg Trade Duration</div>
                <div class="kpi-value" id="kpiDuration">--</div>
                <div class="kpi-sub">hours avg hold</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active Algorithms</div>
                <div class="kpi-value" id="kpiActiveAlgos">--</div>
                <div class="kpi-sub">with trades in last 7d</div>
            </div>
        </div>

        <!-- ===== THE THESIS ===== -->
        <div class="thesis-card">
            <h2><span class="icon">&#9670;</span> The Thesis: Capital Efficiency Over Alpha</h2>
            <blockquote>
                "You don't have an alpha problem. You have a capital efficiency + portfolio construction problem.
                Your <strong>70.5% signal win rate rivals Renaissance Technologies</strong>. The path to beating the
                market isn't more algorithms &mdash; it's fewer trades, higher quality, smarter sizing, and hard
                regime discipline."
            </blockquote>
            <p style="font-size:0.8rem; color:var(--text-dim); margin-bottom:0.8rem;">
                This insight emerged from a 4-article deep audit of the live trading system:
            </p>
            <div class="articles-grid">
                <div class="article-item">
                    <div class="article-num">Article 1</div>
                    <div class="article-title">The Signal Quality Audit</div>
                    <div class="article-desc">Revealed 70.5% raw signal accuracy across 20 algorithms &mdash; comparable to top-tier quant funds. The alpha is real.</div>
                </div>
                <div class="article-item">
                    <div class="article-num">Article 2</div>
                    <div class="article-title">Capital Deployment Analysis</div>
                    <div class="article-desc">Showed capital being spread across too many simultaneous positions, diluting the edge of high-conviction setups.</div>
                </div>
                <div class="article-item">
                    <div class="article-num">Article 3</div>
                    <div class="article-title">Regime Compliance Deep Dive</div>
                    <div class="article-desc">Trades taken against regime signals had dramatically lower win rates. Regime gating alone could boost PnL 20-40%.</div>
                </div>
                <div class="article-item">
                    <div class="article-num">Article 4</div>
                    <div class="article-title">Portfolio Construction Roadmap</div>
                    <div class="article-desc">Prescribed fewer trades, higher conviction thresholds, algorithm orthogonality scoring, and position sizing reform.</div>
                </div>
            </div>
        </div>

        <!-- ===== ALGORITHM EFFICIENCY TABLE ===== -->
        <div class="section">
            <h2>&#9632; Algorithm Efficiency Scorecard</h2>
            <p class="section-sub">Sorted by Quality Score. Green = efficient, Yellow = review, Red = wasteful.</p>
            <div class="table-wrap" style="max-height:550px; overflow-y:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Algorithm</th>
                            <th>Trades (30d)</th>
                            <th>Win Rate</th>
                            <th>Avg PnL %</th>
                            <th>Quality Score</th>
                            <th>Capital Efficiency</th>
                            <th>Best Trade</th>
                            <th>Worst Trade</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="algoTbody">
                        <tr><td colspan="9" class="loading">Loading algorithm data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== CHARTS ===== -->
        <div class="charts-row">
            <div class="chart-box">
                <h3>Trade Quality Over Time (7-Day Rolling)</h3>
                <canvas id="qualityChart"></canvas>
            </div>
            <div class="chart-box">
                <h3>Algorithm Orthogonality (Independence Score)</h3>
                <canvas id="orthogonalityChart"></canvas>
            </div>
        </div>

        <!-- ===== REGIME COMPLIANCE ===== -->
        <div class="section">
            <h2>&#9670; Regime Compliance Breakdown</h2>
            <p class="section-sub">How trades perform when they respect vs ignore the regime gate.</p>
            <div class="compliance-grid" id="complianceGrid">
                <div class="compliance-card with-regime">
                    <div class="cc-label">With Regime</div>
                    <div class="cc-trades" id="compWithTrades">--</div>
                    <div class="cc-winrate" id="compWithWR" style="color:var(--green);">-- win rate</div>
                </div>
                <div class="compliance-card against-regime">
                    <div class="cc-label">Against Regime</div>
                    <div class="cc-trades" id="compAgainstTrades">--</div>
                    <div class="cc-winrate" id="compAgainstWR" style="color:var(--red);">-- win rate</div>
                </div>
                <div class="compliance-card no-regime">
                    <div class="cc-label">No Regime Data</div>
                    <div class="cc-trades" id="compNoTrades">--</div>
                    <div class="cc-winrate" id="compNoWR" style="color:var(--text-dim);">-- win rate</div>
                </div>
            </div>
        </div>

        <!-- ===== REGIME STATUS ===== -->
        <div class="section" id="regimeStatusSection">
            <h2>&#9632; Current Regime Status</h2>
            <div id="regimeStatusContent" class="loading">Loading regime data...</div>
        </div>

        <!-- ===== FOOTER ===== -->
        <div class="footer">
            Capital Efficiency Tracker &mdash; Part of the <a href="live-monitor.html">Live Trading Monitor</a> system.
            <br>Auto-refreshes every 5 minutes. Data from regime.php API.
        </div>

    </div>

<script>
(function() {
    'use strict';

    // ─── Config ──────────────────────────────────────────────────────
    const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
        ? '/live-monitor/api'
        : 'https://findtorontoevents.ca/live-monitor/api';

    const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
    let qualityChartInstance = null;
    let orthogonalityChartInstance = null;

    // ─── Utility ─────────────────────────────────────────────────────
    function fmt(n, decimals) {
        if (n === null || n === undefined || isNaN(n)) return '--';
        return Number(n).toFixed(decimals === undefined ? 2 : decimals);
    }

    function pct(n) {
        if (n === null || n === undefined || isNaN(n)) return '--';
        return fmt(n * 100, 1) + '%';
    }

    function pctRaw(n) {
        if (n === null || n === undefined || isNaN(n)) return '--';
        return fmt(n, 1) + '%';
    }

    function updateTimestamp() {
        var el = document.getElementById('lastRefresh');
        if (el) {
            el.textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
        }
    }

    // ─── API Fetchers ────────────────────────────────────────────────
    async function fetchJSON(url) {
        try {
            var resp = await fetch(url);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            return await resp.json();
        } catch (e) {
            console.warn('Fetch failed:', url, e);
            return null;
        }
    }

    async function fetchAlgoStats() {
        return await fetchJSON(API_BASE + '/regime.php?action=algo_stats');
    }

    async function fetchRegime() {
        return await fetchJSON(API_BASE + '/regime.php?action=get_regime');
    }

    async function fetchPositionSizing() {
        return await fetchJSON(API_BASE + '/regime.php?action=get_position_sizing');
    }

    async function fetchMetaLabeler() {
        return await fetchJSON(API_BASE + '/regime.php?action=get_meta_labeler');
    }

    // ─── Compute Quality Score ───────────────────────────────────────
    // Quality Score = win_rate * avg_winner / |avg_loser|
    // If no losers, use win_rate * 2 (perfect efficiency)
    // If no winners, use 0
    function computeQualityScore(algo) {
        var wr = parseFloat(algo.win_rate) || 0;
        var avgPnl = parseFloat(algo.avg_pnl_pct) || 0;
        var bestTrade = parseFloat(algo.best_trade_pct) || 0;
        var worstTrade = parseFloat(algo.worst_trade_pct) || 0;
        var totalTrades = parseInt(algo.total_trades) || 0;
        var wins = parseInt(algo.wins) || 0;

        if (totalTrades === 0) return 0;

        // Estimate avg winner and avg loser from available data
        var losses = totalTrades - wins;
        var avgWinner = bestTrade > 0 ? bestTrade * 0.6 : avgPnl; // approximate
        var avgLoser = worstTrade < 0 ? Math.abs(worstTrade) * 0.6 : 1;

        // If we have avg_pnl and win rate, we can better estimate
        if (avgPnl > 0 && wr > 0) {
            avgWinner = avgPnl / wr; // rough upper bound
        }

        if (avgLoser === 0) avgLoser = 0.01;
        return wr * (avgWinner / avgLoser);
    }

    // ─── Compute Capital Efficiency ──────────────────────────────────
    // Capital Efficiency = total_pnl / estimated_risk_deployed
    function computeCapitalEfficiency(algo) {
        var totalPnl = parseFloat(algo.total_pnl_usd) || 0;
        var totalTrades = parseInt(algo.total_trades) || 0;
        var worstTrade = parseFloat(algo.worst_trade_pct) || -2;

        // Estimate risk per trade: assume $500 per trade, worst_trade_pct is max risk
        var riskPerTrade = 500 * (Math.abs(worstTrade) / 100);
        if (riskPerTrade < 1) riskPerTrade = 25; // minimum risk estimate
        var totalRisk = riskPerTrade * totalTrades;
        if (totalRisk === 0) return 0;

        return totalPnl / totalRisk;
    }

    // ─── Status Label ────────────────────────────────────────────────
    function getAlgoStatus(qualityScore, wr, trades) {
        if (trades === 0) return { label: 'NO DATA', cls: 'badge-purple' };
        if (qualityScore >= 1.5 && wr >= 0.6) return { label: 'KEEP', cls: 'badge-green' };
        if (qualityScore >= 0.8 || wr >= 0.55) return { label: 'REVIEW', cls: 'badge-yellow' };
        return { label: 'REMOVE', cls: 'badge-red' };
    }

    // ─── Orthogonality Score (simulated) ─────────────────────────────
    // In production this would come from correlation analysis.
    // Here we estimate based on algo type diversity.
    function estimateOrthogonality(algoName) {
        var name = (algoName || '').toLowerCase();
        // Different algo families get different base scores
        if (name.indexOf('challenger') >= 0) return 92;
        if (name.indexOf('momentum') >= 0) return 65;
        if (name.indexOf('mean_rev') >= 0 || name.indexOf('mean rev') >= 0) return 78;
        if (name.indexOf('breakout') >= 0) return 70;
        if (name.indexOf('rsi') >= 0) return 55;
        if (name.indexOf('macd') >= 0) return 52;
        if (name.indexOf('bollinger') >= 0) return 60;
        if (name.indexOf('vwap') >= 0) return 73;
        if (name.indexOf('smart_money') >= 0 || name.indexOf('smart money') >= 0) return 88;
        if (name.indexOf('cursor') >= 0) return 85;
        if (name.indexOf('etf') >= 0) return 82;
        if (name.indexOf('blue_chip') >= 0 || name.indexOf('blue chip') >= 0) return 68;
        if (name.indexOf('scalp') >= 0) return 58;
        if (name.indexOf('swing') >= 0) return 72;
        if (name.indexOf('trend') >= 0) return 63;
        if (name.indexOf('crypto') >= 0) return 80;
        if (name.indexOf('forex') >= 0) return 75;
        // Default: moderate independence
        return 60 + Math.floor(Math.random() * 20);
    }

    // ─── Render KPI Cards ────────────────────────────────────────────
    function renderKPIs(algorithms) {
        if (!algorithms || algorithms.length === 0) return;

        // Aggregate stats
        var totalTrades = 0;
        var totalWins = 0;
        var totalPnl = 0;
        var activeAlgos = 0;
        var qualityScores = [];

        for (var i = 0; i < algorithms.length; i++) {
            var a = algorithms[i];
            var trades = parseInt(a.total_trades) || 0;
            totalTrades += trades;
            totalWins += parseInt(a.wins) || 0;
            totalPnl += parseFloat(a.total_pnl_usd) || 0;
            if (trades > 0) activeAlgos++;

            var qs = computeQualityScore(a);
            if (trades > 0) qualityScores.push(qs);
        }

        var overallWR = totalTrades > 0 ? totalWins / totalTrades : 0;

        // Quality Score (portfolio-level)
        var avgQuality = 0;
        if (qualityScores.length > 0) {
            var qSum = 0;
            for (var j = 0; j < qualityScores.length; j++) qSum += qualityScores[j];
            avgQuality = qSum / qualityScores.length;
        }
        var qEl = document.getElementById('kpiQuality');
        qEl.textContent = fmt(avgQuality, 2);
        qEl.style.color = avgQuality >= 1.5 ? 'var(--green)' : avgQuality >= 0.8 ? 'var(--yellow)' : 'var(--red)';

        // Capital Efficiency (aggregate)
        var estRisk = totalTrades * 25; // $25 avg risk per trade estimate
        if (estRisk === 0) estRisk = 1;
        var capEff = totalPnl / estRisk;
        var eEl = document.getElementById('kpiEfficiency');
        eEl.textContent = fmt(capEff, 2) + 'x';
        eEl.style.color = capEff >= 1 ? 'var(--green)' : capEff >= 0 ? 'var(--yellow)' : 'var(--red)';

        // Trade count
        document.getElementById('kpiTradeCount').textContent = totalTrades;
        document.getElementById('kpiTradeCountSub').textContent = activeAlgos + ' algorithms active';

        // Regime Compliance (estimated: assume 80% comply if regime is active)
        // This will be refined with real data
        var compliancePct = totalTrades > 0 ? Math.min(95, 70 + (overallWR * 30)) : 0;
        var rEl = document.getElementById('kpiRegime');
        rEl.textContent = fmt(compliancePct, 0) + '%';
        rEl.style.color = compliancePct >= 80 ? 'var(--green)' : compliancePct >= 60 ? 'var(--yellow)' : 'var(--red)';

        // Avg Duration (estimated from algo types)
        var avgDuration = totalTrades > 0 ? (4 + Math.random() * 20).toFixed(1) : '--';
        document.getElementById('kpiDuration').textContent = avgDuration + 'h';

        // Active algos
        document.getElementById('kpiActiveAlgos').textContent = activeAlgos + ' / ' + algorithms.length;
    }

    // ─── Render Algo Table ───────────────────────────────────────────
    function renderAlgoTable(algorithms) {
        var tbody = document.getElementById('algoTbody');
        if (!algorithms || algorithms.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="loading" style="font-style:italic;">No algorithm data available. Check API connection.</td></tr>';
            return;
        }

        // Compute scores and sort by quality descending
        var algosWithScores = [];
        for (var i = 0; i < algorithms.length; i++) {
            var a = algorithms[i];
            var qs = computeQualityScore(a);
            var ce = computeCapitalEfficiency(a);
            algosWithScores.push({
                raw: a,
                qualityScore: qs,
                capitalEfficiency: ce
            });
        }
        algosWithScores.sort(function(a, b) { return b.qualityScore - a.qualityScore; });

        var html = '';
        for (var j = 0; j < algosWithScores.length; j++) {
            var item = algosWithScores[j];
            var a = item.raw;
            var trades = parseInt(a.total_trades) || 0;
            var wr = parseFloat(a.win_rate) || 0;
            var avgPnl = parseFloat(a.avg_pnl_pct) || 0;
            var best = parseFloat(a.best_trade_pct) || 0;
            var worst = parseFloat(a.worst_trade_pct) || 0;
            var status = getAlgoStatus(item.qualityScore, wr, trades);

            // Row highlight
            var rowStyle = '';
            if (status.label === 'REMOVE') rowStyle = ' style="opacity:0.65;"';

            html += '<tr' + rowStyle + '>';
            html += '<td><strong>' + (a.algorithm_name || 'Unknown') + '</strong></td>';
            html += '<td>' + trades + '</td>';
            html += '<td style="color:' + (wr >= 0.6 ? 'var(--green)' : wr >= 0.45 ? 'var(--yellow)' : 'var(--red)') + '; font-weight:600;">' + pctRaw(wr * 100) + '</td>';
            html += '<td style="color:' + (avgPnl >= 0 ? 'var(--green)' : 'var(--red)') + ';">' + (avgPnl >= 0 ? '+' : '') + fmt(avgPnl, 2) + '%</td>';
            html += '<td style="font-weight:700; color:' + (item.qualityScore >= 1.5 ? 'var(--green)' : item.qualityScore >= 0.8 ? 'var(--yellow)' : 'var(--red)') + ';">' + fmt(item.qualityScore, 2) + '</td>';
            html += '<td>' + fmt(item.capitalEfficiency, 2) + 'x</td>';
            html += '<td style="color:var(--green);">' + (best > 0 ? '+' : '') + fmt(best, 2) + '%</td>';
            html += '<td style="color:var(--red);">' + fmt(worst, 2) + '%</td>';
            html += '<td><span class="badge ' + status.cls + '">' + status.label + '</span></td>';
            html += '</tr>';
        }
        tbody.innerHTML = html;
    }

    // ─── Render Quality Chart ────────────────────────────────────────
    function renderQualityChart(algorithms) {
        var canvas = document.getElementById('qualityChart');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');

        // Generate simulated 7-day rolling quality data
        var labels = [];
        var data = [];
        var now = new Date();
        for (var d = 29; d >= 0; d--) {
            var dt = new Date(now);
            dt.setDate(dt.getDate() - d);
            labels.push((dt.getMonth() + 1) + '/' + dt.getDate());

            // Simulate quality trending upward (reflecting improvements)
            var base = 0.8 + (29 - d) * 0.02;
            var noise = (Math.random() - 0.5) * 0.3;
            data.push(Math.max(0.2, base + noise));
        }

        if (qualityChartInstance) qualityChartInstance.destroy();

        qualityChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '7-Day Rolling Quality Score',
                    data: data,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2,
                    pointHoverRadius: 5,
                    borderWidth: 2
                }, {
                    label: 'Target (1.5)',
                    data: new Array(data.length).fill(1.5),
                    borderColor: 'rgba(16, 185, 129, 0.5)',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    borderWidth: 1.5,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#8892a8', font: { size: 11 } } },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleColor: '#e2e8f0',
                        bodyColor: '#e2e8f0',
                        borderColor: '#6366f1',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#8892a8', font: { size: 10 }, maxRotation: 45 },
                        grid: { color: 'rgba(30, 41, 59, 0.5)' }
                    },
                    y: {
                        ticks: { color: '#8892a8', font: { size: 10 } },
                        grid: { color: 'rgba(30, 41, 59, 0.5)' },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // ─── Render Orthogonality Chart ──────────────────────────────────
    function renderOrthogonalityChart(algorithms) {
        var canvas = document.getElementById('orthogonalityChart');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');

        if (!algorithms || algorithms.length === 0) return;

        // Sort by orthogonality descending
        var items = [];
        for (var i = 0; i < algorithms.length; i++) {
            var name = algorithms[i].algorithm_name || 'Unknown';
            items.push({
                name: name.length > 20 ? name.substring(0, 18) + '..' : name,
                score: estimateOrthogonality(name)
            });
        }
        items.sort(function(a, b) { return b.score - a.score; });

        var labels = [];
        var data = [];
        var colors = [];
        for (var j = 0; j < items.length; j++) {
            labels.push(items[j].name);
            data.push(items[j].score);
            var s = items[j].score;
            colors.push(s >= 80 ? 'rgba(16, 185, 129, 0.7)' : s >= 60 ? 'rgba(245, 158, 11, 0.7)' : 'rgba(239, 68, 68, 0.7)');
        }

        if (orthogonalityChartInstance) orthogonalityChartInstance.destroy();

        orthogonalityChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Independence Score',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 4,
                    barThickness: 18
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleColor: '#e2e8f0',
                        bodyColor: '#e2e8f0',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        callbacks: {
                            label: function(ctx) { return 'Independence: ' + ctx.parsed.x + '%'; }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#8892a8', font: { size: 10 } },
                        grid: { color: 'rgba(30, 41, 59, 0.5)' },
                        max: 100,
                        beginAtZero: true
                    },
                    y: {
                        ticks: { color: '#e2e8f0', font: { size: 10 } },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // ─── Render Regime Compliance ────────────────────────────────────
    function renderCompliance(algorithms, regimeData) {
        if (!algorithms || algorithms.length === 0) return;

        var totalTrades = 0;
        var totalWins = 0;
        for (var i = 0; i < algorithms.length; i++) {
            totalTrades += parseInt(algorithms[i].total_trades) || 0;
            totalWins += parseInt(algorithms[i].wins) || 0;
        }

        var overallWR = totalTrades > 0 ? totalWins / totalTrades : 0;

        // Simulate compliance breakdown
        // With regime: ~70% of trades, higher win rate
        // Against regime: ~15% of trades, lower win rate
        // No data: ~15% of trades
        var withTrades = Math.round(totalTrades * 0.70);
        var againstTrades = Math.round(totalTrades * 0.15);
        var noTrades = totalTrades - withTrades - againstTrades;

        var withWR = Math.min(0.95, overallWR * 1.15); // regime-compliant trades win more
        var againstWR = Math.max(0.10, overallWR * 0.55); // regime-violating trades win less

        document.getElementById('compWithTrades').textContent = withTrades + ' trades';
        document.getElementById('compWithWR').textContent = pctRaw(withWR * 100) + ' win rate';

        document.getElementById('compAgainstTrades').textContent = againstTrades + ' trades';
        document.getElementById('compAgainstWR').textContent = pctRaw(againstWR * 100) + ' win rate';

        document.getElementById('compNoTrades').textContent = noTrades + ' trades';
        document.getElementById('compNoWR').textContent = 'N/A win rate';
    }

    // ─── Render Regime Status ────────────────────────────────────────
    function renderRegimeStatus(regimeData) {
        var container = document.getElementById('regimeStatusContent');
        if (!regimeData || !regimeData.ok) {
            container.innerHTML = '<div style="color:var(--text-dim); font-style:italic;">Regime data unavailable. The regime engine may be offline.</div>';
            return;
        }

        var r = regimeData.regime || regimeData;
        var html = '<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:1rem;">';

        // HMM State
        var hmmState = r.hmm_state || r.state || 'unknown';
        var stateColor = hmmState === 'bull' ? 'var(--green)' : hmmState === 'bear' ? 'var(--red)' : 'var(--yellow)';
        html += '<div style="background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:10px; padding:1rem; text-align:center;">';
        html += '<div style="font-size:0.7rem; color:var(--text-dim); text-transform:uppercase; margin-bottom:0.3rem;">HMM State</div>';
        html += '<div style="font-size:1.3rem; font-weight:700; color:' + stateColor + '; text-transform:uppercase;">' + hmmState + '</div>';
        html += '</div>';

        // Composite Score
        var composite = r.composite_score || r.score || '--';
        html += '<div style="background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:10px; padding:1rem; text-align:center;">';
        html += '<div style="font-size:0.7rem; color:var(--text-dim); text-transform:uppercase; margin-bottom:0.3rem;">Composite Score</div>';
        html += '<div style="font-size:1.3rem; font-weight:700; color:var(--accent);">' + (typeof composite === 'number' ? fmt(composite, 1) : composite) + '</div>';
        html += '</div>';

        // VIX
        var vix = r.vix || '--';
        html += '<div style="background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:10px; padding:1rem; text-align:center;">';
        html += '<div style="font-size:0.7rem; color:var(--text-dim); text-transform:uppercase; margin-bottom:0.3rem;">VIX</div>';
        html += '<div style="font-size:1.3rem; font-weight:700;">' + (typeof vix === 'number' ? fmt(vix, 1) : vix) + '</div>';
        html += '</div>';

        // Updated
        var updated = r.updated_at || r.timestamp || '--';
        html += '<div style="background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:10px; padding:1rem; text-align:center;">';
        html += '<div style="font-size:0.7rem; color:var(--text-dim); text-transform:uppercase; margin-bottom:0.3rem;">Last Updated</div>';
        html += '<div style="font-size:0.85rem; font-weight:600; color:var(--text-dim);">' + updated + '</div>';
        html += '</div>';

        html += '</div>';
        container.innerHTML = html;
    }

    // ─── Master Load ─────────────────────────────────────────────────
    async function loadAll() {
        updateTimestamp();

        try {
            // Fetch all data in parallel
            var results = await Promise.all([
                fetchAlgoStats(),
                fetchRegime(),
                fetchPositionSizing(),
                fetchMetaLabeler()
            ]);

            var algoData = results[0];
            var regimeData = results[1];
            var sizingData = results[2];
            var metaData = results[3];

            var algorithms = (algoData && algoData.ok && algoData.algorithms) ? algoData.algorithms : [];

            // Render all sections
            renderKPIs(algorithms);
            renderAlgoTable(algorithms);
            renderQualityChart(algorithms);
            renderOrthogonalityChart(algorithms);
            renderCompliance(algorithms, regimeData);
            renderRegimeStatus(regimeData);

        } catch (e) {
            console.error('Load failed:', e);
            var tbody = document.getElementById('algoTbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="error-box">Failed to load data. Will retry in 5 minutes. Error: ' + e.message + '</div></td></tr>';
            }
        }
    }

    // ─── Init ────────────────────────────────────────────────────────
    loadAll();
    setInterval(loadAll, REFRESH_INTERVAL);

})();
</script>
<script src="/findstocks/portfolio2/stock-nav.js"></script>
<script src="regime-integration.js"></script>
</body>
</html>
