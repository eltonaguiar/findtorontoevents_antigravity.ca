<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Bet Winner Finder | Find Toronto Events</title>
    <meta name="description" content="AI-powered sports betting analysis with Kelly criterion sizing. Track NBA, NHL, NFL, MLB odds and find value bets with paper trading simulation.">
    <link rel="canonical" href="https://findtorontoevents.ca/live-monitor/sports-betting.html">
    <meta name="keywords" content="sports betting, AI picks, Kelly criterion, NBA odds, NHL betting, value bets, sports predictions, paper betting">
    <meta property="og:title" content="Sports Bet Winner Finder | Find Toronto Events">
    <meta property="og:description" content="AI-powered sports betting analysis with Kelly criterion sizing. Track NBA, NHL, NFL, MLB odds and find value bets.">
    <meta property="og:url" content="https://findtorontoevents.ca/live-monitor/sports-betting.html">
    <meta property="og:site_name" content="Find Toronto Events">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Sports Bet Winner Finder | Find Toronto Events">
    <meta name="twitter:description" content="AI-powered sports betting analysis. Track NBA, NHL, NFL, MLB odds and find value bets.">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #12122a;
            --bg-card-hover: #1a1a3a;
            --border: #2a2a4a;
            --text: #e0e0f0;
            --text-dim: #8888aa;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234, 179, 8, 0.15);
            --blue: #3b82f6;
            --orange: #f97316;
            --purple: #a855f7;
            --radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark); color: var(--text);
            min-height: 100vh; line-height: 1.6;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .header {
            background: linear-gradient(135deg, #12122a 0%, #1e1e3f 100%);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem 1rem; text-align: center;
        }
        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--green), #22d3ee, var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 0.3rem;
        }
        .header p { color: var(--text-dim); font-size: 0.95rem; }
        .header-links {
            margin-top: 0.8rem; display: flex; gap: 1.5rem;
            justify-content: center; font-size: 0.9rem; flex-wrap: wrap;
        }
        .header-links a { color: var(--text-dim); }
        .header-links a:hover { color: var(--text); }
        .status-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 1.5rem; padding: 0.6rem 1rem;
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            font-size: 0.8rem; color: var(--text-dim); flex-wrap: wrap;
        }
        .status-bar .status-item { display: flex; align-items: center; gap: 0.4rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-dot.connected { background: var(--green); box-shadow: 0 0 6px var(--green); }
        .status-dot.warning { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }
        .status-value { color: var(--text); font-weight: 600; }
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .disclaimer {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 0.8rem 1.2rem;
            font-size: 0.82rem; color: var(--text-dim); margin-bottom: 1rem; text-align: center;
        }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.8rem; margin-bottom: 1rem;
        }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem; text-align: center;
        }
        .stat-card .stat-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .stat-value { font-size: 1.6rem; font-weight: 700; margin-top: 0.2rem; }
        .stat-card .stat-sub { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.2rem; }
        .sport-filters {
            display: flex; gap: 0.5rem; flex-wrap: wrap;
            justify-content: center; margin-bottom: 1rem;
        }
        .sport-btn {
            background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-dim); padding: 0.4rem 0.9rem;
            border-radius: 20px; cursor: pointer; font-size: 0.82rem; transition: all 0.2s;
        }
        .sport-btn:hover { border-color: var(--accent); color: var(--text); }
        .sport-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
        .sport-btn.empty { opacity: 0.35; text-decoration: line-through; cursor: default; }
        .sport-btn.empty:hover { border-color: var(--border); color: var(--text-dim); }
        .tab-nav {
            display: flex; gap: 0.5rem; margin-bottom: 1rem;
            border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; flex-wrap: wrap;
        }
        .tab-btn {
            background: transparent; border: 1px solid transparent;
            color: var(--text-dim); padding: 0.5rem 1rem;
            border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text); background: var(--bg-card); }
        .tab-btn.active { background: var(--bg-card); border-color: var(--border); border-bottom-color: var(--bg-dark); color: var(--accent); font-weight: 600; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .picks-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .pick-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem; transition: border-color 0.2s;
        }
        .pick-card:hover { border-color: var(--accent); }
        .pick-card .pick-header, .pick-card-enhanced .pick-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; }
        .pick-card .pick-sport, .pick-card-enhanced .pick-sport { font-size: 0.75rem; color: var(--accent); font-weight: 600; text-transform: uppercase; }
        .pick-card .pick-time, .pick-card-enhanced .pick-time { font-size: 0.75rem; color: var(--text-dim); }
        .pick-card .pick-teams, .pick-card-enhanced .pick-teams { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .pick-card .pick-detail, .pick-card-enhanced .pick-detail { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.3rem; }
        .pick-card .pick-detail strong, .pick-card-enhanced .pick-detail strong { color: var(--text); }
        .badge {
            display: inline-block; padding: 0.15rem 0.5rem;
            border-radius: 10px; font-size: 0.72rem; font-weight: 600;
        }
        .badge-green { background: var(--green-dim); color: var(--green); }
        .badge-red { background: var(--red-dim); color: var(--red); }
        .badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
        .badge-blue { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
        .badge-ca { background: rgba(239, 68, 68, 0.1); color: #ff6b6b; border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-purple { background: rgba(168, 85, 247, 0.15); color: var(--purple); }
        .badge-orange { background: rgba(249, 115, 22, 0.15); color: var(--orange); }

        /* Rating system */
        .rating-badge {
            display: inline-flex; align-items: center; justify-content: center;
            width: 42px; height: 42px; border-radius: 10px;
            font-size: 1.1rem; font-weight: 800; letter-spacing: -0.5px;
            flex-shrink: 0;
        }
        .rating-Aplus { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; box-shadow: 0 0 12px rgba(34,197,94,0.4); }
        .rating-A { background: linear-gradient(135deg, #22c55e, #4ade80); color: #fff; }
        .rating-Bplus { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: #fff; }
        .rating-B { background: linear-gradient(135deg, #3b82f6, #93c5fd); color: #fff; }
        .rating-Cplus { background: linear-gradient(135deg, #eab308, #facc15); color: #1a1a2e; }
        .rating-C { background: linear-gradient(135deg, #f97316, #fb923c); color: #1a1a2e; }
        .rating-D { background: linear-gradient(135deg, #ef4444, #f87171); color: #fff; }

        .rec-badge {
            display: inline-block; padding: 0.2rem 0.6rem;
            border-radius: 6px; font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .rec-strong-take { background: var(--green); color: #fff; animation: pulse-green 2s infinite; }
        .rec-take { background: var(--blue); color: #fff; }
        .rec-lean { background: var(--yellow); color: #1a1a2e; }
        .rec-wait { background: var(--orange); color: #fff; }
        .rec-skip { background: var(--red-dim); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
            50% { box-shadow: 0 0 0 6px rgba(34,197,94,0); }
        }

        .pick-card-enhanced {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem; transition: all 0.2s;
            position: relative;
        }
        .pick-card-enhanced:hover { border-color: var(--accent); transform: translateY(-2px); }
        .pick-card-enhanced.grade-A { border-left: 3px solid var(--green); }
        .pick-card-enhanced.grade-B { border-left: 3px solid var(--blue); }
        .pick-card-enhanced.grade-C { border-left: 3px solid var(--yellow); }
        .pick-card-enhanced.grade-D { border-left: 3px solid var(--red); }
        .pick-top-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.8rem; margin-bottom: 0.6rem; }
        .pick-rating-col { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; min-width: 50px; }
        .pick-main-col { flex: 1; }
        .pick-score-bar { width: 42px; height: 4px; border-radius: 2px; background: var(--border); overflow: hidden; }
        .pick-score-fill { height: 100%; border-radius: 2px; }
        .pick-win-prob { font-size: 0.72rem; color: var(--text-dim); text-align: center; cursor: help; }
        .grade-info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--border); color: var(--text-dim);
            font-size: 0.6rem; font-weight: 700; cursor: help;
            margin-left: 0.3rem; vertical-align: middle; position: relative;
        }
        .grade-info-icon:hover { background: var(--accent); color: #fff; }
        .grade-tooltip {
            display: none; position: absolute; bottom: 130%; left: 50%;
            transform: translateX(-50%); width: 260px; padding: 0.7rem;
            background: #1e1e3f; border: 1px solid var(--accent);
            border-radius: 8px; font-size: 0.72rem; color: var(--text);
            line-height: 1.5; z-index: 1000; text-align: left;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); pointer-events: none;
        }
        .grade-info-icon:hover .grade-tooltip { display: block; }
        /* Glossary tab */
        .glossary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }
        .glossary-item {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem; transition: border-color 0.2s;
        }
        .glossary-item:hover { border-color: var(--accent); }
        .glossary-term {
            font-weight: 700; font-size: 0.95rem; color: var(--accent);
            margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.5rem;
        }
        .glossary-term .gt-badge { font-size: 0.65rem; padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: 600; }
        .glossary-def { font-size: 0.85rem; color: var(--text-dim); line-height: 1.6; }
        .glossary-def strong { color: var(--text); }
        .glossary-section-title { font-size: 1rem; font-weight: 700; color: var(--text); margin: 1.5rem 0 0.8rem; padding-bottom: 0.4rem; border-bottom: 1px solid var(--border); }
        .glossary-section-title:first-child { margin-top: 0; }
        /* Inline term tooltip */
        .term-tip {
            position: relative; cursor: help;
            border-bottom: 1px dotted var(--accent); color: var(--text);
        }
        .term-tip .term-tip-text {
            display: none; position: absolute; bottom: 130%; left: 50%;
            transform: translateX(-50%); width: 240px; padding: 0.6rem 0.7rem;
            background: #1e1e3f; border: 1px solid var(--accent);
            border-radius: 8px; font-size: 0.72rem; color: var(--text);
            line-height: 1.5; z-index: 1000; text-align: left;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); pointer-events: none;
            font-weight: 400;
        }
        .term-tip:hover .term-tip-text { display: block; }
        /* Pick history result detail */
        .result-detail { font-size: 0.72rem; color: var(--text-dim); margin-top: 0.15rem; white-space: nowrap; }
        .result-detail .rd-risk { color: var(--text-dim); }
        .result-detail .rd-payout { font-weight: 600; }
        .grade-explainer {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 0.7rem 1rem;
            margin-bottom: 1rem; font-size: 0.8rem; color: var(--text-dim);
            line-height: 1.6;
        }
        .grade-explainer strong { color: var(--text); }
        .grade-explainer .ge-title { color: var(--accent); font-weight: 700; margin-bottom: 0.3rem; }
        .pick-reasons { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border); }
        .pick-reasons ul { list-style: none; padding: 0; margin: 0; }
        .pick-reasons li { font-size: 0.75rem; color: var(--text-dim); padding: 0.1rem 0; }
        .pick-reasons li::before { content: '\2022'; color: var(--accent); margin-right: 0.4rem; }

        /* Team rankings */
        .pick-rankings { display: flex; gap: 0.8rem; align-items: center; margin-bottom: 0.5rem; font-size: 0.78rem; flex-wrap: wrap; }
        .team-rank { display: inline-flex; align-items: center; gap: 0.3rem; color: var(--text-dim); }
        .team-rank .rank-num { font-weight: 700; color: var(--text); }
        .team-rank .rank-num.top5 { color: var(--green); }
        .team-rank .rank-num.top10 { color: var(--blue); }
        .team-rank .rank-num.bottom10 { color: var(--red); }
        .team-rank .rank-record { color: var(--text-dim); font-size: 0.72rem; }

        /* Bet amount — prominent display */
        .pick-bet-amount {
            display: inline-flex; align-items: center; gap: 0.3rem;
            background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(99,102,241,0.08));
            border: 1px solid rgba(99,102,241,0.3); border-radius: 8px;
            padding: 0.3rem 0.7rem; font-size: 0.9rem; font-weight: 700; color: var(--accent);
        }
        .pick-bet-amount .bet-label { font-size: 0.7rem; font-weight: 500; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Here's why section */
        .pick-heres-why {
            margin-top: 0.6rem; padding: 0.6rem 0.8rem;
            background: linear-gradient(135deg, rgba(34,197,94,0.06), rgba(59,130,246,0.06));
            border: 1px solid rgba(34,197,94,0.15); border-radius: 8px;
            font-size: 0.78rem; color: var(--text); line-height: 1.5;
        }
        .pick-heres-why .why-label { font-weight: 700; color: var(--green); margin-bottom: 0.2rem; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn {
            background: var(--accent); color: #fff; border: none;
            padding: 0.4rem 0.8rem; border-radius: 6px;
            cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.85; }
        .btn-green { background: var(--green); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: var(--bg-card); color: var(--text-dim); font-weight: 600; text-align: left; padding: 0.6rem 0.8rem; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; }
        th.sortable { cursor: pointer; user-select: none; white-space: nowrap; transition: color 0.2s; }
        th.sortable:hover { color: var(--accent); }
        th.sortable .sort-arrow { margin-left: 0.3rem; font-size: 0.65rem; opacity: 0.3; }
        th.sortable.sort-asc .sort-arrow, th.sortable.sort-desc .sort-arrow { opacity: 1; color: var(--accent); }
        th .th-tip { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; border-radius: 50%; background: var(--border); color: var(--text-dim); font-size: 0.55rem; font-weight: 700; cursor: help; margin-left: 0.3rem; vertical-align: middle; position: relative; }
        th .th-tip:hover { background: var(--accent); color: #fff; }
        th .th-tip-text { display: none; position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%); width: 200px; padding: 0.5rem 0.6rem; background: #1e1e3f; border: 1px solid var(--accent); border-radius: 6px; font-size: 0.7rem; color: var(--text); line-height: 1.4; z-index: 100; text-transform: none; font-weight: 400; box-shadow: 0 4px 16px rgba(0,0,0,0.5); white-space: normal; }
        th .th-tip:hover .th-tip-text { display: block; }
        td { padding: 0.5rem 0.8rem; border-bottom: 1px solid rgba(42, 42, 74, 0.5); }
        tr:hover td { background: var(--bg-card-hover); }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .text-yellow { color: var(--yellow); }
        .text-dim { color: var(--text-dim); }
        .odds-event { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem; overflow: hidden; }
        .odds-event-header { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .odds-event-header h3 { font-size: 0.95rem; }
        .odds-table { overflow-x: auto; }
        .odds-table table { min-width: 600px; }
        .odds-table td.best-odds { background: var(--green-dim); color: var(--green); font-weight: 700; }
        .odds-table td.worst-odds { background: var(--red-dim); color: var(--text-dim); }
        .chart-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; }
        .chart-container h3 { font-size: 0.95rem; margin-bottom: 0.8rem; }
        .history-day {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 0.8rem 1rem;
            margin-bottom: 0.6rem; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; transition: border-color 0.2s;
        }
        .history-day:hover { border-color: var(--accent); }
        .history-day .day-date { font-weight: 600; }
        .history-day .day-stats { display: flex; gap: 1rem; font-size: 0.85rem; }
        .section-title { font-size: 1.1rem; font-weight: 600; margin: 1rem 0 0.8rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-dim); }
        .empty-state p { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .loading { text-align: center; padding: 2rem; color: var(--text-dim); }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .picks-grid { grid-template-columns: 1fr; }
            .container { padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sports Bet Winner Finder</h1>
        <p>Value bets + line shopping across Canadian sportsbooks &mdash; paper betting tracker</p>
        <div class="header-links">
            <a href="live-monitor.html">Live Monitor</a>
            <a href="edge-dashboard.html">Edge Finder</a>
            <a href="opportunity-scanner.html">Scanner</a>
            <a href="/findstocks/portfolio2/hub.html">Hub</a>
            <a href="/">Events</a>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <span class="status-dot connected" id="status-dot"></span>
            <span>Last refresh: <span class="status-value" id="last-refresh">--</span></span>
        </div>
        <div class="status-item">Bankroll: <span class="status-value" id="status-bankroll">$1,000</span></div>
        <div class="status-item">API Credits: <span class="status-value" id="status-credits">--/500</span></div>
        <div class="status-item">Active Bets: <span class="status-value" id="status-active">0</span></div>
    </div>

    <div class="container">
        <div class="disclaimer">
            Paper betting simulation only. Not gambling advice. Past performance does not predict future results.<br>
            <strong>Odds data:</strong> The Odds API (refreshed every 2-3 hours) &bull;
            <strong>Books:</strong> bet365, FanDuel, DraftKings, BetMGM, PointsBet, Caesars &bull;
            Ontario/Canada legal sportsbooks
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Bankroll</div><div class="stat-value" id="stat-bankroll">$1,000</div><div class="stat-sub" id="stat-bankroll-change">+$0.00</div></div>
            <div class="stat-card"><div class="stat-label">Total Bets</div><div class="stat-value" id="stat-total-bets">0</div><div class="stat-sub" id="stat-wlp">W:0 L:0 P:0</div></div>
            <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value" id="stat-win-rate">0%</div><div class="stat-sub">settled bets</div></div>
            <div class="stat-card"><div class="stat-label">ROI</div><div class="stat-value" id="stat-roi">0%</div><div class="stat-sub" id="stat-pnl">$0.00 P&amp;L</div></div>
            <div class="stat-card"><div class="stat-label">Today's Picks</div><div class="stat-value" id="stat-picks">0</div><div class="stat-sub" id="stat-avg-ev">Avg EV: --%</div></div>
            <div class="stat-card"><div class="stat-label">Active Bets</div><div class="stat-value" id="stat-active">0</div><div class="stat-sub" id="stat-reserved">$0 reserved</div></div>
        </div>

        <div class="sport-filters">
            <button class="sport-btn active" onclick="filterSport('all')">All Sports</button>
            <button class="sport-btn" onclick="filterSport('icehockey_nhl')">NHL</button>
            <button class="sport-btn" onclick="filterSport('basketball_nba')">NBA</button>
            <button class="sport-btn" onclick="filterSport('americanfootball_nfl')">NFL</button>
            <button class="sport-btn" onclick="filterSport('baseball_mlb')">MLB</button>
            <button class="sport-btn" onclick="filterSport('americanfootball_cfl')">CFL</button>
            <button class="sport-btn" onclick="filterSport('soccer_usa_mls')">MLS</button>
            <button class="sport-btn" onclick="filterSport('americanfootball_ncaaf')">NCAAF</button>
            <button class="sport-btn" onclick="filterSport('basketball_ncaab')">NCAAB</button>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('picks')">Today's Picks</button>
            <button class="tab-btn" onclick="switchTab('odds')">Odds Comparison</button>
            <button class="tab-btn" onclick="switchTab('bets')">My Bets</button>
            <button class="tab-btn" onclick="switchTab('performance')">Performance</button>
            <button class="tab-btn" onclick="switchTab('history')">Pick History</button>
            <button class="tab-btn" onclick="switchTab('glossary')">Glossary</button>
        </div>

        <div class="tab-panel active" id="tab-picks">
            <div class="loading" id="picks-loading">Loading today's picks...</div>
            <div id="picks-content" style="display:none;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.8rem;">
                    <h3 class="section-title" style="margin:0;">Value Bets <span class="badge badge-green" id="vb-count">0</span></h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;font-size:0.75rem;">
                        <span class="rec-badge rec-strong-take" style="animation:none;font-size:0.65rem;">STRONG TAKE</span>
                        <span class="rec-badge rec-take" style="font-size:0.65rem;">TAKE</span>
                        <span class="rec-badge rec-lean" style="font-size:0.65rem;">LEAN</span>
                        <span class="rec-badge rec-wait" style="font-size:0.65rem;">WAIT</span>
                        <span class="rec-badge rec-skip" style="font-size:0.65rem;">SKIP</span>
                    </div>
                </div>
                <div class="grade-explainer" id="grade-explainer">
                    <div class="ge-title">How Grades Work <span style="font-weight:400;font-size:0.75rem;color:var(--text-dim);">&mdash; see <a href="#" onclick="switchTab('glossary');return false;" style="font-size:0.75rem">Glossary</a> for all terms</span></div>
                    Grades are based on <span class="term-tip"><strong>Expected Value (EV)</strong><span class="term-tip-text">The average profit per dollar bet over many repetitions. +EV means profitable long-term.</span></span>, not just win probability.
                    A pick with <strong>17% win probability at +500 odds</strong> (grade B) can outrank one with
                    <strong>26% win probability at +290 odds</strong> (grade C+) because the potential payout per dollar
                    risked is higher &mdash; the <strong>risk:reward ratio</strong> matters more than raw likelihood.
                    <br>Factors: EV% (50pts), <span class="term-tip">book consensus<span class="term-tip-text">How closely different sportsbooks agree on the odds. Strong consensus = efficient market.</span></span> (20pts), market type (15pts), <span class="term-tip">CA-legal book<span class="term-tip-text">Sportsbooks licensed in Ontario/Canada: bet365, FanDuel, DraftKings, BetMGM, PointsBet, Caesars.</span></span> (10pts), timing (5pts).
                </div>
                <div id="picks-summary" style="display:none;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:0.8rem 1rem;margin-bottom:1rem;display:flex;gap:1.5rem;align-items:center;flex-wrap:wrap;font-size:0.85rem;">
                    <span>Strong Takes: <strong class="text-green" id="sum-strong">0</strong></span>
                    <span>Takes: <strong style="color:var(--blue)" id="sum-takes">0</strong></span>
                    <span>Waits: <strong class="text-yellow" id="sum-waits">0</strong></span>
                    <span>Avg Win Prob: <strong id="sum-winprob">--%</strong></span>
                </div>
                <div class="picks-grid" id="value-bets-grid"></div>
                <h3 class="section-title">Line Shopping Opportunities</h3>
                <div id="line-shop-content"></div>
            </div>
        </div>

        <div class="tab-panel" id="tab-odds">
            <div class="loading" id="odds-loading">Loading odds...</div>
            <div id="odds-content" style="display:none;"></div>
        </div>

        <div class="tab-panel" id="tab-bets">
            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;">
                <button class="btn" onclick="loadBets('active')" id="bets-tab-active">Active</button>
                <button class="btn" onclick="loadBets('history')" id="bets-tab-history" style="background:var(--bg-card);color:var(--text-dim);border:1px solid var(--border);">Settled</button>
            </div>
            <div id="bets-content"><div class="loading">Loading bets...</div></div>
        </div>

        <div class="tab-panel" id="tab-performance">
            <div class="chart-container">
                <h3>Bankroll Growth</h3>
                <canvas id="bankroll-chart" height="250"></canvas>
            </div>
            <div id="perf-tables"></div>
        </div>

        <div class="tab-panel" id="tab-history">
            <div id="history-content"><div class="loading">Loading pick history...</div></div>
        </div>

        <div class="tab-panel" id="tab-glossary">
            <h3 class="glossary-section-title">Grades &amp; Recommendations</h3>
            <div class="glossary-grid">
                <div class="glossary-item">
                    <div class="glossary-term"><span class="rec-badge rec-strong-take gt-badge" style="animation:none">STRONG TAKE</span></div>
                    <div class="glossary-def">The highest-confidence recommendation. The algorithm found a <strong>large positive EV edge</strong> with strong book consensus. Historically the most profitable grade of picks. <em style="color:var(--yellow);font-size:0.78rem">&#9888; This is paper simulation analysis &mdash; never bet money you can&rsquo;t afford to lose.</em></div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="rec-badge rec-take gt-badge">TAKE</span></div>
                    <div class="glossary-def">A solid bet with <strong>meaningful positive EV</strong>. Good risk/reward ratio but not as extreme as a Strong Take. Our model suggests placing at the recommended Kelly-sized amount. <em style="color:var(--yellow);font-size:0.78rem">&#9888; Paper simulation only &mdash; not financial advice.</em></div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="rec-badge rec-lean gt-badge">LEAN</span></div>
                    <div class="glossary-def">Slight edge detected but <strong>not a slam dunk</strong>. The EV is positive but marginal. Consider placing at half the suggested amount, or skip if your bankroll is tight.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="rec-badge rec-wait gt-badge">WAIT</span></div>
                    <div class="glossary-def">Edge is borderline or the line may move. <strong>Don&rsquo;t bet yet</strong> &mdash; check back closer to game time. Odds often shift and the value may improve (or disappear).</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term"><span class="rec-badge rec-skip gt-badge">SKIP</span></div>
                    <div class="glossary-def"><strong>No edge found</strong> or negative EV. The odds don&rsquo;t justify a bet. Discipline means sitting out bad spots &mdash; skipping losing bets is how you stay profitable.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Grade (A+, A, B+, B, C+, C, D)</div>
                    <div class="glossary-def">A composite score (0-100) converted to a letter grade. Based on: <strong>EV%</strong> (50 pts), book consensus (20 pts), market type (15 pts), Canadian-legal book (10 pts), timing (5 pts). A higher grade does <strong>not</strong> always mean higher win probability &mdash; it means better risk-adjusted value.</div>
                </div>
            </div>

            <h3 class="glossary-section-title">Key Betting Concepts</h3>
            <div class="glossary-grid">
                <div class="glossary-item">
                    <div class="glossary-term">EV (Expected Value)</div>
                    <div class="glossary-def">The average profit you'd make per dollar bet <strong>over many repetitions</strong>. An EV of +5% means for every $100 bet, you'd expect to profit $5 on average long-term. Positive EV (+EV) bets are profitable over time, even if individual bets lose.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Vig-Removed Probability</div>
                    <div class="glossary-def">Sportsbooks build a <strong>profit margin (the &ldquo;vig&rdquo; or &ldquo;juice&rdquo;)</strong> into their odds. For example, a fair coin flip should be 50/50 but books price both sides at ~52.4% (totaling 104.8%). &ldquo;Vig-removed&rdquo; strips out that margin to show the <strong>true consensus probability</strong> the market implies. This is what the &ldquo;win prob&rdquo; percentage represents on each pick card.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Kelly Criterion</div>
                    <div class="glossary-def">A mathematical formula for <strong>optimal bet sizing</strong> based on your edge and the odds offered. Betting more when your edge is larger, less when it&rsquo;s smaller. We use <strong>quarter-Kelly</strong> (25% of the full Kelly amount) for safer bankroll management &mdash; this reduces variance at the cost of slightly slower growth.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Line Shopping</div>
                    <div class="glossary-def">Comparing odds across <strong>multiple sportsbooks</strong> to find the best price for the same bet. If bet365 offers +150 and FanDuel offers +160 on the same outcome, FanDuel is the better line. Over time, always getting the best price compounds into significantly higher returns.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Bankroll</div>
                    <div class="glossary-def">The <strong>total amount of money</strong> set aside for betting. All bet sizes are calculated as a percentage of your bankroll. Starting bankroll on this tracker is $1,000 (paper/simulated money).</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">ROI (Return on Investment)</div>
                    <div class="glossary-def"><strong>Total profit divided by total amount wagered</strong>, expressed as a percentage. An ROI of +5% means you profit $5 for every $100 risked. Professional sports bettors typically target 2-10% long-term ROI.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">P&amp;L (Profit &amp; Loss)</div>
                    <div class="glossary-def">The <strong>net dollar amount</strong> gained or lost. A positive P&amp;L means you're up overall; negative means you're down. Shown in green (profit) or red (loss) throughout the tracker.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Paper Betting</div>
                    <div class="glossary-def">Tracking bets with <strong>simulated (fake) money</strong> to test a strategy without risking real cash. All bets on this tracker are paper bets &mdash; no real money is at stake. Great for building confidence in a system before going live.</div>
                </div>
            </div>

            <h3 class="glossary-section-title">Market Types</h3>
            <div class="glossary-grid">
                <div class="glossary-item">
                    <div class="glossary-term">Moneyline (h2h)</div>
                    <div class="glossary-def">The simplest bet: <strong>pick which team wins</strong>. No point spread involved. The favorite has lower odds (smaller payout), the underdog has higher odds (bigger payout). &ldquo;h2h&rdquo; stands for head-to-head.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Spread</div>
                    <div class="glossary-def">A <strong>point handicap</strong> applied to the favorite. If Team A is -6.5, they must win by 7+ points for the bet to win. The underdog at +6.5 can lose by up to 6 points and still &ldquo;cover.&rdquo; Spreads equalize mismatched teams.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Total (Over/Under)</div>
                    <div class="glossary-def">Bet on whether the <strong>combined score</strong> of both teams will be over or under a set number. E.g., Total 215.5 &mdash; bet Over if you think both teams will score 216+ combined, Under if 215 or fewer.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Decimal Odds</div>
                    <div class="glossary-def">The format used in this tracker. <strong>Multiply your bet by the odds to get total payout.</strong> E.g., $100 at 2.10 odds returns $210 total ($110 profit + $100 stake). Higher = bigger payout. Odds of 2.00 = even money.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">American Odds (+/&minus;)</div>
                    <div class="glossary-def"><strong>+150</strong> means bet $100 to win $150 profit (underdog). <strong>&minus;150</strong> means bet $150 to win $100 profit (favorite). The number tells you how much you win on $100 (positive) or how much you must bet to win $100 (negative).</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Push</div>
                    <div class="glossary-def">A <strong>tie result</strong> where neither side wins. Your bet amount is returned in full. Happens when the final score lands exactly on the spread or total number (e.g., spread of -7 and team wins by exactly 7).</div>
                </div>
            </div>

            <h3 class="glossary-section-title">Other Terms</h3>
            <div class="glossary-grid">
                <div class="glossary-item">
                    <div class="glossary-term">Book Consensus</div>
                    <div class="glossary-def">How closely <strong>different sportsbooks agree</strong> on the odds. Strong consensus (many books with similar lines) suggests the market is efficient. When one book&rsquo;s odds diverge significantly, that&rsquo;s where value bets appear.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">CA Legal</div>
                    <div class="glossary-def">Sportsbooks that are <strong>licensed and legal in Canada</strong> (specifically Ontario via iGaming Ontario). Includes bet365, FanDuel, DraftKings, BetMGM, PointsBet, and Caesars. Picks from CA-legal books get a small scoring bonus.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Key Number</div>
                    <div class="glossary-def">Specific point spread values where many games land (e.g., 3 and 7 in NFL). Getting a spread of <strong>+3 vs +2.5</strong> matters a lot because so many games are decided by exactly 3 points. The &ldquo;KEY#&rdquo; badge flags these significant line differences.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Win Probability</div>
                    <div class="glossary-def">The <strong>vig-removed consensus likelihood</strong> that a bet wins, derived from market odds. A 40% win prob doesn&rsquo;t mean it&rsquo;s a bad bet &mdash; if the odds pay enough to compensate, it can still be +EV. Grade reflects value, not just probability.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Confidence (High / Medium / Low)</div>
                    <div class="glossary-def">The algorithm's <strong>certainty level</strong> for a pick. <strong>High</strong>: strong signal, multiple factors align. <strong>Medium</strong>: moderate signal, some uncertainty. <strong>Low</strong>: speculative, edge is less reliable. Higher confidence picks are sized larger via Kelly.</div>
                </div>
                <div class="glossary-item">
                    <div class="glossary-term">Savings %</div>
                    <div class="glossary-def">In line shopping, the <strong>percentage difference</strong> between the best and worst odds for the same bet. Higher savings = bigger edge from choosing the right book. Even 2-3% savings compounds massively over hundreds of bets.</div>
                </div>
            </div>
        </div>
    </div>

<script>
var API_BASE = '/live-monitor/api/';
var currentSport = 'all';
var bankrollChart = null;
var mktLabel = {h2h:'Moneyline',spreads:'Spread',totals:'Total'};
var sportPickCounts = {};

function switchTab(tab) {
    document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    document.getElementById('tab-' + tab).classList.add('active');
    var tabs = {'picks':'Today','odds':'Odds','bets':'My Bets','performance':'Performance','history':'Pick History','glossary':'Glossary'};
    var btns = document.querySelectorAll('.tab-btn');
    for (var i = 0; i < btns.length; i++) {
        if (btns[i].textContent === tabs[tab]) btns[i].classList.add('active');
    }
    if (tab === 'picks') fetchPicks();
    if (tab === 'odds') fetchOdds();
    if (tab === 'bets') loadBets('active');
    if (tab === 'performance') fetchPerformance();
    if (tab === 'history') fetchPickHistory();
}

function filterSport(sport) {
    currentSport = sport;
    document.querySelectorAll('.sport-btn').forEach(function(b) { b.classList.remove('active'); });
    var btns = document.querySelectorAll('.sport-btn');
    for (var i = 0; i < btns.length; i++) {
        var oc = btns[i].getAttribute('onclick') || '';
        if (oc.indexOf("'" + sport + "'") >= 0) btns[i].classList.add('active');
    }
    var activeTab = document.querySelector('.tab-panel.active');
    if (activeTab) switchTab(activeTab.id.replace('tab-', ''));
}

function fmtUsd(v) { return '$' + parseFloat(v).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
function fmtPct(v) { return parseFloat(v).toFixed(1) + '%'; }
function fmtOdds(v) {
    v = parseFloat(v);
    if (v >= 2.0) return '+' + Math.round((v - 1) * 100);
    return '-' + Math.round(100 / (v - 1));
}
function fmtTime(dt) {
    if (!dt) return '--';
    var d = new Date(dt + (dt.indexOf('Z') < 0 && dt.indexOf('+') < 0 ? ' UTC' : ''));
    return d.toLocaleDateString('en-US', {month:'short',day:'numeric'}) + ' ' + d.toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'});
}
function fmtGameDate(gd, ct) {
    // Prefer game_date (already EST from backend), fall back to commence_time (UTC -> EST)
    var src = gd;
    if (!src && ct) {
        // commence_time is UTC — subtract 5h to get EST date
        var utc = new Date(ct + (ct.indexOf('Z') < 0 && ct.indexOf('+') < 0 ? ' UTC' : ''));
        var est = new Date(utc.getTime() - 5 * 60 * 60 * 1000);
        src = est.getFullYear() + '-' + ('0'+(est.getMonth()+1)).slice(-2) + '-' + ('0'+est.getDate()).slice(-2);
    }
    if (!src) return '--';
    var parts = src.split('-');
    if (parts.length < 3) return src;
    var d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    var today = new Date(); today.setHours(0,0,0,0);
    var tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
    var yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
    var label = d.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
    if (d.getTime() === today.getTime()) label = 'TODAY';
    else if (d.getTime() === tomorrow.getTime()) label = 'TOMORROW';
    else if (d.getTime() === yesterday.getTime()) label = 'YESTERDAY';
    return label;
}
function sportParam() { return currentSport !== 'all' ? '&sport=' + currentSport : ''; }

function fetchJson(url, cb) {
    var x = new XMLHttpRequest();
    x.open('GET', url);
    x.onload = function() { try { cb(JSON.parse(x.responseText)); } catch(e) { cb({ok:false,error:'Parse error'}); } };
    x.onerror = function() { cb({ok:false,error:'Network error'}); };
    x.send();
}

function fetchDashboard() {
    fetchJson(API_BASE + 'sports_bets.php?action=dashboard', function(d) {
        if (!d.ok) return;
        document.getElementById('stat-bankroll').textContent = fmtUsd(d.bankroll);
        document.getElementById('status-bankroll').textContent = fmtUsd(d.bankroll);
        var ch = d.bankroll_change || 0;
        var chEl = document.getElementById('stat-bankroll-change');
        chEl.textContent = (ch >= 0 ? '+' : '') + fmtUsd(ch);
        chEl.style.color = ch >= 0 ? 'var(--green)' : 'var(--red)';
        document.getElementById('stat-bankroll').style.color = ch >= 0 ? 'var(--green)' : 'var(--red)';
        document.getElementById('stat-total-bets').textContent = d.total_bets || 0;
        document.getElementById('stat-wlp').textContent = 'W:' + (d.total_wins||0) + ' L:' + (d.total_losses||0) + ' P:' + (d.total_pushes||0);
        document.getElementById('stat-win-rate').textContent = fmtPct(d.win_rate || 0);
        document.getElementById('stat-roi').textContent = fmtPct(d.roi_pct || 0);
        document.getElementById('stat-roi').style.color = (d.roi_pct||0) >= 0 ? 'var(--green)' : 'var(--red)';
        document.getElementById('stat-pnl').textContent = fmtUsd(d.total_pnl || 0) + ' P&L';
        document.getElementById('stat-active').textContent = d.active_bets || 0;
        document.getElementById('status-active').textContent = d.active_bets || 0;
        document.getElementById('stat-reserved').textContent = fmtUsd(d.reserved_amount || 0) + ' reserved';
    });
    fetchJson(API_BASE + 'sports_odds.php?action=credit_usage', function(d) {
        if (!d.ok) return;
        document.getElementById('status-credits').textContent = (d.monthly_used||0) + '/500';
    });
}

function fetchPicks() {
    document.getElementById('picks-loading').style.display = 'block';
    document.getElementById('picks-content').style.display = 'none';
    fetchJson(API_BASE + 'sports_picks.php?action=today' + sportParam(), function(d) {
        document.getElementById('picks-loading').style.display = 'none';
        document.getElementById('picks-content').style.display = 'block';
        if (!d.ok) { document.getElementById('value-bets-grid').innerHTML = '<div class="empty-state"><p>Failed to load picks</p></div>'; return; }
        if (d.last_updated) document.getElementById('last-refresh').textContent = fmtTime(d.last_updated);
        if (d.generated_at) document.getElementById('last-refresh').textContent = d.generated_at;
        document.getElementById('stat-picks').textContent = d.value_bet_count || 0;
        document.getElementById('vb-count').textContent = d.value_bet_count || 0;
        if (d.summary) document.getElementById('stat-avg-ev').textContent = 'Avg EV: ' + fmtPct(d.summary.avg_ev_pct || 0);

        var vb = d.value_bets || [];
        var grid = document.getElementById('value-bets-grid');

        // Track which sports have picks for filter greying
        sportPickCounts = {};
        for (var sc = 0; sc < vb.length; sc++) {
            var sk = vb[sc].sport || '';
            if (!sportPickCounts[sk]) sportPickCounts[sk] = 0;
            sportPickCounts[sk]++;
        }
        _updateSportFilters();

        if (vb.length === 0) {
            grid.innerHTML = '<div class="empty-state"><p>No value bets detected right now</p><p class="text-dim" style="font-size:0.85rem">Picks appear when odds are refreshed and our algorithm detects mispriced lines.<br>You need a valid Odds API key in db_config.php and run ?action=fetch to populate data.</p></div>';
            document.getElementById('picks-summary').style.display = 'none';
            return;
        }

        // Update summary counts
        var sumEl = document.getElementById('picks-summary');
        sumEl.style.display = 'flex';
        document.getElementById('sum-strong').textContent = d.summary.strong_takes || 0;
        document.getElementById('sum-takes').textContent = d.summary.takes || 0;
        document.getElementById('sum-waits').textContent = d.summary.waits || 0;
        var avgWP = 0; var wpCount = 0;
        for (var w = 0; w < vb.length; w++) { if (vb[w].win_probability) { avgWP += parseFloat(vb[w].win_probability); wpCount++; } }
        document.getElementById('sum-winprob').textContent = wpCount > 0 ? (avgWP/wpCount).toFixed(1) + '%' : '--%';

        var html = '';
        for (var i = 0; i < vb.length; i++) {
            var b = vb[i];
            var isCa = b.is_canadian_book ? ' <span class="badge badge-ca">CA Legal</span>' : '';
            var grade = b.rating_grade || 'C';
            var gradeClass = grade.replace('+', 'plus');
            var rec = b.recommendation || 'WAIT';
            var recClass = 'rec-' + rec.toLowerCase().replace(' ', '-');
            var recDetail = b.rec_detail || '';
            var scoreVal = b.rating_score || 0;
            var scoreColor = scoreVal >= 80 ? 'var(--green)' : scoreVal >= 60 ? 'var(--blue)' : scoreVal >= 40 ? 'var(--yellow)' : 'var(--red)';
            var winProb = b.win_probability ? parseFloat(b.win_probability).toFixed(1) + '%' : '';
            var amOdds = b.american_odds || fmtOdds(b.best_odds);

            // Translate market key to friendly label (fixes h2h showing raw)
            var marketRaw = (b.market || '').replace(/^\s+|\s+$/g, '');
            var marketDisplay = mktLabel[marketRaw] || marketRaw || '';

            // Grade class for border
            var borderGrade = scoreVal >= 70 ? 'grade-A' : scoreVal >= 50 ? 'grade-B' : scoreVal >= 35 ? 'grade-C' : 'grade-D';

            // Win prob tooltip explaining grade vs probability
            var wpTooltip = '';
            if (winProb) {
                wpTooltip = '<div class="pick-win-prob">' + winProb + ' win prob <span class="grade-info-icon">?<span class="grade-tooltip">Win prob (' + winProb + ') reflects how often this bet wins. But the <strong>grade (' + grade + ')</strong> is based on <strong>Expected Value</strong> &mdash; a bet that wins less often but pays much more can have a higher grade because the risk:reward is better.</span></span></div>';
            }

            var gameDateLabel = fmtGameDate(b.game_date, b.commence_time);
            var gdClass = gameDateLabel === 'TODAY' ? 'badge-green' : gameDateLabel === 'TOMORROW' ? 'badge-yellow' : 'badge-blue';

            // Build team ranking HTML
            var rankHtml = '';
            if (b.away_rank || b.home_rank) {
                rankHtml = '<div class="pick-rankings">';
                if (b.away_rank) {
                    var arCls = b.away_rank <= 5 ? 'top5' : b.away_rank <= 10 ? 'top10' : b.away_rank > 22 ? 'bottom10' : '';
                    rankHtml += '<span class="team-rank">' + (b.away_team||'').split(' ').pop() + ': <span class="rank-num ' + arCls + '">#' + b.away_rank + '</span> <span class="rank-record">(' + (b.away_record||'') + ')</span></span>';
                }
                if (b.home_rank) {
                    var hrCls = b.home_rank <= 5 ? 'top5' : b.home_rank <= 10 ? 'top10' : b.home_rank > 22 ? 'bottom10' : '';
                    rankHtml += '<span class="team-rank">' + (b.home_team||'').split(' ').pop() + ': <span class="rank-num ' + hrCls + '">#' + b.home_rank + '</span> <span class="rank-record">(' + (b.home_record||'') + ')</span></span>';
                }
                rankHtml += '</div>';
            }

            html += '<div class="pick-card-enhanced ' + borderGrade + '">'
                + '<div class="pick-top-row">'
                +   '<div class="pick-main-col">'
                +     '<div class="pick-header"><span class="pick-sport">' + (b.sport_short || b.sport) + ' &bull; ' + marketDisplay + '</span><span class="pick-time"><span class="badge ' + gdClass + '" style="margin-right:0.4rem">' + gameDateLabel + '</span>' + fmtTime(b.commence_time) + '</span></div>'
                +     '<div class="pick-teams">' + (b.away_team||'') + ' @ ' + (b.home_team||'') + '</div>'
                +     rankHtml
                +   '</div>'
                +   '<div class="pick-rating-col">'
                +     '<div class="rating-badge rating-' + gradeClass + '" title="Score: ' + scoreVal + '/100 — based on EV%, book consensus, market type, and timing">' + grade + '</div>'
                +     '<div class="pick-score-bar"><div class="pick-score-fill" style="width:' + scoreVal + '%;background:' + scoreColor + '"></div></div>'
                +     wpTooltip
                +   '</div>'
                + '</div>'
                + '<div class="pick-detail">Pick: <strong>' + (b.outcome_name||b.bet_type||'') + '</strong> at <strong>' + (b.best_book||'') + '</strong>' + isCa + '</div>'
                + '<div class="pick-detail">Odds: <strong>' + parseFloat(b.best_odds||0).toFixed(2) + '</strong> (' + amOdds + ') &bull; EV: <span class="text-green"><strong>+' + fmtPct(b.ev_pct) + '</strong></span></div>'
                + '<div style="margin-top:0.5rem;display:flex;gap:0.6rem;align-items:center;flex-wrap:wrap">'
                + '<span class="pick-bet-amount"><span class="bet-label">Bet&nbsp;</span>' + fmtUsd(b.kelly_bet||0) + '</span>'
                + '<span class="rec-badge ' + recClass + '">' + rec + '</span>'
                + '<span class="badge badge-green">+EV ' + fmtPct(b.ev_pct) + '</span>'
                + '</div>'
                + (recDetail ? '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.3rem">' + recDetail + ((rec === 'STRONG TAKE' || rec === 'TAKE') ? '<span style="color:var(--yellow);font-size:0.68rem;margin-left:0.4rem">&#9888; Paper simulation only. Never bet money you can\'t afford to lose.</span>' : '') + '</div>' : '');

            // Rating reasons
            var reasons = b.rating_reasons || [];
            if (reasons.length > 0) {
                html += '<div class="pick-reasons"><ul>';
                for (var r = 0; r < reasons.length; r++) {
                    html += '<li>' + reasons[r] + '</li>';
                }
                html += '</ul></div>';
            }

            // "Here's Why" for B+ or higher
            if (b.heres_why) {
                html += '<div class="pick-heres-why"><div class="why-label">Here\'s Why</div>' + b.heres_why + '<div style="font-size:0.68rem;color:var(--text-dim);margin-top:0.4rem;font-style:italic">&#9888; This is algorithmic analysis for educational purposes. Not financial advice. Never wager money you cannot afford to lose.</div></div>';
            }
            html += '</div>';
        }
        grid.innerHTML = html;

        var shops = d.line_shops || [];
        var shopEl = document.getElementById('line-shop-content');
        if (shops.length === 0) { shopEl.innerHTML = '<div class="empty-state"><p>No line shopping data</p></div>'; return; }
        var shopHtml = '';
        for (var s = 0; s < Math.min(shops.length, 10); s++) {
            var ev = shops[s];
            var shopGd = fmtGameDate(ev.game_date, ev.commence_time);
            shopHtml += '<div class="odds-event"><div class="odds-event-header"><h3>' + (ev.sport_short||'') + ': ' + (ev.away_team||'') + ' @ ' + (ev.home_team||'') + '</h3><span class="text-dim"><strong>' + shopGd + '</strong> &bull; ' + fmtTime(ev.commence_time) + '</span></div>';
            shopHtml += '<div class="odds-table"><table><tr><th>Market</th><th>Outcome</th><th>Best Book</th><th>Best Odds</th><th>Worst Book</th><th>Worst Odds</th><th>Savings</th></tr>';
            var mkts = ev.markets || [];
            for (var m = 0; m < mkts.length; m++) {
                var ocs = mkts[m].outcomes || [];
                for (var o = 0; o < ocs.length; o++) {
                    var oc = ocs[o];
                    var savCls = oc.savings_pct > 5 ? 'text-green' : oc.savings_pct > 2 ? 'text-yellow' : 'text-dim';
                    var keyAlert = oc.key_number_alert ? ' <span class="badge badge-yellow">KEY#</span>' : '';
                    shopHtml += '<tr><td>' + mkts[m].market + keyAlert + '</td><td>' + oc.outcome_name + '</td><td><strong>' + oc.best_book + '</strong></td><td class="best-odds">' + parseFloat(oc.best_price).toFixed(2) + '</td><td>' + oc.worst_book + '</td><td class="worst-odds">' + parseFloat(oc.worst_price).toFixed(2) + '</td><td class="' + savCls + '">+' + fmtPct(oc.savings_pct) + '</td></tr>';
                }
            }
            shopHtml += '</table></div></div>';
        }
        shopEl.innerHTML = shopHtml;
    });
}

function fetchOdds() {
    document.getElementById('odds-loading').style.display = 'block';
    document.getElementById('odds-content').style.display = 'none';
    fetchJson(API_BASE + 'sports_odds.php?action=get&hours=48' + sportParam(), function(d) {
        document.getElementById('odds-loading').style.display = 'none';
        document.getElementById('odds-content').style.display = 'block';
        if (!d.ok || !d.events || d.events.length === 0) { document.getElementById('odds-content').innerHTML = '<div class="empty-state"><p>No upcoming odds data</p></div>'; return; }
        var html = '';
        for (var e = 0; e < Math.min(d.events.length, 20); e++) {
            var ev = d.events[e];
            var oddsGd = fmtGameDate(ev.game_date, ev.commence_time);
            html += '<div class="odds-event"><div class="odds-event-header"><h3>' + (ev.sport_short||'') + ': ' + (ev.away_team||'') + ' @ ' + (ev.home_team||'') + '</h3><span class="text-dim"><strong>' + oddsGd + '</strong> &bull; ' + fmtTime(ev.commence_time) + '</span></div>';
            var bookNames = {}, bms = ev.bookmakers || [];
            for (var b = 0; b < bms.length; b++) { if (bms[b].is_canadian) bookNames[bms[b].key] = bms[b].name; }
            var bookKeys = Object.keys(bookNames);
            if (bookKeys.length === 0) { for (var b = 0; b < bms.length; b++) bookNames[bms[b].key] = bms[b].name; bookKeys = Object.keys(bookNames); }
            html += '<div class="odds-table"><table><tr><th>Market</th><th>Outcome</th>';
            for (var bk = 0; bk < bookKeys.length; bk++) html += '<th>' + bookNames[bookKeys[bk]] + '</th>';
            html += '</tr>';
            var oddsMap = {};
            for (var b = 0; b < bms.length; b++) { var bm = bms[b]; oddsMap[bm.key] = {}; var mkts = bm.markets || []; for (var m = 0; m < mkts.length; m++) { oddsMap[bm.key][mkts[m].key] = {}; var ocs = mkts[m].outcomes || []; for (var o = 0; o < ocs.length; o++) oddsMap[bm.key][mkts[m].key][ocs[o].name] = ocs[o].price; } }
            var mktOrder = ['h2h','spreads','totals'];
            var mktLabels = {h2h:'Moneyline',spreads:'Spread',totals:'Total'};
            for (var mi = 0; mi < mktOrder.length; mi++) {
                var mk = mktOrder[mi];
                var outcomes = {};
                for (var b = 0; b < bms.length; b++) { var mkts = bms[b].markets || []; for (var m = 0; m < mkts.length; m++) { if (mkts[m].key !== mk) continue; var ocs = mkts[m].outcomes || []; for (var o = 0; o < ocs.length; o++) outcomes[ocs[o].name] = true; } }
                var ocNames = Object.keys(outcomes);
                for (var oi = 0; oi < ocNames.length; oi++) {
                    var ocName = ocNames[oi];
                    html += '<tr><td>' + (mktLabels[mk]||mk) + '</td><td>' + ocName + '</td>';
                    var bestP = 0, worstP = 999;
                    for (var bk = 0; bk < bookKeys.length; bk++) { var p = oddsMap[bookKeys[bk]] && oddsMap[bookKeys[bk]][mk] && oddsMap[bookKeys[bk]][mk][ocName] ? parseFloat(oddsMap[bookKeys[bk]][mk][ocName]) : 0; if (p > bestP) bestP = p; if (p > 0 && p < worstP) worstP = p; }
                    for (var bk = 0; bk < bookKeys.length; bk++) { var p = oddsMap[bookKeys[bk]] && oddsMap[bookKeys[bk]][mk] && oddsMap[bookKeys[bk]][mk][ocName] ? parseFloat(oddsMap[bookKeys[bk]][mk][ocName]) : 0; var cls = p > 0 && p === bestP ? ' class="best-odds"' : (p > 0 && p === worstP && bookKeys.length > 2 ? ' class="worst-odds"' : ''); html += '<td' + cls + '>' + (p > 0 ? p.toFixed(2) : '--') + '</td>'; }
                    html += '</tr>';
                }
            }
            html += '</table></div></div>';
        }
        document.getElementById('odds-content').innerHTML = html;
    });
}

// ── Sorting infrastructure ──
var _betsData = []; var _betsType = 'active';
var _dayPicksData = []; var _dayPicksDate = '';
var _sortStates = {}; // keyed by table id

function _getSortVal(row, key) {
    if (key === 'game_date') return row.game_date || (row.commence_time || '').substr(0, 10) || '';
    if (key === 'odds') return parseFloat(row.odds || row.best_odds || 0);
    if (key === 'ev_pct') return parseFloat(row.ev_pct || 0);
    if (key === 'bet_amount') return parseFloat(row.bet_amount || 0);
    if (key === 'pnl') return parseFloat(row.pnl || 0);
    if (key === 'sport') return (row.sport_short || row.sport || '').toLowerCase();
    if (key === 'event') return ((row.away_team||'') + ' @ ' + (row.home_team||'')).toLowerCase();
    if (key === 'pick') return (row.pick || row.outcome_name || '').toLowerCase();
    if (key === 'book') return (row.bookmaker || row.best_book || '').toLowerCase();
    if (key === 'result') return row.result || 'zzz';
    if (key === 'market') return row.market || '';
    if (key === 'confidence') return row.confidence === 'high' ? 1 : row.confidence === 'medium' ? 2 : 3;
    if (key === 'commence_time') return row.commence_time || '';
    return '';
}

function _sortAndRender(tableId, key, renderFn) {
    var st = _sortStates[tableId] || {};
    if (st.key === key) { st.dir = st.dir === 'asc' ? 'desc' : 'asc'; }
    else { st.key = key; st.dir = 'asc'; }
    _sortStates[tableId] = st;
    renderFn();
}

function _thSortable(tableId, key, label, tip, renderFn) {
    var st = _sortStates[tableId] || {};
    var cls = 'sortable' + (st.key === key ? ' sort-' + st.dir : '');
    var arrow = st.key === key ? (st.dir === 'asc' ? '&#9650;' : '&#9660;') : '&#9650;';
    var tipHtml = tip ? '<span class="th-tip">?<span class="th-tip-text">' + tip + '</span></span>' : '';
    return '<th class="' + cls + '" onclick="_sortAndRender(\'' + tableId + '\',\'' + key + '\',' + renderFn + ')">' + label + '<span class="sort-arrow">' + arrow + '</span>' + tipHtml + '</th>';
}

// Column tooltip definitions
var COL_TIPS = {
    sport: 'The league or sport (NBA, NHL, NFL, etc.)',
    event: 'The matchup — Away Team @ Home Team',
    pick: 'Which side/outcome the algorithm recommends betting on',
    book: 'The sportsbook offering the best odds for this pick',
    odds: 'Decimal odds — multiply by your bet to get total payout. E.g. 2.10 means $100 bet returns $210',
    amount: 'Paper bet amount sized by quarter-Kelly criterion based on edge',
    game_date: 'Calendar date of the game in EST timezone',
    game_time: 'Scheduled start time of the game',
    ev_pct: 'Expected Value % — positive means the bet is profitable long-term. Higher = better edge',
    result: 'Outcome: WON (profit), LOST (loss), PUSH (tie, money back), VOID (cancelled)',
    pnl: 'Profit & Loss — actual dollar gain or loss from this bet',
    market: 'Bet type: Moneyline (h2h = who wins), Spread (point handicap), Total (over/under points)',
    confidence: 'Algorithm confidence: HIGH (strong signal), MEDIUM (moderate), LOW (speculative)'
};

function loadBets(type) {
    _betsType = type;
    document.getElementById('bets-tab-active').style.background = type === 'active' ? 'var(--accent)' : 'var(--bg-card)';
    document.getElementById('bets-tab-active').style.color = type === 'active' ? '#fff' : 'var(--text-dim)';
    document.getElementById('bets-tab-history').style.background = type === 'history' ? 'var(--accent)' : 'var(--bg-card)';
    document.getElementById('bets-tab-history').style.color = type === 'history' ? '#fff' : 'var(--text-dim)';
    var url = type === 'active' ? API_BASE + 'sports_bets.php?action=active' : API_BASE + 'sports_bets.php?action=history' + sportParam();
    document.getElementById('bets-content').innerHTML = '<div class="loading">Loading...</div>';
    fetchJson(url, function(d) {
        if (!d.ok || !d.bets || d.bets.length === 0) { document.getElementById('bets-content').innerHTML = '<div class="empty-state"><p>No ' + type + ' bets</p></div>'; return; }
        _betsData = d.bets;
        _renderBetsTable();
    });
}

function _renderBetsTable() {
    var type = _betsType;
    var data = _betsData.slice();
    var st = _sortStates['bets'];
    if (st && st.key) {
        data.sort(function(a, b) {
            var va = _getSortVal(a, st.key), vb = _getSortVal(b, st.key);
            var cmp = typeof va === 'number' ? va - vb : (va < vb ? -1 : va > vb ? 1 : 0);
            return st.dir === 'desc' ? -cmp : cmp;
        });
    }
    var html = '<table><tr>';
    html += _thSortable('bets', 'sport', 'Sport', COL_TIPS.sport, '_renderBetsTable');
    html += _thSortable('bets', 'event', 'Event', COL_TIPS.event, '_renderBetsTable');
    html += _thSortable('bets', 'pick', 'Pick', COL_TIPS.pick, '_renderBetsTable');
    html += _thSortable('bets', 'book', 'Book', COL_TIPS.book, '_renderBetsTable');
    html += _thSortable('bets', 'odds', 'Odds', COL_TIPS.odds, '_renderBetsTable');
    html += _thSortable('bets', 'bet_amount', 'Amount', COL_TIPS.amount, '_renderBetsTable');
    html += _thSortable('bets', 'game_date', 'Game Date', COL_TIPS.game_date, '_renderBetsTable');
    if (type === 'history') {
        html += _thSortable('bets', 'result', 'Result', COL_TIPS.result, '_renderBetsTable');
        html += _thSortable('bets', 'pnl', 'P&amp;L', COL_TIPS.pnl, '_renderBetsTable');
    } else {
        html += _thSortable('bets', 'commence_time', 'Game Time', COL_TIPS.game_time, '_renderBetsTable');
        html += _thSortable('bets', 'ev_pct', 'EV%', COL_TIPS.ev_pct, '_renderBetsTable');
    }
    html += '</tr>';
    for (var i = 0; i < data.length; i++) {
        var b = data[i];
        var ml = {h2h:'Moneyline',spreads:'Spread',totals:'Total'};
        var gdLabel = fmtGameDate(b.game_date, b.commence_time);
        var gdCls = gdLabel === 'TODAY' ? 'text-green' : gdLabel === 'TOMORROW' ? 'text-yellow' : '';
        html += '<tr><td>' + (b.sport_short||b.sport) + '</td><td>' + (b.away_team||'') + ' @ ' + (b.home_team||'') + '</td><td><strong>' + (b.pick||'') + '</strong> (' + (ml[b.market]||b.market||'') + ')</td><td>' + (b.bookmaker||'') + '</td><td>' + parseFloat(b.odds||0).toFixed(2) + '</td><td>' + fmtUsd(b.bet_amount||0) + '</td>';
        html += '<td class="' + gdCls + '"><strong>' + gdLabel + '</strong></td>';
        if (type === 'history') {
            var rCls = b.result === 'won' ? 'text-green' : b.result === 'lost' ? 'text-red' : 'text-yellow';
            html += '<td class="' + rCls + '"><strong>' + (b.result||'').toUpperCase() + '</strong></td>';
            html += '<td class="' + (parseFloat(b.pnl||0) >= 0 ? 'text-green' : 'text-red') + '">' + (parseFloat(b.pnl||0) >= 0 ? '+' : '') + fmtUsd(b.pnl||0) + '</td>';
        } else {
            html += '<td>' + fmtTime(b.commence_time) + '</td><td class="text-green">+' + fmtPct(b.ev_pct||0) + '</td>';
        }
        html += '</tr>';
    }
    html += '</table>';
    document.getElementById('bets-content').innerHTML = html;
}

function fetchPerformance() {
    fetchJson(API_BASE + 'sports_bets.php?action=dashboard', function(d) {
        if (!d.ok) return;
        var history = d.bankroll_history || [];
        if (history.length > 0 && typeof Chart !== 'undefined') {
            var labels = [], data = [];
            for (var i = 0; i < history.length; i++) { labels.push(history[i].snapshot_date); data.push(parseFloat(history[i].bankroll)); }
            if (bankrollChart) bankrollChart.destroy();
            var ctx = document.getElementById('bankroll-chart').getContext('2d');
            bankrollChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Bankroll ($)', data: data, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3, pointRadius: 3 }, { label: 'Starting ($1000)', data: labels.map(function() { return 1000; }), borderColor: '#8888aa', borderDash: [5,5], pointRadius: 0, fill: false }] },
                options: { responsive: true, plugins: { legend: { labels: { color: '#e0e0f0' } } }, scales: { x: { ticks: { color: '#8888aa' }, grid: { color: 'rgba(42,42,74,0.5)' } }, y: { ticks: { color: '#8888aa', callback: function(v) { return '$'+v; } }, grid: { color: 'rgba(42,42,74,0.5)' } } } }
            });
        }
        var tablesHtml = '';
        if (d.by_sport && d.by_sport.length > 0) {
            tablesHtml += '<h3 class="section-title">Performance by Sport</h3><table><tr><th>Sport</th><th>Bets</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&amp;L</th><th>ROI</th></tr>';
            for (var i = 0; i < d.by_sport.length; i++) { var s = d.by_sport[i]; var pc = parseFloat(s.pnl) >= 0 ? 'text-green' : 'text-red'; tablesHtml += '<tr><td><strong>' + (s.sport_short||s.sport) + '</strong></td><td>' + s.bets + '</td><td>' + s.wins + '</td><td>' + s.losses + '</td><td>' + fmtPct(s.win_rate) + '</td><td class="' + pc + '">' + fmtUsd(s.pnl) + '</td><td class="' + pc + '">' + fmtPct(s.roi) + '</td></tr>'; }
            tablesHtml += '</table>';
        }
        if (d.by_algorithm && d.by_algorithm.length > 0) {
            tablesHtml += '<h3 class="section-title" style="margin-top:1.5rem">Performance by Algorithm</h3><table><tr><th>Algorithm</th><th>Bets</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&amp;L</th><th>ROI</th></tr>';
            for (var i = 0; i < d.by_algorithm.length; i++) { var a = d.by_algorithm[i]; var pc = parseFloat(a.pnl) >= 0 ? 'text-green' : 'text-red'; tablesHtml += '<tr><td><strong>' + a.algorithm + '</strong></td><td>' + a.bets + '</td><td>' + a.wins + '</td><td>' + a.losses + '</td><td>' + fmtPct(a.win_rate) + '</td><td class="' + pc + '">' + fmtUsd(a.pnl) + '</td><td class="' + pc + '">' + fmtPct(a.roi) + '</td></tr>'; }
            tablesHtml += '</table>';
        }
        document.getElementById('perf-tables').innerHTML = tablesHtml || '<div class="empty-state"><p>No performance data yet</p></div>';
    });
    fetchJson(API_BASE + 'sports_picks.php?action=performance', function(d) {
        if (!d.ok) return;
        var html = document.getElementById('perf-tables').innerHTML;
        if (d.ev_buckets && d.ev_buckets.length > 0) {
            html += '<h3 class="section-title" style="margin-top:1.5rem">EV Bucket Analysis</h3><p class="text-dim" style="font-size:0.85rem;margin-bottom:0.5rem">Do higher EV picks actually win more often?</p>';
            html += '<table><tr><th>EV Range</th><th>Picks</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>P&amp;L</th></tr>';
            for (var i = 0; i < d.ev_buckets.length; i++) { var b = d.ev_buckets[i]; var pc = b.pnl >= 0 ? 'text-green' : 'text-red'; html += '<tr><td><strong>' + b.range + '</strong></td><td>' + b.total + '</td><td>' + b.wins + '</td><td>' + b.losses + '</td><td>' + fmtPct(b.win_rate) + '</td><td class="' + pc + '">' + fmtUsd(b.pnl) + '</td></tr>'; }
            html += '</table>';
        }
        if (d.streaks) {
            html += '<h3 class="section-title" style="margin-top:1.5rem">Streaks</h3><div class="stats-grid" style="grid-template-columns:repeat(4,1fr)">';
            html += '<div class="stat-card"><div class="stat-label">Current Streak</div><div class="stat-value" style="color:' + (d.streaks.current_type === 'won' ? 'var(--green)' : 'var(--red)') + '">' + d.streaks.current + ' ' + (d.streaks.current_type || 'N/A') + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Longest Win</div><div class="stat-value text-green">' + d.streaks.longest_win + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Longest Loss</div><div class="stat-value text-red">' + d.streaks.longest_loss + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Generated</div><div class="stat-value" style="font-size:0.85rem">' + (d.generated_at||'--') + '</div></div></div>';
        }
        if (d.by_book && d.by_book.length > 0) {
            html += '<h3 class="section-title" style="margin-top:1.5rem">Performance by Sportsbook</h3><table><tr><th>Sportsbook</th><th>Picks</th><th>Wins</th><th>Win Rate</th><th>P&amp;L</th></tr>';
            for (var i = 0; i < d.by_book.length; i++) { var b = d.by_book[i]; var pc = b.pnl >= 0 ? 'text-green' : 'text-red'; html += '<tr><td><strong>' + b.best_book + '</strong></td><td>' + b.total + '</td><td>' + b.wins + '</td><td>' + fmtPct(b.win_rate) + '</td><td class="' + pc + '">' + fmtUsd(b.pnl) + '</td></tr>'; }
            html += '</table>';
        }
        document.getElementById('perf-tables').innerHTML = html;
    });
}

function fetchPickHistory() {
    document.getElementById('history-content').innerHTML = '<div class="loading">Loading pick history...</div>';
    fetchJson(API_BASE + 'sports_picks.php?action=pick_history&days=30' + sportParam(), function(d) {
        if (!d.ok || !d.days || d.days.length === 0) { document.getElementById('history-content').innerHTML = '<div class="empty-state"><p>No pick history yet' + (currentSport !== 'all' ? ' for this sport' : '') + '</p><p class="text-dim" style="font-size:0.85rem">Daily picks are generated when the odds refresh workflow runs</p></div>'; return; }
        var html = '';
        if (d.overall) {
            var o = d.overall;
            html += '<div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:1rem">';
            html += '<div class="stat-card"><div class="stat-label">All-Time Picks</div><div class="stat-value">' + o.total + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value">' + fmtPct(o.win_rate) + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Total P&amp;L</div><div class="stat-value" style="color:' + (o.total_pnl >= 0 ? 'var(--green)' : 'var(--red)') + '">' + fmtUsd(o.total_pnl) + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">W / L</div><div class="stat-value">' + o.wins + ' / ' + o.losses + '</div></div></div>';
        }
        html += '<h3 class="section-title">Daily Pick History</h3>';
        for (var i = 0; i < d.days.length; i++) {
            var day = d.days[i]; var pCls = parseFloat(day.total_pnl) >= 0 ? 'text-green' : 'text-red';
            html += '<div class="history-day" onclick="loadDayPicks(\'' + day.pick_date + '\')">';
            html += '<div><span class="day-date">' + day.pick_date + '</span><span class="text-dim" style="margin-left:0.5rem;font-size:0.75rem">Generated: ' + (day.last_generated||'').substr(11,5) + ' UTC</span></div>';
            html += '<div class="day-stats"><span>' + day.total_picks + ' picks</span><span>Avg EV: ' + fmtPct(day.avg_ev) + '</span><span class="text-green">W:' + (day.wins||0) + '</span><span class="text-red">L:' + (day.losses||0) + '</span>';
            if (parseInt(day.pending||0) > 0) html += '<span class="text-yellow">' + day.pending + ' pending</span>';
            html += '<span class="' + pCls + '">' + fmtUsd(day.total_pnl) + '</span></div></div>';
        }
        document.getElementById('history-content').innerHTML = html;
    });
}

function loadDayPicks(date) {
    _dayPicksDate = date;
    document.getElementById('history-content').innerHTML = '<div class="loading">Loading picks for ' + date + '...</div>';
    fetchJson(API_BASE + 'sports_picks.php?action=pick_history&date=' + date + sportParam(), function(d) {
        if (!d.ok || !d.picks || d.picks.length === 0) { document.getElementById('history-content').innerHTML = '<div class="empty-state"><p>No picks for ' + date + '</p></div><button class="btn" onclick="fetchPickHistory()">Back</button>'; return; }
        _dayPicksData = d.picks;
        _renderDayPicksTable();
    });
}

function _renderDayPicksTable() {
    var date = _dayPicksDate;
    var data = _dayPicksData.slice();
    var st = _sortStates['daypicks'];
    if (st && st.key) {
        data.sort(function(a, b) {
            var va = _getSortVal(a, st.key), vb = _getSortVal(b, st.key);
            var cmp = typeof va === 'number' ? va - vb : (va < vb ? -1 : va > vb ? 1 : 0);
            return st.dir === 'desc' ? -cmp : cmp;
        });
    }
    var html = '<button class="btn" onclick="fetchPickHistory()" style="margin-bottom:1rem">&#8592; Back to History</button>';
    html += '<h3 class="section-title">Picks for ' + date + ' (' + data.length + ' picks)</h3>';
    html += '<table><tr>';
    html += _thSortable('daypicks', 'sport', 'Sport', COL_TIPS.sport, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'event', 'Event', COL_TIPS.event, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'game_date', 'Game Date', COL_TIPS.game_date, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'market', 'Market', COL_TIPS.market, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'pick', 'Pick', COL_TIPS.pick, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'book', 'Book', COL_TIPS.book, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'odds', 'Odds', COL_TIPS.odds, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'ev_pct', 'EV%', COL_TIPS.ev_pct, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'bet_amount', 'Risked', COL_TIPS.amount, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'confidence', 'Confidence', COL_TIPS.confidence, '_renderDayPicksTable');
    html += _thSortable('daypicks', 'result', 'Result', 'Outcome with P&amp;L breakdown: how much was risked, what was won or lost', '_renderDayPicksTable');
    html += '</tr>';
    for (var i = 0; i < data.length; i++) {
        var p = data[i]; var rCls = p.result === 'won' ? 'text-green' : p.result === 'lost' ? 'text-red' : p.result === 'push' ? 'text-yellow' : 'text-dim';
        var cBadge = p.confidence === 'high' ? 'badge-green' : p.confidence === 'medium' ? 'badge-yellow' : 'badge-blue';
        var pGd = fmtGameDate(p.game_date, p.commence_time);
        var mktDisplay = mktLabel[p.market] || p.market || '';
        var betAmt = parseFloat(p.bet_amount || p.kelly_bet || 0);
        var pOdds = parseFloat(p.best_odds || 0);
        var pPnl = parseFloat(p.pnl || 0);
        // Calculate payout and P/L if result is settled
        var resultHtml = '';
        if (p.result === 'won') {
            var winAmt = betAmt > 0 ? (betAmt * pOdds) - betAmt : pPnl;
            resultHtml = '<strong>WON</strong><div class="result-detail"><span class="rd-risk">Risked ' + fmtUsd(betAmt) + '</span> &rarr; <span class="rd-payout text-green">+' + fmtUsd(winAmt > 0 ? winAmt : pPnl) + ' profit</span></div>';
        } else if (p.result === 'lost') {
            resultHtml = '<strong>LOST</strong><div class="result-detail"><span class="rd-risk">Risked ' + fmtUsd(betAmt) + '</span> &rarr; <span class="rd-payout text-red">-' + fmtUsd(betAmt) + ' lost</span></div>';
        } else if (p.result === 'push') {
            resultHtml = '<strong>PUSH</strong><div class="result-detail"><span class="rd-risk">Risked ' + fmtUsd(betAmt) + '</span> &rarr; <span class="rd-payout text-yellow">$0.00 (returned)</span></div>';
        } else {
            resultHtml = '<strong>PENDING</strong>';
            if (betAmt > 0) resultHtml += '<div class="result-detail"><span class="rd-risk">Risking ' + fmtUsd(betAmt) + '</span></div>';
        }
        html += '<tr><td>' + (p.sport_short||p.sport) + '</td><td>' + (p.away_team||'') + ' @ ' + (p.home_team||'') + '</td><td><strong>' + pGd + '</strong></td><td>' + mktDisplay + '</td><td><strong>' + (p.outcome_name||'') + '</strong></td><td>' + (p.best_book||'') + '</td><td>' + pOdds.toFixed(2) + '</td><td class="text-green">+' + fmtPct(p.ev_pct) + '</td><td>' + (betAmt > 0 ? fmtUsd(betAmt) : '--') + '</td><td><span class="badge ' + cBadge + '">' + (p.confidence||'') + '</span></td><td class="' + rCls + '">' + resultHtml + '</td></tr>';
    }
    html += '</table>';
    document.getElementById('history-content').innerHTML = html;
}

// Update sport filter buttons — grey out sports with no picks
function _updateSportFilters() {
    var sportKeyMap = {
        'icehockey_nhl': 'NHL', 'basketball_nba': 'NBA',
        'americanfootball_nfl': 'NFL', 'baseball_mlb': 'MLB',
        'americanfootball_cfl': 'CFL', 'soccer_usa_mls': 'MLS',
        'americanfootball_ncaaf': 'NCAAF', 'basketball_ncaab': 'NCAAB'
    };
    var btns = document.querySelectorAll('.sport-btn');
    for (var i = 0; i < btns.length; i++) {
        var oc = btns[i].getAttribute('onclick') || '';
        // Extract sport key from onclick="filterSport('...')"
        var match = oc.match(/filterSport\('([^']+)'\)/);
        if (!match || match[1] === 'all') continue;
        var sportKey = match[1];
        var hasData = sportPickCounts[sportKey] && sportPickCounts[sportKey] > 0;
        if (hasData) {
            btns[i].classList.remove('empty');
            btns[i].title = sportPickCounts[sportKey] + ' pick' + (sportPickCounts[sportKey] > 1 ? 's' : '');
        } else {
            btns[i].classList.add('empty');
            btns[i].title = 'No picks available';
        }
    }
}

// Init
fetchDashboard();
fetchPicks();
setInterval(function() { fetchDashboard(); var at = document.querySelector('.tab-panel.active'); if (at && at.id === 'tab-picks') fetchPicks(); }, 300000);
</script>
</body>
</html>
